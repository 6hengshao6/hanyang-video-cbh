/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Camera.js";import"../geometry.js";import i from"../Graphic.js";import r from"../Viewpoint.js";import s,{O as a}from"../core/Collection.js";import{b as n}from"../chunks/domUtils.js";import o from"../core/Error.js";import{createAbortError as l,isAborted as h,createResolver as c,isAbortError as d,after as u,throwIfAborted as p,onAbort as m,whenOrAbort as _,isPromiseLike as g,o as f}from"../core/promiseUtils.js";import{m as y,h as v}from"../chunks/handleUtils.js";import{h as b,n as x,k as T,A as w,o as C,p as S,x as P}from"../chunks/typedArrayUtil.js";import R,{i as O}from"../core/Handles.js";import{L as E}from"../chunks/Logger.js";import{i as A,a as M,r as D,d as I,f as L,k as N,p as F,m as U,e as j,g as V,u as k,j as z,n as q}from"../chunks/maybe.js";import{watch as G,initial as H,syncAndInitial as B,when as W,sync as $,on as Q,whenOnce as X}from"../core/reactiveUtils.js";import{schedule as Y,s as Z,M as K,P as J,addFrameTask as ee,a as te,setFrameDuration as ie}from"../core/scheduling.js";import{e as re,s as se,b as ae,f as ne,d as oe,c as le}from"../chunks/screenUtils.js";import{initialize as he}from"../core/workers/workers.js";import{property as ce}from"../core/accessorSupport/decorators/property.js";import{cast as de}from"../core/accessorSupport/decorators/cast.js";import{subclass as ue}from"../core/accessorSupport/decorators/subclass.js";import{a as pe,s as me,e as _e,m as ge}from"../chunks/ensureType.js";import{f as fe,I as ye,d as ve,n as be,m as xe,g as Te,A as we,l as Ce,L as Se,s as Pe,p as Re,a as Oe,D as Ee,h as Ae,F as Me,c as De,b as Ie,e as Le,H as Ne,E as Fe,G as Ue,k as je,Z as Ve,j as ke,z as ze,M as qe,J as Ge,o as He,t as Be,q as We,N as $e}from"../chunks/vec3.js";import{o as Qe}from"../chunks/GraphicsCollection.js";import Xe from"../geometry/HeightModelInfo.js";import{canProjectToWGS84ComparableLonLat as Ye,projectPointToWGS84ComparableLonLat as Ze,projectBoundingRect as Ke,projectWithoutEngine as Je,projectVectorToVector as et,lonLatToSphericalPCPF as tt,projectPointToVector as it,canProjectWithoutEngine as rt,project as st}from"../geometry/projection.js";import{c as at,e as nt,o as ot,w as lt,s as ht,d as ct,i as dt,f as ut,u as pt,b as mt,a as _t,N as gt,v as ft,x as yt,g as vt,h as bt,y as xt,k as Tt,z as wt,j as Ct,A as St,t as Pt}from"../chunks/aaBoundingRect.js";import{c as Rt,a as Ot,e as Et,t as At,d as Mt,B as Dt}from"../chunks/boundedPlane.js";import{c as It,v as Lt,r as Nt,R as Ft}from"../chunks/RenderCoordsHelper.js";import{b as Ut}from"../chunks/scaleUtils.js";import{f as jt}from"../widgets/Popup/PopupViewModel.js";import{f as Vt,h as kt,j as zt,k as qt,l as Gt}from"../chunks/layerUtils.js";import Ht,{r as Bt,a as Wt,i as $t,c as Qt,R as Xt,P as Yt,C as Zt,I as Kt,T as Jt,o as ei,b as ti,d as ii,e as ri,f as si,S as ai,p as ni,v as oi,A as li,F as hi,g as ci,s as di,h as ui,V as pi}from"./View.js";import{BreakpointsOwner as mi}from"./BreakpointsOwner.js";import{DOMContainer as _i}from"./DOMContainer.js";import gi from"./GroundView.js";import{e as fi,o as yi,a as vi,i as bi,p as xi,D as Ti,B as wi,I as Ci,P as Si,S as Pi,c as Ri,d as Oi,q as Ei,f as Ai,h as Mi,j as Di,t as Ii,s as Li,n as Ni}from"../chunks/WebGLRequirements.js";import Fi from"./ViewAnimation.js";import{V as Ui,s as ji,v as Vi}from"../chunks/ViewingMode.js";import{c as ki,f as zi,r as qi}from"../chunks/asyncUtils.js";import{HandleOwner as Gi}from"../core/HandleOwner.js";import Hi from"../core/Accessor.js";import{c as Bi,d as Wi,r as $i,l as Qi,s as Xi,b as Yi,a as Zi,n as Ki,i as Ji}from"../chunks/mathUtils.js";import{e as er,m as tr,a as ir}from"../chunks/Ellipsoid.js";import{d as rr,e as sr,b as ar}from"../chunks/mathUtils2.js";import{n as nr}from"../chunks/compilerUtils.js";import{clone as or}from"../core/lang.js";import lr from"./3d/environment/SunLighting.js";import hr from"./3d/environment/VirtualLighting.js";import cr from"../webscene/Environment.js";import dr from"../webscene/SunLighting.js";import ur from"../webscene/VirtualLighting.js";import pr from"../Color.js";import mr from"../core/Evented.js";import{c as _r,a as gr,f as fr,Z as yr,d as vr}from"../chunks/vec4f64.js";import{B as br,t as xr,v as Tr,Q as wr,f as Cr,g as Sr,o as Pr}from"../chunks/unitUtils.js";import{s as Rr,k as Or,m as Er,d as Ar,b as Mr}from"../chunks/vec2.js";import{s as Dr,t as Ir,b as Lr,f as Nr,c as Fr,v as Ur,l as jr,e as Vr}from"../chunks/vec4.js";import{a as kr,f as zr,Z as qr}from"../chunks/vec2f64.js";import{B as Gr,C as Hr,j as Br,q as Wr,m as $r,r as Qr,A as Xr,a as Yr,d as Zr,n as Kr,i as Jr,c as es,e as ts}from"../chunks/mat4.js";import{c as is,f as rs,I as ss}from"../chunks/mat4f64.js";import{T as as,d as ns,a as os,E as ls,P as hs,M as cs,B as ds,I as us,b as ps,R as ms,V as _s,e as gs,f as fs,g as ys,h as vs}from"../chunks/BooleanPassUniform.js";import{R as bs}from"../chunks/ReadLinearDepth.glsl.js";import{G as xs,a as Ts,b as ws,c as Cs,F as Ss,d as Ps,e as Rs,f as Os,i as Es,g as As}from"../chunks/WaterSurface.glsl.js";import{F as Ms,R as Ds}from"../chunks/RgbaFloatEncoding.glsl.js";import{F as Is}from"../chunks/Float3PassUniform.js";import{F as Ls}from"../chunks/Float4PassUniform.js";import{F as Ns}from"../chunks/FloatPassUniform.js";import{g as Fs,N as Us}from"../chunks/interfaces2.js";import{M as js}from"../chunks/Matrix4PassUniform.js";import{S as Vs,U as ks,B as zs}from"../chunks/ShaderBuilder.js";import{T as qs}from"../chunks/Texture2DPassUniform.js";import{V as Gs}from"../chunks/VertexAttribute.js";import{S as Hs,P as Bs,R as Ws}from"../chunks/Program2.js";import{D as $s,A as Qs,e as Xs,C as Ys,g as Zs,f as Ks,U as Js,h as ea,j as ta,R as ia,k as ra,l as sa,m as aa}from"../chunks/Material.js";import{B as na,e as oa,d as la,q as ha,g as ca,T as da,P as ua,a as pa,b as ma,c as _a,U as ga,h as fa,j as ya,D as va,i as ba,S as xa}from"../chunks/enums3.js";import{m as Ta,s as wa,a as Ca,b as Sa,e as Pa,d as Ra,c as Oa}from"../chunks/renderState.js";import{p as Ea,S as Aa}from"../chunks/ShaderTechniqueConfiguration.js";import{c as Ma,P as Da,b as Ia,e as La,F as Na,f as Fa,g as Ua,h as ja,i as Va,d as ka}from"../chunks/glUtil3D.js";import{P as za}from"../chunks/PiUtils.glsl.js";import{C as qa}from"../chunks/ColorConversion.glsl.js";import{f as Ga,a as Ha,j as Ba,b as Wa,t as $a}from"../chunks/mat3.js";import{f as Qa,z as Xa,b as Ya}from"../chunks/vec3f32.js";import{c as Za}from"../chunks/mat3f64.js";import{S as Ka}from"../chunks/ScreenSpacePass.glsl.js";import{M as Ja,P as en,a as tn,c as rn,F as sn,e as an,d as nn,V as on,D as ln}from"../chunks/ForwardLinearDepth.glsl.js";import{F as hn,v as cn,B as dn,b as un,u as pn,a as mn,V as _n,R as gn}from"../chunks/FramebufferObject.js";import{B as fn,t as yn,O as vn,S as bn,f as xn,d as Tn,o as wn,e as Cn,c as Sn,g as Pn,G as Rn,R as On,h as En,i as An,j as Mn,s as Dn,M as In,T as Ln,k as Nn,l as Fn,m as Un,C as jn}from"../chunks/RenderGeometry.js";import{T as Vn,a as kn,R as zn,n as qn,I as Gn,b as Hn}from"../chunks/Scheduler.js";import{w as Bn}from"../chunks/weather.js";import{D as Wn}from"../chunks/DefaultTechniqueConfiguration.js";import{T as $n}from"../chunks/Transform.glsl.js";import{g as Qn}from"../chunks/glUtil.js";import{n as Xn}from"../chunks/InterleavedLayout.js";import{g as Yn}from"../chunks/GeometryUtil.js";import{T as Zn}from"../chunks/Texture.js";import{W as Kn}from"../chunks/WatchUpdatingTracking.js";import{n as Jn,t as eo,s as to,u as io,d as ro,B as so}from"../chunks/DefaultBufferWriter.js";import{p as ao,a as no}from"../chunks/Util2.js";import{f as oo,g as lo}from"../chunks/assets.js";import{A as ho,b as co}from"../chunks/AlignPixel.glsl.js";import{c as uo,e as po,d as mo}from"../chunks/axisAngleDegrees.js";import{S as _o}from"../chunks/ShaderOutput.js";import{R as go}from"../chunks/RenderSlot.js";import{p as fo}from"../chunks/earthUtils.js";import{c as yo,a as vo,C as bo,b as xo,S as To,d as wo}from"../chunks/ShadowCastVisualizeTechniqueConfiguration.js";import{M as Co,A as So,F as Po,a as Ro}from"../chunks/SSAOHelper.js";import Oo from"../webscene/background/ColorBackground.js";import{e as Eo,j as Ao,c as Mo,k as Do,t as Io,l as Lo,d as No,g as Fo}from"../chunks/sphere.js";import{b as Uo,C as jo}from"../chunks/Cyclical.js";import{a as Vo,b as ko}from"../chunks/vector.js";import{a as zo,c as qo,d as Go,s as Ho,w as Bo}from"../chunks/ray.js";import{c as Wo,h as $o,r as Qo,f as Xo,n as Yo,k as Zo,t as Ko,u as Jo,d as el,s as tl}from"../chunks/plane.js";import{b as il,f as rl,c as sl}from"../chunks/ray2.js";import{C as al,P as nl}from"../chunks/Camera.js";import{T as ol,a as ll,b as hl}from"../chunks/verticalOffsetUtils.js";import{a as cl,D as dl,S as ul,i as pl,I as ml,s as _l,n as gl}from"../chunks/Intersector2.js";import{I as fl,a as yl,V as vl}from"../chunks/InputManager.js";import{m as bl,n as xl,d as Tl,o as wl}from"../chunks/viewpointUtils.js";import{F as Cl,M as Sl,Z as Pl,R as Rl,P as Ol}from"../chunks/ZoomMomentumEstimator.js";import{V as El,a as Al,G as Ml,b as Dl,T as Il,C as Ll,h as Nl,v as Fl,L as Ul,t as jl,c as Vl,d as kl,m as zl,F as ql,e as Gl,E as Hl}from"../chunks/ElevationQuery2.js";import{H as Bl,S as Wl}from"../chunks/HUDMaterial.js";import{b as $l}from"../chunks/hydratedFeatures.js";import{createLabelFunction as Ql}from"../chunks/labelFormatUtils.js";import{b as Xl}from"../chunks/calloutUtils.js";import{c as Yl,o as Zl,r as Kl,k as Jl,x as eh,f as th,s as ih}from"../chunks/aaBoundingBox.js";import{g as rh,c as sh,N as ah}from"../chunks/watch.js";import{W as nh,i as oh,O as lh,U as hh}from"../chunks/TriangleMaterial.js";import{F as ch,V as dh}from"../chunks/FeatureTileDescriptor3D.js";import{j as uh,P as ph,i as mh,N as _h,c as gh,a as fh}from"../chunks/frustum.js";import{a as yh}from"../chunks/triangle.js";import{O as vh}from"../chunks/ArrayPool.js";import{P as bh}from"../chunks/PropertiesPool.js";import{g as xh}from"../chunks/ElevationProvider.js";import{f as Th}from"../chunks/vec4f32.js";import{getGeometryServiceURL as wh}from"../chunks/geometryServiceUtils.js";import{p as Ch}from"../chunks/project.js";import Sh from"../rest/support/ProjectParameters.js";import Ph from"../geometry/Point.js";import Rh from"../geometry/SpatialReference.js";import{M as Oh,a as Eh}from"../chunks/MemCache.js";import Ah,{i as Mh}from"./3d/support/SceneViewPerformanceInfo.js";import{S as Dh,g as Ih,a as Lh,b as Nh,c as Fh,r as Uh,w as jh,I as Vh,d as kh,o as zh,n as qh,e as Gh,f as Hh,E as Bh,h as Wh,j as $h,k as Qh,l as Xh,m as Yh,p as Zh,q as Kh,s as Jh,v as ec,t as tc,u as ic,x as rc,y as sc,z as ac,A as nc,i as oc,B as lc,C as hc,D as cc,F as dc,G as uc,H as pc,J as mc,K as _c,L as gc}from"../chunks/terrainUtils.js";import{l as fc,D as yc,c as vc}from"../chunks/DefaultMaterial_COLOR_GAMMA.js";import{l as bc}from"../chunks/objectResourceUtils.js";import{isSVG as xc}from"../core/urlUtils.js";import{P as Tc,a as wc,V as Cc,S as Sc,C as Pc,A as Rc,D as Oc,R as Ec}from"../chunks/basicInterfaces.js";import{T as Ac}from"../chunks/Texture2.js";import"../symbols.js";import Mc from"../symbols/PointSymbol3D.js";import Dc from"../symbols/IconSymbol3DLayer.js";import Ic from"../symbols/TextSymbol3DLayer.js";import{C as Lc}from"../chunks/CollectionFlattener.js";import{isRefreshableLayer as Nc}from"../layers/mixins/RefreshableLayer.js";import{E as Fc}from"../chunks/ElevationQueryTileCache.js";import{a as Uc,E as jc}from"../chunks/LercDecoder.js";import{V as Vc,p as kc}from"../chunks/VectorTile.js";import{E as zc}from"../chunks/ElevationSamplerData.js";import{E as qc,W as Gc,G as Hc,a as Bc,P as Wc,b as $c,T as Qc,M as Xc,c as Yc,d as Zc,e as Kc}from"../chunks/TerrainConst.js";import{O as Jc,T as ed,a as td,N as id,R as rd,P as sd,L as ad}from"../chunks/interfaces4.js";import{y2lat as nd}from"../geometry/support/webMercatorUtils.js";import{g as od}from"../chunks/common.js";import{c as ld,g as hd,a as cd,b as dd,d as ud,e as pd,f as md}from"../chunks/rasterUtils.js";import{S as _d,a as gd}from"../chunks/Slice.glsl.js";import{a as fd,N as yd,b as vd,c as bd}from"../chunks/VertexNormal.glsl.js";import{O as xd}from"../chunks/OutputDepth.glsl.js";import{O as Td,u as wd}from"../chunks/OutputHighlight.glsl.js";import{E as Cd,a as Sd,b as Pd,c as Rd}from"../chunks/EvaluateSceneLighting.glsl.js";import{N as Od}from"../chunks/NormalUtils.glsl.js";import{a as Ed,c as Ad,b as Md,M as Dd,F as Id}from"../chunks/View.glsl.js";import{n as Ld}from"../chunks/DoubleArray.js";import{B as Nd,c as Fd}from"../chunks/BufferView.js";import Ud from"./2d/ViewState.js";import{C as jd,a as Vd}from"../chunks/context-util.js";import{A as kd}from"../chunks/Attribute.js";import{a as zd,c as qd}from"../chunks/mat3f32.js";import{b as Gd}from"../chunks/vec32.js";import{C as Hd,e as Bd}from"../chunks/symbolColorUtils.js";import{p as Wd,i as $d,d as Qd,e as Xd,r as Yd}from"../chunks/orientedBoundingBox.js";import{a as Zd}from"../chunks/Indices.js";import{a as Kd}from"../chunks/quat.js";import{c as Jd}from"../chunks/quatf64.js";import{p as eu,u as tu}from"../chunks/floatRGBA.js";import{D as iu,M as ru,F as su,a as au}from"../chunks/MixExternalColor.glsl.js";import{T as nu}from"../chunks/Texture2DDrawUniform.js";import{N as ou}from"../chunks/Normals.glsl.js";import{T as lu}from"../chunks/TransparencyPassType.js";import{V as hu}from"../chunks/VertexColor.glsl.js";import{C as cu}from"../chunks/DefaultMaterial.glsl.js";import{m as du}from"../chunks/MultipassTerrainTest.glsl.js";import{s as uu,d as pu}from"../chunks/AlphaCutoff.js";import{c as mu,o as _u,a as gu,O as fu}from"../chunks/OrderIndependentTransparency.js";import{e as yu,E as vu,a as bu,V as xu,b as Tu,g as wu,R as Cu,S as Su}from"../chunks/edgeProcessing.js";import{O as Pu}from"../chunks/Octree.js";import{r as Ru}from"../chunks/requestImageUtils.js";import{l as Ou}from"../chunks/resources.js";import{F as Eu}from"../chunks/SSAOBlur.glsl.js";import{C as Au}from"../chunks/CameraSpace.glsl.js";import{M as Mu}from"../chunks/Matrix3PassUniform.js";import{T as Du}from"../chunks/edgeUtils.js";import{E as Iu}from"../chunks/EdgeWorkerHandle.js";import{o as Lu}from"../chunks/utils.js";import{h as Nu}from"../chunks/DisjointTimerQuery.js";import{R as Fu}from"../chunks/RenderingContext.js";import{S as Uu}from"../chunks/LineStipple.glsl.js";import{c as ju}from"../chunks/imageUtils.js";import{a as Vu,b as ku}from"../chunks/intersectorUtilsConversions.js";import{h as zu}from"../chunks/hitTestSelectUtils.js";import{o as qu}from"../chunks/layerViewUtils.js";import{i as Gu,a as Hu}from"../chunks/screenUtils2.js";import{i as Bu}from"../chunks/spatialReferenceSupport.js";import Wu from"./ui/DefaultUI.js";import $u from"../geometry/Extent.js";import"../core/Clonable.js";import"../chunks/get.js";import"../chunks/metadata.js";import"../chunks/tracking.js";import"../chunks/object.js";import"../config.js";import"../chunks/string.js";import"../chunks/nextTick.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../chunks/writer.js";import"../geometry/Geometry.js";import"../chunks/jsonMap.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../chunks/locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../chunks/colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../symbols/Font.js";import"../chunks/persistableUrlUtils.js";import"../chunks/Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"../chunks/messages.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/lineSegment.js";import"../chunks/spatialReferenceEllipsoidUtils.js";import"../layers/Layer.js";import"../symbols/support/symbolUtils.js";import"../chunks/utils6.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/mat4f32.js";import"../chunks/_commonjsHelpers.js";import"../chunks/ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils7.js";import"../chunks/previewUtils.js";import"../chunks/renderUtils.js";import"../chunks/colorUtils2.js";import"../chunks/projector.js";import"../chunks/widgetUtils.js";import"../chunks/mat2df32.js";import"../chunks/mat2d.js";import"../chunks/jsxFactory.js";import"../chunks/jsxWidgetSupport.js";import"../chunks/previewSymbol3D.js";import"../chunks/webStyleSymbolUtils.js";import"../chunks/devEnvironmentUtils.js";import"../symbols/support/jsonUtils.js";import"../chunks/styleUtils.js";import"../widgets/Feature/FeatureViewModel.js";import"../chunks/throttle.js";import"../widgets/Attachments/AttachmentsViewModel.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"../chunks/DataLayerSource.js";import"../layers/support/Field.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/fieldType.js";import"../chunks/executeQueryJSON.js";import"../chunks/utils4.js";import"../chunks/query.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils5.js";import"../chunks/urlUtils2.js";import"../chunks/pbfQueryUtils.js";import"../chunks/pbf.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/queryZScale.js";import"../rest/support/FeatureSet.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/FullTextSearch.js";import"../rest/support/StatisticDefinition.js";import"../chunks/featureConversionUtils.js";import"../rest/support/RelationshipQuery.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../renderers/DictionaryRenderer.js";import"../chunks/DictionaryLoader.js";import"../chunks/LRUCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../chunks/heatmapUtils.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../renderers/support/jsonUtils.js";import"../chunks/MultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../chunks/editsZScale.js";import"../layers/mixins/APIKeyMixin.js";import"../chunks/ArcGISService.js";import"../chunks/arcgisLayerUrl.js";import"../layers/mixins/BlendLayer.js";import"../layers/mixins/CustomParametersMixin.js";import"../chunks/EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../layers/mixins/FeatureLayerBase.js";import"../chunks/commonProperties2.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/TimeReference.js";import"../chunks/datetime.js";import"../chunks/featureLayerUtils.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../chunks/serviceCapabilitiesUtils.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"../chunks/FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"../chunks/labelUtils.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"../chunks/clusterUtils.js";import"../chunks/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../chunks/fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../chunks/labelingInfo.js";import"../chunks/versionUtils.js";import"../chunks/styleUtils2.js";import"../support/popupUtils.js";import"../chunks/actions.js";import"../chunks/AnchorElementViewModel.js";import"../widgets/support/GoTo.js";import"../chunks/ObservableValue.js";import"../Map.js";import"../Basemap.js";import"../chunks/loadAll.js";import"../chunks/writeUtils.js";import"../Ground.js";import"../chunks/editableLayers.js";import"../chunks/basemapUtils.js";import"../chunks/collectionUtils2.js";import"../support/LayersMixin.js";import"../support/TablesMixin.js";import"./BasemapView.js";import"./Magnifier.js";import"../chunks/intersectionUtils.js";import"../chunks/NestedMap.js";import"../chunks/ViewEvents.js";import"../chunks/IViewEvents.js";import"../chunks/interfaces5.js";import"./input/Input.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"./navigation/Navigation.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/heightModelInfoUtils.js";import"../chunks/byteSizeEstimations.js";import"../chunks/debugFlags.js";import"../widgets/Popup.js";import"../widgets/Feature.js";import"../widgets/Widget.js";import"../chunks/uuid.js";import"../chunks/dom.js";import"../chunks/index.js";import"../widgets/Attachments.js";import"../chunks/unitFormatUtils.js";import"../chunks/messageBundle.js";import"../chunks/Heading.js";import"../widgets/support/widget.js";import"../chunks/accessibleHandler.js";import"../chunks/vmEvent.js";import"../chunks/themeUtils.js";import"../chunks/uriUtils.js";import"../chunks/utils16.js";import"../chunks/numberUtils.js";import"../chunks/chartUtils.js";import"../chunks/Spinner.js";import"../widgets/Spinner/SpinnerViewModel.js";import"../layers/support/ElevationSampler.js";import"../layers/support/LOD.js";import"../layers/support/TileInfo.js";import"../chunks/TileKey.js";import"../chunks/capabilities2.js";import"./3d/environment/SunnyWeather.js";import"../chunks/lightingTypes.js";import"../webscene/background/Background.js";import"../chunks/VertexElementDescriptor.js";import"../chunks/vec2f32.js";import"../chunks/TextureOnly.glsl.js";import"../chunks/MultipassGeometryTest.glsl.js";import"../chunks/Intersector.js";import"../chunks/AppleAmdDriverHelper.js";import"./3d/environment/CloudyWeather.js";import"./3d/environment/FoggyWeather.js";import"./3d/environment/RainyWeather.js";import"./3d/environment/SnowyWeather.js";import"../chunks/types.js";import"../chunks/doublePrecisionUtils.js";import"../chunks/VerticalOffset.glsl.js";import"../chunks/SSAO.glsl.js";import"../chunks/ElevationContext.js";import"../chunks/graphicUtils.js";import"../chunks/dehydratedFeatures.js";import"../chunks/quantizationUtils.js";import"../chunks/LineCallout.glsl.js";import"../chunks/earcut.js";import"../chunks/SnappingCandidate.js";import"../chunks/triangulationUtils.js";import"../chunks/deduplicate.js";import"../chunks/callExpressionWithFeature.js";import"../chunks/sdfPrimitives.js";import"../chunks/RibbonLine.glsl.js";import"../chunks/ObjectAndLayerIdColor.glsl.js";import"../chunks/MarkerSizing.glsl.js";import"../chunks/VisualVariables.glsl.js";import"../chunks/line.js";import"../chunks/line2.js";import"../chunks/LineMarkerMaterial.js";import"../chunks/GLTextureMaterial.js";import"../chunks/LineMarker.glsl.js";import"../chunks/lineStippleUtils.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"../chunks/projection.js";import"../chunks/resourceUtils2.js";import"../chunks/NativeLineMaterial.js";import"../chunks/NativeLine.glsl.js";import"../chunks/Intersector3.js";import"../chunks/Path.glsl.js";import"../chunks/ColorMaterial.js";import"../chunks/ColorMaterial.glsl.js";import"../chunks/Pattern.glsl.js";import"../chunks/HUDMaterial.glsl.js";import"./3d/support/LayerPerformanceInfo.js";import"../chunks/Version.js";import"../chunks/RealisticTree.glsl.js";import"../chunks/WorkerHandle.js";import"../chunks/enums2.js";import"../chunks/config.js";import"../chunks/TiledDisplayObject.js";import"../chunks/DisplayObject.js";import"../chunks/TileKey2.js";import"../chunks/mat2df64.js";import"../chunks/quatf32.js";import"../chunks/DiscardOrAdjustAlphaBlend.glsl.js";import"../chunks/workerHelper.js";import"../chunks/ProgramCache.js";import"../chunks/Program.js";import"../chunks/DefaultVertexAttributeLayouts.js";import"./ui/UI.js";import"../widgets/Attribution.js";import"../widgets/Attribution/AttributionViewModel.js";import"../widgets/Compass.js";import"../widgets/Compass/CompassViewModel.js";import"../widgets/NavigationToggle.js";import"../widgets/NavigationToggle/NavigationToggleViewModel.js";import"../widgets/Zoom.js";import"../widgets/Zoom/ZoomViewModel.js";const Qu=()=>import("../chunks/TileLayerView3D.js"),Xu=()=>import("../chunks/ElevationLayerView3D.js"),Yu={"base-dynamic":()=>import("../chunks/BaseDynamicLayerView3D.js"),"base-elevation":Xu,"base-tile":Qu,"bing-maps":Qu,"building-scene":()=>import("../chunks/BuildingSceneLayerView3D.js"),csv:()=>import("../chunks/CSVLayerView3D.js"),dimension:()=>import("../chunks/DimensionLayerView3D.js"),elevation:Xu,feature:()=>import("../chunks/FeatureLayerView3D.js"),geojson:()=>import("../chunks/GeoJSONLayerView3D.js"),graphics:()=>import("../chunks/GraphicsLayerView3D.js"),group:()=>import("../chunks/GroupLayerView.js"),imagery:()=>import("../chunks/ImageryLayerView3D.js"),"integrated-mesh":()=>import("../chunks/IntegratedMeshLayerView3D.js"),"line-of-sight":()=>import("../chunks/LineOfSightLayerView3D.js"),"map-image":()=>import("../chunks/MapImageLayerView3D.js"),media:()=>import("../chunks/MediaLayerView3D.js"),"ogc-feature":()=>import("../chunks/OGCFeatureLayerView3D.js"),"open-street-map":Qu,"oriented-imagery":()=>import("../chunks/FeatureLayerView3D.js"),"point-cloud":()=>import("../chunks/PointCloudLayerView3D.js"),voxel:()=>import("../chunks/VoxelLayerView3D.js"),route:()=>import("../chunks/RouteLayerView3D.js"),scene:e=>null==e.profile||"mesh-pyramids"===e.profile?import("../chunks/SceneLayerView3D.js"):import("../chunks/SceneLayerGraphicsView3D.js"),stream:()=>import("../chunks/StreamLayerView3D.js"),tile:Qu,"imagery-tile":()=>import("../chunks/ImageryTileLayerView3D.js"),"vector-tile":()=>import("../chunks/VectorTileLayerView3D.js"),wcs:()=>import("../chunks/ImageryTileLayerView3D.js"),"web-tile":Qu,wfs:()=>import("../chunks/WFSLayerView3D.js"),wms:()=>import("../chunks/WMSLayerView3D.js"),wmts:()=>import("../chunks/WMTSLayerView3D.js"),"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null},Zu="analyses-owner-handles";var Ku,Ju;!function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"}(Ku||(Ku={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(Ju||(Ju={}));let ep=class extends Gi{constructor(e){super(e),this._allAnalysisViews=new s,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=tp(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(l("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(l()),this._attachedToViewResolver=tp()}get updating(){return!this.view.ready||0!==this._creatingViewCount||this._allAnalysisViews.some((e=>e.updating))}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(M(t)||t.state.list===Ju.REMOVED)throw new o("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),Zu)}_disconnectOwners(){this.handles.remove(Zu),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const t of e)this._addAnalysis(t);const t=e.on("after-add",(e=>this._addAnalysis(e.item))),i=e.on("after-remove",(e=>this._removeAnalysis(e.item)));return{remove:()=>{t.remove(),i.remove();for(const t of e)this._removeAnalysis(t)}}}_addAnalysis(e){const t=this._items.get(e);if(null==t){const t={state:{view:Ku.PENDING,list:Ju.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,t),t.createAnalysisViewTask=ki((e=>this._createAnalysisViewPromise(t,e)))}else t.state.list=Ju.ADDED}_removeAnalysis(e){const t=this._items.get(e);null!=t?(t.state.list=Ju.REMOVED,this._scheduleUpdate()):E.getLogger(this.declaredClass).error("Trying to remove analysis which was not added")}_scheduleUpdate(){A(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=Y((()=>this._update())))}_update(){this._scheduledUpdateHandle=D(this._scheduledUpdateHandle),this._items.forEach((e=>{if(e.state.list===Ju.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case Ku.PENDING:e.createAnalysisViewTask=L(e.createAnalysisViewTask);break;case Ku.CREATED:A(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=I(e.view),e.createAnalysisViewTask=null)}}))}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,M(s.module))try{s.module=await this._loadAnalysisModule(r)}catch(e){throw this._creatingViewCount-=1,e}if(h(t))throw this._creatingViewCount-=1,l("AnalysisView creation aborted");const a=new s.module.default({analysis:i,view:this.view});try{await a.when()}catch(e){throw this._creatingViewCount-=1,e}if(h(t))throw this._creatingViewCount-=1,a.destroy(),l("AnalysisView creation aborted");return e.view=a,e.state.view=Ku.CREATED,this._allAnalysisViews.add(a),this._creatingViewCount-=1,a}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./3d/analysis/AreaMeasurementAnalysisView3D.js");case"dimension":return import("../chunks/DimensionAnalysisView3D.js");case"direct-line-measurement":return import("./3d/analysis/DirectLineMeasurementAnalysisView3D.js");case"line-of-sight":return import("./3d/analysis/LineOfSightAnalysisView3D.js");case"slice":return import("./3d/analysis/SliceAnalysisView3D.js")}}};function tp(){const e=c();return e.promise.catch((()=>{})),e}e([ce()],ep.prototype,"updating",null),e([ce({constructOnly:!0})],ep.prototype,"view",void 0),e([ce()],ep.prototype,"_allAnalysisViews",void 0),e([ce()],ep.prototype,"_creatingViewCount",void 0),ep=e([ue("esri.views.3d.analysis.AnalysisViewManager3D")],ep);const ip=ep;let rp=class extends Hi{constructor(e){super(e),this.collision=new op,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Ui.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Ui.Local?this._set("altitude",e):E.getLogger(this.declaredClass).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?Bi(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return Bi(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Ui.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=np)=>(i.min=ap.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?rr([[4e3,ap.max],[1e4,Wi(88)],[6e6,Wi(88)]]):()=>ap.max;return(t,i=np)=>(i.min=ap.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?rr([[4e3,ap.max],[5e4,Wi(88)],[6e6,Wi(88)],[2e7,ap.min]]):rr([[3e5,ap.max],[3e6,Wi(88)],[6e6,Wi(88)],[2e7,ap.min]]);return(t,i=np)=>(i.min=ap.min,i.max=e(t),i)}};e([ce()],rp.prototype,"altitude",null),e([ce({readOnly:!0})],rp.prototype,"collision",void 0),e([ce()],rp.prototype,"distance",void 0),e([ce({readOnly:!0})],rp.prototype,"minimumPoiDistance",void 0),e([ce()],rp.prototype,"tilt",void 0),e([ce({constructOnly:!0})],rp.prototype,"mode",void 0),rp=e([ue("esri.views.3d.state.Constraints")],rp);const sp={min:-2e5,max:4*er.radius},ap={min:Wi(.5),max:Wi(179.5)},np={min:0,max:0};let op=class extends Hi{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};e([ce({type:Boolean})],op.prototype,"enabled",void 0),e([ce({type:Number})],op.prototype,"elevationMargin",void 0),op=e([ue("esri.views.3d.state.Constraints.CollisionConstraint")],op);let lp=class extends Hi{constructor(){super(...arguments),this.min=sp.min,this.max=sp.max}};e([ce({type:Number})],lp.prototype,"min",void 0),e([ce({type:Number})],lp.prototype,"max",void 0),lp=e([ue("esri.views.3d.constraints.AltitudeConstraint")],lp);let hp=class extends Hi{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){"auto"===this.mode&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};e([ce({type:Number,value:1e-8})],hp.prototype,"near",null),e([de("near")],hp.prototype,"castNear",null),e([ce({type:Number,value:1e-8})],hp.prototype,"far",null),e([de("far")],hp.prototype,"castFar",null),e([ce({type:["auto","manual"]})],hp.prototype,"mode",void 0),hp=e([ue("esri.views.3d.constraints.ClipDistanceConstraint")],hp);const cp={min:$i(ap.min),max:$i(ap.max)};let dp=class extends Hi{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return Bi(e,cp.min,cp.max)}autoUpdate(e){"auto"===this.mode&&this._get("max")!==e&&this._set("max",e)}};e([ce({type:["auto","manual"]})],dp.prototype,"mode",void 0),e([ce({type:Number,value:cp.max})],dp.prototype,"max",null),e([de("max")],dp.prototype,"castMax",null),dp=e([ue("esri.views.3d.constraints.TiltConstraint")],dp);let up=class extends Hi{constructor(){super(...arguments),this.tilt=new dp,this.altitude=new lp,this.clipDistance=new hp}};e([ce({type:dp})],up.prototype,"tilt",void 0),e([ce({type:lp})],up.prototype,"altitude",void 0),e([ce({type:hp})],up.prototype,"clipDistance",void 0),up=e([ue("esri.views.3d.constraints.Constraints")],up);const pp={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:lr,virtual:hr}};var mp;let _p=mp=class extends Hi{set quality(e){["low","high"].includes(e)&&this._set("quality",e)}clone(){return new mp({quality:this.quality})}};var gp;e([ce({type:["low","high"],value:"low"})],_p.prototype,"quality",null),_p=mp=e([ue("esri.views.3d.environment.SceneViewAtmosphere")],_p);let fp=gp=class extends cr{constructor(e){super(e),this.atmosphere=new _p,this.lighting=new lr,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new gp({...t,lighting:t.lighting?"virtual"===t.lighting.type?hr.fromWebsceneLighting(t.lighting):lr.fromWebsceneLighting(t.lighting):void 0})}castLighting(e){return this._convertLighting(e)}applyLighting(e){this.lighting=this._convertLighting(e)}_convertLighting(e){return e?e instanceof lr||e instanceof hr?e:e instanceof dr?this.lighting&&"virtual"!==this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new lr({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):e instanceof ur?this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e):new hr({...e.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):pe(pp,e):new lr}clone(){return new gp({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:or(this.background)})}cloneWithWebsceneEnvironment(e){return new gp({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:or(this.background),...e.cloneConstructProperties(),lighting:this._getLighting(e)})}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&"sun"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):lr.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&"virtual"===this.lighting.type?this.lighting.cloneWithWebsceneLighting(e.lighting):hr.fromWebsceneLighting(e.lighting);default:return nr(e.lighting),lr.fromWebsceneLighting(e.lighting)}}};e([ce({type:_p,json:{read:!1},nonNullable:!0})],fp.prototype,"atmosphere",void 0),e([ce({nonNullable:!0})],fp.prototype,"lighting",void 0),e([de("lighting")],fp.prototype,"castLighting",null),fp=gp=e([ue("esri.views.3d.environment.SceneViewEnvironment")],fp);const yp=fp;var vp;!function(e){e[e.Simple=0]="Simple",e[e.Realistic=1]="Realistic",e[e.Panoramic=2]="Panoramic",e[e.None=3]="None"}(vp||(vp={}));const bp=fe(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),xp=fe(3*parseFloat(Number(65e-8).toFixed(6)),3*parseFloat(Number(1881e-9).toFixed(6)),3*parseFloat(Number(85e-9).toFixed(6))),Tp=fe(parseFloat(Number(bp[0]+xp[0]).toFixed(6)),parseFloat(Number(bp[1]+xp[1]).toFixed(6)),parseFloat(Number(bp[2]+xp[2]).toFixed(6))),wp=is(),Cp=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:bp,build:function(e){const t=new Vs;t.attributes.add(Gs.POSITION,"vec2"),t.include(as,{textureCoordinateType:ns.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:r}=t;return i.uniforms.add([new js("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new js("inverseViewMatrix",((e,t)=>Gr(wp,t.camera.viewMatrix)))]),i.code.add(Fs`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add([new Ms("radii",(e=>e.radii)),new Is("cameraPosition",((e,t)=>t.camera.eye)),new Ls("heightParameters",(e=>e.heightParameters)),new Ns("innerFadeDistance",(e=>e.innerFadeDistance)),new Ns("altitudeFade",(e=>e.altitudeFade)),new qs("depthTex",(e=>e.depthTex)),new Ns("hazeStrength",(e=>e.hazeStrength))]),r.constants.add("betaRayleigh","vec3",bp),r.constants.add("betaCombined","vec3",Tp),r.constants.add("betaMie","float",3996e-9),r.constants.add("scaleHeight","float",Bt*Wt),os(r),t.include(xs),e.haze&&(r.include(bs),r.uniforms.add(new Ms("nearFar",((e,t)=>t.camera.nearFar)))),r.code.add(Fs`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(Fs`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),r.code.add(Fs`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),r.code.add(Fs`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${e.haze?Fs`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${e.haze?Fs``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${e.haze?"":Fs`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${e.haze?Fs`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:Fs`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${e.haze?Fs`
          vec4 depthSample = texture(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:Fs`
          float depthSample = texture(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            fragColor = vec4(0);
            return;
          }`}

      ${e.haze?Fs`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:Fs`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      ${e.haze?"":Fs`
          if (depthSample == 1.0) {
            fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);
          }`}
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class Sp extends Us{constructor(){super(...arguments),this.heightParameters=_r(),this.radii=kr(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1}}class Pp extends Hs{initializeProgram(e){return new Bs(e.rctx,Pp.shader.get().build(this.configuration),$s)}initializePipeline(){return this.configuration.haze?Ta({blending:wa(na.ONE,na.ZERO,na.ONE_MINUS_SRC_COLOR,na.ONE),colorWrite:Ca}):Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),depthTest:{func:oa.LEQUAL},colorWrite:Ca})}}Pp.shader=new Ws(Cp,(()=>Promise.resolve().then((()=>Cp))));class Rp extends Aa{constructor(){super(...arguments),this.haze=!1}}e([Ea()],Rp.prototype,"haze",void 0);class Op{constructor(e,t){this._view=e,this.type=vp.Realistic,this._handles=new R,this._passParameters=new Sp,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=er.radius,this._fadeHaze=0,this._updateRadius(er.radius);const i=t.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([G((()=>this._view.basemapTerrain.rootTileElevationBounds),(()=>this._updateRootTileElevationBounds())),G((()=>this._view.basemapTerrain.visibleElevationBounds),(()=>this._updateVisibleElevationBounds()))]);const r=new Rp;r.haze=!1,this._atmosphereTechnique=t.techniqueRepository.acquire(Pp,r),r.haze=!0,this._atmosphereHazeTechnique=t.techniqueRepository.acquire(Pp,r),this._vao=Ma(i,Da)}destroy(){this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._vao.dispose(),this._handles.destroy()}render(e){this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}renderHaze(e,t){this._fadeHaze=t,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}_render(e,t,i){if(M(i))return;this._update(e.bindParameters.camera),this._passParameters.depthTex=i;const r=e.rctx.bindTechnique(t,this._passParameters,e.bindParameters);e.offscreenRenderingHelper.renderDepthDetached((()=>this._renderCommon(r,e)))}_renderCommon(e,t){M(this._vao)||(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(la.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=er.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(er.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,Rr(this._passParameters.radii,e,e+Wt),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-$t)*$t)}_update(e){if(M(e))return;const t=ye(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],s=Bi((i-this._passParameters.radii[0])/Wt,0,1);Dr(this._passParameters.heightParameters,i,t,r,s),this._passParameters.altitudeFade=Qt(i-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=Qi(Qi(.6,1,Xi(9500,10500,i-er.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}}const Ep=is(),Ap=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new Vs;e.attributes.add(Gs.POSITION,"vec2"),e.varyings.add("worldRay","vec3");const{vertex:t,fragment:i}=e;return t.uniforms.add([new js("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new js("inverseViewMatrix",((e,t)=>Gr(Ep,t.camera.viewMatrix)))]),t.code.add(Fs`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),i.include(qa),i.include(Ds),e.include(ls,{pbrMode:hs.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(za),e.include(xs),e.include(cs),e.include(Ts,{instancedDoublePrecision:!1}),i.uniforms.add([new Is("cameraPosition",((e,t)=>t.camera.eye))]),i.code.add(Fs`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}},Symbol.toStringTag,{value:"Module"}));class Mp extends Hs{constructor(e){super(e,new Aa,(()=>this.destroy()))}initializeProgram(e){return new Bs(e.rctx,Mp.shader.get().build(),$s)}initializePipeline(){return Ta({blending:wa(na.ONE,na.ZERO,na.SRC_ALPHA,na.ONE),depthTest:{func:oa.LEQUAL},colorWrite:Ca})}}Mp.shader=new Ws(Ap,(()=>Promise.resolve().then((()=>Ap))));let Dp=class extends Hi{constructor(e){super(e),this._technique=new Mp(e),this._vao=Ma(e.rctx)}destroy(){this._technique=N(this._technique),this._vao=F(this._vao)}render(e){const t=e.bindParameters.cloudsFade;if(M(this._vao)||M(t.data))return;if(!this._technique.compiled)return void this.requestRender();const i=e.rctx.bindTechnique(this._technique,Ip,e.bindParameters);e.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(la.TRIANGLE_STRIP,0,4)}};e([ce({constructOnly:!0})],Dp.prototype,"rctx",void 0),e([ce({constructOnly:!0})],Dp.prototype,"viewingMode",void 0),e([ce({constructOnly:!0})],Dp.prototype,"planetRadius",void 0),e([ce({constructOnly:!0})],Dp.prototype,"requestRender",void 0),Dp=e([ue("esri.views.3d.environment.CloudsComposition")],Dp);const Ip=new Us;var Lp;!function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"}(Lp||(Lp={}));class Np extends Aa{constructor(){super(...arguments),this.steps=Lp.SIXTEEN,this.writeTextureChannels=ws.RG}}e([Ea({count:Lp.COUNT})],Np.prototype,"steps",void 0),e([Ea({constValue:b("esri-mobile")?1024:2048})],Np.prototype,"cubeMapSize",void 0),e([Ea()],Np.prototype,"writeTextureChannels",void 0);class Fp{constructor(e,t,i,r,s,a,n,o,l=.5){this.coverage=e,this.density=t,this.absorption=i,this.cloudSize=r,this.detailSize=s,this.smoothness=a,this.cloudHeight=n,this.raymarchingSteps=o,this.median=l}}const Up=new Fp([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Lp.SIXTEEN),jp={sunny:Up,cloudy:new Fp([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Lp.TWOHUNDRED,.6),rainy:new Fp([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Lp.TWOHUNDRED,.4),snowy:new Fp([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Lp.HUNDRED,.65),foggy:new Fp([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Lp.SIXTEEN),default:Up},Vp=b("esri-mobile")?64:128,kp=Vp/128,zp=Math.ceil(Math.sqrt(Vp)),qp=(Vp+2)*zp,Gp=qp/1560;class Hp extends Us{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=jp.default.raymarchingSteps,this.weatherTile=kr()}}class Bp extends Us{constructor(){super(...arguments),this.viewMatrix=Za()}}const Wp=kr(),$p=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:Bp,CloudsPassParameters:Hp,build:function(e){const t=new Vs;t.include(Ka,!1);const i=t.fragment;return i.uniforms.add([new Ns("cloudRadius",(e=>e.cloudRadius)),new Ns("power",(e=>Qi(35,120,e.absorption))),new Ns("sigmaE",(e=>1+e.absorption)),new Ns("density",(e=>Qi(0,.3,e.density))),new Ns("cloudSize",(e=>Qi(0,.02,Math.max(.01,1-e.cloudSize)))),new Ns("detailSize",(e=>Qi(0,.2,Math.max(.01,1-e.detailSize)))),new Ns("smoothness",(e=>Qi(0,.5,1-e.smoothness))),new Ns("cloudHeight",(e=>Qi(0,1500,e.cloudHeight))),new Ns("coverage",(e=>e.coverage)),new Ja("view",(e=>e.viewMatrix)),new qs("cloudShapeTexture",(e=>A(e.noiseTexture)?e.noiseTexture.textureAtlas:null)),new Ms("cloudVariables",(e=>Rr(Wp,e.coverage,e.absorption)))]),i.constants.add("halfCubeMapSize","float",.5*e.cubeMapSize),i.code.add(Fs`
    const int STEPS = ${e.steps===Lp.SIXTEEN?Fs`16`:e.steps===Lp.HUNDRED?Fs`100`:Fs`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),i.code.add(Fs`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${Fs.float(qp)};
      const float dataWidth = ${Fs.float(qp)};
      const float tileRows = ${Fs.float(zp)};
      const vec3 atlasDimensions = vec3(${Fs.float(Vp)}, ${Fs.float(Vp)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${Fs.float(kp)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Non-power-of-two textures can't be tiled using WebGL1
      // Get fractional part of uv to tile
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = fract((${Fs.float(Gp)} * p) / ${Fs.float(qp)} + 0.5);

      return texture(cloudShapeTexture, uv).a;
    }
    `),i.code.add(Fs`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),i.code.add(Fs`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),i.code.add("\n    float multipleOctaves(float extinction, float mu, float stepL) {\n      float attenuation = 1.0;\n      float contribution = 1.0;\n      float phaseAttenuation = 1.0;\n      float luminance = 0.0;\n\n      for (int i = 0; i < 4; i++) {\n        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);\n        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);\n        attenuation *= 0.2;\n        contribution *= 0.6;\n        phaseAttenuation *= 0.5;\n      }\n\n      return luminance;\n    }"),i.code.add(Fs`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),i.code.add(Fs`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),i.code.add(Fs`void main() {
if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),t}},Symbol.toStringTag,{value:"Module"}));class Qp extends Hs{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new Bs(e.rctx,Qp.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:Sa(na.CONSTANT_COLOR,na.ONE_MINUS_CONSTANT_COLOR,ha.ADD,this.configuration.writeTextureChannels===ws.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:oa.LEQUAL},colorWrite:Ca})}}var Xp;Qp.shader=new Ws($p,(()=>Promise.resolve().then((()=>$p)))),function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"}(Xp||(Xp={}));class Yp extends Aa{constructor(){super(...arguments),this.mode=Xp.Full}}e([Ea({count:Xp.COUNT})],Yp.prototype,"mode",void 0);class Zp extends Us{constructor(){super(...arguments),this.weatherTile=zr(0,0)}}const Kp=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:Zp,build:function(e){const t=new Vs;if(t.include(Ka,!1),t.fragment.code.add(Fs`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),e.mode===Xp.Full){const e=2,i=8;t.fragment.code.add(Fs`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${Fs.float(zp)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${Fs.float(i)});

      float worley0 = worley(p, ${Fs.float(e)} * 2.0);
      float worley1 = worley(p, ${Fs.float(e)} * 8.0);
      float worley2 = worley(p, ${Fs.float(e)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${Fs.float(e)});
      float worley1 = worley(p, ${Fs.float(e)} * 2.0);
      float worley2 = worley(p, ${Fs.float(e)} * 4.0);
      float worley3 = worley(p, ${Fs.float(e)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `)}return t.fragment.uniforms.add(new Ms("weatherTile",(e=>e.weatherTile))),t.fragment.code.add(Fs`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${Fs.float(128)});

      // Get global coordinates of p
      p += weatherTile * ${Fs.float(128)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${Fs.float(1e5)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),t.fragment.code.add(Fs`void main() {`),e.mode===Xp.Full&&t.fragment.code.add(Fs`
        float padWidth = 1.0;
        float paddedSize = ${Fs.float(Vp)} + 2.0 * padWidth;
        float tileCount = ${Fs.float(zp)} * ${Fs.float(zp)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${Fs.float(Vp)};
          }

          if (startPadY) {
            pixel.y += ${Fs.float(Vp)};
          }

          if (endPadX) {
            pixel.x -= ${Fs.float(Vp)};
          }

          if (endPadY) {
            pixel.y -= ${Fs.float(Vp)};
          }

          uv = vec2(pixel.xy / ${Fs.float(Vp)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${Fs.float(Vp)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${Fs.float(zp)} * ${Fs.float(zp)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${Fs.float(zp)} * ${Fs.float(zp)});
        p = p_;
        p.z /= (${Fs.float(zp)} * ${Fs.float(zp)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),t.fragment.code.add(Fs`
      vec2 mapUV = ${Fs.float(128)} * (gl_FragCoord.xy / ${Fs.float(qp)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${e.mode===Xp.Full?Fs`fragColor.ba = vec2(0.0, map);`:Fs`fragColor = vec4(map);`};
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class Jp extends Hs{initializeProgram(e){return new Bs(e.rctx,Jp.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:this.configuration.mode===Xp.Full?Sa(na.ONE,na.ZERO):wa(na.ZERO,na.ONE,na.ONE,na.ZERO),depthTest:{func:oa.ALWAYS},colorWrite:Ca})}}Jp.shader=new Ws(Kp,(()=>Promise.resolve().then((()=>Kp))));let em=class extends Hi{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Zp,this._frameBuffer=new hn(e.context.renderContext.rctx,{colorTarget:ca.TEXTURE,width:qp,height:qp},{target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:_a.LINEAR,hasMipmap:!1,width:qp,height:qp}),this._vao=Ma(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return A(this._texture)?A(this._weatherMapTechnique)&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(Xp.WeatherMap)):A(this._fullTechnique)&&this._fullTechnique.compiled&&(this._texture=this._render(Xp.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(Or(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=N(this._fullTechniqueCached),this._weatherMapTechniqueCached=N(this._weatherMapTechniqueCached),this._frameBuffer=F(this._frameBuffer),this._vao=F(this._vao)}get _fullTechnique(){if(M(this._fullTechniqueCached)){const e=new Yp;e.mode=Xp.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(Jp,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(M(this._weatherMapTechniqueCached)){const e=new Yp;e.mode=Xp.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(Jp,e)}return this._weatherMapTechniqueCached}_render(e){if(M(this._vao)||M(this._frameBuffer))return null;const t=e===Xp.Full?this._fullTechnique:this._weatherMapTechnique,i=this.context.renderContext.rctx,r=i.getViewport();i.setViewport(0,0,qp,qp),i.bindFramebuffer(this._frameBuffer);const s=i.bindTechnique(t,this._passParameters,null);return i.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.setViewport(r.x,r.y,r.width,r.height),this._needsRender=!1,this._frameBuffer.colorTexture}};e([ce({constructOnly:!0})],em.prototype,"context",void 0),e([ce({readOnly:!0})],em.prototype,"_techniqueRepository",null),em=e([ue("esri.views.3d.environment.NoiseTextureAtlas")],em);let tm=class extends Hi{constructor(e){super(e),this._handles=new R,this._techniques=new Array,this._techniqueConfiguration=new Np,this._bindParameters=new fn(null,null,null),this._passParameters=new Hp,this._drawParameters=new Bp,this._weatherTile=kr(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=Qi(jp.default.coverage[0],jp.default.coverage[1],.5),this.density=Qi(jp.default.density[0],jp.default.density[1],.5),this.absorption=Qi(jp.default.absorption[0],jp.default.absorption[1],.5),this.cloudSize=Qi(jp.default.cloudSize[0],jp.default.cloudSize[1],.5),this.detailSize=Qi(jp.default.detailSize[0],jp.default.detailSize[1],.5),this.smoothness=Qi(jp.default.smoothness[0],jp.default.smoothness[1],.5),this.cloudHeight=Qi(jp.default.cloudHeight[0],jp.default.cloudHeight[1],.5),this.raymarchingSteps=jp.default.raymarchingSteps,this._viewMatrix=is(),this._dirty=!1,this.running=!1}_getTechnique(e){const t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,i=t===ws.RG?2*e:2*e+1;return this._techniques[i]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[i]=new Qp({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[i])}updateWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(null==e||null==t)return;Rr(this._weatherTile,(e+90)/180,(t+180)/360);const i=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-i)*this._weatherTile[1]);let r=0,s=0;if(A(this.view.environment)&&"virtual"!==this.view.environment.lighting.type&&A(this.view.environment.lighting.date)){const e=new Date(this.view.environment.lighting.date);e.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),r=31*e.getUTCMonth()+e.getUTCDate(),s=e.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+r)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+s%100)%(4*this._weatherTileCount),Er(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){this._vao=Ma(this.context.renderContext.rctx);const e=br(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this._handles.add([this.view.resourceController.scheduler.registerTask(Vn.CLOUDS_GENERATOR,this),G((()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps]),(()=>this.setDirty()),H)])}destroy(){this._handles.destroy(),this._techniques.forEach((e=>N(e))),this._frameBufferCube=F(this._frameBufferCube),this._techniques.length=0,this._vao=F(this._vao),this._passParameters.noiseTexture=I(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case Lp.SIXTEEN:return 1;case Lp.HUNDRED:return 4;case Lp.COUNT:case Lp.TWOHUNDRED:return 8}}_ensureNoiseTexture(){if(A(this._passParameters.noiseTexture))this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new em({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return A(this._passParameters.noiseTexture.textureAtlas)}_ensureFrameBufferCube(e){if(M(this._frameBufferCube)){const t={target:da.TEXTURE_CUBE_MAP,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:_a.LINEAR,hasMipmap:!1,width:e,height:e};this._frameBufferCube=new hn(this.context.renderContext.rctx,{colorTarget:ca.CUBEMAP,width:e,height:e},t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=F(this._frameBufferCube)}applyPreset(e,t){const i=e.median,r=e=>{const r=Qi(e[0],e[1],i);return t<.5?Qi(e[0],r,2*t):Qi(r,e[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){if(M(this._vao))return this._dirty=this.running=!1,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Cs.FINISHED_RENDERING,void e.madeProgress();0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),Or(this._passParameters.weatherTile,this._weatherTile));const t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return kn.YIELD;if(!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return kn.YIELD;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Cs.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const i=this.context.renderContext.rctx,r=i.bindTechnique(t,this._passParameters,this._bindParameters);i.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao);const s=i.getViewport(),a=t.configuration.cubeMapSize,n=a/this._tilesPerFace,o=this._tileIndex*n;i.setViewport(0,o,a,n);const l=this._ensureFrameBufferCube(a);i.bindFramebuffer(l);const h=im[this._faceIndex],c=rm[this._faceIndex];Hr(this._viewMatrix,sm,h,c),Ga(this._drawParameters.viewMatrix,this._viewMatrix);const d=da.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return l.setColorTextureTarget(d),r.bindDraw(this._drawParameters,this._bindParameters,this._passParameters),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.gl.flush(),i.setViewport(s.x,s.y,s.width,s.height),this.requestRender(),++this._tileIndex,4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Cs.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),kn.YIELD}};e([ce({constructOnly:!0})],tm.prototype,"context",void 0),e([ce({constructOnly:!0})],tm.prototype,"view",void 0),e([ce({constructOnly:!0})],tm.prototype,"requestRender",void 0),e([ce()],tm.prototype,"coverage",void 0),e([ce()],tm.prototype,"density",void 0),e([ce()],tm.prototype,"absorption",void 0),e([ce()],tm.prototype,"cloudSize",void 0),e([ce()],tm.prototype,"detailSize",void 0),e([ce()],tm.prototype,"smoothness",void 0),e([ce()],tm.prototype,"cloudHeight",void 0),e([ce()],tm.prototype,"raymarchingSteps",void 0),e([ce()],tm.prototype,"running",void 0),tm=e([ue("esri.views.3d.environment.CloudsGenerator")],tm);const im=[Qa(1,0,0),Qa(-1,0,0),Qa(0,1,0),Qa(0,-1,0),Qa(0,0,1)],rm=[Qa(0,1,0),Qa(0,1,0),Qa(0,0,-1),Qa(0,0,1),Qa(0,1,0)],sm=Xa();class am extends Us{constructor(){super(...arguments),this.fogColor=ve(),this.hazeColor=ve(),this.fogStrength=4e-6,this.hazeStrength=4e-6,this.atmosphereC=1,this.fogAmount=0,this.hazeAmount=0}}const nm=is(),om=Object.freeze(Object.defineProperty({__proto__:null,FogHazePassParameters:am,build:function(e){const t=new Vs;t.attributes.add(Gs.POSITION,"vec2"),t.include(as,{textureCoordinateType:ns.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:r}=t;return i.uniforms.add([new js("inverseProjectionMatrix",((e,t)=>t.camera.inverseProjectionMatrix)),new js("inverseViewMatrix",((e,t)=>Gr(nm,t.camera.viewMatrix)))]),i.code.add(Fs`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add(new Ns("atmosphereC",(e=>e.atmosphereC))),r.uniforms.add(new Is("cameraPosition",((e,t)=>t.camera.eye))),r.uniforms.add(new Ms("nearFar",((e,t)=>t.camera.nearFar))),r.uniforms.add(new qs("depthTex",(e=>e.depthTexture))),r.uniforms.add(new Ns("fogStrength",(t=>e.haze?t.hazeStrength:t.fogStrength))),r.uniforms.add(new Ns("fogAmount",(t=>e.haze?t.hazeAmount:t.fogAmount))),r.uniforms.add(new Is("fogColor",(t=>e.haze?t.hazeColor:t.fogColor))),t.include(xs),r.include(bs),r.code.add(Fs`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(Fs`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),r.code.add(Fs`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${e.haze?Fs`
          if(terrainDepth == -1.0){
            fragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class lm extends Hs{initializeProgram(e){return new Bs(e.rctx,lm.shader.get().build(this.configuration),$s)}initializePipeline(){return this.configuration.haze?Ta({blending:wa(na.ONE,na.ZERO,na.ONE_MINUS_SRC_COLOR,na.ONE),colorWrite:Ca}):Ta({blending:wa(na.SRC_ALPHA,na.ZERO,na.ONE_MINUS_SRC_ALPHA,na.ONE),colorWrite:Ca})}}lm.shader=new Ws(om,(()=>Promise.resolve().then((()=>om))));class hm extends Aa{constructor(){super(...arguments),this.haze=!1}}e([Ea()],hm.prototype,"haze",void 0);let cm=class extends Hi{constructor(e){super(e),this._passParameters=new am;const t=e.context.renderContext.rctx;this._vao=Ma(t,Da),this._technique=e.context.techniqueRepository.acquire(lm,new hm);const i=br(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+Wt}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const i=this._technique;if(!i.compiled)return void this.context.requestRender();const r=e.offscreenRenderingHelper;r.renderDepthDetached((()=>{this._passParameters.depthTexture=r.depthTexture;const t=e.rctx.bindTechnique(i,this._passParameters,e.bindParameters);this._renderFog(t,e)}))}_renderFog(e,t){const i=t.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(la.TRIANGLE_STRIP,0,4)}_update(e,t){const i=e.bindParameters.camera;be(um,i.eye);const r=Math.max(0,xe(um,e.bindParameters.lighting.mainLight.direction)),s=t.color;Te(pm,s,.1),we(this._passParameters.fogColor,pm,s,r);const a=Ce(i.eye),n=a*a;this._passParameters.atmosphereC=n-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-Xi(.95*Bn,1*Bn,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}static isSupported(e){return e.capabilities.depthTexture}};e([ce({constructOnly:!0})],cm.prototype,"context",void 0),e([ce({constructOnly:!0})],cm.prototype,"view",void 0),cm=e([ue("esri.views.3d.environment.Fog")],cm);class dm{constructor(){this.color=ve(),this.strength=0,this.amount=0}}const um=ve(),pm=ve();var mm;!function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"}(mm||(mm={}));class _m extends Wn{constructor(){super(...arguments),this.geometry=mm.Cone}}e([Ea({count:mm.COUNT})],_m.prototype,"geometry",void 0);class gm extends Us{constructor(){super(...arguments),this.texV=kr(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new fm}}class fm{constructor(){this.center=ve(),this.v1=ve(),this.v2=ve()}}const ym=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:fm,SimpleAtmospherePassParameters:gm,build:function(e){const t=new Vs,{vertex:i,fragment:r}=t;if(os(i),e.geometry===mm.Underground)t.attributes.add(Gs.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add([new Is("cameraPosition",((e,t)=>t.camera.eye)),new Ns("undergroundFadeAlpha",(e=>e.undergroundFadeAlpha))]),i.code.add(Fs`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.code.add(Fs`void main() {
fragColor = color;
}`);else{t.include($n,e),t.attributes.add(Gs.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=e.geometry===mm.Cylinder;i.uniforms.add([new js("proj",((e,t)=>t.camera.projectionMatrix)),new js("view",((e,t)=>t.camera.viewMatrix))]),s||(t.varyings.add("innerFactor","float"),i.uniforms.add(new Is("silCircleCenter",(e=>e.silhouette.center))),i.uniforms.add(new Is("silCircleV1",(e=>e.silhouette.v1))),i.uniforms.add(new Is("silCircleV2",(e=>e.silhouette.v2))),i.uniforms.add(new Ms("texV",(e=>e.texV))),i.uniforms.add(new Ns("innerScale",(e=>e.innerScale))));const a=6.2831853,n=1/128;i.code.add(Fs`
		void main(void) {
      ${s?Fs`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:Fs`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${Fs.float(a*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${Fs.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.uniforms.add(new qs("tex",(e=>e.texture))),s||r.uniforms.add(new Ns("altitudeFade",(e=>e.altitudeFade))),r.code.add(Fs`
		void main() {
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?Fs`fragColor = atmosphereColor;`:Fs`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}},Symbol.toStringTag,{value:"Module"}));class vm extends Hs{initializeProgram(e){return new Bs(e.rctx,vm.shader.get().build(this.configuration),$s)}initializePipeline(){return this.configuration.geometry===mm.Cylinder?Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),culling:Pa,depthTest:{func:oa.LEQUAL},colorWrite:Ca}):Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),depthTest:{func:oa.LEQUAL},colorWrite:Ca})}}vm.shader=new Ws(ym,(()=>Promise.resolve().then((()=>ym))));const bm=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);class xm{constructor(e,t){this.type=vp.Panoramic,this._configuration=new _m,this._passParameters=new gm,this._configuration.geometry=mm.Cylinder,this._technique=t.techniqueRepository.acquire(vm,this._configuration);const i=t.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=cn(this._vao,"geometry"),this._passParameters.texture=new Zn(i,{pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:_a.LINEAR,flipped:!0,width:1,height:512},bm)}destroy(){this._passParameters.texture=F(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const t=e.rctx,i=t.bindTechnique(this._technique,this._passParameters,e.bindParameters);var r,s;r=Tm,s=e.bindParameters.camera.viewMatrix,Br(r,s),r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.setUniformMatrix4fv("view",Tm),t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(la.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const t=Yn(1,2,!1),i=t.indices[0][1],r=t.vertexAttributes[0][1];for(let e=0;e<i.length;e+=3){const t=i[e];i[e]=i[e+2],i[e+2]=t}const s=r.data,a=wm.createBuffer(i.length),n=a.position;for(let e=0;e<i.length;++e){const t=3*i[e];n.set(e,0,s[t]),n.set(e,1,s[t+1]),n.set(e,2,s[t+2])}return new Ia(e,$s,{geometry:Qn(wm)},{geometry:dn.createVertex(e,ga.STATIC_DRAW,a.buffer)})}}const Tm=is(),wm=Xn().vec3f(Gs.POSITION);var Cm;!function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"}(Cm||(Cm={}));class Sm extends Aa{constructor(){super(...arguments),this.type=Cm.Rain}}e([Ea({count:Cm.COUNT})],Sm.prototype,"type",void 0);const Pm=ve(),Rm=ve(),Om=fe(1,1,1),Em=fe(.85,.85,.85),Am=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new Vs;return t.attributes.add(Gs.POSITION,"vec3"),t.attributes.add(Gs.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new Is("cameraPosition",((e,t)=>t.camera.eye))),t.vertex.uniforms.add(new Is("offset",((e,t)=>function(e,t){const i=t.camera.eye,r=.5*e.width,s=1/e.width,a=Se(Pm,Pe(Pm,(i[0]+r)*s,(i[1]+r)*s,(i[2]+r)*s));return Re(a,i,Te(a,a,e.width))}(e,t)))),t.vertex.uniforms.add(new Ns("width",(e=>e.width))),t.vertex.uniforms.add(new js("proj",((e,t)=>t.camera.projectionMatrix))),t.vertex.uniforms.add(new js("view",((e,t)=>t.camera.viewMatrix))),t.vertex.uniforms.add(new Ns("time",(e=>e.time))),t.varyings.add("vUv","vec2"),t.vertex.code.add(Fs`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===Cm.Rain?Fs`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:Fs`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),t.fragment.uniforms.add([new Ns("opacity",(e=>e.opacity)),new Is("particleColor",((t,i)=>function(e,t){const i=t.type===Cm.Rain?Em:Om,r=Te(Pm,i,.7),s=e.camera.eye;be(Rm,s);const a=Math.max(0,xe(Rm,e.lighting.mainLight.direction));return we(r,r,i,a)}(i,e)))]),t.fragment.code.add(Fs`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${e.type===Cm.Rain?Fs`d = 0.35 * smoothstep(0.5, 0.0, d);`:Fs`d = smoothstep(0.5, 0.1, d);`}
      fragColor = opacity * vec4(particleColor * d, d);
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class Mm extends Us{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}}class Dm extends Hs{initializeProgram(e){return new Bs(e.rctx,Dm.shader.get().build(this.configuration),Im)}initializePipeline(){return Ta({blending:wa(na.ONE,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),depthTest:{func:oa.LEQUAL},colorWrite:Ca})}}Dm.shader=new Ws(Am,(()=>Promise.resolve().then((()=>Am))));const Im=new Map([[Gs.POSITION,0],[Gs.INSTANCEFEATUREATTRIBUTE,1]]);let Lm=class extends Hi{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new Mm,this._animation=new Qs,this._updatingTracking=new Kn,this._passParameters.time=0,this._passParameters.radius=br(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=N(this._snowTechniqueCached),this._rainTechniqueCached=N(this._rainTechniqueCached),this._vao=F(this._vao),this._instanceIdBuffer=F(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(M(this._rainTechniqueCached)){const e=new Sm;e.type=Cm.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(Dm,e)}return this._rainTechniqueCached}get _snowTechnique(){if(M(this._snowTechniqueCached)){const e=new Sm;e.type=Cm.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(Dm,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,i){const r="rainy"===i?this._rainTechnique:this._snowTechnique;if(!r.compiled)return void this.context.requestRender();const s=e.rctx;if(this._ensureResources(s),M(r)||M(this._vao)||M(this._instanceIdBuffer))return;if(A(e.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),this._passParameters.opacity<=0)return;t=t<.5?Qi(0,.35,2*t):Qi(.35,1,2*(t-.5)),this._passParameters.time=("rainy"===i?this._rainSpeed:this._snowSpeed)*Z(this._animation.time)%1e5;const a=s.bindTechnique(r,this._passParameters,e.bindParameters);s.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),un(s,Im,this._instanceIdBuffer,Fm,0),s.capabilities.instancing?.drawArraysInstanced(la.TRIANGLES,0,3,this._numParticles*t),pn(s,Im,this._instanceIdBuffer,Fm)}_ensureResources(e){M(this._vao)&&(this._vao=this._createVertexArrayObject(e)),M(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let e=0;e<this._numParticles;e++)t.push(e);return dn.createVertex(e,ga.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Ia(e,Im,{geometry:Qn(Nm)},{geometry:dn.createVertex(e,ga.STATIC_DRAW,t)})}};e([ce({constructOnly:!0})],Lm.prototype,"context",void 0),e([ce({constructOnly:!0})],Lm.prototype,"view",void 0),e([ce({readOnly:!0})],Lm.prototype,"updating",null),e([ce()],Lm.prototype,"_updatingTracking",void 0),Lm=e([ue("esri.views.3d.environment.Precipitation")],Lm);const Nm=Xn().vec3f(Gs.POSITION),Fm=Qn(Xn().f32(Gs.INSTANCEFEATUREATTRIBUTE),1),Um=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),jm=-$t,Vm=rr([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class km{constructor(e,t){this.view=e,this.type=vp.Simple,this._passParameters=new gm,this._vaoCount=0,this._texV1=1,this._isMars=xr(e.spatialReference);const i=br(e.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+jm)/this._planetRadius,this._middleRimFactor=(this._planetRadius+0)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=0/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=t.techniqueRepository;const r=t.renderContext.rctx;this._cameraChangeHandle=G((()=>this.view.state?.camera),(()=>t.requestRender()),B),this._vao=this._createRibbon(r),this._vaoCount=cn(this._vao,"geometry"),this._fadeVao=Ma(r),this._fadeVaoCount=cn(this._fadeVao,"geometry");const s=this._isMars?Um:bm;this._passParameters.texture=new Zn(r,{pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:_a.LINEAR,flipped:!0,width:1,height:512},s);const a=new _m;a.geometry=mm.Cone,this._coneTechnique=this._techniqueRepository.acquire(vm,a),a.geometry=mm.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(vm,a)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=F(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const t=e.bindParameters.camera;this._update(t);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._vao),i.drawArrays(la.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._fadeVao),i.drawArrays(la.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const t=ve(),i=this._planetRadius,r=Ce(e.eye),s=r-i;if(s<0){const e=Math.min(-s/5e3,1);this._passParameters.undergroundFadeAlpha=e}else this._passParameters.undergroundFadeAlpha=0;const a=Math.max(50,s),n=i+jm;var o,l,h;this._passParameters.innerScale=(l=i,h=n,(o=i+a)*o/(Math.sqrt(o*o-l*l)*Math.sqrt(o*o-h*h)+l*h)-1),this._passParameters.altitudeFade=Qt(s),Te(t,e.eye,(i+50)/r),zm(t,e.center,e.up,i,this._passParameters.silhouette);const c=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),d=1-511/512,u=Vm(s);let p=this._texV0+d*this._texVScale,m=this._texV0+c*u*this._texVScale;if(s>50){zm(e.eye,e.center,e.up,i,this._passParameters.silhouette);const t=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),r=Bi((t-1.5)/(c-1.5),0,1);p=this._texV0+r*d*this._texVScale,m=this._texV0+Qi(this._texV1,c*u,r)*this._texVScale}Rr(this._passParameters.texV,p,m)}_createRibbon(e){const t=Jn(1155),i=new Uint32Array(1920);t[0]=0,t[1]=0,t[2]=-1;for(let e=0;e<128;e++){const r=9*e+3;t[r]=e,t[r+1]=this._innerRimFactor,t[r+2]=-1,t[r+3]=e,t[r+4]=this._middleRimFactor,t[r+5]=0,t[r+6]=e,t[r+7]=this._outerRimFactor,t[r+8]=1;const s=3*e+1,a=127===e?1:s+3,n=15*e;i[n]=s,i[n+1]=s+1,i[n+2]=a+1,i[n+3]=a+1,i[n+4]=a,i[n+5]=s,i[n+6]=s+1,i[n+7]=s+2,i[n+8]=a+2,i[n+9]=a+2,i[n+10]=a+1,i[n+11]=s+1,i[n+12]=s,i[n+13]=a,i[n+14]=0}const r=Bm.createBuffer(i.length),s=r.position;for(let e=0;e<i.length;++e){const r=3*i[e];s.set(e,0,t[r]),s.set(e,1,t[r+1]),s.set(e,2,t[r+2])}return new Ia(e,$s,{geometry:Qn(Bm)},{geometry:dn.createVertex(e,ga.STATIC_DRAW,r.buffer)})}_computeScreenRimWidth(e,t,i,r){return Oe(Gm,r.center,r.v2),Te(Hm,Gm,this._outerRimFactor),Wr(qm,t,Gm,i),ao(Gm,qm,e.projectionMatrix,e.viewport,Gm),ao(Hm,qm,e.projectionMatrix,e.viewport,Hm),Ee(Gm,Hm)/e.height}}function zm(e,t,i,r,s){const a=Ce(e),n=r*Math.sqrt(a*a-r*r)/a,o=Math.sqrt(r*r-n*n),l=s.v1,h=s.v2;return Te(s.center,e,o/a),Ae(l,e,t),ye(l)<1&&Ae(l,e,i),Te(l,l,n/Ce(l)),Ae(h,l,e),Te(h,h,n/Ce(h)),n}const qm=is(),Gm=ve(),Hm=ve(),Bm=Xn().vec3f(Gs.POSITION);class Wm extends Hs{initializeProgram(e){return new Bs(e.rctx,Wm.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:wa(na.ONE,na.ZERO,na.ONE_MINUS_SRC_COLOR,na.ONE),colorWrite:Ca})}}Wm.shader=new Ws(om,(()=>Promise.resolve().then((()=>om))));let $m=class extends Hi{constructor(e){super(e),this._passParameters=new am;const t=e.context.renderContext.rctx;this._vao=Ma(t,Da);const i=br(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+Wt;const r=new hm;r.haze=!0,this._hazeTechnique=e.context.techniqueRepository.acquire(Wm,r)}destroy(){this._hazeTechnique.release(),this._vao.dispose()}set strength(e){this._passParameters.hazeStrength=e}get strength(){return this._passParameters.hazeStrength}render(e,t){if(0===this.view.basemapTerrain.baseOpacity)return;if(this._update(e,t),this._passParameters.hazeAmount<=0)return;const i=this._hazeTechnique;if(!i.compiled)return void this.context.requestRender();const r=e.offscreenRenderingHelper;r.renderDepthDetached((()=>{this._passParameters.depthTexture=r.depthTexture;const t=e.rctx.bindTechnique(i,this._passParameters,e.bindParameters);this._renderSimpleHaze(t,e)}))}_renderSimpleHaze(e,t){const i=t.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(la.TRIANGLE_STRIP,0,4)}_update(e,t){const i=e.bindParameters.camera;be(Ym,i.eye);const r=Math.max(0,xe(Ym,e.bindParameters.lighting.mainLight.direction)),s=Xm;Te(Zm,s,0),we(this._passParameters.hazeColor,Zm,s,r);const a=Ce(i.eye),n=a*a;this._passParameters.atmosphereC=n-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.hazeAmount=(1-Xi(.7*Bn,1*Bn,Math.abs(a-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}static isSupported(e){return e.capabilities.depthTexture}};e([ce({constructOnly:!0})],$m.prototype,"context",void 0),e([ce({constructOnly:!0})],$m.prototype,"view",void 0),$m=e([ue("esri.views.3d.environment.SimpleHaze")],$m);class Qm{constructor(){this.strength=0,this.amount=0}}const Xm=fe(.24,.44,.8),Ym=ve(),Zm=ve(),Km=is(),Jm=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new Vs;return e.attributes.add(Gs.POSITION,"vec3"),e.attributes.add(Gs.COLOR,"vec4"),e.attributes.add(Gs.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add([new js("transform",((e,t)=>function(e,t){const i=24e-8;return Br(Km,t.camera.projectionMatrix),Km[10]=i-1,Km[11]=-1,Km[14]=(i-2)*t.camera.near,$r(Km,Km,t.camera.viewMatrix),$r(Km,Km,e.modelMatrix)}(e,t))),new Ls("viewport",((e,t)=>t.camera.fullViewport)),new Ns("pixelRatio",((e,t)=>t.camera.pixelRatio))]),e.include(ho),e.vertex.code.add(Fs`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(Fs`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);
}`),e}},Symbol.toStringTag,{value:"Module"}));class e_ extends Us{constructor(){super(...arguments),this.modelMatrix=is()}}class t_ extends Hs{constructor(e){super(e,new Aa,(()=>this.destroy()))}initializeProgram(e){return new Bs(e.rctx,t_.shader.get().build(),$s)}initializePipeline(){return Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),depthTest:{func:oa.LEQUAL},colorWrite:Ca})}}t_.shader=new Ws(Jm,(()=>Promise.resolve().then((()=>Jm))));let i_=class extends Hi{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return A(this._loadDataTask)&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter=new e_,this._updatingTracking=new Kn}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=L(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=N(this._technique),this._vao=F(this._vao)}render(e){const{rctx:t}=e;if(this._ensureResources(t),M(this._technique)||M(this._vao))return;if(!this._technique.compiled)return void this.requestRender();const i=t.bindTechnique(this._technique,this._renderParameter,e.bindParameters);t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(la.POINTS,0,this._numPoints)}_ensureResources(e){if(A(this._technique)||M(l_))return;this._technique=new t_({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=l_.byteLength/n_;const t=new Float32Array(l_,0,2*this._numPoints),i=new Uint8Array(l_,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add((()=>"virtual"!==this.view.environment.lighting.type?this.view.environment.lighting.date:null),(e=>this._update(e)),H)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=Br(this._renderParameter.modelMatrix,a_);Qr(r,r,-i*Math.PI),$r(r,s_,r),Qr(r,r,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=o_.createBuffer(r),a=s.position,n=s.color,o=s.size;for(let e=0;e<r;e++){const r=t[2*e],s=t[2*e+1];a.set(e,0,-Math.cos(r)*Math.sin(s)),a.set(e,1,-Math.sin(r)*Math.sin(s)),a.set(e,2,-Math.cos(s));const l=this._unpackUint8Attributes(i[e]),h=this._hexToRGB(r_[l[1]]);n.set(e,0,255*h[0]),n.set(e,1,255*h[1]),n.set(e,2,255*h[2]),n.set(e,3,255),o.set(e,l[0])}return new Ia(e,$s,{geometry:Qn(o_)},{geometry:dn.createVertex(e,ga.STATIC_DRAW,s.buffer)})}_createLoadDataTask(){if(A(l_))return null;const e=ki((async e=>{const{data:t}=await oo("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:e});this._verifyStarData(t),l_=t}));return e.promise.catch((e=>{d(e)||E.getLogger(this.declaredClass).error(e)})).then((()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))})),e}_verifyStarData(e){if(!e)throw new o("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/n_;if(t%1!=0||t>5e4||t<5e3)throw new o("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};e([ce({constructOnly:!0})],i_.prototype,"view",void 0),e([ce({constructOnly:!0})],i_.prototype,"requestRender",void 0),e([ce({readOnly:!0})],i_.prototype,"updating",null),e([ce()],i_.prototype,"_loadDataTask",void 0),e([ce()],i_.prototype,"_updatingTracking",void 0),i_=e([ue("esri.views.3d.environment.Stars")],i_);const r_=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],s_=rs(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),a_=rs(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),n_=9,o_=Xn().vec3f(Gs.POSITION).vec4u8(Gs.COLOR).f32(Gs.SIZE);let l_=null;function h_(e,t,i,r){const s=e.fadeInOutHeight,a=s.stage===Os.FINISHED?i:e.startTimeHeightFade;if(0!==r){const e=(i-a)/(m_*r);s.factor+=t?-e:e}else s.factor=t?0:1;e.startTimeHeightFade=i,s.factor=Bi(s.factor,0,1),s.stage=Os.HEIGHT_FADE}const c_=fe(0,0,1),d_=uo(),u_=ve(),p_=ve(),m_=1;var __,g_;!function(e){e[e.Immediate=0]="Immediate",e[e.Faded=1]="Faded"}(__||(__={}));const f_=[go.POSTPROCESSING_ENVIRONMENT_OPAQUE,go.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let y_=g_=class extends Hi{constructor(e){super(e),this._context=null,this._atmosphere=null,this._hqAtmosphere=null,this._oldWeatherParameters=new v_,this._newWeatherParameters=new v_,this._fadedWeatherParameters=new v_,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(f_,this)}destroy(){this.removeHandles(),null!=this.view?._stage&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return A(this._hqAtmosphere)&&this.view._stage.renderer.isFeatureEnabled(Xt.RealisticAtmosphere)?this._hqAtmosphere:this._atmosphere}get _atmosphereType(){return A(this.atmosphere)?this.atmosphere.type:vp.None}get canRender(){return!!this.view.basemapTerrain?.renderer.canRender||"global"!==this.view.viewingMode}get needsLinearDepth(){return this._atmosphereType===vp.Realistic}updateAnimation(e){return!!A(this._precipitation)&&this._precipitation.update(e)}get updating(){return A(this._stars)&&this._stars.updating||A(this._clouds)&&this._clouds.running}get weatherVisible(){return Ce(this.view.state.camera.eye)-br(this.view.spatialReference).radius<=Bn}get _stars(){const e=this.view,t=e.environment?.starsEnabled??!1,i=this._get("_stars");return!t||M(this._context)?(I(i),null):A(i)?i:new i_({view:e,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||M(this._context))return I(e),null;const t=this.view,i=this._context;return A(e)&&e.context===i?e:(I(e),new Lm({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||M(this._context))return I(e),null;if(A(e))return e;const t=this.view,i=this._context;return I(e),new tm({context:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||M(this._context))return I(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,r=br(this.view.spatialReference).radius;return A(e)&&e.viewingMode===t&&e.planetRadius===r?e:(I(e),new Dp({rctx:i,viewingMode:t,planetRadius:r,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||M(this._context))return I(e),null;if(A(e))return e;const t=this.view,i=this._context;return new cm({context:i,view:t})}get _simpleHaze(){const e=this._get("_simpleHaze");if(!this.weatherEnabled||M(this._context))return I(e),null;if(A(e))return e;const t=this.view,i=this._context;return new $m({context:i,view:t})}get weatherEnabled(){return!!this.view?.environmentManager?.weatherEnabled}get _precipitationEnabled(){return this.weatherEnabled&&("rainy"===this.view.environment.weather.type||"snowy"===this.view.environment.weather.type)}initializeRenderContext(e=null){this._context=e;const t=()=>this._setNeedsRender();this.addHandles([W((()=>this.view?.basemapTerrain),(()=>this._updateBasemapTerrain()),B),G((()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality})),(e=>this._updateAtmosphere(e)),B),G((()=>this._stars),t),G((()=>this._precipitation),t),G((()=>this._clouds),(()=>this._updateWeather()),H),G((()=>this._fog),(()=>this._updateFogHaze()),H),G((()=>this._simpleHaze),(()=>this._updateFogHaze()),H),G((()=>this.view.state.mode),(()=>{this._setNeedsRender()}),$),G((()=>this._atmosphereType),(()=>this._updateBasemapTerrain()),B),G((()=>this._weatherUpdateParameters),(()=>{this._updateWeather(),this._updateFogHaze()}),B)])}uninitializeRenderContext(){this._context=null,this._atmosphere=I(this._atmosphere),this._hqAtmosphere=I(this._hqAtmosphere),this._set("_stars",I(this._stars)),this._set("_precipitation",I(this._precipitation)),this._set("_clouds",I(this._clouds)),this._set("_cloudsComposition",I(this._cloudsComposition)),this._set("_fog",I(this._fog)),this._set("_simpleHaze",I(this._simpleHaze))}prepareRender(e){e.bindParameters.cloudsFade.data=Es(this._clouds)?this._clouds:null,"local"!==this.view.viewingMode&&(function(e,t,i,r,s){e.renderingStage===Cs.FINISHED_RENDERING&&(e.renderingStage=Cs.FADING_TEXTURE_CHANNELS);const a=Ce(t.eye);e.fadeInOutHeight.factor<0&&(e.fadeInOutHeight.factor=a-er.radius>Bn?1:0),e.isCameraPositionFinal=Me(e.cameraPositionLastFrame,t.eye),be(u_,t.eye),Te(u_,u_,er.radius);const n=e.parallax;0===n.anchorPointClouds[0]&&0===n.anchorPointClouds[1]&&0===n.anchorPointClouds[2]&&De(n.anchorPointClouds,u_);const o=Ce(Ie(p_,n.anchorPointClouds,u_));let l=!0;o>e.fadeIn.distanceThresholdFactor*n.cloudsHeight||e.fadeIn.stage!==Ss.FINISHED?function(e,t,i){const r=e.parallax.anchorPointClouds;e.fadeIn.stage===Ss.FINISHED&&(e.fadeIn.factor=0,De(r,u_),e.fadeIn.stage=Ss.CHANGE_ANCHOR,e.crossFade.enabled=!1,e.fadeInOut.stage=Ps.FINISHED),e.fadeIn.stage===Ss.CHANGE_ANCHOR&&e.isCameraPositionFinal&&(Rs(e.data)&&e.renderingStage!==Cs.RENDERING||e.renderingStage===Cs.FADING_TEXTURE_CHANNELS)&&(De(r,u_),e.fadeIn.stage=Ss.FADE_IN,e.startTime=t,e.renderingStage===Cs.FADING_TEXTURE_CHANNELS&&(e.renderingStage=Cs.SWITCH_CHANNELS)),e.fadeIn.factor<1&&e.fadeIn.stage===Ss.FADE_IN?e.fadeIn.factor=i?Bi((t-e.startTime)/(1*i),0,1):1:e.fadeIn.factor>=1&&e.fadeIn.stage===Ss.FADE_IN&&(e.fadeIn.stage=Ss.FINISHED,e.fadeIn.factor=1)}(e,r,s):o>e.fadeInOut.distanceThresholdFactor*n.cloudsHeight||e.fadeInOut.stage!==Ps.FINISHED?function(e,t,i){const{fadeInOut:r,crossFade:s}=e;r.stage===Ps.FINISHED&&(e.startTime=t,r.factor=1,r.stage=Ps.FADE_OUT),r.factor>0&&r.stage===Ps.FADE_OUT?r.factor=i?1-Bi((t-e.startTime)/(.5*i),0,1):0:(r.factor<=0&&r.stage===Ps.FADE_OUT&&(r.factor=0,De(e.parallax.anchorPointClouds,u_)),r.factor<=0&&r.stage===Ps.FADE_OUT&&e.isCameraPositionFinal&&(r.factor=0,r.stage=Ps.SWITCH,e.crossFade.enabled=!1,s.factor=1),r.stage===Ps.SWITCH&&(Rs(e.data)&&e.renderingStage!==Cs.RENDERING||e.renderingStage===Cs.FADING_TEXTURE_CHANNELS)&&(e.startTime=t,r.factor=0,r.stage=Ps.FADE_IN,De(e.parallax.anchorPointClouds,u_),e.crossFade.enabled=!1,s.factor=1,e.renderingStage===Cs.FADING_TEXTURE_CHANNELS&&(e.renderingStage=Cs.SWITCH_CHANNELS)),r.factor<1&&r.stage===Ps.FADE_IN?r.factor=i?Bi((t-e.startTime)/(1*i),0,1):1:r.factor>=1&&r.stage===Ps.FADE_IN&&(r.stage=Ps.FINISHED,r.factor=1))}(e,r,s):o>e.crossFade.distanceThresholdFactor*n.cloudsHeight||e.crossFade.enabled||e.renderingStage===Cs.FADING_TEXTURE_CHANNELS?function(e,t,i,r){const{crossFade:s}=e,a=e.parallax.anchorPointClouds;e.crossFade.enabled&&!r||(De(e.parallaxNew.anchorPointClouds,u_),e.startTime=t,s.factor=0,e.crossFade.enabled=!0),s.factor<1&&e.crossFade.enabled?s.factor=i?Bi((t-e.startTime)/(1.3*i),0,1):1:s.factor>=1&&e.crossFade.enabled&&(e.crossFade.enabled=!1,s.factor=1,De(a,e.parallaxNew.anchorPointClouds),e.renderingStage===Cs.FADING_TEXTURE_CHANNELS&&(e.renderingStage=Cs.SWITCH_CHANNELS))}(e,r,s,(i!==zn.IDLE||!Rs(e.data))&&e.renderingStage!==Cs.FADING_TEXTURE_CHANNELS):l=!1;const h=a-er.radius;if((h>1.7*Bn||h<-Bn)&&e.fadeInOutHeight.factor<1?e.fadeInOutHeight.factor=1:(h>Bn||h<-.35*Bn)&&e.fadeInOutHeight.factor<1?h_(e,!1,r,s):h<Bn&&h>-.35*Bn&&e.fadeInOutHeight.factor>0?h_(e,!0,r,s):e.fadeInOutHeight.stage=Os.FINISHED,e.renderingStage===Cs.SWITCH_CHANNELS&&(e.readChannels=1-e.readChannels,e.renderingStage=Cs.FINISHED),n.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(a*a-er.radius*er.radius,0))/a,po(c_,n.anchorPointClouds,d_),Xr(n.transform,ss,d_[3],mo(d_)),l){const{parallaxNew:t}=e;po(c_,t.anchorPointClouds,d_),Xr(t.transform,ss,d_[3],mo(d_))}De(e.cameraPositionLastFrame,t.eye)}(e.bindParameters.cloudsFade,e.bindParameters.camera,this.view.state.mode,e.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(e.bindParameters),e.bindParameters.cloudsFade.renderingStage===Cs.FINISHED&&A(this._clouds)&&0===this._clouds.coverage&&!1===this._clouds.running&&(this._clouds.destroyFrameBufferCube(),e.bindParameters.cloudsFade.data=null))}render(e){var t;if(e.output===_o.Color)switch(e.bindParameters.slot){case go.POSTPROCESSING_ENVIRONMENT_OPAQUE:A(this._stars)&&this._stars.render(e),A(this.atmosphere)&&(this.atmosphere.render(e),A(this._cloudsComposition)&&A(e.bindParameters.cloudsFade.data)&&(this.weatherVisible&&A(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(e)),((t=e.bindParameters.cloudsFade).crossFade.enabled||t.fadeInOut.stage!==Ps.FINISHED||t.fadeIn.stage!==Ss.FINISHED||t.fadeInOutHeight.stage!==Os.FINISHED||t.renderingStage!==Cs.FINISHED)&&A(this._context)&&this._context.requestRender());break;case go.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(A(this.atmosphere)&&(this.atmosphere.renderHaze(e,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._atmosphereType!==vp.Realistic&&A(this._simpleHaze)&&this._simpleHaze.render(e,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&A(this._fog)&&this._fog.render(e,this._weatherParameters.fog),A(this._precipitation))){const t=this.view.environment.weather;"rainy"!==t.type&&"snowy"!==t.type||this._precipitation.render(e,t.precipitation,t.type)}}}updateLightSources(e,t,i,r){if(A(this._context)){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=t,s.bindParameters.newLighting.globalFactor=i,s.bindParameters.newLighting.set(e),r===__.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return M(e)?null:"rainy"===e.type||"snowy"===e.type?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}_updateWeatherFading(e){if(!e.weatherFading)return;const t=e.cloudsFade;return t.fadeIn.stage===Ss.FADE_IN?(e.fadeLighting(t.fadeIn.factor),void this._fadeWeather(t.fadeIn.factor)):t.fadeInOut.stage===Ps.FADE_IN?(e.fadeLighting(t.fadeInOut.factor),void this._fadeWeather(t.fadeInOut.factor)):t.crossFade.enabled?(e.fadeLighting(t.crossFade.factor),void this._fadeWeather(t.crossFade.factor)):(e.fadeLighting(0),void this._fadeWeather(0))}_fadeWeather(e){const{_newWeatherParameters:t,_oldWeatherParameters:i}=this;e>=1?this._weatherParameters=t:(this._fadedWeatherParameters.lerp(i,t,e),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const e=this._weatherUpdateParameters;M(e)||M(this._clouds)||(this._clouds.applyPreset(jp[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){A(this._context)&&this._context.requestRender()}_updateFogHaze(){const e=this._weatherUpdateParameters;if(M(this._fog)||M(this._simpleHaze)||M(e)||M(this._context))return;const t=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),e.type){case"foggy":this._newWeatherParameters.fog.strength=Qi(3e-5,.005,e.weatherAdjustment**3),De(this._newWeatherParameters.fog.color,x_),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===vp.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=Qi(4e-6,2e-4,(e.effect??0)**3),De(this._newWeatherParameters.fog.color,b_),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=Qi(4e-6,2e-4,(e.effect??0)**3),De(this._newWeatherParameters.fog.color,x_),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===vp.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}t.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(e){const t=this._selectAtmosphereType(e);if(A(this._atmosphere)?this._atmosphere.type===t:t===vp.None)return;this._atmosphere=I(this._atmosphere),this._hqAtmosphere=I(this._hqAtmosphere);const i=this._getAtmosphereClass(t);i&&A(this._context)&&(this._atmosphere=new i(this.view,this._context),t===vp.Simple&&(this._hqAtmosphere=new Op(this.view,this._context))),this._setNeedsRender(),this._updateBasemapTerrain()}_getAtmosphereClass(e){switch(e){case vp.Realistic:return Op;case vp.Panoramic:return xm;case vp.Simple:return km;default:case vp.None:return null}}_selectAtmosphereType(e){const{enabled:t,quality:i,viewingMode:r}=e;return!t||Tr(this.view.spatialReference)?vp.None:r===Ui.Local?vp.Panoramic:A(this._context)&&"high"===i&&Op.isSupported(this._context)&&wr(this.view.spatialReference)?vp.Realistic:vp.Simple}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=this._atmosphereType===vp.Simple)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),stubGetAtmosphereClass:e=>{T_=g_.prototype._getAtmosphereClass,g_.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{g_.prototype._getAtmosphereClass=T_}}}};e([ce({constructOnly:!0})],y_.prototype,"view",void 0),e([ce({readOnly:!0})],y_.prototype,"atmosphere",null),e([ce({readOnly:!0})],y_.prototype,"_atmosphereType",null),e([ce({type:Boolean,readOnly:!0})],y_.prototype,"updating",null),e([ce({readOnly:!0})],y_.prototype,"weatherVisible",null),e([ce()],y_.prototype,"_context",void 0),e([ce()],y_.prototype,"_atmosphere",void 0),e([ce()],y_.prototype,"_hqAtmosphere",void 0),e([ce({readOnly:!0})],y_.prototype,"_stars",null),e([ce({readOnly:!0})],y_.prototype,"_precipitation",null),e([ce({readOnly:!0})],y_.prototype,"_clouds",null),e([ce({readOnly:!0})],y_.prototype,"_cloudsComposition",null),e([ce({readOnly:!0})],y_.prototype,"_fog",null),e([ce({readOnly:!0})],y_.prototype,"_simpleHaze",null),e([ce({readOnly:!0})],y_.prototype,"weatherEnabled",null),e([ce({readOnly:!0})],y_.prototype,"_precipitationEnabled",null),e([ce({readOnly:!0})],y_.prototype,"_weatherUpdateParameters",null),y_=g_=e([ue("esri.views.3d.environment.EnvironmentRenderer")],y_);class v_{constructor(){this.fog=new dm,this.haze=new Qm}copyFrom(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,De(this.fog.color,e.fog.color)}lerp(e,t,i){this.fog.amount=Qi(e.fog.amount,t.fog.amount,i),this.haze.amount=Qi(e.haze.amount,t.haze.amount,i),this.fog.strength=Qi(e.fog.strength,t.fog.strength,i),this.haze.strength=Qi(e.haze.strength,t.haze.strength,i),we(this.fog.color,e.fog.color,t.fog.color,i)}}const b_=fe(.5,.5,.5),x_=fe(1.5,1.5,1.5);let T_,w_=class extends mr.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new R,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new Co,this._ambientLight=new So,this._moonLight=new Po,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){return this._renderer?.view}get updating(){return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!this._renderer?.updating)}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===Ui.Global&&wr(this._view.spatialReference)}get weatherVisible(){return this.weatherEnabled&&this._renderer?.weatherVisible}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new y_({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this._viewHandles.add([G((()=>e.environment.lighting),(e=>this._updateLightingHandler(e)),$),G((()=>"virtual"!==e.environment.lighting.type?e.environment.lighting.date:null),(e=>this._lightingDateHandler(e)),$),G((()=>e.stationary),(()=>this._interactingStationaryHandler())),G((()=>e.environment.lighting.directShadowsEnabled),t,$),G((()=>e.environment.lighting.ambientOcclusionEnabled),t,$),G((()=>e.environment.lighting.waterReflectionEnabled),t,$),G((()=>e.environment.background?.color),t,$),G((()=>e.spatialReference),(()=>this._resetReferencePosition(!0)),$),G((()=>e.environment.weather.type),(()=>this._updateLighting(null,__.Faded)),$),G((()=>this.weatherEnabled),(()=>this._updateLighting(null,__.Faded)),$),G((()=>e.viewingMode),(()=>this._resetReferencePosition(!0)),B),G((()=>"virtual"!==e.environment.lighting.type&&e.environment.lighting.cameraTrackingEnabled),(e=>this._updateCameraTracking(e)),B),G((()=>e.state.camera),i,B),G((()=>this.disableQueries),i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=I(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking("virtual"!==e.type&&e.cameraTrackingEnabled),this._lightingDateHandler("virtual"!==e.type?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const e=this._view.environment.lighting;"virtual"!==e?.type&&(e.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if("virtual"!==t?.type){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!Ye(i)){const e=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(e))return void this._requestReferencePositionUpdate(e)}if(this._preupdateTracking(e),A(this._referencePosWGS84Comparable)){const e=fo(this._referencePosWGS84Comparable,R_);A(e)&&(t.autoUpdate(null,e),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&"virtual"!==this._view.environment.lighting.type&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){const i=wr(this._view.spatialReference);if(i&&!Ye(this._view.spatialReference))return"virtual"===this._view.environment.lighting.type&&this._updateLighting(),!1;const r=e.position;return M(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=ve()),i?Ze(r,this._referencePosWGS84Comparable):Pe(this._referencePosWGS84Comparable,r.longitude??0,r.latitude??0,r.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(t.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,t=__.Immediate){const i=this._view;e=e||("virtual"===i.environment.lighting.type?null:i.environment.lighting.date);const r=this._referencePosWGS84Comparable,s=A(r)?C_:S_,a=this.weatherVisible?i.environment.weather.type:"disabled";A(r)?yo(e,r,i.state.viewingMode,a,i.state.camera,s):"virtual"===i.environment.lighting.type&&vo(i.state.camera,i.state.viewingMode,s.direct.directionToLightSource);const n=this._mainLight,o=s.direct;Te(n.intensity,o.color,o.intensity*Math.PI),De(n.direction,o.directionToLightSource),n.specularStrength=s.specularStrength,n.environmentStrength=s.environmentStrength;const l=this._ambientLight;Te(l.intensity,s.ambient.color,s.ambient.intensity);const h=this._moonLight;we(h.intensity,O_,E_,s.globalFactor);const c=(1-.5*s.globalFactor)*(1-.4*s.noonFactor*(1-s.globalFactor));Te(h.intensity,h.intensity,c),De(h.direction,o.directionToLightSource),this._renderer.updateLightSources([n,l,h],s.noonFactor,s.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if("virtual"===this._view.environment.lighting.type||!this._view.environment.lighting.cameraTrackingEnabled||M(e))return!1;const i=P_;i.setTime((t||this._view.environment.lighting.date).getTime());const r=fo(e,R_);if(M(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const a=i.getUTCHours()-(r.hours-s.hours),n=i.getUTCMinutes()-(r.minutes-s.minutes),o=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(a),i.setUTCMinutes(n),i.setUTCSeconds(o),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=U(this._referencePosWGS84Comparable,!0,(e=>xo(e[2],this._view.state.viewingMode))),i=this._view.environment.background,r=i instanceof Oo?{type:"color",color:gr(pr.toUnitRGBA(i.color))}:{type:"color",color:fr(0,0,0,1)};e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,background:r,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const e=this._referencePosUpdateQuery=u(this._referencePointUpdateDelay).then((()=>{if(this._referencePosUpdateQuery===e){const t=()=>this._referencePosUpdateQuery!==e;return this._doReferencePositionUpdateQuery(t)}})).catch((e=>{"mapcoordshelper:missing-geometry-service"===e.name&&(this.disableQueries=!0)})).then((()=>{this._referencePosUpdateQuery===e&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))})),t=this._referencePosUpdateTimer=u(this._referencePointUpdateInterval).then((()=>{this._referencePosUpdateTimer===t&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())}));this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const e=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=e):this._referencePosWGS84Comparable=[t[0],t[1],e],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};e([ce({type:Boolean,readOnly:!0})],w_.prototype,"updating",null),e([ce()],w_.prototype,"disableQueries",void 0),e([ce()],w_.prototype,"_disableWeather",void 0),e([ce()],w_.prototype,"weatherEnabled",null),e([ce()],w_.prototype,"weatherVisible",null),e([ce()],w_.prototype,"referencePositionWGS84Comparable",null),e([ce()],w_.prototype,"_renderer",void 0),e([ce()],w_.prototype,"_referencePosWGS84Comparable",void 0),w_=e([ue("esri.views.3d.environment.SceneViewEnvironmentManager")],w_);const C_=new bo,S_=new bo,P_=new Date,R_={hours:0,minutes:0,seconds:0},O_=fe(.22,.22,.33),E_=fe(.22,.22,.22);function A_(e=I_){return[e[0],e[1],e[2],e[3]]}function M_(e,t){return function(e,t,i,r,s=A_()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}(e[0],e[1],e[2],t,zo.get())}function D_(e,t,i){return Ae(i,e,t),be(i,i),i[3]=Vo(e,t),i}const I_=[0,0,1,0];function L_(e,t,i,r){const s=il(t,i,N_);return Eo(e,s,r)}const N_=qo();var F_;!function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"}(F_||(F_={}));const U_=[1,3e8],j_=1508e5,V_={exclude:new Set([ol])};function k_(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function z_(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function q_(e,t,i){const r=Yr(Go.get(),i[3],i);M(r)||Zr(r,ss)||(Ie(Ag,e.eye,t),Le(Ag,Ag,r),e.eye=Oe(Ag,Ag,t),Ie(Ag,e.center,t),Le(Ag,Ag,r),e.center=Oe(Ag,Ag,t),e.up=Le(Ag,e.up,r))}function G_(e,t,i,r){return $o(e,il(t,i,Ng),r)}function H_(e,t,i,r){const s=Ho.get();let a=1-i;Ie(s,t,e.eye);const n=Ce(s);let o=n*(1-a);a>=0&&o<r&&(o=r,a=-(o-n)/n),Math.abs(n-o)<1e-6||(Te(s,s,a),e.eye=Oe(Ag,e.eye,s),e.center=we(Ag,e.center,t,a))}function B_(e,t,i){t.getScreenCenter(W_),L_(e,t,W_,Ag)&&(t.center=Ag);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const a=Te(Ho.get(),t.viewForward,s);t.eye=Ie(Ag,t.center,a)}const W_=re();function $_(e,t){Pe(t,0,0,0);for(const i of e)Oe(t,t,i);Te(t,t,1/e.length)}function Q_(e,t,i,r){return Math.sin(e/Ce(t))*(i+r.radius)}function X_(e,t,i,r){return Q_(Math.PI/2,t,i,r)+(e-Math.PI/2)}var Y_;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(Y_||(Y_={}));const Z_={Elevation:3e4,Angle:Wi(16)},K_={Pole:.95,Angle:Wi(18),Tilt:45},J_=Wi(80);function eg(e,t,i,r,s,a){const n=ve(),o=Mo();let l=!0,h=!0;return e.intersectScreen(i,n,a)?o[3]=Ce(n):(h=!1,t.aboveGround&&s!==F_.Ellipsoid?o[3]=Math.max(Ce(t.center),.9*r.radius):o[3]=Ce(t.eye)-t.relativeElevation,s===F_.Silhouette?sg(o,t,i,n):l=L_(o,t,i,n)),{sphere:o,scenePickPoint:l?n:null,hasGeometryIntersection:h}}function tg(e,t,i){return Ce(e.eye)-i.radius>Z_.Elevation?Y_.Horizontal:(il(e,t,Fg),-Math.sign(e.relativeElevation)*(.5*Math.PI+Vo(e.eye,Fg.direction))<Z_.Angle?Y_.Vertical:Y_.Horizontal)}function ig(e,t,i){Ie(rg,i,t),e.eye=Ie(Ag,e.eye,rg),e.center=Ie(Ag,e.center,rg)}const rg=ve();function sg(e,t,i,r){const s=il(t,i,Ng);return!(M(s)||(Ao(e,s,ag),Eo(e,s,r)?Ne(ag,s.origin)<Ne(r,s.origin)&&(De(r,ag),1):(Ie(ng,t.eye,t.center),be(ng,ng),Qo(ng,-xe(be(ng,ng),ag),og),$o(og,s,r),1)))}const ag=ve(),ng=ve(),og=Wo();function lg(e,t,i,r,s,a){let n=0;if(Ae(Ig,e,t),Ie(Mg,e,t),Ce(e)<=s||!r.aboveGround){Ae(i,Mg,r.eye);const o=xe(e,t)/(Ce(e)*Ce(t));if(o<.9999)n=Yi(o);else{const i=Ce(Ae(ve(),e,t))/(Ce(e)*Ce(t));n=Zi(i)}const l=Math.cos(Bi(Uo.normalize(Wi(a)),0,J_));n=-n-Math.max(0,Ce(t)-s)/(l*s)}else Ie(hg,r.eye,r.center),Ae(i,Mg,hg),n=-Ce(Mg)/s;return be(i,i),Te(i,i,Ce(Ig)),n}const hg=ve();function cg(e,t,i,r){let s,a;const n=Math.cos(Bi(Uo.normalize(Wi(r)),0,J_));return s=t>i?-(t-i)/(n*i):t<-i?Math.PI-(t+i)/(n*i):Yi(t/i),a=e>i?-(e-i)/(n*i):e<-i?Math.PI-(e+i)/(n*i):Yi(e/i),(a-s)*i}function dg(e,t,i,r,s,a,n,o,l,h){Ae(Ig,e,t),It(a.up,a.eye,vg,bg,xg),It([0,0,1],a.eye,gg,fg,yg),De(i,fg),De(r,gg),be(i,i),Te(i,i,Ce(Ig)),Lt(e,be(bg,bg),be(xg,xg),be(vg,vg),Tg),Lt(t,bg,xg,vg,wg),function(e,t,i,r,s,a,n,o,l,h){const c=cg(e[2],t[2],a[3],o),d=l?cg(e[0],t[0],a[3],180):t[0]-e[0],u=Math.sin(n)*d-Math.cos(n)*c,p=Math.cos(n)*d+Math.sin(n)*c;be(Ag,s);const m=l?u/Math.sqrt(Math.abs(a[3]**2-xe(i,Ag)**2)):u/a[3],_=p/Math.sqrt(Math.abs(a[3]**2-xe(i,r)**2));Rr(h,m,_)}(Tg,wg,e,gg,fg,n,o,l,h,s)}function ug(e,t,i,r,s,a){Yr(Pg,r,i),Yr(Rg,a,s),$r(Og,Pg,Rg),Ie(Ag,e.eye,t),Le(Ag,Ag,Og),e.eye=Oe(Ag,Ag,t),Ie(Ag,e.center,t),Le(Ag,Ag,Og),e.center=Oe(Ag,Ag,t),Ie(Ag,e.up,t),Le(Ag,Ag,Og),e.up=Oe(Ag,Ag,t)}function pg(e,t,i,r,s,a){return(Math.abs(r)>Math.PI-K_.Angle||Math.abs(r)<K_.Angle)&&(Math.abs(e[2])<i*K_.Pole||Math.abs(t)>i)&&a.aboveGround&&s<K_.Tilt}function mg(e,t,i,r,s,a){if(a)D_(i,r,Sg),q_(t,e,Sg);else{const a=lg(i,r,Lg,t,e[3],s);q_(t,e,M_(Lg,a))}}function _g(e,t,i,r,s,a,n){const o=n?20:1;let l,h;De(Eg,r),Dg.copyFrom(t);for(let r=0;r<o&&Ne(i,Eg)>1e-12&&(l=Ne(i,Eg),dg(i,Eg,fg,gg,Cg,Dg,e,s,a,n),ug(Dg,e,gg,Cg[1],fg,Cg[0]),c=Eg,d=Eg,u=e,p=gg,m=Cg[1],_=fg,g=Cg[0],Yr(Pg,m,p),Yr(Rg,g,_),$r(Og,Pg,Rg),Ie(d,c,u),Le(d,d,Og),Oe(d,d,u),h=Ne(i,Eg),h<l||0===r);r++)t.copyFrom(Dg);var c,d,u,p,m,_,g}const gg=ve(),fg=ve(),yg=ve(),vg=ve(),bg=ve(),xg=ve(),Tg=ve(),wg=ve(),Cg=kr(),Sg=A_(),Pg=is(),Rg=is(),Og=is(),Eg=ve(),Ag=ve(),Mg=ve(),Dg=new al,Ig=ve(),Lg=ve(),Ng={origin:ve(),direction:ve()},Fg={origin:ve(),direction:ve()};let Ug=class extends Yt{constructor(){super(...arguments),this._zoomLocation=ve(),this._tmpCamera=new al,this._tmpViewDir=ve(),this._tmpRayDir={origin:ve(),direction:ve()},this._targetOnSphere=ve(),this._tmpCenter=ve(),this._constraintOptions={selection:Zt.ALL_EXCEPT_COLLISION,interactionType:Kt.ZOOM,interactionFactor:null,interactionStartCamera:new al,interactionDirection:null,tiltMode:Jt.TUMBLE},this._sphere=Mo()}initialize(){this._intersector=cl(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this._constraintOptions;r&&(this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r));let s=!1,a=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,0===this.view.map.ground.opacity?V_:{})&&(s=e>0,a=!0),this._tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:De(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,a),this.begin(this._tmpCamera)}animationSettings(){return{duration:K(600),easing:ei}}_updateCamera(e,t,i,r,s){const a=tg(e,r,br(this.view.spatialReference)),n=Math.abs(this.view.camera.position.z);be(Vg,e.eye),Te(Vg,Vg,-1),il(e,r,this._tmpRayDir),be(this._tmpRayDir.direction,this._tmpRayDir.direction);const o=Bi(Math.min(8,1/Math.abs(xe(Vg,this._tmpRayDir.direction)))*n,200,j_);if(a===Y_.Horizontal){let s=.6**t;this._sphere[3]=Ce(i),Ie(this._tmpViewDir,e.center,e.eye);const a=Math.min(Ce(this._tmpViewDir),o);let n=a*s;if(s<=1&&n<4&&(n=4,s=n/a),Math.abs(a-n)<1e-6)return;const m=Ce(e.center);if(this._sphere[3]!==m){const t=this._sphere[3]+s*(m-this._sphere[3]);e.center=Te(jg,e.center,t/m)}Te(this._tmpViewDir,this._tmpViewDir,-s),e.eye=Oe(jg,e.center,this._tmpViewDir),ti(this.view,e,this._constraintOptions),Ne(i,e.center)>1e-12&&L_(this._sphere,e,r,this._targetOnSphere)&&(l=this._sphere,h=e,c=i,d=this._targetOnSphere,u=this.view.camera.heading,p=this.view.camera.tilt,pg(c,xe(h.up,c),l[3],-Uo.normalize(Wi(u)),p,h)?_g(l,h,c,d,-Uo.normalize(Wi(u)),p,!0):mg(l,h,c,d,p,!0))}else{let a=.6**Math.abs(t);const n=t>0?1:-1;Ie(this._tmpViewDir,i,e.eye);const l=Ce(this._tmpViewDir),h=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,60);let c=A(h)?h:o;c=s&&t>0?Math.min(c,l):c,Te(this._tmpRayDir.direction,this._tmpRayDir.direction,c),Oe(i,this._tmpRayDir.origin,this._tmpRayDir.direction);let d=c*a;const u=Math.max(4,1.01*e.nearFar[0]);if(t>0&&d<u&&(d=u,a=d/c),Math.abs(c-d)<1e-6)return;Te(this._tmpRayDir.direction,this._tmpRayDir.direction,n*(1-a)),e.eye=Oe(jg,e.eye,this._tmpRayDir.direction),e.center=Oe(jg,e.center,this._tmpRayDir.direction)}var l,h,c,d,u,p;ii(this.view,e)}};Ug=e([ue("esri.views.3d.state.controllers.global.ZoomStepController")],Ug);const jg=ve(),Vg=ve();let kg=class extends Yt{constructor(){super(...arguments),this._zoomLocation=ve(),this._tmpCamera=new al,this._tmpRayDir=ve(),this._tmpCenter=ve(),this._constraintOptions={selection:Zt.ALL,interactionType:Kt.ZOOM,interactionFactor:null,interactionStartCamera:new al,interactionDirection:null,tiltMode:Jt.TUMBLE}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this._constraintOptions;r&&(this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r)),this._tmpCamera.copyFrom(i.camera);const s=cl(this.view.state.viewingMode);let a=!1;e>0?(a=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,0===this.view.map.ground.opacity?V_:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,s,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:De(this._zoomLocation,this._tmpCamera.center);const n=.6**e;let o=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],this.view.state.camera,60);Ie(Gg,this._tmpCamera.eye,this._zoomLocation),be(Gg,Gg);const l=Bi(Math.min(8,1/Math.abs(xe(qg,Gg)))*Math.abs(this.view.camera.position.z),200,j_);if(o=A(o)?o:l,o){const e=ve();Ie(e,this._zoomLocation,this._tmpCamera.eye),(o<Ce(e)||!a)&&(be(e,e),Oe(this._zoomLocation,this._tmpCamera.eye,Te(e,e,o)))}this._updateCamera(this._tmpCamera,n,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:K(600),easing:ei}}_updateCamera(e,t,i){Ie(this._tmpRayDir,i,e.eye);const r=Ce(this._tmpRayDir);let s=r*t;const a=t<=1,n=Math.max(4,1.01*e.nearFar[0]);0!==s&&(a&&s<n&&(s=n,t=s/r),Math.abs(r-s)<1e-6||(Te(this._tmpRayDir,this._tmpRayDir,t),e.eye=Ie(zg,i,this._tmpRayDir),e.center=we(zg,e.center,i,1-t),ti(this.view,e,this._constraintOptions)))}};kg=e([ue("esri.views.3d.state.controllers.local.ZoomStepController")],kg);const zg=ve(),qg=fe(0,0,1),Gg=ve();class Hg extends fl{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,(e=>this._handleDoubleClick(e)))}_handleDoubleClick(e){const t=e.data;if(fi(t,"primary")){const i=this._view.state.isGlobal?new Ug({view:this._view,mode:"animation"}):new kg({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),re(t.x,t.y)),e.stopPropagation()}}}let Bg=class extends ri{constructor(){super(...arguments),this.startCamera=new al,this.currentCamera=new al,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<si}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=ai.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout((()=>this.notifyChange("isInteractive")),si),this.view.state.updateCamera((e=>this.stepController(0,e))),this.steppingFinished&&this.finishController()}};var Wg;e([ce({readOnly:!0})],Bg.prototype,"isInteractive",null),e([ce()],Bg.prototype,"_lastInteraction",void 0),Bg=e([ue("esri.views.3d.state.controllers.InteractiveController")],Bg),function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"}(Wg||(Wg={}));let $g=class extends Bg{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=Wg.CENTER,this._rotScale=0,this._lastPoint=kr(),this._tmpWorldUp=ve(),this._tmpViewDir=ve(),this._tmpRotCurPoint=kr(),this._tmpTransf=is(),this._tmpAxis=ve(),this._tmpPivotPoint=ve(),this._pivotPos=ve(),this._constraintOptions={selection:Zt.ALL,interactionType:Kt.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Jt.TUMBLE}}initialize(){this._rotScale=this.pivot===Wg.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case Wg.EYE:De(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Kt.LOOK_AROUND,this._constraintOptions.tiltMode=Jt.LOOK_AROUND,this._constraintOptions.selection=Zt.NONE;break;case Wg.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,0===this.view.map.ground.opacity?V_:{});t||De(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.tiltMode=Jt.TUMBLE,this._constraintOptions.selection=Zt.ALL&~Zt.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,k_(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=ve();Ie(r,this._pivotPos,i.eye);const s=Ce(r),a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,Xg);let n=Math.max(Math.min(5,1/Math.abs(xe(Xg,i.viewForward)))*a,10);t&&(n=Math.min(s,n));const o=br(this.view.spatialReference),l=re(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),h=tg(this.startCamera,l,o);let c=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,225,90),d=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],i,90);(A(c)||A(d))&&(c=j(c,d),d=M(d)||h===Y_.Horizontal?c:d,n=c>d?d:c,n=t?Math.min(n,s):n),be(r,r),De(this._pivotPos,Oe(this._tmpPivotPoint,i.eye,Te(this._tmpPivotPoint,r,n)))}update(e){if(this.active){switch(this.pivot){case Wg.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case Wg.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}ti(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),k_(e,t,this._tmpRotCurPoint);let s=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,a=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;Ie(this._tmpViewDir,i,r);const n=Ce(this._tmpViewDir),o=Yi(xe(this._tmpViewDir,this._tmpWorldUp)/n);if(this.pivot===Wg.EYE){s*=-.5;const e=.5*Math.PI-o,t=.5*Math.PI*.99;s=e-Math.max(-t,Math.min(t,e+s))}return s=Bi(s+o,ap.min,ap.max)-o,Ae(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===Wg.CENTER&&(a=-a),Yr(this._tmpTransf,a,this._tmpWorldUp),Xr(this._tmpTransf,this._tmpTransf,s,this._tmpAxis),Le(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Le(Qg,e.up,this._tmpTransf),Oe(Qg,r,this._tmpViewDir),Or(this._lastPoint,this._tmpRotCurPoint),Qg}};e([ce()],$g.prototype,"pivot",void 0),$g=e([ue("esri.views.3d.state.controllers.RotateController")],$g);const Qg=ve(),Xg=ve();class Yg extends fl{constructor(e,t,i,r){super(!0),this._view=e,this.pointerAction=t,this._pivot=i,this.registerIncoming("drag",r,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!yi(e.data,this.pointerAction))return;const i=re(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new $g({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}let Zg=class extends Bg{constructor(){super(...arguments),this._pickPoint=ve(),this._tmpP0=kr(),this._panAxisAngle=A_(),this._tmpRayDir=ve(),this._tmpRayDirPick=ve(),this._targetOnSphere=ve(),this._navMode=Y_.Horizontal,this._tmpRay={origin:ve(),direction:ve()},this.dragBeginPoint=re(),this._normalizedAnchorPoint=kr(),this._constraintOptions={selection:Zt.ALL_EXCEPT_COLLISION,interactionType:Kt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Jt.TUMBLE},this._sphere=Mo(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Or(this.dragBeginPoint,e),k_(this.startCamera,e,this._normalizedAnchorPoint);const t=br(this.view.spatialReference),i=eg(this._intersectionHelper,this.startCamera,e,t,F_.Ellipsoid,0===this.view.map.ground.opacity?V_:{});if(this._navMode=tg(this.startCamera,e,t),this._navMode===Y_.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=j(i.scenePickPoint,this._pickPoint),this._sphere=i.sphere;else{let t;il(this.startCamera,e,this._tmpRay),be(this._tmpRay.direction,this._tmpRay.direction),A(i.scenePickPoint)&&(Ie(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),t=Ce(this._tmpRayDirPick));const r=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,Jg);let s=Bi(Math.min(30,1/Math.abs(xe(Jg,this._tmpRay.direction)))*r,U_[0],U_[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,80);s=A(a)?a:s,s=null!=t?Math.min(s,t):s,this._hasPickPoint=!0,Te(this._tmpRay.direction,this._tmpRay.direction,s),Oe(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Y_.Horizontal){Ie(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=Ce(this._tmpRayDir);k_(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){const e=1-(1-r/t)*(1-this._sphere[3]/Ce(this.currentCamera.center));this.currentCamera.center=Te(Kg,this.currentCamera.center,e)}Te(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=Oe(Kg,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=ni(Ar(this.dragBeginPoint,e)),ti(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(sg(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),D_(this._pickPoint,this._targetOnSphere,this._panAxisAngle),q_(this.currentCamera,this._sphere,this._panAxisAngle))}else{const t=Ce(this._tmpRay.direction);k_(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;Te(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=Oe(Kg,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=Oe(Kg,this.currentCamera.center,this._tmpRayDir)}ii(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};Zg=e([ue("esri.views.3d.state.controllers.global.ZoomController")],Zg);const Kg=ve(),Jg=ve();let ef=class extends Bg{constructor(){super(...arguments),this._tmpP=ve(),this._tmpDir=ve(),this._tmpN=ve(),this._tmpP0=kr(),this._tmpPoi=ve(),this._tmpRayDir=ve(),this.dragBeginPoint=re(),this._normalizedAnchorPoint=kr(),this._constraintOptions={selection:Zt.ALL,interactionType:Kt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:ve(),tiltMode:Jt.TUMBLE},this._plane=Wo()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;Or(this.dragBeginPoint,e),k_(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,0===this.view.map.ground.opacity?V_:{});Ie(this._tmpDir,this._tmpP,this.startCamera.eye);const i=Ce(this._tmpDir);be(this._tmpDir,this._tmpDir);const r=Math.abs(this.view.camera.position.z);let s=Bi(Math.min(30,1/Math.abs(xe(rf,this._tmpDir)))*r,U_[0],U_[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,80);s=A(a)?a:s,s=t?Math.min(s,i):s,Te(this._tmpDir,this._tmpDir,s),Oe(this._tmpP,this.startCamera.eye,this._tmpDir),Ie(this._tmpN,this.startCamera.eye,this.startCamera.center),be(this._tmpN,this._tmpN),this._tmpN[1]<0&&Fe(this._tmpN,this._tmpN),Xo(this._tmpP,this._tmpN,this._plane),this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;(function(e,t,i,r){return $o(e,rl(t,i,Ng),r)})(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||De(this._tmpPoi,this.currentCamera.center),k_(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);Or(this._normalizedAnchorPoint,this._tmpP0),Ie(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=Ce(this._tmpRayDir);let r=i*(1-t);this._constraintOptions.interactionDirection&&(De(this._constraintOptions.interactionDirection,this._tmpRayDir),Te(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(Te(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=Oe(tf,this.currentCamera.eye,this._tmpRayDir),we(tf,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?tf[2]=Math.max(this.startCamera.center[2],tf[2]):tf[2]=Math.min(this.startCamera.center[2],tf[2]),this.currentCamera.center=tf,this._constraintOptions.interactionFactor=ni(Ar(this.dragBeginPoint,e)),ti(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};ef=e([ue("esri.views.3d.state.controllers.local.ZoomController")],ef);const tf=ve(),rf=fe(0,0,1);class sf extends fl{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){const t=e.data;if(t.pointers.size>1)return;if(!yi(e.data,this.pointerAction))return;const i=re(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new Zg({view:this._view}):this._cameraController=new ef({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}}let af=class extends Bg{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new al,this._headingStart=0,this._constraintOptions={selection:Zt.ALL,interactionType:Kt.NONE,interactionStartCamera:new al,interactionFactor:0,interactionDirection:null,tiltMode:Jt.LOOK_AROUND}}handleEventGamepad(e){const t=vi(e,this.view.navigation.gamepad,this._transformation);("end"===e.action||bi(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,xi(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const t=xi(this._keysButtonState,this._transformation);bi(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z;this._filteredSurfaceElevation+=1*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,pf),this._applyDisabledMovementTypes(pf),this._applyPan(pf.pan),this._applyRotate(pf.rotate),this._applyZoom(pf.zoom),this._applyAscend(pf.ascend),this._constraintOptions.interactionType=Kt.NONE,this._constraintOptions.selection=Zt.COLLISION,ti(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;Ie(mf,t.center,t.eye),Le(mf,mf,e.matrix),t.center=Oe(mf,mf,t.eye),t.up=Le(mf,t.up,e.matrix),this._constraintOptions.interactionType=Kt.LOOK_AROUND,this._constraintOptions.selection=Zt.ALL_EXCEPT_COLLISION,ti(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=Le(mf,t.eye,e.matrix),t.center=Le(mf,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Le(mf,t.up,e.matrix)),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.selection=Zt.ALL,ti(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=Oe(mf,this.currentCamera.eye,Te(Ho.get(),t,e)),De(_f,t),Fe(_f,_f),this._constraintOptions.interactionDirection=_f,this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.selection=Zt.ALL_EXCEPT_COLLISION,ti(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Ho.get());if(this._constraintOptions.interactionDirection=De(_f,t),this.view.state.isGlobal){const t=Ce(this.currentCamera.eye),i=(t+e)/t;this.currentCamera.eye=Te(mf,this.currentCamera.eye,i),this.currentCamera.center=Te(mf,this.currentCamera.center,i)}else{const i=Te(Ho.get(),t,e);this.currentCamera.eye=Oe(mf,this.currentCamera.eye,i),this.currentCamera.center=Oe(mf,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=Kt.ASCEND,this._constraintOptions.selection=Zt.COLLISION,ti(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Zt.ALL_EXCEPT_COLLISION,ti(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){!function(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Jr(e.pan.matrix),e.rotate.enabled=!1,Jr(e.rotate.matrix)}(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,mf)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,a=this._transformation,n=this.view.navigation.gamepad,o=Pe(Ho.get(),s[0],s[1],0);be(o,o);const l=a.translation[0]*e.pan;if(0!==l){const e=Te(Ho.get(),r,l);Kr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}switch(n.mode){case"pan":{const t=-a.translation[1]*e.pan;if(0!==t){const e=Te(Ho.get(),o,t);Kr(i.pan.matrix,i.pan.matrix,e),i.pan.enabled=!0}i.zoom=a.zoom*e.zoom;break}case"zoom":i.zoom=(-a.translation[1]+a.zoom)*e.zoom;break;default:nr(n.mode)}const h=a.translation[2]*e.ascend;i.ascend=h;const c=-a.heading*e.rotate;0!==c&&(Xr(i.rotate.matrix,i.rotate.matrix,c,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Ho.get())),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=oi(this.view.renderCoordsHelper,t.center,t.eye),p=Bi(u+d,ap.min,ap.max)-u;p&&(Xr(i.rotate.matrix,i.rotate.matrix,p,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,a=this._transformation,n=this.view.navigation.gamepad,o=Ae(Ho.get(),s,r);be(o,o),Fe(o,o),function(e,t,i,r,s,a,n,o,l){pg(e.center,xe(e.up,e.center),Ce(e.center),-Uo.normalize(Wi(a)),n,t)?function(e,t,i,r,s,a){const{eye:n}=e;It([0,0,1],n,gg,fg,yg);const o=t.translation[0]*i.pan,l="zoom"===s.mode?0:t.translation[1]*i.pan,h=Math.max(Math.sqrt(Math.abs(1-xe(e.center,gg)**2/Ce(e.center)**2)),.5),c=(Math.sin(a)*l+Math.cos(a)*o)/h,d=-Math.cos(a)*l+Math.sin(a)*o;switch(Xr(r.pan.matrix,r.pan.matrix,c,gg),r.pan.enabled=!0,s.mode){case"pan":Xr(r.pan.matrix,r.pan.matrix,d,fg),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l,-Uo.normalize(Wi(s))):function(e,t,i,r,s){const{eye:a,viewRight:n}=e,o=Ae(Ho.get(),n,a),l=t.translation[0]*i.pan;switch(0!==l&&(Xr(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const e=t.translation[1]*i.pan;0!==e&&(Xr(r.pan.matrix,r.pan.matrix,e,n),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}(t,i,r,o,l)}(this.startCamera,t,a,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,n),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(pf.pan,this._tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=a.translation[2]*e.ascend;i.ascend=h;const c=-a.heading*e.rotate;0!==c&&(Xr(i.rotate.matrix,i.rotate.matrix,c,this._tmpCamera.eye),i.rotate.enabled=!0);const d=a.tilt*e.rotate,u=this._clampTiltDeltaGlobalToValidRange(d,t.ray,l);0!==u&&(Xr(i.rotate.matrix,i.rotate.matrix,u,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=a.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=br(this.view.spatialReference),s=Q_(ap.min,t.origin,i,r);let a=0,n=0;const o=Ho.get();return this.view.renderCoordsHelper.intersectManifold(t,i,o)?(a=Q_(oi(this.view.renderCoordsHelper,o,t.origin),t.origin,i,r),n=Q_(ap.max,t.origin,i,r)):(Ao(Do(Io,i+r.radius),t,o),a=X_(-Vo(t.direction,o),t.origin,i,r),n=X_(ap.max,t.origin,i,r)),Bi(a+e,s,n)-a}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),a=t+Math.abs(s-t);return r.setAltitude(i,a,e),a}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=bl(this.view,t,0,of,gf),a=i.intersectManifoldClosestSilhouette(Bo(t,s),e,Ho.get()),n=Ee(t,a),o=i.intersectManifoldClosestSilhouette(Bo(t,Ue(Ho.get(),t,r.center)),e,Ho.get()),l=Ee(t,o);return Math.min(n,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,a=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,Ho.get());if(s){const t=Ie(Ho.get(),e,a),i=Ce(t);Te(t,t,1/i);const r=be(Ho.get(),e),s=Yi(xe(r,t));return i*Math.sin(Math.min(lf,s))}{const i=De(Ho.get(),e);return t.setAltitude(i,this._filteredSurfaceElevation),Ee(a,i)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:cf}_computeVelocities(e){const t=this._filteredSurfaceElevation,i=t+br(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,a=Ho.get(),n=this._getPointAbsoluteSurfaceElevation(r.eye,t,a),o=this._clampedDistanceToSurface(t,a),l=r.width/2,h=hf*r.width,c=hf*r.width,d=o*Math.tan(.5*r.fovX)/l,u=d/i,p=d/this._computeHeadingRotateRadius(a),m=n-t;return{pan:(s?u:d)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/l)*m-m),zoom:2**(h*e/l)*o-o,rotate:Bi(p*c,df,uf)*e}}_applyDisabledMovementTypes(e){!A(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Jr(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Jr(e.rotate.matrix))}static activatesFor(e,t){const i=vi(t,e.navigation.gamepad,nf);return!("end"===t.action||bi(i))}};e([ce({constructOnly:!0})],af.prototype,"gamepadDevice",void 0),e([ce({constructOnly:!0})],af.prototype,"disableMovements",void 0),af=e([ue("esri.views.3d.state.controllers.GamepadKeyboardController")],af);const nf={translation:[0,0,0],heading:0,tilt:0,zoom:0},of=80,lf=Wi(of),hf=.75,cf=5,df=Wi(30),uf=Wi(80),pf={zoom:0,ascend:0,pan:{enabled:!1,matrix:is()},rotate:{enabled:!1,matrix:is()}},mf=ve(),_f=ve(),gf=xl();class ff extends fl{constructor(e){super(!0),this._view=e,this._watchHandles=new R,this._handle=this.registerIncoming("gamepad",(e=>this._handleEventGamepad(e))),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([G((()=>this._view.navigation.gamepad.enabled),(e=>{e?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))}),H),G((()=>this._view.navigation.gamepad.device),(e=>{this._cameraControllerGamepad&&e&&this._cameraControllerGamepad.gamepadDevice!==e&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)}))])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const i=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(i||af.activatesFor(this._view,e.data)){if(!i){const t=new af({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(t)&&(this._cameraControllerGamepad=t)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}}var yf;!function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"}(yf||(yf={}));class vf extends fl{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Ui.Local},this._keyToNumber={[t.left]:yf.LEFT,[t.right]:yf.RIGHT,[t.forward]:yf.FORWARD,[t.backward]:yf.BACKWARD,[t.up]:yf.UP,[t.down]:yf.DOWN,[t.headingLeft]:yf.HEADINGLEFT,[t.headingRight]:yf.HEADINGRIGHT,[t.tiltUp]:yf.TILTUP,[t.tiltDown]:yf.TILTDOWN,[t.zoomIn]:yf.ZOOMIN,[t.zoomOut]:yf.ZOOMOUT},this.registerIncoming("key-down",null,(e=>this._handleKeyDown(e))),this.registerIncoming("key-up",null,(e=>this._handleKeyUp(e))),this.registerIncoming("blur",null,(()=>this._handleBlur()))}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];null!=t&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new af({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleBlur(){this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];null!=t&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}}class bf extends fl{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",t,(e=>this._handleMouseWheel(e)))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new Ug({view:this._view,mode:"interaction"}):new kg({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,re(t.x,t.y)),e.preventDefault(),e.stopPropagation()}}class xf{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return void 0===this._value?0:this._value}update(e){void 0===this._value?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}}let Tf=class extends li{constructor(){super(...arguments),this._beginCamera=new al,this._elapsedTimeSec=0,this.constraintOptions={selection:Zt.ALL,interactionType:Kt.PAN,interactionFactor:0,interactionStartCamera:new al,interactionDirection:null,tiltMode:Jt.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Fi}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this._beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),ti(this.view,t,this.constraintOptions)}};Tf=e([ue("esri.views.3d.state.controllers.momentum.MomentumController")],Tf);let wf=class extends Tf{constructor(e){super(e),this.interactionType=Kt.PAN,this._tmpPan=ve()}momentumStep(e,t){const i=this.momentum.value(e);Te(this._tmpPan,this.momentum.direction,i),t.eye=Ie(Cf,t.eye,this._tmpPan),t.center=Ie(Cf,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};e([ce({constructOnly:!0})],wf.prototype,"momentum",void 0),wf=e([ue("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],wf);const Cf=ve(),Sf=ve(),Pf=ve();let Rf=class extends Tf{constructor(e){super(e),this.interactionType=Kt.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);De(Pf,t.eye),be(Pf,Pf),Ae(this.momentum.axis2,Pf,this.momentum.axis1),ug(t,Sf,this.momentum.axis1,i,this.momentum.axis2,r)}};e([ce({constructOnly:!0})],Rf.prototype,"momentum",void 0),Rf=e([ue("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Rf);let Of=class extends Tf{set center(e){this._set("center",je(e))}set axis(e){this._set("axis",je(e))}constructor(e){super(e),this.interactionType=Kt.TUMBLE}momentumStep(e,t){const i=this.momentum.value(e);q_(t,this.center,M_(this.axis,i))}};e([ce({constructOnly:!0})],Of.prototype,"momentum",void 0),e([ce({constructOnly:!0})],Of.prototype,"center",null),e([ce({constructOnly:!0})],Of.prototype,"axis",null),Of=e([ue("esri.views.3d.state.controllers.momentum.MomentumController")],Of);let Ef=class extends Tf{set zoomCenter(e){this._set("zoomCenter",je(e))}constructor(e){super(e),this.interactionType=Kt.ZOOM,this.constraintOptions.interactionDirection=ve()}momentumStep(e,t){const{interactionDirection:i}=this.constraintOptions;if(!i)return;De(i,t.eye);const r=this.momentum.valueDelta(0,e);H_(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),Ue(i,t.eye,i)}};e([ce({constructOnly:!0})],Ef.prototype,"momentum",void 0),e([ce({constructOnly:!0})],Ef.prototype,"zoomCenter",null),Ef=e([ue("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Ef);let Af=class extends Tf{set screenCenter(e){this._set("screenCenter",re(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",je(e))}constructor(e){super(e),this.interactionType=Kt.ZOOM,this.radius=0,this._tmpSceneCenter=ve(),this._tmpZoomAxisAngle=A_(),this._sphere=Mo()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);B_(this._sphere,t,i),this.constraintOptions.interactionType=Kt.ZOOM,ti(this.view,t,this.constraintOptions),sg(this._sphere,t,this.screenCenter,this._tmpSceneCenter),D_(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),q_(t,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Kt.PAN}};e([ce({constructOnly:!0})],Af.prototype,"momentum",void 0),e([ce({constructOnly:!0})],Af.prototype,"screenCenter",null),e([ce({constructOnly:!0})],Af.prototype,"sceneCenter",null),e([ce({constructOnly:!0})],Af.prototype,"radius",void 0),Af=e([ue("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],Af);class Mf{constructor(e){this._gain=e}update(e){void 0!==this.filteredValue?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return void 0!==this.filteredValue}}const Df=1e-5;class If extends Sl{constructor(e,t,i,r,s,a=0,n){super(e,t,i),this._angularVelocity1=r,this.axis1=s,this.angularVelocity2=a,this.axis2=n}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}}class Lf{constructor(e=300,t=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=i,this.enabled=!0,this._tmpAxis1=ve(),this._tmpAxis2=ve(),this._tmpAngles=kr(),this._time=new Cl(.3),this._screen=[new Cl(.4),new Cl(.4)],this._angle1=new Mf(.6),this._angle2=new Mf(.6),this._axis1=ve(),this._axis2=ve(),this._lastScene=ve()}addMomentumDirectRotation(e,t,i,r,s,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let e=lg(this._lastScene,t,this._tmpAxis2,r,s,a);this._angle2.update(0),ye(this._tmpAxis2)<Df?e=0:be(this._axis1,this._tmpAxis2),this._angle1.update(e),De(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,t,i,r,s,a,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;dg(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,r,s,a,n,!1),ye(this._tmpAxis2)<Df?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),be(this._axis1,this._tmpAxis1),be(this._axis2,this._tmpAxis2)),De(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,i=null==e||null==t?null:Math.sqrt(e*e+t*t),r=this._time.filteredDelta,s=null==i||null==r?0:i/r;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(e,t,i){const r=this._time.filteredDelta,s=this._angle1.filteredValue,a=this._angle2.filteredValue,n=null==r||null==a?0:a/r;return new If(e,t,i,null==r||null==s?0:s/r,this._axis1,n,this._axis2)}}let Nf=class extends Bg{constructor(){super(...arguments),this._smoothRotation=new xf(.05),this._rotationAxis=ve(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Wo(),this._beginRadius=0,this._smoothScaling=new xf(.05),this._zoomCenterScreen=re(),this._zoomMomentumEstimator=new Pl,this._rotationMomentumEstimator=new Rl,this._panSphericalMomentumEstimator=new Lf,this._panPlanarMomentumEstimator=new Ol,this._adjustedSphere=Mo(),this._tmp3d=ve(),this._tmpScreenPointArray=re(),this._beginScreenPoint=re(),this._beginScenePoint=ve(),this._screenPickPoint=re(),this._scenePickPoint=ve(),this._mode=Y_.Horizontal,this._sphere=Mo(),this._pointerCount=0,this._tmpInteractionDirection=ve(),this._constraintOptions={selection:Zt.ALL,interactionType:Kt.NONE,interactionFactor:0,interactionStartCamera:new al,interactionDirection:null,tiltMode:Jt.TUMBLE}}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panPlanarMomentumEstimator.enabled=t,this._panSphericalMomentumEstimator.enabled=t,this._beginHeading=-Uo.normalize(Wi(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),se(e.center,this._screenPickPoint),Or(this._beginScreenPoint,this._screenPickPoint);const i=br(this.view.spatialReference),r=eg(this._intersectionHelper,this.startCamera,this._screenPickPoint,i,F_.Silhouette,0===this.view.map.ground.opacity?V_:{});M(r.scenePickPoint)||(this._scenePickPoint=r.scenePickPoint,this._sphere=r.sphere,De(this._beginScenePoint,this._scenePickPoint),this._mode=tg(this.startCamera,this._screenPickPoint,i),this._mode===Y_.Vertical&&this._preparePlanarPanMode(e,r.hasGeometryIntersection),this._constraintOptions.interactionStartCamera?.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._mode===Y_.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._mode===Y_.Horizontal?new Af({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Ef({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Of({view:this.view,momentum:i,center:this._sphere,axis:this._rotationAxis});if(this._mode===Y_.Horizontal){const e=this._panSphericalMomentumEstimator.evaluateMomentum();if(e)return new Rf({view:this.view,momentum:e})}else{const e=this._panPlanarMomentumEstimator.evaluateMomentum();if(e)return new wf({view:this.view,momentum:e})}return null}_preparePlanarPanMode(e,t){const i=Fe(this._tmp3d,this.startCamera.viewForward);Xo(this._scenePickPoint,i,this._panningPlane);const r=re(this._screenPickPoint[0],0),s=ve(),a=Ce(this.startCamera.eye);this._adjustedSphere[3]=a<this._sphere[3]?a-100:this._sphere[3],sg(this._adjustedSphere,this.startCamera,r,s);const n=ae();this.startCamera.projectToRenderScreen(s,n);const o=ve(),l=ve(),h=ve();Ie(o,this._scenePickPoint,this.currentCamera.eye);const c=Ce(o);be(o,o);const d=5*Math.max(Math.abs(this.view.camera.position.z),50),u=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,80);let p=A(u)?u:d;p=t?Math.min(p,c):p,De(h,Oe(l,this.currentCamera.eye,Te(l,o,p))),this._panningPlane[3]=-xe(Yo(this._panningPlane),h),this.startCamera.center=Oe(l,this.startCamera.eye,Te(l,this.startCamera.viewForward,p));const m=se(e.center,this._tmpScreenPointArray);G_(this._panningPlane,this.startCamera,m,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),B_(this._sphere,this.currentCamera,this._smoothScaling.value),se(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.interactionFactor=ni(e.radius-this._beginRadius),ti(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=se(e.center,this._tmpScreenPointArray);sg(this._sphere,this.currentCamera,t,this._tmp3d),pg(this._beginScenePoint,xe(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(_g(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(mg(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.interactionFactor=ni(Ar(this._screenPickPoint,t)),ti(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){be(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||Fe(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,i=t+z_(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);const s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),q_(this.currentCamera,this._sphere,M_(this._rotationAxis,s)),this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.interactionFactor=ni(e.radius*i),ti(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=se(e.center,this._tmpScreenPointArray);G_(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(ig(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.interactionFactor=ni(Ar(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),ti(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),H_(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.interactionFactor=ni(e.radius-this._beginRadius),ti(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){De(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||Fe(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let i=e.angle-t;i=z_(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),q_(this.currentCamera,this._sphere,M_(this._rotationAxis,a)),this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.interactionFactor=ni(e.radius*a),ti(this.view,this.currentCamera,this._constraintOptions)}};Nf=e([ue("esri.views.3d.state.controllers.global.PinchAndPanController")],Nf);const Ff=fe(0,0,1),Uf=16/180*Math.PI;let jf=class extends Bg{constructor(){super(...arguments),this._rotationValueSmooth=new xf(.05),this._scalingValueSmooth=new xf(.05),this._planeHorizontal=Wo(),this._planeVertical=Wo(),this._rotationMomentumEstimator=new Rl,this._panMomentumEstimator=new Ol(300,12,.9),this._zoomMomentumEstimator=new Pl,this._beginRadius=0,this._beginCenter=ve(),this._beginAngle=0,this._tmpPoints=[],this._panMode=Y_.Horizontal,this._beginCenterScreen=re(),this._tmpCentroid3d=ve(),this._tmpCentroid2d=re(),this._tmp2d=re(),this._pointerCount=0,this._constraintOptions={selection:Zt.ALL,interactionType:Kt.NONE,interactionFactor:0,interactionStartCamera:new al,interactionDirection:null,tiltMode:Jt.TUMBLE}}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),se(e.center,this._beginCenterScreen),Qo(Ff,0,this._planeHorizontal);const i=ve(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,0===this.view.map.ground.opacity?V_:{}),s=ve();Fe(s,this.startCamera.viewForward);const a=ve();De(a,Ff);const n=xe(s,a),o=Zi(n<0?-n:n);this._panMode=o>=Uf?Y_.Horizontal:Y_.Vertical;const l=Math.min(5,1/Math.abs(xe(a,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),50);Zo(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||Ko(this._planeHorizontal,this._planeHorizontal);const h=ve(),c=ve(),d=ve();Ie(h,i,this.currentCamera.eye);const u=Ce(h);if(be(h,h),this._panMode===Y_.Vertical){Te(a,a,n),Ie(this._planeVertical,s,a),be(this._planeVertical,this._planeVertical),Zo(this._planeVertical,this._planeVertical,i);const t=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,80);let o=A(t)?t:l;o=r?Math.min(o,u):o,De(d,Oe(c,this.currentCamera.eye,Te(c,h,o))),this._planeVertical[3]=-xe(this._planeVertical,d),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),$_(this._tmpPoints,this._beginCenter)}else{const t=r?u:l;De(d,Oe(c,this.currentCamera.eye,Te(c,h,t))),this._planeHorizontal[3]=-xe(Yo(this._planeHorizontal),d),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),$_(this._tmpPoints,this._beginCenter)}this._constraintOptions.interactionStartCamera?.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this._panMode===Y_.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){const t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=i,this._scalingValueSmooth.update(t),H_(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.interactionFactor=ni(Math.abs(e.radius-this._beginRadius)),ti(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),$_(this._tmpPoints,this._tmpCentroid3d),se(e.center,this._tmpCentroid2d),ig(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.interactionFactor=ni(Ar(this._beginCenterScreen,this._tmpCentroid2d)),ti(this.view,this.currentCamera,this._constraintOptions),t){const t=this._planeHorizontal,i=r,s=this._rotationValueSmooth.value,a=s+z_(e.angle-s),n=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=n,this._rotationValueSmooth.update(a);const o=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(o,.001*e.timestamp),q_(this.currentCamera,i,M_(t,o)),this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.interactionFactor=ni(Math.abs(e.radius*o)),ti(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new Ef({view:this.view,momentum:t,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Of({view:this.view,momentum:i,center:this._beginCenter,axis:Yo(this._planeHorizontal)});const r=this._panMomentumEstimator.evaluateMomentum();return r?new wf({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;const s=this._tmp2d;let a=0;return e.forEach((e=>{s[0]=e.x,s[1]=e.y,void 0===r[a]&&(r[a]=ve()),G_(t,i,s,r[a]),a+=1})),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};jf=e([ue("esri.views.3d.state.controllers.local.PinchAndPanController")],jf);class Vf extends fl{constructor(e,t,i){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,(e=>this._handleDrag(e)))}_handleDrag(e){if("mouse"===e.data.pointerType&&!yi(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,i=this._momentum&&this._momentum.active&&t<40;switch(e.data.action){case"start":case"update":if(i)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);t&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new Nf({view:this._view}):new jf({view:this._view})}}class kf extends fl{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,(()=>this.view.state.stopActiveCameraController()))}}class zf extends fl{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,(e=>this._handleKeyDown(e)))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}}class qf extends zf{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({heading:0}).catch((()=>{}))}}class Gf extends zf{constructor(e,t,i){super(t,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch((()=>{}))}}class Hf extends fl{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",(e=>this._handleTwoFinger(e)))}_handleTwoFinger(e){const t=this._invert?-1:1,i=re(0,e.data.delta*t);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new $g({view:this._view,pivot:Wg.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}}class Bf extends fl{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new Ti({start:(e,t)=>this._observeStart(e,t),update:(e,t,i)=>this._observeUpdate(e,t,i),end:(e,t)=>this._observeEnd(t)}),this.registerIncoming("drag",(e=>this._dragEventSeparator.handle(e)))}get failed(){return"failed"===this._state}_observeStart(e,t){1===e&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=2===e?"ready":"failed"}_observeUpdate(e,t,i){if("failed"!==this._state&&2===e)return"active"===this._state?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,i.data)?this._checkVerticalThresholdReached(t.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){"active"===this._state&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let i=-1/0,r=1/0,s=-1/0,a=1/0;for(const{x:e,y:n}of t.pointers.values())i=Math.max(i,e),r=Math.min(r,e),s=Math.max(s,n),a=Math.min(a,n);let n=-1/0,o=1/0,l=-1/0,h=1/0;for(const{x:t,y:i}of e.pointers.values())n=Math.max(n,t),o=Math.min(o,t),l=Math.max(l,i),h=Math.min(h,i);const c=i-r,d=s-a,u=n-o,p=l-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(u-c)<=this._maxDelta&&Math.abs(p-d)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let i=Math.abs(e.center.y-t.center.y);return e.pointers.forEach(((e,r)=>{const s=t.pointers.get(r);i=Math.min(i,Math.abs(e.y-s.y))})),i>=this._threshold}}let Wf=class extends Hi{constructor(){super(...arguments),this._handles=new R}destroy(){this._handles=I(this._handles),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){"pan"!==e&&"rotate"!==e||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){"default"!==e&&"pro"!==e||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get hasPendingInputs(){return!!this._inputManager?.hasPendingInputs}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=I(this._inputManager)}connect(){const e=this.view;this._source=new wi(this.view.surface,e.input);const t=[new Ci,new Si,new Pi,new Ri(this.view.navigation),new Bf],i=new yl({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Oi],vl.INTERNAL),this._modeDragPan=new Vf(e,"primary"),this._modeDragRotate=new Yg(e,"secondary",Wg.CENTER),this._modeDragZoom=new sf(e,"tertiary"),i.installHandlers("navigation",[new kf(e),new Hg(e),new ff(e),new vf(e,{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"}),new bf(e),new Gf(e,"p"),new qf(e,"n"),new Yg(e,"primary",Wg.EYE,["b"]),new Yg(e,"secondary",Wg.CENTER,["b"]),new Vf(e,"tertiary",["b"]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Hf(e)],vl.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this._handles.add(G((()=>this.view.navigation?.browserTouchPanEnabled),(e=>{this._source.browserTouchPanningEnabled=!e}),H))}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=$f.get(e)?.get(t);i&&(this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};e([ce()],Wf.prototype,"view",void 0),e([ce({value:"pan"})],Wf.prototype,"primaryDragAction",null),e([ce({value:"default"})],Wf.prototype,"mode",null),e([ce({readOnly:!0})],Wf.prototype,"hasPendingInputs",null),e([ce()],Wf.prototype,"latestPointerType",null),e([ce()],Wf.prototype,"latestPointerLocation",null),e([ce()],Wf.prototype,"multiTouchActive",null),e([ce()],Wf.prototype,"_inputManager",void 0),Wf=e([ue("esri.views.3d.input.SceneInputManager")],Wf);const $f=new Map,Qf=new Map,Xf=new Map;Qf.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),Qf.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),Xf.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),Xf.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),$f.set("default",Qf),$f.set("pro",Xf);const Yf=Wf;let Zf,Kf,Jf=!1,ey=!1,ty=!1,iy=!1,ry=null;function sy(){ry&&(ry(),ry=null)}function ay(e,t,i,r,s){sy();const a=Zf.height,n=Kf;n.beginPath(),n.lineWidth=1,n.strokeStyle=s,n.moveTo(e,a-i),n.lineTo(t,a-i),n.stroke(),n.lineTo(t,a-r),n.stroke(),n.lineTo(t,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.lineTo(e,a-i),n.stroke(),n.closePath()}function ny(e,t){Jf&&(t&&ty||!t&&iy)&&ay(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}const oy=ve(),ly=_r(),hy=_r(),cy=ve(),dy=is(),uy=Mo(),py=qo(),my=ve(),_y=at();class gy{constructor(){this.aabr=at(),this.distance=0,this.culled=!1,this.visible=!1}}class fy{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var yy;!function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"}(yy||(yy={}));class vy{constructor(){this.camera=new al,this.slicePlane=Rt(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Ot(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let by=class extends Hi{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._runningViewState=new vy,this._state=yy.Idle,this._active=new Map,this._visible=new Map,this._iterators=new wy,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==yy.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/yy.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&null!=this.view.state&&this.updating}runTask(e){switch(this._state){case yy.Idle:this._startUpdate(),e.madeProgress();case yy.Process:if(this._state=yy.Process,!this._processActiveGraphics(e))return;case yy.Sort:if(this._state=yy.Sort,!this._sortVisibleGraphics(e))return;case yy.Deconflict:if(this._state=yy.Deconflict,!this._deconflictVisibleGraphics(e))return;default:!function(e,t){if(!ey||!Kf)return;sy();const i=Kf;let r=0;for(let t=0;t<e.accBinsNumX;t++)for(let s=0;s<e.accBinsNumY;s++){const a=e.accBins[t][e.accBinsNumY-1-s];r+=a.length;const n=t*e.accBinsSizeX,o=(t+1)*e.accBinsSizeX,l=s*e.accBinsSizeY,h=(s+1)*e.accBinsSizeY;i.fillText(a.length.toFixed(),n+5,l+15),ay(n,o,l,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}(this,this._visible),this._state=yy.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach((e=>this.addToActiveGraphics(e))):e.forEach((e=>this.removeFromActiveGraphics(e))),this.setDirty()}layerSupportsDeconfliction(e){if(M(e)||"object3d"!==e.type)return!1;const t=e.stageObject;if(1!==(t?t.geometries.length:0))return!1;const i=t?.geometries[0],r=i?.material;return r instanceof Bl}_startUpdate(){var e;e=this.view,ty=La.DECONFLICTOR_SHOW_VISIBLE,iy=La.DECONFLICTOR_SHOW_INVISIBLE,Jf=ty||iy,ey=La.DECONFLICTOR_SHOW_GRID,ry=null,Jf||ey?ry=()=>function(e){null==Zf&&(Zf=document.createElement("canvas"),Zf.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Zf));const{state:t}=e,{camera:i,pixelRatio:r}=t,{width:s,height:a}=i,n=s*r,o=a*r;Zf.setAttribute("width",`${n}px`),Zf.setAttribute("height",`${o}px`),Zf.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${a}px`),Kf=Zf.getContext("2d"),Kf.clearRect(0,0,s,a),Kf.font="12px Arial"}(e):Zf&&(Zf.parentElement.removeChild(Zf),Zf=null),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:i}=this._runningViewState.camera;this._initBins(t,i),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new gy,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),function(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(Al.DECONFLICTION,t)}(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=Gr(dy,this._runningViewState.camera.projectionMatrix),r="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&this._runningViewState.camera.relativeElevation>0?uy:null;let s=0;for(A(r)&&(Le(r,Ve,this._runningViewState.camera.viewMatrix),r[3]=br(this.view.spatialReference).radius,s=Lo(r,Ve));!e.done;){e.madeProgress();const a=t.next();if(!0===a.done)return this._resetActiveGraphicsIterator(),!0;const n=a.value,o=n&&n.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(n,i,r,s),o.culled?this._visible.delete(n.graphics3DGraphic.graphic.uid):this._visible.set(n.graphics3DGraphic.graphic.uid,n))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),!0===i.done)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===El.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(!0===r.done)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,a=s.info[this.visibilityGroup];if(!a||a.culled)continue;const n=s.graphics3DGraphic,o=(!i||n.isVisible())&&!this._isConflicted(s);o&&this._addToBins(s),a.visible=o,this._setGraphicVisibility(s,o),ny(a,o)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=xy(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=xy(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=function*(e,t,i){t.clear(),e.forEach(((e,r)=>{const s=t.pushNew();s.id=r,s.visible=e.graphics3DGraphic.hasVisibilityFlag(Al.DECONFLICTION,i),s.prio=e.info?e.info[i].distance:Number.MAX_VALUE})),yield;const r=t.iterableSort(((e,t)=>e.visible!==t.visible?e.visible?-1:1:e.prio!==t.prio?e.prio-t.prio:e.id-t.id));for(let e=r.next();!e.done;e=r.next())yield;t.forAll((t=>{const i=e.get(t.id);i&&(e.delete(t.id),e.set(t.id,i))})),t.clear()}(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const a=e.info[this.visibilityGroup];if(!s.isVisible(El.GRAPHIC,Al.DECONFLICTION))return void(a.culled=!0);const n=this.getGraphicsLayers(s);nt(a.aabr);let o=null;for(const s of n){if(!this.layerSupportsDeconfliction(s))continue;const n=s.stageObject.geometries[0].material;if(M(o)){if(o=Sy,this._getProjectionInfo(s,t,o),o.isOutsideScreen||this._isCulledBySlice(e,oy)||A(i)&&this._isCulledByHorizon(o,i,r))return void(a.culled=!0);!La.TESTS_DISABLE_OPTIMIZATIONS&&a.visible&&(o.distance*=.7)}this._expandBoundingRect(a,s,n,o)}M(o)?a.culled=!0:(a.distance=o.distance,a.culled=!1)}_getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,a=s.geometries[0],n=a.material,o=No(s.boundingVolumeWorldSpace.bounds);Le(oy,o,r.viewMatrix);const l=a.vertexAttributes,h=l.get(Gs.NORMAL).data,c=l.get(Gs.AUXPOS1).data;n.applyShaderOffsetsView(oy,h,s.transformation,c,r,i.scaleInfo,oy),Dr(ly,oy[0],oy[1],oy[2],1),Ir(hy,ly,r.projectionMatrix),Te(i.positionNDC,hy,1/hy[3]),n.applyShaderOffsetsNDC(i.positionNDC,c,r,i.positionNDC,cy),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(cy[2]),i.distance=cy[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),Dr(hy,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),Ir(ly,hy,t),Lr(ly,ly,1/ly[3]),Pe(i.positionView,oy[0],oy[1],oy[2])}_isCulledByHorizon(e,t,i){return De(py.direction,e.positionView),Pe(py.origin,0,0,0),!!Eo(t,py,my)&&e.distanceWithoutPolygonOffset>i}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&Et(this._runningViewState.slicePlane,t)}_expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const a=this._runningViewState.camera,n=t.getScreenSize(Cy);Xs(n,s.factor,n),n[0]*=a.pixelRatio,n[1]*=a.pixelRatio;const o=ot(i.calculateRelativeScreenBounds(n,s.factorAlignment.scale,_y),Qi(0,a.fullWidth,.5+.5*r[0]),Qi(0,a.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(0!==l){const e=l*Math.min(lt(o),ht(o));o[0]-=e,o[1]-=e,o[2]+=e,o[3]+=e}ct(e.aabr,o,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let e=Math.floor(i.aabr[0]/this._accBinsSizeX);e<=Math.floor(i.aabr[2]/this._accBinsSizeX);e++)if(!(e<0||e>=this._accBinsNumX))for(let r=Math.floor(i.aabr[1]/this._accBinsSizeY);r<=Math.floor(i.aabr[3]/this._accBinsSizeY);r++){if(r<0||r>=this._accBinsNumY)continue;const s=this._accBins[e][r];for(let e=0;e<s.length;e++){const r=s.data[e],a=r.info[this.visibilityGroup];if(a&&a.visible&&r.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,dt(a.aabr,i.aabr)))return!0}}return!1}_initBins(e,t){if(null==this._accBins){this._accBins=[];for(let e=0;e<this._accBinsNumX;e++){this._accBins.push([]);const e=this._accBins[this._accBins.length-1];for(let t=0;t<this._accBinsNumY;t++)e.push(new J)}}else for(let e=0;e<this._accBinsNumX;e++)for(let t=0;t<this._accBinsNumY;t++)this._accBins[e][t].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this._accBinsSizeX),r=Math.floor(t.aabr[2]/this._accBinsSizeX),s=Math.floor(t.aabr[1]/this._accBinsSizeY),a=Math.floor(t.aabr[3]/this._accBinsSizeY);for(let t=i;t<=r;t++)if(!(t<0||t>=this._accBinsNumX))for(let i=s;i<=a;i++)i<0||i>=this._accBinsNumY||this._accBins[t][i].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(Al.DECONFLICTION,t,this.visibilityGroup),this.visibilityGroup===El.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function*xy(e){if(Map.prototype.entries){const t=e.entries();for(let e=t.next();!e.done;e=t.next())yield e.value[1]}else yield*e.values()}e([ce({constructOnly:!0})],by.prototype,"view",void 0),e([ce({type:Boolean,readOnly:!0})],by.prototype,"updating",null),by=e([ue("esri.views.3d.layers.graphics.Deconflictor")],by);class Ty{}class wy{constructor(e=null,t=null,i=null){this.active=e,this.visible=t,this.sort=i,this.sortArray=new J({allocator:e=>e||new Ty})}}const Cy=kr(),Sy=new class{constructor(){this.positionView=ve(),this.positionNDC=ve(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new Wl}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}};let Py=class extends by{constructor(e){super(e),this.visibilityGroup=El.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return kn.YIELD;const t=performance.now();if(e.state!==zn.IDLE&&t-this._lastDeconfliction<2e3)return kn.YIELD;super.runTask(e),this.state===yy.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};e([ce({constructOnly:!0})],Py.prototype,"parent",void 0),Py=e([ue("esri.views.3d.layers.graphics.LabelDeconflictor")],Py);let Ry=class extends by{constructor(){super(...arguments),this._handles=new R,this._contexts=new Map,this._viewState=new vy,this.visibilityGroup=El.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([G((()=>this.view?.state?.camera),(()=>{this._updateViewState(),this.setDirty()})),G((()=>this.view?.map?.ground?.opacity),((e,t)=>{1!==e&&1!==t||this.setDirty()})),G((()=>this.view?.slicePlane),(()=>{this._updateSlicePlane(),this._slicePlaneChanged()}),H)]),this._frameTask=this.view.resourceController.scheduler.registerTask(Vn.GRAPHICS_DECONFLICTOR,this),this._labels=new Py({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&Oy(e));t.setVisibilityFlag(Al.DECONFLICTION,i,El.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;A(e)&&At(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=A(e)}_slicePlaneChanged(){me(this._contexts,((e,t)=>t.symbolCreationContext.slicePlaneEnabled))&&this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:e=>this._removeGraphic(t,e),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic)))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach((e=>this._removeGraphic(t,e.graphics3DGraphic))),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new fy(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),Oy(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=Oy(e);i||function(e){const t=e.graphics3DGraphics;t&&t.forEach((e=>e.clearVisibilityFlag(Al.DECONFLICTION)))}(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach((e=>e.slicePlaneEnabled=i)),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t||!t.length)return!1;for(const e of t)if(this.layerSupportsDeconfliction(e))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function Oy(e){const t=e.layer;return!(!t||!t.featureReduction||"selection"!==t.featureReduction.type)}function Ey(e){return e instanceof Ml?e.graphics3DSymbol:e instanceof Dl?e:null}Ry=e([ue("esri.views.3d.layers.graphics.GraphicsDeconflictor")],Ry);const Ay=E.getLogger("esri.views.3d.layers.graphics.labelPlacement");function My(e){const t=function(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=Ey(r.graphics3DSymbol),a=V(s,(e=>"point-3d"===e.symbol.type?e.symbol:null)),n=Uy[t]||Ly(e);return A(a)&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Fy(a.verticalOffset),anchor:null,normalizedOffset:null}:i&&i.hasVisibleVerticalOffset()&&(M(a)||!a.supportsCallout()||!a.verticalOffset||r.isDraped)?"above-center"===n.placement?{placement:"above-center",verticalOffset:Fy(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(Ay.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}(e);if(M(t))return null;const i=function(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=Uy[i],s=r||Ly(e);return i&&!r&&Ay.warnOncePerTick(`the requested label placement '${i}' is currently unsupported in SceneView.`),function(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(M(i))return null;if(A(t.disablePlacement))return t.labelClass.labelPlacement?(Ay.warnOncePerTick(Iy(e.placement,t.disablePlacement.logEntityDescription)),Ly(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return Ay.warnOncePerTick(Iy(e.placement,`'${r}' geometries`)),Ly(t);break;case"point":case"mesh":return e}return e}(s,e)}(e,t);if(M(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return function(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(M(r))return null;switch(r.type){case"point":!function(e,t,i){const r=Dy(i);if(M(r))return;const s=i.graphics3DGraphic.layers[0];switch(A(s)?s.getCenterObjectSpace(e.translation):Pe(e.translation,0,0,0),r.type){case"icon":case"text":!function(e,t,i,r){const{graphics3DGraphic:s}=i,a=A(r)?r.getScreenSize():null;if(!s.isDraped&&A(a)){const r=function(e,t=ky){const{graphics3DGraphic:i}=e,r=i.layers[0],s=A(r)?r.stageObject.geometries[0].material:null;if(s&&s instanceof Bl){const e=s.parameters.anchorPosition;t[0]=2*(e[0]-.5),t[1]=2*(e[1]-.5)}else t[0]=0,t[1]=0;return t}(i);Vy[0]=a[0]/2*(t.normalizedOffset[0]-r[0]),Vy[1]=a[1]/2*(t.normalizedOffset[1]-r[1]),e.screenOffset[0]=Vy[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=Vy[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=Vy[1]}else e.hasLabelVerticalOffset||"center"===e.anchor||(Uy[i.labelClass.labelPlacement]&&Ay.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}(e,t,i,s);break;case"object":Ny(e,t,s)}}(e,t,i);break;case"polygon":!function(e,t,i){const r=Dy(i);if(!M(r))switch(r.type){case"extrude":{const r=i.graphics3DGraphic.layers[0];A(r)?(r.getBoundingBoxObjectSpace(zy),Zl(zy,e.translation),e.translation[2]=Kl(zy)/2):Pe(e.translation,0,0,0),Ny(e,t,r);break}}}(e,t,i);break;case"mesh":Ny(e,t,i.graphics3DGraphic.layers[0])}return e}({anchor:r,verticalOffset:t.verticalOffset,screenOffset:kr(),centerOffset:fr(0,0,0,-1),centerOffsetUnits:"world",translation:ve(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function Dy(e){const t=Ey(e.graphics3DGraphic.graphics3DSymbol);return A(t)?t.symbol.symbolLayers.getItemAt(0):null}function Iy(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function Ly(e){const t=e.graphics3DGraphic.graphic.geometry;if(M(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=Dy(e);return A(t)&&"extrude"===t.type?Uy["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return Uy["above-center"];default:return}}function Ny(e,t,i){const r=A(i)?i.getBoundingBoxObjectSpace(zy):zy,s=fe(r[3]-r[0],r[4]-r[1],r[5]-r[2]),a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=a/2*t.normalizedOffset[0];const n=e.translation[2],o=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=n+o;const l=Ce(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function Fy(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const Uy={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},jy={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in jy){const t=jy[e],i=Uy[e];t.forEach((e=>{Uy[e]=i}))}Object.freeze&&(Object.freeze(Uy),Object.keys(Uy).forEach((e=>{Object.freeze(Uy[e]),Object.freeze(Uy[e].normalizedOffset)})));const Vy=[0,0],ky=[0,0],zy=Yl();class qy{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}const Gy=4096;class Hy{constructor(){this.offset={x:0,y:0},this.uvMinMax=_r()}}class By{constructor(e,t){this.textId=e,this.textRenderer=t,this.placement=new Hy,this.rendered=!1}}let Wy=class extends Hi{constructor(e){super(e),this.type=Ys.Texture,this.id=rh(),this.events=new mr,this._glTexture=null,this._needsClear=!1,this._elementsToAddOrUpdate=new Map,this._elementsToRemove=new Map,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._stage=this.view._stage,this._canvas=this._create2DCanvas(),this._ctx=this._canvas.getContext("2d"),this._stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=F(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this._atlas.size.width}get height(){return this._atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,flipped:!0,samplingMode:_a.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return A(this._glTexture)||(this._glTexture=new Zn(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Vn.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=D(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=F(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",512..toString()),e.setAttribute("height",512..toString()),e}_update2DCanvasSize(){this._canvas.setAttribute("width",this._atlas.size.width.toString()),this._canvas.setAttribute("height",this._atlas.size.height.toString())}_createAtlasRegion(e=512){this._atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=Ki(i),i=Math.min(i,Gy),i}_resizeAtlas(e,t){t=t||e;const i=this._atlas;i.size.width=e,i.size.height=t,A(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this._atlas;e.cursor.x=$y,e.cursor.y=$y+Qy,e.lineHeight=0,this._needsClear=!0}_getAtlasUsage(){const e=this._atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this._elementsToRemove.size,t=this._elementsToAddOrUpdate.size,i=this._elements.size;return this._getAtlasUsage()/i*(i+t-e)}_addAtlasElement(e,t,i,r){const s=this._atlas,{renderedWidth:a,renderedHeight:n}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,Dr(e.placement.uvMinMax,e.placement.offset.x/s.size.width,1-(e.placement.offset.y+n)/s.size.height,(e.placement.offset.x+a)/s.size.width,1-e.placement.offset.y/s.size.height),s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this._elements.set(t,e)}_removeAtlasElement(e){if(e&&this._elements.has(e.textId)){const t=e.placement.offset;this._ctx.clearRect(t.x,t.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),this._elements.delete(e.textId)}}_ensureStageObjects(e){const t=this._stageObjects.get(e);if(t)return t;const i=new Set;return this._stageObjects.set(e,i),i}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const i=this._stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].setAttributeData(Gs.SIZE,[0,0]),t.geometryVertexAttrsUpdated(t.geometries[0]))}_processAddition(e,t){const i=this._atlas,r=e.textId,s=e.textRenderer.renderedWidth,a=e.textRenderer.renderedHeight,n=s+$y,o=a+$y+Qy;if(i.cursor.x+n<i.size.width&&i.cursor.y+o<i.size.height)this._addAtlasElement(e,r,n,o),this._elementsToRender.set(r,e),this._elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+o+i.lineHeight<i.size.height)){const e=this._getExpectedAtlasUsage(),r=e>.85&&i.size.width<Gy;return r&&this._resizeAtlas(2*i.size.width,2*i.size.height),!t||!r&&e>.95&&i.size.width===Gy?(this._processRemovals(),Xy.OK):(this._repack(),Xy.REPACK)}i.cursor.x=$y,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,r,n,o),this._elementsToRender.set(r,e),this._elementsToAddOrUpdate.delete(r)}return Xy.OK}_processRemovals(){this._elementsToRemove.forEach(((e,t)=>{const i=this._stageObjects.get(t);i&&0!==i.size||this._removeAtlasElement(e),i&&0===i.size&&this._stageObjects.delete(t)})),this._elementsToRemove.clear()}_repack(){this._processRemovals(),this._elements.forEach(((e,t)=>{e.rendered=!1,this._elementsToAddOrUpdate.set(t,e)})),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()}_processRenderingRequest(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);const t=this._stageObjects.get(e.textId);t&&t.forEach((t=>{t.geometries[0].setAttributeData(Gs.UV0,e.placement.uvMinMax),t.geometries[0].setAttributeData(Gs.SIZE,[e.textRenderer.displayWidth,e.textRenderer.displayHeight]),t.geometryVertexAttrsUpdated(t.geometries[0])})),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(M(this._glTexture))return kn.YIELD;let i=!1;if(me(this._elementsToAddOrUpdate,((r,s)=>{const a=this._elements.get(s);if(a?.rendered){const t=this._stageObjects.get(s);return t&&t.forEach((e=>{const t=e.geometries[0],i=this._elements.get(s);t.setAttributeData(Gs.UV0,i.placement.uvMinMax),t.setAttributeData(Gs.SIZE,[i.textRenderer.displayWidth,i.textRenderer.displayHeight]),e.geometryVertexAttrsUpdated(e.geometries[0])})),this._elementsToAddOrUpdate.delete(s),e.madeProgress(),!1}return this._processAddition(this._elementsToAddOrUpdate.get(s),t)===Xy.REPACK&&(i=!0,!0)})),i)return this.runTask(qn,!1),void e.madeProgress();let r=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),me(this._elementsToRender,((t,i)=>(this._processRenderingRequest(t),this._elementsToRender.delete(i),r=!0,e.madeProgress(),e.done))),r&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&yn.orderedRepackingEnabled&&(this.repackOrdered(),e.madeProgress())}addTextTexture(e,t){const i=e.key;this._elementsToAddOrUpdate.has(i)||this._elementsToAddOrUpdate.set(i,new By(i,e)),this._addStageObject(i,t),this._elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this._elementsToRemove.set(i,this._elements.get(i)),this._removeStageObject(i,t)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(0===this._elements.size)return;const e=[];this._elements.forEach(((t,i)=>e.push({element:t,key:i})));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this._elementsToRemove.size){e.sort(((e,t)=>e.key.localeCompare(t.key))),this._elements.clear();for(const{element:t,key:i}of e)this._elements.set(i,t);this._repack(),this.setDirty()}}get test(){const{_elements:e,_stageObjects:t,_elementsToRemove:i,_atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,resizeAtlas:(e,t)=>s._resizeAtlas(e,t),run:(e,t)=>s.runTask(e,t)}}};e([ce({constructOnly:!0})],Wy.prototype,"view",void 0),e([ce({type:Boolean})],Wy.prototype,"updating",void 0),Wy=e([ue("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Wy);const $y=2,Qy=2;var Xy;!function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"}(Xy||(Xy={}));class Yy{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}}class Zy{constructor(e,t,i,r,s){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=r,this.labelFunction=s,this.calloutSymbolLayerIndex=0}}class Ky{constructor(e,t,i,r,s,a,n){this.layer=e,this.graphics3DCore=t,this.scaleVisibility=i,this.emptySymbolLabelSupported=r,this.elevationInfoOverride=s,this.disablePlacement=a,this.active=n,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new nh({pickable:!0,disableOctree:!0},e.uid)}}let Jy=class extends Hi{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new R,this._handles.add([G((()=>this.view.state?.camera),(()=>this.setDirty())),G((()=>this.view.state?.rasterPixelRatio),(()=>this._resetAllLabels())),this.view.resourceController.scheduler.registerTask(Vn.LABELER,this)]),this._textTextureAtlas=new Wy({view:this.view}),this._hudMaterialCollection=new qy(this.view._stage),this._calloutMaterialCollection=new qy(this.view._stage)}dispose(){this._handles=I(this._handles),this._textTextureAtlas=F(this._textTextureAtlas),this._hudMaterialCollection=F(this._hudMaterialCollection),this._calloutMaterialCollection=F(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.graphics.forEach(((t,i)=>{const r=new Yy(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r),t.setVisibilityFlag(Al.USER_SETTING,!0,El.LABEL)})),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach(((e,t)=>{e.setVisibilityFlag(Al.USER_SETTING,!1,El.LABEL),this.setLabelGraphicVisibility(e,!1),this._labels.delete(t)})),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];A(i)&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const i=e.textRenderers[t._labelIndex];A(i)&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),kn.YIELD}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(!tv(t)){if(iv(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),ev(t)){this._dirty=!0;continue}if(!tv(t))continue}me(t.labelsToInitialize,((i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done)))&&(this._dirty=!0)}this._labelsToRemove.forEach((e=>this._removeLabelTextureFromAtlas(e))),this._labelsToAdd.forEach((e=>this._addLabelTextureToAtlas(e))),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController?.signal;await(e.layer.when?.()),p(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter((e=>!!e.symbol));if(!s||0===s.length)return;let a=!1;await zi(s,(async(r,s)=>{const n=r.symbol,o=Ey(i.getOrCreateGraphics3DSymbol(n));if(M(o))return void E.getLogger(this.declaredClass).error("Failed to create Graphics3DSymbol for label");await o.load(),p(t);let l=null;Xl(n)&&n.hasVisibleCallout()&&(l=zl(n,i.symbolCreationContext),await l.load(),p(t));const h=await qi(Ql(r,e.layer.fieldsIndex,this.view.spatialReference));if(p(t),!0===h.ok){const i=await this._createTextRenderParameters(o.symbol);p(t),e.labelClassContexts[s]=new Zy(r,o,l,i,h.value)}else E.getLogger(this.declaredClass).error(`Label expression failed to evaluate: ${h.error}`),a=!0})),p(t)}async _createLabelClassContext(e){return M(e.labelClassPromise)&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch((t=>{if(d(t))throw t;e.labelClassContexts.length=0})).then((()=>{e.labelClassAbortController=null,this.notifyChange("updating")})).catch((()=>{})),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&"text"===t.type?Il.fromSymbol(t,this.view.state.rasterPixelRatio):null}_destroyLabelClassContext(e){for(const t of e.labelClassContexts)--t.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,L(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s){const a=new Ll(i.verticalOffset,Nl(i.anchor),Fl(i.anchor),e.text,i.translation,i.elevationOffset,i.centerOffset,i.screenOffset,i.centerOffsetUnits,e.displayWidth,e.displayHeight);return sv.graphic=t,sv.renderingInfo=null,sv.layer=r,s.createLabel(sv,a,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,i,r,s){return sv.graphic=e,sv.layer=s,sv.renderingInfo=new Ul(null,t,r.translation,r.centerOffset,r.screenOffset,r.centerOffsetUnits,r.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(sv)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,r=i.labelClassContexts;if(!r||0===r.length||!i.emptySymbolLabelSupported&&0===t.layers.length)return!1;let s=!1;const a=t.graphic,n=i.layer,o=rv(i.layer),l=this.view._stage;for(let h=0;h<r.length;h++){const c=e.textRenderers[h],d=e.textLabelPlacements[h];if(M(c)||M(d))continue;const u=r[h],p=u.graphics3DSymbol,m=p.symbol&&"label-3d"===p.symbol.type?p.symbol:null,_=p.symbolLayers[0];if(!_)continue;_.setElevationInfoOverride(i.elevationInfoOverride);const g=this._createTextSymbolGraphic(c,a,d,n,_);if(M(g))return!1;g._labelClass=u.labelClass,g._labelIndex=h,t.addLabelGraphic(g,l,i.stageLayer),t.setVisibilityFlag(Al.USER_SETTING,o,El.LABEL),t.clearVisibilityFlag(Al.SCALE_RANGE,El.LABEL),t.setVisibilityFlag(Al.DECONFLICTION,!1,El.LABEL),s=!0;const f=u.graphics3DCalloutSymbolLayer;if(f&&d.hasLabelVerticalOffset){f.setElevationInfoOverride(i.elevationInfoOverride);const e=this._createLineCalloutGraphic(a,m,f,d,n);A(e)&&(u.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(e,l,i.stageLayer))}break}return i.scaleVisibility&&s&&i.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(null==i._labelClass)continue;const e=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];null!=e&&e.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const t=e.labelingContext,i=t.labelClassContexts;if(!i||0===i.length)return;const r=e.graphics3DGraphic.graphic;for(let s=0;s<i.length;s++){const a=i[s];if(e.textRenderers[s]=null,e.textLabelPlacements[s]=null,!a.textRenderParameters)continue;const n=a.labelFunction;let o;if("arcade"===n.type)try{const e=n.needsHydrationToEvaluate()?$l(r,t.layer):r;o=n.evaluate(e)}catch(e){o=null}else o=n.evaluate(r);if(M(o)||""===o||/^\s+$/.test(o))continue;const l=a.graphics3DSymbol,h="label-3d"===l.symbol?.type?l.symbol:null;if(!l.symbolLayers[0])continue;const c=My({graphics3DGraphic:e.graphics3DGraphic,labelSymbol:h,labelClass:a.labelClass,disablePlacement:t.disablePlacement});if(M(c))continue;const d=Nl(c.anchor),u=jl(d);e.textRenderers[s]=new Vl(o,u,a.textRenderParameters),e.textLabelPlacements[s]=c}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const i=t.graphic.uid;if(e.graphics.set(i,t),e.active){const r=new Yy(e,t);this._labels.set(i,r),e.labelsToInitialize.set(i,r)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=this._labels.get(i);e.graphics.delete(i),r&&(this._destroyGraphic(r,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const t=e.graphics.get(i);t&&(this._removeGraphic(e,t),this._addGraphic(e,t))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.graphics.forEach((e=>r.set(e.graphic.uid,e)));const s=e=>e.labelLayers[0];if(k(i.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const t=e=>e.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,t)}}}_visibilityInfoChange(e){const t=rv(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach(((t,i)=>{const r=this._labels.get(i);r&&(this._destroyGraphic(r,i),r.visible=!1,r.rendered=!1,e.labelsToInitialize.set(i,r))})),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,a=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const n=e.layer,o=new Ky(n,e,t,r,s,a,rv(n));return this.view._stage.add(o.stageLayer),this._labelingContexts.push(o),this.setDirty(),{addGraphic:e=>this._addGraphic(o,e),removeGraphic:e=>this._removeGraphic(o,e),featureReductionChange:()=>{},layerLabelsEnabled:()=>rv(o.layer),labelingInfoChange:e=>this._labelingInfoChange(o,e),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",o),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",o),visibilityInfoChange:()=>this._visibilityInfoChange(o),reset:()=>this._resetLabels(o),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.graphics.forEach((e=>this._removeGraphic(t,e))),this.view._stage.remove(t.stageLayer),this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.textInitialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some((e=>ev(e)))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce(((e,t)=>e+(ev(t)?0:1)),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function ev(e){return!!e.labelClassPromise&&!!e.labelClassAbortController}function tv(e){return e.labelClassContexts&&e.labelClassContexts.length}function iv(e){return null===e.labelClassContexts}function rv(e){return!0===e.labelsVisible&&!!e.labelingInfo?.some((e=>!!e.symbol))}e([ce({constructOnly:!0})],Jy.prototype,"view",void 0),e([ce({constructOnly:!0})],Jy.prototype,"deconflictor",void 0),e([ce()],Jy.prototype,"_textTextureAtlas",void 0),e([ce({type:Boolean,readOnly:!0})],Jy.prototype,"updating",null),Jy=e([ue("esri.views.3d.layers.graphics.Labeler")],Jy);const sv=new kl(null,null,null);class av{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustum=new hi(e),this._extendedFrustum=new hi(e),this._intersector=new ql({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)}end(){this._cache.clear()}calculate(e){if(this._allTilesInvisible)return dh.INVISIBLE;const t=this._renderCoordsHelper.viewingMode===Ui.Global&&e.lij[0]>=nv&&e.lij[0]<ov,i=this._getOrCalculateSingleTileVisibility(e,!t);return i!==dh.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):i}_shortenFrustumFarPlane(e){const t=hi.nearFarLineIndices,i=e.mutablePoints;for(const e of t){const[t,r]=e,s=i[t],a=i[r];Ie(dv,a,s),Te(dv,dv,hv),Oe(i[r],s,dv)}e.updatePoints(i)}_calculateAggregatedChildrenVisibility(e){let t=dh.INVISIBLE;const i=this._cache.get(e.id);if(null!=i)return i;const r=mv.acquire();e.getChildren(r);for(const e of r){const i=this.calculate(e);if(i!==dh.INVISIBLE&&(t=i,i===dh.VISIBLE_ON_SURFACE))break}return mv.release(r),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const i=this._cache.get(e.id);if(null!=i)return i;const r=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,r),r}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===Ui.Global&&e.lij[0]<lv?this._calculateSingleTileVisibilitySided(e,!1)===dh.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_calculateSingleTileVisibilitySided(e,t){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);const i=br(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,i)?this._intersector.isVisibleInFrustum(this._frustum,i,!0)?dh.VISIBLE_ON_SURFACE:dh.VISIBLE_WHEN_EXTENDED:dh.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,dv);this._aboveGround||Fe(t,t);const i=Yi(-xe(t,e.viewForward));if(this._allTilesInvisible=i>(Math.PI+e.fovY)/2,this._allTilesInvisible)return;if(this._hasExtendedFrustum=i>e.fovY/2,!this._hasExtendedFrustum)return;const r=this._extendedFrustumParameters(),s=this._extendedFrustum.mutablePoints;for(let e=0;e<4;e++){const t=r.pointIndices[e],i=s[t],a=this._renderCoordsHelper.getAltitude(i);if(r.needsAltitudeAdjustment(a)){switch(this._renderCoordsHelper.worldUpAtPosition(i,dv),t){case uh.FAR_BOTTOM_LEFT:case uh.FAR_TOP_LEFT:case uh.NEAR_BOTTOM_LEFT:case uh.NEAR_TOP_LEFT:Jo(this._extendedFrustum.planes[ph.LEFT],dv,dv);break;case uh.FAR_BOTTOM_RIGHT:case uh.FAR_TOP_RIGHT:case uh.NEAR_BOTTOM_RIGHT:case uh.NEAR_TOP_RIGHT:Jo(this._extendedFrustum.planes[ph.RIGHT],dv,dv)}Te(dv,dv,r.direction),this._renderCoordsHelper.intersectInfiniteManifold(Bo(i,dv),r.zWithMargin,i)}}if(this._extendedFrustum.updatePoints(s),el(s[uh.NEAR_BOTTOM_LEFT],s[uh.NEAR_BOTTOM_RIGHT],s[uh.NEAR_TOP_RIGHT],uv),el(s[uh.NEAR_BOTTOM_RIGHT],s[uh.NEAR_TOP_RIGHT],s[uh.NEAR_TOP_LEFT],pv),xe(Yo(uv),Yo(pv))<0){const e=this._extendedFrustum.mutablePoints;this._aboveGround?[e[uh.NEAR_BOTTOM_LEFT],e[uh.NEAR_BOTTOM_RIGHT]]=[e[uh.NEAR_BOTTOM_RIGHT],e[uh.NEAR_BOTTOM_LEFT]]:[e[uh.NEAR_TOP_LEFT],e[uh.NEAR_TOP_RIGHT]]=[e[uh.NEAR_TOP_RIGHT],e[uh.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(e)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-cv;return{zWithMargin:e,pointIndices:hi.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+cv;return{zWithMargin:e,pointIndices:hi.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}}const nv=2,ov=6,lv=12,hv=.95,cv=1,dv=ve(),uv=Wo(),pv=Wo(),mv=new vh(Array,(e=>{4!==e.length&&(e[0]=new ch,e[1]=new ch,e[2]=new ch,e[3]=new ch)}),(e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()}));class _v{constructor(e){this._camera=new al,this._focusOnMap=[0,0],this._screenRect=at(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new av(e.renderCoordsHelper)}begin(e,t,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,ut(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=pt(e.extent,this._focusOnMap),e.measures.visibility!==dh.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=fv,i=1<<t,r=e.measures.screenRect;nt(r);let s=0;const a=e.lij[0]+t,n=e.lij[1]<<t,o=e.lij[2]<<t,l=this._tileSizeWithBias(e),h=l*l;for(let t=0;t<i;t++)for(let l=0;l<i;l++)if(s+=this._computeScreenArea(e,a,n+t,o+l,r),s>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===dh.VISIBLE_WHEN_EXTENDED?this._tileSize*yv:this._tileSize}_computeScreenArea(e,t,i,r,s){const a=e.measures.visibility===dh.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,i,r,a,vv),nt(gv);for(let e=0;e<4;e++)mt(gv,vv[e]);return ct(s,gv,s),yh(vv[0],vv[1],vv[2])+yh(vv[0],vv[2],vv[3])}_projectToScreen(e,t,i,r,s){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,t,i,bv),this._toRenderCoords(bv,0,3,Tv[0]),this._toRenderCoords(bv,2,3,Tv[1]),this._toRenderCoords(bv,2,1,Tv[2]),this._toRenderCoords(bv,0,1,Tv[3]),r&&(this._projectToPlane(Tv,this._camera.frustum[ph.NEAR]),this._projectToPlane(Tv,this._camera.frustum[ph.TOP]),this._projectToPlane(Tv,this._camera.frustum[ph.BOTTOM]));for(let e=0;e<4;e++)this._camera.projectToRenderScreen(Tv[e],Cv),this._camera.renderToScreen(Cv,s[e])}_projectToPlane(e,t){for(let i=0;i<4;i++)wv[i]=tl(t,e[i]);const i=Math.max(wv[0],wv[1],wv[2],wv[3]);if(i>0){const r=Te(xv,Yo(t),-i);for(let t=0;t<4;t++)Oe(e[t],e[t],r)}}_toRenderCoords(e,t,i,r){return xv[0]=e[t],xv[1]=e[i],xv[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(xv,this._tilingScheme.spatialReference,r),r}}const gv=at(),fv=2,yv=5,vv=[re(),re(),re(),re()],bv=at(),xv=ve(),Tv=[ve(),ve(),ve(),ve()],wv=[0,0,0,0],Cv=ae();let Sv=class extends Hi{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(A(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void E.getLogger(this.declaredClass).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||A(t)&&e&&t.equals(e))return;const i=A(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(M(this.filterExtent))return null;const e=at();return Gl(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new s,this.tileSize=512,this._idToTile=new Map,this._handles=new R,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new J}initialize(){this._handles.add([G((()=>[this.tilingScheme,this.tileSize]),(()=>this._reset()),$),G((()=>[this.tileSize,this.cameraOnSurface?.location,this.tilingScheme,this.viewState?.contentCamera,this.focus?.location]),(()=>this._setDirty()),B)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(Vn.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=D(this._frameWorker),this._handles=I(this._handles)}addClient(){const e=Pv++;return this._clients.add(e),1===this._clients.size&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(qn))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),A(this._frameWorker)&&(this._frameWorker.priority=Vn.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&A(this._frameWorker)&&(this._frameWorker.priority=Vn.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new _v({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map((t=>new ch(t[0],t[1],t[2],e)))}_purgeHorizonTiles(e){e.sort(((e,t)=>{const i=e.measures.screenRect,r=t.measures.screenRect;return i[1]+i[3]-(r[1]+r[3])})),nt(Rv);for(let t=0;t<e.length;t++)if(ct(Rv,e.data[t].measures.screenRect,Rv),ht(Rv)>Ov)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!dt(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==dh.INVISIBLE&&(i.measures.shouldSplit?(t.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)))}0===this._pendingTiles.length&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const e of this.tiles.items)e.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===dh.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};e([ce({constructOnly:!0})],Sv.prototype,"scheduler",void 0),e([ce({constructOnly:!0})],Sv.prototype,"renderCoordsHelper",void 0),e([ce({constructOnly:!0})],Sv.prototype,"tilingSchemeOwner",void 0),e([ce({constructOnly:!0})],Sv.prototype,"cameraOnSurface",void 0),e([ce({constructOnly:!0})],Sv.prototype,"focus",void 0),e([ce({constructOnly:!0})],Sv.prototype,"viewState",void 0),e([ce({constructOnly:!0})],Sv.prototype,"terrain",void 0),e([ce()],Sv.prototype,"tiles",void 0),e([ce()],Sv.prototype,"tileSize",void 0),e([ce({readOnly:!0})],Sv.prototype,"tilingScheme",null),e([ce()],Sv.prototype,"filterExtent",null),e([ce({readOnly:!0})],Sv.prototype,"_filterExtentRect",null),e([ce({readOnly:!0})],Sv.prototype,"_rootTileIds",null),e([ce({value:!1})],Sv.prototype,"suspended",null),e([ce({readOnly:!0})],Sv.prototype,"updating",null),Sv=e([ue("esri.views.3d.layers.support.FeatureTileTree3D")],Sv);let Pv=0;const Rv=at(),Ov=10;let Ev=class extends Hi{constructor(){super(...arguments),this._propertiesPool=new bh({camera:al},this),this._lastSeenCameraProjectionValues=new al,this.mode=zn.ANIMATING,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new mr,this.viewingMode=Ui.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new rp({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new bh({camera:al},this)}createInitialCamera(){if(this.viewingMode===Ui.Global){const e=br(this.spatialReference).radius;this.camera=new al({eye:fe(4*e,0,0),center:fe(e,0,0),up:fe(0,0,1)})}else this.camera=new al({eye:fe(0,0,100),center:fe(0,0,0),up:fe(0,1,0)})}get animation(){return this.cameraController instanceof li&&A(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==Mv&&Mv.copyFrom(e),Mv.computeUp(this.viewingMode),this.events.emit("before-camera-change",Mv);const t=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Mv)&&(this._lastSeenCameraProjectionValues.copyFrom(Mv),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),(!t||!t.equals(Mv))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(Mv)),this._cameraChanged=!t||!t.almostEquals(Mv),this._cameraChanged)){const e=sh((()=>{this._cameraChanged=!1,e.remove()}))}}get pixelRatio(){return this.camera.pixelRatio}get contentCamera(){return j(this._contentCamera,this.camera)}set contentCamera(e){this._contentCamera=A(e)?e.clone():null}get fixedContentCamera(){return A(this._contentCamera)}get isGlobal(){return this.viewingMode===Ui.Global}get isLocal(){return this.viewingMode===Ui.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(this.removeHandles(Dv),this.addHandles(W((()=>e.state===ai.Finished||e.state===ai.Stopped),(()=>{this._set("cameraController",null),this.updateCamera((t=>e.onControllerEnd(t)))}),{sync:!0,once:!0}),Dv),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ai.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==ai.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Mv.copyFrom(this._get("camera")),e(Mv),this.camera=Mv,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[nl.TOP]!==t.padding[nl.TOP]||e.padding[nl.RIGHT]!==t.padding[nl.RIGHT]||e.padding[nl.BOTTOM]!==t.padding[nl.BOTTOM]||e.padding[nl.LEFT]!==t.padding[nl.LEFT]}};e([ce()],Ev.prototype,"mode",void 0),e([ce({readOnly:!0,type:Fi})],Ev.prototype,"animation",null),e([ce({type:al})],Ev.prototype,"camera",null),e([ce({readOnly:!0})],Ev.prototype,"pixelRatio",null),e([ce()],Ev.prototype,"rasterPixelRatio",void 0),e([ce()],Ev.prototype,"contentPixelRatio",void 0),e([ce({})],Ev.prototype,"_contentCamera",void 0),e([ce({type:al})],Ev.prototype,"contentCamera",null),e([ce({readOnly:!0})],Ev.prototype,"fixedContentCamera",null),e([ce({readOnly:!0})],Ev.prototype,"constraints",void 0),e([ce({readOnly:!0})],Ev.prototype,"events",void 0),e([ce({readOnly:!0})],Ev.prototype,"isGlobal",null),e([ce({readOnly:!0})],Ev.prototype,"isLocal",null),e([ce({readOnly:!0})],Ev.prototype,"viewingMode",void 0),e([ce({readOnly:!0})],Ev.prototype,"spatialReference",void 0),e([ce()],Ev.prototype,"navigating",null),e([ce()],Ev.prototype,"stationary",null),e([ce()],Ev.prototype,"_cameraChanged",void 0),e([ce()],Ev.prototype,"cameraController",null),Ev=e([ue("esri.views.3d.state.ViewState")],Ev);const Av=Ev,Mv=new al,Dv="ViewStateHandles";class Iv{constructor(e,t,i){this.viewingMode=e,this._forEachLayer=t,this._view=i,this._externalIntersectionHandlers=new J,this._tolerance=dl,this._tmpRay=qo(),this._tmpRegion=at(),this._validateHUDIntersector=cl(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),jv(this.viewingMode),t,i)}intersectScreenFreePointFallback(e,t,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,i)}intersectRayFreePointFallback(e,t,i){return this.intersectRay(e,jv(this.viewingMode),t,i)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,i,r){return t.options.selectionMode=!1,t.options.store=ul.MIN,this.computeIntersection(e,t,r),!!t.results.min&&t.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,t,i=.5,r=.5){return e.getRenderCenter(qv,i,r),qv[0]+=.0466,qv[1]-=.0123,sl(e,qv,t)}intersectIntersectorScreen(e,t,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,i)}intersectToolIntersectorScreen(e,t,i){const r=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(r,t,i)}intersectToolIntersectorRay(e,t,i){t.options.selectionMode=!0,this.computeIntersection(e,t,i);const r=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||pl(r)&&r.intersector!==ml.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,i))}setTolerance(e=dl){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort(((e,t)=>e.type===ml.TERRAIN?1:t.type===ml.TERRAIN?-1:0))}removeIntersectionHandler(e){null!=this._externalIntersectionHandlers.removeUnordered(e)&&this._externalIntersectionHandlers.sort(((e,t)=>e.type===ml.TERRAIN?1:t.type===ml.TERRAIN?-1:0))}_getPickRay(e,t){const i=this._view.state.camera;return rl(i,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==Ui.Local||M(e)||Oe(t,e.origin,be(Ho.get(),e.direction)),!1}intersectElevationFromScreen(e,t,i=0,r=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,i,r)}_intersectElevation(e,t,i=0,r=null){if(M(e))return null;const s=A(t)?t.mode:"absolute-height",a=A(t)?j(t.offset,0):0,n="on-the-ground"!==s?a+i:0,o=n/this._view.renderCoordsHelper.unitInMeters;if("absolute-height"===s){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,n,zv)){const e=this._view.computeMapPointFromVec3d(zv);return e.z??(e.z=0),e.z-=a,e}return null}const l=this._view.state.camera,h=ne(Ho.get());l.projectToRenderScreen(e.origin,h);const c=new Vv(null,this._forEachLayer),d=this._view.slicePlane,u=A(d)?_l(d):null,p=cl(this.viewingMode);p.options.store=ul.MIN,p.options.verticalOffset=o;const m=e.origin,_=Oe(Ho.get(),m,e.direction);p.reset(m,_,l),p.point=h;const g=A(r)?"type"in r&&"graphics"===r.type?e=>e.metadata?.layerUid!==r.uid:e=>e.metadata?.graphicUid!==r.uid:null;switch(s){case"relative-to-scene":{const e=e=>(M(g)||g(e))&&!!e.metadata?.isElevationSource;p.intersect(c.layers,h,this._tolerance,null,e),this._externalIntersectionHandlers.forAll((e=>{if(e.type===ml.I3S||e.type===ml.TERRAIN){const t=e.slicePlaneEnabled?u:null;e.intersect(p,t,p.rayBegin,p.rayEnd,h)}}));break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll((e=>{if(e.isGround){const t=e.slicePlaneEnabled?u:null;e.intersect(p,t,p.rayBegin,p.rayEnd,h)}}))}if(p.results.min.getIntersectionPoint(zv)){const e=this._view.computeMapPointFromVec3d(zv);return e.z=i,e}return null}computeIntersection(e,t,i){if(M(e))return;const r=this._view.state.camera,s=ne(Ho.get());r.projectToRenderScreen(e.origin,s);const a=new Vv(i,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const n=e.origin,o=Oe(Ho.get(),e.origin,e.direction);t.reset(n,o,r),t.intersect(a.layers,s,this._tolerance);const l=this._view.slicePlane,h=A(l)?_l(l):null;t.intersect(a.sliceableLayers,s,this._tolerance,h);const c=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll((e=>{const i=e.layerUid,r=Array.isArray(i),l=r?i:[i];r&&(t.options.filteredLayerUids=[]);let d=!1;for(const e of l)a.filterLayerUid(e)?d=!0:r&&t.options.filteredLayerUids.push(e);if(t.options.isFiltered=!d,e.isGround&&c||!t.options.isFiltered){const i=e.slicePlaneEnabled?h:null;e.intersect(t,i,n,o,s)}}));const d=Ho.get(),u=this._view.basemapTerrain;if(i&&i.enableDraped&&A(u.spatialReference)&&t.results.ground.getIntersectionPoint(d)){const e=u.overlayManager.renderer,i=this._view.renderCoordsHelper.spatialReference,r=Ho.get();this._view.renderCoordsHelper.fromRenderCoords(d,r,u.spatialReference),r[2]=j(this._view.elevationProvider?.getElevation(d[0],d[1],d[2],i,"ground"),0),e.intersect(t,r,t.results.ground,(e=>a.filterRenderGeometry(e)))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;_t(this._tmpRegion,gt);const i=this._view.state.camera,r=[],s=this._tmpRegion,a=e=>{const t=new Fv(e);i.projectToRenderScreen(e.target.center,t.screenPoint),t.screenPoint[0]=Math.floor(t.screenPoint[0]),t.screenPoint[1]=Math.floor(t.screenPoint[1]),r.push(t),mt(s,t.screenPoint)};e.sortResults(t.all),A(t.min.dist)&&a(t.min);for(const e of t.all)t.min.target.object!==e.target.object&&t.max.target.object!==e.target.object&&a(e);if(A(t.max.dist)&&t.max.target.object!==t.min.target.object&&a(t.max),!r.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);const n=i.fullWidth,o=i.fullHeight,l=Math.max(0,s[0]-Lv),h=Math.max(0,s[1]-Lv),c=Math.min(lt(s)+2*Lv,n-l),d=Math.min(ht(s)+2*Lv,o-h),u=new Uint8Array(c*d*4);this._view._stage.renderer.readHUDVisibility(l,h,c,d,u);let p=!0;const m=M(e.results.max.dist);let _=0;for(const t of r)for(const i of Nv)if(u[4*(Math.min(t.screenPoint[0]+i[0],n)-s[0]+(Math.min(t.screenPoint[1]+i[1],o)-s[1])*c)]){p&&(e.results.min.copy(t.result),p=!1),m&&e.results.max.copy(t.result),e.options.store===ul.ALL&&e.results.all.splice(_++,0,t.result);break}}}const Lv=1,Nv=(()=>{const e=[],t=Lv;for(let i=-t;i<=t;i++)for(let r=-t;r<=t;r++)e.push([r+t,i+t]);return e})();class Fv{constructor(e){this.result=e,this.screenPoint=ae()}}let Uv;function jv(e){return Uv&&Uv.viewingMode===e||(Uv=cl(e)),Uv}class Vv{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,t((e=>{e.pickable&&this.filterLayerUid(e.apiLayerUid)&&(e.sliceable?this.sliceableLayers:this.layers).push(e)}))}filterLayerUid(e){const{include:t,exclude:i}=this;return M(e)?null==t&&null==i:(null==t||t.has(e))&&(null==i||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}}function kv(e){return"object"==typeof e&&"intersect"in e}const zv=ve(),qv=ae();let Gv=class extends(mr.EventedMixin(Hi)){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this._handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQueryCached=I(this._elevationQueryCached)}get _elevationQuery(){return M(this._elevationQueryCached)&&(this._elevationQueryCached=new Hl(this.view.resourceController.scheduler,this.view.spatialReference,(()=>this.view.map&&this.view.map.ground),{maximumAutoTileRequests:4})),this._elevationQueryCached}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,i,r,s){if(this.elevationCacheEnabled&&null!=this.lastElevationQuery){const a=this.lastElevationQuery;if(e===a.x&&t===a.y&&i===a.z&&Cr(r,a.spatialReference)&&s===a.queryContext)return a.result}let a=null;return a=Hv(a,this._im,e,t,i,r,s),M(a)&&(a=Hv(a,this._ground,e,t,i,r,s)),"scene"===s&&(a=Hv(a,this._scene,e,t,i,r,s)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:a}),a}getSphereElevationBounds(e,t){let i=1/0,r=-1/0;for(const s of[this._im,this._ground,this._scene])s.forEach((s=>{if(s.getSphereElevationBounds){const a=s.getSphereElevationBounds(e,t);A(a)&&(i=Math.min(i,a.min),r=Math.max(r,a.max))}}));return{min:i,max:r}}queryElevation(e,t,i,r,s,a=null,n=0){const o=c();return this._elevationQuery.queryElevation(e,t,a,n).then((a=>{"scene"===s&&(a=Hv(a,this._scene,e,t,i,r,s)),o.resolve(a)})).catch((a=>{d(a)?o.reject(a):o.resolve(this.getElevation(e,t,i,r,s))})),o.promise}register(e,t){this._handles.set(t,t.on("elevation-change",(e=>this.emit("elevation-change",e)))),this._providersFromContext(e).push(t)}unregister(e){this._handles.has(e)&&(this._handles.get(e)?.remove(),this._handles.delete(e));for(const t of[this._im,this._ground,this._scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}};function Hv(e,t,i,r,s,a,n){for(const o of t){const t=o.getElevation(i,r,s,a,n);A(t)&&(e=A(e)?Math.max(t,e):t)}return e}e([ce({constructOnly:!0})],Gv.prototype,"view",void 0),e([ce()],Gv.prototype,"spatialReference",null),Gv=e([ue("esri.views.3d.support.CombinedElevationProvider")],Gv);class Bv{static isValidProfile(e){return e in Bv.profiles}static getDefaultProfile(){return b("esri-iPhone")?"low":"medium"}static apply(e,t){const i=Bv.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,t.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const r=t.sceneService.object,s=i.sceneService.object;r.lodFactor=s.lodFactor,r.lodCrossfadeinDuration=s.lodCrossfadeinDuration,r.lodCrossfadeoutDuration=s.lodCrossfadeoutDuration,r.lodCrossfadeUncoveredDuration=s.lodCrossfadeUncoveredDuration,t.sceneService.point.lodFactor=i.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=i.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,t.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,t.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,t.heatmap.pixelRatio=i.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=i.fadeDuration,t.antialiasingEnabled=i.antialiasingEnabled,t.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,t.highQualityTransparency=i.highQualityTransparency,t.memoryLimit=i.memoryLimit,t.additionalCacheMemory=i.additionalCacheMemory,t.frameRate=i.frameRate,t.maximumPixelRatio=i.maximumPixelRatio}}function Wv(){const e=!!b("esri-mobile"),t=!!b("ios"),i=K(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{object:{lodFactor:.2,lodCrossfadeinDuration:K(0),lodCrossfadeoutDuration:K(0),lodCrossfadeUncoveredDuration:K(0)},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:K(0)},fadeDuration:K(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:K(0),lodCrossfadeoutDuration:K(0),lodCrossfadeUncoveredDuration:i},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!b("disable-feature:reduce-map-tile-levels"),textureFadeDuration:i},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:K(0),lodCrossfadeoutDuration:K(0),lodCrossfadeUncoveredDuration:i},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!b("disable-feature:reduce-map-tile-levels"),textureFadeDuration:i},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}Bv.test={reset(){const e=Wv();for(const t in e)Bv.profiles[t]=e[t]}},function(e){e.profiles=Wv()}(Bv||(Bv={}));const $v=Bv,Qv=new pr([0,255,255]),Xv=new pr([0,0,0]);let Yv=class extends Hi{constructor(){super(...arguments),this.color=Qv.clone(),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=Xv.clone(),this.shadowDifference=.2}static toEngineOptions(e){const t=pr.toUnitRGBA(e.color??Qv),i=A(e.haloColor)?pr.toUnitRGBA(e.haloColor):t,r=pr.toUnitRGBA(e.shadowColor??Xv),s=e.haloOpacity??1,a=e.fillOpacity??.25,n=e.shadowOpacity??.4,o=e.shadowDifference??.2;return{color:Th(t[0],t[1],t[2],t[3]),haloColor:Th(i[0],i[1],i[2],i[3]),haloOpacity:s,haloOpacityOccluded:.25*s,fillOpacity:a,fillOpacityOccluded:.25*a,shadowOpacity:n,shadowColor:fr(r[0],r[1],r[2],r[3]),occludedShadowOpacity:n*(1-o)}}};e([ce({type:pr})],Yv.prototype,"color",void 0),e([ce({type:pr})],Yv.prototype,"haloColor",void 0),e([ce()],Yv.prototype,"haloOpacity",void 0),e([ce()],Yv.prototype,"fillOpacity",void 0),e([ce()],Yv.prototype,"shadowOpacity",void 0),e([ce({type:pr})],Yv.prototype,"shadowColor",void 0),e([ce()],Yv.prototype,"shadowDifference",void 0),Yv=e([ue("esri.views.3d.support.HighlightOptions")],Yv);const Zv=Yv;class Kv{constructor(e,t){this.spatialReference=t,this.unitInMeters=Sr(this.spatialReference,br(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=wh(e&&e.get("portalItem")).catch((()=>{throw new o("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")}))}async toGeographic(e){const t=await this._geometryServiceURLPromise;let i,r=!0;Array.isArray(e[0])&&"number"!=typeof e[0]?i=e:(i=[e],r=!1);const s=i.map((e=>e instanceof Ph?e:new Ph(e,this.spatialReference))),a=new Sh({geometries:s,outSpatialReference:Rh.WGS84}),n=(await Ch(t,a)).map((e=>"point"===e.type?[e.x,e.y]:void 0)).filter((e=>!!e));return r?n:n[0]}}let Jv=class extends Hi{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};e([ce()],Jv.prototype,"minTotalNumberOfFeatures",void 0),e([ce()],Jv.prototype,"maxTotalNumberOfFeatures",void 0),e([ce()],Jv.prototype,"maxTotalNumberOfPrimitives",void 0),e([ce()],Jv.prototype,"snapshotAvailable",void 0),e([ce()],Jv.prototype,"polygonLodFactor",void 0),e([ce()],Jv.prototype,"polylineLodFactor",void 0),e([ce()],Jv.prototype,"skipHighSymbolLods",void 0),Jv=e([ue("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Jv);let eb=class extends Hi{constructor(){super(...arguments),this.lodFactor=1}};e([ce()],eb.prototype,"lodFactor",void 0),eb=e([ue("esri.views.3d.support.QualitySettings.LoDFactorSettings")],eb);let tb=class extends eb{constructor(){super(...arguments),this.lodCrossfadeinDuration=K(0),this.lodCrossfadeoutDuration=K(0),this.lodCrossfadeUncoveredDuration=K(0)}};tb=e([ue("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],tb);let ib=class extends Hi{constructor(){super(...arguments),this.object=new tb,this.point=new eb,this.integratedMesh=new eb,this.pointCloud=new eb,this.uncompressedTextureDownsamplingEnabled=!1}};e([ce({type:tb})],ib.prototype,"object",void 0),e([ce({type:eb})],ib.prototype,"point",void 0),e([ce({type:eb})],ib.prototype,"integratedMesh",void 0),e([ce({type:eb})],ib.prototype,"pointCloud",void 0),e([ce()],ib.prototype,"uncompressedTextureDownsamplingEnabled",void 0),ib=e([ue("esri.views.3d.support.QualitySettings.SceneServiceSettings")],ib);let rb=class extends Hi{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=K(400)}};e([ce()],rb.prototype,"lodBias",void 0),e([ce()],rb.prototype,"angledSplitBias",void 0),e([ce()],rb.prototype,"reduceTileLevelDifferences",void 0),e([ce()],rb.prototype,"textureFadeDuration",void 0),rb=e([ue("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],rb);let sb=class extends Hi{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};e([ce()],sb.prototype,"pixelRatio",void 0),e([ce()],sb.prototype,"maxTotalNumberOfFeatures",void 0),sb=e([ue("esri.views.3d.support.QualitySettings.HeatmapSettings")],sb);let ab=class extends Hi{constructor(){super(...arguments),this.graphics3D=new Jv,this.sceneService=new ib,this.tiledSurface=new rb,this.heatmap=new sb,this.fadeDuration=K(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.memoryLimit=void 0,this.additionalCacheMemory=void 0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};e([ce({type:Jv})],ab.prototype,"graphics3D",void 0),e([ce({type:ib})],ab.prototype,"sceneService",void 0),e([ce({type:rb})],ab.prototype,"tiledSurface",void 0),e([ce({type:sb})],ab.prototype,"heatmap",void 0),e([ce()],ab.prototype,"fadeDuration",void 0),e([ce()],ab.prototype,"antialiasingEnabled",void 0),e([ce()],ab.prototype,"physicallyBasedRenderingEnabled",void 0),e([ce()],ab.prototype,"highQualityTransparency",void 0),e([ce()],ab.prototype,"memoryLimit",void 0),e([ce()],ab.prototype,"additionalCacheMemory",void 0),e([ce()],ab.prototype,"frameRate",void 0),e([ce()],ab.prototype,"maximumPixelRatio",void 0),ab=e([ue("esri.views.3d.support.QualitySettings.QualitySettings")],ab);const nb=ab;var ob;!function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"}(ob||(ob={}));const lb=(()=>{const e=new Array;return e[ob.ELEVATION]=10,e[ob.BASEMAP]=10,e[ob.I3S_INDEX]=10,e[ob.I3S_DATA]=10,e[ob.SYMBOLOGY]=5,e})(),hb=30;let cb=class extends Hi{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new Oh,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=500,this._additionalCacheMemory=100}destroy(){this._cacheStorage.destroy()}set maxMemory(e){null==e||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(1),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){null!=e&&e>=0&&(this._additionalCacheMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}newCache(e,t){return new Eh(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<.6&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(1);else if(e)(this._memoryPredicted>1.1||this._usedMemory>1)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>1)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<.75&&this._quality<1){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),1))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((e=>!!e.updating))}_updateMemory(){let e=0;this.view.basemapTerrain&&(e+=this.view.basemapTerrain.usedMemory);const t=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderer.edgeView;A(t)&&(e+=t.usedMemory);let i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((t=>{if(Mh(t)){const r=t.ignoresMemoryFactor?this._quality:1;e+=t.usedMemory*r,i+=t.unloadedMemory*r}}));const r=M(this._warnMemoryUsage)||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(e>s&&r){this._warnMemoryUsage=e;const t=e=>(e/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",r=Math.round(100*this._quality);E.getLogger(this.declaredClass).warn(`Memory Limit exceeded! Limit: ${t(s)} Current: ${t(e)} Projected: ${t(e+i)} Quality: ${r}%`)}this._usedMemory=e/s,this._memoryPredicted=(e+i)/s;const a=s-e;this._cacheStorage.maxSize=Math.max(0,a+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}};e([ce({constructOnly:!0})],cb.prototype,"view",void 0),e([ce()],cb.prototype,"maxMemory",null),e([ce()],cb.prototype,"additionalCacheMemory",null),e([ce()],cb.prototype,"memoryFactor",null),e([ce()],cb.prototype,"updating",null),e([ce()],cb.prototype,"usedMemory",null),e([ce()],cb.prototype,"_quality",void 0),e([ce()],cb.prototype,"_usedMemory",void 0),e([ce()],cb.prototype,"_updating",void 0),e([ce()],cb.prototype,"_stableQuality",void 0),e([ce()],cb.prototype,"_maxMemory",void 0),e([ce()],cb.prototype,"_additionalCacheMemory",void 0),cb=e([ue("esri.views.3d.support.MemoryController")],cb);let db=class extends Hi{constructor(){super(...arguments),this.updating=!1}};e([ce({readOnly:!0})],db.prototype,"updating",void 0),db=e([ue("esri.views.3d.support.ResourceControllerMain")],db);let ub=class extends db{constructor(){super(...arguments),this._immediateTask=Gn,this._normalTask=Gn,this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){var e;this._scheduler=Hn(),this._memoryController=(e=this.view,new cb({view:e})),this._streamDataLoader=new Dh,this._streamDataLoader.setup(30,lb,this._scheduler),this.addHandles([G((()=>this.view.state?.mode),(e=>{null!=e&&(this._scheduler.state=e)}),$),G((()=>this.view.stationary),(()=>this._stationaryChangedHandler()))]),this._frameTask=ee({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(Vn.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(Vn.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=D(this._frameTask),this._streamDataLoader=I(this._streamDataLoader),this._memoryController=I(this._memoryController),this._scheduler=I(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(i,r,s)=>t.request(i,r,e,s),get busy(){return!t.hasDownloadSlots(e)}}}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(Z(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};e([ce()],ub.prototype,"view",void 0),e([ce()],ub.prototype,"_scheduler",void 0),e([ce()],ub.prototype,"_memoryController",void 0),e([ce()],ub.prototype,"_streamDataLoader",void 0),e([ce()],ub.prototype,"_immediateTask",void 0),e([ce()],ub.prototype,"_normalTask",void 0),e([ce({readOnly:!0})],ub.prototype,"updating",null),ub=e([ue("esri.views.3d.support.ResourceControllerImpl")],ub);class pb{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",(()=>{})),this._wosrMemCache=e("wosr-resources",(()=>{}))}destroy(){this._gltfLoading.forEach((e=>e.abortController.abort())),this._wosrLoading.forEach((e=>e.abortController.abort())),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,i){const r=i?`gltfPBR:${e}`:`gltf:${e}`,s=this._gltfMemCache.get(r);return A(s)?Promise.resolve(s):this._loadOnce(this._gltfLoading,this._gltfMemCache,r,(t=>fc(new yc(t.streamDataRequester),e,t,i)),t)}loadWOSR(e,t){const i=`wosr:${e}:${t.disableTextures}`,r=this._wosrMemCache.get(i);return A(r)?Promise.resolve(r):this._loadOnce(this._wosrLoading,this._wosrMemCache,i,(t=>bc(e,t)),t)}async _loadOnce(e,t,i,r,s){p(s);const a=m(s,(()=>this._abortLoad(e,i)));let n=e.get(i);if(n)n.refCount++;else{const t=new AbortController;n={refCount:1,abortController:t,promise:r({...s,signal:t.signal})},e.set(i,n)}try{const r=await n.promise;return t.put(i,r,r.size),e.delete(i),p(s),r}finally{D(a)}}_abortLoad(e,t){const i=e.get(t);A(i)&&--i.refCount>0||(e.delete(t),A(i)&&i.abortController.abort())}}class mb extends ci{constructor(e,t,i,r){super(t,r),this._streamDataRequester=e,this._parameters=i}async fromUrl(e,t,i){p(i);const r=A(i)?i.signal:null,s=this.makeUid(e,t);let a=this._textureRequests.get(s);if(!a){const i=new AbortController,r=this._streamDataRequester.request(e,"image",{uid:s,signal:i.signal});a={referenceCount:0,texture:null,textureAsync:null,abortController:i};const n=a;this._textureRequests.set(s,a),a.textureAsync=r.then((async i=>{const r=this._createTexture(e,i,t);return n.texture=r,n.abortController=null,this._stage.add(r),await this._stage.load(r),{uid:s,texture:r,release:()=>this._release(s)}}),(e=>{throw n.abortController=null,e}))}a.referenceCount++;try{return await _(a.textureAsync,r)}catch(e){throw this._release(s),e}}_createTexture(e,t,i){const r={...this._parameters,powerOfTwoResizeMode:Tc.PAD};if(xc(e)){if(i||0===t.width&&0===t.height){const e=t.width?t.height/t.width:1;i=i||64,e>1?(t.width=Math.round(i/e),t.height=i):(t.width=i,t.height=Math.round(i*e))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(r.preMultiplyAlpha=!1)}return r.width=t.width,r.height=t.height,new Ac(t,r)}}class _b{constructor(e){this.textures=null,this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(ob.SYMBOLOGY),this.objectResourceCache=new pb(((t,i)=>e.resourceController.memoryController.newCache(t,i))),this.textures=new mb(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:ma.CLAMP_TO_EDGE,t:ma.CLAMP_TO_EDGE}},e.resourceController.scheduler);const t=br(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=Zs(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=Ks(e.viewingMode,t)}destroy(){I(this.textures),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return y();this._graphicsOwners.push(e);const t=G((()=>e.layer?.screenSizePerspectiveEnabled),(()=>this._updateScreenSizePerspectiveEnabled()));return this._updateScreenSizePerspectiveEnabled(),y((()=>{t.remove(),x(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()}))}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some((e=>!0===e.layer?.screenSizePerspectiveEnabled));if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new R;const e=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([G((()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance),e,$),this._viewState.events.on("camera-projection-changed",e)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=I(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;gb.distance=e.centerOnSurfaceInfrequent.distance,gb.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(gb),this.screenSizePerspectiveSettingsLabels.update(gb),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}}const gb={distance:0,fovY:0};class fb{constructor(e,t,i=""){this.graphics=e,this._symbol=new Mc({symbolLayers:[new Dc({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new Ic({text:i,halo:{color:"white",size:1/.75},material:{color:t},size:12})]})}show(e,t){if(M(t))return;this.hide();const r=new Ph({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new i({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){A(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let yb=class extends Hi{constructor(e){super(e),this.handles=new R}destroy(){this.handles.destroy()}};e([ce({constructOnly:!0})],yb.prototype,"renderCoordsHelper",void 0),e([ce({constructOnly:!0})],yb.prototype,"surface",void 0),e([ce({constructOnly:!0})],yb.prototype,"state",void 0),yb=e([ue("esri.views.3d.support.PointOfInterest")],yb);const vb=Array;let bb=class extends yb{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new bh({location:Ph,renderLocation:vb},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=ve(),this._tmpPoint=new Ph}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(Q((()=>this.map?.ground?.layers),"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=I(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=Ee(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Tl(i,t,0)}get updating(){return this._dirty||null!=this._pendingElevationQueryController}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return this._updateSurfaceAltitude(0),kn.YIELD;const e=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint,e);const t=(this._tmpPoint.z??0)>Tb&&this.renderCoordsHelper.viewingMode===Ui.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?wb:0}).then((e=>this._updateSurfaceAltitude(e.geometry.z??0))).catch((e=>{d(e)||this._updateSurfaceAltitude(0)})).catch((()=>{})).then((()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null})),this._pendingElevationQueryController=i,kn.YIELD}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(xb,this._estimatedSurfaceAltitude,this._camera.eye),ke(this._get("renderLocation"),xb)||(this._set("renderLocation",De(this._propertiesPool.get("renderLocation"),xb)),this.notifyChange("renderLocation"))}};e([ce({constructOnly:!0})],bb.prototype,"scheduler",void 0),e([ce({constructOnly:!0})],bb.prototype,"cache",void 0),e([ce({constructOnly:!0})],bb.prototype,"task",void 0),e([ce({readOnly:!0})],bb.prototype,"location",null),e([ce({constructOnly:!0})],bb.prototype,"map",void 0),e([ce({readOnly:!0})],bb.prototype,"renderLocation",void 0),e([ce({readOnly:!0})],bb.prototype,"scale",null),e([ce({readOnly:!0})],bb.prototype,"updating",null),bb=e([ue("esri.views.3d.support.CameraOnSurface")],bb);const xb=ve(),Tb=1e5,wb=1e6,Cb=Array;let Sb=class extends yb{constructor(e){super(e),this._propertiesPool=new bh({location:Ph,renderLocation:Cb},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=ve(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=D(this._frameWorker),this._propertiesPool=I(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,kn.YIELD}_updateRenderLocation(){const e=Rb;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=Ob;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(De(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=Ee(this._camera.eye,e):(Te(e,this._camera.viewForward,this._get("distance")),Oe(e,e,this._camera.eye)),ke(this._get("renderLocation"),e)||this._set("renderLocation",De(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=br(this.renderCoordsHelper.spatialReference).radius,s=r+e,a=ye(i.eye),n=a<s*s,o=Ee(i.eye,t);if(n&&o>r/4){const e=s-Math.sqrt(a);return Te(t,i.viewForward,e),Oe(t,t,i.eye),!0}}else{const e=this.surface?.ready?this.surface.extent:null;A(e)&&Ke(e,this.surface?.spatialReference,Eb,this.renderCoordsHelper.spatialReference)&&(t[0]=Bi(t[0],Eb[0],Eb[2]),t[1]=Bi(t[1],Eb[1],Eb[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||null==e)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(La.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=Ee(i,e),s=Ee(i,t);if(Math.abs(s-r)/r>Pb)return!0}return!1}};e([ce({constructOnly:!0})],Sb.prototype,"scheduler",void 0),e([ce({constructOnly:!0})],Sb.prototype,"task",void 0),e([ce()],Sb.prototype,"distance",void 0),e([ce({constructOnly:!0})],Sb.prototype,"estimateSurfaceAltitudeAtCenter",void 0),e([ce({readOnly:!0})],Sb.prototype,"location",null),e([ce({readOnly:!0})],Sb.prototype,"renderLocation",void 0),e([ce()],Sb.prototype,"updating",void 0),Sb=e([ue("esri.views.3d.support.CenterOnSurface")],Sb);const Pb=.05,Rb=ve(),Ob=ve(),Eb=at();class Ab{constructor(e){this._handles=new R,this.events=new mr,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",(e=>this._layerViewsChanged(e)))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=I(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach((e=>{"esri.views.3d.layers.SceneLayerView3D"===e.declaredClass&&this._handles.add(e.on("visible-geometry-changed",(()=>this._contentChanged())),e.uid)})),e.removed.forEach((e=>this._handles.remove(e.uid)))}_contentChanged(){this.events.emit("request-update",Mb)}}const Mb={},Db=Array;let Ib=class extends yb{constructor(e){super(e),this._propertiesPool=new bh({location:Ph,renderLocation:Db},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([G((()=>this.centerOnSurface.renderLocation),(()=>this.updateRenderLocation())),G((()=>this.state.contentCamera),(()=>this.updateRenderLocation()))]),this.scheduler&&this.handles.add(this.scheduler.registerTask(Vn.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=I(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,Lb);const s=Math.max(0,(Math.acos(xe(Lb,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!Me(e,t)){const e=this._propertiesPool.get("renderLocation");De(e,t),this._set("renderLocation",e)}return kn.YIELD}const a=1-Bi(s/(.5*Math.PI),0,1),n=a*a*a;this._calculateScreenHorizontalEdgeOnSurface(Fb);const o=this._propertiesPool.get("renderLocation");return we(o,t,Fb,n),e&&Me(e,o)||this._set("renderLocation",o),kn.YIELD}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(ae());if(i[1]=t.aboveGround?t.padding[nl.BOTTOM]:t.fullHeight-t.padding[nl.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,Nb)){Ie(Nb,Nb,t.eye);const i=be(Nb,Nb);if(this.renderCoordsHelper.intersectManifold(Bo(t.eye,i),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};e([ce()],Ib.prototype,"_dirty",void 0),e([ce({constructOnly:!0})],Ib.prototype,"scheduler",void 0),e([ce({constructOnly:!0})],Ib.prototype,"centerOnSurface",void 0),e([ce({constructOnly:!0})],Ib.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),e([ce({readOnly:!0})],Ib.prototype,"updating",null),e([ce({readOnly:!0})],Ib.prototype,"location",null),e([ce({readOnly:!0})],Ib.prototype,"renderLocation",void 0),Ib=e([ue("esri.views.3d.support.pointsOfInterest.Focus")],Ib);const Lb=ve(),Nb=ve(),Fb=ve();let Ub=class extends Hi{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=ve();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new R}initialize(){this.view.state.isLocal&&(this._handles.add([G((()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent]),(()=>this._update())),Q((()=>this.surface?.layers),"change",(()=>this._update()))]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||M(this.surfaceView.extent)||M(this.surfaceView.spatialReference))return void this._set("location",null);const e=ft(this.surfaceView.extent),t=new Ph({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then((e=>{this._updateController=null,this._set("location",e.geometry)})).catch((e=>{d(e)||e&&"elevation-query:invalid-layer"===e.name||console.error("StableSurfaceCenter failed to update: ",e)}))):this._set("location",t)}};e([ce({constructOnly:!0})],Ub.prototype,"view",void 0),e([ce({constructOnly:!0})],Ub.prototype,"cache",void 0),e([ce()],Ub.prototype,"surface",null),e([ce()],Ub.prototype,"surfaceView",null),e([ce({readOnly:!0})],Ub.prototype,"location",void 0),e([ce({readOnly:!0})],Ub.prototype,"renderLocation",null),Ub=e([ue("esri.views.3d.terrain.StableSurfaceCenter")],Ub);let jb=class extends Hi{constructor(e){super(e),this._tileGeometryUpdateExtent=nt(),this._tileGeometryUpdateSpatialReference=null,this.events=new mr,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",(e=>this._tileGeometryChanged(e))),this.scheduler.registerTask(Vn.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Vb),nt(this._tileGeometryUpdateExtent),this._set("updating",!1),kn.YIELD):kn.YIELD}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=k(e.spatialReference),ct(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.contentCamera.eye,r=qb,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,kb,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,zb,t),kb[0]<zb[0]?(r[0]=kb[0],r[2]=zb[0]):(r[0]=zb[0],r[2]=kb[0]),kb[1]<zb[1]?(r[1]=kb[1],r[3]=zb[1]):(r[1]=zb[1],r[3]=kb[1]),dt(r,e)}};e([ce({constructOnly:!0})],jb.prototype,"state",void 0),e([ce({constructOnly:!0})],jb.prototype,"centerOnSurfaces",void 0),e([ce({constructOnly:!0})],jb.prototype,"renderCoordsHelper",void 0),e([ce({constructOnly:!0})],jb.prototype,"scheduler",void 0),e([ce({constructOnly:!0})],jb.prototype,"surface",void 0),e([ce({readOnly:!0})],jb.prototype,"updating",void 0),jb=e([ue("esri.views.3d.support.SurfaceGeometryUpdates")],jb);const Vb={},kb=ve(),zb=ve(),qb=nt();let Gb=class extends Hi{constructor(e){super(e),this._handles=new R,this._tmpRay=qo(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new bh({renderPointOfView:Hb},this),this.renderPointOfView=ve(),this._pois=new Array,this._debugCenters=new Map}initialize(){const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=cl(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=ul.MIN,this._contentIntersector=cl(e.viewingMode);const s=()=>this._estimateSurfaceAltitudeAtCenter(),a=this.view.resourceController.scheduler,n=k(this.view.basemapTerrain?.elevationQueryCache),o={state:e,scheduler:a,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Sb({...o,task:Vn.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnSurfaceFrequent",new Sb({...o,task:Vn.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s})),this._set("centerOnContent",new Sb({...o,task:Vn.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new bb({...o,cache:n,task:Vn.POINT_OF_INTEREST_INFREQUENT,map:r})),this._set("surfaceGeometryUpdates",new jb({...o,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new Ab({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new Ub({cache:n,view:this.view})),this._set("focus",new Ib({state:e,scheduler:a,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceInfrequent,estimateSurfaceIntersectionAtRenderPoint:(e,t)=>this._estimateSurfaceIntersectionAtRenderPoint(e,this.view.state.contentCamera,t)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const l=this.view.graphics;this._debugCenters.set(this.centerOnContent,new fb(l,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new fb(l,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new fb(l,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new fb(l,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new fb(l,"green","Focus")),this._handles.add([G((()=>e.contentCamera),(e=>this._cameraChanged(e)),$),G((()=>t.extent),(()=>this._updateCenterPointsOfInterest())),W((()=>!t.updating),(()=>this._updateCenterPointsOfInterest()),$),Q((()=>this.surfaceGeometryUpdates.events),"request-update",(()=>this._updateCenterPointsOfInterest())),Q((()=>this.contentGeometryUpdates.events),"request-update",(()=>this._updateCenterOnContent())),W((()=>La.SHOW_POI),(e=>this._setDebug(e)),H)]),this._cameraChanged(this.view.state.contentCamera);for(const e of this._pois)e.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some((e=>e.updating)))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return M(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Bb,$b)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Bb):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(M(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=Oe(Bb,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(Bb)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Bb)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=sl(t,e,Wb);if(M(r))return null;const s=r.origin,a=Oe(Bb,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,a),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;ke(this.renderPointOfView,t)||this._set("renderPointOfView",De(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach((e=>e.hide())),void this._handles.remove("debug");for(const e of this._pois)this._handles.add(G((()=>e.renderLocation),(t=>this._debugCenters.get(e)?.show(t,e.renderCoordsHelper.spatialReference)),H),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};e([ce({readOnly:!0})],Gb.prototype,"centerOnContent",void 0),e([ce({readOnly:!0})],Gb.prototype,"centerOnSurfaceFrequent",void 0),e([ce({readOnly:!0})],Gb.prototype,"centerOnSurfaceInfrequent",void 0),e([ce({readOnly:!0})],Gb.prototype,"cameraOnSurface",void 0),e([ce({readOnly:!0})],Gb.prototype,"focus",void 0),e([ce({readOnly:!0})],Gb.prototype,"renderPointOfView",void 0),e([ce({readOnly:!0})],Gb.prototype,"surfaceOrigin",void 0),e([ce({readOnly:!0})],Gb.prototype,"contentGeometryUpdates",void 0),e([ce({readOnly:!0})],Gb.prototype,"surfaceGeometryUpdates",void 0),e([ce({constructOnly:!0})],Gb.prototype,"view",void 0),e([ce({readOnly:!0})],Gb.prototype,"updating",null),Gb=e([ue("esri.views.3d.support.PointsOfInterest")],Gb);const Hb=Array,Bb=ve(),Wb=qo(),$b={exclude:new Set([ol])},Qb={value:.5,readOnly:!0},Xb={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};class Yb{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}}class Zb{constructor(e,t,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new zc(i,t)}computeMinMaxValue(e,t,i,r){r.min=1/0,r.max=-1/0,r.hasNoDataValues=!1;const s=e-this.level;if(s<=0)return r;const a=2**s;if(Math.floor(t/a)!==this.i||Math.floor(i/a)!==this.j)return r;let n=1/0,o=-1/0;const l=this.samplerData.data.width,h=this.samplerData.data.values,c=.5*qc;let d=(l-1)/a,u=(i-this.j*a)*d,p=(t-this.i*a)*d;if(d<1){const e=Math.floor(u),t=Math.floor(p),i=e+t*l,s=h[i],a=h[i+1],n=h[i+l],o=h[i+l+1];if(s+a+n+o<c){const i=u-e,l=p-t,h=sr(s,a,n,o,i,l),c=sr(s,a,n,o,i+d,l),m=sr(s,a,n,o,i,l+d),_=sr(s,a,n,o,i+d,l+d);return r.min=Math.min(h,c,m,_),r.max=Math.max(h,c,m,_),r}u=e,p=t,d=1}else u=Math.floor(u),p=Math.floor(p),d=Math.ceil(d);for(let e=u;e<=u+d;e++)for(let t=p;t<=p+d;t++){const i=h[e+t*l];i<c?(n=Math.min(n,i),o=Math.max(o,i)):r.hasNoDataValues=!0}return r.min=n,r.max=o,r}}const Kb=.5*qc;function Jb(e,t,i){if(M(i))return null;for(const r of i){if(!r)continue;const i=r.safeWidth;let s=Bi(r.dy*(r.y1-t),0,i),a=Bi(r.dx*(e-r.x0),0,i);const n=Math.floor(s),o=Math.floor(a),l=r.data.width,h=n*l+o,c=r.data.values,d=c[h],u=c[h+1],p=h+l,m=c[p],_=c[p+1];if(d+m+u+_<Kb){s-=n,a-=o;const e=d+(u-d)*a;return e+(m+(_-m)*a-e)*s}}return null}let ex=class extends Hi{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",(()=>this.notifyChange("stencilEnabledExtents")))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach((t=>{const i=t.layer;if("IntegratedMeshLayer"===i.operationalLayerType&&null!=this.viewSpatialReference){const t=rx(i.fullExtent,this.viewSpatialReference);A(t)&&e.push(bt(t))}})),e}};e([ce({readOnly:!0})],ex.prototype,"layerViewsExtent",null),e([ce({readOnly:!0})],ex.prototype,"tiledLayersExtent",null),e([ce({readOnly:!0})],ex.prototype,"stencilEnabledExtents",null),e([ce()],ex.prototype,"viewSpatialReference",void 0),e([ce()],ex.prototype,"tilingScheme",void 0),e([ce()],ex.prototype,"defaultTiledLayersExtent",void 0),e([ce({constructOnly:!0})],ex.prototype,"layers",void 0),e([ce({constructOnly:!0})],ex.prototype,"layerViews",void 0),ex=e([ue("esri.views.3d.terrain.ExtentHelper")],ex);let tx=class extends ex{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?Gc:Hc}};tx=e([ue("esri.views.3d.terrain.ExtentHelperGlobal")],tx);let ix=class extends ex{_computeLayerViewsExtent(){const e=nt(),t=this.viewSpatialReference;this.layerViews.forEach((i=>{const r=i.layer;if(i.isResolved()&&("graphics"!==r.type||!r.internal)){const r=rx("fullExtentInLocalViewSpatialReference"in i&&i.fullExtentInLocalViewSpatialReference||i.layer.fullExtent,t);ct(e,r,e)}}));const i=yt(e)?e:null,r=this._get("layerViewsExtent");return vt(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=nt();this.layers.forEach((r=>{if(r.loaded&&Vt(r)){const s=Ih(r,t,Ui.Local);if(M(s))return;const{tileInfo:a,fullExtent:n}=s;A(a)&&A(n)&&(Lh(r)||e.compatibleWith(a)&&n.spatialReference.equals(e.spatialReference))&&ct(i,n,i)}})),ct(i,this.defaultTiledLayersExtent,i);const r=yt(i)?i:null,s=this._get("tiledLayersExtent");return vt(r,s)?s:r}};function rx(e,t){return A(e)&&!e.spatialReference.equals(t)?Je(e,e.spatialReference,t):e}var sx;ix=e([ue("esri.views.3d.terrain.ExtentHelperLocal")],ix),function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"}(sx||(sx={}));const ax=[sx.ELEVATION,sx.MAP];function nx(){const e=globalThis.require?.modules;if(e){const t=Object.keys(e);for(const i of t)-1!==i.search(".glsl")&&delete e[i]}}const ox=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let lx,hx=class extends Hi{get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||La.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return A(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?br(this._spatialReference).metersPerDegree:1}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}constructor(e){super(e),this._handles=new R,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=b("esri-mobile")?2048:4096,this._animationTimeLast=0,this._removeRenderOverlayCallback=()=>{}}initialize(){const e=this.view;this.renderer=new vn({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=cl(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",(()=>{this.setDrawTexturesDirty(),this.notifyChange("hasHighlights")})),this.renderer.events.on("has-water",(t=>e._stage?.renderer.setParameters({hasOverlayWater:t}))),this.renderer.events.on("renders-occluded",(()=>{this.setDrawTexturesDirty(),this.notifyChange("rendersOccluded")})),this.renderer.events.on("content-changed",(()=>this.setDrawTexturesDirty())),this.renderer.events.on("textures-disposed",(()=>this.updateOverlayResult())),G((()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location]),(()=>this.setPlacementDirty())),G((()=>[e.state?.pixelRatio,e.state?.contentPixelRatio]),(()=>this.setPlacementDirty()),$),this.surface.on("elevation-change",(()=>this.setPlacementDirty())),e.on("resize",(()=>this.setPlacementDirty())),e.resourceController.scheduler.registerTask(Vn.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",(e=>{this._updateOverlays(qn,e,wc.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,wc.BACKGROUND,e.pixelRatio)}))]);let t=e=>this._renderOverlayCallback(e);this._removeRenderOverlayCallback=()=>{t=()=>{}},e._stage?.renderer.setParameters({renderOverlay:e=>t(e)})}_renderOverlayCallback(e){this._contentUpdated=!1;const t=this.renderer;t.processSyncDrapeSources(),t.hasOverlays&&(this._dispatchAnimationUpdate(e),this._drawOverlayTextures(t.overlays,wc.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}destroy(){this._handles=I(this._handles),this._removeRenderOverlayCallback(),this.view?._stage?.renderer.setParameters({renderOverlay:()=>{}}),A(lx)&&(lx.hide(),lx=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;A(e)&&A(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new jo(-20037508.342787,20037508.342787):new jo(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,bn)}_updateDrapeSourceExtent(e){2===this.renderer.overlays.length&&A(e.setDrapingExtent)&&A(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateOverlayResult(){this.view._stage?.renderer.setParameters({overlays:this.renderer.overlays})}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,wc.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return kn.YIELD;const r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,ux);const s=lt(ux.inner)/lt(ux.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const a=this._updateOverlay(Jc.INNER,ux.inner,r,1*ux.pixelRatioAdjustment,ux.mapUnitsPerPixel),n=this._updateOverlay(Jc.OUTER,ux.outer,r,s*ux.pixelRatioAdjustment,ux.mapUnitsPerPixel);a!==gx.EXTENT&&n!==gx.EXTENT||(this._drapeSources.forEach((e=>this._updateDrapeSourceExtent(e))),this.surface.updateTileOverlayParams(i)),a===gx.NONE&&n===gx.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this.view.state.contentPixelRatio,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t;return Math.min(Ki(Math.max(i,r)+256),this._maxResolution)}_updateOverlay(e,t,i,r,s){if(0===this.renderer.overlays.length)return gx.NONE;const a=this.renderer.overlays[e],n=a.mapUnitsPerPixel;if(a.mapUnitsPerPixel=s,a.pixelRatio=r,function(e,t){const i=La.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i}(t,a.extent)&&i===a.resolution)return n===s?gx.NONE:gx.RERENDER_ONLY;_t(a.extent,t),a.resolution=i;const o=ft(a.extent);return a.renderLocalOrigin=xn(o[0],o[1],0,"OV_"+this._latestOriginId++),gx.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Jc.INNER],r=this.renderer.overlays[Jc.OUTER],s=e.extent;this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,Jc.INNER,t),this._setTileOverlayData(s,Jc.OUTER,t)):(this._clearTileOverlayData(Jc.INNER,t),this._clearTileOverlayData(Jc.OUTER,t))}else this._clearTileOverlayData(Jc.INNER,t),this._clearTileOverlayData(Jc.OUTER,t)}overlayPixelSizeInMapUnits(e){if(0===this.renderer.overlays.length)return 0;const t=this.renderer.overlays[Jc.INNER],i=this.renderer.overlays[Jc.OUTER],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(0===this.renderer.overlays.length)return;const r=this.renderer.overlays[t].extent,s=lt(r),a=ht(r);let n=e[0];if(this._longitudeCyclical){n=this._longitudeCyclical.minimalMonotonic(r[0],n);const t=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);n>t&&(n=t-(e[2]-e[0]))}i.setScale(t,lt(e)/s,ht(e)/a),i.setOffset(t,(n-r[0])/s,(e[1]-r[1])/a)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){nx(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(qn)}_dispatchAnimationUpdate(e){const t=K(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||A(this.view.state.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const i=K(t/this.surface.view._stage.renderer.animationTimeDilation),r=new Js(this.view.state.camera,i,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(r)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,_x,t,i);if(M(s))return!1;const a=s.origin,n=Oe(dx,s.origin,s.direction);return this._groundIntersector.reset(a,n,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,a,n),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),a=this.view.pointsOfInterest.centerOnSurfaceFrequent,n=1e-5,o=Bi(a.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+n,e.aboveGround?s-n:1/0),l=e.aboveGround;if("global"===this.view.viewingMode){const t=dx;Ao(Do(Io,br(this.view.spatialReference).radius+o),Bo(e.eye,e.viewForward),t),Ie(t,t,e.eye);const s=Uo.normalize(ko(e.viewForward,t,e.viewRight))/e.fovY+.5,a=s<=0||s>=1?.5:r;i=l?a*s:s+a*(1-s)}else{const t=.5*Math.PI-Math.acos(-e.viewForward[2]),s=Math.tan(t),a=fr(0,s,1,0),n=Ir(a,a,e.projectionMatrix)[1],o=Bi(.5+.5*n,0,1);i=1===o||0===o?.5:l?o*r:1-(1-o)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&ze(t,e.eye)<a.distance*a.distance}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=ve();this._findHorizonBasedPointOfInterest(e,s)||De(s,r);const a=Math.max(.1,Ee(e.eye,s)),n=oi(this.view.renderCoordsHelper,r,e.eye),o=Math.PI/2-Math.abs(n-Math.PI/2);La.OVERLAY_SHOW_CENTER?(M(lx)&&(lx=new fb(this.view.graphics,"red")),lx.show(s,this._renderSR)):A(lx)&&lx.hide(),this._overlaySREqualsRenderSR||et(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,h=!this._isSpherical&&A(this._spatialReference)&&this._spatialReference.isGeographic,c=h&&A(this._spatialReference)?1/br(this._spatialReference).metersPerDegree:1,d=this.view.state.contentPixelRatio,u=e.perScreenPixelRatio/d*a*c;i.mapUnitsPerPixel=u/this._worldToPCSRatio;let p=t*u/2,m=!1,_=h?90:1/0;this._isSpherical&&A(l)&&A(this._spatialReference)&&(this._spatialReference.isWebMercator?(p/=Math.cos(nd(s[1])),_=l[3]):(m=!0,p/=br(this._spatialReference).metersPerDegree,_=90),p>=_&&(p=_,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let g=1;m&&(g=1/Math.max(.2,Math.cos(Math.abs(Wi(s[1])))),p*g>180&&(g=180/p),i.mapUnitsPerPixel*=g);const f=Math.log(2)/12;p=Math.exp(Math.round(Math.log(p)/f)*f);const y=p*g,v=.5*t/(32*y),b=.5*t/(32*p);s[0]=Math.round(s[0]*v)/v,s[1]=Math.round(s[1]*b)/b;const x=i.inner;x[0]=s[0]-y,x[1]=s[1]-p,x[2]=s[0]+y,x[3]=s[1]+p,this._isSpherical&&this._shiftExtentToFitBounds(x,1/0,_);const T=i.outer;if(6*y>lt(l))_t(T,k(l));else if(o<=.25*Math.PI)T[0]=x[0]-y,T[1]=x[1]-p,T[2]=x[2]+y,T[3]=x[3]+p;else{et(e.eye,this._renderSR,dx,this._spatialReference),Mr(cx,s,dx);let t=-Math.atan2(cx[1],cx[0])+.125*Math.PI;t<0&&(t+=2*Math.PI);const i=Math.floor(t/(.25*Math.PI));Lr(cx,ox[i],2*p),cx[0]*=g,cx[2]*=g,Nr(T,x,cx)}if(this._isSpherical)T[0]=this._longitudeCyclical.clamp(T[0]),T[2]=this._longitudeCyclical.clamp(T[2]),T[1]=Math.max(T[1],-_),T[3]=Math.min(T[3],_);else{const e=xt(x,l,px),t=xt(T,l,mx);Tt(e,t)&&(T[2]=T[0],T[3]=T[1])}const w=Math.abs(x[2]-x[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,w),i.pixelRatioAdjustment=i.mapUnitsPerPixel/w}_drawOverlayTextures(e,t,i=this.view.state.contentPixelRatio){if(0===e.length||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const r=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const s=this._drawOverlay(e[Jc.INNER],i),a=this._drawOverlay(e[Jc.OUTER],i);s!==Cc.CHANGED&&a!==Cc.CHANGED||this.surface.updateTileOverlayParams(wc.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),r?(this.surface.requestRender(t),t===wc.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(wc.BACKGROUND)}_drawOverlay(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return!M(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):dt(e,t))}_rectInsideRect(e,t){return!M(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:Tt(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),ot(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask(qn)}}};e([ce()],hx.prototype,"_spatialReference",void 0),e([ce({readOnly:!0})],hx.prototype,"running",null),e([ce()],hx.prototype,"_placementDirty",void 0),e([ce()],hx.prototype,"_contentUpdated",void 0),e([ce()],hx.prototype,"_isSpherical",null),e([ce()],hx.prototype,"_worldToPCSRatio",null),e([ce({autoDestroy:!0})],hx.prototype,"renderer",void 0),e([ce({constructOnly:!0})],hx.prototype,"view",void 0),e([ce({constructOnly:!0})],hx.prototype,"surface",void 0),e([ce()],hx.prototype,"suspended",null),e([ce()],hx.prototype,"updating",null),e([ce({type:Boolean})],hx.prototype,"hasHighlights",null),e([ce({type:Boolean})],hx.prototype,"rendersOccluded",null),hx=e([ue("esri.views.3d.terrain.OverlayManager")],hx);const cx=_r(),dx=ve(),ux={inner:at(),outer:at(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},px=at(),mx=at(),_x=qo();var gx;!function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"}(gx||(gx={}));class fx{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map}acquire(e){if(!fx.test.disabled){const t=this._pool.get(e);if(t&&0!==t.length)return t.pop()}try{return this._factoryCallback(e)}catch(t){const i=window.performance&&window.performance.memory;let r="";throw i&&(r=`\n  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+t+r),t}}release(e){if(fx.test.disabled)return;const t=this._lengthCallback(e);let i=this._pool.get(t);i||(i=new J({shrink:!0}),this._pool.set(t,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}fx.test={disabled:!1};class yx{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Jl(),this.indexCount=0,this.numVerticesPerSide=0,this.uvRange=[0,0,1,1],this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]}}class vx{constructor(e,t,i,r,s){this.attributes=e,this.localOrigin=t,this.index0=i,this.stride=r,this.count=s}getVertexIndex(e){return this.getAttributeIndex(e)}getAttributeIndex(e){return Nh(0<=e&&e<this.count),this.index0+this.stride*e}_getVertexRaw(e,t){this.attributes.position.getVec(e,t)}_getNormalRaw(e,t){this.attributes.normalCompressed.getVec(e,t)}getVertexPos(e,t){this._getVertexRaw(this.getAttributeIndex(t),e),Oe(e,e,this.localOrigin)}getNormal(e,t){const i=kr();this._getNormalRaw(this.getAttributeIndex(t),i),function(e,t){const i=Rx(t[0]),r=Rx(t[1]),s=1-Math.abs(i)-Math.abs(r);e[2]=s,s<0?(e[0]=(i>=0?1:-1)*(1-Math.abs(r)),e[1]=(r>=0?1:-1)*(1-Math.abs(i))):(e[0]=i,e[1]=r),be(e,e)}(e,i)}_setNormal(e,t,i,r){wx(this.attributes.normalCompressed,e,t,i,r)}_setUV(e,t,i){Sx(this.attributes.uv0,e,t,i)}setNormalFromValues(e,t,i,r){this._setNormal(this.getAttributeIndex(e),t,i,r)}setVertexFromValuesRawPositionUV(e,t,i,r,s,a){const n=this.getAttributeIndex(e);this.attributes.position.setValues(n,t,i,r),this._setUV(n,s,a)}setVertexFromValuesRawPositionUVNormal(e,t,i,r,s,a,n,o,l){const h=this.getAttributeIndex(e);this.attributes.position.setValues(h,t,i,r),this._setUV(h,s,a),this._setNormal(h,n,o,l)}}const bx=Xn().vec3f(Gs.POSITION).vec2i16(Gs.UV0).vec2i16(Gs.NORMALCOMPRESSED,{glNormalized:!0}),xx=new fx((e=>bx.createBuffer(e)),(e=>e.count));function Tx(e){return xx.acquire(e)}function wx(e,t,i,r,s){const a=1/(Math.abs(i)+Math.abs(r)+Math.abs(s)),n=i*a,o=r*a,l=s<=0?(n>=0?1:-1)*(1-Math.abs(o)):n,h=s<=0?(o>=0?1:-1)*(1-Math.abs(n)):o;e.setValues(t,Px(l),Px(h))}const Cx=16384;function Sx(e,t,i,r){e.setValues(t,i*Cx,r*Cx)}function Px(e){return Bi(Math.round(32767*e),-32767,32767)}function Rx(e){return Bi(e/32767,-1,1)}function Ox(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}class Ex{constructor(){this.cornerTiles=[null,null,null,null],this.cornerTileSamplerVersions=[-1,-1,-1,-1]}}class Ax{constructor(){this.cornerNeighborData=[new Ex,new Ex,new Ex,new Ex],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1],this.cornerPeerNeighbors=[null,null,null,null]}}class Mx{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.shading=!1,this.samplerDataVersion=0,this.neighborData=new Ax}}class Dx{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=I(this._current),this._next=I(this._next),this._waiting=I(this._waiting),this._delayed=I(this._delayed)}get current(){if(M(this._current))return null;if(!this._isFadingEnabled){const e=this._delayed||this._waiting||this._next||this._current;e!==this._current&&(this._current=null,this.clear(),this._current=e)}let e=Dx.test.fadeMoment;if(A(this._delayed)&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,Ix.Immediate),this._delayed=null)),A(this._next)){e=e||performance.now();const t=this._fadeDuration,i=A(this._current)&&this._next.texture===this._current.texture,r=this._next.type!==ed.FADING,s=e-this._fadeStart>=t;(i||r||s)&&(I(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(M(this._next))return 1;const e=Dx.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return t>i?0:1-t/i}get isFading(){return A(this._next)||A(this._delayed)}push(e,t=Ix.Immediate){this._delayed=I(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),M(this._current))return void(this._current=e);const i=Dx.test.fadeMoment||performance.now();return t!==Ix.Immediate?(this._delayed=e,void(this._delayedTime=i+t)):M(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(M(e)||(I(this._waiting),this._waiting=e))}get _fadeDuration(){return M(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}}var Ix,Lx;Dx.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(Ix||(Ix={})),function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"}(Lx||(Lx={}));class Nx{constructor(){this._queue=new J,this.remove=()=>{}}get done(){return 0===this._queue.length&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),A(e)&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}}class Fx{constructor(){this._q=new J}get done(){return 0===this._q.length}reset(e){if(this._q.clear(),!M(e)){this._q.pushArray(e);for(let e=0;e<this._q.length;++e){const t=this._q.data[e];t.isLeaf||this._q.pushArray(t.children)}}}next(){return this._q.pop()}}function Ux(e,t,i){if(M(t)||M(t.fullExtent))return!1;const r=t.fullExtent,s=e.extent;if(i){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const a=e.surface.tilingScheme.levels[e.level].scale,n=t.minScale;if(n>0&&a>1.00000001*n)return!1;const o=t.maxScale;return!(o>0&&a<.99999999*o)}function jx(e,t){const i=e.lij,r=t.lij;return i[0]-r[0]||i[1]-r[1]||i[2]-r[2]}function Vx(e,t,i=null){M(i)||0===i.length?e===Lx.BACK_TO_FRONT?t.sort(kx):t.sort(zx):t.sort(((t,r)=>function(e,t,i,r){return Gx(e,r)===Gx(t,r)?qx(e,t,i):e?i:-i}(t,r,e,i)))}function kx(e,t){const i=t.screenDepth-e.screenDepth;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function zx(e,t){const i=e.screenDepth-t.screenDepth;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function qx(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:jx(e,t)}function Gx(e,t){for(const i of t)if(e.intersectsExtent(i))return!0;return!1}function Hx(e,t){const i=e.distanceToPOI-t.distanceToPOI;if(0!==i)return i;const r=e.lij,s=t.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function Bx(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,a=1<<s[0]-r[0];return Math.floor(s[1]/a)===r[1]&&Math.floor(s[2]/a)===r[2]}class Wx{get updating(){return!!this._tileRequested}init(e,t,i,r){this.tile=e,this._layerIdx=t,this._layerClass=i,this._suspended=r,this._tileLayerInfo=e.getLayerInfo(t,i),this._tileRequested=null;const s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,ed.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return A(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,i=this.tile.surface.layerViewByIndex(e,t),r=Fh(i),{minLevel:s,maxLevel:a}=i.dataLevelRange,n=this._desiredMinLevelDelta,o=this._progressiveLevelModulo+n,l=this._scaleRangeEnabled?Ux:()=>!0;let h=this.tile;const c=h.level;let d;const u=this._tileLayerInfo.upsampleInfo,p=A(u)?u.tile.level:-1,m=!!A(u)&&p-c>=n,_=z(r,"tilemapCache");for(;h&&l(h,r,!1)&&h.level>=s;){const i=h.level,r=c-i,l=h.layerInfo[t][e];if(l.data&&r>=n){(!m||i>p)&&this._setUpsampleTile(h),l.dataInvalidated&&(d=h);break}if((M(_)||"unavailable"!==_.getAvailability(h.lij[0],h.lij[1],h.lij[2]))&&i<=a&&!l.data&&!l.dataMissing&&((M(d)||h.level===s||i%Wc==0||c-d.level<n)&&(d=h),r>=o))break;h=h.parent}if(A(d)&&c-d.level<n)if(u)d=null;else{const i=this._findAncestorWithData();A(i)&&(this._setUpsampleTile(i),d=i.layerInfo[t][e].dataInvalidated?i:null)}return d}_findAncestorWithData(){const e=this.tile.elevationLevel,t=this._desiredMinLevelDelta;let i;for(let r=this.tile;r;r=r.parent)if(r.hasLayerData(this._layerIdx,this._layerClass)){if(e-r.level>=t)return r;i=r}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,ed.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}const $x=new Error("Abstract method called on TileAgent"),Qx=new class extends Wx{get _desiredMinLevelDelta(){throw $x}get _progressiveLevelModulo(){throw $x}dispose(){}};class Xx extends Wx{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return $c(this.tile.level)-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class Yx extends Wx{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Wc}}var Zx,Kx,Jx;function eT(e){e.fragment.uniforms.add([new qs("u_colormap",(e=>e.u_colormap)),new Ns("u_colormapOffset",(e=>e.colormap.u_colormapOffset)),new Ns("u_colormapMaxIndex",(e=>e.colormap.u_colormapMaxIndex)),new Ns("u_opacity",(e=>e.common.u_opacity))]),e.fragment.code.add(Fs`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function tT(e){e.fragment.uniforms.add(new qs("u_transformGrid",(e=>e.u_transformGrid))),e.fragment.uniforms.add(new Ms("u_transformSpacing",(e=>e.common.u_transformSpacing))),e.fragment.uniforms.add(new Ms("u_targetImageSize",(e=>e.common.u_targetImageSize))),e.fragment.code.add(Fs`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}!function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"}(Zx||(Zx={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(Kx||(Kx={}));class iT extends Us{constructor(){super(...arguments),this.scale=1,this.offset=qr}}function rT(e){e.attributes.add(Gs.POSITION,"vec2"),e.attributes.add(Gs.UV0,"vec2"),e.vertex.uniforms.add(new Ns("scale",(e=>e.scale))),e.vertex.uniforms.add(new Ms("offset",(e=>e.offset))),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.code.add(Fs`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}class sT extends iT{constructor(e,t,i){super(),this.common=e,this.u_image=t,this.u_transformGrid=i}}function aT(e,t){e.include(tT),e.fragment.uniforms.add([new qs("u_image",(e=>e.u_image)),new ds("u_flipY",(e=>e.common.u_flipY)),new ds("u_applyTransform",(e=>e.common.u_applyTransform))]);const{requireBilinearWithNN:i}=t;i&&e.fragment.uniforms.add([new Ms("u_srcImageSize",(e=>e.common.u_srcImageSize))]),e.fragment.code.add(Fs`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),i?e.fragment.code.add(Fs`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):e.fragment.code.add(Fs`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}!function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(Jx||(Jx={}));const nT={normal:Jx.Normal,average:Jx.Average,lighten:Jx.Lighten,lighter:Jx.Lighter,screen:Jx.Screen,plus:Jx.Plus,"color-dodge":Jx.ColorDodge,darken:Jx.Darken,multiply:Jx.Multiply,"color-burn":Jx.ColorBurn,overlay:Jx.Overlay,"soft-light":Jx.SoftLight,"hard-light":Jx.HardLight,"vivid-light":Jx.VividLight,hue:Jx.Hue,saturation:Jx.Saturation,luminosity:Jx.Luminosity,color:Jx.Color,difference:Jx.Difference,exclusion:Jx.Exclusion,minus:Jx.Minus,invert:Jx.Invert,reflect:Jx.Reflect,"destination-over":Jx.DestinationOver,"destination-atop":Jx.DestinationAtop,"destination-in":Jx.DestinationIn,"destination-out":Jx.DestinationOut,"source-atop":Jx.SourceAtop,"source-in":Jx.SourceIn,"source-out":Jx.SourceOut,xor:Jx.Xor};function oT(e){e.code.add(Fs`
    float lineFactorAtPosition(float value) {
      float pos = value * ${Fs.float(257)};
      if(pos < 0.5 || pos > ${Fs.float(256.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function lT(e,t){const i=t.blendMode;i!==Jx.Normal&&(i===Jx.Reflect&&e.code.add(Fs`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==Jx.ColorDodge&&i!==Jx.VividLight||e.code.add(Fs`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==Jx.ColorBurn&&i!==Jx.VividLight||e.code.add(Fs`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===Jx.Overlay&&e.code.add(Fs`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===Jx.HardLight&&e.code.add(Fs`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===Jx.SoftLight&&e.code.add(Fs`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===Jx.VividLight&&e.code.add(Fs`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==Jx.Hue&&i!==Jx.Saturation&&i!==Jx.Color&&i!==Jx.Luminosity||(e.code.add(Fs`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==Jx.Hue&&i!==Jx.Saturation||e.code.add(Fs`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(Fs`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===Jx.Multiply?Fs`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Average?Fs`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Lighten?Fs`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Darken?Fs`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Lighter?Fs`return vec4(cl * ol + cb * ob, ol + ob);`:i===Jx.Plus?Fs`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===Jx.Minus?Fs`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===Jx.Screen?Fs`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Difference?Fs`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Invert?Fs`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===Jx.DestinationOver?Fs`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===Jx.DestinationAtop?Fs`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===Jx.DestinationOut?Fs`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===Jx.SourceAtop?Fs`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===Jx.SourceOut?Fs`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===Jx.Xor?Fs`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===Jx.DestinationIn?Fs`return vec4(cb * ob * ol, ol * ob);`:i===Jx.SourceIn?Fs`return vec4(cl * ol * ob, ol * ob);`:i===Jx.Hue?Fs`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Saturation?Fs`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Color?Fs`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Luminosity?Fs`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Exclusion?Fs`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Reflect?Fs`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.ColorDodge?Fs`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.ColorBurn?Fs`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.Overlay?Fs`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.SoftLight?Fs`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.HardLight?Fs`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===Jx.VividLight?Fs`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:Fs``}
    }
  `))}var hT,cT,dT;function uT(e,t){const i=t.output===hT.GridComposite,r=t.output===hT.ColorComposite,s=t.output===hT.GroupBackgroundComposite,a=t.output===hT.Composite;i&&e.fragment.include(oT),r&&e.fragment.uniforms.add(new Is("backgroundColor",(e=>e.backgroundColor)));const n=t.baseOpacityMode===cT.Required;n&&e.fragment.uniforms.add(new Ns("baseOpacity",(e=>e.baseOpacity))),a&&e.fragment.uniforms.add(new qs("fboColor",(e=>e.fboTexture)));const o=t.blendMode!==Jx.Normal,l=t.premultipliedSource===dT.On;e.fragment.include(lT,t),e.fragment.code.add(Fs`
    vec4 getBackground(vec2 uv) {
      return ${n?Fs`baseOpacity *`:""} ${s?Fs`vec4(0.0, 0.0, 0.0, 0.0)`:r?Fs`vec4(backgroundColor, 1.0)`:i?Fs`vec4(gridColor(uv), 1.0)`:Fs`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${o?Fs`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:Fs`
          float composeAlpha = colorLayer.a * opacity;
          return ${!l&&(a&&!n||s)?Fs`colorLayer * opacity;`:Fs`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}!function(e){e[e.Composite=0]="Composite",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.GroupBackgroundComposite=3]="GroupBackgroundComposite",e[e.COUNT=4]="COUNT"}(hT||(hT={})),function(e){e[e.NotRequired=0]="NotRequired",e[e.Required=1]="Required",e[e.COUNT=2]="COUNT"}(cT||(cT={})),function(e){e[e.Off=0]="Off",e[e.On=1]="On",e[e.COUNT=2]="COUNT"}(dT||(dT={}));class pT extends sT{constructor(e,t,i,r,s,a){super(e,r,s),this.colormap=t,this.symbolizer=i,this.u_colormap=a,this.backgroundColor=Ve,this.fboTexture=null,this.baseOpacity=1}}const mT=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:class extends pT{},ColorizerStretchUniforms:class extends pT{},ColorizerUniforms:pT,build:function(e){const t=new Vs;return t.include(rT),t.include(aT,e),t.include(eT,e),t.include(uT,e),t.fragment.code.add(Fs`vec4 applyBackgroundBlend(vec4 layerColor) {
vec4 bgColor = getBackground(vuv);
return blendLayers(bgColor, layerColor, u_opacity);
}`),e.colorizerType===Zx.Stretch?function(e,t){e.fragment.uniforms.add([new us("u_bandCount",(e=>e.symbolizer.u_bandCount)),new Na("u_minCutOff",(e=>e.symbolizer.u_minCutOff),3),new Na("u_maxCutOff",(e=>e.symbolizer.u_maxCutOff),3),new Na("u_factor",(e=>e.symbolizer.u_factor),3),new Ns("u_minOutput",(e=>e.symbolizer.u_minOutput)),new Ns("u_maxOutput",(e=>e.symbolizer.u_maxOutput)),new ds("u_useGamma",(e=>e.symbolizer.u_useGamma)),new Na("u_gamma",(e=>e.symbolizer.u_gamma),3),new Na("u_gammaCorrection",(e=>e.symbolizer.u_gammaCorrection),3),new Ns("u_opacity",(e=>e.common.u_opacity))]),e.fragment.code.add(Fs`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?Fs`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:Fs`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.code.add(Fs`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${t.stretchType===Kx.Noop?Fs`
        fragColor = applyBackgroundBlend(currentPixel);`:Fs`
        if (currentPixel.a == 0.0) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}(t,e):e.colorizerType===Zx.Lut?function(e){e.fragment.code.add(Fs`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}(t):e.colorizerType===Zx.Hillshade&&function(e,t){const i=e.fragment;i.uniforms.add([new qs("u_image",(e=>e.u_image)),new us("u_hillshadeType",(e=>e.symbolizer.u_hillshadeType)),new Na("u_sinZcosAs",(e=>e.symbolizer.u_sinZcosAs),6),new Na("u_sinZsinAs",(e=>e.symbolizer.u_sinZsinAs),6),new Na("u_cosZs",(e=>e.symbolizer.u_cosZs),6),new Na("u_weights",(e=>e.symbolizer.u_weights),6),new Ms("u_factor",(e=>e.symbolizer.u_factor)),new Ns("u_minValue",(e=>e.symbolizer.u_minValue)),new Ns("u_maxValue",(e=>e.symbolizer.u_maxValue)),new Ms("u_srcImageSize",(e=>e.common.u_srcImageSize))]),i.include(qa),i.code.add(Fs`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),i.code.add(Fs`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?Fs`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:Fs`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.code.add(Fs`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}
    }
  `)}(t,e),t}},Symbol.toStringTag,{value:"Module"})),_T={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class gT{constructor(e,t,i=null,r=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=e,this.source=t,this.width=i||t.width,this.height=r||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=F(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{..._T,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||_T}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){A(e)&&e.length>0?this._bandIds&&e.every(((e,t)=>!!this._bandIds?.[t]&&e===this._bandIds[t]))||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,A(this._rasterTexture)){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode("bilinear"===t?_a.LINEAR:_a.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=F(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((M(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(e,this.bandIds),A(this._rasterTexture)&&(this._updateColormapTexture(e),this.transformGrid&&M(this._transformGridTexture)&&(this._transformGridTexture=ld(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:r,opacity:s}=this,a=hd(t,[i,r],[this.source.width,this.source.height],s),n=cd(e.colormap,e.colormapOffset),o="stretch"===this.symbolizerParameters.type?dd(this.symbolizerParameters):null,l="hillshade"===this.symbolizerParameters.type?ud(this.symbolizerParameters):null;return new pT(a,n,o||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return"bilinear"===this.interpolation&&null!=e.colormap&&"stretch"===e.type}get memoryUsage(){if(M(this._memoryUsed)){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map((e=>A(e)?e.descriptor.width*e.descriptor.height*4:0)).reduce(((e,t)=>e+t),0)}return this._memoryUsed}release(){return this._rasterTexture=F(this._rasterTexture),this._transformGridTexture=F(this._transformGridTexture),this._colormapTexture=F(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=F(this._rasterTexture));const r=M(t)&&M(this.bandIds)||A(t)&&A(this.bandIds)&&t.join("")===this.bandIds.join("");if(A(this._rasterTexture)&&r)return;this._rasterTexture=F(this._rasterTexture);const s=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=pd(e,i,s,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&"none"===this.symbolizerParameters.stretchType&&!this.symbolizerParameters.useGamma&&"u8"===this.source.pixelType}_getRasterTextureInterpolation(e){return"lut"===this.symbolizerParameters.type||"nearest"===e||"majority"===e||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some(((e,i)=>e!==t[i]))?(this._colormapTexture=F(this._colormapTexture),this._colormapTexture=md(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=md(e,i),void(this._colormap=i)):(this._colormapTexture=F(this._colormapTexture),void(this._colormap=null))}}class fT{constructor(){this.waitingAgents=new J,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=yT.acquire();return t._init(e),t}release(){this.dispose(),vT.delete(this),yT.release(this)}dispose(){this.loadingAgent=F(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Uh(this._data)}static prune(){yT.prune(0)}_init(e){this.waitingAgents.clear(),this._data=Uh(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=L(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){A(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e===t||M(t))this._unsetUpsampleInfo();else{if(M(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),function(e,t,i){let r=1,s=0,a=0;for(;e!==t;)if(r*=.5,s*=.5,a*=.5,1&e.lij[2]&&(s+=.5),0==(1&e.lij[1])&&(a+=.5),null==(e=e.parent))throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,a,r)}(e,t,this._upsampleInfo)}}get data(){return this._data}set data(e){Uh(this._data),this._data=e}}const yT=new vh(fT,null,(()=>{})),vT=new Map;class bT{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,0===this._refCount&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}var xT;!function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.RENDERDATA=8]="RENDERDATA",e[e.GEOMETRY=16]="GEOMETRY",e[e.TEXTURE_NOFADING=32]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=64]="TEXTURE_FADING"}(xT||(xT={}));class TT{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=at(),this._elevationBounds=kr(),this.layerInfo=[[],[]],this.extentInRadians=at(),this.centerAtSeaLevel=ve(),this._center=[ve(),Mo(),ve()],this.up=qe(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=ve()}static prune(){ST.prune(0),PT.prune(0),fT.prune()}get _isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[OT.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,t=e?.frustumVisibility??td.INTERSECTS;this._frustumVisibility=t===td.INSIDE?td.INSIDE:t===td.OUTSIDE?td.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const i=this._frustumVisibility!==td.OUTSIDE&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}get shouldLoad(){return this.isLeaf}init(e,t,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=br(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[OT.MIDDLE][3]=0,this.elevationLevel=e?e[0]:0,t&&t.elevationBounds?Or(this._elevationBounds,t.elevationBounds):Rr(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const e of ax){const t=i.numLayers(e),r=this.layerInfo[e];for(const e of r)e.release();r.length=t;for(let i=0;i<t;i++)r[i]=fT.acquire(this._surface.upsampleInfoPool),e===sx.ELEVATION&&this.findElevationBoundsForLayer(i,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,Bc)}release(){jh(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of ax){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[sx.MAP].reduce(((e,t)=>e+(t instanceof Vc?t.memoryUsage:0)),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const e=this._surface.tilingScheme.pixelSize;return e*e*4}_ensureUsedMemory(){if(A(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;let e=0;for(const{data:t}of this.layerInfo[sx.MAP])t instanceof Vc?e+=this._getTerrainDataMemory(t):this._mapTileMemoryInternal+=this._getTerrainDataMemory(t);const t=this._cpuImageMemorySize;for(const e of this.layerInfo[sx.ELEVATION])this._usedMemory+=e.data?t:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=mn(this.renderData.textureDescriptor)),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,t){const i=this.layerInfo[e][t];return i?.data?e===sx.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===sx.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof bT?mn(e.texture):e instanceof HTMLImageElement||e instanceof Vh?this._cpuImageMemorySize:e instanceof Vc||e instanceof gT?e.memoryUsage:0}updateScreenDepth(e){const t=this._center[OT.MIDDLE],i=e,r=t[0],s=t[1],a=t[2],n=i[2]*r+i[6]*s+i[10]*a+i[14];this.screenDepth=n<0?0:n/(i[3]*r+i[7]*s+i[11]*a+i[15])}shouldSplit(e,t,i){if(!this.visible)return xT.NONE;if(A(e.frustum)&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===td.OUTSIDE))return xT.NONE;const r=this.level;Ie(IT,this._center[OT.MIDDLE],t);let s=ye(IT),a=IT,n=OT.MIDDLE;Ie(LT,this._center[OT.TOP],t);const o=ye(LT);o<s&&(s=o,a=LT,n=OT.TOP),Ie(NT,this._center[OT.BOTTOM],t);const l=ye(NT);if(l<s&&(s=l,a=NT,n=OT.BOTTOM),this._edgeLen2>s&&r<e.maxLod)return xT.SPLIT;const h=A(i)?i-r:1/0,c=Math.sqrt(s),d=e.fovX*c*2,u=this._edgeLen/d,p=()=>{if(r<e.maxLod)return this.elevationLevel=r,xT.NONE;const t=r+Math.ceil(-Math.log2(e.relativeWidthLimit/u));return t!==this.elevationLevel?(this.elevationLevel=t,xT.ELEVATION):xT.NONE};if(h<=.5)return p();const m=xe(this.up,IT),_=this._elevationBounds[1]-this._elevationBounds[0],g=_/this.edgeLen;if(e.aboveGround&&m>0&&g<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-g>0)return xT.NONE;const f=A(i)?3-Math.min(h,2):1;if(u*f<e.relativeWidthLimit||r>=e.maxLod)return p();if(r<7)return xT.SPLIT;Te(FT,this.up,m),Ie(FT,FT,a);const y=ye(FT);if(y<=this.radius*this.radius)return xT.SPLIT;Te(FT,FT,this.radius/Math.sqrt(y)),Oe(FT,FT,this._center[n]),Ie(FT,t,FT);const v=Math.min(1,(Math.abs(xe(FT,this.up))+.5*_+this._curvatureHeight)/Ce(FT)),b=.1/e.angledSplitBias,x=e.fovY*c*2;return v*(this._edgeLen/x*f)<b*e.relativeHeightLimit?xT.NONE:xT.SPLIT}setChildren(e,t,i,r){jh(!!(e&&t&&i&&r),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=i,this._children[3]=r}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of ax)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const e of ax){const t=this.layerInfo[e];for(const e of t)e.loadingAgent&&e.loadingAgent!==Qx&&(CT(e.loadingAgent),e.loadingAgent=null),e.pendingUpdates=0}this.resetPendingUpdate(xT.GEOMETRY),this.resetPendingUpdate(xT.TEXTURE_NOFADING),this.resetPendingUpdate(xT.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[sx.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==Qx&&(CT(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(vt(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,i=this._isWithinClippingArea;A(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const r=i&&this._isWithinClippingArea,s=!(i||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||r||s||this.setPendingUpdate(xT.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const i=this.layerInfo[t][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of ax){const t=this.layerInfo[e];for(const e of t)if(e.loadingAgent&&e.loadingAgent!==Qx&&e.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(xT.SPLIT)||e!==sx.ELEVATION&&!this.loadable}get hasPendingUpdates(){return 0!==this._pendingUpdates}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,e===xT.SPLIT||e===xT.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,i){const r=this.layerInfo[t][e];if(r.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),!0;if(r.waitingAgents.push(i),r.data&&!r.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),t,e),i.dataArrived(this),!0;if(r.requestPromise)return!0;L(r.requestAbort),r.requestAbort=new AbortController;const s=this._surface.requestTileData(this,e,t,r.requestAbort);if(!s)return r.requestAbort=null,!1;const a=()=>{r.requestPromise===s&&(r.requestPromise=null,r.requestAbort=null)};return r.requestPromise=s,s.then(a,a),!0}get isLeaf(){return null==this._children[0]}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return ye(Ie(FT,this._center[OT.MIDDLE],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const i=this.extent;return e>=i[0]&&t>=i[1]&&e<=i[2]&&t<=i[3]}unrequestLayerData(e,t,i){const r=this.layerInfo[t][e],s=r.waitingAgents,a=null!=s.removeUnordered(i);jh(a,"agent has not requested this piece of map data"),s.length<1&&(r.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,i){const r=this.layerInfo[t][e];r.data=i,r.dataInvalidated=!1,r.waitingAgents.forAll((e=>e.dataArrived(this))),r.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${i}`);const r=this.layerInfo[t][e];r.dataMissing=!0,r.waitingAgents.forAll((e=>e.dataMissing())),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t){switch(e){case sx.MAP:return this._updateTexture(t);case sx.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===ed.FADING?xT.TEXTURE_NOFADING:xT.TEXTURE_FADING),this.setPendingUpdate(e===ed.FADING?xT.TEXTURE_FADING:xT.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(xT.GEOMETRY);for(const e of this.layerInfo[sx.ELEVATION])e.pendingUpdates|=xT.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBounds,t=e[0],i=e[1];Rr(e,1/0,-1/0);const r=this.layerInfo[sx.ELEVATION];let s=!0;for(const t of r)A(t.elevationBounds)&&(e[0]=Math.min(e[0],t.elevationBounds.min),e[1]=Math.max(e[1],t.elevationBounds.max),t.elevationBounds.hasNoDataValues||(s=!1));s&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),t===e[0]&&i===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBounds,t=.5*(e[0]+e[1]),i=this._center;Te(FT,this.up,t),Oe(i[OT.MIDDLE],this.centerAtSeaLevel,FT),Te(FT,this.up,e[0]),Oe(i[OT.TOP],this.centerAtSeaLevel,FT),Te(FT,this.up,e[1]),Oe(i[OT.BOTTOM],this.centerAtSeaLevel,FT)}findElevationBoundsForLayer(e,t){const i=this.layerInfo[sx.ELEVATION][e],r=$c(this.level),s=Math.max(this.elevationLevel-r,0),a=i.elevationBounds;if(A(a)&&a.level>=t&&a.level<=s)return;const n=this._surface.layerViewByIndex(e,sx.ELEVATION);if(!Ux(this,Fh(n),!1))return;const o=RT;let l=!1;const h=i.data;if(h&&h.level<=s){const e=i.data;o.min=e.samplerData.data.minValue,o.max=e.samplerData.data.maxValue,o.hasNoDataValues=e.samplerData.data.hasNoDataValues,o.level=this.level,l=!0}else{let t,i,a=0;for(let n=this._parent;n&&(!i||a<r)&&(a=this.elevationLevel-n.level,t=i||t,i=n.layerInfo[sx.ELEVATION][e].data,!(!i&&t&&n.level<=s));n=n.parent);i=i||t,i&&(i.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],o),o.min!==1/0&&(o.level=i.level,l=!0))}l&&(M(i.elevationBounds)&&(i.elevationBounds=new Yb),i.elevationBounds.copyFrom(o))}modifyLayers(e,t,i){const r=this.layerInfo[i];for(const e of r)e.loadingAgent&&e.loadingAgent!==Qx&&(CT(e.loadingAgent),e.loadingAgent=null),e.waitingAgents.clear();for(let t=0;t<r.length;++t)void 0===e[t]&&r[t].release();const s=new Array(...r),a=t.length;r.length=a;for(let e=0;e<a;e++){const i=t[e];r[e]=i>-1?s[i]:fT.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,ed.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const e of t)e.loadingAgent===Qx&&(e.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of ax){const t=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==Qx&&(i.loadingAgent.setSuspension(t),i.loadingAgent===Qx&&this.updateRenderData(e,ed.FADING))}}removeLayerAgent(e,t){const i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==Qx&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,t){const i=this.layerInfo[t][e];i.loadingAgent=Qx,!i.data&&M(i.upsampleInfo)&&this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return"normal"!==e.blendMode||kt(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,i){for(let r=e;r<t;++r){const e=this._surface.layerViewByIndex(r,i);if(kh(e)&&"normal"!==e?.layer?.blendMode||kt(e?.layer?.parent)&&this._hasBlendableAncestor(e?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,t){const i=this.layerInfo[t];if(0===i.length)return;const r=this._isSuspended(t);for(let s=e;s<i.length;++s){const a=i[s];let n=!1;const o=this._surface.layerViewByIndex(s,t),l=Fh(o);if(a.loadingAgent?Ux(this,l,!1)?(a.loadingAgent!==Qx&&a.loadingAgent.setSuspension(r),a.loadingAgent!==Qx&&(n=a.loadingAgent.update())):a.dispose():Ux(this,l,!1)&&(a.loadingAgent=wT(this,s,t,r),n=a.loadingAgent.startLoading(),n?a.loadingAgent===Qx&&this.setPendingUpdate(xT.GEOMETRY):(CT(a.loadingAgent),a.loadingAgent=Qx)),a.loadingAgent===Qx&&this.updateRenderData(t,ed.FADING),!this._hasBlendModes(e,i.length,t)&&n&&o.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.elevationLevel-this.level,i=Math.max(this.level-e,$c(this.level)-t),r=Bi(1+(this.maxTesselation>>i),2,this.maxTesselation+1),s=this.getDefaultVerticesPerSide();return Math.max(r,s)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,t){if(!e)return null;const i=this.surface.rootTiles;if(A(i))for(const r of i)if(ET(r,e)){let i=r,s=e[0]-i.level-1;for(;s>=0&&!i.isLeaf&&!t(i);){const t=e[1]>>s&1,r=e[2]>>s&1;i=i.children[2*t+r],s--}return t(i)?i:null}return null}findNeighborTile(e,t){const i=this.lij,r=this.getNeighborLIJ(i,e);return r?(a=r,(s=i)[0]===a[0]&&s[1]===a[1]&&s[2]===a[2]?t(this)?this:null:this._findLIJ(r,t)):null;var s,a}findCorner(e,t){const i=e===id.NORTH_EAST?1:e===id.NORTH_WEST?0:e===id.SOUTH_WEST?2:3;let r=this;for(;r.children[0]&&(!t||!t(r));)r=r.children[i];return r}findNeighborCornerTileExact(e,t){return this.findNeighborTile(e,(e=>t(e)||e.level===this.level))?.findCorner(zh(e),t)||null}forAllSubtreeOnSide(e,t){const i=e===id.NORTH?[0,1]:e===id.NORTH_EAST?[1]:e===id.EAST?[1,3]:e===id.SOUTH_EAST?[3]:e===id.SOUTH?[2,3]:e===id.SOUTH_WEST?[2]:e===id.WEST?[0,2]:[0],r=e=>{const s=e.children;!t(e)&&s[0]&&i.forEach((e=>r(s[e])))};r(this)}forallNeighbors(e){qh.forEach((t=>this.findNeighborCornerTileExact(t,e))),Gh.forEach((t=>this.findNeighborTile(t,(t=>t.level===this.level||e(t)))?.forAllSubtreeOnSide(Hh(t),e)))}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const i=this.level-t.level;if(Nh(!Bh||i>=0),0===i)return 0;const r=2**i,s=1==(1&e),a=s?0:1,n=t.lij[a+1]*r,o=this.lij[a+1],l=o-n,h=s?r-1-l:l;return Bh&&(Nh(n<=o&&o<n+r),Nh(0<=h&&h<r)),h}forEachLoadedNeighbor(e){const t=this.level,i=e=>e.level===t||e.isLoaded;Gh.forEach((t=>{const r=this.findNeighborTile(t,i);null!=r&&r!==this&&r.forAllSubtreeOnSide(Hh(t),(i=>!!i.isLoaded&&(e(i,t),!0)))})),qh.forEach((t=>{const r=this.findNeighborTile(t,i)?.findCorner(zh(t),(e=>e.isLoaded));Nh(!r||AT(this,r,t)),r?.isLoaded&&e(r,t)}))}getNeighborLIJ(e,t){const i=Wh(t)?-1:$h(t)?1:0,r=Qh(t)?-1:Xh(t)?1:0,s=[e[0],e[1]+i,e[2]+r];return s[1]<0?null:this.surface.isGlobal?this.wrapLIJ(s):s[2]<0?null:s}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return 0===this.lij[2]}get isNorthEnd(){return 0===this.lij[1]}get isSouthEnd(){return this.extent[1]+od()>=this.surface.extent[1]}checkGeometryWaterproofness(){Yh&&(Nh(this.isLoaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,i=this.surface.rootTilesExtent,r=.25*(t[2]-t[0]);if(Wh(e)&&t[3]+r>=i[3])return!1;if($h(e)&&t[1]-r<=i[1])return!1;const s=this.surface.isGlobal;return!(!s&&Qh(e)&&t[0]-r<=i[0]||!s&&Xh(e)&&t[2]+r>=i[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;De(this._lastPOI,e);const i=this._center[OT.MIDDLE],r=e[0]-i[0],s=e[1]-i[1],a=e[2]-i[2];this.distanceToPOI=r*r+s*s+a*a}}function wT(e,t,i,r){const s=i===sx.ELEVATION?PT.acquire():ST.acquire();return s.init(e,t,i,r),s}function CT(e){e.dispose(),e instanceof Xx?PT.release(e):e instanceof Yx&&ST.release(e)}const ST=new vh(Yx),PT=new vh(Xx),RT=new Yb;var OT;function ET(e,t){const i=e.level,r=t[0];if(i>r)return!1;const s=r-i,a=Math.floor(t[1]/2**s),n=Math.floor(t[2]/2**s);return a===e.lij[1]&&n===e.lij[2]}function AT(e,t,i){return!M(e)&&!M(t)&&t!==e&&(e.level>=t.level?MT(e,t,i):MT(t,e,zh(i)))}function MT(e,t,i){Nh(e.level>=t.level);const r=Zh(i),s=Kh(i),a=e.extent,n=t.extent,o=[r?a[0]:a[2],s?a[3]:a[1]],l=[r?n[2]:n[0],s?n[1]:n[3]],h=1e-5*(a[2]-a[0]),c=Jh(o[0],l[0],h)||e.surface.isGlobal&&Jh(o[0],-l[0],h),d=Jh(o[1],l[1],h);if(c&&d)return!0;if(e.level===t.level)return Nh(!1),!1;if(!c&&!d)return Nh(!1),!1;const u=c?DT(n[1],n[3],a[1],a[3],h):DT(n[0],n[2],a[0],a[2],h);return Nh(u),u}function DT(e,t,i,r,s){return e-s<=i&&i<=r&&r<=t+s}!function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"}(OT||(OT={}));const IT=ve(),LT=ve(),NT=ve(),FT=ve();class UT{constructor(){this._scales=fr(-1,-1,-1,-1),this._offsets=fr(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,i){this._scales[2*e]=t,this._scales[2*e+1]=i}setOffset(e,t,i){this._offsets[2*e]=t,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}}function jT(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(Fs`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(Fs`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(Fs`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}class VT extends fd{constructor(){super(...arguments),this.slicePlaneLocalOrigin=ve(),this.origin=this.slicePlaneLocalOrigin}}var kT;!function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"}(kT||(kT={}));class zT extends VT{constructor(){super(...arguments),this.identifier=kT.Material,this.output=_o.Color,this.transparent=!1,this.integratedMesh=!1}}class qT extends VT{constructor(){super(...arguments),this.identifier=kT.ShadowMap}}let GT=class extends VT{constructor(){super(...arguments),this.identifier=kT.Highlight}};class HT extends ks{constructor(e,t){super(e,"vec4",zs.Draw,((i,r,s)=>i.setUniform4fv(e,t(r,s))))}}var BT;function WT(e,t){const{vertex:i,fragment:r}=e;i.uniforms.add([new HT("overlayTexOffset",((e,t)=>function(e,t){for(const i of t.overlays){const{index:t,extent:r}=i;wt(r)>0&&(XT[2*t]=e.toMapSpace[0]/lt(r)-r[0]/lt(r),XT[2*t+1]=e.toMapSpace[1]/ht(r)-r[1]/ht(r))}return XT}(e,t))),new HT("overlayTexScale",((e,t)=>function(e,t){for(const i of t.overlays){const{index:t,extent:r}=i;wt(r)>0&&(XT[2*t]=e.toMapSpace[2]/lt(r),XT[2*t+1]=e.toMapSpace[3]/ht(r))}return XT}(e,t)))]),r.constants.add("overlayOpacity","float",1),r.uniforms.add(new qs("ovColorTex",((e,t)=>QT(e,t)))),$T(e,t)}function $T(e,t){t.pbrMode!==hs.Water&&t.pbrMode!==hs.WaterOnIntegratedMesh&&t.pbrMode!==hs.TerrainWithWater||e.include(As,t);const{vertex:i,fragment:r}=e;e.varyings.add("vtcOverlay","vec4"),i.code.add(Fs`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),r.code.add(Fs`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),r.code.add(Fs`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),r.code.add(Fs`vec4 getOverlayColorTexel(vec4 texCoords) {
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y)*texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w)*texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),t.pbrMode!==hs.Water&&t.pbrMode!==hs.WaterOnIntegratedMesh&&t.pbrMode!==hs.TerrainWithWater||(os(r),ps(r),r.code.add(Fs`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function QT(e,t){return 0===t.overlays.length?null:e.identifier===kT.Material&&e.output===_o.Color?t.overlays[Jc.INNER].getColorTextureNoRasterImage():e.identifier===kT.Material&&e.output===_o.ObjectAndLayerIdColor?t.overlays[Jc.INNER].getColorTexture(Tn.ObjectAndLayerIdColor):e.identifier===kT.Highlight?t.overlays[Jc.INNER].getValidTexture(rd.Highlight):null}!function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"}(BT||(BT={}));const XT=_r();var YT;!function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"}(YT||(YT={}));class ZT extends Us{constructor(){super(...arguments),this.overlayOpacity=1}}function KT(e,t){e.vertex.uniforms.add([new iw("overlayTexOffset"),new iw("overlayTexScale")]),e.fragment.uniforms.add([new Ns("overlayOpacity",(e=>e.overlayOpacity)),new qs("ovColorTex",((e,t)=>0===t.overlays.length?null:t.overlays[Jc.INNER].getColorTexture(e.overlaySource)))]),$T(e,t)}function JT(e,t){const{vertex:i,fragment:r,varyings:s}=e;s.add("vtc","vec2"),i.uniforms.add(new iw("texOffsetAndScale")),r.uniforms.add(new rw("tex")),r.uniforms.add(new tw("textureOpacities"));const a=t.textureFadingEnabled&&!t.renderOccluded;a&&(i.uniforms.add(new iw("nextTexOffsetAndScale")),s.add("nvtc","vec2"),r.uniforms.add(new rw("texNext")),r.uniforms.add(new tw("nextTexOpacities")),r.uniforms.add(new ew("fadeFactor")));const n=t.tileBlendInput===YT.ColorComposite,o=t.tileBlendInput===YT.GridComposite;o&&r.include(oT),n&&r.uniforms.add(new tw("backgroundColor")),i.code.add(Fs`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${a?Fs`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:Fs``}
  }`),r.code.add(Fs`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${o||n?Fs`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${n?Fs`backgroundColor`:Fs`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:Fs`return color;`}
    }`),a?r.code.add(Fs`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(Fs`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}class ew extends ks{constructor(e){super(e,"float")}}class tw extends ks{constructor(e){super(e,"vec3")}}class iw extends ks{constructor(e){super(e,"vec4")}}class rw extends ks{constructor(e){super(e,"sampler2D")}}class sw extends ZT{}const aw=is(),nw=ve(),ow=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:sw,build:function(e){const t=new Vs,{vertex:i,fragment:r,varyings:s}=t;t.include(en),t.include(yd,e),t.include(as,e);const a=()=>{t.include(Od,e),i.code.add(Fs`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};Ed(i,e),t.include($n,e);const n=e.overlayMode!==BT.Disabled;switch(e.output){case _o.Color:{t.include(JT,e),t.include(Cd,e),n&&t.include(KT,{...e,pbrMode:e.pbrMode===hs.Terrain?hs.TerrainWithWater:hs.Water});const o=e.overlayMode===BT.EnabledWithWater;o&&t.include(jT,e),s.add("vnormal","vec3"),s.add("vpos","vec3"),s.add("vup","vec3"),a(),(e.atmosphere||e.screenSizePerspective)&&Ad(i);const l=e.receiveShadows&&!e.renderOccluded;l&&t.include(sn,e),e.atmosphere&&s.add("wnormal","vec3"),e.screenSizePerspective&&(s.add("screenSizeDistanceToCamera","float"),s.add("screenSizeCosAngle","float")),i.code.add(Fs`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${o?Fs`forwardVertexTangent(vnormal);`:Fs``}

          ${e.atmosphere?Fs`wnormal = normalize((viewNormal * vec4(normalize(positionWorld), 1.0)).xyz);`:""}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${n?Fs`setOverlayVTC(uv);`:""}
          ${e.tileBorders?Fs`forwardTextureCoordinates();`:""}

          ${e.screenSizePerspective?Fs`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${l?Fs`forwardLinearDepth();`:""}

        }
      `),t.include(_d,e),t.include(Cd,e),t.include(Sd,e),t.include(ms,e),Md(r,e),Pd(r),Rd(r),r.uniforms.add([i.uniforms.get("localOrigin"),new Is("viewDirection",((e,t)=>be(nw,Pe(nw,t.camera.viewMatrix[12],t.camera.viewMatrix[13],t.camera.viewMatrix[14]))))]),o&&r.uniforms.add([new qs("ovWaterTex",((e,t)=>0===t.overlays.length?null:t.overlays[Jc.INNER].getNormalTexture(e.overlaySource))),new Dd("view",((e,t)=>Kr(aw,t.camera.viewMatrix,e.origin)))]),r.code.add(Fs`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),os(r),ps(r),r.code.add(Fs`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${e.receiveShadows&&!e.renderOccluded?"readShadowMap(vpos, linearDepth)":e.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${n?Fs`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${e.invisible?Fs`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }
          ${e.atmosphere?Fs`
              float ndotl = clamp(vndl, 0.0, 1.0);
              vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
              atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); // avoid atmosphere on bright base maps
              atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
              atm *= tileColor.a; // premultiply with tile alpha`:""}

          vec3 albedo = ${e.atmosphere?Fs`atm + tileColor.rgb;`:Fs`tileColor.rgb;`}

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${e.pbrMode===hs.Terrain||e.pbrMode===hs.TerrainWithWater?Fs`fragColor = vec4(evaluateTerrainLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:Fs`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${o?Fs`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${e.screenSizePerspective?Fs`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${e.visualizeNormals?e.spherical?Fs`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:Fs`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${e.tileBorders?Fs`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          fragColor = highlightSlice(fragColor, vpos);
        }
      `)}break;case _o.Depth:n&&t.include(KT,e),t.include(xd,e),tn(t),rn(t),i.code.add(Fs`
              void main(void) {
                ${n?Fs`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
              }
          `),r.code.add(Fs`
              void main() {
                ${n&&e.invisible?Fs`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
                outputDepth(linearDepth);
              }
          `);break;case _o.Shadow:case _o.ShadowHighlight:case _o.ShadowExcludeHighlight:t.include(xd,e),tn(t),rn(t),i.code.add(Fs`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),r.code.add(Fs`void main() {
outputDepth(linearDepth);
}`);break;case _o.Normal:n&&t.include(KT,e),s.add("vnormal","vec3"),Ad(i),a(),i.code.add(Fs`
            void main(void) {
              ${n?Fs`setOverlayVTC(getUV0());`:""}
              gl_Position = transformPosition(proj, view, position);
              vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
            }
        `),r.code.add(Fs`
            void main() {
              ${n&&e.invisible?Fs`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
              vec3 normal = normalize(vnormal);
              if (gl_FrontFacing == false) {
                normal = -normal;
              }
              fragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
            }
        `);break;case _o.Highlight:n&&t.include(KT,e),i.code.add(Fs`
          void main() {
            ${n?Fs`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),t.include(Td,e),r.code.add(Fs`
          void main() {
            ${n?Fs`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return e.output===_o.ObjectAndLayerIdColor&&(t.include(KT,{...e,pbrMode:hs.Disabled}),i.code.add(Fs`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),r.code.add(Fs`void main() {
fragColor = getOverlayColorTexel(vtcOverlay);
}`)),t}},Symbol.toStringTag,{value:"Module"}));class lw extends Hs{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.spherical=e.viewingMode===Ui.Global}initializeProgram(e){return new Bs(e.rctx,lw.shader.get().build(this.configuration),hw)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,i=t.backfaceCullingEnabled&&!t.renderOccluded;return Ta({blending:t.renderOccluded?Sa(na.ONE,na.ONE_MINUS_SRC_ALPHA):null,culling:i?Pa:null,depthTest:t.renderOccluded?null:{func:oa.LESS},depthWrite:t.renderOccluded?null:Ra,colorWrite:Ca,stencilTest:e?eo(Sc.IntegratedMeshMaskExcluded):null})}getPipelineState(e,t){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,t)}}lw.shader=new Ws(ow,(()=>Promise.resolve().then((()=>ow))));const hw=new Map([[Gs.POSITION,0],[Gs.UV0,1],[Gs.NORMALCOMPRESSED,2]]);class cw{constructor(){this.geometryInfo=new yx,this.intersectionData=null,this.geometryState=null,this._textureRef=new Dx((()=>this.tile.surface.textureFadeDuration)),this.overlay=new UT,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._dirtyEdgeResolutions=15,this._dirtyEdges=15,this._dirtyCorners=15}get tile(){return this._tile}init(e){this.clear(),this._tile=e;const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,Jl(t.boundingBox),t.indexCount=0,t.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new Mx,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this._wireframeChanged||this._clippingAreaChanged||this._samplerDataChanged||this._numVerticesPerSideChanged||this._dirtyCorners||this._dirtyEdgeResolutions||this._dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),Bh&&this.tile.intersectsClippingArea)for(let e=0;e<4;++e)Nh(this.geometryInfo.outerEdges[e].count===this.geometryState.neighborData.edgeResolutions[e]+1)}_calculateEdgeResolution(e,t){const i=this.tile,r=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const t=i.surface.extent;if(A(t)&&(0===e&&i.extent[3]>t[3]||1===e&&i.extent[2]>t[2]||2===e&&i.extent[1]<t[1]||3===e&&i.extent[0]<t[0]))return r}const s=i.level,a=Gh[e];if(!t)return Nh(M(i.surface?.rootTiles)||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(a)),r;if(t.isLoaded){const i=t,a=i.renderData.geometryState,n=s-i.level;if(Nh(n>=0),0===n){const e=a.numVerticesPerSide-1;return Math.max(e,r)}const o=2**n,l=a.neighborData.edgeResolutions[(e+2)%4]/o;return Math.max(1,l)}Nh(!t.isLeaf);let n=r;return t.forAllSubtreeOnSide(Hh(a),(e=>e===i||(e.isLoaded?(n=Math.max(n,2**(e.level-s)),!0):(Nh(!e.isLeaf),!1)))),n}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState.neighborData,i=t=>(t.isLoaded||t.level===e.level)&&t?.intersectsClippingArea,r=t.edgePeerNeighbors,s=t.edgePeerNeighborSamplerVersions;for(let a=0;a<4;++a){const n=e.findNeighborTile(Gh[a],i),o=vw(e,n),l=o?.renderData?.geometryState.samplerDataVersion??-1,h=r[a],c=o!==vw(e,h),d=s[a]!==l;r[a]=n,(c||d)&&(s[a]=l,this._markEdgeDirty(a));const u=t.edgeResolutions[a],p=this._calculateEdgeResolution(a,n);Nh(Ji(p)),Nh(p>=1),t.edgeResolutions[a]=p,u!==p&&this._markEdgeResolutionDirty(a)}const a=t.cornerPeerNeighbors;for(let s=0;s<4;++s){const n=e.findNeighborTile(qh[s],i);a[s]=n;const o=vw(e,r[s]),l=vw(e,r[(s+1)%4]),h=vw(e,n);yw[s]=h,yw[(s+1)%4]=l,yw[(s+2)%4]=e,yw[(s+3)%4]=o,Nh(yw.some((t=>t?.isLoaded||t===e)));const c=yw.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);yw.forEach(((e,t)=>{e&&e?.level>c&&(yw[t]=null)})),Nh(yw.some((t=>t?.isLoaded||t===e)));const d=t.cornerNeighborData[s].cornerTiles,u=t.cornerNeighborData[s].cornerTileSamplerVersions;for(let e=0;e<4;++e){const t=yw[e],i=t?.renderData.geometryState.samplerDataVersion??-1,r=d[e]!==t,a=!r&&u[e]!==i;(r||a)&&(d[e]=t,u[e]=i,this._markCornerDirty(s))}Nh(d.some((t=>t?.isLoaded||t===e)))}Bh&&Nh(this.geometryState.neighborData.edgeResolutions.every((e=>e>0)));for(let e=0;e<4;++e)yw[e]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;Bh&&Nh(!this.tile.intersectsClippingArea||this.geometryState.neighborData.edgeResolutions.every((e=>e>0))),this.intersectionData=null;const t=this.tile,i=this._vao,r=this.geometryInfo.vertexAttributes,s=!i||!r||this._wireframeChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._dirtyEdgeResolutions,a=!s&&(0!==this._dirtyEdges||0!==this._dirtyEdgeResolutions),n=!a&&0!==this._dirtyCorners;s?(this.releaseGeometry(),this._createGeometry(e)):a||n?t.updateEdgeElevations():n?t.updateCornerElevations():console.warn("Update for no reason?"),this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._dirtyEdgeResolutions=0,this._dirtyEdges=0,this._dirtyCorners=0,this._clippingAreaChanged=!1,this._wireframeChanged=!1}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao.dispose(),this._vao=null,e=this.geometryInfo,xx.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null,!0);var e}ensureTexture(e,t){return A(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),M(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){A(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_markCornerDirty(e){const t=1<<e;this._dirtyCorners|=t}_markEdgeDirty(e){const t=1<<e;this._dirtyEdges|=t}_markEdgeResolutionDirty(e){const t=1<<e;this._dirtyEdgeResolutions|=t,this._dirtyEdges|=t}_markAllEdgesAndCornersDirty(){this._dirtyCorners=15,this._dirtyEdges=15,this._dirtyEdgeResolutions=15}updateGeometryState(){const e=this._getElevationInfo(),t=this.tile,i=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),r=Math.max(i,5);let s=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(s=null);const a=this.geometryState;let n=!1;a.numVerticesPerSide!==r&&(this._numVerticesPerSideChanged=!0,a.numVerticesPerSide=r,a.samplerDataVersion++,n=!0),e.changed&&(this._samplerDataChanged=!0,a.samplerData=e.samplerData,a.samplerDataVersion++,n=!0),T(a.clippingArea,s)||(this._clippingAreaChanged=!0,a.clippingArea=s,n=!0);const o=t.surface.wireframe;return a.wireframe!==o&&(this._wireframeChanged=!0,a.wireframe=o,n=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=n),n&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,r=e.gl;this._vao=new Ia(e,hw,{geometry:Qn(t.layout)},{geometry:dn.createVertex(e,r.STATIC_DRAW,t.buffer)},dn.createIndex(e,r.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=Ix.Immediate){A(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[sx.ELEVATION],i=t.length,r=new Array(i);let s=0,a=0,n=!1;for(let o=0;o<i;o++){const i=t[o];if(A(i.upsampleInfo)){const t=i.upsampleInfo.tile,l=t.layerInfo[sx.ELEVATION][o].data,h=l&&l.samplerData;e&&e[s]===h||(n=!0),r[s++]=h,a=Math.max(a,t.lij[0])}else if(i.data){const t=this.tile.surface.layerViewByIndex(o,sx.ELEVATION);if(Ux(this.tile,t.layer,!1)){const t=i.data;e&&e[s]===t.samplerData||(n=!0),r[s++]=t.samplerData,a=this.tile.level}}}A(e)&&e.length!==s&&(n=!0);const o=s>0,l=o?r:null;return o&&(r.length=s),{changed:n,samplerData:l,maxTileLevel:a}}get estimatedGeometryMemoryUsage(){const e=U(this.intersectionData,0,(e=>e.estimatedMemoryUsage));return(this.geometryInfo.indices?.byteLength??0)+(this.geometryInfo.vertexAttributes?.byteLength??0)+e}get textureDescriptor(){return A(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:null!=this._texture}}checkGeometryWaterproofness(){if(!Bh)return;const e=this.tile;if(Nh(e?.isLoaded),!e.isLoaded||!e.intersectsClippingArea)return;const t=e.renderData;if(0===e.level)return;const i=e.surface.extent;if(A(i)&&!e.intersectsExtent(i))return;const r=Gh.map(((t,r)=>!!A(i)&&(r<2?-1:1)*(e.extent[3-r]-i[3-r])<0)),s=e.level;Nh(0===this._dirtyCorners),Nh(0===this._dirtyEdges),Nh(0===this._dirtyEdgeResolutions),Nh(!this._numVerticesPerSideChanged),Nh(!this._samplerDataChanged),Nh(!this._clippingAreaChanged),Nh(!this._wireframeChanged);const a=qh.map((t=>e.findNeighborCornerTileExact(t,(t=>!t.intersectsClippingArea||t.isLoaded||t.level===e.level))??null)).map((e=>e?.intersectsClippingArea?e:null)),n=this.geometryState.neighborData;for(let t=0;t<4;++t){const i=n.cornerPeerNeighbors[t],r=a[t];Nh(r===i,`Tile[${e.lij}].corner[${t}] out of date: cur=[${i?.lij}] exp=[${r?.lij}]`)}Gh.forEach(((i,a)=>{if(r[a])return;const n=e.findNeighborTile(i,(e=>(e.level===s||e?.isLoaded)&&e?.intersectsClippingArea));if(!n){const t=!e.surface.updatingRootTiles&&A(e.surface.rootTiles)&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(i);return void Nh(!t)}Nh(n.isLoaded||n.level===e.level),Nh(n===this.geometryState.neighborData.edgePeerNeighbors[a]);const o=s-n.level;if(!n.isLoaded)return Nh(!n.isLeaf),void Nh(0===o);const l=n.renderData;Nh(function(e,t,i){if(M(e)||M(t))return!1;if(0===e.level&&0===t.level){if(e.isEastEnd&&t.isWestEnd&&i===id.EAST)return!0;if(e.isWestEnd&&t.isEastEnd&&i===id.WEST)return!0}const r=Math.max(1e-6*(e.extent[2]-e.extent[0]),1);switch(i){case id.NORTH:return Jh(e.extent[3],t.extent[1],r);case id.SOUTH:return Jh(e.extent[1],t.extent[3],r);case id.EAST:return Jh(e.extent[2],t.extent[0],r)||Jh(e.extent[2],-t.extent[0],r);case id.WEST:return Jh(e.extent[0],t.extent[2],r)||Jh(e.extent[0],-t.extent[2],r)}}(e,n,i)),Nh(o>=0);const h=2**o;if(o<0)return void Nh(!1);const c=t.geometryInfo,d=c.outerEdges[a],u=c.numVerticesPerSide-1,p=l.geometryInfo;if(!p)return void Nh(!1);{const e=this.geometryState.neighborData.edgePeerNeighbors[a];if(e?.isLoaded){const i=e.renderData;Nh(e==e),Nh(t.geometryState.neighborData.edgePeerNeighborSamplerVersions[a]===i.geometryState.samplerDataVersion),Nh(this.geometryState.neighborData.edgePeerNeighborSamplerVersions[a]===i.geometryState.samplerDataVersion)}}const m=(a+2)%4,_=p.outerEdges[m],g=d.count-1,f=_.count-1;Nh(g*h===f,`Tile[${e.lij}]:e${a},res=${g} edgeRes mismatch with Neighbor[${n.lij}]:e${m},res=${f} (expected:${g*h})`);const y=e.extent,v=i===id.NORTH||i===id.SOUTH,b=_.count-1,x=b/2**o,T=d.count-1;if(x<1)return void Nh(1===T);Nh(x===T),Nh(Ji(x));const w=p.numVerticesPerSide-1;Nh(o>0||x===Math.max(w,u));const C=e.getNeighborEdgeStartVertexIndex(a,n);Nh(0<=C&&C<h);const S=C*x;Nh(0<=S&&S<=b-x);let P=0,R=S;d.getVertexPos(dw,0),d.getVertexPos(uw,d.count-1);const O=Ee(dw,uw),E=Math.max(fw,1e-4*O);for(let r=0;r<=x;++r){d.getVertexPos(dw,P),_.getVertexPos(uw,R);const s=r/x,o=v?y[0]+s*(y[2]-y[0]):i===id.WEST?y[0]:y[2],h=v?i===id.SOUTH?y[1]:y[3]:y[1]+s*(y[3]-y[1]),c=e.surface.extent;if(M(c)||Ct(c,o,h)){const i=Ge(dw,uw),r=He(dw)-er.radius,s=He(uw)-er.radius,u=i<E;if(!u){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${a}[${P}/${d.count}] and [${n.lij}].edge${m}[${R}/${_.count}]`),A(c)&&console.warn("  surface extent= ",c," x,y=",o,",",h);const p=ve();Ie(p,t.localOrigin,l.localOrigin),He(p)>0&&console.warn(`   localOrigins: ${t.localOrigin} vs ${l.localOrigin} d=${He(p)} [${p}]`),(()=>{const t=je(dw),i=je(uw);e.updateEdgeElevations(),n.updateEdgeElevations(),d.getVertexPos(dw,P),_.getVertexPos(uw,R);const r=ve();Re(r,dw,t),He(r)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${t} vs ${dw} d=${He(r)} [${r}]`),Re(r,uw,i),He(r)>0&&console.warn(`  XXX Neighbor[${n.lij}] edge out of date: ${i} vs ${uw} d=${He(r)} [${r}]`)})(),Nh(u,`Mismatch in tile [${e.lij}].edge[${a}][${P}/${d.count}] vs neighbor [${n.lij}].edge[${m}][${R}/${_.count}] ${ec(dw)} vs ${ec(uw)}  dist=${i} h(t|n|d)=${r}|${s}|${s-r}`)}d.getNormal(pw,P),_.getNormal(mw,R),be(_w,pw),be(gw,mw);const p=xe(_w,gw),g=1-p<.01||e===n;if(!g){const t=ve();Re(t,pw,mw);const i=()=>`Mismatch in tile edge normal ${tc(e.lij)} (${P}/${d.count-1}) edge ${a} vs neighbor ${tc(n.lij)}  (${R}/${_.count-1}) nedge ${m} :${ec(pw)} vs ${ec(mw)}  dot = ${p} : ${ec(t)}`;console.warn("Mismatch in tile edge normal: ",i());{e.updateEdgeElevations(),n.updateEdgeElevations();const t=ve(),i=ve();d.getNormal(t,P),_.getNormal(i,R),Me(pw,t)||console.warn("Missing update in tile normal: ",ec(pw)," => ",ec(t)),Me(mw,i)||console.warn("Missing update in neighbor normal: ",ec(mw)," => ",ec(i))}Nh(g,i())}}P+=1,R+=1}}))}}const dw=ve(),uw=ve(),pw=ve(),mw=ve(),_w=ve(),gw=ve(),fw=1,yw=[null,null,null,null];function vw(e,t){return t?.isLoaded||t===e?t:null}const bw=65536;function xw(e){e.tile.intersectsClippingArea&&(ww(e),Tw(e))}function Tw(e,t=!1){const i=e.geometryState,r=e.geometryInfo,s=i.neighborData,a=e.tile,n=a.level,o=a.extent,l=a.ellipsoid.radius,h=a.extentInRadians,c=h[0],d=h[2],u=h[1],p=h[3],m=i.samplerData,_=o[0],g=o[2],f=o[1],y=o[3],v=Sw(e),b=r.boundingBox,x=e.localOrigin,T=x[0],w=x[1],C=x[2],S=r.vertexAttributes,P=S.position,R=P.typedBuffer,O=P.typedBufferStride,E=S.uv0;for(let i=0;i<4;++i){const h=1===i||3===i,x=s.edgeResolutions[i];Nh(Ji(x));const S=x+1,P=vw(a,s.edgePeerNeighbors[i]);if(kw(a,P,i)){Dw(e,i,P);continue}const D=A(P);Nh(!D||P.level===a.level),Nh(!D||jx(a,P)<=0);const I=P?.renderData,L=I?.geometryState;if(Bh){const e=a.surface;if(!P&&e&&!e.updatingRootTiles){const t=Gh[i],r=a.findNeighborTile(t,(e=>e.isLoaded||e.isLeaf||e.level===a.level));r?r.intersectsClippingArea&&(Nh(!r.isLoaded),Nh(!r.isLeaf),Nh(r.level===n)):Nh(M(e?.rootTiles)||!a.shouldHaveNeighbor(t))}}const N=1===i?o[2]:o[0],F=P?.extent,U=F&&h?1===i?F[0]:F[2]:N,j=0===i?o[3]:o[1],V=1===i?1:0,k=0===i?1:0,z=1===i?d:c,q=0===i?p:u,G=Math.sin(z),H=Math.cos(z),B=Math.sin(q),W=Math.cos(q),$=L?.samplerData,Q=D?(e,t,i)=>.5*(Jb(e,t,m)+Jb(i,t,$)):(e,t,i)=>Jb(e,t,m),X=r.outerEdges[i],Y=t&&S>3?S-3:1,Z=A(m)&&m.some((e=>null!=e)),K=A($)&&$.some((e=>null!=e)),J=Z||K,ee=1/x,te=X.index0;Nh(!F||Jh(F[2]-F[0],o[2]-o[0])),(()=>{const e=1===i?-1:3===i?1:0,t=0===i?-1:2===i?1:0,r=(o[2]-o[0])*ee,s=e*r,a=t*r,n=h?e*((d-c)*ee):0,u=h?0:t*ee,p=k,x=h?z+n:z,P=h?Math.sin(x):G,A=h?Math.cos(x):H,M=h?z-n:z,I=h?Math.sin(M):G,L=h?Math.cos(M):H,F=h?q:v(p+u),Z=h?B:Math.sin(F),K=h?W:Math.cos(F),ie=h?q:v(p-u),re=h?B:Math.sin(ie),se=h?W:Math.cos(ie);let ae=0,ne=0,oe=0;{const e=0*ee,t=h?N:_*(1-e)+g*e,i=h?U:t,r=h?f*(1-e)+y*e:j,s=h?z:c*(1-e)+d*e,a=h?G:Math.sin(s),n=h?H:Math.cos(s),o=h?v(e):q,u=h?Math.sin(o):B,p=h?Math.cos(o):W,m=l+Q(t,r,i);ae=n*p*m,ne=a*p*m,oe=u*m}let le=0,he=0,ce=0;{const e=1*ee,t=h?N:_*(1-e)+g*e,i=h?U:t,r=h?f*(1-e)+y*e:j,s=h?z:c*(1-e)+d*e,a=h?G:Math.sin(s),n=h?H:Math.cos(s),o=h?v(e):q,u=h?Math.sin(o):B,p=h?Math.cos(o):W,m=l+Q(t,r,i);le=n*p*m,he=a*p*m,ce=u*m}for(let e=1;e<S-1;e+=Y){let t=0,r=0,n=0;{const i=(e+1)*ee,s=h?N:_*(1-i)+g*i,a=h?U:s,o=h?f*(1-i)+y*i:j,u=h?z:c*(1-i)+d*i,p=h?G:Math.sin(u),m=h?H:Math.cos(u),b=h?v(i):q,x=h?Math.sin(b):B,T=h?Math.cos(b):W,w=l+Q(s,o,a);t=m*T*w,r=p*T*w,n=x*w}const o=t,u=r,p=n,x=le,S=he,M=ce;le=o,he=u,ce=p;{const t=te+e,i=t*O,r=x-T,s=S-w,a=M-C;R[i]=r,R[i+1]=s,R[i+2]=a,Ox(r,s,a,b);const n=e*ee;Sx(E,t,h?V:n,h?n:k)}const F=ae,Y=ne,ie=oe;ae=x,ne=S,oe=M;const de=x,ue=S,pe=M,me=1/Math.sqrt(de*de+ue*ue+pe*pe),_e=pe*me;let ge=0,fe=0,ye=0;if(J&&_e*_e<.999){let t=0,r=0,n=0;{const e=0===i?-1:1;t=e*(o-F),r=e*(u-Y),n=e*(p-ie)}{const o=e*ee,u=h?N:_*(1-o)+g*o,p=h?U:u,b=h?f*(1-o)+y*o:j,x=h?z:c*(1-o)+d*o,T=h?G:Math.sin(x),w=h?H:Math.cos(x),C=h?v(o):q,S=h?Math.sin(C):B,R=h?Math.cos(C):W;let O=de,E=ue,M=pe;if(D){const e=l+Jb(p-s,b-a,$),t=h?R:se;O=(h?L:w)*t*e,E=(h?I:T)*t*e,M=(h?S:re)*e}{const e=l+Jb(u+s,b+a,m),o=h?R:K,c=(h?A:w)*o*e,d=(h?P:T)*o*e,p=(h?S:Z)*e;D||(O=2*de-c,E=2*ue-d,M=2*pe-p);const _=3===i?-1:1,g=_*(O-c),f=_*(E-d),y=_*(M-p);ge=n*f-r*y,fe=t*y-n*g,ye=r*g-t*f;const v=1/Math.sqrt(ge*ge+fe*fe+ye*ye);ge*=v,fe*=v,ye*=v}}}else ge=de*me,fe=ue*me,ye=pe*me;X.setNormalFromValues(e,ge,fe,ye)}})()}}function ww(e){Iw(e)}function Cw(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function Sw(e){const t=e.tile;if(t.surface.isWebMercator){const e=t.extent,i=t.ellipsoid.radius,r=t=>function(e,t,i,r){return Cw(e*(1-r)+t*r,i)}(e[1],e[3],i,t);return r}const i=t.extentInRadians;return e=>function(e,t,i){return e*(1-i)+t*i}(i[1],i[3],e)}function Pw(e,t){e.tile.intersectsClippingArea&&(Ow(e),Rw(e,!1))}function Rw(e,t){const i=e.geometryState,r=i.neighborData,s=e.tile,a=s.surface,n=s.extent,o=i.clippingArea,l=A(o)?o:jw,h=n[0],c=n[2],d=n[1],u=n[3],p=[u>l[3],c>l[2],d<l[1],h<l[0]],m=e.geometryInfo,_=s.horizontalScale,g=Ew(a.isWebMercatorOnPlateeCarree,s.ellipsoid.radius,_),f=m.boundingBox,y=m.uvRange[0],v=m.uvRange[1],b=m.uvRange[2],x=m.uvRange[3],T=Math.max(h,l[0]),w=Math.min(c,l[2]),C=Math.max(d,l[1]),S=Math.min(u,l[3]),P=e.localOrigin,R=P[0],O=P[1],E=P[2],D=i.samplerData;for(let i=0;i<4;++i){const n=1===i||3===i,o=r.edgeResolutions[i];Nh(Ji(o));const l=o+1,P=p[i],I=vw(s,r.edgePeerNeighbors[i]);if(!P&&kw(s,I,i)){Dw(e,i,I);continue}const L=A(I)&&!P,N=I?.renderData,F=N?.geometryState;if(Bh&&(Nh(!L||I.level===s.level),Nh(!L||jx(s,I)<=0),s&&!I&&!a.updatingRootTiles)){const e=Gh[i],t=s.findNeighborTile(e,(e=>e.isLoaded||e.isLeaf||e.level===s.level));a.updatingRootTiles||(t?t.intersectsClippingArea&&(Nh(!t.isLoaded),Nh(!t.isLeaf),Nh(t.level===s.level)):Nh(M(a?.rootTiles)||!s.shouldHaveNeighbor(e)))}const U=Bi(1===i?c:h,T,w),j=Bi(0===i?u:d,C,S),V=F?.samplerData,k=m.outerEdges[i],z=t&&l>3?l-3:1,q=Bi(1===i?1:0,y,b),G=Bi(0===i?1:0,v,x),H=L?(e,t)=>.5*(Jb(e,t,V)+Jb(e,t,D)):(e,t)=>Jb(e,t,D),B=(c-h)/o,W=n?1===i?B:-B:0,$=n?0:0===i?B:-B,Q=-W,X=-$;let Y=0,Z=0,K=0;{const e=0/o,t=n?U:Bi(h*(1-e)+c*e,T,w),i=n?Bi(d*(1-e)+u*e,C,S):j,r=H(t,i);Y=t*_,Z=g(i),K=r}let J=0,ee=0,te=0;{const e=1/o,t=n?U:Bi(h*(1-e)+c*e,T,w),i=n?Bi(d*(1-e)+u*e,C,S):j,r=H(t,i);J=t*_,ee=g(i),te=r}for(let e=1;e<l-1;e+=z){const t=e/o,r=J,s=ee,a=te;{const i=n?q:Bi(t,y,b),o=n?Bi(t,v,x):G,l=r-R,h=s-O,c=a-E;Ox(r,h,c,f),k.setVertexFromValuesRawPositionUV(e,l,h,c,i,o)}{const t=(e+1)/o,i=n?U:Bi(h*(1-t)+c*t,T,w),r=n?Bi(d*(1-t)+u*t,C,S):j,s=H(i,r);J=i*_,ee=g(r),te=s}const l=J,p=te,m=Y,P=Z,A=K;Y=r,Z=s,K=a;let M=0,I=0,N=0;if(n){const e=ee-s,n=p-a,o=P-s,l=A-a,h=Bi(d*(1-t)+u*t,C,S),c=U+Q,m=c*_-r,g=Jb(c,h,D)-a,f=3===i?-1:1;if(M=f*(-o+e)*g,I=f*m*(-l+n),N=-f*m*(-o+e),L){const t=U+W,i=t*_-r;M=(-o+e)*(g-(Jb(t,h,V)-a)),I=(m-i)*(-l+n),N=-(m-i)*(-o+e)}}else{const e=l-r,n=p-a,o=m-r,d=A-a,u=Bi(h*(1-t)+c*t,T,w),_=j+X,f=Jb(u,_,D)-a,y=g(_)-s,v=2===i?-1:1;if(M=v*y*(-d+n),I=v*(-o+e)*f,N=-v*y*(-o+e),L){const t=u,i=j+$,r=g(i)-s;M=(-y+r)*(-d+n),I=(-o+e)*(-f+(Jb(t,i,V)-a)),N=-(-y+r)*(-o+e)}}const F=1/Math.sqrt(M*M+I*I+N*N);k.setNormalFromValues(e,M*F,I*F,N*F)}}}function Ow(e,t){Iw(e)}function Ew(e,t,i){return e?e=>function(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}(e,t):e=>function(e,t){return e*t}(e,i)}function Aw(e,t,i,r,s,a){const n=t-1,o=e.vertexAttributes.count,l=2*(Math.min(t-2,r[1])-Math.max(1,r[0]))*(Math.min(t-2,s[1])-Math.max(1,s[0])),h=Gh.map(((e,i)=>0===i&&s[1]<t-2||1===i&&r[1]<t-2||2===i&&s[0]>1||3===i&&r[0]>1)),c=e.outerEdges.reduce(((e,t,i)=>e+(h[i]?0:n-2+t.count-1)),0),d=i.reduce(((e,t)=>e+n*(2*(t.latitudeResolution-1)+1)),0),u=a?2:1,p=3*(l+c+d)*u,m=o>=bw?new Uint32Array(p):new Uint16Array(p);let _=0;const g=t-2,f=n-2;Nh(f>=0);const y=(e,t,i,r,s,a)=>{const n=e*s,o=a[n],l=a[n+1],h=a[n+2],c=t*s,d=a[c],u=a[c+1],p=a[c+2],m=i*s,_=a[m],g=a[m+1],f=a[m+2],y=r*s,v=a[y],b=a[y+1],x=a[y+2];return(d-v)*(d-v)+(u-b)*(u-b)+(p-x)*(p-x)>(o-_)*(o-_)+(l-g)*(l-g)+(h-f)*(h-f)};if(a){const a=(e,t,i)=>{m[_++]=e,m[_++]=t,m[_++]=t,m[_++]=i,m[_++]=i,m[_++]=e,Bh&&(Nh(e<o),Nh(t<o),Nh(i<o),Nh(_<=p))};(()=>{for(let i=Math.max(s[0],1)-1;i<Math.min(s[1],t-2)-1;++i){const s=i*g;for(let n=Math.max(r[0],1)-1;n<Math.min(r[1],t-2)-1;++n){const t=i*g+n,r=t+1,o=r+g,l=o-1,h=s+n,c=h+1,d=c+g,u=d-1,p=e.vertexAttributes.position.typedBuffer,m=e.vertexAttributes.position.typedBufferStride;y(h,c,d,u,m,p)?(a(t,r,o),a(o,l,t)):(a(t,r,l),a(l,o,r))}}})(),Nh(_===3*l*u),(()=>{for(let t=0;t<4;++t){const i=_;if(h[t])continue;const r=e.outerEdges[t],s=e.innerEdges[t];let o=0,l=0;const c=r.count,d=s.count;Nh(d===n-1);let p=0;const m=1===t||2===t?(e,t,i)=>a(e,t,i):(e,t,i)=>a(e,i,t);for(;o<c-1||l<d-1;){const e=s.getVertexIndex(l),t=r.getVertexIndex(o),i=o<c-1,a=l<d-1;i&&(!a||(i?0+n*(o+.5)/(c-1):0)<=(a?1+f*(l+.5)/(d-1):0))?(++o,Bh&&Nh(o<c),m(e,t,r.getVertexIndex(o)),p++):(++l,Bh&&Nh(l<d),m(e,t,s.getVertexIndex(l)),p++)}Bh&&(Nh(o===c-1),Nh(l===d-1),Nh(p===c+d-2),Nh(p===n-2+r.count-1),Nh(_===i+3*p*u))}})(),Nh(_===3*(l+c)*u);const d=i=>{const r=e.outerEdges[i.connectedOuterEdgeOffset];let s=r.getVertexIndex(0),o=r.stride;for(let e=0;e<i.latitudeResolution;++e){const r=0===e?i.rowOffset:s+t;for(let t=0;t<n;t++)a(s,s+1,r+t),e<i.latitudeResolution-1&&a(s+1,r+t+1,r+t),s+=o;s=r,o=1}};i.forEach(d)}else{(()=>{const i=Math.max(s[0],1)-1,a=Math.min(s[1],t-2)-1,n=Math.max(r[0],1)-1,o=Math.min(r[1],t-2)-1;for(let t=i;t<a;++t){const i=t*g;for(let t=n;t<o;++t){const r=i+t,s=r+1,a=s+g,n=a-1,o=e.vertexAttributes.position.typedBuffer,l=e.vertexAttributes.position.typedBufferStride;y(r,s,a,n,l,o)?(m[_]=r,m[_+1]=s,m[_+2]=a,m[_+3]=a,m[_+4]=n,m[_+5]=r):(m[_]=r,m[_+1]=s,m[_+2]=n,m[_+3]=n,m[_+4]=s,m[_+5]=a),_+=6}}})(),Nh(_===3*l*u),(()=>{for(let t=0;t<4;++t){if(h[t])continue;const i=e.outerEdges[t],r=e.innerEdges[t];let s=0,a=0;const o=i.count,l=r.count;Nh(l===n-1);const c=1===t||2===t,d=c?1:2,u=c?2:1,p=i.index0,g=i.stride,y=r.index0,v=r.stride;for(;s<o-1||a<l-1;){const e=y+a*v,t=p+s*g,i=s<o-1,r=a<l-1,h=i&&(!r||(i?0+n*(s+.5)/(o-1):0)<=(r?1+f*(a+.5)/(l-1):0));h?++s:++a;const c=h?t+g:e+v;m[_]=e,m[_+d]=t,m[_+u]=c,_+=3}}})(),Nh(_===3*(l+c)*u);const a=i=>{const r=e.outerEdges[i.connectedOuterEdgeOffset];let s=r.getVertexIndex(0),a=r.stride;for(let e=0;e<i.latitudeResolution;++e){const r=0===e?i.rowOffset:s+t;for(let t=0;t<n;t++){const n=r+t;m[_]=s,m[_+1]=s+1,m[_+2]=n,e<i.latitudeResolution-1?(m[_+3]=s+1,m[_+4]=n+1,m[_+5]=n,_+=6):_+=3,s+=a}s=r,a=1}};i.forEach(a)}Nh(_===p),e.indices=m,e.indexCount=p}function Mw(e,t){const i=e.localOrigin,r=e.geometryInfo,s=e.geometryState.neighborData.edgeResolutions,a=r.numVerticesPerSide-2,n=r.vertexAttributes;let o=t;for(let e=0;e<4;++e){{const t=0===e||2===e,s=(0===e?a-1:0)*a+(1===e?a-1:0),o=(t?0:1)*a+(t?1:0);r.innerEdges[e]=new vx(n,i,s,o,a)}{const t=o,a=s[e]+1;r.outerEdges[e]=new vx(n,i,t,1,a),o+=a}}}function Dw(e,t,i){const r=(t+2)%4,s=e.geometryState,a=e.tile,n=s.neighborData,o=a.level-i.level,l=1===t||3===t,h=n.edgeResolutions[t];Nh(Ji(h));const c=h+1,d=e.geometryInfo,u=d.boundingBox,p=d.outerEdges[t],m=d.uvRange[0],_=d.uvRange[1],g=d.uvRange[2],f=d.uvRange[3],y=Bi(1===t?1:0,m,g),v=Bi(0===t?1:0,_,f),b=i.renderData,x=b.geometryState,T=b.geometryInfo.outerEdges[r],w=a.getNeighborEdgeStartVertexIndex(t,i)*h,C=h*2**o;Nh(x.neighborData.edgeResolutions[r]===C),Nh(T.count-1===C);const S=b.localOrigin[0]-e.localOrigin[0],P=b.localOrigin[1]-e.localOrigin[1],R=b.localOrigin[2]-e.localOrigin[2],O=p.attributes,E=p.index0,A=p.stride,M=O.position.typedBuffer,D=O.position.typedBufferStride,I=O.normalCompressed.typedBuffer,L=O.normalCompressed.typedBufferStride,N=O.uv0,F=T.attributes,U=T.index0,j=T.stride,V=F.position.typedBuffer,k=F.position.typedBufferStride,z=F.normalCompressed.typedBuffer,q=F.normalCompressed.typedBufferStride;for(let e=1;e<c-1;++e){const t=E+A*e,i=U+j*(w+e),r=t*D,s=i*k,a=V[s]+S,n=V[s+1]+P,o=V[s+2]+R;M[r]=a,M[r+1]=n,M[r+2]=o,Ox(a,n,o,u);const c=t*L,d=i*q;I[c]=z[d],I[c+1]=z[d+1];const p=e/h;Sx(N,t,l?y:Bi(p,m,g),l?Bi(p,_,f):v)}}function Iw(e){const t=e.geometryState,i=t.neighborData,r=e.localOrigin,s=i.cornerNeighborData,a=e.geometryInfo,n=a.outerEdges,o=a.boundingBox,l=e.tile,h="local"===e.tile.surface.view?.viewingMode,c=l.ellipsoid.radius,d=l.extentInRadians,u=l.horizontalScale;let p=0,m=0,_=0;const g=h?(()=>{const t=e.geometryState.clippingArea,i=l.extent,r=A(t)&&(i[3]>t[3]||i[2]>t[2]||i[1]<t[1]||i[0]<t[0]),s=Ew(l.surface.isWebMercatorOnPlateeCarree,l.ellipsoid.radius,u);return(e,i,a)=>{const n=0===e?O[0]:O[2],o=0===i?O[1]:O[3],l=r?Bi(n,t[0],t[2]):n,h=r?Bi(o,t[1],t[3]):o,c=a;p=l*u,m=s(h),_=c}})():(e,t,i)=>{const r=d[0===t?1:3],s=d[0===e?0:2],a=Math.cos(r),n=Math.sin(r),o=Math.sin(s),l=Math.cos(s),h=c+i;p=l*a*h,m=o*a*h,_=n*h};let f=0,y=0,v=0,b=0,x=0,T=0,w=0,C=0,S=0;const P=h&&e.tile.surface.isWebMercatorOnPlateeCarree,R=(e,t,i,r,s)=>{let a=0,n=0,o=0;if(h){const e=t*u,s=P?(Math.PI/2-2*Math.atan(Math.exp(-i/c)))*c:i*u;a=e-p,n=s-m,o=r-_}else{const s=Sw(e),l=e.tile,h=l.extent,d=l.extentInRadians,u=(t-h[0])/(h[2]-h[0]),g=(i-h[1])/(h[3]-h[1]),f=d[0]*(1-u)+d[2]*u,y=s(g),v=Math.cos(y),b=Math.sin(y),x=Math.sin(f),T=Math.cos(f),w=c+r;a=T*v*w-p,n=x*v*w-m,o=b*w-_}switch(s){case 0:w+=a,C+=n,S+=o;break;case 1:b-=a,x-=n,T-=o;break;case 2:w-=a,C-=n,S-=o;break;case 3:b+=a,x+=n,T+=o}},O=l.extent,E=t.clippingArea,M=A(E)?E:jw,D=O[0],I=O[2],L=O[1],N=O[3],F=[N>M[3],I>M[2],L<M[1],D<M[0]],U=Math.max(D,M[0]),j=Math.min(I,M[2]),V=Math.max(L,M[1]),k=Math.min(N,M[3]),z=a.uvRange[0],q=a.uvRange[1],G=a.uvRange[2],H=a.uvRange[3],B=e=>{const t=s[e].cornerTiles;f=0,y=0,v=1;let i=1/0;for(let e=0;e<4;++e)i=Math.min(i,t[e]?.level??1/0);for(let e=0;e<4;++e){const r=t[e];Vw[e]=r?.level===i?r:null}let r=1,a=0;for(let e=0;e<4;++e){const t=Vw[e];t&&(r=Math.max(r,t?.renderData.geometryState.numVerticesPerSide),a=t.extent[2]-t.extent[0])}const n=a,o=r;Nh(o>1);const l=n/o;for(let e=0;e<4;++e){const t=Vw[(e+3)%4],i=Vw[e%4];if(!t&&!i)continue;const r=0===e?1:1===e?2:2===e?3:0,s=0===e?2:1===e?3:2===e?0:1;if(t&&i){const a=Fw[e][0]*l,n=Fw[e][1]*l,o=t.extent,h=o[0===r||1===r?2:0]+a,c=o[0===r||3===r?3:1]+n,d=i.extent,u=d[0===s||1===s?2:0]+a,p=d[0===s||3===s?3:1]+n,m=t.renderData,_=i.renderData,g=Jb(h,c,m.geometryState.samplerData),f=Jb(u,p,_.geometryState.samplerData);R(m,h,c,.5*(g+f),e)}else{const a=t??i,n=t?r:s,o=a.extent,h=Fw[e],c=o[0===n||1===n?2:0]+h[0]*l,d=o[0===n||3===n?3:1]+h[1]*l,u=a.renderData,p=Jb(c,d,u.geometryState.samplerData);R(u,c,d,p,e)}}if(!h){const e=Math.sqrt(p*p+m*m+_*_);f=p/e,y=m/e,v=_/e}const c=Math.sqrt(b*b+x*x+T*T);b/=c,x/=c,T/=c;const d=Math.sqrt(w*w+C*C+S*S);if(w/=d,C/=d,S/=d,h||v*v<.999){f=T*C-x*S,y=b*S-T*w,v=x*w-b*C;const e=1/Math.sqrt(f*f+y*y+v*v);f*=e,y*=e,v*=e}};for(let i=0;i<4;++i){const a=i,h=(i+1)%4,c=0===i||1===i?1:0,d=0===i||3===i?1:0,u=Bi(c,z,G),b=Bi(d,q,H),x=n[a],T=0===i||3===i?x.count-1:0,w=n[h],C=0===i||1===i?w.count-1:0,S=s[i].cornerTiles;let P=-1;for(let e=0;e<4;++e){const t=S[e];t&&(-1===P||jx(S[P],t)>0)&&(P=e)}const R=P,O=S[R];if(f=0,y=0,v=1,O!==l){const t=l.level-O.level,r=2**t,s=[O.lij[0]+t,O.lij[1]*r,O.lij[2]*r],a=[s[1]+r===l.lij[1],0===i&&(1===R||0===R&&O!==S[3])||1===i&&(0===R||1===R&&O!==S[2]),s[1]===l.lij[1]+1,2===i&&(3===R||2===R&&O!==S[1])||3===i&&(2===R||3===R&&O!==S[0])],n=a.reduce(((e,t)=>e+(t?1:0)),0);Nh(1===n||2===n);let h=-1,c=-1;const d=O.renderData;if(1===n){const t=a.findIndex((e=>e));Nh(0<=t&&t<=3),h=(t+2)%4;const r=e.geometryState.neighborData.edgeResolutions[t];c=l.getNeighborEdgeStartVertexIndex(t,O)*r+r*(0===t&&0===i||1===t&&0===i||2===t&&1===i||3===t&&3===i?1:0)}else{Nh(a[1]||a[3]),h=a[1]?3:1;const e=d.geometryState.neighborData.edgeResolutions[h];c=0===i||3===i?0:e}const p=d.geometryInfo.outerEdges[h];{const t=x.index0+T*x.stride,i=w.index0+C*w.stride,r=p.index0+c*p.stride;{const s=p.attributes.position,a=s.typedBuffer,n=r*s.typedBufferStride,l=e.localOrigin,h=p.localOrigin,c=a[n]+h[0]-l[0],d=a[n+1]+h[1]-l[1],u=a[n+2]+h[2]-l[2];Ox(c,d,u,o);{const e=x.attributes.position,i=e.typedBuffer,r=t*e.typedBufferStride;i[r]=c,i[r+1]=d,i[r+2]=u}{const e=w.attributes.position,t=e.typedBuffer,r=i*e.typedBufferStride;t[r]=c,t[r+1]=d,t[r+2]=u}}Sx(x.attributes.uv0,t,u,b),Sx(w.attributes.uv0,i,u,b);{const e=p.attributes.normalCompressed.typedBuffer,s=r*p.attributes.normalCompressed.typedBufferStride;{const i=x.attributes.normalCompressed,r=i.typedBuffer,a=t*i.typedBufferStride;r[a]=e[s],r[a+1]=e[s+1]}{const t=w.attributes.normalCompressed,r=t.typedBuffer,a=i*t.typedBufferStride;r[a]=e[s],r[a+1]=e[s+1]}}}}else{let e;e=F[a]||F[h]?Jb(Bi(D*(1-c)+I*c,U,j),Bi(L*(1-d)+N*d,V,k),t.samplerData):Lw(S),g(c,d,e),B(i);const s=p-r[0],n=m-r[1],l=_-r[2];Ox(s,n,l,o),x.setVertexFromValuesRawPositionUVNormal(T,s,n,l,u,b,f,y,v),w.setVertexFromValuesRawPositionUVNormal(C,s,n,l,u,b,f,y,v)}}for(let e=0;e<4;++e)Vw[e]=null}function Lw(e){const t=e.reduce(((e,t)=>Math.min(e,t?.level??1/0)),1/0);Bh&&(Nh(!e[0]||!e[2]||AT(e[0],e[2],id.SOUTH_WEST)),Nh(!e[1]||!e[3]||AT(e[1],e[3],id.NORTH_WEST)));let i=0,r=0;for(let s=0;s<4;++s){const a=e[s];if(a&&a.level===t){const e=0===s||1===s,t=0===s||3===s,n=a.extent,o=n[e?0:2],l=n[t?1:3],h=a.renderData?.geometryState?.samplerData;r+=Jb(o,l,h),i++}}const s=i?r/i:0;return Nh(null!=s),s}function Nw(e){const t=e.vao,i=e.geometryInfo.vertexAttributes.position.typedBuffer;t.vertexBuffers.geometry.setSubData(i,0,0,i.length)}const Fw=[[0,1],[1,0],[0,-1],[-1,0]],Uw=new class{constructor(){this.sinLonLUT=new Array(Bc+1),this.cosLonLUT=new Array(Bc+1),this.sinLatLUT=new Array(Bc+1),this.cosLatLUT=new Array(Bc+1)}update(e,t,i){const r=t[0],s=t[2];for(let t=0;t<=e;t++){const a=t/e,n=r*(1-a)+s*a;this.sinLonLUT[t]=Math.sin(n),this.cosLonLUT[t]=Math.cos(n);const o=i(a);this.sinLatLUT[t]=Math.sin(o),this.cosLatLUT[t]=Math.cos(o)}}},jw=ut(-1/0,-1/0,1/0,1/0),Vw=[null,null,null,null];function kw(e,t,i){if(!t)return!1;const r=jx(e,t);return r>0||0===r&&i>=2}class zw extends TT{get horizontalScale(){return this._horizontalScaleFactor}constructor(e,t,i){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=at(),void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i);const r=i.view.renderSpatialReference,s=i.spatialReference,a=A(r)&&Pr(r)&&A(s)&&s.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=a;const n=this.surface.isWebMercatorOnPlateeCarree,o=this._extentInRenderSR,l=this.extent;if(n){const e=fe(l[0],l[1],0);et(e,Rh.WebMercator,e,Rh.PlateCarree);const t=fe(l[2],l[3],0);et(t,Rh.WebMercator,t,Rh.PlateCarree),o[0]=e[0],o[1]=e[1],o[2]=t[0],o[3]=t[1]}else for(let e=0;e<4;++e)o[e]=l[e]*a;this.centerAtSeaLevel[0]=.5*(o[0]+o[2]),this.centerAtSeaLevel[1]=.5*(o[1]+o[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(o[2]-o[0],o[3]-o[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),r=Math.sqrt(t*t+i*i),s=.5*(this.elevationBounds[0]-this.elevationBounds[1]),a=Math.max(r,s);this._center[OT.MIDDLE][3]=a}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),i=t[0],r=t[1],s=t[2],a=t[3],n=t[4],o=t[5];let l=!0;for(let t=0;t<6;t++){const h=e[t],c=h[0],d=h[1],u=h[2],p=h[3];if(c*(c>0?i:a)+d*(d>0?r:n)+u*(u>0?s:o)+p>=0)return td.OUTSIDE;l=l&&c*(c<0?i:a)+d*(d<0?r:n)+u*(u<0?s:o)+p<=0}return l?td.INSIDE:td.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return eh(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,t,i,r){return qw[0]=1/t[0],qw[1]=1/t[1],qw[2]=1/t[2],ea(this._aabb(),e,qw,i,r)}createGeometry(){(function(e,t){const i=e.tile.extent,r=e.geometryState,s=i[0],a=i[1],n=i[2]-s,o=i[3]-a,l=r.clippingArea,h=A(l)?Math.max(0,(l[0]-s)/n):0,c=A(l)?Math.max(0,(l[1]-a)/o):0,d=A(l)?Math.min(1,(l[2]-s)/n):1,u=A(l)?Math.min(1,(l[3]-a)/o):1,p=r.numVerticesPerSide,m=(p-2)**2,_=Tx(m+r.neighborData.edgeResolutions.reduce(((e,t)=>e+t+1),0)),g=e.geometryInfo,f=g.boundingBox;Jl(f),g.numVerticesPerSide=r.numVerticesPerSide,g.vertexAttributes=_,Dr(g.uvRange,h,c,d,u),function(e){const t=e.tile;if(!t.intersectsClippingArea)return;const i=t.surface,r=e.geometryState,s=r.samplerData,a=e.localOrigin,n=i.isWebMercatorOnPlateeCarree,o=r.clippingArea,l=A(o)?o:jw,h=t.extent,c=h[0],d=h[1],u=h[2],p=h[3],m=Math.max(c,l[0]),_=Math.min(u,l[2]),g=Math.max(d,l[1]),f=Math.min(p,l[3]),y=t.ellipsoid.radius,v=t.horizontalScale,b=r.numVerticesPerSide,x=b-1,T=b-2,w=e.geometryInfo,C=w.vertexAttributes,S=C.position,P=C.uv0,R=C.normalCompressed,O=w.uvRange,E=O[0],M=O[1],D=O[2],I=O[3],L=w.boundingBox,N=a[0],F=a[1],U=a[2],j=S.typedBuffer,V=S.typedBufferStride;let k=0;const z=Bi(d,g,f),q=n?(Math.PI/2-2*Math.atan(Math.exp(-z/y)))*y:z*v,G=1/x,H=Bi(d*(1-G)+p*G,g,f);let B=q,W=n?(Math.PI/2-2*Math.atan(Math.exp(-H/y)))*y:H*v;for(let e=1;e<=T;e++){const t=e/x,i=Bi(d*(1-t)+p*t,g,f),r=Bi(t,M,I),a=W,o=(e-1)/x,l=Bi(d*(1-o)+p*o,g,f),h=B,b=(e+1)/x,w=Bi(d*(1-b)+p*b,g,f),C=n?(Math.PI/2-2*Math.atan(Math.exp(-w/y)))*y:w*v,S=Bi(b,M,I);B=W,W=C;const O=Bi(c,m,_);let A=O*v,z=Jb(O,i,s);const q=1/x,G=Bi(q,E,D),H=Bi(c*(1-G)+u*G,m,_);let $=G,Q=H,X=H*v,Y=Jb(H,i,s);if(1===e){const e=X-N,t=B-F,i=Y-U,s=0*V;j[s]=e,j[s+1]=t,j[s+2]=i,Ox(e,t,i,L),Sx(P,k,Bi(q,E,D),r)}for(let t=1;t<=T;t++){const n=X,o=Y,d=(t+1)/x,p=Bi(d,E,D),g=Bi(c*(1-d)+u*d,m,_),f=Q;Q=g;{const n=k+1,o=n*V;if(1===e||t===T){const l=g*v,h=Jb(g,i,s);if(1===e&&t<T){const e=l-N,t=a-F,i=h-U;j[o]=e,j[o+1]=t,j[o+2]=i,Ox(e,t,i,L),Sx(P,n,p,r)}X=l,Y=h}else X=j[o]+N,Y=j[o+2]+U}const y=X,b=Y,O=A,M=z;A=n,z=o;const I=(k-T)*V,q=1===e?Jb(f,l,s):j[I+2]+U,G=Jb(f,w,s);if(e<T){const e=k+T,t=e*V,i=n-N,r=C-F,s=G-U;j[t]=i,j[t+1]=r,j[t+2]=s,Ox(i,r,s,L);const a=$;$=p,Sx(P,e,a,S)}{const e=y-O,t=h-C,i=t*(b-M),r=e*(q-G),s=-t*e,a=i*i+r*r+s*s;if(0===a)wx(R,k,0,0,1);else{const e=1/Math.sqrt(a);wx(R,k,i*e,r*e,s*e)}}++k}}}(e),Mw(e,m),Pw(e),Aw(g,r.numVerticesPerSide,[],[0,p-1],[0,p-1],r.wireframe),e.intersectionData=null})(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(Ow(e),Rw(e,!0),Nw(e))}updateEdgeElevations(){var e;e=this.renderData,this._horizontalScaleFactor,e.tile.intersectsClippingArea&&(Pw(e),Nw(e))}}const qw=ve();class Gw{constructor(){this.extent=_r(),this.minLevel=0,this.maxLevel=0,this.callback=null}}let Hw=class extends Hi{constructor(){super(...arguments),this._queries=new J({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new J({initialSize:30}),this._queryPool=new vh(Gw)}queryVisibleLevelRange(e,t,i,r){const s=this._queryPool.acquire();Fr(s.extent,e),s.minLevel=t??-Number.MAX_VALUE,s.maxLevel=i??Number.MAX_VALUE,s.callback=r,this._queryQueue.push(s),this.notifyChange("updating")}get updating(){return 0!==this._queryQueue.length}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let i=0;for(;i<this._queriesInvPtr;){const r=this._queries.data[i],s=r.extent;t>=r.minLevel&&t<=r.maxLevel&&s[0]<=e.extent[2]&&s[2]>=e.extent[0]&&s[1]<=e.extent[3]&&s[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};e([ce()],Hw.prototype,"updating",null),Hw=e([ue("esri.views.3d.terrain.ScaleRangeQueries")],Hw);class Bw extends TT{get convexHull(){return this._convexHull}constructor(e,t,i){super(),this._convexHull=new Array(24),this._boundingSphere=Mo(),void 0!==e&&this.init(e,t,i)}init(e,t,i){super.init(e,t,i);const r=this.ellipsoid.radius,s=this.extentInRadians[0],a=this.extentInRadians[1],n=this.extentInRadians[2],o=this.extentInRadians[3],l=e[0],h=Qi(a,o,.5),c=Qi(s,n,.5),d=0===l?0:Math.min(Math.abs(a),Math.abs(o));this._edgeLen=(n-s)*Math.cos(d)*r,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=r-Math.sqrt(r*r-this._edgeLen2/4),tt(this.centerAtSeaLevel,c,h,this.ellipsoid.radius),be(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(0===this.lij[0])Pe(e[OT.MIDDLE],0,0,0),Pe(e[OT.TOP],0,0,0),Pe(e[OT.BOTTOM],0,0,0),e[OT.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const s=e[OT.MIDDLE],a=this.convexHull;let n=0;for(let e=0;e<8;++e)n=Math.max(n,(i=a,r=3*e,$w((t=s)[0],t[1],t[2],i[r],i[r+1],i[r+2])));e[OT.MIDDLE][3]=Math.sqrt(n)}var t,i,r}_calculateFrustumVisibilityStatus(e){if(!mh(e,this._boundingSphere))return td.OUTSIDE;if(this.lij[0]<10)return td.INTERSECTS;const t=this.convexHull,i=this.surface.view.state.camera.near;let r=!0;for(let s=0;s<_h.NUM;s++){const a=s===ph.NEAR,n=e[s],o=n[0],l=n[1],h=n[2],c=n[3]-(a?i:0);let d=!1;for(let e=0;e<8;++e){const i=3*e;if(o*t[i]+l*t[i+1]+h*t[i+2]+c<0){if(d=!0,!r)break}else r=!1}if(!d)return td.OUTSIDE}return r?td.INSIDE:td.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){(function(e,t){const i=e.tile,{extent:r,extentInRadians:s,surface:a}=i,n=e.localOrigin,o=e.geometryState,l=a.isWebMercator,h=o.numVerticesPerSide,c=h-1,d=(h-2)**2,u=l&&(t===sd.HAS_SOUTH_POLE||t===sd.HAS_BOTH_POLES),p=l&&(t===sd.HAS_NORTH_POLE||t===sd.HAS_BOTH_POLES),m=6*((u?1:0)+(p?1:0))*(c+1),_=o.neighborData,g=_.edgeResolutions.reduce(((e,t)=>e+t+1),0),f=Tx(d+m+g),y=e.geometryInfo;y.numVerticesPerSide=o.numVerticesPerSide,y.vertexAttributes=f;const v=y.boundingBox;Jl(v);const b=Sw(e);Uw.update(c,s,b),function(e){const t=e.tile;if(!t.intersectsClippingArea)return;const i=e.geometryState,r=i.numVerticesPerSide,s=r-2,a=r-1,n=e.geometryInfo,o=n.vertexAttributes,l=o.position,h=o.uv0,c=o.normalCompressed,d=t.extent,u=d[0],p=d[2],m=d[1],_=d[3],g=t.ellipsoid.radius,f=i.samplerData,y=e.localOrigin,v=y[0],b=y[1],x=y[2],T=l.typedBuffer,w=l.typedBufferStride,C=1/a,S=n.boundingBox;let P=0;if(1<=s){const e=C,t=m*(1-e)+_*e,i=Uw.sinLatLUT[1],r=Uw.cosLatLUT[1];for(let a=1;a<=s;a++){const s=a*C,n=u*(1-s)+p*s,o=Uw.sinLonLUT[a],l=Uw.cosLonLUT[a],c=g+Jb(n,t,f),d=c*l*r-v,m=c*o*r-b,_=c*i-x;Ox(d,m,_,S);const y=(a-1)*w;T[y]=d,T[y+1]=m,T[y+2]=_,Sx(h,a-1,s,e)}}for(let e=1;e<=s;e++){const t=e*C,i=m*(1-t)+_*t,r=Uw.sinLatLUT[e],n=Uw.cosLatLUT[e],o=e+1,l=o*C,d=m*(1-l)+_*l,y=Uw.sinLatLUT[o],R=Uw.cosLatLUT[o],O=Uw.sinLonLUT[0],E=Uw.cosLonLUT[0],A=g+Jb(u,i,f);let M=E*n*A-v,D=O*n*A-b,I=r*A-x;const L=P*w;let N=T[L],F=T[L+1],U=T[L+2];for(let t=1;t<=s;t++){const o=t*C,_=u*(1-o)+p*o,O=Uw.sinLonLUT[t],E=Uw.cosLonLUT[t];let A=0,L=0,j=0;if(t<s){const e=(P+1)*w;A=T[e],L=T[e+1],j=T[e+2]}else{const e=Uw.sinLonLUT[a],t=Uw.cosLonLUT[a],s=g+Jb(p,i,f);A=t*n*s-v,L=e*n*s-b,j=r*s-x}const V=M,k=D,z=I;M=N,D=F,I=U,N=A,F=L,U=j;const q=A-V,G=L-k,H=j-z;let B=0,W=0,$=0;if(e>1){const e=(P-s)*w;B=T[e],W=T[e+1],$=T[e+2]}else{const e=Uw.sinLatLUT[0],t=Uw.cosLatLUT[0],i=g+Jb(_,m,f);B=E*t*i-v,W=O*t*i-b,$=e*i-x}const Q=g+Jb(_,d,f),X=E*R*Q-v,Y=O*R*Q-b,Z=y*Q-x;if(e<s){const e=P+s,t=e*w;T[t]=X,T[t+1]=Y,T[t+2]=Z,Ox(X,Y,Z,S),Sx(h,e,o,l)}const K=B-X,J=W-Y,ee=$-Z;let te=E*n,ie=O*n,re=r;re*re<.999&&(te=H*J-G*ee,ie=q*ee-H*K,re=G*K-q*J);const se=1/Math.sqrt(te*te+ie*ie+re*re);wx(c,P,te*se,ie*se,re*se),++P}}}(e),Mw(e,d),xw(e);const x=[];if((()=>{let e=d+g;const t=n[0],s=n[1],a=n[2],o=i.ellipsoid.radius,l=r[1],m=r[3],_=(i,r)=>{const n=r*h;Ox(-t,-s,i*o-a,v),x.push({connectedRowOffset:n,connectedOuterEdgeOffset:1===i?0:2,rowOffset:e,latitudeResolution:6});const d=Cw(-1===i?l:m,o),u=i*Math.PI/2-d,p=.99*(1===i?1:-1),_=o+0,g=f.position,y=f.uv0,b=f.normalCompressed;for(let i=1;i<=6;++i){const r=d+u*(i/6),n=Math.cos(r),o=Math.sin(r);for(let i=0;i<=c;i++){const r=i/c,l=Uw.sinLonLUT[i],h=Uw.cosLonLUT[i]*n,d=l*n,u=o,m=h*_-t,f=d*_-s,x=u*_-a;Ox(m,f,x,v),g.setValues(e,m,f,x),Sx(y,e,r,p),wx(b,e,h,d,u),++e}}};u&&_(-1,0),p&&_(1,c)})(),Aw(y,o.numVerticesPerSide,x,[0,h-1],[0,h-1],o.wireframe),e.intersectionData=null,Bh)for(let e=0;e<4;++e)Nh(y.outerEdges[e].count===_.edgeResolutions[e]+1)})(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),Bh&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=e,i=this.elevationBounds,r=this.ellipsoid.radius,s=i[1];if(0===this.level)Pe(t,0,0,0),e[3]=r+s;else{const s=this.extentInRadians,a=.5*(s[0]+s[2]),n=s[1],o=s[3];Qw(Yw,a,n,r),Qw(Zw,a,o,r),Oe(t,Yw,Zw);const l=.5*(i[0]+i[1]);Te(t,t,(r+l)/He(t));const h=this.convexHull;let c=0;const d=(e,t)=>{const i=e[0]-h[3*t],r=e[1]-h[3*t+1],s=e[2]-h[3*t+2];return Math.sqrt(i*i+r*r+s*s)};for(let e=0;e<8;++e){const i=d(t,e);c=Math.max(c,i)}const u=c;e[3]=u+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(0===this.level)return;const i=this.elevationBounds,r=this._getPatchType(),s=this.surface.isWebMercator,a=s&&r===sd.HAS_NORTH_POLE,n=s&&r===sd.HAS_SOUTH_POLE,o=n||a,l=Math.PI/2,h=e[0],c=e[2],d=n?-l:e[1],u=a?l:e[3],p=.5*(h+c),m=i[0],_=t+(o?Math.min(0,m-1):m),g=(e,t,i)=>Qw(e,t,i,_),f=ve(),y=ve(),v=ve(),b=ve();g(f,h,d),g(y,h,u),g(v,c,u),g(b,c,d);const x=(e,t)=>{for(let i=0;i<3;++i)this._convexHull[3*t+i]=e[i]};x(f,0),x(y,1),x(v,2),x(b,3);const T=i[1],w=t+(o?Math.max(0,T+1):T),C=ve(),S=ve(),P=ve();Qw(S,p,u,_),Qw(P,p,d,_),Oe(C,S,P),be(C,C);const R=ve(),O=ve(),E=(e,t)=>{Re(O,e,t),be(O,O);const i=-xe(e,R)/xe(O,R);Nh(i>=0),Te(O,O,i),Oe(e,e,O)};if(2**this.lij[0]>2*this.lij[1]){const e=P,t=ve();Ae(t,Xw,e),be(t,t),Ae(R,e,t),be(R,R),Nh(Jh(xe(R,e)/He(e),0)),E(f,y),E(b,v),x(f,0),x(b,3)}else if(2**this.lij[0]!==2*this.lij[1]){const e=S,t=ve();Ae(t,Xw,e),be(t,t),Ae(R,t,e),be(R,R),E(y,f),E(v,b),x(y,1),x(v,2)}const A=(e,t)=>{const i=w/xe(t,C);for(let r=0;r<3;++r)this._convexHull[3*e+r]=t[r]*i};A(4,f),A(5,y),A(6,v),A(7,b)}_getPatchType(){const e=this.lij[1],t=0===e,i=e===(1<<this.level)-1;return t?i?sd.HAS_BOTH_POLES:sd.HAS_NORTH_POLE:i?sd.HAS_SOUTH_POLE:sd.REGULAR}intersectsRay(e,t,i,r){const s=this._boundingSphere,a=s[3]+i,n=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],o=s[0]-e[0],l=s[1]-e[1],h=s[2]-e[2],c=(o*t[0]+l*t[1]+h*t[2])/n,d=t[0]*c-o,u=t[1]*c-l,p=t[2]*c-h;return d*d+u*u+p*p<a*a}getDefaultVerticesPerSide(){return this.level<Ww.length?Ww[this.level]+1:2}updateCornerElevations(){var e;(e=this.renderData).tile.intersectsClippingArea&&(ww(e),Tw(e,!0),Nw(e)),this._updateBoundingVolumes()}updateEdgeElevations(){var e;(e=this.renderData).tile.intersectsClippingArea&&(xw(e),Nw(e)),this._updateBoundingVolumes()}_checkBVs(){if(!Bh)return;if(this.level<=2)return;const e=this._boundingSphere,t=e[3],i=e,r=ve(),s=this.ellipsoid.radius,a=this.elevationBounds;a[1],a[0];const n=s+a[0],o=this._center[OT.MIDDLE][3],l=this.convexHull,h=(e,t)=>{for(let i=0;i<3;++i)e[i]=l[3*t+i]};{const e=ve(),t=ve(),i=ve(),r=ve(),s=ve(),a=(a,n,o,l)=>{h(t,a),h(i,n),h(r,o),Re(t,t,i),Re(r,r,i),Ae(e,t,r),be(e,e);const c=xe(e,i);h(s,l);const d=xe(e,s),u=Math.abs(d-c);Nh(Jh(u,0),`Non coplanar ${a},${n},${o},${l} diff = ${u}`)};a(0,1,2,3),a(4,5,6,7),a(0,1,4,5),a(1,2,5,6),a(2,3,6,7),a(3,0,7,4)}const c=Ld(24),d=ve(),u=ve(),p=ve(),m=ve(),_=(e,t,i,r)=>{h(d,t),h(u,i),h(p,r),Re(d,d,u),be(d,d),Re(p,p,u),be(p,p),Ae(m,d,p),be(m,m);const s=xe(m,u);((e,t,i)=>{const r=4*e;for(let e=0;e<3;++e)c[r+e]=t[e];c[r+3]=i})(e,m,s)};_(0,0,1,2),_(1,1,0,4),_(2,1,5,2),_(3,3,2,6),_(4,4,0,3),_(5,4,6,5);const g=(e,t,i,r)=>{const s=4*e;return c[s]*t+c[s+1]*i+c[s+2]*r-c[s+3]},f=(e,t,i,r)=>g(e,t,i,r)>=-1,y=(e,t)=>f(e,t[0],t[1],t[2]),v=2**this.lij[0]>2*this.lij[1],b=(e,r,s)=>Math.sqrt($w(e,r,s,i[0],i[1],i[2]))<t,x=e=>b(e[0],e[1],e[2]),T=this.extentInRadians,w=.5*(T[0]+T[2]),C=T[1],S=T[3],P=ve(),R=ve();Qw(P,w,S,n),Qw(R,w,C,n);const O=v?"Upper":"Lower";let E=!0;for(let e=0;e<6;++e){for(let t=0;t<8;++t){const i=3*t,r=f(e,l[i],l[i+1],l[i+2]);E&&(E=r),Nh(r,`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}Nh(y(e,R),`Tile[${this.lij}] (${O}) bottom mid outside of plane ${e}`),Nh(y(e,P),`Tile[${this.lij}] (${O}) top mid outside of plane ${e}`)}Nh(E,"Not all convex hull points are inside  convex hull polyhedron"),Nh(x(R),`Tile[${this.lij}] (${O}) bottom mid outside of bounding sphere`),Nh(x(P),`Tile[${this.lij}] (${O}) top mid outside of bounding sphere`);for(let e=0;e<8;++e){const t=b((A=l)[M=3*e],A[M+1],A[M+2]);Nh(t,`Tile[${this.lij}] Convex hull point ${e} outside of bounding sphere`)}var A,M;for(let e=0;e<6;++e)for(let t=0;t<8;++t){const i=3*t;f(e,l[i],l[i+1],l[i+2])||console.error(`Tile[${this.lij}] Convex hull point ${t} outside of plane ${e}`)}const D=this.extentInRadians,I=Math.max(D[2]-D[0],D[3]-D[1]),L=Math.round(I*s),N=this.renderData;if(!N)return;const{geometryInfo:F,localOrigin:U}=N,j=F.vertexAttributes?.position;if(!j)return;const V=j.count,k=ve(),z=F.numVerticesPerSide-2,q=z*z,G=N.geometryState.neighborData,H=G.edgeResolutions.reduce(((e,t)=>e+t+1),0);for(let e=0;e<V;++e){const n=e<q,l=!n&&e<q+H;let h=!1,c=-1;if(l){let t=q;for(let i=0;i<4;++i){const r=G.edgeResolutions[i];if(e===t||e===t+r-1){h=!0;break}if(t+=r,e<t){c=i;break}}}const d=l?G.edgePeerNeighbors[c]:null,u=l&&d&&jx(this,d)>0;j.getVec(e,r),Oe(k,r,U);const p=He(k)-s;let m=0,_=!1;const y=a[0]-p,v=p-a[1],b=y>1,x=v>1,T=b||x,w=()=>{const t=n?"internal":l&&!h?"edge":h?"corner":"pole";return`Tile[${this.lij}].vertex[${e}]:${t}`+(b?"(below)":x?"(above)":"")+(u?"(Neighbor)":"")},C=Ge(k,i);if(C>=t+0){const e=C-t;T||(console.error(`${w()} is out of the bounding sphere by ${e.toFixed(0)} / ${t.toFixed(0)}[tol=0] h=${p.toFixed(0)} / [${a[0].toFixed(0)}..${a[1].toFixed(0)}] (${(e/t).toFixed(0)})`),_=!0)}for(let i=0;i<6;++i)if(!f(i,k[0],k[1],k[2])){const r=g(i,k[0],k[1],k[2]),s=e%z,n=(e-s)/z;0===i&&y||5===i&&v||(console.error(`${w()} (${s},${n})|${z}] is out of the bounding trapezoid plane ${i} h=${Math.round(p)} / [${Math.round(a[0])}..${Math.round(a[1])}] dist=${Math.round(r)} radii = ${Math.round(t)}/${Math.round(o)}} : maxL = ${L}`),++m)}if(_||m>0)break}}}const Ww=[128,64,64,32,16,8,8,4];function $w(e,t,i,r,s,a){const n=r-e,o=s-t,l=a-i;return n*n+o*o+l*l}const Qw=(e,t,i,r)=>{const s=Math.cos(t),a=Math.sin(t),n=Math.cos(i),o=Math.sin(i);e[0]=r*n*s,e[1]=r*n*a,e[2]=r*o},Xw=[0,0,1],Yw=ve(),Zw=ve();let Kw=class extends Hi{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};e([ce()],Kw.prototype,"fovX",void 0),e([ce()],Kw.prototype,"fovY",void 0),e([ce()],Kw.prototype,"relativeWidthLimit",void 0),e([ce()],Kw.prototype,"relativeHeightLimit",void 0),e([ce()],Kw.prototype,"maxLod",void 0),e([ce()],Kw.prototype,"angledSplitBias",void 0),e([ce()],Kw.prototype,"aboveGround",void 0),e([ce()],Kw.prototype,"frustum",void 0),Kw=e([ue("esri.views.3d.terrain.SplitLimits")],Kw);class Jw extends Aa{constructor(){super(...arguments),this.blendMode=Jx.Normal}}e([Ea({count:Jx.COUNT})],Jw.prototype,"blendMode",void 0);class eC extends Jw{constructor(){super(...arguments),this.output=hT.Composite,this.baseOpacityMode=cT.NotRequired,this.premultipliedSource=dT.Off}}var tC;e([Ea({count:hT.COUNT})],eC.prototype,"output",void 0),e([Ea({count:cT.COUNT})],eC.prototype,"baseOpacityMode",void 0),e([Ea()],eC.prototype,"premultipliedSource",void 0),function(e){e[e.BelowLayer=0]="BelowLayer",e[e.Only=1]="Only",e[e.COUNT=2]="COUNT"}(tC||(tC={}));const iC=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return tC},build:function(e){const t=new Vs;if(t.include(rT),e.background===tC.Only){const i=e.output===hT.ColorComposite;return i?t.fragment.uniforms.add(new Is("backgroundColor",(e=>e.backgroundColor))):t.fragment.include(oT),t.fragment.code.add(Fs`
    void main() {
      fragColor = vec4(${i?Fs`backgroundColor`:Fs`gridColor(uv)`}, 1.0);
    }
  `),t}return t.include(uT,e),t.fragment.uniforms.add(new qs("tex",(e=>e.texture))),t.fragment.uniforms.add(new Ns("opacity",(e=>e.opacity))),t.fragment.code.add(Fs`void main() {
vec4 bgColor = getBackground(uv);
fragColor = blendLayers(bgColor, texture(tex, uv), opacity);
}`),t}},Symbol.toStringTag,{value:"Module"}));class rC extends iT{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Ve}}class sC extends Hs{initializeProgram(e){return new Bs(e.rctx,sC.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:Sa(na.ONE,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca})}}sC.shader=new Ws(iC,(()=>Promise.resolve().then((()=>iC))));class aC extends eC{constructor(){super(...arguments),this.background=tC.BelowLayer}}e([Ea()],aC.prototype,"background",void 0);class nC{constructor(e,t,i,r,s,a){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=fr(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=fe(r,s,a)}destroy(){this.texture.release()}}class oC{constructor(){this._renderParams={context:null,drawPhase:1,state:new Ud({viewpoint:new r({targetGeometry:new Ph(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null}}dispose(){this._renderParams=null}render(e,t,i,r,s,a,n,o,l,h){const c=a.adjustLevel(t[0]),d=this._renderParams;d.context=e,d.painter=r,d.glyphMosaic=r.glyphMosaic,d.spriteMosaic=r.spriteMosaic,d.pixelRatio=h,d.displayLevel=c,d.requiredLevel=c;const u=a.getScale(t[0]),[p,m]=a.getShift(t,n*u),_=.125*n*u/l,g=i.transforms.dvs;g[0]=_,g[4]=-_,g[6]=-1-p-o[0]*n*2,g[7]=1+m+(1-o[1])*n*2-2,d.state.size[0]=l,d.state.size[1]=l,i.stage||i.attachWithContext(e),i.triangleCount=0,r.drawTile(d,i,s)}}class lC extends Hs{initializeProgram(e){return new Bs(e.rctx,lC.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:Sa(na.ONE,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca})}}lC.shader=new Ws(mT,(()=>Promise.resolve().then((()=>mT))));class hC extends eC{constructor(){super(...arguments),this.colorizerType=Zx.Stretch,this.stretchType=Kx.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}}e([Ea({count:Zx.COUNT})],hC.prototype,"colorizerType",void 0),e([Ea({count:Kx.COUNT})],hC.prototype,"stretchType",void 0),e([Ea()],hC.prototype,"applyColormap",void 0),e([Ea()],hC.prototype,"requireBilinearWithNN",void 0);class cC{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach((e=>e.dispose())),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const i=new hn(this._rctx,{colorTarget:ca.TEXTURE,depthStencilTarget:fa.DEPTH_RENDER_BUFFER,width:e,height:e});return this._fbos.set(e,i),i}}const dC=E.getLogger("esri.views.3d.terrain");class uC{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._fbos=[],this._vectorTileHelper=new oC,this._bindParameters=new fn(null,null,null),this._blendLayersTechniqueConfig=new aC,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=Ma(this._rctx,Da)}dispose(){this._fbos.forEach(F),this._fbos=null,this._vtFBO=F(this._vtFBO),this._vaoQuad=F(this._vaoQuad),this._vectorTileHelper=F(this._vectorTileHelper),this._backgroundTechnique=N(this._backgroundTechnique),this._applyOpacityTechnique=N(this._applyOpacityTechnique),this._blendLayersTechnique=N(this._blendLayersTechnique)}_getBlendLayersTechnique(e,t,i,r=dT.Off,s=tC.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=r,this._blendLayersTechniqueConfig.background=s,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(sC,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const i=this._getBlendLayersTechnique(Jx.Normal,t?hT.ColorComposite:hT.GridComposite,cT.NotRequired,dT.Off,tC.Only),r=this._rctx.bindTechnique(i,e,this._bindParameters);this._render(r)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(la.TRIANGLE_STRIP,0,cn(this._vaoQuad,"geometry"))}drawGroup(e,t,i,r,s,a=dT.On){t===hT.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const n=this._getBlendLayersTechnique(r,t,s,a),o=this._rctx.bindTechnique(n,e,this._bindParameters);this._render(o)}drawRasterData(e,t,i,r,s,a=dT.Off){if(M(e.texture))return;e.fboTexture=t===hT.GroupBackgroundComposite||r===Jx.Normal&&s===cT.NotRequired&&a===dT.Off?null:this.switch(i).colorTexture;const n=this._getBlendLayersTechnique(r,t,s,a),o=this._rctx.bindTechnique(n,e,this._bindParameters);this._render(o)}drawImageryTileData(e,t,i,r,s,a){const n=a.sourceLayerInfo.data;if(!n.source)return;if(a.tile.surface.layerViewByIndex(a.layerIndex,sx.MAP).ensureSymbolizerParameters(n),!n.bind(this._rctx))return;e.fboTexture=r===Jx.Normal&&s===cT.NotRequired?null:this.switch(i).colorTexture;const o=this._getRasterColorizerTechnique(n,t,r,s);n.opacity=e.opacity;const l=n.getUniforms();l.scale=a.scale,l.offset=a.offset,l.backgroundColor=e.backgroundColor,l.fboTexture=e.fboTexture,l.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(o,l,null);this._render(h)}_getRasterColorizerTechnique(e,t,i,r){const s=e.symbolizerParameters,a=["stretch","lut","hillshade"].indexOf(s.type);return M(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new hC,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=r,this._rasterColorizerConfig.colorizerType=a,this._rasterColorizerConfig.applyColormap=!!s.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?Kx.Noop:Kx.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(lC,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,i,r,s,a,n,o,l){const h=this._rctx,c=a.sourceLayerInfo.data,d=a.tile.surface.layerViewByIndex(a.layerIndex,sx.MAP),u=s===cT.Required||e.opacity<1||r!==Jx.Normal||t!==hT.Composite,p=u?dT.On:dT.Off;this._getBlendLayersTechnique(r,t,s,p).bindPipelineState(h);let m=null,_=null;u?(_=this.currentFBO(i),M(this._vtFBO)&&(this._vtFBO=new cC(this._rctx)),m=this._vtFBO.get(i),h.bindFramebuffer(m),this._clearCurrentFBO()):l&&h.clearSafe(ya.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(h,a.sourceLod,c,d.painter,d.layer.styleRepository,d.schemaHelper,Math.round(1/a.scale),a.offset,o,n)}catch(e){dC.warnOnce("A render call containing vector tiles did not resolve correctly.",e)}return!A(m)||(h.bindFramebuffer(_),e.texture=m.colorTexture,e.offset=qr,e.scale=1,this.drawRasterData(e,t,i,r,s,p),l)}copyFBOToTexture(e){const t=this._rctx,i=t.bindTexture(e.texture,Zn.TEXTURE_UNIT_FOR_UPDATES),r=e.descriptor;t.gl.copyTexImage2D(da.TEXTURE_2D,0,r.pixelFormat,0,0,r.width,r.height,0),e.generateMipmap(),t.bindTexture(i,Zn.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(ya.COLOR_BUFFER_BIT|ya.DEPTH_BUFFER_BIT)}_initFBO(e,t,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,i=!0){if(this._current=t,t>=this._fbos.length)for(let e=this._fbos.length;e<=t;e++)this._fbos.push(new cC(this._rctx));this._initFBO(this._fbos[t].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}}class pC{constructor(e,t,i,r){this.start=e,this.end=t,this.blendMode=i,this.opacity=r}}class mC{constructor(e,t,i){this._rctx=e,this.tileSize=t,this._techniqueRepository=i,this._passParameters=new rC,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new uC(this._rctx,this._techniqueRepository),this._blackTex=new bT(Fa(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=F(this._composition),this._backgroundTexture=N(this._backgroundTexture),this._blackTex=N(this._blackTex)}get backgroundIsGrid(){return M(this._backgroundColor)}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const i=e.surface,r=i.baseOpacity;let s=0,a=0,n=this.tileSize,o=!1;const l=i.view.state.contentPixelRatio;let h=!1;TC.clear(),wC.length=0;const c=e.layerInfo[sx.MAP];let d=c.length,u=0;for(;u<c.length;u++){const t=i.layerViewByIndex(u,sx.MAP),p=t.layer.opacity;vC[u]=p;const m=t.fullOpacity;if(bC[u]=m,zt(t.layer)&&d>=c.length&&(d=u),kh(t)){xC[u]=t.layer.blendMode;let e="normal"!==t.layer.blendMode;if(kt(t.layer.parent)){const i=gC(t.layer.parent);A(i)&&""!==i&&(e=fC(t.layer.parent)||e)}e&&(h=e,o=!1)}if(0===p&&!h){c[u].pendingUpdates&=~(xT.TEXTURE_NOFADING&xT.TEXTURE_FADING);continue}++a;const _=_C(e,u);if(_){if(c[u].pendingUpdates&=~(xT.TEXTURE_NOFADING&xT.TEXTURE_FADING),kt(t.layer.parent)){const e=gC(t.layer.parent);A(e)&&""!==e&&yC(t.layer.parent,u)}ic(t)?n=Math.max(n,this.tileSize*l):1===r&&1===m&&(t.isOpaque||this._dataToTexture(_)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(o=!0),++s}}this._rctx.type===jd.WEBGL1&&(n=function(e){const t=Ki(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}(n));const p=n/this.tileSize,m=u-1;this._ensureBackgroundTexture(this.tileSize),0!==s?1===s&&!h&&this._useLayerTexture(e,m,d,bC[m])||this._composeMapLayers(e,t,m,d,vC,xC,n,p,!o||h,TC,h):this._useBackgroundTexture(e,a)}_ensureBackgroundTexture(e){M(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=qr,this._passParameters.scale=1,this._passParameters.opacity=1,A(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,A(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}_useBackgroundTexture(e,t){let i=Ix.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(i=Ix.Delayed);const r=e.renderData;this._backgroundTexture&&M(r.textureReference)&&(i=Ix.Immediate),r.setTextureReference(A(this._backgroundTexture)?new nC(this._backgroundTexture,ed.FADING,SC,e.surface.baseOpacity,0,1):null,i)}_useLayerTexture(e,t,i,r){const s=t<i,a=s?1:e.surface.baseOpacity,n=s?e.surface.baseOpacity:1,o=_C(e,t);return!!this._dataToTexture(o)&&(e.renderData.setTextureReference(new nC(o.sourceLayerInfo.data,ed.FADING,o,a,n,r)),!0)}_composeMapLayers(e,t,i,r,s,a,n,o,l,h,c){this._composition.ensureBuffer(n);const d=e.surface.baseOpacity;let u=!1,p=_a.LINEAR_MIPMAP_LINEAR,m=!1,_=0;for(let t=i;t>=0;t--){const i=_C(e,t);if(!i)continue;if(0===s[t]&&!c)continue;const g=t<r&&d<1&&!u;this._passParameters.baseOpacity=g?d:1;const f=this._passParameters.baseOpacity<1?cT.Required:cT.NotRequired;g&&(u=!0);let y=!1;h.forEach((e=>{e.start===t&&(wC.push(e),this._composition.openGroup(n),y=!0)}));const v=0===_,b=y?hT.GroupBackgroundComposite:l&&v?this.backgroundIsGrid?hT.GridComposite:hT.ColorComposite:hT.Composite,x=nT[a[t]];for(rc(i)?(this._passParameters.opacity=s[t],m=this._composition.drawVectorData(this._passParameters,b,n,x,f,i,o,this.tileSize,m)):sc(i)?(this._passParameters.opacity=s[t],this._composition.drawImageryTileData(this._passParameters,b,n,x,f,i),this._hasNearestInterpolation(i)&&(p=_a.NEAREST)):this._dataToTexture(i)&&(this._passParameters.texture=i.sourceLayerInfo.data.texture,this._passParameters.offset=i.offset,this._passParameters.scale=i.scale,this._passParameters.opacity=s[t],this._composition.drawRasterData(this._passParameters,b,n,x,f));wC.length>0&&wC[wC.length-1].end===t;){const e=wC.pop();this._passParameters.opacity=e.opacity,this._passParameters.offset=qr,this._passParameters.scale=1;const t=l&&v?this.backgroundIsGrid?hT.GridComposite:hT.ColorComposite:hT.Composite;this._composition.drawGroup(this._passParameters,t,n,nT[e.blendMode],f)}_++}const g=e.renderData,f=g.ensureTexture(n,(()=>this._buildTexture(n,p)));this._composition.copyFBOToTexture(f),this._composition.unbind(),g.setTextureReference(new nC(f,t,SC,u?1:d,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_dataToTexture(e){if(ac(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return nc(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t=_a.LINEAR_MIPMAP_LINEAR){if(M(e))return null;const i={target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,preMultiplyAlpha:!0,flipped:!0,hasMipmap:!0},r=this._rctx;let s;if("number"==typeof e)i.width=i.height=e,s=new bT(new Zn(r,i));else if(e instanceof Vh)i.isOpaque=e.isOpaque,s=new bT(new Zn(r,i,e.image)),e.release();else try{i.width=e.width,i.height=e.height,s=new bT(new Zn(r,i,e))}catch(e){s=new bT(Ua(r)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=r.bindTexture(s.texture,Zn.TEXTURE_UNIT_FOR_UPDATES);return s.generateMipmap(),r.bindTexture(a,Zn.TEXTURE_UNIT_FOR_UPDATES),s}get test(){return{backgroundTexture:this._backgroundTexture}}}function _C(e,t){CC.layerIndex=t;const i=e.layerInfo[sx.MAP][t];if(A(i.data))return Rr(CC.offset,0,0),CC.tile=e,CC.scale=1,CC.sourceLod=e.lij,CC.sourceLayerInfo=i,CC;const r=i.upsampleInfo;if(A(r)){const e=r.tile.layerInfo[sx.MAP][t];return CC.tile=r.tile,Or(CC.offset,r.offset),CC.scale=r.scale,CC.sourceLod=r.tile.lij,CC.sourceLayerInfo=e,CC}return null}function gC(e){return e.get("uid")}function fC(e){let t="normal"!==e.blendMode;return kt(e.parent)&&(t=fC(e.parent)||t),t}function yC(e,t){kt(e.parent)&&yC(e.parent,t);const i=gC(e);if(A(i)&&""!==i){const r=TC.get(i);r?r.start=t:TC.set(i,new pC(t,t,e.blendMode,e.opacity))}}const vC=new Array,bC=new Array,xC=new Array,TC=new Map,wC=new Array,CC={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},SC={offset:[0,0],scale:1},PC=1e-6;class RC{constructor(e,t,i,r,s){this.aabb=e,this.axis=t,this.d=i,this.midStartIndex=r,this.rightStartIndex=s}}class OC{constructor(e,t,i,r){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positionAttribute=r,this._rayDirection=ve(),this.bspNodeTree=new Array;const s=i-t,a=s<=DC?new Uint16Array(s):new Uint32Array(s);this.indices=a;for(let e=0;e<s;++e)a[e]=e;{const n=function(e,t,i,r,s){const a=i-t,n=new Float32Array(6*a);for(let i=0;i<a;++i){const a=3*(i+t),o=e[a]*s,l=e[a+1]*s,h=e[a+2]*s;for(let e=0;e<3;++e){const t=r[o+e],s=r[l+e],a=r[h+e];n[6*i+e]=Math.min(t,s,a),n[6*i+3+e]=Math.max(t,s,a)}}return n}(e,t,i,r.data,r.stride),o=Bi(Math.log2(s/40),2,10),l=(e,t,i)=>{const r=function(e,t,i,r){if(r<=i)return th(NaN,NaN,NaN,NaN,NaN,NaN);{const r=6*e[i];for(let e=0;e<3;++e)AC[e]=t[r+0+e],MC[e]=t[r+3+e]}for(let s=i+1;s<r;++s){const i=6*e[s];for(let e=0;e<3;++e)AC[e]=Math.min(AC[e],t[i+0+e]),MC[e]=Math.max(MC[e],t[i+3+e])}return th(AC[0],AC[1],AC[2],MC[0],MC[1],MC[2])}(a,n,e,t),s=t-e;if(s<=40){const i=new RC(r,void 0,0,e,t);return this.bspNodeTree.push(i),i}const{axis:h,midValue:c}=function(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}(r),d=function(e,t,i,r,s,a){let n=i,o=r;for(;n<o;){const i=e[n];t[6*i+s+3]<=a?++n:(--o,e[n]=e[o],e[o]=i)}let l=n;for(o=r;l<o;){const i=e[o-1];t[6*i+s]>=a?--o:(e[o-1]=e[l],e[l]=i,++l)}return{next:n,mid:l}}(a,n,e,t,h,c),u=(e,t)=>{if(i>o)return;const r=t-e;return r<40||r>=.8*s?void 0:l(e,t,i+1)},p=new RC(r,h,c,d.next,d.mid);return this.bspNodeTree.push(p),p.leftNode=u(e,d.next),p.rightNode=u(d.mid,t),p};l(0,s,0),this.triangleVertexIndices=function(e,t,i,r){const s=r-i;let a=0;for(let e=i;e<r;++e)for(let i=0;i<3;++i)a=Math.max(t[3*e+i],a);const n=a<=DC?new Uint16Array(3*s):new Uint32Array(3*s);for(let r=0;r<s;++r){const s=3*(e[r]+i);for(let e=0;e<3;++e){const i=t[s+e];n[3*r+e]=i}}return n}(a,e,t,i)}}intersectRayTriangleRange(e,t){{if(e>=t)return;const i=this.triangleVertexIndices,r=this.positionAttribute.data,s=this.positionAttribute.stride,a=this._rayOrigin,n=a[0],o=a[1],l=a[2],h=this._rayDirection,c=h[0],d=h[1],u=h[2];for(let a=e,h=3*e;a<t;++a){let e=i[h++]*s;const t=r[e++],p=r[e++],m=r[e];e=i[h++]*s;const _=r[e++],g=r[e++],f=r[e];e=i[h++]*s;const y=_-t,v=g-p,b=f-m,x=r[e++]-t,T=r[e++]-p,w=r[e]-m,C=d*w-T*u,S=u*x-w*c,P=c*T-x*d,R=y*C+v*S+b*P;if(Math.abs(R)<=Number.EPSILON)continue;const O=n-t,E=o-p,A=l-m,M=O*C+E*S+A*P;if(R>0){if(M<0||M>R)continue}else if(M>0||M<R)continue;const D=E*b-v*A,I=A*y-b*O,L=O*v-y*E,N=c*D+d*I+u*L;if(R>0){if(N<0||M+N>R)continue}else if(N>0||M+N<R)continue;const F=(x*D+T*I+w*L)/R;if(F>=0){const e=this.indices[a]+this.firstTriangleIndex,t=ta(y,v,b,x,T,w,EC);this._callback(F,t,e,!1)}}}OC.numFacesTested+=t-e}intersectRay(e,t){OC.numFacesTested=0;const i=fe(e.r0[0],e.r0[1],e.r0[2]),r=fe(e.r1[0],e.r1[1],e.r1[2]),s=r[0]-i[0],a=r[1]-i[1],n=r[2]-i[2];if(s*s+a*a+n*n<PC)return;this._rayOrigin=i;const o=this._rayDirection;o[0]=s,o[1]=a,o[2]=n;const l=this.triangleVertexIndices.length/3;this._callback=t;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,l)}intersectRayBSP(e,t,i){const r=this._rayOrigin,s=this._rayDirection;if(!function(e,t,i){const r=t,s=i;let a=0,n=1/0;for(let t=0;t<3;++t){{const i=e[t];if(r[t]<i){if(s[t]<=PC)return!1;const e=(i-r[t])/s[t];a=Math.max(a,e)}else if(s[t]<=-PC){const e=(i-r[t])/s[t];n=Math.min(n,e)}if(a>n)return!1}{const i=e[t+3];if(r[t]>i){if(s[t]>=-PC)return!1;const e=(i-r[t])/s[t];a=Math.max(a,e)}else if(s[t]>=PC){const e=(i-r[t])/s[t];n=Math.min(n,e)}if(a>n)return!1}}return!0}(e.aabb,r,s))return;const a=e.axis,n=e.d;if(r[a]<n||s[a]<0){const i=t,r=e.midStartIndex;if(i<r){const t=e.leftNode;void 0!==t?this.intersectRayBSP(t,i,r):this.intersectRayTriangleRange(i,r)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),r[a]>n||s[a]>0){const t=e.rightStartIndex,r=i;if(t<r){const i=e.rightNode;void 0!==i?this.intersectRayBSP(i,t,r):this.intersectRayTriangleRange(t,r)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}OC.numFacesTested=0;const EC=ve(),AC=[1/0,1/0,1/0],MC=[-1/0,-1/0,-1/0],DC=65535;class IC extends Wn{constructor(){super(...arguments),this.output=_o.Color,this.overlayMode=BT.Disabled,this.tileBlendInput=YT.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.atmosphere=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=hs.Terrain}}e([Ea({count:_o.COUNT})],IC.prototype,"output",void 0),e([Ea({count:BT.COUNT})],IC.prototype,"overlayMode",void 0),e([Ea({count:YT.COUNT})],IC.prototype,"tileBlendInput",void 0),e([Ea()],IC.prototype,"spherical",void 0),e([Ea()],IC.prototype,"doublePrecisionRequiresObfuscation",void 0),e([Ea()],IC.prototype,"atmosphere",void 0),e([Ea()],IC.prototype,"receiveShadows",void 0),e([Ea()],IC.prototype,"hasSlicePlane",void 0),e([Ea()],IC.prototype,"backfaceCullingEnabled",void 0),e([Ea()],IC.prototype,"textureFadingEnabled",void 0),e([Ea()],IC.prototype,"renderOccluded",void 0),e([Ea()],IC.prototype,"hasScreenSpaceReflections",void 0),e([Ea()],IC.prototype,"hasCloudsReflections",void 0),e([Ea()],IC.prototype,"invisible",void 0),e([Ea()],IC.prototype,"tileBorders",void 0),e([Ea()],IC.prototype,"visualizeNormals",void 0),e([Ea()],IC.prototype,"screenSizePerspective",void 0),e([Ea()],IC.prototype,"receiveAmbientOcclusion",void 0),e([Ea({count:hs.COUNT})],IC.prototype,"pbrMode",void 0),e([Ea({constValue:vd.CompressedAttribute})],IC.prototype,"normalType",void 0),e([Ea({constValue:ns.Compressed})],IC.prototype,"textureCoordinateType",void 0),e([Ea({constValue:!1})],IC.prototype,"highStepCount",void 0),e([Ea({constValue:!1})],IC.prototype,"useCustomDTRExponentForWater",void 0),e([Ea({constValue:!1})],IC.prototype,"useFillLights",void 0);const LC=Yl();var NC;!function(e){e[e.Opaque=0]="Opaque",e[e.Semitransparent=1]="Semitransparent",e[e.TransparentWithDraped=2]="TransparentWithDraped",e[e.Empty=3]="Empty"}(NC||(NC={}));let FC=class extends Hi{get _isGlobal(){return this._stage.viewingMode===Ui.Global}constructor(e){super(e),this.type=ml.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new IC,this._passParameters=new sw,this._rctx=null,this._renderDataPool=new vh(cw),this._patchGroups=new Map,this._patchGroupsDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Nx,this._highestVisibleLODTile=null,this._visible=!0,this._transparencyState=NC.Opaque,this._velvetOverground=!0,this._castShadows=!0,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=ia.Occlude}initialize(){const e=[go.OPAQUE_TERRAIN,go.TRANSPARENT_TERRAIN,go.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}destroy(){this._stage.removeRenderPlugin(this),xx.clear()}get canRender(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===NC.TransparentWithDraped||e===NC.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get needsLinearDepth(){return this._overlayRenderer.hasWater}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return ol}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?wn:ia.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,A(this._tileRenderer)&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,xT.TEXTURE_FADING)}updateTileTexture(e,t){A(this._tileRenderer)&&(this._tileRenderer.updateTileTexture(e,t===xT.TEXTURE_FADING?ed.FADING:ed.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const t of e.layerInfo[sx.ELEVATION])t.pendingUpdates&=~xT.GEOMETRY;e.resetPendingUpdate(xT.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=Math.max(0,7*Math.floor((e.level-3)/7));if(this._isGlobal&&0===t)return Ve;for(;e.parent&&e.level>t;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this._visible=e,this.setDirty()}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=wc.UPDATE){this._patchGroupsDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=wc.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=wc.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.techniqueRepository,this._tileRenderer=new mC(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=Ua(this._rctx)}uninitializeRenderContext(){this._emptyTex=F(this._emptyTex),this._tileRenderer=F(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==NC.Opaque)return;const s=UC,a=jC;Ie(s,r,i),Pe(a,1/s[0],1/s[1],1/s[2]);const n=e.results.min,o=e.results.max,l=e.results.ground,h=e.options.store===ul.MIN,c=!!e.results.ground.target,d=ll(e.verticalOffset),u=e.tolerance;let p,m=h&&A(n.dist)?n.dist:1/0;const _=c=>{const _=c.renderData;if(!_?.vao)return;const g=_.geometryInfo;ih(LC,g.boundingBox);const f=_.localOrigin;A(d)&&(d.localOrigin=f,d.applyToAabb(LC));const y=LC;if(VC[0]=i[0]-f[0],VC[1]=i[1]-f[1],VC[2]=i[2]-f[2],!ea(y,VC,a,u,m))return;const v=(e,t,i)=>{e.set(this.type,c,t,i,ss),m=h&&A(n.dist)?n.dist:1/0},b=(a,h)=>{if(A(h)&&a>=0&&(e.options.backfacesTerrain||xe(h,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||null==t||t(i,r,a))){if((null==l.dist||a<l.dist)&&v(l,a,h),e.options.isFiltered)return;e.options.store===ul.ALL&&(M(p)?(p=gl(e.ray),v(p,a,h),e.results.all.push(p)):a<p.dist&&v(p,a,h)),(null==n.dist||a<n.dist)&&v(n,a,h),e.options.store!==ul.MIN&&(null==o.dist||a>o.dist)&&v(o,a,h)}},x=kC;Ie(x,r,f);const T=g.indices,w=g.vertexAttributes,C=w.getField(Gs.POSITION,Nd),S=new kd(C.typedBuffer,3,!1,w.stride/4),P=g.indexCount/3;if(M(d)&&P>200){const e=c.renderData;M(e.intersectionData)&&(e.intersectionData=new OC(T,0,P,S)),e.intersectionData.intersectRay({r0:VC,r1:x},b)}else ra(VC,x,0,P,T,S,null,d,b)},g=this._rootTiles;A(g)&&(()=>{const t=this._tileIterator;t.reset(g);const r=e.options.invisibleTerrain;for(let e=t.next();e;e=t.next())!(e.visible||r&&e.intersectsClippingArea)||!A(d)&&!e.intersectsRay(i,s,u,m)||c&&this._useStencilForTile(e)?t.skipSubtree():_(e)})()}processScaleRangeQueries(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const t of this._patchGroups.values())for(const i of t)A(i.renderData?.textureReference)&&e.queriesForTile(i);e.process(),t.madeProgress()}}prepareTechnique(e){if(e.bindParameters.slot===go.OCCLUDED_TERRAIN){if(0==(e.renderOccludedMask&wn))return null}else{const t=this.transparency===NC.Opaque?go.OPAQUE_TERRAIN:go.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.output){case _o.Color:return this.transparency===NC.Empty?null:(this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=A(e.bindParameters.cloudsFade.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.active,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty?BT.Disabled:this._overlayRenderer.hasWater?BT.EnabledWithWater:BT.Enabled,this._updateTechnique(_o.Color,e.bindParameters.slot===go.OCCLUDED_TERRAIN));case _o.Shadow:case _o.ShadowExcludeHighlight:return this._castShadows&&1===e.bindParameters.lighting.globalFactor?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(_o.Shadow,!1)):null;case _o.Depth:return this.transparency===NC.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(_o.Depth,!1));case _o.Normal:return this.transparency===NC.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(_o.Normal,!1));case _o.ObjectAndLayerIdColor:return this.transparency===NC.Empty?null:this._updateTechnique(_o.ObjectAndLayerIdColor,!1);case _o.Highlight:return this.transparency!==NC.Empty&&this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(_o.Highlight,!1)):null}return null}render(e,t){const i=1===e.bindParameters.lighting.globalFactor;switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case _o.Color:{const i=e.bindParameters.slot===go.OCCLUDED_TERRAIN?Tn.Occluded:Tn.ColorAndWater;this.transparency===NC.Opaque?this._renderMaterialPass(e,t,i):e.offscreenRenderingHelper.renderToTargets((()=>this._renderMaterialPass(e,t,i)),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break}case _o.Depth:case _o.Normal:this._renderAuxiliaryPass(e,t,Tn.None);break;case _o.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,t,Tn.Highlight);break;case _o.Shadow:case _o.ShadowExcludeHighlight:this._castShadows&&i&&this._renderAuxiliaryPass(e,t,Tn.None);break;case _o.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,Tn.ObjectAndLayerIdColor)}}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._renderPatchGroups(e,t,i)}_renderAuxiliaryPass(e,t,i){const r=e.rctx;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,i)}updateTileBackground(e=null){if(M(this._tileRenderer))return;const t=this._tileRenderer;let i=null;if(A(e)){const t=pr.toUnitRGBA(e);i=fe(t[0]||0,t[1]||0,t[2]||0)}t.setBackground(i),this._allTiles.forAll((e=>t.updateTileTexture(e,ed.FADING))),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?YT.GridComposite:A(t.backgroundColor)?YT.ColorComposite:YT.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Lx.NONE){const e=Array.from(this._patchGroups.values()),t=this._stencilEnabledLayerExtents;for(const i of e)Vx(this.renderOrder,i,t);e.sort(((e,t)=>qx(e[0],t[0],this.renderOrder))),this._patchGroups=new Map(e.map((e=>[e[0].renderData.localOrigin,e]))),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(!M(e)){e[0]?.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();for(const t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const e=t.next(),i=e.renderData;if(!i){this._numTilesCulled++;continue}if(!e.visible){this._numTilesCulled++,t.skipSubtree();continue}const r=i.localOrigin;let s=this._patchGroups.get(r);s||(s=new Array,this._patchGroups.set(r,s)),s.push(e),(!this._highestVisibleLODTile||e.elevationLevel>this._highestVisibleLODTile.elevationLevel)&&(this._highestVisibleLODTile=e),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i){const r=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach((s=>{const a=s[0].renderData.localOrigin;t.program.bindDraw(new Cn(a),e.bindParameters,this._passParameters);for(let a=0;a<s.length;a++)this._renderPatch(e,t,s[a],la.TRIANGLES,r,i)})),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i){const r=e.bindParameters.camera,s=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const e=Zs(this._stage.viewingMode,this._ellipsoidRadius),t=this.pointsOfInterest.centerOnSurfaceFrequent.distance;e.update({distance:t,fovY:r.fovY})}const a=this._stencilEnabledLayerExtents.length>0,n=i===Tn.Occluded;n&&(s.bindTexture("tex",this._emptyTex),s.setUniform3fv("textureOpacities",Ve),s.setUniform4fv("texOffsetAndScale",yr));const o=A(this._tileRenderer)&&A(this._tileRenderer.backgroundColor)?this._tileRenderer.backgroundColor:Ve;this._techniqueConfiguration.tileBlendInput===YT.ColorComposite&&s.setUniform3fv("backgroundColor",o);const l=this.wireframe?la.LINES:la.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&s.bindTexture("texNext",this._emptyTex);const h=this._patchGroups;for(const r of h.values()){const o=r[0].renderData.localOrigin;t.program.bindDraw(new Cn(o),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const o of r){const r=o.renderData,h=r.textureReference;if(!M(h)){if(!n){s.setUniform4fv("texOffsetAndScale",h.offsetAndScale),s.bindTexture("tex",h.texture.texture);const e=r.textureFadeFactor,t=e<1?r.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&A(t)&&e<1?(s.setUniform1f("fadeFactor",e),s.setUniform4fv("nextTexOffsetAndScale",t.offsetAndScale),s.setUniform3fv("nextTexOpacities",t.opacities),s.bindTexture("texNext",t.texture.texture)):s.setUniform1f("fadeFactor",1),r.textureIsFading&&this.setNeedsRender(),s.setUniform3fv("textureOpacities",h.opacities)}this._renderPatch(e,t,o,l,a,i),o.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,r,s,a){const n=i.renderData,o=n.vao,l=o.indexBuffer;if(M(l))return void(Bh&&console.error("Rendered tile with no indices: ",i.lij," : ",n));const h=t.program;a===Tn.None||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,n.overlay),s&&(t.useStencil=this._useStencilForTile(i),t.bindPipelineState(e.rctx,e.bindParameters.slot));const c=n.geometryInfo.indexCount;e.rctx.bindVAO(o),h.assertCompatibleVertexAttributeLocations(o),e.rctx.drawElements(r,c,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,e===_o.Color&&(this._techniqueConfiguration.atmosphere=this._isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(lw,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};e([ce({constructOnly:!0})],FC.prototype,"_overlayRenderer",void 0),e([ce({constructOnly:!0})],FC.prototype,"_stage",void 0),e([ce({readOnly:!0})],FC.prototype,"_isGlobal",null),e([ce({constructOnly:!0})],FC.prototype,"_allTiles",void 0),e([ce({constructOnly:!0})],FC.prototype,"_ellipsoidRadius",void 0),e([ce({value:!1})],FC.prototype,"renderingDisabled",null),e([ce()],FC.prototype,"renderPatchBorders",null),e([ce()],FC.prototype,"visualizeNormals",null),e([ce()],FC.prototype,"cullBackFaces",null),e([ce({value:Lx.FRONT_TO_BACK})],FC.prototype,"renderOrder",null),e([ce()],FC.prototype,"wireframe",null),FC=e([ue("esri.views.3d.terrain.TerrainRenderer")],FC);const UC=ve(),jC=ve(),VC=ve(),kC=ve();class zC{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let qC=class extends Hi{constructor(e){super(e),this._handles=new R}initialize(){this._handles.add(this.layers.on("change",(()=>this._update()))),this._handles.add(G((()=>this.extentHelper.layerViewsExtent),(()=>this._setAdHocTilingScheme()))),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=I(this._handles),this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some((t=>!(!Vt(t)||t.isRejected()||t.isFulfilled()&&!function(e,t,i){return A(Ih(e,t,i))}(t,this.viewSpatialReference,this.viewingMode)||(e=t,"vector-tile"===t?.type||Lh(t))))),e)if(e.isResolved()){const t=Ih(e,this.viewSpatialReference,this.viewingMode);if(A(t)){const e=new Qc(t.tileInfo);this._lockTilingScheme(e)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch((()=>{})).then((()=>{t!==this._waitTask||this.destroyed||this._update()}));this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Ui.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Qc.makeWebMercatorAuxiliarySphere(t):Ye(e.spatialReference)&&(e=Qc.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(G((()=>this.extentHelper.tiledLayersExtent),(()=>this._updateTiledLayerExtent())))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Ui.Global){const e=this.extentHelper.viewSpatialReference,t=Ye(e)||xr(e)||Tr(e);e.isWebMercator?this.tilingScheme=Qc.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Qc.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;A(e)&&!vt(e,this.extent)&&(this.tilingScheme=Qc.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};e([ce()],qC.prototype,"tilingScheme",void 0),e([ce({readOnly:!0})],qC.prototype,"extent",void 0),e([ce({value:!1})],qC.prototype,"tilingSchemeLocked",void 0),e([ce({constructOnly:!0})],qC.prototype,"viewSpatialReference",void 0),e([ce({constructOnly:!0})],qC.prototype,"layers",void 0),e([ce({constructOnly:!0})],qC.prototype,"extentHelper",void 0),e([ce({constructOnly:!0})],qC.prototype,"viewingMode",void 0),qC=e([ue("esri.views.3d.terrain.TilingSchemeLogic")],qC);class GC{constructor(){this.offset=kr(),this.scale=0,this.tile=null}init(e,t,i,r){this.tile=e,this.offset[0]=t,this.offset[1]=i,this.scale=r}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}let HC=class extends(mr.EventedMixin(Hi)){constructor(e){super(e),this._scaleRangeQueries=new Hw,this._iteratorPool=new vh(Nx,(e=>e.remove=()=>this._iteratorPool.release(e))),this._postorderIterator=new Fx,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visibleCached=!1,this._usedMemory=null,this._performanceInfo=new zC,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=ve(),this._eyePosSurfaceSR=ve(),this._splitLimits=new Kw,this._frustum=gh(),this._viewProjectionMatrix=is(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new R,this._watchUpdatingTracking=new Kn,this._frameTask=Gn,this._allTiles=new J,this._upsampleInfoPool=new vh(GC),this._rootTilesExtent=at(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=Rh.WebMercator,this.visibleElevationBounds=new Yb(1/0,-1/0),this.rootTileElevationBounds=new Yb(1/0,-1/0),this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this.oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateeCarree=!1,this.overlayManager=new hx({...e,surface:this}),this._isGlobal=!e.view?.state?.isLocal}initialize(){this._lercDecoder=Uc(this.view.resourceController),this._tilePool=this.view.state.isLocal?new vh(zw):new vh(Bw);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",(e=>e.unloadMapData())),this._elevationQueryCache=new Fc(e.newCache("elevation-query")),this._handles.add([G((()=>this.overlayManager.hasHighlights),(e=>this._renderer.setNeedsHighlight(e))),G((()=>this.overlayManager.rendersOccluded),(e=>this._renderer.setRenderOccludedOverlay(e))),G((()=>this.overlayManager.renderer.isEmpty),(()=>this._evaluateTransparency()))],"overlayManager"),this._renderer=new FC({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:br(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([G((()=>this.baseOpacity),(()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?ed.UNFADED:ed.IMMEDIATE)}),B),G((()=>this.hasCompositeBlendMode),(()=>this._updateTileTextures(this._evaluateTransparency()?ed.UNFADED:ed.IMMEDIATE)),B),G((()=>this.renderingDisabled),(()=>this.view?._stage?.renderer.setParameters({terrainRenderingEnabled:!this.renderingDisabled})),$),G((()=>this.backgroundColor),(e=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(e)}),B),G((()=>this.snapLevel),(()=>this._viewChanged=!0),$),G((()=>this.view.pointsOfInterest),(e=>{this._renderer.pointsOfInterest=e,this._watchUpdatingTracking.removeAll(),e&&this._watchUpdatingTracking.add((()=>e.focus.renderLocation),(()=>this._allTilesSorted=!1))})),G((()=>La.TERRAIN_TILE_TREE_SHOW_TILES),(e=>{e&&!this._treeDebugger?import("../chunks/TerrainTileTree3DDebugger.js").then((({TerrainTileTree3DDebugger:e})=>{!this._treeDebugger&&La.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new e({view:this.view}))})):e||(this._treeDebugger=I(this._treeDebugger))}),H)]);const{spatialReference:t}=this.view;var i,r;this._extentHelper=(i=this.viewingMode,r={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:t},i===Ui.Global?new tx(r):new ix(r));const s=new Lc({getCollections:()=>this.view?.defaultsFromMap?.mapCollections?.map((({layers:e})=>e)),getChildrenFunction:e=>e&&"layers"in e?e.layers:null}),a=new qC({layers:s,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:t});this._set("tilingSchemeLogic",a),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(ob.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(ob.BASEMAP);const n=this.view.resourceController.scheduler;this._frameTask=n.registerTask(Vn.TERRAIN_SURFACE,this),this._handles.add([G((()=>this._extentHelper.stencilEnabledExtents),(e=>this._renderer.setStencilEnabledLayerExtents(e)),H),G((()=>this.tilingSchemeLogic.tilingScheme),(()=>this._updateTilingScheme()),$),G((()=>this.extent),(()=>this._updateRootTiles()),H),this.view.on("resize",(()=>this._viewChangeUpdate())),G((()=>{const e=this.view,t=e.state;return[this._lodBias,this.lodSnapping,e.resourceController?.memoryController?.memoryFactor,t.camera,t.contentCamera,t.fixedContentCamera]}),(()=>this._viewChangeUpdate()),B),G((()=>this.view.qualitySettings?.tiledSurface?.textureFadeDuration),(e=>this._renderer.textureFadingEnabled=e>0),H),G((()=>this.view.qualitySettings?.physicallyBasedRenderingEnabled),(e=>this._renderer.pbrMode=e?hs.Terrain:hs.Disabled),H),G((()=>this._userClippingExtent),(()=>this._updateClippingExtent()),$)]),this._handles.add(this.view.allLayerViews.on("after-changes",(()=>this._layerViewsDirty=!0))),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=N(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=I(this._upsampleMapCache),this._elevationQueryCache=I(this._elevationQueryCache),this._set("tilingSchemeLogic",I(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach(((e,t)=>this._unregisterTiledLayerView(t))),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",I(this.overlayManager)),this._tilePool=I(this._tilePool),TT.prune(),this._treeDebugger=I(this._treeDebugger),this._renderer=I(this._renderer),this._iteratorPool=I(this._iteratorPool),this._set("view",null),this._extentHelper=I(this._extentHelper),this._upsampleInfoPool=I(this._upsampleInfoPool),kc(),vT.size>0&&(console.log(`${vT.size} live TilePerLayerInfo allocations:`),vT.forEach((e=>console.log(e,"\n"))))}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnapping===ad.ON){const e=this.view,t=this.tilingScheme,i=e.pointsOfInterest?.cameraOnSurface?.scale;if(t&&i){const r=e.state.contentCamera;let s=wl(e,r.eye,r.viewForward,r.up).tilt;s>90&&(s=180-s);const a=2*(s/90)**2,n=t.levelAtScale(i)-a,o=Math.min(n,this._splitLimits.maxLod||1/0);return o<=0?null:o}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?ad.ON:ad.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(M(t)||M(e))return null;const i=at(),r=Gl(t,i,e)?i:null,s=this._get("extent");return vt(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=xt(this.groundExtent,this._userClippingExtent,at()),t=this._get("extent");return vt(e,t)?t:e}get groundExtent(){return A(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return A(this._rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view.map.ground.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}set velvetOverground(e){this._renderer.velvetOverground=e,this._set("velvetOverground",e)}get wireframe(){return this._renderer.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}set _visible(e){e!==this._visibleCached&&(this._visibleCached=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.transparency===NC.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get textureFadeDuration(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=this._rootTiles;if(M(s)||!s.length)return null;if(0===s[0].layerInfo[sx.ELEVATION].length)return null;const a=QC;return a[0]=e,a[1]=t,a[2]=i,et(a,r,a,this._spatialReference)?eS(s,a[0],a[1]):(E.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)}getElevations(e,t,i){const r=this._rootTiles,s=r?r[0].layerInfo[sx.ELEVATION].length:0;if(!M(r)&&r.length&&0!==s)for(let s=0;s<t;++s){const t=3*s;i(s,eS(r,e[t],e[t+1]))}else for(let e=0;e<t;++e)i(e,null)}getScale(e){if(!this.tilingScheme)return null;if(!it(e,QC,this.spatialReference))return E.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this._rootTiles;if(A(t))for(const e of t)if(e?.containsPoint(QC)){let t=e;for(;t.children[0]&&!t.rendered;){const e=t.children[0].extent;let i=0;QC[0]>e[2]&&(i+=1),QC[1]<e[1]&&(i+=2),t=t.children[i]}return this._getLodBiasCorrectedScale(t.level)}return 1/0}getSphereElevationBounds(e,t){if(QC[0]=e[0],QC[1]=e[1],QC[2]=e[2],QC[3]=e[3],!et(QC,t,QC,this.tilingScheme?.spatialReference))return E.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let i=1/0,r=-1/0;const s=e=>{if(e&&St(e.extent,QC))if(e.isLeaf||e.rendered)i=Math.min(i,e.elevationBounds[0]),r=Math.max(r,e.elevationBounds[1]);else for(const t of e.children)s(t)},a=this._rootTiles;if(A(a))for(const e of a)s(e);return{min:i,max:r}}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!it(e,QC,this.spatialReference))return E.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;QC[3]=t;let i=null;const r=e=>{if(e&&St(e.extent,QC)){const t=e.children;if(t[0]&&!e.rendered)for(const e of t)r(e);else{const t=this._getLodBiasCorrectedScale(e.level);i=null==i?t:Math.min(i,t)}}},s=this._rootTiles;if(A(s))for(const e of s)r(e);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,a=i?this.tilingScheme.levelAtScale(i):1/0,n=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,s+n,a+n,r)}_evaluateTransparency(){const e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?t?NC.Empty:NC.TransparentWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?NC.Opaque:NC.Semitransparent,s=i!==r;return s&&(this._renderer.transparency=r,this.view?._stage?.renderer.setParameters({terrainTransparency:this._renderer.transparency})),s}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;jh(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const t=e?.spatialReference??Rh.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateeCarree=this._isWebMercator&&Pr(this.view?.renderSpatialReference),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles())}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return YC[0]=e,YC[1]=t,YC[2]=i,s.init(YC,r,this),s}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=XC;let r=t.rootTilesInExtent(e,i,5*Xc);if(A(this._rootTiles)){if(r.length>Xc)return void E.getLogger(this.declaredClass).warn(Yc);const e=this._rootTiles.map((e=>e.lij)),t=w(e,r,WC);if(this._updatingRootTiles=!0,t.removed.length>0||t.added.length>0){const e=this._rootTiles.filter((e=>!(t.removed.findIndex((t=>WC(t,e.lij)))>-1&&(this._purgeTile(e),1))));t.added.forEach((t=>e.push(this._newRootTile(t)))),this._setRootTiles(e)}}else this._updatingRootTiles=!0,r.length>Xc&&(E.getLogger(this.declaredClass).warn(Zc),r=t.rootTilesInExtent(e,i,Xc)),this._setRootTiles(r.map((e=>this._newRootTile(e))));vt(i,this._rootTilesExtent)||(this._rootTilesExtent=at(i)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter((e=>e.isLoaded&&e.intersectsClippingArea));e.forEach((e=>this._renderer.updateTileGeometryState(e))),e.forEach((e=>e.renderData.updateNeighborData())),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(0===e.length)return;e.sort(jx);const t=this.renderer;e.forEach((e=>t.updateGeometryIfNeeded(e))),e.forEach((e=>this._pendingTilesForElevationUpdateEvent.add(e)))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===xT.SPLIT}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(xT.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),A(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(xT.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(M(e))return;const t=function(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let e=0;e<4;e++){const t=r.children[e];if(t&&t!==i)return!0}}return!1}(e),i=this.visibleElevationBounds;let r=t?i.min:1/0,s=t?i.max:-1/0;const a=this.extent,n=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(e);!o.done;){const e=o.next();e.updateClippingStatus(a)&&e.resetPendingUpdate(xT.GEOMETRY)&&this._updateTileGeometryState(e),e.setPendingUpdate(xT.RENDERDATA),e.computeVisibility(),e.updateScreenDepth(n),e.renderData&&(r=Math.min(e.elevationBounds[0],r),s=Math.max(e.elevationBounds[1],s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(i.min!==r||i.max!==s)&&(this.visibleElevationBounds=new Yb(r,s))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0;const i=this._rootTiles;A(i)&&i.forEach((({elevationBounds:i})=>{e=Math.min(e,i[0]),t=Math.max(t,i[1])}));const r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new Yb(e,t))}_updateViewDependentParameters(){const{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,a=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(M(this._splitLimits.frustum)&&(this._splitLimits.frustum=gh()),fh(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,fh(this._frustum,e.frustum),$r(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),De(this._eyePosRenderSR,t.eye),et(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&($C(e)?this._loadChildren(e):function(e){return e.isLeaf&&(e.parent?.shouldLoad??!1)}(e)&&this._loadParent(e))}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}_markAllTileNeighborsForGeometryUpdate(e){const t=this._pendingTilesToUpdate;e.forEachLoadedNeighbor((e=>{t.add(e)}))}_updateTileTexture(e,t){const i=e.resetPendingUpdate(xT.TEXTURE_FADING)?xT.TEXTURE_FADING:!!e.resetPendingUpdate(xT.TEXTURE_NOFADING)&&xT.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){const e=KC.extent;nt(e),this._pendingTilesForElevationUpdateEvent.forEach((t=>ct(e,t.extent,e))),this._pendingTilesForElevationUpdateEvent.clear(),KC.spatialReference=this.spatialReference,this.emit("elevation-change",KC)}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();t.reset(this._rootTiles);const i=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;for(;!t.done;){const e=t.next(),a=e.shouldSplit(r,s,i);if(a!==xT.SPLIT){if(e.resetPendingUpdate(xT.SPLIT)&&e.updateAgentSuspension(),a===xT.ELEVATION&&e.updateAgents(sx.ELEVATION),t.skipSubtree(),!e.isLeaf){e.setPendingUpdate(xT.MERGE),e.resetPendingUpdate(xT.SPLIT);const t=this._iteratorPool.acquire();t.resetOne(e);const i=this._viewProjectionMatrix;for(let e=t.next();!t.done;e=t.next())this._updateClippingStatus(e),e.updateVisibility(),e.updateScreenDepth(i);t.remove()}}else e.resetPendingUpdate(xT.MERGE),e.isLeaf&&(e.setPendingUpdate(xT.SPLIT),t.skipSubtree()),e.rendered&&e.setPendingUpdate(xT.RENDERDATA)}t.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(function(e,t){const i=e.length;for(let r=0;r<i;++r)e.getItemAt(r).updateDistanceToPOI(t);e.sort(Hx)}(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){Nh(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForGeometryUpdate(e))}_batchUpdatePendingTileGeometries(){const e=this._pendingTilesToUpdate;if(0===e.size)return;const t=Array.from(this._pendingTilesToUpdate.keys()).filter((e=>e.isLoaded&&e.intersectsClippingArea)),i=(i,r)=>{!r?.isLoaded||!r.intersectsClippingArea||r.level<i.level||e.has(r)||(e.add(r),t.push(r),r.renderData.updateNeighborData())};t.sort(jx);const r=t.length;for(let s=0;s<r;++s){const r=t[s];Nh(r.isLoaded),Nh(r.intersectsClippingArea);const a=r.renderData;a.updateNeighborData();const n=a._dirtyEdgeResolutions,o=a.geometryState.neighborData;for(let t=0;t<4;++t)if(n&1<<t){const s=a.geometryState.neighborData.edgePeerNeighbors[t];s&&s?.level>=r.level&&s.forAllSubtreeOnSide(Hh(Gh[t]),(t=>!(!t.isLoaded||!t.intersectsClippingArea||(Nh(e.has(t)||jx(r,t)<0),i(r,t),0)))),i(r,o.cornerPeerNeighbors[t]),i(r,o.cornerPeerNeighbors[(t+1)%4])}}e.clear(),this._updateTilesGeometries(t),Bh&&Yh&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!e.done;){s=!0;let a=!1;const n=!this._allTiles.some((s=>{if(!i&&!r&&!s.visible)return e.done;let n=s;if(s.resetPendingUpdate(xT.MERGE)){if(!t)return s.setPendingUpdate(xT.MERGE),e.done;for(;n.parent?.resetPendingUpdate(xT.MERGE);)n=n.parent;this._mergeTile(n),a=!0,e.madeProgress()}else s.resetPendingUpdate(xT.SPLIT)&&(this._splitTile(s),a=!0,e.madeProgress());return!e.done&&n===s&&s.resetPendingUpdate(xT.RENDERDATA)&&(this._updateRenderData(s),e.madeProgress()),e.done}));if(a&&(this._allTilesSorted=!1,this._allTilesDirty=!0),n){if(!i){i=!0;continue}if(!a)break}else this._allTilesDirty=!0}s?e.madeProgress():this._allTilesDirty=!0,!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some((t=>(t.resetPendingUpdate(xT.GEOMETRY)&&(this._updateTileGeometryState(t),this._updateTileTexture(t,e),this.shortBatches&&this._batchUpdatePendingTileGeometries(),e.madeProgress()),e.done))),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some((t=>(this._updateTileTexture(t,e),e.done)))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(wc.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*Kc}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=Bi(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){A(this._rootTiles)&&(this._rootTiles.forEach((e=>this._purgeTile(e))),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1}_purgeDescendantTiles(e){if(!e.children[0])return!1;let t=!1;for(let i=0;i<4;++i)t=this._purgeTile(e.children[i])||t;return e.unsetChildren(),t}_purgeTile(e){const t=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),this._tilePool.release(e),t}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}_splitTile(e){jh(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(xT.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){JC.spatialReference=this.spatialReference,JC.extent=e.extent,JC.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",JC)}_createTile(e,t,i,r){jh(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(xT.SPLIT),s}get shortBatches(){return this.view.state.mode!==zn.IDLE}_mergeTile(e){jh(!e.hasPendingUpdate(xT.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(jh(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged}_loadChildren(e){jh(e.rendered,"parent should be rendered"),this._unloadTile(e);const t=e.children;t.forEach((e=>this._loadTile(e))),t.forEach((e=>this._pendingTilesToUpdate.add(e))),this._markAllTileNeighborsForGeometryUpdate(e),this._emitTileScaleChange(e,e.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_loadParent(e){const t=e.parent;this._unloadChildren(t),this._loadTile(t),this._markTileToUpdate(t),this._emitTileScaleChange(t,t.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_unloadChildren(e){const t=e.children;if(t[0])for(let e=0;e<4;++e){const i=t[e];this._unloadChildren(i),this._unloadTile(i)}}_loadTile(e){e.load(),e.setPendingUpdate(xT.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}_elevationDataArrived(e,t,i){const r=new Zb(e.lij,e.extent,i);e.dataArrived(t,sx.ELEVATION,r);const s=[e],a=e.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const e=n.next();e.findElevationBoundsForLayer(t,a),e.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds(),n.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(e=qn){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const e of this.view.allLayerViews.items)if(i.add(e.uid),oc(e)||lc(e))if(this._basemapLayerViewHandles.has(e.uid)&&!lc(e)){const i=this._layerClassFromLayerView(e),s=this._getLayerIdxByUID(i,e.uid);A(s)&&((s<r||M(r))&&(t=!0),r=s)}else this._registerTiledLayerView(e),e.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach(((e,r)=>{i.has(r)||(this._unregisterTiledLayerView(r),t=!0)})),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){let e=0===this.view.map?.ground?.opacity;for(const t of this.view.allLayerViews.items)if(hc(t)&&!zt(t.layer)&&0!==t.fullOpacity)return e=!1,e;return e}_hasCompositeBlendMode(){for(const t of this.view.allLayerViews.items)if((kh(t)||lc(t))&&((e=nT[t.layer.blendMode])===Jx.DestinationOver||e===Jx.DestinationAtop||e===Jx.DestinationIn||e===Jx.DestinationOut||e===Jx.SourceAtop||e===Jx.SourceIn||e===Jx.SourceOut||e===Jx.Xor))return!0;var e;return!1}_layerClassFromLayerView(e){return cc(e)?sx.ELEVATION:sx.MAP}_registerTiledLayerView(e){const t=[];if((kh(e)||lc(e))&&t.push(G((()=>e.layer.blendMode),(()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(ed.UNFADED)}))),!lc(e)){const i=this._layerClassFromLayerView(e);t.push(G((()=>e.suspended),(()=>this._updateTiledLayers()))),t.push(G((()=>e.fullOpacity),(()=>this._updateTileTextures(ed.UNFADED)))),t.push(G((()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null),(()=>this._restartAllAgents(i)))),t.push(e.on("data-changed",(()=>{const t=this._getLayerIdxByUID(i,e.uid);A(t)&&this._invalidateLayerData(t,i)})))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(const e of t)e.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach((e=>{if(!e.layer||e.suspended||!oc(e)||!e.fullExtent)return;const r=this._layerClassFromLayerView(e);if(r===sx.MAP){const t=e.displayLevelRange.maxLevel;t!==1/0&&(null===i||t>i)&&(i=t)}t[r].push(e)}));for(const e of ax){const i=this._layerViews[e],r=t[e];r.reverse();const s=r.length;let a=i.length!==s;const n=new Array(s),o=new Array(i.length);this._layerIndexByUid[e].clear();for(let t=0;t<s;t++){const s=r[t].uid;this._layerIndexByUid[e].set(s,t);const l=i.indexOf(r[t]);n[t]=l,t!==l&&(a=!0),l>-1&&(o[l]=t)}if(a){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;)t.next().modifyLayers(o,n,e);this._layerViews[e]=r,this._restartAllAgents(e),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===sx.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll((t=>{t.updateAgents(sx.MAP),e===ed.IMMEDIATE?this.renderer.updateTileTexture(t,xT.TEXTURE_NOFADING):t.updateRenderData(sx.MAP,e)})),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll((i=>i.removeLayerAgent(e,t))),this._allTiles.forAll((i=>i.invalidateLayerData(e,t)))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=wc.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){1==++this._pendingUpdates&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),a=s.layer;return!a.tilemapCache||ic(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...r,timeout:6e3}).then((()=>--this._asyncWorkItems)).catch((t=>{throw--this._asyncWorkItems,p(r),d(t)||this._dataMissing(e,i,s,{notInTilemap:!0}),t})).then((()=>this._frameTask.schedule((()=>this._requestTileData(e,i,s,r)),r.signal))))}_requestTileData(e,t,i,r){return t===sx.ELEVATION?cc(i)?this._requestElevationTileData(e,i,r):Promise.reject():hc(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=r=>{if(h(i))return;const s=this._layerIndexByUid[sx.ELEVATION].get(t.uid);null!=s?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,s,r)):E.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",sx.ELEVATION,e.lij.toString())},s=i=>{d(i)||(this._dataMissing(e,sx.ELEVATION,t,i),this.requestUpdate())};if(dc(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:qc,signal:i.signal}).then((e=>{if(!h(i))return this._frameTask.schedule((()=>r(e)),i.signal,s);E.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")}),s).finally((()=>{--this._asyncWorkItems}));const a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(a,"binary",i).then((e=>this._lercDecoder.decode(e,{noDataValue:qc},i.signal))).then((e=>{e?r(new jc(e)):s(new Error("LERC decoding failed"))}),s).finally((()=>{--this._asyncWorkItems}))}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(r,s)=>{--this._asyncWorkItems,Uh(s),h(i)||(this._dataMissing(e,sx.MAP,t,r),this.requestUpdate())},s=e=>t=>r(t,e),a=r=>this._frameTask.schedule((()=>{--this._asyncWorkItems,this.requestUpdate(),h(i)?Uh(r):this._mapTileDataArrived(e,t,r)}),i.signal,s(r)).catch(s(r)),n=(e,t=null)=>this._frameTask.schedule((()=>r(e,t)));if(ic(t)){const r=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(r[0],r[1],r[2],i).then(a,n)}if(uc(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(a,n);if(pc(t)&&dc(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then((e=>{if(h(i))return E.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(l());a(e)}),n);let o=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);Nc(t.layer)&&t.layer.refreshTimestamp&&(o+=`${o.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const c=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,c,i).then(a,n)}_mapTileDataArrived(e,t,i){const r=this._getLayerIdxByUID(sx.MAP,t.uid);A(r)?e.dataArrived(r,sx.MAP,i):(Uh(i),E.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i,r){const s=this._getLayerIdxByUID(t,i.uid);A(s)?e.dataMissing(s,t,r):E.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll((e=>{e.renderData&&this.overlayManager.setTileParameters(e)})),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll((t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))})),e}get usedMemory(){return this.tilingScheme?(M(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),A(this._usedMemory)?this._usedMemory:0):0}_recalculateUsedMemory(){return this.tilingScheme?this._allTiles.reduce(((e,t)=>e+t.usedMemory),0):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return A(r)&&this._allTiles.forAll((e=>t+=e.getUsedMemoryForLayer(i,r))),t}getTile(e){if(M(e)||M(this._rootTiles))return null;const t=e.split("/").map((e=>+e));if(0===t[0])return this._rootTiles.find((e=>e.lij[1]===t[1]&&e.lij[2]===t[2]));const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let a;if(this._rootTiles.some((e=>e.lij[1]===r&&e.lij[2]===s&&(a=e,!0))),a){let e=1<<t[0]-1;for(;a.lij[0]<t[0];){let i=t[1]&e?2:0;if((t[2]&e)>0&&i++,!a.children[i])return null;a=a.children[i],e>>=1}return jh(a.lij[0]===t[0]&&a.lij[1]===t[1]&&a.lij[2]===t[2],"not the right tile?"),a}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{A(e._rootTiles)&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){ZC.clear(),e._allTiles.forAll((e=>{e.visible&&e.rendered&&ZC.push(e)}));const t=ZC.toArray();return Vx(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}checkAllTilesWaterproofness(){if(!Yh)return;const e=this._rootTiles;if(M(e))return;const t=e=>e?.renderData?.geometryInfo?.indices?.length>0,i=(e,i)=>{t(e)&&console.error("Tile[",e.lij,"] has geometry although parent[",i.lij,"] has geom")},r=e=>{if(e.intersectsClippingArea)if(e.renderData&&!e.renderData.geometryState&&console.error("Tile[",e.lij,"] has renderData but not geometryState"),e.renderData&&!e.renderData.geometryInfo&&console.error("Tile[",e.lij,"] has renderData but not geometryInfo"),!e.renderData?.geometryInfo||(e.renderData.geometryInfo.indices?.length??0)>0||console.error("Tile[",e.lij,"] has renderData but no indices - geometryInfo: ",e.renderData.geometryInfo),t(e)){e.checkGeometryWaterproofness();for(const t of e.children)i(t,e)}else if(e.isLeaf)console.error("Tile[",e.lij,"] has no geometry and no children, from root to leaf");else for(const t of e.children)r(t)},s=e=>{const t=e.parent?.visible??!0,i=e.visible;e.computeVisibility();const r=e.visible;if(i!==r&&t&&console.error(" Tile[",e.lij,"] has out of date visibility: ",i," instead of ",r),!e.isLeaf)for(const t of e.children)s(t)};for(const t of e)r(t),s(t)}get isGlobal(){return this._isGlobal}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateeCarree(){return this._isWebMercatorOnPlateeCarree}isEastEndWrap(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this.isGlobal&&0===e[2]}lijEastEnd(e){return 2**(e+(A(this.spatialReference)&&this.spatialReference.isGeographic?1:0))}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this.isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){mc(e)}enableWaterproofnessChecks(e){_c(e)}};e([ce()],HC.prototype,"_renderer",void 0),e([ce({constructOnly:!0})],HC.prototype,"_scaleRangeQueries",void 0),e([ce({constructOnly:!0})],HC.prototype,"view",void 0),e([ce({constructOnly:!0})],HC.prototype,"overlayManager",void 0),e([ce()],HC.prototype,"_hasPendingUpdates",void 0),e([ce()],HC.prototype,"_asyncWorkItems",void 0),e([ce()],HC.prototype,"_allTilesDirty",void 0),e([ce()],HC.prototype,"_allTilesSorted",void 0),e([ce()],HC.prototype,"_viewChanged",void 0),e([ce()],HC.prototype,"_splitLimits",void 0),e([ce({readOnly:!0})],HC.prototype,"_watchUpdatingTracking",void 0),e([ce()],HC.prototype,"_frameTask",void 0),e([ce({readOnly:!0})],HC.prototype,"snapLevel",null),e([ce({readOnly:!0})],HC.prototype,"lodSnapping",null),e([ce()],HC.prototype,"_userClippingExtent",null),e([ce()],HC.prototype,"_rootTilesExtent",void 0),e([ce({readOnly:!0})],HC.prototype,"extent",null),e([ce({readOnly:!0})],HC.prototype,"groundExtent",null),e([ce({readOnly:!0})],HC.prototype,"_tilingSchemeExtent",null),e([ce({readOnly:!0})],HC.prototype,"updating",null),e([ce({readOnly:!0})],HC.prototype,"running",null),e([ce(Xb)],HC.prototype,"updatingProgress",void 0),e([ce({readOnly:!0})],HC.prototype,"updatingProgressValue",null),e([ce()],HC.prototype,"_maxNumUpdating",void 0),e([ce()],HC.prototype,"baseOpacity",null),e([ce()],HC.prototype,"hasCompositeBlendMode",void 0),e([ce({readOnly:!0})],HC.prototype,"viewingMode",null),e([ce()],HC.prototype,"maxTextureScale",void 0),e([ce({readOnly:!0})],HC.prototype,"ready",null),e([ce({value:Lx.FRONT_TO_BACK})],HC.prototype,"renderOrder",null),e([ce({readOnly:!0})],HC.prototype,"rootTiles",null),e([ce()],HC.prototype,"_rootTiles",void 0),e([ce({readOnly:!0})],HC.prototype,"spatialReference",null),e([ce({type:pr})],HC.prototype,"backgroundColor",null),e([ce({value:!1})],HC.prototype,"slicePlaneEnabled",null),e([ce({readOnly:!0})],HC.prototype,"tilingScheme",void 0),e([ce({readOnly:!0})],HC.prototype,"tilingSchemeLocked",null),e([ce({readOnly:!0})],HC.prototype,"tilingSchemeLogic",void 0),e([ce({value:!0})],HC.prototype,"velvetOverground",null),e([ce()],HC.prototype,"wireframe",null),e([ce({value:!1})],HC.prototype,"suspended",null),e([ce()],HC.prototype,"textureFadeDuration",null),e([ce()],HC.prototype,"visibleElevationBounds",void 0),e([ce()],HC.prototype,"rootTileElevationBounds",void 0),e([ce()],HC.prototype,"_layerViewsDirty",void 0),e([ce()],HC.prototype,"renderPatchBorders",null),e([ce()],HC.prototype,"visualizeNormals",null),e([ce()],HC.prototype,"renderingDisabled",null),HC=e([ue("esri.views.3d.terrain.TerrainSurface")],HC);const BC=HC;function WC(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function $C(e){const t=e.children;if(!t[0])return!1;for(const e of t)if(e.shouldLoad)return!0;for(const e of t)if($C(e))return!0;return!1}const QC=_r(),XC=at(),YC=[0,0,0],ZC=new J,KC={spatialReference:null,extent:at(),context:"ground"},JC={spatialReference:null,extent:null,scale:0};function eS(e,t,i){for(const r of e){if(!r.containsPointXY(t,i))continue;let e=r;for(;e&&!e.renderData;){const r=(t>e.extentMidX?1:0)+(i<e.extentMidY?2:0);e=e.children[r]}return Jb(t,i,e?.renderData?.geometryState.samplerData??null)}return null}class tS{constructor(e,t,i){this.operation=e,this.geometry=t,this.states=i}}let iS=class extends Hi{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach(((i,r)=>{const s=this._ensureGeomRecord(e,r);i.forEach((({geometry:e,operation:i,states:a},n)=>{let o=!1;if(i===Sn.UPDATE){const i=s.get(n);if(i){if(a&Pn.TRANSFORMATION){const t=this.model.getObject(r);this.model.updateRenderGeometryTransformation(t,e,i)&&(o=!0)}o||t.updates.push({renderGeometry:i,updateType:a})}else no(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(i===Sn.REMOVE||o){const e=s.get(n);e?(t.removes.push(e),s.delete(n)):i===Sn.REMOVE&&no(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(i===Sn.ADD||o){const i=this.model.getObject(r);if(A(i)){const r=this.model.getRenderGeometry(i,e);t.adds.push(r),s.set(n,r)}}})),0===s.size&&this._residentGeomRecords.get(e).delete(r)})),0===this._residentGeomRecords.get(e).size&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach((e=>e.forEach((e=>t.push(e)))))}_objectStateChanged(e,t){for(const i of t.geometries)this._updateOrCreateDirtyRecord(t,i,null,Sn.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(Pn.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(Pn.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(Pn.OCCLUDEE,e)}objectGeometryUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,Sn.UPDATE,Pn.GEOMETRY)}layerAdded(e){e.objects.forAll((t=>this._layerObjectAdded(e,t)))}layerRemoved(e){e.objects.forAll((t=>this._layerObjectRemoved(e,t)))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const e of t.geometries)this._objectGeometryAdded(t,e,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const e of t.geometries)this._objectGeometryRemoved(t,e,i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach(((e,t)=>{const i=this.model.getObject(t);i&&i.hasVolativeTransformation()&&e.forEach((e=>e.shaderTransformationChanged()))}))}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach((i=>{this._updateOrCreateDirtyRecord(e,i.geometry,t,Sn.UPDATE,Pn.TRANSFORMATION)}))}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.geometry)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Sn.ADD)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.geometry)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Sn.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,r,s=Pn.NONE){i=j(i,this._getParentLayerId(e));const a=e.id,n=t.id,o=this._ensureDirtyRecord(i,a),l=o.get(n);if(l){const e=l.operation;e===Sn.REMOVE&&r===Sn.ADD&&l.states!==Pn.NONE?l.operation=Sn.UPDATE:e===Sn.REMOVE&&r===Sn.ADD||e===Sn.ADD&&r===Sn.REMOVE?o.delete(n):e!==Sn.UPDATE||r!==Sn.REMOVE&&r!==Sn.UPDATE?(no((e===Sn.REMOVE||e===Sn.ADD)&&r===Sn.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),l.states|=s):(l.operation=r,l.states|=s)}else o.set(n,new tS(r,t,s));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return me(this._dirtyGeomRecords,(e=>me(e,(e=>e&&e.size>0))))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return A(e.parentLayer)?e.parentLayer.id:ah}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach(((i,r)=>{i.forEach(((i,s)=>{t.length>0&&(t+="\n"),t+=r+"."+s;const a=[];i.forEach((e=>{const t=e.operation;a[t]||(a[t]=[]),a[t].push(e.geometry.id)}));for(let i=0;i<a.length;i++)if(a[i]){t+=" "+e[i-1]+": ";for(let e=0;e<a[i].length;e++)t+=a[i][e]+", "}}))})),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce(((e,t)=>e+t.size),0)},commit:t=>e._dirtyGeomRecords.forEach(((i,r)=>e.commitLayer(r,t)))}}};e([ce({constructOnly:!0})],iS.prototype,"model",void 0),e([ce()],iS.prototype,"dirty",void 0),iS=e([ue("esri.views.3d.webgl-engine.lib.ModelDirtySet")],iS);const rS=iS;let sS=class extends Hi{constructor(){super(...arguments),this.dirtySet=new rS({model:this}),this._content=new Map,this._originFactory=new Rn(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;no(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),oh(e)&&this.dirtySet.layerAdded(e)}remove(e){no(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),oh(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)A(t)&&(no(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)no(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach((i=>{i.type===e&&t(i)}))}getRenderGeometry(e,t){const{shaderTransformer:i,localOrigin:r}=t,s=new On(t,{shaderTransformer:i,castShadow:e.castShadow});return s.updateTransformation((i=>e.getCombinedStaticTransformation(t,i))),s.localOrigin=A(r)?r:this._originFactory.getOrigin(s.boundingSphere),s}updateRenderGeometryTransformation(e,t,i){if(M(e))return!1;i.updateTransformation((i=>e.getCombinedStaticTransformation(t,i)));const r=this._originFactory.getOrigin(i.boundingSphere);return i.localOrigin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<Ys.COUNT;++i)e[i]=t.filter((e=>e.type===i)).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};e([ce({constructOnly:!0})],sS.prototype,"dirtySet",void 0),sS=e([ue("esri.views.3d.webgl-engine.parts.Model")],sS);class aS{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}allVisible(){return this.componentCount()===this._totalCount}allInvisible(){return 0===this._indexRanges.length}componentCount(){const e=this._indexRanges;let t=0;for(let i=0;i<e.length;i+=2)t+=e[i+1];return t}reset(e){"all"===e||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=function(e){const t=new Array;if(0===e.length)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const a=e[s];i+r===a?r+=1:(t.push(i),t.push(r),i=a,r=1)}return t.push(i),t.push(r),t}(e)}forEachComponent(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i],s=r+t[i+1];for(let t=r;t<s;t++)if(!e(t))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let i=0;i<t.length;i+=2){const r=t[i];if(!e(r,r+t[i+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],a=s+i[r+1],n=e[s],o=e[a];t[r]=n,t[r+1]=o-n}return t}}let nS=class extends Hi{constructor(){super(...arguments),this.visible=oS.Hidden}};var oS;function lS(e,t,i,r){if(i>=t)return e;null==e&&(e=function(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}());const s=e.isVisibleBit;let a=e.data;const n=cS(a),o=i/n|0,l=i-n*o,h=(t-1)/n|0,c=a,d=r===s;if(!(i<c.length*n)&&d){const e=1.5,t=o+1,i=Math.ceil(c.length*e),r=h+1;let s=Math.max(t,i);s=Math.min(s,r),a=new Uint32Array(s),a.set(c)}return o<a.length&&(a[o]=function(e,t,i){return e&~(1<<t)|(i?1:0)<<t}(a[o],l,d)),e.data=a,e}function hS(e,t){if(null==e)return!0;const{isVisibleBit:i,data:r}=e,s=cS(r);return t<r.length*s?function(e,t,i,r){const s=i/r|0,a=i-s*r;return function(e,t){return 0!=(e&1<<t)}(t[s],a)===e}(i,r,t,s):!e.isVisibleBit}function cS(e){return 8*e.BYTES_PER_ELEMENT}e([ce({autoDestroy:!0})],nS.prototype,"renderable",void 0),e([ce({autoDestroy:!0})],nS.prototype,"components",void 0),nS=e([ue("esri.views.3d.webgl-engine.collections.Component.ComponentObject")],nS),function(e){e[e.Hidden=0]="Hidden",e[e.Visible=1]="Visible"}(oS||(oS={}));class dS{constructor(e,t){this._indices=A(e.indices)?e.indices:Zd(e.positions.length/3),this._positions=e.positions,this._components=t,this._componentIntersectionData=new Array(t.count)}getComponentAabb(e,t){if(A(this._perComponentAabbs)){for(let i=0;i<6;i++)t[i]=this._perComponentAabbs[6*e+i];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions,t.stride=3,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,i,r,s,a,n){const o=new kd(this._positions,3,!1,3),l=this._indices,h=this._components.offsets,c=sa(e,t,uS),d=e[2],u=t[2];this._components.visibility.forEachComponent((p=>{if(!hS(this._components.pickability,p))return!0;const m=this.getComponentAabb(p,pS);if(A(a)){const i=a[p];A(s)?s.componentOffset=i:(e[2]=d-i,t[2]=u-i)}if(A(s)&&s.applyToAabb(m),!aa(m,e,c,i))return!0;const _=h[p]/3,g=h[p+1]/3,f=g-_,y=(e,t,i)=>n(p,e,Be(t,t,r),i);return M(s)&&f>200?(null==this._componentIntersectionData[p]&&(this._componentIntersectionData[p]=new OC(this._indices,_,g,o)),this._componentIntersectionData[p].intersectRay({r0:e,r1:t},y)):ra(e,t,_,g,l,o,void 0,s,y),!0}))}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);const t=this._indices,i=this._positions,r=this._components.offsets;let s=0;for(let a=0;a<e;a++){const e=r[a],n=r[a+1];let o=1/0,l=1/0,h=1/0,c=-1/0,d=-1/0,u=-1/0;for(let r=e;r<n;r++){const e=3*t[r],s=i[e],a=i[e+1],n=i[e+2];o=Math.min(o,s),l=Math.min(l,a),h=Math.min(h,n),c=Math.max(c,s),d=Math.max(d,a),u=Math.max(u,n)}this._perComponentAabbs[s++]=o,this._perComponentAabbs[s++]=l,this._perComponentAabbs[s++]=h,this._perComponentAabbs[s++]=c,this._perComponentAabbs[s++]=d,this._perComponentAabbs[s++]=u}}get positions(){return this._positions}get indices(){return this._indices}}const uS=ve(),pS=Yl();class mS{constructor(e,t,i,r){this.vao=e,this.primitiveType=t,this.parameters=i,this.indexed=r}dispose(){this.vao.dispose()}}class _S{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}}function gS(e){return e?fS(e,1/0,-1/0):{near:1/0,far:-1/0}}function fS(e,t,i){return e.near=t,e.far=i,e}function yS(e,t,i=e){return null!=t&&(i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far)),i}function vS(e,t){return e.near<=t&&t<=e.far}const bS={near:0,far:0},xS=new J({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=q(e.object),e)}),TS=gS(),wS=ve(),CS=ve(),SS=new J({deallocator:null}),PS=new J({deallocator:null});function RS(e,t,i){i.length=0;const r=t.length-3;OS(wS,t,r);const s=tl(e,wS);s<=0&&(i.push(wS[0]),i.push(wS[1]),i.push(wS[2]));let a=0,n=s;for(;a<r;a+=3){OS(CS,t,a);const r=tl(e,CS);n*r<0&&(we(wS,CS,wS,r/(r-n)),ES(i,wS)),r<=0&&ES(i,CS),n=r,De(wS,CS)}n*s<0&&(OS(CS,t,r),we(wS,CS,wS,s/(s-n)),ES(i,wS))}function OS(e,t,i){return Pe(e,t.data[i],t.data[i+1],t.data[i+2])}function ES(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function AS(e,t,i,r){Kd(IS,e.quaternion),Re(LS,t,e.center),We(LS,LS,IS);const s=8*((LS[0]<-e.halfSize[0]?-1:LS[0]>e.halfSize[0]?1:0)+3*(LS[1]<-e.halfSize[1]?-1:LS[1]>e.halfSize[1]?1:0)+9*(LS[2]<-e.halfSize[2]?-1:LS[2]>e.halfSize[2]?1:0)+13),a=MS[s];if(0===a)return a;Ha(DS,e.quaternion),Ba(DS,DS,e.halfSize);const n=(t,i)=>{const r=MS[s+i+1];return Pe(t,((1&r)<<1)-1,(2&r)-1,((4&r)>>1)-1),Be(t,t,DS),Oe(t,e.center,t)};return i.length=0,ES(i,n(NS,0)),ES(i,n(FS,1)),ES(i,n(LS,2)),ES(i,n(US,3)),r(i),1===a||(i.length=0,ES(i,NS),ES(i,US),ES(i,n(LS,4)),ES(i,n(jS,5)),r(i),2===a||(i.length=0,ES(i,NS),ES(i,jS),ES(i,n(LS,6)),ES(i,FS),r(i))),a}const MS=(()=>{const e=new Int8Array(216);let t=0;const i=i=>{for(let r=0;r<i.length;r++)e[t+r]=i[r];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),DS=Za(),IS=Jd(),LS=ve(),NS=ve(),FS=ve(),US=ve(),jS=ve();class VS{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll((i=>i.renderable.material.submit(e,t,i)))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?function(e,t){const i=gS(),{eye:r,frustum:s,viewForward:a}=e;t.forAll((e=>{const t=A(e.offsetObb)?e.offsetObb:e.obb,n=xe(Re(LS,t.center,r),a),o=Wd(t,a);if(vS(i,n-o)&&vS(i,n+o))return;const l=function(e,t){let i=0;for(let r=0;r<4;r++){const s=$d(e,t[r]);if(s>0)return-1;0===s&&(i|=1<<r)}return i}(t,s);if(-1===l)return;if(0===l)return TS.far=n+o,TS.near=n-o,void yS(i,TS);const h=xS.pushNew();h.near=n-o,h.far=n+o,h.mask=l,h.object=e}));for(let e=0;e<xS.length;e++){const t=xS.data[e];if(vS(i,t.near)&&vS(i,t.far))continue;TS.far=t.far,TS.near=1/0;const n=AS(A(t.object.offsetObb)?t.object.offsetObb:t.object.obb,r,SS,(e=>{let i=PS;for(let r=0;r<4&&e.length>0;r++){if(0==(t.mask&1<<r))continue;RS(s[r],e,i);const a=e;e=i,i=a}for(let t=0;t<e.length;t+=3){Pe(wS,e.data[t],e.data[t+1],e.data[t+2]);const i=xe(Re(wS,wS,r),a);TS.near=Math.min(TS.near,i)}}));0===n&&(TS.near=0),yS(i,TS)}return xS.length=0,i}(e,this._objects.visibleObjects):null}}function kS(e){const t=Xn().vec3f(Gs.POSITION);return e.normals&&t.vec2i16(Gs.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===ns.Default?t.vec2f(Gs.UV0):e.textureCoordinates===ns.Atlas&&(t.vec2f(Gs.UV0),t.vec4u16(Gs.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(Gs.COLOR,{glNormalized:!0}),t.alignTo(4)}class zS{constructor(){this.externalColor=_r(),this.externalColorMixMode=Hd.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}}class qS extends ks{constructor(e,t){super(e,"int",zs.Draw,((i,r,s)=>i.setUniform1i(e,t(r,s))))}}var GS;!function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"}(GS||(GS={}));const HS=429496.7296;function BS(e,t){eu(e/HS*.5+.5,t)}function WS(e,t){switch(t.componentData){case GS.Varying:return function(e,t){const{vertex:i,fragment:r}=e;i.include(Ds),i.uniforms.add(new nu("componentColorTex",(e=>e.componentParameters.texture.texture))),e.attributes.add(Gs.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4");const s=t.output===_o.ObjectAndLayerIdColor;s&&e.varyings.add("vObjectAndLayerIdColor","vec4"),e.include(iu),i.constants.add("elevationScale","float",2*HS),i.constants.add("stride","float",b("enable-feature:objectAndLayerId-rendering")?3:2),i.code.add(Fs`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),i.code.add(Fs`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);

    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

   float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);

    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return (rgba2float(encodedElevation) - 0.5) * elevationScale;
  }

  ${s?Fs`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);

            vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
          }`:Fs`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),r.code.add(Fs`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${s?Fs`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}(e,t);case GS.Uniform:return function(e){const{vertex:t,fragment:i}=e;t.uniforms.add(new HT("externalColor",(e=>e.componentParameters.externalColor))),i.uniforms.add(new qS("externalColorMixMode",(e=>e.componentParameters.externalColorMixMode))),e.varyings.add("vExternalColor","vec4"),t.code.add(Fs`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),i.code.add(Fs`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}
void outputObjectAndLayerIdColor() {
fragColor = vec4(1.0,0.0,0.0,0.0);
}`)}(e);case GS.COUNT:return;default:nr(t.componentData)}}var $S,QS,XS;function YS(e,t){const i=e.vertex;switch(i.code.add(Fs`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case $S.None:i.code.add(Fs`#define vertexDiscardByOpacity(_opacity_) {}`);break;case $S.Opaque:i.code.add(Fs`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case $S.Transparent:i.code.add(Fs`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}function ZS(e){return e&&xr(e)?QS.Mars:e&&Tr(e)?QS.Moon:QS.Earth}!function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"}($S||($S={})),function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"}(QS||(QS={})),function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(XS||(XS={}));class KS extends Aa{constructor(){super(...arguments),this.output=_o.Color,this.textureCoordinateType=ns.None,this.componentData=GS.Uniform,this.cullFace=Pc.Back,this.vertexDiscardMode=$S.None,this.doubleSidedMode=ou.WindingOrder,this.alphaDiscardMode=Rc.Opaque,this.integratedMeshMode=XS.None,this.transparencyPassType=lu.NONE,this.ellipsoidMode=QS.Earth,this.pbrMode=hs.Disabled,this.normalType=vd.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasBaseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1}}function JS(e,t){e.include(hu,t),e.fragment.include(ru);const i=e.fragment;i.uniforms.add(new HT("baseColor",(e=>e.baseColor))),i.uniforms.add(new su("objectOpacity",(e=>e.objectOpacity))),t.hasVertexColors?i.code.add(Fs`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(Fs`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(Fs`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function eP(e,t){const i=e.fragment;switch(t.doubleSidedMode){case ou.None:i.code.add(Fs`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case ou.View:e.include(an,t),i.code.add(Fs`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case ou.WindingOrder:i.code.add(Fs`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:nr(t.doubleSidedMode);case ou.COUNT:}switch(t.normalType){case vd.Attribute:case vd.CompressedAttribute:e.include(bd,t),i.code.add(Fs`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case vd.ScreenDerivative:e.include(an,t),i.code.add(Fs`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case vd.Ground:t.spherical?(e.include(an,t),i.code.add(Fs`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):i.code.add(Fs`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),i.code.add(Fs`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:nr(t.normalType);case vd.COUNT:}}function tP(e,t){const i=e.fragment;if(!t.hasBaseColorTexture||t.output!==_o.Color&&t.alphaDiscardMode===Rc.Opaque)i.code.add(Fs`vec4 readBaseColorTexture() { return vec4(1.0); }`);else{e.include(_s,t);const r=t.textureCoordinateType===ns.Atlas;i.uniforms.add(new nu("baseColorTexture",(e=>e.texture))),r?(e.include(gs),i.code.add(Fs`vec4 readBaseColorTexture() {
return textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);
}`)):i.code.add(Fs`vec4 readBaseColorTexture() {
return texture(baseColorTexture, vuv0);
}`)}}function iP(e){return 0===e.overlays.length?null:e.overlays[Jc.INNER].getValidTexture(rd.Water)}e([Ea({count:_o.COUNT})],KS.prototype,"output",void 0),e([Ea({count:ns.COUNT})],KS.prototype,"textureCoordinateType",void 0),e([Ea({count:GS.COUNT})],KS.prototype,"componentData",void 0),e([Ea({count:Pc.COUNT})],KS.prototype,"cullFace",void 0),e([Ea({count:$S.COUNT})],KS.prototype,"vertexDiscardMode",void 0),e([Ea({count:ou.COUNT})],KS.prototype,"doubleSidedMode",void 0),e([Ea({count:Rc.COUNT})],KS.prototype,"alphaDiscardMode",void 0),e([Ea({count:XS.COUNT})],KS.prototype,"integratedMeshMode",void 0),e([Ea({count:lu.COUNT})],KS.prototype,"transparencyPassType",void 0),e([Ea({count:QS.COUNT})],KS.prototype,"ellipsoidMode",void 0),e([Ea({count:hs.COUNT})],KS.prototype,"pbrMode",void 0),e([Ea({count:vd.COUNT})],KS.prototype,"normalType",void 0),e([Ea()],KS.prototype,"spherical",void 0),e([Ea()],KS.prototype,"doublePrecisionRequiresObfuscation",void 0),e([Ea()],KS.prototype,"hasVertexColors",void 0),e([Ea()],KS.prototype,"hasNormals",void 0),e([Ea()],KS.prototype,"hasSlicePlane",void 0),e([Ea()],KS.prototype,"hasBaseColorTexture",void 0),e([Ea()],KS.prototype,"receiveAmbientOcclusion",void 0),e([Ea()],KS.prototype,"receiveShadows",void 0),e([Ea()],KS.prototype,"blendingEnabled",void 0),e([Ea()],KS.prototype,"hasScreenSpaceReflections",void 0),e([Ea()],KS.prototype,"hasPolygonOffset",void 0),e([Ea()],KS.prototype,"hasMetallicRoughnessTexture",void 0),e([Ea()],KS.prototype,"hasEmissionTexture",void 0),e([Ea()],KS.prototype,"hasOcclusionTexture",void 0),e([Ea()],KS.prototype,"hasNormalTexture",void 0),e([Ea()],KS.prototype,"hasOccludees",void 0),e([Ea()],KS.prototype,"hasMultipassTerrain",void 0),e([Ea()],KS.prototype,"cullAboveGround",void 0),e([Ea()],KS.prototype,"hasCloudsReflections",void 0),e([Ea()],KS.prototype,"snowCover",void 0),e([Ea()],KS.prototype,"objectAndLayerIdColor",void 0),e([Ea({constValue:zs.Draw})],KS.prototype,"pbrTextureBindType",void 0),e([Ea({constValue:!0})],KS.prototype,"hasSliceHighlight",void 0),e([Ea({constValue:!1})],KS.prototype,"hasSliceInVertexProgram",void 0),e([Ea({constValue:!1})],KS.prototype,"useCustomDTRExponentForWater",void 0),e([Ea({constValue:!1})],KS.prototype,"hasVertexTangents",void 0),e([Ea({constValue:!0})],KS.prototype,"supportsTextureAtlas",void 0),e([Ea({constValue:!1})],KS.prototype,"highStepCount",void 0),e([Ea({constValue:!1})],KS.prototype,"instancedDoublePrecision",void 0),e([Ea({constValue:!0})],KS.prototype,"useFillLights",void 0),e([Ea({constValue:!1})],KS.prototype,"objectAndLayerIdColorInstanced",void 0);const rP=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new Vs;t.include(an,e),t.include(bd,e),t.include(hu,e),t.include(as,e),t.include(sn,e),t.include(WS,e),t.include(au,e),t.include(gd,e),t.include(tP,e),t.include(YS,e);const{vertex:i,fragment:r}=t;e.pbrMode!==hs.Normal&&e.pbrMode!==hs.Schematic||(t.include(fs,e),e.hasNormalTexture&&t.include(cu,e));const s=e.output===_o.Shadow||e.output===_o.ShadowHighlight||e.output===_o.ShadowExcludeHighlight;s&&e.componentData===GS.Varying?i.code.add(Fs`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):i.code.add(Fs`#define discardShadows(castShadows) {}`);const a=e.integratedMeshMode===XS.ColorOverlay||e.integratedMeshMode===XS.ColorOverlayWithWater,n=a&&e.output===_o.Color&&e.pbrMode===hs.WaterOnIntegratedMesh;return a&&(t.include(Cd,e),t.include(WT,e),e.spherical?i.code.add(Fs`
      const float invEllipsoidRadius = ${Fs.float(1/(e.ellipsoidMode===QS.Earth?er.radius:e.ellipsoidMode===QS.Mars?tr.radius:ir.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):i.code.add(Fs`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),n&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),i.code.add(Fs`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${e.output===_o.ObjectAndLayerIdColor?Fs`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${Fs.float(uu)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${e.output===_o.ObjectAndLayerIdColor?Fs`forwardObjectAndLayerIdColor();`:""}
      ${n?e.spherical?Fs`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:Fs`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${a?Fs`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),e.output===_o.Alpha&&(r.include(bs),t.include(du,e),t.include(JS,e),a&&r.uniforms.add(new qs("ovColorTex",((e,t)=>QT(e,t)))),r.code.add(Fs`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.hasMultipassTerrain?Fs`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${a?Fs`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        fragColor = vec4(materialColor.a);
      }
    `)),e.output===_o.Color&&(r.include(bs),t.include(du,e),t.include(JS,e),t.include(eP,e),t.include(Cd,e),e.receiveShadows?(t.include(ys,e),r.code.add(Fs`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):r.code.add(Fs`float evaluateShadow() { return 0.0; }`),a&&r.uniforms.add(new qs("ovColorTex",((e,t)=>QT(e,t)))),r.code.add(Fs`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.hasMultipassTerrain?Fs`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${a?Fs`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),e.pbrMode===hs.Normal||e.pbrMode===hs.Schematic?(ps(r),r.code.add(Fs`
        ${e.pbrMode===hs.Normal?Fs`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),e.hasNormalTexture?r.code.add(Fs`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):r.code.add(Fs`vec3 shadingNormal = normalVertex;`),r.code.add(Fs`${e.spherical?Fs`vec3 normalGround = normalize(positionWorld());`:Fs`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),r.code.add(Fs`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());

        ${e.snowCover?Fs`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);

                shadingNormal = mix(shadingNormal, surfaceNormal, snow);
                ssao = mix(ssao, 0.0, snow);
                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                emission = mix(emission, vec3(0.0), snow);`:""}

        ${a?Fs` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(e.receiveShadows?r.code.add(Fs`float shadow = evaluateShadow();`):e.spherical?(Rd(r),r.code.add(Fs`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):r.code.add(Fs`float shadow = 0.0;`),n&&r.uniforms.add(new qs("ovNormalTex",((e,t)=>iP(t)))),e.snowCover&&r.code.add(Fs`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`),r.code.add(Fs`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${a?Fs` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${n?Fs`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),r.code.add(Fs`
        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.transparencyPassType===lu.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `)),(e.output===_o.Depth||s)&&(t.include(xd,e),r.code.add(Fs`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),e.output===_o.Normal&&(t.include(eP,e),r.code.add(Fs`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${e.normalType===vd.Ground?"0.0":"1.0"};
        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),e.output===_o.ObjectAndLayerIdColor&&t.fragment.code.add(Fs`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${a?Fs`fragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),e.output===_o.Highlight&&(t.include(Td,e),r.code.add(Fs`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${a?Fs`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  fragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),t},getOverlayNormalTexture:iP},Symbol.toStringTag,{value:"Module"}));class sP extends Hs{initializeConfiguration(e,t){t.spherical=e.viewingMode===Ui.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Bs(e.rctx,sP.shader.get().build(this.configuration),aP)}_setPipelineState(e){const t=this.configuration,i=t.integratedMeshMode!==XS.None,r=e===lu.NONE,s=e===lu.FrontFace;return Ta({blending:t.output!==_o.Color&&t.output!==_o.Alpha||!t.blendingEnabled?null:r?mu:_u(e),culling:Oa(t.cullFace),depthTest:{func:gu(e)},depthWrite:r||s?Ra:null,colorWrite:Ca,stencilWrite:i||t.hasOccludees?to:null,stencilTest:i?io(Sc.IntegratedMeshMaskExcluded):t.hasOccludees?ro:null,polygonOffset:r||s?t.hasPolygonOffset?{factor:2,units:2}:null:fu})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}sP.shader=new Ws(rP,(()=>Promise.resolve().then((()=>rP))));const aP=new Map([[Gs.POSITION,0],[Gs.NORMAL,1],[Gs.NORMALCOMPRESSED,1],[Gs.COLOR,2],[Gs.UV0,3],[Gs.UVREGION,4],[Gs.COMPONENTINDEX,5]]);class nP extends Us{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,null!=this._parameterBlocks)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(null==this._parameterBlocks)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}}class oP{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function lP(e={}){return(t,i)=>{const r=t._parameterCount??0;if(t._parameterCount=r+1,e.vectorOps){const s=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(e){const t=this[r];if(null==t)this[r]=e;else{if(s.equals(t,e))return;s.copy(t,e)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(t){this[r]!==t&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=t,this._setDirty())}})}}function hP(){return(e,t)=>{const i=e._parameterCount??0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(e){this[i]!==e&&(this[i]=e,this._setDirty())}})}}class cP{constructor(e){this._low=Ya(),this._high=Ya(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const t=this._low,i=this._high;De(t,e),Re(i,e,t)}setElements(e,t,i){Pe(dP,e,t,i),this.set(dP)}get(e){return Oe(e,this._low,this._high)}getLowScaled(e){return Te(e,this._low,1)}}const dP=ve();class uP extends nP{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=Th(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Qa(1,1,.5),this.emissiveFactor=Qa(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new _P,this.componentParameters=new gP,this.textureAlphaCutoff=pu,this.alphaDiscardMode=Rc.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=QS.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new KS;const i=new cP(e.position),r=zd(e.rotationScale);Wa(r,r),this.transformNormalGlobalFromModel=$a(r,r),this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=N(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return A(this.baseColorTexture)?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return A(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return A(this.emissionTexture)?this.emissionTexture.glTexture:null}get textureOcclusion(){return A(this.occlusionTexture)?this.occlusionTexture.glTexture:null}get textureNormal(){return A(this.normalTexture)?this.normalTexture.glTexture:null}prepareTechnique(e,t,i,r){const s=this._techniqueConfiguration;s.hasVertexColors=r.colors,s.hasNormals=r.normals,s.textureCoordinateType=r.textureCoordinates,s.hasMetallicRoughnessTexture=A(this.metallicRoughnessTexture),s.hasEmissionTexture=A(this.emissionTexture),s.hasOcclusionTexture=A(this.occlusionTexture),s.hasNormalTexture=A(this.normalTexture),s.transparencyPassType=t.identifier===kT.Material&&null!=i.transparencyPassType?i.transparencyPassType:lu.NONE,s.hasMultipassTerrain=t.identifier===kT.Material&&null!=i.multipassTerrain&&i.multipassTerrain.enabled,s.cullAboveGround=t.identifier===kT.Material&&null!=i.multipassTerrain&&i.multipassTerrain.cullAboveGround,s.ellipsoidMode=this.ellipsoidMode,s.componentData=this.componentParameters.type,s.cullFace=this.commonMaterialParameters.cullFace,s.doubleSidedMode=this.commonMaterialParameters.doubleSided?ou.View:ou.None,s.hasBaseColorTexture=A(this.baseColorTexture);const a=this._computeWhichMaterialPass();s.blendingEnabled=a===pP.Transparent||a===pP.OpaqueAndTransparent,s.alphaDiscardMode=this.alphaDiscardMode,s.integratedMeshMode=this.isIntegratedMesh?function(e){return 0!==e.overlays.length&&A(e.overlays[Jc.INNER].getColorTextureNoRasterImage())}(i)?iP(i)?XS.ColorOverlayWithWater:XS.ColorOverlay:XS.NoOverlay:XS.None,s.hasPolygonOffset=this.polygonOffsetEnabled;const n=this.hasParametersFromSource&&M(this.baseColorTexture);if(s.pbrMode=s.integratedMeshMode===XS.ColorOverlayWithWater?hs.WaterOnIntegratedMesh:this.usePBR?n?hs.Schematic:hs.Normal:hs.Disabled,s.normalType=s.integratedMeshMode===XS.None?s.hasNormals?vd.CompressedAttribute:vd.ScreenDerivative:vd.Ground,s.hasSlicePlane=A(i.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,t.identifier===kT.ShadowMap)s.output=_o.Shadow,s.vertexDiscardMode=$S.None;else if(t.identifier===kT.Highlight)s.output=_o.Highlight,s.vertexDiscardMode=$S.None;else{switch(this._computeWhichMaterialPass()===pP.OpaqueAndTransparent?s.vertexDiscardMode=t.transparent?$S.Opaque:$S.Transparent:s.vertexDiscardMode=$S.None,s.output=t.output,s.receiveAmbientOcclusion=!1,s.receiveShadows=!1,t.output){case _o.Color:s.receiveAmbientOcclusion=i.ssaoHelper.active,s.hasOccludees=i.hasOccludees,s.receiveShadows=i.shadowMap.ready,s.hasScreenSpaceReflections=i.ssr.enabled,s.hasCloudsReflections=A(i.cloudsFade.data);break;case _o.Alpha:s.hasOccludees=i.hasOccludees;break;case _o.ObjectAndLayerIdColor:s.objectAndLayerIdColor=!0}s.snowCover=this.hasSnowCover(i)}return this._technique=e.releaseAndAcquire(sP,s,this._technique),this._setClean(),this._technique}hasSnowCover(e){return A(e.weather)&&e.weatherVisible&&"snowy"===e.weather.type&&"enabled"===e.weather.snowCover}submit(e,t,i){if(0===this.objectOpacity)return;const r=i.renderable.geometry,s=i.components,a=i.renderable.meta.cameraDepthSquared,n=s.geometryRanges,o=s.highlightRanges,l=s.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case pP.Opaque:e.materialOpaque.submitDraw(this,r,n,a);break;case pP.Transparent:e.materialTransparent.submitDraw(this,r,n,a);break;case pP.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,r,n,a),e.materialTransparent.submitDraw(this,r,n,a);break;case pP.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,r,n,a),function(e){return 0!==e.overlays.length&&A(e.overlays[Jc.INNER].getValidTexture(rd.Highlight))}(t)&&e.highlightIntegratedMesh.submitDraw(this,r,n,a)}const h=this.componentParameters.castShadows!==mP.None;h&&e.shadowMap.submitDraw(this,r,n,a),A(o)&&(e.highlight.submitDraw(this,r,o,a),h&&e.highlightShadowMap.submitDraw(this,r,o,a)),h&&A(l)&&e.defaultShadowMap.submitDraw(this,r,l,a)}_computeWhichMaterialPass(){return this.isIntegratedMesh?pP.IntegratedMesh:this.objectOpacity<1?pP.Transparent:this.componentParameters.opaqueOverride===mP.All?pP.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===Rc.Blend||this.alphaDiscardMode===Rc.MaskBlend?pP.Transparent:this.componentParameters.transparent===mP.None?pP.Opaque:this.componentParameters.transparent===mP.All?pP.Transparent:pP.OpaqueAndTransparent}}var pP,mP;e([lP({vectorOps:Ur})],uP.prototype,"baseColor",void 0),e([lP()],uP.prototype,"usePBR",void 0),e([lP()],uP.prototype,"hasParametersFromSource",void 0),e([lP({vectorOps:$e})],uP.prototype,"mrrFactors",void 0),e([lP({vectorOps:$e})],uP.prototype,"emissiveFactor",void 0),e([lP({dispose:!0})],uP.prototype,"baseColorTexture",void 0),e([lP({dispose:!0})],uP.prototype,"metallicRoughnessTexture",void 0),e([lP({dispose:!0})],uP.prototype,"emissionTexture",void 0),e([lP({dispose:!0})],uP.prototype,"occlusionTexture",void 0),e([lP({dispose:!0})],uP.prototype,"normalTexture",void 0),e([lP()],uP.prototype,"objectOpacity",void 0),e([hP()],uP.prototype,"commonMaterialParameters",void 0),e([hP()],uP.prototype,"componentParameters",void 0),e([lP()],uP.prototype,"textureAlphaCutoff",void 0),e([lP()],uP.prototype,"alphaDiscardMode",void 0),e([lP()],uP.prototype,"isIntegratedMesh",void 0),e([lP()],uP.prototype,"polygonOffsetEnabled",void 0),e([lP()],uP.prototype,"ellipsoidMode",void 0),e([lP()],uP.prototype,"hasOccludees",void 0),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(pP||(pP={}));class _P extends oP{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Pc.Back,this.hasSlicePlane=!0}}e([lP()],_P.prototype,"doubleSided",void 0),e([lP()],_P.prototype,"cullFace",void 0),e([lP()],_P.prototype,"hasSlicePlane",void 0);class gP extends oP{constructor(){super(...arguments),this.externalColor=fr(1,1,1,1),this.externalColorMixMode=Hd.Multiply,this.castShadows=mP.All}get transparent(){return this.externalColor[3]<1?mP.All:mP.None}get opaqueOverride(){return this.externalColorMixMode===Hd.Replace&&1===this.externalColor[3]?mP.All:mP.None}get visible(){return this.externalColor[3]>0?mP.All:mP.None}get type(){return GS.Uniform}}e([lP({vectorOps:Ur})],gP.prototype,"externalColor",void 0),e([lP()],gP.prototype,"externalColorMixMode",void 0),e([lP()],gP.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(mP||(mP={}));class fP extends oP{constructor(){super(...arguments),this.texture=null,this.transparent=mP.None,this.opaqueOverride=mP.None,this.castShadows=mP.None}get type(){return GS.Varying}}e([lP()],fP.prototype,"texture",void 0),e([lP()],fP.prototype,"transparent",void 0),e([lP()],fP.prototype,"opaqueOverride",void 0),e([lP()],fP.prototype,"castShadows",void 0);class yP{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}}class vP{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0,this._texture=new Zn(this._rctx,{target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,samplingMode:_a.NEAREST,wrapMode:ma.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this._data=new Fd(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,i,r,s,a){const n=e*this._fieldCount+t;this._dirty=!0,this._data.set(n,0,i),this._data.set(n,1,r),this._data.set(n,2,s),this._data.set(n,3,a)}setDataElement(e,t,i,r){const s=e*this._fieldCount+t;this._dirty=!0,this._data.set(s,i,r)}getDataElement(e,t,i){const r=e*this._fieldCount+t;return this._dirty=!0,this._data.get(r,i)}resizeToFit(e){const t=(e+1)*this._fieldCount;if(t>this._data.count){const e=Math.ceil(t/this.textureWidth)*this.textureWidth,i=new Fd(new ArrayBuffer(4*e));i.typedBuffer.set(this._data.typedBuffer),this._data=i}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}}class bP{constructor(e,t=1){this.textureBuffer=new vP(e,t),this._indexManager=new yP(65536)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}}class xP{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter((e=>0!==e.activeCount||(e.dispose(),!1)))}destroy(){this._buffers.forEach((e=>e.dispose())),this._buffers=[]}getBuffer(e){for(const t of this._buffers)if(t.availableCount>=e)return t;if(e>65536)return null;const t=new bP(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}}const TP=E.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class wP{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._objects=[new J,new J],this._renderSubmit=new VS(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=b("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new xP(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){no(0===this._objects[oS.Hidden].length&&0===this._objects[oS.Visible].length,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const t=new nS;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=Qd(e.obb),t.components=new class{constructor(e,t){this.offsets=t,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;const i=this.count;this.visibility=new aS(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let e=0;e<i;e++)this.materialDataIndices[e]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return M(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return M(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return M(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((M(this.cachedHighlightRanges)||M(this.cachedDefaultRanges))&&A(this.highlightCounts)){const{highlightRanges:e,defaultRanges:t}=function(e,t,i){const r=[],s=[];let a=i.length,n=i.length;return t.forEachComponent((t=>(e[t]>0?(a!==t-1&&(r.length&&r.push(i[a+1]-r[r.length-1]),r.push(i[t])),a=t):(n!==t-1&&(s.length&&s.push(i[n+1]-s[s.length-1]),s.push(i[t])),n=t),!0))),r.length&&r.push(i[a+1]-r[r.length-1]),s.length&&s.push(i[n+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}}(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new dS(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t}destroyObject(e){const t=e;this._objects[t.visible].removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const i=e;t!==i.visible&&(this._objects[i.visible].removeUnordered(i),this._objects[t].push(i),i.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll((e=>e.renderable.meta.cameraDepthSquared=Ne(t,e.obb.center)))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const i=e.renderable.material;t(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const i=e;i.components.visibility.reset(t),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,i=t.components.visibility.componentCount();return{visible:i,invisible:t.components.count-i}}setComponentData(e,t){const i=e,r=i.renderable.material,s=i.components,a=s.materialDataBuffer,n=s.materialDataIndices,o=new zS,l=a.textureBuffer,h=new Uint8Array(4),c=new Uint32Array(h.buffer);let d=0,u=0,p=0,m=s.verticalOffsets,_=1/0,g=-1/0,f=!1,y=!1,v=0;for(let e=0;e<s.count;e++){t(e,o),d+=+(o.externalColor[3]<1),u+=+(o.externalColorMixMode===Hd.Replace&&1===o.externalColor[3]),p+=+o.castShadows,Bd(o.externalColor,o.externalColorMixMode,h),h[2]=254&h[2]|+o.castShadows,l.setData(n[e],0,h[0],h[1],h[2],h[3]),f||(f=e>0&&v!==c[0]),v=c[0],y||(y=0!==o.elevationOffset),y&&M(m)&&(m=new Array(e).fill(0)),A(m)&&(m[e]=o.elevationOffset),_=Math.min(_,o.elevationOffset),g=Math.max(g,o.elevationOffset),BS(o.elevationOffset,h),l.setData(n[e],1,h[0],h[1],h[2],h[3]);const i=o.objectAndLayerIdColor;A(i)&&l.setData(n[e],2,i[0],i[1],i[2],i[3]),o.pickable!==hS(s.pickability,e)&&(s.pickability=lS(s.pickability,s.count,e,o.pickable))}s.verticalOffsets=y?m:null,i.offsetObb=y?Xd(i.obb,_,g,this._viewingMode,A(i.offsetObb)?i.offsetObb:Qd(i.obb)):null,f||y||this._hasObjectAndLayerId?(r.componentParameters=new fP,r.componentParameters.castShadows=SP(p,s.count),r.componentParameters.transparent=SP(d,s.count),r.componentParameters.opaqueOverride=SP(u,s.count),r.componentParameters.texture=l,l.updateTexture()):(r.componentParameters=new gP,r.componentParameters.castShadows=o.castShadows?mP.All:mP.None,r.componentParameters.externalColor=o.externalColor,r.componentParameters.externalColorMixMode=o.externalColorMixMode),this._notifyDirty()}getComponentAabb(e,t,i,r=!1){e.intersectionGeometry.getComponentAabb(t,i);const s=e,a=s.components.verticalOffsets;if(r||M(a))return i;const n=a[t];if(this._viewingMode===Ui.Local||0===n)return i[2]+=n,i[5]+=n,i;const o=k(hl(n));return o.localOrigin=s.transform.position,o.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,i){return e.intersectionGeometry.getComponentPositions(t,i)}intersect(e,t,i,r,s,a){const n=e;A(s)&&(s.localOrigin=n.transform.position);const o=Wa(PP,n.transform.rotationScale);Re(RP,t,n.transform.position),Re(OP,i,n.transform.position),Be(RP,RP,o),Be(OP,OP,o);const l=$a(PP,o);return n.intersectionGeometry.intersect(RP,OP,r,l,s,n.components.verticalOffsets,a)}addEdges(e,t,i,r){const s=e,{indices:a,positions:n}=s.intersectionGeometry,o=s.components.offsets;return t.addComponentObject(e,s.transform,{center:s.obb.center,radius:Yd(s.obb)},n,a,o,i,r)}async extractEdgeInformation(e,t,i){const r=e,s=r.components.visibility;if(s.allInvisible())return{buffer:yu.createBuffer(0),origin:[0,0,0]};const{indices:a,positions:n}=r.intersectionGeometry,o=r.components.offsets,l=vu.createBuffer(n.length/3);vc(l.position.typedBuffer,n,l.position.typedBufferStride,3),Gd(l.position,l.position,r.transform.rotationScale),this._setComponentIndices(l.componentIndex,a,o);const h=l.count,c=this._computeVisibilityIndices(a,s,o,h);return{origin:je(r.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:c,indicesLength:c.length,skipDeduplicate:!0,data:l,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,t,i){let r=0;for(let s=0;s<i.length-1;s++){const a=i[s],n=i[s+1];for(let i=a;i<n;i++){const s=t?t[i]:i;e.set(s,r)}r++}}_computeVisibilityIndices(e,t,i,r){if(e&&t.allVisible())return e;let s=0;t.forEachComponentRange(((e,t)=>(s+=i[t]-i[e],!0)));const a=C(e)?new Array(s):2===e?.BYTES_PER_ELEMENT||r<=65536?new Uint16Array(s):new Uint32Array(s);let n=0;return t.forEachComponentRange(((t,r)=>{const s=i[t],o=i[r];for(let t=s;t<o;t++)a[n++]=e?e[t]:t;return!0})),a}addComponentHighlight(e,t){const i=e.components;M(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1)),0==i.highlightCounts[t]++&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,t){const i=e.components;if(M(i.highlightCounts))return void TP.warn("Removing non-existing highlight.");const r=i.highlightCounts[t],s=i.highlightCounts[i.count];if(0!==r){if(r>1)return i.highlightCounts[t]=r-1,void(i.highlightCounts[i.count]=s-1);i.highlightCounts[t]=0,i.highlightsDirty(),this._notifyDirty(),1===s?i.highlightCounts=null:i.highlightCounts[i.count]=s-1}else TP.warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;A(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[oS.Visible]}_createRenderable(e,t){const i=this._renderManager.rctx,r=e.geometry,s=r.vertices.layoutParameters,a=dn.createVertex(i,ga.STATIC_DRAW,r.vertices.data),n=V(r.indices,(e=>dn.createIndex(i,ga.STATIC_DRAW,e))),o=Qn(kS(s)),l=new Uint16Array(r.vertices.count);for(let e=0;e<t.count;e++){const i=t.offsets[e],s=t.offsets[e+1],a=t.materialDataIndices[e];if(A(r.indices))for(let e=i;e<s;e++)l[r.indices[e]]=a;else for(let e=i;e<s;e++)l[e]=a}const h=dn.createVertex(i,ga.STATIC_DRAW,l.buffer),c=new uP(e.transform,e.toMapSpace),d=new _n(i,aP,{data:o,componentIndices:CP},{data:a,componentIndices:h},k(n)),u=new mS(d,la.TRIANGLES,s,A(n)),p={cameraDepthSquared:.5,gpuMemoryEstimate:a.byteSize+h.byteSize+(A(n)?n.byteSize:0)};return new class{constructor(e,t,i){this.material=e,this.geometry=t,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}}(c,u,p)}_notifyDirty(){this._renderManager.notifyDirty()}}const CP=Qn(Xn().u16(Gs.COMPONENTINDEX));function SP(e,t){return e===t?mP.All:0===e?mP.None:mP.Some}const PP=qd(),RP=ve(),OP=ve();class EP extends Us{constructor(){super(...arguments),this.opacity=1}}const AP=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:EP,build:function(e){const t=new Vs;return t.include(Ka),t.fragment.uniforms.add(new qs("tex",(e=>e.texture))),e.hasOpacityFactor&&t.fragment.uniforms.add(new Ns("opacity",(e=>e.opacity))),t.fragment.code.add(Fs`
    void main() {
      fragColor = texture(tex, uv) ${e.hasOpacityFactor?"* opacity":""};
    }`),t}},Symbol.toStringTag,{value:"Module"}));var MP;!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(MP||(MP={}));class DP extends Aa{constructor(){super(...arguments),this.alphaMode=MP.None,this.hasOpacityFactor=!1}}e([Ea({count:MP.COUNT})],DP.prototype,"alphaMode",void 0),e([Ea()],DP.prototype,"hasOpacityFactor",void 0);class IP extends Hs{initializeProgram(e){return new Bs(e.rctx,IP.shader.get().build(this.configuration),$s)}initializePipeline(){switch(this.configuration.alphaMode){case MP.None:return Ta({colorWrite:Ca});case MP.Alpha:return Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca});case MP.PremultipliedAlpha:case MP.COUNT:return Ta({blending:Sa(na.ONE,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca})}}}IP.shader=new Ws(AP,(()=>Promise.resolve().then((()=>AP))));class LP extends Us{}const NP=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:LP,build:function(){const e=new Vs;return e.include(Ka),e.fragment.uniforms.add(new qs("tex",(e=>e.texture))),e.fragment.code.add(Fs`void main() {
fragColor = vec4(1.0 - texture(tex, uv).a);
}`),e}},Symbol.toStringTag,{value:"Module"}));class FP extends Hs{initializeProgram(e){return new Bs(e.rctx,FP.shader.get().build(),$s)}initializePipeline(){return Ta({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}}FP.shader=new Ws(NP,(()=>Promise.resolve().then((()=>NP))));class UP extends Us{}const jP=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:UP,build:function(){const e=new Vs;return e.include(Ka),e.fragment.uniforms.add([new qs("colorTexture",(e=>e.colorTexture)),new qs("alphaTexture",(e=>e.alphaTexture)),new qs("frontFaceTexture",(e=>e.frontFaceTexture))]),e.fragment.code.add(Fs`void main() {
vec4 srcColor = texture(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture(alphaTexture, uv).r;
vec4 frontFace = texture(frontFaceTexture, uv);
fragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`),e}},Symbol.toStringTag,{value:"Module"}));class VP extends Hs{initializeProgram(e){return new Bs(e.rctx,VP.shader.get().build(),$s)}initializePipeline(){return Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca})}}VP.shader=new Ws(jP,(()=>Promise.resolve().then((()=>jP))));class kP extends Us{constructor(){super(...arguments),this.overlayIndex=Jc.INNER,this.opacity=1}}const zP=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:kP,build:function(){const e=new Vs;return e.include(Ka),e.fragment.uniforms.add(new qs("tex",(e=>e.texture))),e.fragment.uniforms.add(new us("overlayIdx",(e=>e.overlayIndex))),e.fragment.uniforms.add(new Ns("opacity",(e=>e.opacity))),e.fragment.code.add(Fs`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),e}},Symbol.toStringTag,{value:"Module"}));class qP extends Hs{initializeProgram(e){return new Bs(e.rctx,qP.shader.get().build(),$s)}initializePipeline(){return Ta({blending:Sa(na.ONE,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca})}}qP.shader=new Ws(zP,(()=>Promise.resolve().then((()=>zP))));class GP{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._configuration=new DP,this._passParameters=new EP,this._oitParameters=new UP,this._hudParameters=new LP,this._overlayParameters=new kP}destroy(){this._vao=F(this._vao)}compositeOIT(e,t,i,r){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=i,this._oitParameters.frontFaceTexture=r;const s=this._rctx,a=this._techniqueRepository.acquire(VP);s.bindTechnique(a,this._oitParameters,e);const n=this._ensureVAO();s.bindVAO(n),s.drawArrays(la.TRIANGLE_STRIP,0,cn(n,"geometry")),a.release()}compositeHUD(e,t){this._hudParameters.texture=t;const i=this._rctx,r=this._techniqueRepository.acquire(FP);i.bindTechnique(r,this._hudParameters,e);const s=this._ensureVAO();i.bindVAO(s),i.drawArrays(la.TRIANGLE_STRIP,0,cn(s,"geometry")),r.release()}compositeOverlay(e,t,i,r){this._overlayParameters.texture=t,this._overlayParameters.opacity=i,this._overlayParameters.overlayIndex=r;const s=this._rctx,a=this._techniqueRepository.acquire(qP);s.bindTechnique(a,this._overlayParameters,e);const n=this._ensureVAO();s.bindVAO(n),s.drawArrays(la.TRIANGLE_STRIP,0,cn(n,"geometry")),a.release()}composite(e,t,i=MP.None,r=1){const s=this._rctx;this._configuration.alphaMode=i,this._configuration.hasOpacityFactor=1!==r,this._passParameters.texture=t,this._passParameters.opacity=r;const a=this._techniqueRepository.acquire(IP,this._configuration);s.bindTechnique(a,this._passParameters,e);const n=this._ensureVAO();s.bindVAO(n),s.drawArrays(la.TRIANGLE_STRIP,0,cn(n,"geometry")),a.release()}_ensureVAO(){return M(this._vao)&&(this._vao=Ma(this._rctx)),this._vao}}const HP=100;function BP(e,t,i){return tu(t,e)*(i[1]-i[0])+i[0]}function WP(e,t,i){if(!i.visible)return;if(!mh(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=ZP;i.geometries.forEach((i=>{$r(s,r,i.shaderTransformation);const a=ar(s);$P(e,t,i.boundingInfo,s,a)}))}function $P(e,t,i,r,s){if(M(i))return;Le(YP,i.center,r);const{eye:a,viewForward:n}=t,o=n[0]*(YP[0]-a[0])+n[1]*(YP[1]-a[1])+n[2]*(YP[2]-a[2]);if(YP[3]=i.radius*s,!(o-YP[3]>e.near&&o+YP[3]<e.far)&&mh(t.frustum,YP))if(i.radius>HP&&i.getChildren())for(const a of i.getChildren())$P(e,t,a,r,s);else tR.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function QP(e,t,i){const r=t.eye,s=t.viewForward,a=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,a-i[3]),e.far=Math.max(e.far,a+i[3])}const XP=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],YP=Mo(),ZP=is(),KP=gS(),JP=new class{constructor(){this._items=new J({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,i=e.viewForward;this._items.forAll((e=>{const r=e.obj.boundingVolumeWorldSpace.bounds,s=(r[0]-t[0])*i[0]+(r[1]-t[1])*i[1]+(r[2]-t[2])*i[2];e.distance=s,e.near=s-r[3],e.far=s+r[3]})),this._items.sort(((e,t)=>e.distance-t.distance))}forEachInDepthRange(e,t,i){if(t===Pu.DepthOrder.FRONT_TO_BACK)for(let t=0;t<this._items.length;++t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}else for(let t=this._items.length-1;t>=0;--t){const r=this._items.data[t];r.far<e.near||r.near>e.far||i(r.obj,r.near,r.far)}}},eR=new class{constructor(){this._view=is(),this._viewProj=is(),this._frustum=gh(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),Br(this._view,e.viewMatrix),$r(this._viewProj,e.projectionMatrix,this._view),fh(this._frustum,e.frustum);const i=this._view,r=i[2],s=i[6],a=i[10],n=i[14];t.forAll((e=>e.forEachGeometry((e=>{if(!e.visible||!e.castShadow)return;const t=e.boundingSphere,i=r*t[0]+s*t[1]+a*t[2]+n,o=i-t[3],l=i+t[3];this._geometries.push(e),this._near.push(-l),this._far.push(-o)}))));const o=new _S;if(0===this._geometries.length)return o;for(let e=0;e<this._geometries.length;++e)this._near[e]>o.far&&(o.far=this._near[e]),this._near[e]>2&&this._far[e]<o.near&&(o.near=this._far[e]);const l=this._looseRange;l.near=Math.max(.5*o.near,2),l.far=2*o.far;let h=0,c=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<o.near&&(this._near[e]>=l.near?o.near=this._near[e]:this._nearCandidates[h++]=e),this._far[e]>o.far&&(this._far[e]<=l.far?o.far=this._far[e]:this._farCandidates[c++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return o;this._nearCandidates.sort(((e,t)=>this._near[e]<this._near[t]?-1:this._near[e]>this._near[t]?1:0)),this._farCandidates.sort(((e,t)=>this._far[e]<this._far[t]?1:this._far[e]>this._far[t]?-1:0));for(let e=0;e<this._nearCandidates.length;++e){const t=this._nearCandidates[e];if(this._near[t]<o.near){const e=this._geometries[t],i=e.boundingInfo;this._includeNearBoundingInfoRec(i,e.shaderTransformation,o)}}for(let e=0;e<this._farCandidates.length;++e){const t=this._farCandidates[e];if(this._far[t]>o.far){const e=this._geometries[t],i=e.boundingInfo;this._includeFarBoundingInfoRec(i,e.shaderTransformation,o)}}return this._reset(),o}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,i){if(M(e))return;const r=e.center;Le(YP,r,t);const s=ar(t),a=YP[0],n=YP[1],o=YP[2],l=e.radius*s,h=this._frustum;if(h[0][0]*a+h[0][1]*n+h[0][2]*o+h[0][3]>l||h[1][0]*a+h[1][1]*n+h[1][2]*o+h[1][3]>l||h[2][0]*a+h[2][1]*n+h[2][2]*o+h[2][3]>l||h[3][0]*a+h[3][1]*n+h[3][2]*o+h[3][3]>l)return;const c=this._view[2]*a+this._view[6]*n+this._view[10]*o+this._view[14],d=c+l;if(!(-(c-l)<2||-d>=i.near))if(-d>this._looseRange.near)i.near=-d;else{if(l>HP){const r=e.getChildren();if(void 0!==r){for(const e of r)this._includeNearBoundingInfoRec(e,t,i);return}}tR.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,i){if(M(e))return;let r=e.radius;const s=e.center;Le(YP,s,t);const a=ar(t),n=YP[0],o=YP[1],l=YP[2];r*=a;const h=this._frustum;if(h[0][0]*n+h[0][1]*o+h[0][2]*l+h[0][3]>r||h[1][0]*n+h[1][1]*o+h[1][2]*l+h[1][3]>r||h[2][0]*n+h[2][1]*o+h[2][2]*l+h[2][3]>r||h[3][0]*n+h[3][1]*o+h[3][2]*l+h[3][3]>r)return;const c=this._view[2]*n+this._view[6]*o+this._view[10]*l+this._view[14]-r;if(!(-c<=i.far))if(-c<this._looseRange.far)i.far=-c;else{if(r>HP){const r=e.getChildren();if(void 0!==r){for(const e of r)this._includeFarBoundingInfoRec(e,t,i);return}}tR.unionDepthRangeWithAABB(i,this._viewProj,t,e.bbMin,e.bbMax)}}},tR=new class{constructor(){this._modelViewProj=is(),this._clipPosition=[_r(),_r(),_r(),_r(),_r(),_r(),_r(),_r()]}unionDepthRangeWithAABB(e,t,i,r,s){const a=this._modelViewProj;$r(a,t,i);let n=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],i=0===e||3===e||4===e||7===e?r[0]:s[0],n=0===e||1===e||4===e||5===e?r[1]:s[1],o=e<4?r[2]:s[2];t[0]=a[0]*i+a[4]*n+a[8]*o+a[12],t[1]=a[1]*i+a[5]*n+a[9]*o+a[13],t[2]=a[2]*i+a[6]*n+a[10]*o+a[14],t[3]=a[3]*i+a[7]*n+a[11]*o+a[15]}for(let t=0;t<12;++t){const i=this._clipPosition[XP[t][0]],r=this._clipPosition[XP[t][1]],s=this._clipPosition[XP[t][2]],a=this._clipTriangle(i,r,s);let o=!0;for(let e=0;e<a.length;++e)if(a[e][3]>=2){o=!1;break}if(!o){n=!0;for(let t=0;t<a.length;++t){const i=a[t][3];Number.isFinite(i)&&(e.near=Math.min(i,e.near),e.far=Math.max(i,e.far))}}}return n}_inside(e,t){return 0===t?e[0]>=-e[3]:1===t?e[1]>=-e[3]:2===t?e[0]<=e[3]:3===t?e[1]<=e[3]:void no(!1)}_intersect(e,t,i){let r=0;return 0===i?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):1===i?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):2===i?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):3===i&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),jr(_r(),e,t,r)}_clipTriangle(e,t,i){let r=[e,t,i];for(let e=0;e<4;++e){const t=r;r=[];for(let i=0;i<t.length;++i){const s=t[i],a=t[(i+1)%t.length];this._inside(a,e)?(this._inside(s,e)||r.push(this._intersect(s,a,e)),r.push(a)):this._inside(s,e)&&r.push(this._intersect(s,a,e))}}return r}};class iR{}class rR extends Us{constructor(){super(...arguments),this.textures=new iR}}const sR=re(),aR=oe(),nR=_r();let oR=class extends Hi{constructor(){super(...arguments),this._handles=new R,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new rR,this.events=new mr,this.attributeLocations=new Map([[Gs.POSITION,0]]),this._tmpScreenPoint=re(),this._tmpRenderPoint=oe()}get updating(){return M(this._imageSources)&&A(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};A(this._magnifier)&&this._handles.add(G((()=>V(this._magnifier,(e=>e.version))),t)),t()}get enabled(){return A(this._validMagnifier)}get _validMagnifier(){return A(this._magnifier)&&this._magnifier.visible&&A(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get _factor(){return A(this._magnifier)&&this._magnifier.factor||1}destroy(){this._magnifier=null,this._handles.destroy(),A(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const i=this._validMagnifier;if(M(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this._updateResources(e,s),M(this._resources))return;const a=this._passParameters.textures,n=Math.ceil(1/this._factor*s);a.input.resize(n,n),se(i.position,this._tmpScreenPoint);const o=t.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),l=t.camera.fullWidth,h=t.camera.fullHeight,c=.5*n,d=.5*n;o[0]=Bi(o[0],c,l-c-1),o[1]=Bi(o[1],d,h-d-1);const u=Math.floor(o[0]-c),p=Math.floor(o[1]-d),m=this._resources.program;m.bindTexture("textureInput",a.input),e.gl.copyTexImage2D(a.input.descriptor.target,0,a.input.descriptor.pixelFormat,u,p,n,n,0),this._passParameters.magnifier=i,e.useProgram(m),m.bindPass(this._passParameters,t),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(la.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(M(e))return;const t=e.maskUrl,i=e.overlayUrl;!A(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),A(this._imageSources)||A(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:ki((async e=>{const r=M(t)||M(i)?Ou(e):null,s=A(t)?Ru(t,{signal:e}):r.then((e=>e.mask)),a=A(i)?Ru(i,{signal:e}):r.then((e=>e.overlay));this._imageSources={mask:await s,overlay:await a},this._disposeResources(),this.events.emit("request-render")}))},this._imageLoadTask.task.promise.then((()=>this.notifyChange("updating")),(()=>this.notifyChange("updating"))))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(A(this._resources)){if(this._passParameters.textures.size!==t){const i=this._createTextureResources(e,t);if(M(i))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=i}return}const i=this._createTextureResources(e,t);M(i)||(this._resources={program:this._createProgram(e),vao:Ma(e,ja,this.attributeLocations,0,1),pipelineState:Ta({blending:Sa(na.ONE,na.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Ca})},this._passParameters.textures=i)}_disposeResources(){M(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(M(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new Zn(e,{target:da.TEXTURE_2D,pixelFormat:ua.RGBA,internalFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:_a.LINEAR,flipped:!0,preMultiplyAlpha:!xc(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result},this._imageSources.overlay),r=new Zn(e,{target:da.TEXTURE_2D,pixelFormat:ua.ALPHA,internalFormat:ua.ALPHA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:_a.LINEAR,flipped:!0},this._imageSources.mask);return{input:new Zn(e,{target:da.TEXTURE_2D,pixelFormat:ua.RGBA,internalFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,samplingMode:_a.LINEAR,flipped:!1}),mask:r,overlay:i,size:t}}_createProgram(e){return new Bs(e,function(){const e=new Vs;return e.attributes.add(Gs.POSITION,"vec2"),e.vertex.uniforms.add(new Ls("drawPosition",((e,t)=>function(e,t){const i=t.camera.pixelRatio,r=e.magnifier.offset.x*i,s=e.magnifier.offset.y*i;se(e.magnifier.position,sR);const a=t.camera.screenToRender(sR,aR),n=Math.ceil(i*e.magnifier.size),o=t.camera.fullWidth,l=t.camera.fullHeight;return Dr(nR,(a[0]+r)/o*2-1,(a[1]-s)/l*2-1,n/o*2,n/l*2)}(e,t)))),e.varyings.add("vUV","vec2"),e.vertex.code.add(Fs`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add(new qs("textureInput",(e=>e.textures.input))),e.fragment.uniforms.add(new qs("textureMask",(e=>e.textures.mask))),e.fragment.uniforms.add(new qs("textureOverlay",(e=>e.textures.overlay))),e.fragment.uniforms.add(new ds("maskEnabled",(e=>e.magnifier.maskEnabled))),e.fragment.uniforms.add(new ds("overlayEnabled",(e=>e.magnifier.overlayEnabled))),e.fragment.code.add(Fs`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}(),this.attributeLocations)}};e([ce()],oR.prototype,"_imageSources",void 0),e([ce()],oR.prototype,"_imageLoadTask",void 0),e([ce({readOnly:!0})],oR.prototype,"updating",null),oR=e([ue("esri/views/3d/webgl-engine/lib/MagnifierHelper")],oR);class lR{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Fd(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,i,r,s,a=null,n=null,o=null){if(!(e&&t&&i&&r))return;if(this._layerUidToId.set(r,i),this._layerUidToPopupEnabled.set(r,s),!s)return;let l=this._layerUidToGraphicsUidToObjectId.get(r);l||(l=new Map,this._layerUidToGraphicsUidToObjectId.set(r,l)),l.set(t,{objectId:e,attributeNodeId:a,attributeIndex:n,subLayerId:o})}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return fr(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(void 0===t)return E.getLogger(this.declaredClass).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(!1===t)return this.colorZero;let i=this._uidToRenderColor.get(e.layerUid);i||(i=new Map,this._uidToRenderColor.set(e.layerUid,i));let r=i.get(e.graphicUid);if(!r){for(;!r;){const e=Math.floor(16777214*Math.random())+1;this._colorToUID.has(e)||(r=e)}if(r>16777215)throw new Error("Object ID Overflow");i.set(e.graphicUid,r),this._colorToUID.set(r,e)}const s=new ArrayBuffer(4);return new DataView(s).setUint32(0,r,!1),new Fd(s)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,i]of this._colorToUID.entries()){const r=this._layerUidToGraphicsUidToObjectId.get(i.layerUid);let s=null;r?(s=r.get(i.graphicUid),s||E.getLogger(this.declaredClass).warn("getColorMapping: no entry found for graphicsId "+i.graphicUid)):E.getLogger(this.declaredClass).warn("getColorMapping: no entry found for layerUid "+i.layerUid);const a=this._layerUidToId.get(i.layerUid);a||E.getLogger(this.declaredClass).warn("no layerId found for uid "+i.layerUid),s&&a&&e.set(t,s.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:s.objectId,lid:a,attrId:s.attributeNodeId,attrIdx:s.attributeIndex,subLayerId:s.subLayerId}:{type:"object-and-layer-id",oid:s.objectId,lid:a})}return e}}var hR;!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(hR||(hR={}));class cR{constructor(e,t,i=hR.FrontToBack){this._rctx=e,this._techniqueRepository=t,this._sorting=i,this._draws=new J({initialSize:32,allocator:e=>e||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,i,r){const s=this._draws.pushNew();s.geometry=t,s.geometryRanges=i,s.material=e,s.depthSquaredHint=r,s.indexType=(t.indexed?k(t.vao.indexBuffer).indexType:null)??0}prepare(e,t){return this._draws.map((i=>i.material.prepareTechnique(this._techniqueRepository,e,t,i.geometry.parameters)))}dispatch(e,t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let s=null;const a=this._draws.length;for(let n=0;n<a;n++){const a=i[n];a===s&&a.configuration.transparencyPassType===lu.NONE||(r.bindTechnique(a,e,t),s=a);const o=this._draws.data[n],l=o.geometry;r.bindVAO(l.vao),this._previouslyBoundDraw.get(a)!==o.material&&(a.program.bindDraw(o.material,t,e),this._previouslyBoundDraw.set(a,o.material));const h=o.geometryRanges,c=h.length;if(0!==o.indexType){const e=dR.get(o.indexType);for(let t=0;t<c;t+=2){const i=h[t],s=h[t+1];r.drawElements(l.primitiveType,s,o.indexType,i*e)}}else for(let e=0;e<c;e+=2){const t=h[e],i=h[e+1];r.drawArrays(l.primitiveType,t,i)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===hR.FrontToBack?1:-1;this._draws.sort(((t,i)=>{const r=e*(t.depthSquaredHint-i.depthSquaredHint);return 0!==r?r:t.geometry.vao.size-i.geometry.vao.size}))}get count(){return this._draws.length}}const dR=new Map;dR.set(va.UNSIGNED_BYTE,1),dR.set(va.UNSIGNED_SHORT,2),dR.set(va.UNSIGNED_INT,4);class uR{constructor(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParameters=new zT,this._shadowPassParameters=new qT,this._highlightPassParameters=new GT,this._systems=new Set,this._passes={materialOpaque:new cR(e,t),materialTransparent:new cR(e,t,hR.BackToFront),materialIntegratedMesh:new cR(e,t),shadowMap:new cR(e,t),highlight:new cR(e,t),highlightIntegratedMesh:new cR(e,t),highlightShadowMap:new cR(e,t),defaultShadowMap:new cR(e,t)}}register(e){this._systems.add(e)}prepareRender(e){if(0!==this._systems.size){for(const e of Object.values(this._passes))e.prepareSubmit();this._systems.forEach((t=>t.submit(this._passes,e.bindParameters)));for(const e of Object.values(this._passes))e.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}prepareTechniques(e){return 0===this._systems.size?null:(this._configure(e),this._materialPassParameters.output=e.output,this._invoke(e,((t,i)=>t.prepare(i,e.bindParameters))))}render(e,t){this._invoke(e,((i,r)=>i.dispatch(r,e.bindParameters,t)))}_invoke(e,t){switch(e.bindParameters.slot){case go.OPAQUE_MATERIAL:switch(e.output){case _o.Color:case _o.Depth:case _o.Normal:case _o.ObjectAndLayerIdColor:return t(this._passes.materialOpaque,this._materialPassParameters);case _o.Highlight:return t(this._passes.highlight,this._highlightPassParameters);case _o.Shadow:return t(this._passes.shadowMap,this._shadowPassParameters);case _o.ShadowHighlight:return t(this._passes.highlightShadowMap,this._shadowPassParameters);case _o.ShadowExcludeHighlight:return t(this._passes.defaultShadowMap,this._shadowPassParameters)}break;case go.TRANSPARENT_MATERIAL:switch(e.output){case _o.Color:case _o.Alpha:case _o.Depth:case _o.Normal:case _o.ObjectAndLayerIdColor:return t(this._passes.materialTransparent,this._materialPassParameters)}break;case go.INTEGRATED_MESH:switch(e.output){case _o.Color:case _o.Depth:case _o.Normal:case _o.ObjectAndLayerIdColor:return t(this._passes.materialIntegratedMesh,this._materialPassParameters);case _o.Highlight:return t(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}slots(){return[go.OPAQUE_MATERIAL,go.TRANSPARENT_MATERIAL,go.INTEGRATED_MESH]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const t={near:1/0,far:-1/0};return this._systems.forEach((i=>{const r=i.queryShadowCasterDepthRange(e);A(r)&&yS(t,r,t)})),t}_configure(e){const t=e.output===_o.Shadow||e.output===_o.ShadowHighlight||e.output===_o.ShadowExcludeHighlight?this._shadowPassParameters:e.output===_o.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,t)}_updateParameters(e,t){const i=e.bindParameters.camera,r=i.viewInverseTransposeMatrix;Pe(pR,r[3],r[7],r[11]),_R.set(pR),De(t.transformWorldFromViewTH,_R.high),De(t.transformWorldFromViewTL,_R.low),De(t.slicePlaneLocalOrigin,pR),Ga(t.transformViewFromCameraRelativeRS,i.viewMatrix),Br(t.transformProjFromView,i.projectionMatrix),t.identifier===kT.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===go.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===go.INTEGRATED_MESH,$a(mR,t.transformViewFromCameraRelativeRS),Wa(t.transformNormalViewFromGlobal,mR))}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}}const pR=ve(),mR=Za(),_R=new cP;class gR{constructor(){this._step=TR,this._dilation=1,this._firstIdleTime=K(0)}frame(e,t){if(t?0===this._firstIdleTime&&(this._firstIdleTime=K(performance.now())):this._firstIdleTime=K(0),b("enable-feature:high-quality-idle")){const e=t?performance.now()-this._firstIdleTime:0;if(e>=yR+vR)return this._step=K(1/0),void(this._dilation=1);this._dilation=e>=yR?bR:1}else this._dilation=1;const i=Bi(e/fR,TR,wR);this._step===1/0?this._step=K(i):this._step=K(this._step*xR+i*(1-xR))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=K(0)}}const fR=.5,yR=K(6e4),vR=K(5e3),bR=10,xR=.9,TR=K(1e3),wR=K(1e3/30),CR=_r(),SR=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new Vs,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(Gs.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(Gs.UV0,"vec2"),t.uniforms.add(new qs("coverageTex",(e=>e.coverageTexture))),r.add(Fs`void main() {
vec4 cov = texture(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),i.uniforms.add(new qs("tex",(e=>e.blurColorTexture))),i.uniforms.add(new qs("origin",(e=>e.highlightColorTexture))),i.uniforms.add(new Ls("uColor",(e=>e.color))),i.uniforms.add(new Ls("haloColor",(e=>e.haloColor))),i.uniforms.add(new Ls("opacities",(e=>Dr(CR,e.haloOpacity,e.haloOpacityOccluded,e.fillOpacity,e.fillOpacityOccluded)))),i.constants.add("outlineSize","float",8.6),i.constants.add("blurSize","float",.4),s.add(Fs`void main() {
vec4 blurredHighlightValue = texture(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
fragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),e}},Symbol.toStringTag,{value:"Module"}));class PR extends Hs{initializeProgram(e){return new Bs(e.rctx,PR.shader.get().build(),$s)}initializePipeline(){return Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca})}}PR.shader=new Ws(SR,(()=>Promise.resolve().then((()=>SR))));class RR extends Us{constructor(){super(...arguments),this.blurSize=kr()}}const OR=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:RR,build:function(){const e=new Vs,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(Gs.POSITION,"vec2"),e.attributes.add(Gs.UV0,"vec2"),e.varyings.add("blurCoordinate","vec3"),t.uniforms.add(new qs("coverageTex",(e=>e.coverageTexture))),i.uniforms.add(new Eu("blurSize",(e=>e.blurSize))),r.add(Fs`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
}`),i.uniforms.add(new nu("tex",(e=>e.blurInputTexture))),s.add(Fs`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture(tex, uv);
if (blurCoordinate.z == 1.0) {
fragColor = center;
} else {
vec4 sum = vec4(0.0);
sum += center * 0.204164;
sum += texture(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture(tex, uv - blurSize * 3.294215) * 0.093913;
fragColor = sum;
}
}`),e}},Symbol.toStringTag,{value:"Module"}));class ER extends Hs{initializeProgram(e){return new Bs(e.rctx,ER.shader.get().build(),$s)}initializePipeline(){return Ta({colorWrite:Ca})}}ER.shader=new Ws(OR,(()=>Promise.resolve().then((()=>OR))));class AR extends Us{constructor(){super(...arguments),this.invFramebufferDim=kr()}}const MR=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:AR,build:function(){const e=new Vs,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(Gs.POSITION,"vec2"),r.add(Fs`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),i.uniforms.add(new nu("tex",(e=>e.inputTexture))),i.uniforms.add(new Eu("invFramebufferDim",(e=>e.invFramebufferDim))),s.add(Fs`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture(tex, coord);
float mx = floor(max(value.g, value.b));
fragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`),e}},Symbol.toStringTag,{value:"Module"}));class DR extends Hs{initializeProgram(e){return new Bs(e.rctx,DR.shader.get().build(),$s)}initializePipeline(){return Ta({colorWrite:Ca})}}DR.shader=new Ws(MR,(()=>Promise.resolve().then((()=>MR))));class IR extends Us{constructor(){super(...arguments),this.color=Th(1,0,1,1),this.haloColor=Th(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.shadowColor=fr(1,0,1,1),this.shadowOpacity=.15,this.occludedShadowOpacity=.075}}class LR{constructor(e,t){this._techniqueRep=e,this._rctx=t,this._viewportToRestore=_r(),this._passParameters=new IR,this._downsampleDrawParameters=new AR,this._blurDrawParameters=new RR,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this._quadVAO)return;this._quadVAO=Ma(this._rctx);const e={colorTarget:ca.TEXTURE,depthStencilTarget:fa.NONE,width:0,height:0},t={target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,samplingMode:_a.LINEAR,wrapMode:ma.CLAMP_TO_EDGE,width:0,height:0};this._blur0Fbo=new hn(this._rctx,e,t),this._blur1Fbo=new hn(this._rctx,e,t),this._blurTechnique=this._techniqueRep.acquire(ER),this._downsampleTechnique=this._techniqueRep.acquire(DR),this._applyTechnique=this._techniqueRep.acquire(PR)}dispose(){if(this._blurTechnique=N(this._blurTechnique),this._downsampleTechnique=N(this._downsampleTechnique),this._applyTechnique=N(this._applyTechnique),this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this._quadVAO&&(this._quadVAO.dispose(!0),this._quadVAO=null),this._blur0Fbo=F(this._blur0Fbo),this._blur1Fbo=F(this._blur1Fbo)}setDefaultOptions(e){this._passParameters={...new IR,...e}}render(e,t,i){this._passParameters.highlightColorTexture=t.colorTexture,this._assertResources();const r=e.camera;Fr(this._viewportToRestore,r.fullViewport);const s=r.fullWidth,a=r.fullHeight,n=r.pixelRatio,o=Math.ceil(s/n),l=Math.ceil(a/n);this._blur0Fbo.resize(o,l),this._blur1Fbo.resize(o,l);const h=this._rctx;h.bindVAO(this._quadVAO);let c=null;this._gridUpdateResources(t,32),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,c=this._grid.vao;const d=h.bindTechnique(this._blurTechnique,this._passParameters,e);h.bindVAO(c),h.bindFramebuffer(this._blur0Fbo),h.setViewport(0,0,o,l),h.setClearColor(0,0,0,0),h.clear(ya.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=t.colorTexture,Rr(this._blurDrawParameters.blurSize,1/o,0),d.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,cn(c,"geometry")),h.bindFramebuffer(this._blur1Fbo),h.clear(ya.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this._blur0Fbo.colorTexture,Rr(this._blurDrawParameters.blurSize,0,1/l),d.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,cn(c,"geometry")),h.bindFramebuffer(i),h.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]),this._passParameters.blurColorTexture=this._blur1Fbo.colorTexture,h.bindTechnique(this._applyTechnique,this._passParameters,e),h.drawArrays(this._applyTechnique.primitiveType,0,cn(c,"geometry")),h.bindVAO(null)}_gridUpdateResources(e,t){const i=this._rctx,r=this._grid;let s=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],s=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(s=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,s=!0),s){for(let e=1;e<r.coverageMipmap.length;e++)r.coverageMipmap[e].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(let e=0;e<r.mipmapLevels;e++){const t=r.coverageMipmap[e],s={target:da.TEXTURE_2D,pixelFormat:ua.RGB,dataType:pa.UNSIGNED_SHORT_5_6_5,samplingMode:_a.LINEAR,wrapMode:ma.CLAMP_TO_EDGE,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)},a={colorTarget:ca.TEXTURE,depthStencilTarget:fa.NONE,width:Math.ceil(t.width/2),height:Math.ceil(t.height/2)};r.coverageMipmap[e+1]=new hn(i,a,s)}}const a=Math.ceil(e.height/r.cellPixelSize),n=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==a||r.horizontalCellCount!==n){r.verticalCellCount=a,r.horizontalCellCount=n;const e=a+1,t=n+1,s=1/a,o=1/n,l=6,h=4,c=new Float32Array(l*h*e*t);let d=0;for(let i=0;i<e;i++)for(let e=0;e<t;e++)c[d]=(e-.5)*o*2-1,c[d+1]=(i-.5)*s*2-1,c[d+2]=e*o,c[d+3]=i*s,c[d+4]=(e+.5)*o*2-1,c[d+5]=(i-.5)*s*2-1,c[d+6]=e*o,c[d+7]=i*s,c[d+8]=(e-.5)*o*2-1,c[d+9]=(i+.5)*s*2-1,c[d+10]=e*o,c[d+11]=i*s,c[d+12]=(e-.5)*o*2-1,c[d+13]=(i+.5)*s*2-1,c[d+14]=e*o,c[d+15]=i*s,c[d+16]=(e+.5)*o*2-1,c[d+17]=(i-.5)*s*2-1,c[d+18]=e*o,c[d+19]=i*s,c[d+20]=(e+.5)*o*2-1,c[d+21]=(i+.5)*s*2-1,c[d+22]=e*o,c[d+23]=i*s,d+=l*h;r.vao&&r.vao.dispose(!0),r.vao=new Ia(i,$s,{geometry:Da},{geometry:dn.createVertex(i,ga.STATIC_DRAW,c)})}}_gridComputeMipmap(e){const t=this._rctx,i=this._grid,r=t.bindTechnique(this._downsampleTechnique,this._passParameters,e);t.bindVAO(this._quadVAO);for(let s=0;s<i.mipmapLevels;s++){t.bindFramebuffer(i.coverageMipmap[s+1]);const a=i.coverageMipmap[s+1].width,n=i.coverageMipmap[s+1].height;this._downsampleDrawParameters.inputTexture=i.coverageMipmap[s].colorTexture,Rr(this._downsampleDrawParameters.invFramebufferDim,1/a,1/n),r.bindDraw(this._downsampleDrawParameters,e,this._passParameters),t.setViewport(0,0,a,n),t.drawArrays(la.TRIANGLE_STRIP,0,cn(this._quadVAO,"geometry"))}}get gpuMemoryUsage(){let e=(A(this._blur0Fbo)?this._blur0Fbo.gpuMemoryUsage:0)+(A(this._blur1Fbo)?this._blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const t of this._grid.coverageMipmap)e+=t.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this._blur0Fbo,this._blur1Fbo]}}}const NR={dataType:pa.UNSIGNED_BYTE,internalFormat:ua.RGBA},FR={};class UR{constructor(e){this._rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._disposeWithFramebuffers(this._depthTextures,t),this._disposeWithFramebuffers(this._depthBuffers,t),this._disposeWithFramebuffers(this._colorTextures,t))}_disposeWithFramebuffers(e,t){const i=e.get(t);i&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==i&&e.depthStencilAttachment!==i||(e.detachAll(),e.dispose(),this._framebuffers.delete(t))})),i.dispose(),e.delete(t))}getDepthTexture(e,t){if(!this.depthTextureSupported)return null;let i=this._depthTextures.get(e.id);return!i||i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=q()),i||(i=new Zn(this._rctx,{target:da.TEXTURE_2D,pixelFormat:ua.DEPTH_STENCIL,dataType:pa.UNSIGNED_INT_24_8,samplingMode:_a.NEAREST,wrapMode:ma.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return null;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===t.width&&i.descriptor.height===t.height||i.resize(t.width,t.height):(i=new gn(this._rctx,{internalFormat:ba.DEPTH_STENCIL,...t}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,t){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===t.width&&i.descriptor.height===t.height||(i.dispose(),i=q())),i||(i=new Zn(this._rctx,{target:da.TEXTURE_2D,pixelFormat:ua.RGBA,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:_a.LINEAR,wrapMode:ma.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:rh(),...FR,...e}}registerColorTarget(e={}){return{id:rh(),...NR,...e}}getFramebuffer(e,t,i){const r=this._getKey(t,i);let s=this._framebuffers.get(r);const a=this.getColorTexture(t,e);if(this.depthTextureSupported){const t=i?this.getDepthTexture(i,e):void 0;return s?((s.width!==e.width||s.height!==e.height||s.colorTexture!==a||s.depthStencilTexture!==t)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilTexture(t)),s):(s=A(i)?new hn(this._rctx,{colorTarget:ca.TEXTURE,depthStencilTarget:fa.DEPTH_STENCIL_TEXTURE},a,t):new hn(this._rctx,{colorTarget:ca.TEXTURE,depthStencilTarget:fa.NONE},a),this._framebuffers.set(r,s),s)}const n=i?this.getDepthBuffer(i,e):void 0;return s?((s.width!==e.width||s.height!==e.height||s.colorTexture!==a)&&(s.detachAll(),s.resize(e.width,e.height),s.attachColorTexture(a),s.attachDepthStencilBuffer(n)),s):(s=new hn(this._rctx,{colorTarget:ca.TEXTURE,depthStencilTarget:i?fa.DEPTH_STENCIL_RENDER_BUFFER:fa.NONE},a,n),this._framebuffers.set(r,s),s)}_getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}get gpuMemoryUsage(){let e=0;const t=new Set,i=i=>{t.has(i)||(t.add(i),e+=mn(i))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),e}}class jR{constructor(e,t){this._rctx=e,this._compositingHelper=t,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._background={type:"color",color:[0,0,0,1]};const i=e.type===jd.WEBGL2;this._renderTargetHelper=new UR(e);const r=this._renderTargetHelper;this._mainColorTargets=[r.registerColorTarget({name:"mainColorTarget0"}),r.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=r.registerColorTarget({name:"frontFaceTarget"});const s=e=>r.registerColorTarget({name:e,dataType:pa.FLOAT,internalFormat:i?xa.RGBA32F:ua.RGBA,samplingMode:_a.NEAREST});this.colorFloatTarget=s("colorFloatTarget"),this.alphaFloatTarget=s("alphaFloatTarget"),this.mainDepth=r.registerDepthTarget({name:"mainDepth"}),this.linearDepth=r.registerColorTarget({name:"linearDepth",samplingMode:_a.NEAREST}),this.terrainLinearDepth=r.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=r.registerColorTarget({name:"geometryLinearDepth"}),this.normal=r.registerColorTarget({name:"normal"}),this.highlight=r.registerColorTarget({name:"highlight",internalFormat:i?xa.RGBA4:ua.RGBA,dataType:pa.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=r.registerColorTarget({name:"hudVisibility",internalFormat:i?xa.RGBA4:ua.RGBA,dataType:pa.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=r.registerColorTarget({name:"tmpColor"}),this.tmpDepth=r.registerDepthTarget({name:"tmpDepth"}),this.hudColor=r.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this._mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this._mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,t)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}setupRenderTarget(e){e||(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1])),this._mainColorTarget=0===this._mainColorTarget&&e?1:0}initializeFrame(e){const t=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const i=this._background.color;t.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),t.clearSafe(ya.COLOR_BUFFER_BIT|ya.DEPTH_BUFFER_BIT|ya.STENCIL_BUFFER_BIT)}composite(e){A(this.colorTexture)&&this._compositingHelper.composite(e,this.colorTexture,MP.None)}renderTmpAndCompositeToMain(e,t,i,r=!1){this.renderToTargets(e,this.tmpColor,r?this.tmpDepth:this.mainDepth,VR),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),i)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,kR)}compositeTransparentTerrainOntoHUDVisibility(e){this.renderToTargets((()=>this._compositingHelper.compositeHUD(e,this._getColorTexture(this.tmpColor))),this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,i){let r,s;switch(t){case lu.Color:r=this.colorFloatTarget,s=[0,0,0,0];break;case lu.Alpha:r=this.alphaFloatTarget,s=[1,1,1,1];break;case lu.FrontFace:r=this.frontFaceTarget,s=[0,0,0,0]}i?this.renderToTargets(e,r,this.tmpDepth,s,!0,!0):this.renderToTargets(e,r,this.mainDepth,s,!1)}compositeTransparentTerrainOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),MP.PremultipliedAlpha)}compositeOccludedOntoMain(e,t){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),MP.PremultipliedAlpha,t)}compositeTransparentOntoOpaque(e,t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(ya.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}renderToFBO(e,t,i=!1,r=!1){const s=this._rctx;let a=0;if(t){const e=1e-13,i=Math.max(e,t[3]);s.setClearColor(t[0],t[1],t[2],i),a|=ya.COLOR_BUFFER_BIT}i&&(a|=ya.DEPTH_BUFFER_BIT),!1===r?r=0:(!0===r&&(r=255),a|=ya.STENCIL_BUFFER_BIT),a&&s.clearSafe(a,r),e(),s.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderToTargets(e,t,i,r,s=!1,a=!1){const n=this.bindTarget(t,i);return this.renderToFBO(e,r,s,a),n}bindTarget(e,t){const i=this._renderTargetHelper.getFramebuffer(this._dimensions,e,t);return this._rctx.bindFramebuffer(i),i}_getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}const VR=[0,0,0,0],kR=[0,1,0,1];class zR{constructor(e){this._context=e,this._renderPlugins=new J,this._slots=[];for(let e=0;e<go.MAX_SLOTS;++e)this._slots[e]=[]}add(e,t,i){const r=()=>{if(i?.aborted)throw t.uninitializeRenderContext(),l();this._renderPlugins.push(t);for(const i of e)this._slots[i].push(t);this._context.requestRender()},s=t.initializeRenderContext(this._context,i);if(g(s))return s.then(r);r()}remove(e){if(null!=this._renderPlugins.removeUnordered(e)){for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter((t=>t!==e));e.uninitializeRenderContext(),this._context.requestRender()}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)}))}updateAnimation(e){let t=!1;return this._renderPlugins.forAll((i=>{i.updateAnimation&&(t=i.updateAnimation(e)||t)})),t}prepareSlots(e){for(const t of e)this._context.renderContext.bindParameters.slot=t,this._slots[t].filter((e=>{e.canRender&&(qR(e)&&e.prepareTechnique(this._context.renderContext),GR(e)&&e.prepareTechniques(this._context.renderContext))}))}render(){const e=this._slots[this._context.renderContext.bindParameters.slot],t=new Array;e.filter((e=>{if(!e.canRender)return!1;if(qR(e)){const i=e.prepareTechnique(this._context.renderContext);return!!A(i)&&(t.push(i),!0)}if(GR(e)){const i=e.prepareTechniques(this._context.renderContext);return!!A(i)&&(t.push(i),!0)}return t.push(null),!0})).forEach(((e,i)=>e.render(this._context.renderContext,t[i])))}queryDepthRange(e){const t=HR;return t.near=1/0,t.far=-1/0,this._renderPlugins.forAll((i=>{if(i.queryDepthRange){const r=i.queryDepthRange(e);r&&yS(t,r,t)}})),t}get needsTransparentPass(){return this._renderPlugins.some((e=>!!e.needsTransparentPass))}get needsHighlight(){return this._renderPlugins.some((e=>!!e.needsHighlight))}get needsLinearDepth(){return this._renderPlugins.some((e=>!!e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this._slots[go.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,t)=>e|t.renderOccludedFlags),0)}}function qR(e){return"prepareTechnique"in e}function GR(e){return"prepareTechniques"in e}const HR={near:0,far:0};class BR extends vs{}const WR=is(),$R=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:BR,ShadowCastMaxSamples:255,build:function(e){const t=new Vs,i=t.fragment;return i.include(Ds),i.include(bs),t.include(Au),t.include(Ka),t.include(ys,e),i.uniforms.add([new qs("depthMap",(e=>e.linearDepthTexture)),new js("inverseViewMatrix",((e,t)=>es(WR,Kr(WR,t.camera.viewMatrix,t.camera.center)))),new Ms("nearFar",((e,t)=>t.camera.nearFar))]),i.constants.add("sampleValue","float",.00392156862745098),i.code.add(Fs`void main(void) {
float depth = rgba2float(texture(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
fragColor = vec4(sampleValue);
}`),t}},Symbol.toStringTag,{value:"Module"}));class QR extends Us{constructor(e){super(),this.shadowCastMap=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=vr(XR),this.bandSize=.1,this.threshold=.5}}const XR=fr(.01,0,.25,1),YR=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:QR,build:function(e){const t=new Vs,i=t.fragment;i.include(Ds),i.include(bs),t.include(Au),t.include(Ka);const{visualization:r,bandsEnabled:s}=e;i.constants.add("inverseSampleValue","float",255),i.uniforms.add([new qs("shadowCastMap",(e=>e.shadowCastMap)),new Ns("sampleScale",(e=>e.sampleScale)),new Ns("opacityFromElevation",(e=>e.opacityFromElevation)),new Ls("uColor",(e=>e.color))]);const a=r===To.Gradient,n=r===To.Threshold;return a&&s?i.uniforms.add(new Ns("bandSize",(e=>e.bandSize))):n&&i.uniforms.add(new Ns("threshold",(e=>e.threshold))),i.code.add(Fs`
      void main(void) {
        vec4 record = texture(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;
        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${n?Fs`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${a&&s?Fs`strength = ceil(strength / bandSize) * bandSize;`:""}

        fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${a?Fs`* strength`:""});
      }
    `),t}},Symbol.toStringTag,{value:"Module"}));class ZR extends Hs{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){return new Bs(e.rctx,ZR.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:mu,colorWrite:Ca,depthTest:null,depthWrite:null})}get primitiveType(){return la.TRIANGLE_STRIP}}ZR.shader=new Ws(YR,(()=>Promise.resolve().then((()=>YR))));const KR=1/512;let JR=class extends Hi{constructor(e,t,i,r){super({}),this._techniqueRepository=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new QR(this._data.shadowCastTexture),this._techniqueConfig=new wo,this._enabled=!1,this._vao=Ma(t),this._techniqueConfig.visualization=To.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=F(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(ZR,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,this._passParameters,e),this._rctx.drawArrays(t.primitiveType,0,cn(this._vao,"geometry"))}setOptions(e){void 0!==e.enabled&&this._setEnabled(e.enabled),void 0!==e.color&&this._setColor(e.color),void 0!==e.threshold&&(this._threshold=e.threshold),void 0!==e.visualization&&(this._visualization=e.visualization),void 0!==e.bandSize&&(this._bandSize=e.bandSize),void 0!==e.bandsEnabled&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>KR}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;Vr(e,t)||(Fr(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};e([ce()],JR.prototype,"opacityFromElevation",null),JR=e([ue("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],JR);class eO extends Aa{constructor(){super(...arguments),this.receiveShadows=!0}}e([Ea()],eO.prototype,"receiveShadows",void 0);class tO extends Hs{constructor(e){super(e,new eO,(()=>this.destroy()))}initializeProgram(e){return new Bs(e.rctx,tO.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:wa(na.ONE,na.ONE,na.ONE,na.ONE),colorWrite:Ca,depthTest:null,depthWrite:null})}get primitiveType(){return la.TRIANGLE_STRIP}}tO.shader=new Ws($R,(()=>Promise.resolve().then((()=>$R))));let iO=class extends Hi{constructor(e,t,i,r,s,a){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=a,this._progress=0,this._sampleCount=0,this._passParameters=new BR,this._enabledInternal=!1,this._cachedLightDirections=[],this._depthRange=bS,this._previewing=!1,this._handles=new R,this._cameraForcedForScreenshot=!1,this._bindParameters=new fn(new En(e,i.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._vao=Ma(e);const n={colorTarget:ca.TEXTURE,depthStencilTarget:fa.NONE,width:0,height:0},o={target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,samplingMode:_a.LINEAR,wrapMode:ma.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new hn(e,n,o),this._accumulationRenderer=new JR(t,e,this,a);const l=this._stage.view.resourceController.scheduler;this._handles.add([l.registerTask(Vn.SHADOW_ACCUMULATOR,this),G((()=>i.renderView),(e=>{this._handles.remove(sO),A(e)&&this._handles.add(e.events.on("force-camera-for-screenshot",(()=>this._cameraForcedForScreenshot=!0)),sO)}),B),G((()=>this._previewing),(()=>this._requestRenderIfEnabled()),$)])}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(M(this._accumulationTechniqueCached)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new tO(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabledInternal&&this._sampleCount>0}get canAccumulate(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==bS&&this._opacityFromElevation>KR}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(T(t,e,Me))return;const i=Math.min(255,e.length);t.length=i,this._sampleCount=i;for(let r=0;r<i;++r)t[r]=De(t[r]??ve(),e[r]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,r){if(this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();const s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(rO,this._sampleCount-this._progress);for(let e=0;e<s;++e)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(e){this._accumulationRenderer.render(e)}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=F(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=F(this._fbo),this._vao=F(this._vao),this._accumulationTechniqueCached=N(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){void 0!==e.enabled&&(this._enabled=e.enabled),void 0!==e.previewing&&(this._previewing=e.previewing),void 0!==e.lightDirections&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,ua.RGBA,pa.UNSIGNED_BYTE,nO),nO[0]/this._progress)}_start(){this._progress=0,this._enabledInternal=!0}_stop(){this._enabledInternal=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(ya.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,cn(this._vao,"geometry"))}_sampleLightDirection(){return this._progress++,this._lightDirections[this._progress*aO%this._lightDirections.length]}_updateCamera(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Xi(4e4,5e4,e.relativeElevation))}set _enabled(e){e!==this._enabledInternal&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabledInternal&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};e([ce()],iO.prototype,"_progress",void 0),e([ce()],iO.prototype,"_sampleCount",void 0),e([ce()],iO.prototype,"_enabledInternal",void 0),e([ce()],iO.prototype,"_depthRange",void 0),e([ce()],iO.prototype,"_previewing",void 0),e([ce()],iO.prototype,"_accumulationRenderer",void 0),e([ce()],iO.prototype,"_isRefining",null),e([ce()],iO.prototype,"_isActive",null),e([ce()],iO.prototype,"canAccumulate",null),e([ce()],iO.prototype,"_isDoneAccumulating",null),e([ce()],iO.prototype,"_opacityFromElevation",null),e([ce()],iO.prototype,"running",null),iO=e([ue("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],iO);const rO=6,sO="renderView",aO=104729,nO=new Uint8Array(4),oO=is(),lO=ve(),hO=kr(),cO=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new Vs;t.include(ms,e);const i=t.fragment;return i.include(Ds),i.include(bs),t.include(Au),t.include(Ka),i.uniforms.add([new qs("defaultDepthTex",((e,t)=>t.shadowMap.getSnapshot(An.Default))),new qs("highlightDepthTex",((e,t)=>t.shadowMap.getSnapshot(An.Highlight))),new qs("depthMap",((e,t)=>t.linearDepthTexture)),new qs("highlightMap",((e,t)=>t.highlightColorTexture)),new Ls("uColor",(e=>e.shadowColor)),new Ms("nearFar",((e,t)=>t.camera.nearFar)),new Ns("opacity",(e=>e.shadowOpacity)),new Ns("occludedOpacity",(e=>e.occludedShadowOpacity)),new Ns("terminationFactor",(e=>e.opacityElevation*e.dayNightTerminator)),new Is("lightingMainDirectionView",((e,t)=>be(lO,Le(lO,t.lighting.mainLight.direction,t.camera.viewInverseTransposeMatrix)))),new Ms("texelSize",((e,t)=>A(t.linearDepthTexture)?Rr(hO,1/t.linearDepthTexture.descriptor.width,1/t.linearDepthTexture.descriptor.height):qr)),new js("inverseViewMatrix",((e,t)=>es(oO,Kr(oO,t.camera.viewMatrix,t.camera.center))))]),i.constants.add("unoccludedHighlightFlag","vec4",wd).add("highlightedThreshold","float",.99999).add("selfShadowThreshold","float",.025),i.code.add(Fs`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),i.code.add(Fs`void main(void) {
vec4 highlightInfo = texture(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),t}},Symbol.toStringTag,{value:"Module"}));class dO extends Us{constructor(){super(...arguments),this.shadowColor=fr(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class uO extends Hs{constructor(e){super(e,new eO,(()=>this.destroy()))}initializeProgram(e){return new Bs(e.rctx,uO.shader.get().build(this.configuration),$s)}initializePipeline(){return Ta({blending:wa(na.SRC_ALPHA,na.ONE,na.ONE_MINUS_SRC_ALPHA,na.ONE_MINUS_SRC_ALPHA),colorWrite:Ca,depthTest:null,depthWrite:null})}get primitiveType(){return la.TRIANGLE_STRIP}}uO.shader=new Ws(cO,(()=>Promise.resolve().then((()=>cO))));class pO{constructor(e,t){this._rctx=e,this._viewingMode=t,this._maxOpacity=1,this._passParameters=new dO,this._drawParameters=new vs,this._vao=Ma(this._rctx)}get _technique(){return M(this._techniqueCached)&&(this._techniqueCached=new uO({rctx:this._rctx,viewingMode:this._viewingMode})),this._techniqueCached}render(e,t){if(!e.shadowMap.enabled||!e.linearDepthTexture||!this.isVisible)return;const i=this._technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(t),this._rctx.bindTechnique(i,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,cn(this._vao,"geometry"))}get gpuMemoryUsage(){return this._vao?.size??0}setDefaultOptions(e){this._passParameters={...this._passParameters,...e},this._updateMaxOpacity()}updateParameters(e,t){this._passParameters.opacityElevation=1-Xi(4e4,5e4,e.relativeElevation);const i=this._viewingMode===Ui.Global?be(mO,e.center):Pe(mO,0,0,1),r=xe(i,t);this._passParameters.dayNightTerminator=Xi(0,1,Bi(30*r,0,1))}dispose(){this._vao=F(this._vao),this._techniqueCached=N(this._techniqueCached)}get isVisible(){const{opacityElevation:e,dayNightTerminator:t}=this._passParameters;return this._maxOpacity*e*t>=.001953125}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}}const mO=ve(),_O=Rt();class gO{constructor(){this._plane=Rt()}get isEnabled(){return!Mt(this.plane,_O)}get plane(){return this._plane}set plane(e){Ot(e||_O,this._plane)}}class fO extends Us{}function yO(e){e.uniforms.add(new Ls("resolution",(e=>{const{descriptor:t}=e.colorTexture,i=t.width,r=t.height;return Dr(vO,1/i,1/r,i,r)})))}const vO=_r(),bO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new Vs,{attributes:t,varyings:i,vertex:r,fragment:s}=e;return t.add(Gs.POSITION,"vec2"),i.add("uv","vec2"),i.add("offsets[2]","vec4"),i.add("maxOffset","vec4"),i.add("pixelCoord","vec2"),yO(r),r.code.add(Fs`
      void main() {
        uv = position * 0.5 + vec2(0.5);
        gl_Position = vec4(position, 0, 1);

        pixelCoord = uv * resolution.zw;
        offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${Fs.int(8)} );
      }
    `),s.uniforms.add(new qs("edgesTexture",(e=>e.edges.colorTexture))),s.uniforms.add(new qs("areaTexture",(e=>e.areaTexture))),s.uniforms.add(new qs("searchTexture",(e=>e.searchTexture))),yO(s),s.code.add(Fs`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture(tex, coord + offset.x * resolution.xy, 0.0);
      }

      float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
        e.r = bias + e.r * scale;
        return 255.0 * texture( searchTex, e, 0.0 ).r;
      }

      float searchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${Fs.int(8)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float searchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${Fs.int(8)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float searchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${Fs.int(8)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${Fs.int(8)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${Fs.int(16)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture( areaTex, texcoord, 0.0 ).rg;
      }

      void main() {
        ivec4 subsampleIndices = ivec4(0.0);
        vec4 weights = vec4(0.0);
        vec2 e = texture( edgesTexture, uv ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = searchXLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x );
          coords.y = offsets[1].y;
          d.x = coords.x;
          float e1 = texture( edgesTexture, coords, 0.0 ).r;
          coords.x = searchXRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y );
          d.y = coords.x;
          d = d * resolution.z - pixelCoord.x;
          vec2 sqrt_d = sqrt( abs(d) );
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = searchYUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z );
          coords.x = offsets[0].x;
          d.x = coords.y;
          float e1 = texture( edgesTexture, coords, 0.0 ).g;
          coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w );
          d.y = coords.y;
          d = d * resolution.w - pixelCoord.y;
          vec2 sqrt_d = sqrt(abs(d));
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0)).g;
          weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
        }
        fragColor = weights;
      }
    `),e}},Symbol.toStringTag,{value:"Module"}));class xO extends Hs{initializeProgram(e){return new Bs(e.rctx,xO.shader.get().build(),$s)}initializePipeline(){return Ta({colorWrite:Ca})}}xO.shader=new Ws(bO,(()=>Promise.resolve().then((()=>bO))));const TO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new Vs,{attributes:t,varyings:i,vertex:r,fragment:s}=e;return t.add(Gs.POSITION,"vec2"),i.add("uv","vec2"),i.add("offsets[2]","vec4"),yO(r),r.code.add(Fs`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}`),s.uniforms.add(new qs("blendWeightsTexture",(e=>e.blend.colorTexture))),s.uniforms.add(new qs("colorTexture",(e=>e.colorTexture))),yO(s),s.code.add(Fs`void main() {
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets[1].zw).g;
a.a = texture(blendWeightsTexture, offsets[1].xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}
}`),e}},Symbol.toStringTag,{value:"Module"}));class wO extends Hs{initializeProgram(e){return new Bs(e.rctx,wO.shader.get().build(),$s)}initializePipeline(){return Ta({colorWrite:Ca})}}wO.shader=new Ws(TO,(()=>Promise.resolve().then((()=>TO))));const CO=Object.freeze(Object.defineProperty({__proto__:null,build:function(){const e=new Vs,{attributes:t,varyings:i,vertex:r,fragment:s}=e;return t.add(Gs.POSITION,"vec2"),yO(r),i.add("uv","vec2"),i.add("offsets[3]","vec4"),r.code.add(Fs`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
offsets[2] = uv.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}`),s.uniforms.add(new qs("colorTexture",(e=>e.colorTexture))),s.code.add(Fs`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture(colorTexture, uv).rgb;

      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${Fs.float(.05)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges.xy *= step(maxDelta, float(${Fs.float(2)}) * delta.xy);

      fragColor = vec4(edges, 0.0, 0.0);
    }
  `),e}},Symbol.toStringTag,{value:"Module"}));class SO extends Hs{initializeProgram(e){return new Bs(e.rctx,SO.shader.get().build(),$s)}initializePipeline(){return Ta({colorWrite:Ca})}}SO.shader=new Ws(CO,(()=>Promise.resolve().then((()=>CO))));let PO=class extends Hi{constructor(e,t){super({}),this._rctx=e,this._techniqueRep=t,this._passParameters=new fO,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=L(this._abortController),this.disable()}_loadResources(e){if(A(this._abortController))return!1;if(A(this._passParameters.searchTexture))return!0;this._abortController=new AbortController;const t=this._abortController.signal;return import("../chunks/SmaaRenderPassData.js").then((e=>this._loadTextures(e,t))).then((()=>e())).finally((()=>this._abortController=null)),!1}_loadTextures(e,t){return p(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,_a.LINEAR,ua.RGB),this._loadTextureFromBase64(e.searchTexure,_a.NEAREST,ua.LUMINANCE)]).then((([e,i])=>{h(t)?(e.dispose(),i.dispose(),p(t)):(this._passParameters.areaTexture=e,this._passParameters.searchTexture=i)}))}get updating(){return A(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const e=new Aa;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(SO,e,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(xO,e,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(wO,e,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=Va(this._rctx),this._passParameters.edges=new hn(this._rctx,{colorTarget:ca.TEXTURE,depthStencilTarget:fa.NONE},{target:da.TEXTURE_2D,pixelFormat:ua.RGB,dataType:pa.UNSIGNED_BYTE,samplingMode:_a.LINEAR,wrapMode:ma.CLAMP_TO_EDGE,width:4,height:4}),this._passParameters.blend=new hn(this._rctx,{colorTarget:ca.TEXTURE,depthStencilTarget:fa.NONE},{target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,samplingMode:_a.LINEAR,wrapMode:ma.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=F(this._vao),this._passParameters.areaTexture=F(this._passParameters.areaTexture),this._passParameters.searchTexture=F(this._passParameters.searchTexture),this._passParameters.blend=F(this._passParameters.blend),this._passParameters.edges=F(this._passParameters.edges),this._isEnabled=!1)}get _validPassParameters(){return this._isEnabled?this._passParameters:null}render(e){const t=this._validPassParameters;if(M(t))return;t.colorTexture=e;const i=this._rctx,r=i.getBoundFramebufferObject(),s=e.descriptor.width,a=e.descriptor.height;i.bindVAO(this._vao),i.setViewport(0,0,s,a),t.edges.resize(s,a),i.bindFramebuffer(t.edges),i.setClearColor(0,0,0,1),i.clear(ya.COLOR_BUFFER_BIT),i.bindTechnique(this._edgeDetectTechnique,t,null),i.drawArrays(la.TRIANGLES,0,3),t.blend.resize(s,a),i.bindFramebuffer(t.blend),i.setClearColor(0,0,1,1),i.clear(ya.COLOR_BUFFER_BIT),i.bindTechnique(this._blendWeightsTechnique,t,null),i.drawArrays(la.TRIANGLES,0,3),i.bindFramebuffer(r),i.setClearColor(0,1,0,1),i.clear(ya.COLOR_BUFFER_BIT),i.bindTechnique(this._blurTechnique,t,null),i.drawArrays(la.TRIANGLES,0,3)}_loadTextureFromBase64(e,t,i){return Ru(e).then((e=>new Zn(this._rctx,{pixelFormat:i,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.CLAMP_TO_EDGE,width:e.width,height:e.height,samplingMode:t},e)))}};e([ce()],PO.prototype,"_abortController",void 0),e([ce({readOnly:!0})],PO.prototype,"updating",null),PO=e([ue("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],PO);class RO{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const t=this._originData.get(e.id)||new OO(e);return t.refCount++,this._originData.has(t.origin.id)||this._originData.set(t.origin.id,t),t}release(e){e.refCount--,0===e.refCount&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach((t=>{Br(t.viewMatrix,e),function(e,t){const i=e[0],r=e[1],s=e[2];t[12]+=i*t[0]+r*t[4]+s*t[8],t[13]+=i*t[1]+r*t[5]+s*t[9],t[14]+=i*t[2]+r*t[6]+s*t[10],t[14]+=i*t[3]+r*t[7]+s*t[11]}(t.origin.vec3,t.viewMatrix)}))}}class OO{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=is()}}class EO extends nn{constructor(e,t){super(),this.distanceFalloffFactor=e,this.transparency=t,this.transformNormalViewFromGlobal=Za()}}class AO extends on{constructor(){super(...arguments),this.transformNormalViewFromGlobal=Za(),this.slicePlaneLocalOrigin=ve(),this.transformNormalGlobalFromModel=Za()}}function MO(e){const t=Fs`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}const DO=zr(.5,-4e-4);function IO(e,t){const i=e.vertex;i.include(MO),i.constants.add("depthBias","vec2",DO),i.uniforms.add(new Ms("inverseViewport",((e,t)=>t.inverseViewport))),t.legacy?(i.uniforms.add(new js("proj",((e,t)=>t.camera.projectionMatrix))),i.code.add(Fs`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(i.uniforms.add(new Mu("transformNormalViewFromGlobal",(e=>e.transformNormalViewFromGlobal))),i.uniforms.add(new js("transformProjFromView",(e=>e.transformProjFromView))),i.code.add(Fs`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),i.code.add(Fs`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function LO(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(Fs`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(Fs`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function NO(e,t){const i=e.vertex;t.silhouette?(i.code.add(Fs`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(Fs`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(Fs`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(Fs`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function FO(e,t){const i=e.vertex;i.include(Ds),i.uniforms.add(new Ns("distanceFalloffFactor",(e=>e.distanceFalloffFactor))),i.code.add(Fs`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add(new nu("componentDataTex",(e=>e.componentDataTexture))),e.attributes.add(Gs.COMPONENTINDEX,"float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentVerticalOffsetFieldOffset","float",2),i.constants.add("componentFieldCount","float",3),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("verticalOffsetScale","float",2*HS),i.code.add(Fs`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float texSize = float(textureSize(componentDataTex, 0).x);
float colIndex = mod(fieldIndex, texSize);
float rowIndex = floor(fieldIndex / texSize);
return vec2(colIndex, rowIndex) + 0.5;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
float verticalOffset;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);
vec4 colorValue = texelFetch(componentDataTex, ivec2(colorIndex), 0);
vec4 otherValue = texelFetch(componentDataTex, ivec2(otherIndex), 0);
float verticalOffset = (rgba2float(texelFetch(componentDataTex, ivec2(verticalOffsetIndex), 0)) - 0.5) * verticalOffsetScale;
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5,
verticalOffset
);
}`),t.legacy?i.code.add(Fs`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add(new Ja("transformNormalGlobalFromModel",(e=>e.transformNormalGlobalFromModel))),i.code.add(Fs`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add(Gs.NORMALA,"vec3"),e.attributes.add(Gs.NORMALB,"vec3"),i.code.add(Fs`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(e.attributes.add(Gs.NORMAL,"vec3"),i.code.add(Fs`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),t.legacy?i.code.add(Fs`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(i.include(ln,t),i.include(ln,t),i.uniforms.add([new Mu("transformViewFromCameraRelativeRS",(e=>e.transformViewFromCameraRelativeRS)),new Ja("transformWorldFromModelRS",(e=>e.transformWorldFromModelRS)),new Id("transformWorldFromModelTL",(e=>e.transformWorldFromModelTL)),new Id("transformWorldFromModelTH",(e=>e.transformWorldFromModelTH)),new Is("transformWorldFromViewTL",(e=>e.transformWorldFromViewTL)),new Is("transformWorldFromViewTH",(e=>e.transformWorldFromViewTH))]),i.code.add(Fs`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${t.spherical?Fs`normalize(transformWorldFromModelTL + rotatedModelPosition);`:Fs`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),i.uniforms.add(new js("transformProjFromView",((e,t)=>t.camera.projectionMatrix))),i.code.add(Fs`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),i.code.add(Fs`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}var UO,jO;function VO(e,t){const i=e.vertex;switch(e.attributes.add(Gs.SIDENESS,"vec2"),t.mode===UO.MIXED?i.code.add(Fs`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(Fs`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case UO.MIXED:i.code.add(Fs`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case UO.SKETCH:i.code.add(Fs`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case UO.SOLID:i.code.add(Fs`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case UO.COUNT:break;default:nr(t.mode)}}function kO(e,t){const i=e.vertex;switch(e.include(VO,t),t.mode){case UO.SOLID:i.code.add(Fs`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case UO.SKETCH:i.uniforms.add(new su("strokesAmplitude",(e=>e.strokesTexture.amplitude))),i.code.add(Fs`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case UO.MIXED:i.uniforms.add(new su("strokesAmplitude",(e=>e.strokesTexture.amplitude))),i.code.add(Fs`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function zO(e,t){e.include(VO,t);const{vertex:i,fragment:r}=e;var s;switch(((s=t).mode===UO.SKETCH||s.mode===UO.MIXED)&&(i.uniforms.add(new nu("strokesTexture",(e=>e.strokesTexture.texture))),i.uniforms.add([new su("strokesLog2Resolution",(e=>Math.log2(e.strokesTexture.resolution))),new su("strokeVariants",(e=>e.strokesTexture.variants))]),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add([new nu("strokesTexture",(e=>e.strokesTexture.texture)),new su("strokesNormalizationScale",(e=>e.strokesTexture.normalizationScale))]),i.code.add(Fs`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) / vec2(textureSize(strokesTexture, 0));
vStrokeUV.x += variantOffset;
}`),e.fragment.include(Ds),r.code.add(Fs`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case UO.SOLID:i.code.add(Fs`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(Fs`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case UO.SKETCH:i.code.add(Fs`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(Fs`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case UO.MIXED:e.varyings.add("vType","float"),i.code.add(Fs`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(Fs`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}!function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"}(UO||(UO={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.SILHOUETTE=1]="SILHOUETTE"}(jO||(jO={}));const qO=kr();class GO extends ks{constructor(e){super(e,"mat4")}}const HO=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new Vs,{vertex:i,fragment:r}=t;return e.legacy&&i.uniforms.add([new GO("model"),new GO("localView")]),t.include(IO,e),t.include(FO,e),t.include(kO,e),t.include(VO,e),t.include(zO,e),t.include(_d,e),t.include(NO,e),t.include(LO,e),t.include(du,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add([new Ms("pixelToNDC",((e,t)=>Rr(qO,2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]))),new Ls("viewport",((e,t)=>t.camera.fullViewport)),new Ns("pixelRatio",((e,t)=>t.camera.pixelRatio))]),t.attributes.add(Gs.POSITION0,"vec3"),t.attributes.add(Gs.POSITION1,"vec3"),t.attributes.add(Gs.VARIANTOFFSET,"float"),t.attributes.add(Gs.VARIANTSTROKE,"float"),t.attributes.add(Gs.VARIANTEXTENSION,"float"),i.code.add(Fs`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      vViewPos = viewPos;

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 ndcToPixel = viewport.zw * 0.5;
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

      ${e.antialiasing?Fs`
        const float aaPaddingPixels = 1.0;

        // Line size with padding
        float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
        float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;`:Fs`
        float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
        float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;`}

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard short edges below a certain length threshold
      ${e.mode===UO.SKETCH?Fs`
        if (lineLengthPixels <= 3.0) {
          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return;
        }`:e.mode===UO.MIXED?Fs`
        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {
           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
           return;
        }`:""}
      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),r.code.add(Fs`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float positionX = position.x - calculateLineOffset();

      if (radius < 1.0) {
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);
        return vec2(0.5 - min(coverageX, coverageY), 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      fragColor = vec4(vColor.rgb, vColor.a * coverage);
    }
  `),t}},Symbol.toStringTag,{value:"Module"}));class BO extends Hs{initializeProgram(e){return new Bs(e.rctx,BO.shader.get().build(this.configuration),bu)}initializePipeline(e){return e.blendMinMax?Ta({blending:wa(na.ONE,na.ONE,na.ZERO,na.ONE,ha.ADD,e.blendMinMax.MAX),depthTest:{func:oa.LEQUAL},colorWrite:Ca}):Ta({depthTest:{func:oa.LEQUAL},depthWrite:Ra,colorWrite:Ca})}}BO.shader=new Ws(HO,(()=>Promise.resolve().then((()=>HO))));class WO extends Wn{constructor(){super(...arguments),this.mode=UO.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.spherical=!1}}e([Ea({count:UO.COUNT})],WO.prototype,"mode",void 0),e([Ea()],WO.prototype,"hasSlicePlane",void 0),e([Ea()],WO.prototype,"silhouette",void 0),e([Ea()],WO.prototype,"legacy",void 0),e([Ea()],WO.prototype,"antialiasing",void 0),e([Ea()],WO.prototype,"doublePrecisionRequiresObfuscation",void 0),e([Ea()],WO.prototype,"hasMultipassTerrain",void 0),e([Ea()],WO.prototype,"cullAboveGround",void 0),e([Ea()],WO.prototype,"spherical",void 0);const $O={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},QO={solid:UO.SOLID,sketch:UO.SKETCH,uber:UO.MIXED};class XO{constructor(e,t,i){this._rctx=e,this._shaderTechniqueRepository=t,this._configuration=new WO,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[Du.TRANSPARENT]:{[Du.TRANSPARENT]:new J,[Du.OPAQUE]:new J},[Du.OPAQUE]:{[Du.TRANSPARENT]:new J,[Du.OPAQUE]:new J}},this._renderablesDirty=!1,this._drawParameters=new AO,this._settings={...$O,...i},this.key=XO.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const r=this._settings.strokesTexture.variants;this.writerSettings={variants:r,reducedPrecision:La.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=QO[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}dispose(){this._technique=N(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,t){this._renderablesDirty&&this._sortRenderables(),this._sortedRenderables[t][Du.TRANSPARENT].forAll(e),this._sortedRenderables[t][Du.OPAQUE].forAll(e)}updateTechnique(e,t){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(BO,this._configuration,this._technique),this._technique}bindRegularEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!1),e,t)}bindSilhouetteEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!0),e,t)}renderRegularEdges(e,t,i,r,s){this._render(e,t,t.regular.vao,i,r,s)}renderSilhouetteEdges(e,t,i,r,s){this._render(e,t,t.silhouette.vao,i,r,s)}_render(e,t,i,r,s,a){a>0&&(this._bindDraw(e,t,r,s),this._rctx.bindVAO(i),this._rctx.capabilities.instancing.drawArraysInstanced(la.TRIANGLE_FAN,0,4,a))}_bindDraw(e,t,i,r){if(this._drawParameters.componentDataTexture=t.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in t.transform)this._lastOriginId!==t.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",t.transform.origin.viewMatrix),this._lastOriginId=t.transform.origin.origin.id),e.setUniformMatrix4fv("model",t.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=t.transform.origin.origin.vec3;else{const e=new cP(t.transform.position),i=$a(YO,Wa(YO,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=e.low,this._drawParameters.transformWorldFromModelTH=e.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=i;const s=r.camera.viewInverseTransposeMatrix;Pe(this._drawParameters.slicePlaneLocalOrigin,s[3],s[7],s[11])}e.bindDraw(this._drawParameters,r,i)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[Du.TRANSPARENT][Du.TRANSPARENT].clear(),this._sortedRenderables[Du.TRANSPARENT][Du.OPAQUE].clear(),this._sortedRenderables[Du.OPAQUE][Du.TRANSPARENT].clear(),this._sortedRenderables[Du.OPAQUE][Du.OPAQUE].clear(),this._renderables.forEach((e=>{e.objectTransparency!==Du.INVISIBLE&&e.edgeTransparency!==Du.INVISIBLE&&this._sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform?"origin"in t.transform?e.transform.origin.origin.id<t.transform.origin.origin.id?-1:e.transform.origin.origin.id>t.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[Du.TRANSPARENT][Du.TRANSPARENT].sort(e),this._sortedRenderables[Du.TRANSPARENT][Du.OPAQUE].sort(e),this._sortedRenderables[Du.OPAQUE][Du.TRANSPARENT].sort(e),this._sortedRenderables[Du.OPAQUE][Du.OPAQUE].sort(e)}static getKey(e,t,i){return`edges-t:${e}:${t}:${i}`}}const YO=qd();function ZO(e,t){if(!e)return null;const i=e.length/2,r=JO*i,s=new Array(i);let a=0;const n=t===KO.PRESSURE;for(let t=0;t<e.length;t+=2){const i=(e[t]+e[t+1])/2;s[a++]=n?Math.min(r,1-(1-i)*eE):Math.min(r,i*eE)}return s}var KO;!function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"}(KO||(KO={}));const JO=.1,eE=.5;class tE{constructor(e,t,i,r,s){this.resolution=e,this.normalizationScale=t,this.amplitude=i,this.variants=r,this.texture=s}dispose(){this.texture=F(this.texture)}}const iE=[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}];function rE(e){let t=null;for(const i of e){const e=i.type;if(oE(i))if(M(t))t=e;else if(t!==e)return"uber"}return A(t)?t:"uber"}function sE(e){let t=Du.INVISIBLE;for(const{material:i}of e)if(nE(i)){if(i.color[3]*i.opacity<1)return Du.TRANSPARENT;t=Du.OPAQUE}return t}function aE(e){let t=Du.INVISIBLE;for(const{material:i}of e)if(nE(i)){switch(i.objectTransparency){case Du.TRANSPARENT:case Du.INVISIBLE:return Du.TRANSPARENT;case Du.OPAQUE:if(i.opacity<1)return Du.TRANSPARENT}t=Du.OPAQUE}return t}function nE(e){return e.size*e.color[3]*e.opacity>0}function oE(e){return e.size*e.color[3]>0}function lE(e,t,i,r){for(let s=0;s<e.length;s++){const a=e[s].index,n=t[s],o=t[s+1];if(r)for(let e=n;e<o;e++){const t=r[e];i.set(t,a)}else for(let e=n;e<o;e++)i.set(e,a)}}let hE=class extends Hi{constructor(e){super(e),this._updatingHandles=new Kn,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=ve(),this._localOrigins=new RO(new Rn(e.renderSR))}initialize(){this._worker=new Iu(this.schedule),this._componentColorManager=new xP(this.rctx,3);const e=xu.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,0===t||3===t?0:1),e.sideness.set(t,1,0===t||1===t?0:1);this._verticesBufferObject=dn.createVertex(this.rctx,ga.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach((e=>this._discardObjectEntry(e))),this._perObjectData.clear(),this._strokesTexture=F(this._strokesTexture),this._componentColorManager=I(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=F(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(e,t,i,r,s,a,n,o){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let l;const h=new dE(new Promise((e=>l=e)),i.center,i.radius);this._perObjectData.set(e,h);const c=await this._updatingHandles.addPromise(this._addComponentGeometry(t,h,r,s,a,n,o));return this.setNeedsRender(),l(),c}async addOrUpdateObject3D(e,t,i,r){if(this.destroyed)return void E.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(e);let a;s?.renderables.length>0&&this._perObjectDataEvictionCache.add(s);const n=e.boundingVolumeWorldSpace.bounds,o=new dE(new Promise((e=>a=e)),No(n),Fo(n));this._perObjectData.set(e,o);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&function(e){let t=null,i=null;for(let r=0;r<e.geometries.length;r++){const s=e.geometries[r];if(s.material.supportsEdges){if(t){if(!T(t,s.transformation))return!1}else t=s.transformation;if(!i&&A(s.localOrigin))i=s;else if(i&&A(i.localOrigin)&&A(s.localOrigin)&&i.localOrigin.id!==s.localOrigin.id)return!1}}return!0}(e))l.push(this._addObjectMergedGeometries(e,o,t,i,r));else for(let s=0;s<e.geometries.length;s++){const a=e.geometries[s];a.material.supportsEdges&&l.push(this._addGeometry(e,o,a,t[0],i,r))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(o),this._discardObjectEntry(s),this.setNeedsRender(),a()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach((e=>this._removeRenderable(e))),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this._perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));if(M(i))return;const r=t instanceof Array?e=>t[e]:()=>t;i.renderables.forEach((e=>{const t=e.components.meta.length;for(let i=0;i<t;i++){const t=r(i),s=e.components.meta[i],a=s.index;s.material.opacity=t,e.components.buffer.textureBuffer.setDataElement(a,1,3,255*t)}this._updateTransparency(e)})),this.setNeedsRender()}async getObjectMemoryUsage(e){const t=await this._getObjectEntry(e);return A(t)?t.renderables.reduce(((e,t)=>e+t.statistics.gpuMemoryUsage),0):0}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof lh,a=!!i.hasSlicePlane,n=rE(t),o=XO.getKey(n,a,s),l=await this._updatingHandles.addPromise(this._getObjectEntry(e));M(l)||(l.renderables.forEach((e=>{if(o!==e.rendererKey){const t=this._renderers.get(e.rendererKey),i=this._acquireRenderer(n,a,s);t.removeRenderable(e),--t.refCount,e.rendererKey=o,i.addRenderable(e)}for(let i=0;i<t.length;i++)e.components.meta[i].material=t[i];r&&this._updateComponentBuffer(e.components),this._updateTransparency(e)})),this.setNeedsRender())}async updateAllVerticalOffsets(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));M(i)||(i.renderables.forEach((e=>{const i=e.components.meta;for(let r=0;r<i.length;r++)e.components.meta[r].verticalOffset=t?.[r]??0;this._updateComponentBuffer(e.components)})),this.setNeedsRender())}async updateObjectVisibility(e,t){const i=await this._updatingHandles.addPromise(this._getObjectEntry(e));A(i)&&(i.renderables.forEach((e=>e.visible=t)),this.setNeedsRender())}removeObject(e){const t=this._perObjectData.get(e);t&&(this._perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this._perObjectData.get(e);if(!t)throw new Error("no object");return await t.loaded,null==t.loaded?null:t}render(e,t){if(M(this._componentColorManager))return;this._localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=ve(),s=new cP;let a=0,n=0;if(this._renderers.forEach((i=>{if(0===i.refCount)this._renderers.delete(i.key),i.dispose();else{let r=!0,s=!0;i.forEachRenderable((t=>{t.visible&&(a+=t.statistics.averageEdgeLength,n++,r&&t.regular&&(i.updateTechnique(e,!1),r=!1),s&&t.silhouette&&(i.updateTechnique(e,!0),s=!1))}),t)}})),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),0===n)return;const o=new EO(40*a/n,t);Pe(r,i[3],i[7],i[11]),s.set(r),De(o.transformWorldFromViewTH,s.high),De(o.transformWorldFromViewTL,s.low),Ga(o.transformViewFromCameraRelativeRS,e.camera.viewMatrix),$a(bE,o.transformViewFromCameraRelativeRS),Wa(o.transformNormalViewFromGlobal,bE),o.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this._renderers.forEach((t=>{this._renderRegularEdges(t,e,o),this._renderSilhouetteEdges(t,e,o)}))}_updateTransparency(e){const t=sE(e.components.meta),i=aE(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this._renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,i){e.getCombinedStaticTransformation(t,i);const r=A(t.localOrigin)?this._localOrigins.register(t.localOrigin):this._localOrigins.acquire(Pe(this._tmpModelPosition,i[12],i[13],i[14]));return t.localOrigin=r.origin,function(e,t){const i=-e[0],r=-e[1],s=-e[2],a=t[3],n=t[7],o=t[11],l=t[15];t[0]+=a*i,t[1]+=a*r,t[2]+=a*s,t[4]+=n*i,t[5]+=n*r,t[6]+=n*s,t[8]+=o*i,t[9]+=o*r,t[10]+=o*s,t[12]+=l*i,t[13]+=l*r,t[14]+=l*s}(r.origin.vec3,i),r}_updateComponentBuffer(e){const{meta:t,buffer:i}=e,r=new Uint8Array(4);for(let e=0;e<t.length;e++){const s=t[e].material,a=t[e].index,n=Bi(Math.round(8*s.size),0,255),o=Bi(s.extensionLength,-128,127)+128,l="solid"===s.type?Tu.SOLID:Tu.SKETCH,h=255*s.opacity,c=s.color,d=255*c[0],u=255*c[1],p=255*c[2],m=255*c[3];i.textureBuffer.setData(a,0,d,u,p,m),i.textureBuffer.setData(a,1,n,o,l,h),BS(t[e].verticalOffset,r),i.textureBuffer.setData(a,2,r[0],r[1],r[2],r[3])}}_createComponentBuffers(e){if(M(this._componentColorManager))return null;const t=new Array,i=this._componentColorManager.getBuffer(e.length);for(let r=0;r<e.length;r++){const s=e[r],a=i.acquireIndex();t.push({index:a,verticalOffset:0,material:s})}const r=new uE(i,t);return this._updateComponentBuffer(r),r}_extractEdges(e,t,i,r,s,a=s.length){return this._worker.process({data:t,indices:s,indicesLength:a,writerSettings:e,skipDeduplicate:i},this._workerAbort.signal,r)}_createRenderable(e,t,i,r,s){const a=t=>A(this._verticesBufferObject)?new pE(new Ia(this.rctx,bu,{vertices:wu,instances:t===jO.REGULAR?Cu.glLayout:Su.glLayout},{vertices:this._verticesBufferObject,instances:dn.createVertex(this.rctx,ga.STATIC_DRAW,t===jO.REGULAR?e.regular.instancesData.buffer:e.silhouette.instancesData.buffer)}),t===jO.REGULAR?e.regular.lodInfo:e.silhouette.lodInfo):null,n=e.regular.lodInfo.lengths.length>0?a(jO.REGULAR):null,o=e.silhouette.lodInfo.lengths.length>0?a(jO.SILHOUETTE):null,l=(A(n)?n.vao.size:0)+(A(o)?o.vao.size:0);return new _E(n,o,{gpuMemoryUsage:l,externalMemoryUsage:s,averageEdgeLength:e.averageEdgeLength},i,sE(t.meta),aE(t.meta),t,r)}async _addGeometry(e,t,i,r,s,a){const n=i.vertexAttributes.get(Gs.POSITION),o=i.indices.get(Gs.POSITION),l=is(),h=this._computeModelTransformWithLocalOrigin(e,i,l),c=new vE(n,o,l,h);return this._addPositionData(t,c,i.edgeIndicesLength,r,s,a)}async _addPositionData(e,t,i,r,s,a=!1){if(null==e.loaded)return;const n=this._createComponentBuffers([r]);if(M(n)||i<=0)return;const o=this._acquireRenderer(r.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:h}=t,c=t.indices,d=t.position,u=d.data.length/d.size,p=vu.createBuffer(u);for(let e=0;e<u;e++)p.position.set(e,0,d.data[e*d.size]),p.position.set(e,1,d.data[e*d.size+1]),p.position.set(e,2,d.data[e*d.size+2]);lE(n.meta,[0,p.componentIndex.count],p.componentIndex);const m=await this._updatingHandles.addPromise(this._extractEdges(o.writerSettings,p,!1,a,c,i));if(null==e.loaded)return;const _=this._createRenderable(m,n,new mE(l,h),o.key,!1);e.renderables.push(_),o.addRenderable(_),this._gpuMemoryUsage+=_.statistics.gpuMemoryUsage}async _addComponentGeometry(e,t,i,r,s,a,n){if(null==t.loaded)return 0;const o=this._createComponentBuffers(a);if(M(o))return 0;const l=rE(a),h=this._acquireRenderer(l,n.hasSlicePlane||!1,!1),c=vu.createBuffer(i.length/3);vc(c.position.typedBuffer,i,c.position.typedBufferStride,3),lE(o.meta,s,c.componentIndex,r);const d=h.writerSettings,u=await this._updatingHandles.addPromise(this._extractEdges(d,c,!0,!1,r));if(null==t.loaded)return 0;const p=this._createRenderable(u,o,e,h.key,!0);return t.renderables.push(p),h.addRenderable(p),p.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(e,t,i,r,s){const a=new Map;let n=0,o=null,l=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t];if(!i.material.supportsEdges)continue;!o&&i.localOrigin&&(o=i);const r=i.vertexAttributes.get(Gs.POSITION);l+=r.data.length/r.size,n+=i.edgeIndicesLength}const h=l>=65536?Uint32Array:Uint16Array,c=n?new h(n):null,d=[];let u=0;for(let t=0;t<e.geometries.length;t++){const i=e.geometries[t];if(!i.material.supportsEdges)continue;const r=i.vertexAttributes.get(Gs.POSITION),s=i.indices.get(Gs.POSITION);let n=a.get(r.data);if(null==n){n=d.length/3;for(let e=0;e<r.data.length;e+=r.size)d.push(r.data[e]),d.push(r.data[e+1]),d.push(r.data[e+2]);a.set(r.data,n)}if(s)for(let e=0;e<i.edgeIndicesLength;e++)c[u++]=n+s[e]}const p=o||e.geometries[0],m=is(),_=this._computeModelTransformWithLocalOrigin(e,p,m);for(let t=0;t<e.geometries.length;t++)e.geometries[t].localOrigin=_.origin;const g=new vE({data:d,size:3},c,m,_);await this._updatingHandles.addPromise(this._addPositionData(t,g,c.length,i[0],r,s))}_acquireRenderer(e,t,i){const r=XO.getKey(e,t,i);let s=this._renderers.get(r);return M(this._strokesTexture)&&(this._strokesTexture=function(e){const t=256,i=new Uint8Array(262144),r=1024,s=Math.log2(t)+1,a=iE.length;let n=(s-1)*a*r;for(const{distance:e,pressure:t}of iE){let o=e,l=t,h=n;for(let e=0;e<s;e++){0!==e&&(o=ZO(o,KO.DISTANCE),l=ZO(l,KO.PRESSURE));for(let e=0;e<256;e++){const t=.5+(o?o[e%o.length]/16:0),r=l?l[e%l.length]:1;eu(t,i,h),eu(r,i,h+131072),h+=4}h-=r*(a+1)}n+=r}const o=new Zn(e,{pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:_a.LINEAR,width:t,height:t,wrapMode:ma.REPEAT},i);return new tE(t,16,8,a,o)}(this.rctx)),s||(s=new XO(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this._strokesTexture,legacy:i,spherical:this.viewingMode===Ui.Global}),this._renderers.set(r,s)),++s.refCount,s}_removeRenderable(e){cE(e.regular),cE(e.silhouette);const t=this._renderers.get(e.rendererKey);if(t){t.removeRenderable(e),--t.refCount,"origin"in e.transform&&this._localOrigins.release(e.transform.origin),this._gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const t of e.components.meta)e.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,r=ve(),s=e=>{Re(r,e.center,t);const s=xe(r,i),a=e.radius,n=s<-a?1/0:s<a?0:s-a;e.renderables.forEach((e=>e.distanceToCamera=n))};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(e,t,i){const r=e.bindRegularEdges(i,t),s=i.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((s=>{if(!gE(s)||!s.visible)return;const n=yE(s.regular.lod.lengths,s.distanceToCamera,a);e.renderRegularEdges(r,s,i,t,n)}),s)}_renderSilhouetteEdges(e,t,i){const r=e.bindSilhouetteEdges(i,t),s=i.transparency,a=t.camera.perScreenPixelRatio;e.forEachRenderable((s=>{if(!fE(s)||!s.visible)return;const n=yE(s.silhouette.lod.lengths,s.distanceToCamera,a);e.renderSilhouetteEdges(r,s,i,t,n)}),s)}get test(){return{hasRenderedPrimitives:e=>{let t=!1;const i=e.perScreenPixelRatio,r=(e,r)=>e.forEachRenderable((e=>{e.visible&&!t&&(gE(e)&&(t=yE(e.regular.lod.lengths,e.distanceToCamera,i)>0),!t&&fE(e)&&(t=yE(e.silhouette.lod.lengths,e.distanceToCamera,i)>0))}),r);return this._renderers.forEach((e=>{t||(r(e,Du.OPAQUE),r(e,Du.TRANSPARENT))})),t}}}};function cE(e){A(e)&&(e.vao.vertexBuffers.instances.dispose(),e.vao.dispose(!1),e.vao=null)}e([ce({constructOnly:!0})],hE.prototype,"rctx",void 0),e([ce({constructOnly:!0})],hE.prototype,"renderSR",void 0),e([ce({constructOnly:!0})],hE.prototype,"viewingMode",void 0),e([ce({constructOnly:!0})],hE.prototype,"techniqueRepository",void 0),e([ce({constructOnly:!0})],hE.prototype,"setNeedsRender",void 0),e([ce({constructOnly:!0})],hE.prototype,"schedule",void 0),e([ce({readOnly:!0})],hE.prototype,"_updatingHandles",void 0),e([ce({readOnly:!0})],hE.prototype,"updating",null),hE=e([ue("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],hE);class dE{constructor(e,t,i){this.center=t,this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then((()=>{null!=this.loaded&&(this.loaded=!0)}))}}class uE{constructor(e,t){this.buffer=e,this.meta=t}}class pE{constructor(e,t){this.vao=e,this.lod=t}}class mE{constructor(e,t){this.modelMatrix=e,this.origin=t}}class _E{constructor(e,t,i,r,s,a,n,o){this.regular=e,this.silhouette=t,this.statistics=i,this.transform=r,this.edgeTransparency=s,this.objectTransparency=a,this.components=n,this.rendererKey=o,this.distanceToCamera=0,this.visible=!0}}function gE(e){return A(e.regular)}function fE(e){return A(e.silhouette)}function yE(e,t,i){const r=t*i,s=S(e,r,!0);return-1===s?r<e[0]?e.length:0:e.length-s}class vE{constructor(e,t,i,r){this.position=e,this.indices=t,this.modelTransform=i,this.origin=r}}const bE=Za();class xE{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach((e=>{const t=this._timer.createQuery(),i=this._timer.createQuery();this._queryPool.push(t,i),this._queryResults.set(e,null)}))}start(){Nu||(this._currentQuery=this._queryPool.pop(),M(this._currentQuery)||(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||M(this._currentQuery)||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(M(t))return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){A(this._currentQuery)&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){A(this._currentQuery)&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach((e=>{this._timer.deleteQuery(e)})),this._queryResults.forEach((e=>{M(e)||this._timer.deleteQuery(e)}))}}var TE;!function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.LINEAR_DEPTH="linear depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.NORMALS="normals",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.SSAO="SSAO",e.OPAQUE="opaque",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.ENVIRONMENT="environment",e.LASER_LINE="laser line",e.OCCLUDED="occluded",e.ANTIALIASING="antialiasing",e.HIGHLIGHTS="highlights",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish"}(TE||(TE={}));const wE="Total";class CE{constructor(e){this._rctx=e,this._startTimeStampCPU=K(0),this._lastTimeStampCPU=K(0),this._totalCPUTime=new te(wE),this._cpuTimeSamplers=new Map(Object.values(TE).map((e=>[e,new te(e)]))),this._enableGPUTimer=0,this._totalGPUTime=new te("GPU"),this._gpuTimeSamplers=new Map(Object.values(TE).map((e=>[e,new te(e)]))),this._totalTime=K(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return A(this._gpuTimerPool)}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return K(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(M(this._gpuTimerPool)){const e=[...Object.values(TE),wE];this._gpuTimerPool=function(e,t){const i=e.capabilities.disjointTimerQuery;return M(i)?null:new xE(i,t)}(this._rctx,e)}return M(this._gpuTimerPool)?{hasGPUTimerSupport:!1,remove:()=>{}}:(++this._enableGPUTimer,{hasGPUTimerSupport:!0,remove:Lu((()=>{--this._enableGPUTimer,0===this._enableGPUTimer&&(this._gpuTimerPool=F(this._gpuTimerPool))}))})}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=K(performance.now()),A(this._gpuTimerPool)&&this._gpuTimerPool.start()}advance(e){const t=K(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,A(this._gpuTimerPool)){const t=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(t),this._gpuTimerPool.start()}}finishFrame(){if(A(this._gpuTimerPool)){const e=this._gpuTimerPool.stop(TE.FINISH);this._gpuTimeSamplers.get(TE.FINISH).record(e)}const e=K(performance.now()-this._startTimeStampCPU);this._totalTime=K(this._totalTime+e),this._totalCPUTime.record(e),A(this._gpuTimerPool)&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce(((e,t)=>e+(t.last||0)),0)),++this._totalFrameCount}}let SE=class extends Hi{get _bindParameters(){return this._renderContext.bindParameters}isFeatureEnabled(e,t=this._state){return j(this._renderStateFeatures.get(t,e),!1)}setFeatureEnabled(e,t,i){this._renderStateFeatures.set(t,e,i),this.notifyChange("_renderStateFeatures"),this._requestRender()}get _antialiasing(){return this._antialiasingEnabled||this.isFeatureEnabled(Xt.Antialiasing)}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Xt.HighQualityTransparency)}get hasWaterReflection(){return this.hasWater&&(this._waterReflectionEnabled||this.isFeatureEnabled(Xt.WaterReflection))}get hasWater(){return this._hasWater||this._hasOverlayWater}constructor(e,t,i,r,s,a,n,o){super({}),this._stage=e,this._materialRepository=t,this._shaderTechniqueRepository=r,this._rctx=s,this._compositingHelper=a,this._magnifierHelper=n,this._requestRender=o,this._materialRenderers=new J,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._renderOverlay=e=>{},this._isRendering=!1,this._fallbackDepthStencilTexture=null,this._sliceHelper=new gO,this._state=zn.IDLE,this._renderStateFeatures=di(),this._antialiasingEnabled=!0,this._highQualityTransparencyEnabled=!0,this._terrainRenderingEnabled=!0,this._terrainTransparency=NC.Opaque,this._waterReflectionEnabled=!1,this._ssaoEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new gR,this._handles=new R,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new PO(this._rctx,r),o(),this._offscreen=new jR(this._rctx,this._compositingHelper),this.performanceInfo=new CE(this._rctx),this._shadowMap=new En(this._rctx,e.viewingMode),this._ssaoHelper=new Ro(e.view,r,this._rctx,o),this._highlight=new LR(r,this._rctx),this._shadowHighlight=new pO(this._rctx,e.viewingMode),this._shadowAccumulator=new iO(this._rctx,r,e,(e=>{const t=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(e.camera,e.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=t}),((e,t,i)=>{e.shadowMap.start(e.camera,t,i),this._renderShadowCascades(_o.Shadow,e.shadowMap),e.camera.setGLViewport(this._rctx),this._prepare(e.camera,e.contentCamera)}),o),this._renderContext=new Mn(this._rctx,this._offscreen,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new zR({renderContext:this._renderContext,techniqueRepository:r,textureRepository:i,materialRepository:this._materialRepository,requestRender:o,controller:e}),this.renderPassManager=new uR(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([G((()=>this._stage.view.state.camera),(()=>o()),B),G((()=>La.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES),(e=>{this._renderHiddenTransparentEdges=e?()=>this._renderEdges(Du.TRANSPARENT):()=>{},o()}),H),G((()=>this._ssaoEnabled||this.isFeatureEnabled(Xt.SSAO)),(e=>this._ssaoHelper.enabled=e),B)])}normalizeCtorArgs(){return{}}destroy(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=D(this._gpuTimerHandle),this._materialRenderers.forAll((e=>e.dispose())),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=F(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=I(this._edgeView),so.prune()}disposeOffscreenBuffers(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing&&this._smaaPass.updating||A(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return M(this._edgeView)&&(this._edgeView=new hE({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.view.resourceController.immediate.schedule(e)}),this._handles.add(G((()=>V(this._edgeView,(e=>e.updating))),(()=>this._requestRender()),$)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return ts(this._bindParameters.ssr.reprojectionMatrix,ss)}set _reprojectionMatrix(e){P(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(e){const{_shadowMap:t,_bindParameters:i}=this;if(void 0!==e.screenSpaceReflectionsEnabled&&i.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(i.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),void 0!==e.shadowMap&&this._shadowMap.enabled!==e.shadowMap&&(this._shadowMap.enabled=e.shadowMap,this._requestRender()),void 0!==e.shadowMapMaxCascades&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),A(e.environment)){A(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=!!e.weatherVisible),void 0!==e.environment.lighting.ambientOcclusionEnabled&&this._ssaoEnabled!==e.environment.lighting.ambientOcclusionEnabled&&(this._ssaoEnabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),void 0!==e.environment.lighting.waterReflectionEnabled&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());const t="virtual"!==e.environment.lighting.type;i.enableFillLights!==t&&(i.enableFillLights=t,this._requestRender())}e.background&&this._offscreen.background!==e.background&&(this._offscreen.background=e.background,this._requestRender()),void 0!==e.antialiasingEnabled&&this._antialiasingEnabled!==e.antialiasingEnabled&&(this._antialiasingEnabled=e.antialiasingEnabled,this._requestRender()),void 0!==e.highQualityTransparency&&this._highQualityTransparencyEnabled!==e.highQualityTransparency&&(this._highQualityTransparencyEnabled=e.highQualityTransparency,this._requestRender()),void 0!==e.defaultHighlightOptions&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),void 0!==e.overlays&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),void 0!==e.hasOverlayWater&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),void 0!==e.renderOverlay&&this._renderOverlay!==e.renderOverlay&&(this._renderOverlay=e.renderOverlay,this._requestRender()),void 0!==e.slicePlane&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=k(e.slicePlane),this._requestRender()),void 0!==e.terrainRenderingEnabled&&this._terrainRenderingEnabled!==e.terrainRenderingEnabled&&(this._terrainRenderingEnabled=e.terrainRenderingEnabled,this._requestRender()),void 0!==e.terrainTransparency&&this._terrainTransparency!==e.terrainTransparency&&(this._terrainTransparency=e.terrainTransparency,this._requestRender()),void 0!==e.shadowCastOptions&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(e,t){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:i,removes:r,updates:s}=e;if(0===i.length&&0===r.length&&0===s.length)return;const a=Dn(e);let n=!1;a.forEach(((i,r)=>{if(t.done)return;let s=this._materialRenderers.find((e=>e.material===r));M(s)&&i.adds.length>0&&(s=new In(this._rctx,this._materialRepository,r),this._materialRenderers.push(s)),s&&(s.modify(i),s.isEmpty&&(n=!0)),i.removes.forEach((t=>e.removes.removeUnordered(t))),i.adds.forEach((t=>e.adds.removeUnordered(t))),i.updates.forEach((t=>e.updates.removeUnordered(t))),t.madeProgress()})),n&&this._materialRenderers.filterInPlace((e=>!e.isEmpty||(e.dispose(),!1))),this._hasHighlights=this._materialRenderers.some((e=>e.hasHighlights)),this._bindParameters.hasOccludees=this._materialRenderers.some((e=>e.hasOccludees)),this._hasWater=this._materialRenderers.some((e=>e.hasWater)),this._hasHUDElements=this._materialRenderers.some((e=>e.requiresSlot(go.LINE_CALLOUTS_HUD_DEPTH,_o.Color)||e.requiresSlot(go.HUD_MATERIAL,_o.Color)||e.requiresSlot(go.LABEL_MATERIAL,_o.Color))),this._requestRender()}updateAnimation(e){const t=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll((t=>this._hasAnimations=t.updateAnimation(e)||this._hasAnimations)),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations!==t&&(this._gpuTimerHandle=t?D(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}render(e,t,i,r,s){this._isRendering=!0,this.performanceInfo.startFrame();const{camera:a,contentCamera:n,mode:o}=i;this._state=o,this._renderOverlay(s),this.performanceInfo.advance(TE.OVERLAY),this._renderContext.time=s,this._bindParameters.transparencyPassType=lu.NONE;const l=this._offscreen;l.setupRenderTarget(this.hasWaterReflection);const h=Rt(this._sliceHelper.plane);r===Oc.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),a.setGLViewport(this._rctx),this._prepare(a,n),this._renderPlugins.prepareRender(),this.performanceInfo.advance(TE.PREPARE);const c=this._computeDepthRange(a);this._renderShadowMap(e,a,this._bindParameters.lighting.mainLight.direction,c),this.performanceInfo.advance(TE.SHADOW_MAP),l.initializeFrame(a),this._ensureBindParameters(a,n),this._renderLinearDepth(),this.performanceInfo.advance(TE.LINEAR_DEPTH),this._accumulateShadows(c,a,n),this.performanceInfo.advance(TE.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(TE.NORMALS),this._ensureBindParametersSSR(s),this._renderSSAO(s),this.performanceInfo.advance(TE.SSAO),this._renderContext.output=_o.Color,l.bindFramebuffer();const d=this._terrainRenderingEnabled&&(this._terrainTransparency===NC.Semitransparent||this._terrainTransparency===NC.TransparentWithDraped),u=this._highQualityTransparency&&d;this._prepareOpaqueGeometrySlots(),this._setMultipassTerrain(u),this._prepareSlots(go.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),u||this._prepareInternalSlots(this._materialRenderers,go.LINE_CALLOUTS),this._renderOpaqueGeometry(),this.performanceInfo.advance(TE.OPAQUE),this._renderTerrainLinearDepth(u),this._setMultipassTerrain(u),this._renderEdges(Du.OPAQUE),this.performanceInfo.advance(TE.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(go.VOXEL),this.performanceInfo.advance(TE.VOXEL),this._renderHiddenTransparentEdges();const p=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;p&&(this._oitEnabled?this._renderOrderIndependentTransparency(PE.Geometry):this._renderTransparentGeometry()),this.performanceInfo.advance(TE.TRANSPARENT),this._renderGeometryLinearDepth(u);const m=this._renderHUDVisibility(u);u||this._renderInternalSlot(go.LINE_CALLOUTS),this.performanceInfo.advance(TE.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(t),this.performanceInfo.advance(TE.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(Du.TRANSPARENT,u),this.performanceInfo.advance(TE.TRANSPARENT_EDGES),this._renderTransparentTerrain(),d&&m&&(u?this._renderLineCallouts(co.Occluded):l.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(co.Occluded,l.framebuffer),this.performanceInfo.advance(TE.HUD_OCCLUDED)),this.performanceInfo.advance(TE.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),d&&(l.compositeTransparentTerrainOntoMain(this._bindParameters),u&&(this._renderEdges(Du.OPAQUE),this.performanceInfo.advance(TE.OPAQUE_EDGES),p&&(this._oitEnabled?this._renderOrderIndependentTransparency(PE.Geometry):this._renderTransparentGeometry()),this.performanceInfo.advance(TE.TRANSPARENT),this._renderEdges(Du.TRANSPARENT),this.performanceInfo.advance(TE.TRANSPARENT_EDGES))),u&&this._renderLineCallouts(co.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),l.renderToTargets((()=>{this._prepareInternalSlots(this._materialRenderers,go.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._prepareSlots(go.POSTPROCESSING_ENVIRONMENT_TRANSPARENT,go.LASERLINES),this._renderInternalSlot(go.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(go.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(go.LASERLINES)}),l.currentColorTarget,l.mainDepth),this.performanceInfo.advance(TE.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&l.renderTmpAndCompositeToMain((()=>this._renderSlot(go.LASERLINES_CONTRAST_CONTROL)),this._bindParameters,MP.PremultipliedAlpha),this.performanceInfo.advance(TE.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(TE.OCCLUDED);const _=r===Oc.ON&&this._magnifierHelper.enabled,g=_&&M(e)?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):e;this._rctx.bindFramebuffer(g);const f=this._offscreen.colorTexture;!this._renderAntiAliasing(f)&&A(f)&&this._compositingHelper.composite(this._bindParameters,f,MP.None),this.performanceInfo.advance(TE.ANTIALIASING),this._renderHUD(co.NotOccluded,g),this.performanceInfo.advance(TE.HUD),this._renderHighlights(g,this._bindParameters),this.performanceInfo.advance(TE.HIGHLIGHTS),_&&this._magnifierHelper.render(this._rctx,this._bindParameters),g!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,MP.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=h,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}_renderObjectAndLayerIdColor(e){if(A(e)&&b("enable-feature:objectAndLayerId-rendering")){const t=this._renderContext.output;this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((()=>this._renderGeometryAndTransparentTerrainPass(_o.ObjectAndLayerIdColor)),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(e),this._offscreen.renderToFBO((()=>{this._bindParameters.renderTransparentlyOccludedHUD=co.NotOccluded,this._renderInternalSlot(go.HUD_MATERIAL)}),void 0,!0,!0),this._renderContext.output=t}}finish(e){this._hasAnimations||this._animationTimestep.clear();const t=this.performanceInfo.gpuSamplingEnabled,i=e===wc.BACKGROUND;if(i||t){const e=i?this.performanceInfo.elapsedTime:0,r=t?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),s=Math.max(e,r);this._animationTimestep.frame(s,i)}}readDepthPixels(e,t,i){const r=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const t=ya.COLOR_BUFFER_BIT|ya.DEPTH_BUFFER_BIT|ya.STENCIL_BUFFER_BIT;this._rctx.clearSafe(t),this._renderGeometryAndTransparentTerrainPass(_o.Depth)}r.readPixels(t[0],t[1],t[2],t[3],ua.RGBA,pa.UNSIGNED_BYTE,i)}readHUDVisibility(e,t,i,r,s){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(e,t,i,r,ua.RGBA,pa.UNSIGNED_BYTE,s)}readAccumulatedShadow(e){return this._shadowAccumulator.readAccumulatedShadow(e[0],e[1])}_setMultipassTerrain(e){this._setMultipassEnabled(e),this._setTerrainCulling(e)}_setMultipassEnabled(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_prepareSlots(...e){this._renderPlugins.prepareSlots(e)}_renderSlot(e){this._bindParameters.slot=e,this._renderPlugins.render()}_renderEdges(e,t=!1){const i=this._edgeView;A(i)&&i.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain((()=>i.render(this._bindParameters,e)),this._bindParameters,MP.Alpha,t)}_renderShadowMap(e,t,i,r){const s=this._shadowMap;s.enabled&&this.isFeatureEnabled(Xt.ShadowMapUpdate)&&(s.start(t,i,r),this._shadowHighlight.updateParameters(t,i),this._needsShadowHighlight?(this._renderShadowCascades(_o.ShadowHighlight,this._shadowMap,(e=>s.takeCascadeSnapshotTo(e,An.Highlight))),s.clear(),this._renderShadowCascades(_o.ShadowExcludeHighlight,this._shadowMap,(e=>{s.takeCascadeSnapshotTo(e,An.Default),this._renderGeometryAndTransparentTerrainPass(_o.ShadowHighlight)}))):this._renderShadowCascades(_o.Shadow),s.finish(e),t.setGLViewport(this._rctx))}_renderShadowCascades(e,t=this._shadowMap,i=(e=>{})){for(const r of t.cascades)r.camera.setGLViewport(this._rctx),this._prepare(r.camera,r.camera),this._renderGeometryAndTransparentTerrainPass(e),i(r)}get _needsLinearDepth(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasWaterReflection||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreen.renderToTargets((()=>this._renderGeometryAndTransparentTerrainPass(_o.Depth)),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture}_renderTerrainLinearDepth(e){if(e){const e=this._renderContext.output;this._renderContext.output=_o.Depth,this._offscreen.renderToTargets((()=>this._renderTransparentTerrain()),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture}_renderGeometryLinearDepth(e){if(e){const e=this._renderContext.output;this._offscreen.renderToTargets((()=>this._renderGeometryPass(_o.Depth)),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture}get _needsNormal(){return this._ssaoHelper.active}_renderNormal(){this._needsNormal?this._offscreen.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(_o.Normal)}),this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(e){if(!this._needsDepthRange)return bS;const t=function(e,t,i){let r=0;if(!t.some((e=>(r+=e.numGeometries,r>=1e4))))return eR.compute(e,t);const s=gS();return i.forAll((t=>{t.visible&&yS(s,function(e,t){if(!t.visible)return;const i=gS(),r=t.getSpatialQueryAccelerator();return A(r)?function(e,t,i){const r=t.eye,s=t.viewForward,a=t.frustum,n=e=>e.visible,o=i.objectCount;if(o<500)fS(KP,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,Pu.DepthOrder.FRONT_TO_BACK,KP,((i,r)=>{WP(e,t,i),KP.far=e.near,r.setRange(KP)}),a,n),fS(KP,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,Pu.DepthOrder.BACK_TO_FRONT,KP,((i,r)=>{WP(e,t,i),KP.near=e.far,r.setRange(KP)}),a,n);else{const r=Math.max(Math.min(o,500),Math.ceil(.1*o)),l=i.findClosest(s,Pu.DepthOrder.FRONT_TO_BACK,a,n,r),h=i.findClosest(s,Pu.DepthOrder.BACK_TO_FRONT,a,n,r);l&&h&&(QP(e,t,l.boundingVolumeWorldSpace.bounds),QP(e,t,h.boundingVolumeWorldSpace.bounds))}}(i,e,r):function(e,t,i){JP.clear(),i.forAll((e=>{e.visible&&0!==e.geometries.length&&JP.add(e)})),JP.empty||(JP.sort(t),fS(KP,t.near,Math.min(e.near,t.far)),JP.forEachInDepthRange(KP,Pu.DepthOrder.FRONT_TO_BACK,((i,r)=>{r<e.near&&WP(e,t,i)})),fS(KP,Math.max(e.far,t.near),t.far),JP.forEachInDepthRange(KP,Pu.DepthOrder.BACK_TO_FRONT,((t,i,r)=>{e.far=Math.max(e.far,r)})))}(i,e,t.objects),i}(e,t))})),s}(e,this._materialRenderers,this._stage.layers);return yS(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderGeometryAndTransparentTerrainPass(e){this._renderContext.output=e,this._prepareSlots(go.TRANSPARENT_TERRAIN),this._renderGeometryPass(e),this._renderTransparentTerrain()}_renderGeometryPass(e){this._renderContext.output=e,this._prepareSlots(go.TRANSPARENT_MATERIAL),this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderSSAO(e){this._ssaoHelper.render(this._bindParameters,e,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)}_prepareOpaqueGeometrySlots(){this._prepareSlots(go.INTEGRATED_MESH,go.OPAQUE_TERRAIN,go.OPAQUE_MATERIAL,go.POSTPROCESSING_ENVIRONMENT_OPAQUE),this._prepareInternalSlots(this._materialRenderers,go.OPAQUE_MATERIAL)}_renderOpaqueGeometry(){this._renderSlot(go.INTEGRATED_MESH),this._renderSlot(go.OPAQUE_TERRAIN),this._renderInternalSlot(go.OPAQUE_MATERIAL),this._renderSlot(go.OPAQUE_MATERIAL),this._renderSlot(go.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(go.TRANSPARENT_MATERIAL),this._renderSlot(go.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(go.TRANSPARENT_TERRAIN)}_renderHUDVisibility(e){let t=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility((()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,t=this._renderInternalSlot(go.OCCLUSION_PIXELS)}),e),t}_renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===co.Occluded?this._offscreen.renderToTargets((()=>this._renderInternalSlot(go.LINE_CALLOUTS)),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(go.LINE_CALLOUTS)}_renderHUD(e,t){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(PE.HUD,e),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,MP.PremultipliedAlpha)):e===co.Occluded?this._offscreen.renderToTargets((()=>this._renderHUDElements(co.Occluded)),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}_renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._prepareInternalSlots(this._materialRenderers,go.LINE_CALLOUTS_HUD_DEPTH,go.HUD_MATERIAL,go.LABEL_MATERIAL),this._renderInternalSlot(go.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(go.HUD_MATERIAL),this._renderInternalSlot(go.LABEL_MATERIAL)}get _needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}_renderHighlights(e,t){if(!this._needsHighlight)return void this._offscreen.disposeTarget(this._offscreen.highlight);const i=this._highlight,r=this._offscreen.renderToTargets((()=>{this._renderGeometryAndTransparentTerrainPass(_o.Highlight),this._rctx.clearSafe(ya.DEPTH_BUFFER_BIT),this._renderHUDElements(co.Both)}),this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=r.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(t,e),i.render(this._bindParameters,r,e)}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(e,t,i){this._needsShadowCast&&A(this._offscreen.linearDepthTexture)&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,e,t,i)}_renderOrderIndependentTransparency(e,t=co.Both){const i=e===PE.HUD,r=i?()=>this._renderHUDElements(t):()=>this._renderTransparentGeometry(),s=e=>{this._bindParameters.transparencyPassType=e,this._offscreen.renderOITPass((()=>r()),e,i)},a=this._renderContext.output;i||(this._renderContext.output=_o.Alpha,this._bindParameters.transparencyPassType=lu.Alpha,this._prepareSlots(go.TRANSPARENT_MATERIAL),this._renderContext.output=_o.Color,this._bindParameters.transparencyPassType=lu.Color,this._prepareSlots(go.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=lu.FrontFace,this._prepareSlots(go.TRANSPARENT_MATERIAL)),this._renderContext.output=_o.Alpha,s(lu.Alpha),this._renderContext.output=_o.Color,s(lu.Color),s(lu.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,i),this._bindParameters.transparencyPassType=lu.NONE,this._renderContext.output=a,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let e=0;OE.clear(),this._materialRenderers.forAll((t=>{t.material&&t.material.isVisible()&&t.material.renderOccluded===ia.OccludeAndTransparentStencil&&(e|=t.material.renderOccluded,OE.push(t))}));const t=this._offscreen,i=(i,r,s,a,n)=>{0!=(e&r)&&(t.renderToTargets(s,t.tmpColor,t.mainDepth,[0,0,0,0],a,n),t.compositeOccludedOntoMain(this._bindParameters,i))};0!==OE.length&&(this._prepareInternalSlots(OE,go.OCCLUDER_MATERIAL,go.TRANSPARENT_OCCLUDER_MATERIAL),this._renderInternalSlot(go.OCCLUDER_MATERIAL,OE),i(.5,ia.OccludeAndTransparentStencil,(()=>this._renderInternalSlot(go.TRANSPARENT_OCCLUDER_MATERIAL,OE)),!1,!1)),OE.clear(),this._materialRenderers.forAll((t=>{t.material&&t.material.isVisible()&&(t.material.renderOccluded===ia.OccludeAndTransparent||t.material.renderOccluded===ia.Transparent||t.material.renderOccluded===ia.Opaque)&&(e|=t.material.renderOccluded,OE.push(t))}));const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const s=e=>{this._renderContext.renderOccludedMask=e,this._prepareInternalSlots(OE,go.OPAQUE_MATERIAL,go.TRANSPARENT_MATERIAL,go.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),r>ia.Occlude&&this._renderSlot(go.OCCLUDED_TERRAIN),this._renderInternalSlot(go.OPAQUE_MATERIAL,OE),this._renderInternalSlot(go.TRANSPARENT_MATERIAL,OE),this._renderInternalSlot(go.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,OE),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=_o.Color,i(.5,ia.OccludeAndTransparent,(()=>s(ia.OccludeAndTransparent)),!0,Sc.OutlineVisualElementMask),i(.5,ia.Transparent,(()=>s(ia.Transparent)),!0,Sc.OutlineVisualElementMask),i(1,ia.Opaque,(()=>s(ia.Opaque)),!0,Sc.OutlineVisualElementMask),OE.clear()}_renderAntiAliasing(e){if(this._antialiasing){if(this._smaaPass.enable((()=>this._requestRender()))&&A(e))return this._smaaPass.render(e),!0}else this._smaaPass.disable();return!1}_prepare(e,t){this._needsTransparentPass=this._materialRenderers.some((e=>e.requiresSlot(go.TRANSPARENT_MATERIAL,_o.Color))),this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParameters(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t;const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.mainColorTexture=i.mainColorTexture,this._bindParameters.highlightDepthTexture=i.depthTexture??this._getFallbackDepthTexture()}_ensureBindParametersSSR(e){if(this._bindParameters.ssr.enabled=this.hasWaterReflection,this._bindParameters.ssr.enabled){M(this._waterReflectionEnableTime)&&(this._waterReflectionEnableTime=e),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=ss:(es(AE,this._bindParameters.camera.viewMatrix),es(EE,this._bindParameters.camera.projectionMatrix),$r(ME,AE,EE),$r(ME,this._renderContext.lastFrameCamera.viewMatrix,ME),$r(ME,this._renderContext.lastFrameCamera.projectionMatrix,ME),this._reprojectionMatrix=ME),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const t=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=t>0?Math.min(t,e-this._waterReflectionEnableTime)/t:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._bindParameters.ssr.lastFrameColorTexture=null,this._waterReflectionEnableTime=null}_prepareInternalSlots(e,...t){for(const i of t)this._bindParameters.slot=i,e.forAll((e=>{e.material.shouldRender(this._renderContext)&&e.prepareTechnique(this._renderContext)}))}_renderInternalSlot(e,t=this._materialRenderers){let i=!1;return this._bindParameters.slot=e,t.forAll((e=>{if(e.material.shouldRender(this._renderContext)){const t=e.prepareTechnique(this._renderContext);A(t)&&(e.render(this._renderContext,t),i=!0)}})),i}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=ka(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){return{offscreen:this._offscreen?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}get test(){const e=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{e._renderStateFeatures=di()},getFramebufferTexture:t=>{switch(t){case RE.Color:return e._offscreen.colorTexture;case RE.LinearDepth:return e._offscreen.linearDepthTexture;case RE.Normals:return e._offscreen.normalTexture;case RE.ShadowMap:return e._shadowMap.depthTexture;case RE.HudVisibility:return e._offscreen.hudVisibilityTexture;case RE.Highlight:return e._offscreen.highlightTexture}}}}};var PE,RE;e([ce()],SE.prototype,"_shadowAccumulator",void 0),e([ce()],SE.prototype,"_state",void 0),e([ce()],SE.prototype,"_renderStateFeatures",void 0),e([ce()],SE.prototype,"_antialiasingEnabled",void 0),e([ce({readOnly:!0})],SE.prototype,"_antialiasing",null),e([ce()],SE.prototype,"_ssaoEnabled",void 0),e([ce()],SE.prototype,"_smaaPass",void 0),e([ce({autoDestroy:!0})],SE.prototype,"_edgeView",void 0),e([ce()],SE.prototype,"updating",null),e([ce()],SE.prototype,"isCameraFinal",null),SE=e([ue("esri.views.3d.webgl-engine.lib.Renderer")],SE),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(PE||(PE={})),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(RE||(RE={}));const OE=new J,EE=is(),AE=is(),ME=is();class DE extends Fu{constructor(e,t,i){super(e,t),this.newCache=i,this._refCount=1}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}bindTechnique(e,t,i,r){return this.useProgram(e.program),e.bindPipelineState(this,i?.slot,!!r),e.program.bindPass(t,i),e.program}get test(){return this.programCache.test}}let IE=class extends Hi{constructor(e,t,i){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new mr,this._frameTask=e.view.resourceController.scheduler.registerTask(Vn.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(Ys.Texture,(e=>e.unload()))}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return M(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(Ln,new Nn)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),j(t.loadingPromise,t)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach((t=>{const i=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)})),e&&this.events.emit("changed",wc.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(M(t))return no(void 0!==t),null;const i=t.events.on("unloaded",(()=>{i.remove(),this._onTextureUnloaded(e)})),r=new LE(e,(()=>{this._frameTask.schedule((()=>{r.isUnreferenced&&t.unload()}))}));return this._textures.set(e,r),r.ref(),A(t.glTexture)?(this._updateGLTexture(r,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule((()=>{const i=t.load(this._rctx,(()=>this.textureTechnique)),s=i=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,i),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r);return g(i)?i.then(s,(e=>(this._loadingCount--,r.loadingPromise=null,d(e)||E.getLogger(this.declaredClass).error(e),null))):s(i)})),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",wc.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};e([ce()],IE.prototype,"_loadingCount",void 0),e([ce()],IE.prototype,"_frameTask",void 0),e([ce()],IE.prototype,"updating",null),IE=e([ue("esri.views.3d.webgl-engine.lib.TextureRepository")],IE);class LE{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return 0===this._refCount}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(0!==this._refCount?(E.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}let NE=class extends Hi{constructor(){super(...arguments),this._passParameters=new FE,this._loading=0}get passParameters(){return this._passParameters}destroy(){this._passParameters.waveNormal=F(this._passParameters.waveNormal),this._passParameters.wavePertubation=F(this._passParameters.wavePertubation)}get updating(){return this._loading>0}ensureResources(e){if(this._loading>0)return Ec.LOADING;if(A(this._passParameters.waveNormal)&&A(this._passParameters.wavePertubation))return Ec.LOADED;const t={target:da.TEXTURE_2D,pixelFormat:ua.RGBA,dataType:pa.UNSIGNED_BYTE,wrapMode:ma.REPEAT,samplingMode:_a.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8};return++this._loading,Ru(lo("esri/images/materials/water/normals.jpg")).then((i=>this._passParameters.waveNormal=new Zn(e,{...t,width:i.width,height:i.height},i))).catch((e=>E.getLogger(this.declaredClass).error("Failed to load water material normal texture.",e))).finally((()=>--this._loading)),++this._loading,Ru(lo("esri/images/materials/water/perturbation.jpg")).then((i=>this._passParameters.wavePertubation=new Zn(e,{...t,width:i.width,height:i.height},i))).catch((e=>E.getLogger(this.declaredClass).error("Failed to load water material pertubation texture.",e))).finally((()=>--this._loading)),Ec.LOADING}};e([ce()],NE.prototype,"_loading",void 0),e([ce({type:Boolean,readOnly:!0})],NE.prototype,"updating",null),NE=e([ue("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],NE);class FE extends Us{}class UE{constructor(e,t){this.viewCamera=e,this.frameHasDecorations=t}}class jE{constructor(e,t,i,r){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=i,this._disposeOffscreenBuffers=r,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(wc.BACKGROUND);const t=c();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const i of this._screenshotQueue){if(null==this._rctx){i.resolver.reject();continue}const r={...i.settings,pixelRatio:i.settings.pixelRatio*e.viewCamera.pixelRatio},s=this._renderScreenshot(e,r,t);i.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,i){e.width=t.width,e.height=t.height;const r=e.getContext("2d"),s=i.pixelRatio;return r.save(),r.translate(0,t.height),r.scale(1,-1),i.region&&r.translate(-i.region.x,-i.region.y),r.scale(s,s),t=this._renderFunctions.renderOverlay(e,t),r.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:i,framebufferHeight:r,region:s,resample:a}=e,n=this._ensureScreenshotEncodeCanvas();let o=ju(i,r,n);this._rctx.gl.readPixels(0,0,i,r,ua.RGBA,va.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),t(),o=this._renderScreenshotOverlay(n,o,{...e,region:void 0});const l=ju(s.width,s.height,n);return Ei(o,l,!0,a.region.x,r-(a.region.y+a.region.height),a.region.width,a.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:i,region:r}=e,s=this._ensureScreenshotEncodeCanvas(),a=ju(r.width,r.height,s);return this._rctx.gl.readPixels(r.x,i-(r.y+r.height),r.width,r.height,ua.RGBA,va.UNSIGNED_BYTE,new Uint8Array(a.data.buffer)),t(),this._renderScreenshotOverlay(s,a,e)}_renderScreenshot(e,t,i){let r=null,s=null;const a=e.viewCamera,{framebufferWidth:n,framebufferHeight:o}=t;let l=!1;const h=t.disableDecorations&&e.frameHasDecorations,c=n!==a.fullWidth||o!==a.fullHeight,d=t.ignorePadding&&a.pixelRatio!==t.pixelRatio,u=c||h||d||t.objectAndLayerIdColor;if(t.objectAndLayerIdColor&&(s=new hn(this._rctx,{width:n,height:o,colorTarget:ca.TEXTURE,depthStencilTarget:fa.DEPTH_STENCIL_RENDER_BUFFER})),u){const e=a.clone();if(t.ignorePadding){const i=vr(e.padding);for(let r=0;r<4;r++)i[r]=Math.round(i[r]/e.pixelRatio*t.pixelRatio);e.padding=i}e.fullWidth=n,e.fullHeight=o,e.pixelRatio=t.pixelRatio;const h=a.fovX-e.fovX,c=a.fovY-e.fovY;h<0&&h<c?e.fovX=a.fovX:c<0&&c<h&&(e.fovY=a.fovY),this._forceCameraHook(e),l=!0,r=new hn(this._rctx,{width:e.fullWidth,height:e.fullHeight,colorTarget:ca.TEXTURE,depthStencilTarget:fa.DEPTH_STENCIL_RENDER_BUFFER}),this._renderFunctions.renderScene(r,s,e,t.disableDecorations?Oc.OFF:Oc.ON,i),this._disposeOffscreenBuffers()}const p=()=>{this._rctx.bindFramebuffer(null),F(r)},m=this._readbackScreenshot(t,p);p();let _=null;if(t.objectAndLayerIdColor){const e=()=>{this._rctx.bindFramebuffer(null),F(s)};this._rctx.bindFramebuffer(s),_=this._readbackScreenshot(t,e),this._rctx.bindFramebuffer(null),e()}if(u&&!this._rctx.contextAttributes.alpha)for(let e=3;e<m.data.length;e+=4)m.data[e]=255;if(_&&!this._rctx.contextAttributes.alpha)for(let e=3;e<_.data.length;e+=4)_.data[e]=255;return l&&this._forceCameraHook(a),[m,_]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}let VE=class extends Hi{constructor(e){super({}),this.events=new mr,this.waterTextureRepository=new NE,this._magnifierHelper=new oR,this.objectAndLayerIdRenderHelper=b("enable-feature:objectAndLayerId-rendering")?new lR:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode,this._initializeContext(e),this.addHandles([G((()=>this.waterTextureRepository?.updating),(()=>this.requestRender()),H),this._magnifierHelper.events.on("request-render",(()=>this.requestRender()))]),this._stippleTextureRepository=new Uu(this._rctx),this._shaderTechniqueRepository=new Fn({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new IE(e,this._shaderTechniqueRepository,this._rctx),this.addHandles(this._textureRepository.events.on("changed",(e=>this.requestRender(e)))),this._materialRepository=new Un(this._textureRepository,this._shaderTechniqueRepository,(()=>this.requestRender()),(()=>this.requestRender())),this._compositingHelper=new GP(this._rctx,this._shaderTechniqueRepository),this.renderer=new SE(e,this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,(e=>this.requestRender(e)));const t={renderScene:(e,t,i,r,s)=>this.renderer.render(e,t,{camera:i,contentCamera:i,mode:zn.IDLE},r,s),requestRenderScene:e=>this.requestRender(e),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(t,i)=>e.options.screenshot.renderOverlay(t,i)};this._screenshotManager=new jE(this._rctx,t,(e=>this.events.emit("force-camera-for-screenshot",e)),(()=>this.renderer.disposeOffscreenBuffers())),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=D(this._frameTask),this._shaderTechniqueRepository=I(this._shaderTechniqueRepository)}get performanceInfo(){const e=this._rctx.gl;return{renderer:this.renderer.performanceInfo,textureMemory:void 0!==e.getUsedTextureMemory?e.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==e.getUsedRenderbufferMemory?e.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==e.getUsedVBOMemory?e.getUsedVBOMemory():void 0}}requestRender(e=wc.UPDATE){this._needsRender=!0,e===wc.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then((e=>e[0]))}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,r,s,a=s){const n=r.constrainWindowSize(t,i,s*r.pixelRatio,a*r.pixelRatio),o=this._ensureDepthBuffer(n);this.renderer.readDepthPixels(r,n,o);let l=Number.MAX_VALUE;for(let e=0;e<n[2]*n[3];e++){const t=BP(4*e,o,r.nearFar);l>t&&t!==r.nearFar[0]&&t!==r.nearFar[1]&&(l=t)}if(A(e)){const s=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);A(s)&&l>s&&s!==r.nearFar[0]&&s!==r.nearFar[1]&&(l=s)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(M(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){nx(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let i=!1,r=wc.BACKGROUND,s=!1;const a={preRender:({time:s})=>{i=this.updating,r=this._needsUpdate?wc.UPDATE:wc.BACKGROUND,e.commitSyncLayers();const a=K(s-this._lastAnimationUpdate);if(a>this.renderer.animationTimestep||A(t.forcedAnimationTime)||i||this._needsRender){const e=K(a/this.renderer.animationTimeDilation),i=new Js(t.camera,e,t.forcedAnimationTime);this.renderer.updateAnimation(i)&&this.requestRender(wc.BACKGROUND),this._lastAnimationUpdate=s}},render:({time:e})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const i=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(null,null,t,Oc.ON,e),s=!0,i&&this.renderer.hasWaterReflection&&(this.requestRender(wc.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:e})=>{const i=new UE(t.camera,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update(),this._screenshotManager.update(i,e)},finish:()=>{s&&(this.renderer.finish(t.mode===zn.IDLE?r:wc.UPDATE),s=!1)}};this._frameTask=ee(a)}_initializeContext(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},r=Vd("3d",this._canvas,i);if(M(r)){const e=b("esri-force-webgl");E.getLogger(this.declaredClass).error(e)}else this._rctx=this._newRenderingContext(r,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&E.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&b("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8};return new DE(e,i,((e,i)=>t.view.resourceController.memoryController.newCache(e,i)))}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(e){return A(this.objectAndLayerIdRenderHelper)?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}get componentObjectCollection(){return M(this._componentObjectCollection)&&(this._componentObjectCollection=new wP(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};e([ce({type:Boolean,readOnly:!0})],VE.prototype,"updating",null),e([ce({autoDestroy:!0})],VE.prototype,"_rctx",void 0),e([ce({autoDestroy:!0})],VE.prototype,"_container",void 0),e([ce({autoDestroy:!0})],VE.prototype,"_canvas",void 0),e([ce({autoDestroy:!0})],VE.prototype,"_stippleTextureRepository",void 0),e([ce({autoDestroy:!0})],VE.prototype,"waterTextureRepository",void 0),e([ce({autoDestroy:!0})],VE.prototype,"_magnifierHelper",void 0),e([ce({readOnly:!0})],VE.prototype,"objectAndLayerIdRenderHelper",void 0),e([ce({autoDestroy:!0})],VE.prototype,"_textureRepository",void 0),e([ce({autoDestroy:!0})],VE.prototype,"_compositingHelper",void 0),e([ce({autoDestroy:!0,readOnly:!0})],VE.prototype,"renderer",void 0),e([ce({autoDestroy:!0})],VE.prototype,"_screenshotManager",void 0),e([ce()],VE.prototype,"componentObjectCollection",null),e([ce({autoDestroy:!0})],VE.prototype,"_componentObjectCollection",void 0),e([ce()],VE.prototype,"_needsUpdate",void 0),e([ce()],VE.prototype,"_needsWaterReflectionUpdate",void 0),VE=e([ue("esri.views.3d.webgl-engine.parts.RenderView")],VE);let kE=class extends Hi{constructor(e){super(e),this._handles=new R,this._model=new sS,this._layers=new J,this._asyncChangeSet=new jn,this._syncChangeSet=new jn,this._layerSyncSet=new Set}initialize(){this._set("renderView",new VE(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(Vn.STAGE,this),this._handles.add(this._frameTask)}destroy(){this._handles.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){return this.renderView?.renderer}add(e){this._model.add(e),oh(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}remove(e){M(e)||(this.renderView.requestRender(),this._model.remove(e),oh(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){A(e)&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){A(e)&&(this._model.removeMany(e),this.renderView.requestRender())}async load(e,t){M(e)||(Array.isArray(e)||(e=[e]),await Promise.all(e.filter((e=>M(e.glTexture))).map((e=>this.schedule((()=>this._model.has(e)?e.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique)):null))),t)))}loadImmediate(e){return e.load(this.renderView.renderingContext,(()=>this.renderView.textureRepository.textureTechnique))}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){this._frameTask.processQueue(e),this._commit(e)}_commit(e){const t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{if(e.done)return;const r=this._layerSyncSet.has(i.id)||i.updatePolicy===hh.SYNC,s=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,s),this._layerSyncSet.delete(i.id),s.empty||(this.renderer.modify(s,r?qn:e),this.renderView.requestRender(),e.madeProgress())})),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qn),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll((i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==hh.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))})),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll((t=>{(this._layerSyncSet.has(t.id)||t.updatePolicy===hh.SYNC)&&(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id))}));for(const t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qn),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,qn),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),null!=this._layers.removeUnordered(e)&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,qn))}addRenderPlugin(e,t,i){const r=this.renderer.renderPlugins.add(e,t,i),s=()=>{kv(t)&&this.view.sceneIntersectionHelper.addIntersectionHandler(t)};if(g(r))return r.then(s);s()}removeRenderPlugin(e){kv(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter((e=>e.type===t)).length,model:e._model}}};kE.DebugSettings={endFrameContentValidation:!1},e([ce({constructOnly:!0})],kE.prototype,"view",void 0),e([ce({constructOnly:!0})],kE.prototype,"options",void 0),e([ce({readOnly:!0})],kE.prototype,"viewingMode",null),e([ce({constructOnly:!0})],kE.prototype,"container",void 0),e([ce({constructOnly:!0})],kE.prototype,"_handles",void 0),e([ce({readOnly:!0})],kE.prototype,"updating",null),e([ce({constructOnly:!0})],kE.prototype,"_model",void 0),e([ce({autoDestroy:!0})],kE.prototype,"renderView",void 0),e([ce({readOnly:!0})],kE.prototype,"renderer",null),e([ce({readOnly:!0})],kE.prototype,"running",null),kE=e([ue("esri.views.3d.webgl-engine.Stage")],kE);let zE=class extends Wu{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};e([ce()],zE.prototype,"components",void 0),zE=e([ue("esri.views.ui.3d.DefaultUI3D")],zE);const qE=zE;let GE=class extends(mi(_i(Ai(Ht)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new bh({slicePlane:Dt},this),this._resourceController=new ub({view:this}),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new Ry({view:this}),this.labeler=new Jy({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new ui,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new up,this.environmentManager=new w_,this.floors=new s,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new ip({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Av,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new qE,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new Zv,this.voxelWasm=null,this.voxelWasmPromise=null,he(),e&&e.environment||(this._defaults.environment=new yp,this.environment=this._defaults.environment);const t=(e=null)=>{A(e)&&e.type===a.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this._updatingChanged()})))};this.handles.add([Q((()=>this.map?.allLayers),"after-changes",(e=>t(e)),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),G((()=>this.map),(e=>{e&&"load"in e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new Yf({view:this}),this.stateManager=new pi({view:this})}initialize(){this.groundView=new gi({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(Q((()=>this.map?.allLayers),"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add((()=>this.qualitySettings.memoryLimit),(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),H),this.updatingHandles.add((()=>this.qualitySettings.additionalCacheMemory),(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),H),this.updatingHandles.add((()=>this.qualitySettings.frameRate??0),(e=>ie(e>0?1e3/Math.ceil(e):0)),H),this.updatingHandles.add((()=>this.map?.ground),e,B),this.updatingHandles.add((()=>this.map?.ground?.opacity),(()=>this._updateDefaultHitTestOptions()),B),this.handles.add(G((()=>this.spatialReference),(()=>this.notifyChange("clippingArea")),$))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=I(this.sharedSymbolResources),this._set("labeler",I(this.labeler)),this._set("deconflictor",I(this.deconflictor)),this._resourceController=I(this._resourceController),this._set("stateManager",I(this.stateManager)),this._set("inputManager",I(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this._set("environmentManager",I(this.environmentManager)),this.groundView=I(this.groundView),this._exitBasemapTerrain())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||("clippingArea"in this.map?this.map?.clippingArea:void 0);return!this._userClippingArea&&!this.get("map.clippingEnabled")||M(e)?(this._clippingArea=null,null):e instanceof $u?this.spatialReference&&(e=BE(e,this.spatialReference),M(e))?(E.getLogger(this.declaredClass).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),M(e.intersection(this._groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(E.getLogger(this.declaredClass).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&A(e)?E.getLogger(this.declaredClass).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Ui.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return M(t)||M(e)||t.spatialReference.equals(e)?t:BE(t,e)}get dataExtent(){let e=this._groundAndLayersExtent;const t=this.spatialReference||Rh.WGS84,i=BE(this.clippingArea,t);A(i)&&(e=A(e)?e.intersection(i):i);const r=this._get("dataExtent");return A(e)&&e.equals(r)?r:e}get _groundAndLayersExtent(){const e=this.spatialReference||Rh.WGS84;let t;const i=i=>{const r=BE(i,e);M(r)||(A(t)?t.union(r):t=r.clone())},r=this.basemapTerrain;if(r?.spatialReference){const e=r.groundExtent;i(new $u({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const e=e=>{!A(e.fullExtent)||"graphics"===e.type&&e.internal||i(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(M(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);const s=this._get("_groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof yp?e:e instanceof cr?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):yp.fromWebsceneEnvironment(e):_e(yp,e):new yp}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||this.toolViewManager?.interacting}get stationary(){return!this.animation&&!this.resizing&&(M(this.state)||this.state.stationary)}get navigating(){return this.state?.navigating??!1}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){$v.isValidProfile(e)&&($v.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||$v.getDefaultProfile()}set slicePlane(e){if(A(this._stage)&&this._stage.renderer.setParameters({slicePlane:e}),M(e))return void this._set("slicePlane",null);const t=this._propertiesPool.get("slicePlane");Ot(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return null!=this.spatialReference?Ut(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?Xe.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((r=>{if(r.isFulfilled()){if(r.updating){if(t=!0,r.suspended||oc(r))return;++i,e+=r.updatingProgress}}else++i}));for(const t of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager])if(A(t)&&t.updating){const t=.1;i+=t,e+=.5*t}for(const t of[this.deconflictor,this.labeler,this.basemapTerrain])A(t)&&t.updating&&(++i,e+=t.updatingProgress);const r=this.stateManager.test.updatingIgnoreRenderState?zn.IDLE:this.state.mode;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r!==zn.IDLE||this._createGraphicsViewController||this.inputManager?.hasPendingInputs||this.map?.allLayers?.some((e=>!e.isFulfilled()))),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const i=performance.now();if(e<1){const t=Math.min((i-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-t)+e*t}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?i:0}return t}get viewingMode(){const e=this._predeterminedViewingMode;if(A(e))return ji(e);const t=this.spatialReference;return t?A(this.defaultsFromMap?.viewingMode)&&t.equals(this.defaultsFromMap.spatialReference)?ji(this.defaultsFromMap.viewingMode):Bu(t,Ui.Global)?"global":"local":"global"}set viewingMode(e){this.ready?E.getLogger(this.declaredClass).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get resourceController(){return this._resourceController}get performanceInfo(){return new Ah(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return E.getLogger(this.declaredClass).error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=A(i.graphics)&&(A(i.graphics.include)||A(i.graphics.exclude)),s=Gu(e)?Hu(this,e):e,a=se(s);i.enableDraped=i.include&&!i.include.has(ol)||i.exclude&&i.exclude.has(ol);const n=this.sceneIntersectionHelper,o=cl(this.state.viewingMode);if(o.options.selectionMode=!0,o.options.store=r?ul.ALL:ul.MIN,n.intersectIntersectorScreen(a,o,i),r){for(const e of o.results.all){const t=Vu(e,this);if(M(t))return this._intersectResultToMapPoint(e);if("graphic"!==t.type||this._testGraphicUidFilter(i.graphics,t.graphic))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return E.getLogger(this.declaredClass).error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=j(null==e.z?xh(this.elevationProvider,e):null,0);return it(e,$E,this.renderSpatialReference,t),this.state.camera.projectToScreen($E,QE),le(QE[0],QE[1])}pixelSizeAt(e){return this.ready?e?(it(e,$E,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt($E)):0:(E.getLogger(this.declaredClass).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return E.getLogger(this.declaredClass).error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=Gu(e)?Hu(this,e):e,r=re(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const a=cl(this.state.viewingMode);a.options.selectionMode=!0,a.options.store=ul.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(r,a,s);const n=this._intersectResultsToHits(a.results.all,s.graphics),o=a.results.ground,l=ku(o,this),h=A(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,c={screenPoint:i,results:n,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:pl(o)?o.distanceInRenderSpace:0,layer:h}};return La.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(c.intersector=a),Promise.resolve(c)}async popupHitTest(e){const{results:t,ground:i}=await zu(this,e);let r=null;return!(0===t.length||Math.abs(j(t[0].distance,0)-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(M(e.parent))throw new o("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return Mi(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return Di(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t);return[Di(i[0],this._pixelFormat()),Di(i[1],this._pixelFormat())]}_completeSettings(e){const t=Ii(e,this);return t.pixelRatio/=this.state.pixelRatio,Li(t,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:e=>this._takeScreenshot(e),takeScreenshotWithObjectAndLayerId:e=>this._takeScreenshotWithObjectAndLayerId(e)}}async takeScreenshotWithObjectAndLayerId(e){if(!b("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshotWithOID(t),r=Mi(i[0],t,this._pixelFormat()),s=this._completeSettings(e);return s.format="png",[r,Mi(i[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(M(this._stage.renderView.objectAndLayerIdRenderHelper))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return(e=>{const t=Yu[e.type];if(M(t))throw function(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new o(`${i}:view-not-supported`,`${t} is not supported in 3D`)}(e);return t(e)})(e)}hasLayerViewModule(e){return(e=>A(Yu[e.type]))(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=Ni(this.type);const t=b("safari");if(t&&t<9&&(e=new o("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),A(e))throw E.getLogger(this.declaredClass).warn("#validate()",e.message),e}get _predeterminedViewingMode(){const e=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return A(e)?Vi(e):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const i=this._predeterminedViewingMode;if(A(i))return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,Ui.Local),s=this._validateSpatialReferenceForViewingMode(e,t,Ui.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Ui.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Ui.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!(!Bu(e,i)||!M(t)&&!qt(t)&&(Vt(t)&&M(Ih(t,e,i))||Gt(t)&&i===Ui.Global))}_makeSpatialReferenceConstraints(e,t,i){if(M(t))return[{spatialReference:e,viewingMode:i}];const r=e.isWebMercator,s=e.isWGS84;return qt(t)&&(r||s)?s&&i!==Ui.Local&&null!==gc(t.tileInfo,t.fullExtent,e,Ui.Global)?[{spatialReference:r?Rh.WGS84:Rh.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:Rh.WebMercator,viewingMode:i}]:Vt(t)||Gt(t)||!r&&!s?Vt(t)&&r&&i!==Ui.Global?[{spatialReference:e,viewingMode:i},{spatialReference:Rh.WGS84,viewingMode:Ui.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?Rh.WGS84:Rh.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=A(this.getSpatialReferenceSupport({spatialReference:e})),i=this._predeterminedViewingMode;return t||(A(i)?E.getLogger(this.declaredClass).warnOnce(`Spatial reference defined on view not supported in ${ji(i)} viewing mode.`):e.isGeographic&&E.getLogger(this.declaredClass).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||Rh.WGS84;return et(e,this.renderSpatialReference,e,i)||(i=Rh.WGS84,et(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new Ph(e,i),t}trackGraphicState(e){if(!e.graphic)return E.getLogger(this.declaredClass).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&A(t)&&"processor"in t&&"graphics-3d"===t.processor?.type&&t.processor.graphicsCore&&(i=t.processor.graphicsCore.trackGraphicState(e))};return A(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,A(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return v(e.map((e=>this.highlight(e))));if(s.isCollection(e))return v(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):y()}maskOccludee(e){if(!e)return E.getLogger(this.declaredClass).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&A(t)&&qu(t)&&(i=t.maskOccludee(e))};return A(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,A(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){A(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await X((()=>this.graphicsView)),this.graphicsView;if(!e.layer||!this.map)throw new o("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{s.added.includes(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,WE.INCLUDE),i=this._externalToInternalRenderItems(e.exclude,WE.EXCLUDE);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint($E)?(t=this.computeMapPointFromVec3d($E,t),e.intersector===ml.TERRAIN&&this.basemapTerrain&&(t.z=j(xh(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const a=e[s],n=ku(a,this);if(A(n)&&(n===this.map.ground||"type"in n&&"integrated-mesh"===n.type))break;const o=Vu(a,this);if(M(o))continue;if("graphic"===o.type){if(M(r)&&s!==e.length-1&&(r=new Set),A(r)){const e=this._getGraphicFilterUid(o.graphic);if(r.has(e))continue;r.add(e)}if(!this._testGraphicUidFilter(t,o.graphic))continue}const l=this._intersectResultToMapPoint(a),h=a.distanceInRenderSpace;i.push({...o,mapPoint:l,distance:h})}return i}_getGraphicFilterUid(e){const t=e.sourceLayer,i=e.layer,r=t&&"objectIdField"in t?t:i&&"objectIdField"in i?i:t;if(r){const t=r.objectIdField??jt,i=e.attributes?.[t];if(i)return`o-${r.id}-${i}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return M(e)||(M(e.include)||e.include.has(i))&&(M(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,r={layerUids:void 0,graphicUids:void 0}){if(!e)return r;if(e instanceof i)!function(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}(r,this._getGraphicFilterUid(e)),t===WE.INCLUDE&&(A(this.graphicsView)&&e.layer===this?HE(r,this.graphicsView.processor.layer.id):e.layer&&HE(r,e.layer.uid));else if(O(e))for(const i of e)i===this.graphics&&A(this.graphicsView)?HE(r,this.graphicsView.processor.layer.id):i===this.map.ground?HE(r,ol):this._externalToInternalRenderItems(i,t,r);else"uid"in e&&HE(r,e.uid);return r}_initBasemapTerrain(){this._set("basemapTerrain",new BC({view:this})),this._set("elevationProvider",new Gv({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Gb({view:this})),this._set("featureTiles",new Sv({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=A(this.basemapTerrain.extent)&&A(this.basemapTerrain.spatialReference)?st(Pt(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;A(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add((()=>La.FEATURE_TILE_TREE_SHOW_TILES),(e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(import("../chunks/FeatureTileTree3DDebugger.js")).then((({FeatureTileTree3DDebugger:e})=>{!this._featureTreeDebugger&&La.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new e({view:this}))})):e||!this._featureTreeDebugger||La.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)}),B),this.updatingHandles.add((()=>this.clippingArea),e,B),this.updatingHandles.add((()=>this.basemapTerrain.extent),e,B)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new Kv(this.map,e));const t=this.state.isGlobal,i=Nt(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",Ft.create(this.state.viewingMode,i)),t||this.handles.add(G((()=>this.basemapTerrain?.extent),(e=>{const t=this.renderCoordsHelper.spatialReference;A(e)&&(0!==e[0]||0!==e[1]||0!==e[2]||0!==e[3])&&Ke(e,this.basemapTerrain.spatialReference,XE,t)&&(this.renderCoordsHelper.extent=XE)}),$),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(dl/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){A(e)&&e.type===a.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add(G((()=>[e.updating,e.updatingProgress]),(()=>this._updatingChanged()),$),"updatingMonitors"),e.when((()=>this._updatingChanged()),(()=>this._updatingChanged())))})),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},t=new Iv(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=n(this.surface);this._stage=new kE({view:this,options:e,container:i}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.handles.add([this.updatingHandles.add((()=>this.qualitySettings.antialiasingEnabled),(()=>this._stage.renderer.setParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})),H),this.updatingHandles.add((()=>this.qualitySettings.highQualityTransparency),(e=>this._stage.renderer.setParameters({highQualityTransparency:e})),H),G((()=>this.magnifier),(e=>this._stage.renderView.magnifier=e),B),this.on("pointer-move",(()=>this._stage?.renderer.resetAnimation())),f(this._stage.renderView.canvas,"webglcontextlost",(e=>this.fatalError=new o("webgl-context-lost",e.statusMessage)))],"stage");const r=()=>{this._stage.renderer.setParameters({defaultHighlightOptions:Zv.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add((()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference]),r),"stage"),r(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(dl/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=I(this._stage),this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new _b({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("../chunks/GraphicsView3D.js")).default;p(e),await X((()=>this.basemapTerrain?.ready),e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),A(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=Vi(this.viewingMode);if(e===Ui.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.handles.add(Q((()=>this.graphics),"after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(ol);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(ol);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultHitTestOptions.exclude.add(e.uid)}}addVoxelLayerViewToWasm(e){return M(this.voxelWasm)?(M(this.voxelWasmPromise)&&(this.voxelWasmPromise=import("../chunks/VoxelWasmPerSceneView.js").then((e=>(this.voxelWasm=new e.default(this),this.voxelWasm)))),this.voxelWasmPromise.then((t=>t.addVoxelLayer(e)))):this.voxelWasm.addVoxelLayer(e)}removeVoxelLayerViewFromWasm(e){A(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(e)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}};function HE(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function BE(e,t){return A(e)&&rt(e.spatialReference,t)?st(e,t):null}var WE;GE.type="3d",e([ce()],GE.prototype,"_userClippingArea",void 0),e([ce()],GE.prototype,"_resourceController",void 0),e([ce()],GE.prototype,"_stage",void 0),e([ce({readOnly:!0})],GE.prototype,"deconflictor",void 0),e([ce({readOnly:!0})],GE.prototype,"labeler",void 0),e([ce(Qe(ui,"analyses"))],GE.prototype,"analyses",void 0),e([ce({type:Fi,readOnly:!0})],GE.prototype,"animation",null),e([ce({readOnly:!0})],GE.prototype,"basemapTerrain",void 0),e([ce({readOnly:!0})],GE.prototype,"elevationProvider",void 0),e([ce()],GE.prototype,"camera",null),e([ce({type:t})],GE.prototype,"contentCamera",null),e([ce({readOnly:!0})],GE.prototype,"canvas",void 0),e([ce({type:Ph})],GE.prototype,"center",null),e([ce({type:$u})],GE.prototype,"clippingArea",null),e([ce({type:up})],GE.prototype,"constraints",void 0),e([ce({type:$u,readOnly:!0})],GE.prototype,"renderDataExtent",null),e([ce({type:$u,readOnly:!0})],GE.prototype,"dataExtent",null),e([ce({type:$u,readOnly:!0})],GE.prototype,"_groundAndLayersExtent",null),e([ce({value:null,type:yp})],GE.prototype,"environment",null),e([de("environment")],GE.prototype,"castEnvironment",null),e([ce({readOnly:!0})],GE.prototype,"environmentManager",void 0),e([ce({type:$u})],GE.prototype,"extent",null),e([ce()],GE.prototype,"floors",void 0),e([ce()],GE.prototype,"screenCenter",null),e([ce()],GE.prototype,"frustum",null),e([ce({type:Number,readOnly:!0})],GE.prototype,"fullOpacity",void 0),e([ce({readOnly:!0})],GE.prototype,"graphicsView",void 0),e([ce({readOnly:!0})],GE.prototype,"analysisViewManager",void 0),e([ce()],GE.prototype,"groundView",void 0),e([ce({type:Boolean})],GE.prototype,"initialExtentRequired",null),e([ce()],GE.prototype,"_defaultsFromMapSettings",null),e([ce()],GE.prototype,"interacting",null),e([ce()],GE.prototype,"stationary",null),e([ce()],GE.prototype,"navigating",null),e([ce()],GE.prototype,"map",void 0),e([ce({readOnly:!0})],GE.prototype,"mapCoordsHelper",void 0),e([ce()],GE.prototype,"padding",null),e([ce({type:Gb,readOnly:!0})],GE.prototype,"pointsOfInterest",void 0),e([ce({type:Sv,readOnly:!0})],GE.prototype,"featureTiles",void 0),e([ce()],GE.prototype,"_featureTreeDebugger",void 0),e([ce({type:Boolean})],GE.prototype,"screenSizePerspectiveEnabled",void 0),e([ce({constructOnly:!0})],GE.prototype,"deactivatedWebGLExtensions",void 0),e([ce({constructOnly:!0})],GE.prototype,"debugWebGLExtensions",void 0),e([ce({constructOnly:!0})],GE.prototype,"renderCanvas",void 0),e([ce({constructOnly:!0})],GE.prototype,"state",void 0),e([ce({readOnly:!0})],GE.prototype,"inputManager",void 0),e([ce({readOnly:!0})],GE.prototype,"stateManager",void 0),e([ce({type:["low","medium","high"]})],GE.prototype,"qualityProfile",null),e([ce({type:nb,get(){let e=this._get("qualitySettings");return e||(e=new nb,$v.apply(this.qualityProfile,e)),e}})],GE.prototype,"qualitySettings",void 0),e([ce()],GE.prototype,"slicePlane",null),e([ce({readOnly:!0})],GE.prototype,"typeSpecificPreconditionsReady",null),e([ce({readOnly:!0})],GE.prototype,"renderCoordsHelper",void 0),e([ce({readOnly:!0})],GE.prototype,"sceneIntersectionHelper",void 0),e([ce({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],GE.prototype,"resolution",null),e([ce({type:Number})],GE.prototype,"scale",null),e([ce()],GE.prototype,"heightModelInfo",null),e([ce()],GE.prototype,"spatialReference",void 0),e([ce({type:Boolean,constructOnly:!0})],GE.prototype,"alphaCompositingEnabled",void 0),e([ce({constructOnly:!0})],GE.prototype,"preserveDrawingBufferEnabled",void 0),e([ce({type:Boolean})],GE.prototype,"supersampleScreenshotsEnabled",void 0),e([ce({readOnly:!0})],GE.prototype,"type",void 0),e([ce(),de((e=>e instanceof Wu?e:ge(qE,e)))],GE.prototype,"ui",void 0),e([ce({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating","state.mode"]})],GE.prototype,"updating",null),e([ce({type:Number,readOnly:!0,dependsOn:["updating"]})],GE.prototype,"updatingProgress",void 0),e([ce({type:["global","local"]})],GE.prototype,"viewingMode",null),e([ce({type:r})],GE.prototype,"viewpoint",null),e([ce({type:Number})],GE.prototype,"zoom",null),e([ce({type:Zv})],GE.prototype,"highlightOptions",void 0),GE=e([ue("esri.views.SceneView")],GE),function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(WE||(WE={}));const $E=ve(),QE=re(),XE=at(),YE=GE;export{ob as C,gT as R,oS as S,Qb as a,rv as b,kS as c,YE as default,ZS as g,hb as m,Bx as t,Xb as u};
