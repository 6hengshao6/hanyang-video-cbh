/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import"../../geometry.js";import e from"../../Viewpoint.js";import{JSONSupport as r}from"../../core/JSONSupport.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{t as o}from"../../chunks/common.js";import{f as i,s as a,a as c,r as u,t as m,b as p,c as l}from"../../chunks/mat2d.js";import{c as f}from"../../chunks/mat2df32.js";import{c as h}from"../../chunks/mat2df64.js";import{s as y,d as j,e as g,r as d,m as w}from"../../chunks/mat3.js";import{c as k}from"../../chunks/mat3f32.js";import{b as x,n as v,c as b,e as R,f as G,g as S,h as z,s as A,t as M,i as _,j as N,k as U}from"../../chunks/vec2.js";import{f as T}from"../../chunks/vec2f32.js";import{a as V,f as C}from"../../chunks/vec2f64.js";import F from"../../core/Collection.js";import{i as P,j as E,a as q}from"../../chunks/maybe.js";import{f as D,n as I,g as L,h as O}from"../../chunks/unitUtils.js";import W from"../../geometry/Extent.js";import B from"../../geometry/Geometry.js";import Q from"../../geometry/Point.js";import{isLoaded as H,canProjectWithoutEngine as J,load as K,project as X}from"../../geometry/projection.js";import Y from"../../geometry/SpatialReference.js";import"../../geometry/Multipoint.js";import"../../core/lang.js";import"../../chunks/writer.js";import"../../chunks/zmUtils.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../core/Error.js";import"../../chunks/tracking.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/ArrayPool.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/promiseUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/reader.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/vec4.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../Camera.js";import"../../core/Clonable.js";import"../../chunks/Cyclical.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";function Z(t){return function(t){return t instanceof Float32Array&&t.length>=2}(t)||function(t){return Array.isArray(t)&&t.length>=2}(t)}const $=96,tt=39.37,et=180/Math.PI;function rt(t){return t.wkid?t:t.spatialReference||Y.WGS84}function st(t,e){return e.type?A(t,e.x,e.y):U(t,e)}function nt(t){return L(t)}function ot(t,e){const r=Math.max(1,e[0]),s=Math.max(1,e[1]);return Math.max(t.width/r,t.height/s)*(n=t.spatialReference,I(n)?nt(n)*tt*$:1);var n}async function it(t,e,r,s){let n,o;if(!t)return null;if(Array.isArray(t)&&!t.length)return null;if(F.isCollection(t)&&(t=t.toArray()),Array.isArray(t)&&t.length&&"object"==typeof t[0]){const n=t.every((t=>"attributes"in t)),o=t.some((t=>!t.geometry));let i=t;if(n&&o&&e&&e.allLayerViews){const r=new Map;for(const e of t){const t=e.layer,s=r.get(t)||[],n=e.attributes[t.objectIdField];null!=n&&s.push(n),r.set(t,s)}const s=[];r.forEach(((t,r)=>{const n=e.allLayerViews.find((t=>t.layer.id===r.id));if(n&&"queryFeatures"in n){const e=r.createQuery();e.objectIds=t,e.returnGeometry=!0,s.push(n.queryFeatures(e))}}));const n=await Promise.all(s),o=[];for(const t of n)if(t&&t.features&&t.features.length)for(const e of t.features)P(e.geometry)&&o.push(e.geometry);i=o}for(const t of i)s=await it(t,e,r,s);return s}if(Array.isArray(t)&&2===t.length&&"number"==typeof t[0]&&"number"==typeof t[1])n=new Q(t);else if(t instanceof B)n=t;else if("geometry"in t)if(t.geometry)n=t.geometry;else if(t.layer){const r=t.layer,s=e.allLayerViews.find((t=>t.layer.id===r.id));if(s&&"queryFeatures"in s){const e=r.createQuery();e.objectIds=[t.attributes[r.objectIdField]],e.returnGeometry=!0;const o=await s.queryFeatures(e);n=E(o,"features",0,"geometry")}}if(q(n))return null;if(o="point"===n.type?new W({xmin:n.x,ymin:n.y,xmax:n.x,ymax:n.y,spatialReference:n.spatialReference}):n.extent,!o)return null;H()||J(o.spatialReference,r)||await K();const i=X(o,r);return i?s=s?s.union(i):i:null}function at(t,e){return D(rt(t),e)?t:X(t,e)}async function ct(t,r){if(!t||!r)return new e({targetGeometry:new Q,scale:0,rotation:0});let s=r.spatialReference;const{constraints:n,padding:o,viewpoint:i,size:a}=r,c=[o?a[0]-o.left-o.right:a[0],o?a[1]-o.top-o.bottom:a[1]];let u=null;t instanceof e?u=t:t.viewpoint?u=t.viewpoint:t.target&&"esri.Viewpoint"===t.target.declaredClass&&(u=t.target);let m=null;u&&u.targetGeometry?m=u.targetGeometry:t instanceof W?m=t:(t||t&&("center"in t||"extent"in t||"target"in t))&&(m=await it(t.center,r,s)||await it(t.extent,r,s)||await it(t.target,r,s)||await it(t,r,s)),!m&&i&&i.targetGeometry?m=i.targetGeometry:!m&&r.extent&&(m=r.extent),s||(s=rt(r.spatialReference||r.extent||m)),H()||D(m.spatialReference,s)||J(m,s)||await K();const p=at(m.center??m,s);let l=0;if(u&&P(u.targetGeometry)&&"point"===u.targetGeometry.type)l=u.scale;else if("scale"in t&&t.scale)l=t.scale;else if("zoom"in t&&-1!==t.zoom&&n&&n.effectiveLODs)l=n.zoomToScale(t.zoom);else if(Array.isArray(m)||"point"===m.type||"extent"===m.type&&0===m.width&&0===m.height){const t=at(r.extent,s);l=P(t)?ot(t,c):r.extent?ot(r.extent,c):i.scale}else l=ot(at(m.extent,s),c);const f=function(t){if(t&&(!Array.isArray(t)||"number"!=typeof t[0])&&("object"==typeof t||Array.isArray(t)&&"object"==typeof t[0])){if("layer"in t&&t.layer&&t.layer.minScale&&t.layer.maxScale){const e=t.layer;return{min:e.minScale,max:e.maxScale}}if(Array.isArray(t)&&t.length&&t.every((t=>"layer"in t))){let e=0,r=0;for(const s of t){const t=s.layer;t&&t.minScale&&t.maxScale&&(e=t.minScale<e?t.minScale:e,r=t.maxScale>r?t.maxScale:r)}return e&&r?{min:e,max:r}:null}}}(t);f&&(f.min&&f.min>l?l=f.min:f.max&&f.max<l&&(l=f.max));let h=0;u?h=u.rotation:t.hasOwnProperty("rotation")?h=t.rotation:i&&(h=i.rotation);let y=new e({targetGeometry:p,scale:l,rotation:h});return n&&(y=n.fit(y),n.constrainByGeometry(y),n.rotationEnabled||(y.rotation=h)),y}function ut(t,e){const r=t.targetGeometry,s=e.targetGeometry;return r.x=s.x,r.y=s.y,r.spatialReference=s.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}function mt(t,e,r){return r?A(t,.5*(e[0]-r.right+r.left),.5*(e[1]-r.bottom+r.top)):z(t,e,.5)}const pt=function(){const t=V();return function(e,r,s){const n=r.targetGeometry;st(t,n);const o=.5*yt(r);return e.xmin=t[0]-o*s[0],e.ymin=t[1]-o*s[1],e.xmax=t[0]+o*s[0],e.ymax=t[1]+o*s[1],e.spatialReference=n.spatialReference,e}}();function lt(t,e,r,s,n){return bt(t,e,r.center),t.scale=ot(r,s),n&&n.constraints&&n.constraints.constrain(t),t}const ft=function(){const t=V();return function(e,r,s){return S(e,function(t,e){return z(t,e,.5)}(e,r),mt(t,r,s))}}(),ht=function(){const t=h(),e=V();return function(r,s,n,o){const i=yt(s),a=jt(s);return A(e,i,i),p(t,e),u(t,t,a),m(t,t,ft(e,n,o)),m(t,t,[0,o.top-o.bottom]),A(r,t[4],t[5])}}();function yt(t){return t.scale*(e=t.targetGeometry,P(e)&&I(e.spatialReference)?1/(nt(e.spatialReference)*tt*$):1);var e}function jt(t){return o(t.rotation)||0}const gt=function(){const t=V(),e=V(),r=V();return function(s,n,o,i,p,l){return _(t,n),z(e,o,.5*l),A(r,1/i*l,-1/i*l),c(s,e),p&&u(s,s,p),a(s,s,r),m(s,s,t),s}}(),dt=function(){const t=V();return function(e,r,s,n){const o=yt(r),i=jt(r);return st(t,r.targetGeometry),gt(e,t,s,o,i,n)}}(),wt=function(){const t=V();return function(e,r,s,n){const o=yt(r);return st(t,r.targetGeometry),gt(e,t,s,o,0,n)}}();function kt(t){const e=O(t);return e?e.valid[1]-e.valid[0]:0}const xt=function(){const t=V(),e=V(),r=[0,0,0];return function(s,n,o){x(t,s,n),v(t,t),x(e,s,o),v(e,e),b(r,t,e);let i=Math.acos(R(t,e)/(G(t)*G(e)))*et;return r[2]<0&&(i=-i),isNaN(i)&&(i=0),i}}(),vt=function(){const t=V();return function(e,r,s,n){const o=e.targetGeometry;return ut(e,r),ht(t,r,s,n),o.x+=t[0],o.y+=t[1],e}}(),bt=function(t,e,r){ut(t,e);const s=t.targetGeometry;return s.x=r.x,s.y=r.y,s.spatialReference=r.spatialReference,t},Rt=function(){const t=V();return function(e,r,s,n,o){o||(o="center"),S(t,s,n),z(t,t,.5);const i=t[0],a=t[1];switch(o){case"center":A(t,0,0);break;case"left":A(t,-i,0);break;case"top":A(t,0,a);break;case"right":A(t,i,0);break;case"bottom":A(t,0,-a);break;case"top-left":A(t,-i,a);break;case"bottom-left":A(t,-i,-a);break;case"top-right":A(t,i,a);break;case"bottom-right":A(t,i,-a)}return Tt(e,r,t),e}}();function Gt(t,e,r){return ut(t,e),t.rotation+=r,t}function St(t,e,r){return ut(t,e),t.rotation=r,t}const zt=function(){const t=V();return function(e,r,s,n,o){return ut(e,r),isNaN(s)||0===s||(Nt(t,n,r,o),e.scale=r.scale*s,Ut(t,t,e,o),Tt(e,e,A(t,t[0]-n[0],n[1]-t[1]))),e}}();function At(t,e,r){return ut(t,e),t.scale=r,t}const Mt=function(){const t=V();return function(e,r,s,n,o,i){return ut(e,r),isNaN(s)||0===s||(Nt(t,o,r,i),e.scale=r.scale*s,e.rotation+=n,Ut(t,t,e,i),Tt(e,e,A(t,t[0]-o[0],o[1]-t[1]))),e}}(),_t=function(){const t=V(),e=V();return function(r,s,n,o,i,a,c){return ft(e,a,c),N(t,i,e),o?Mt(r,s,n,o,t,a):zt(r,s,n,t,a)}}(),Nt=function(){const t=h();return function(e,r,s,n){return M(e,r,function(t,e,r,s){return dt(t,e,r,1),l(t,t)}(t,s,n))}}(),Ut=function(){const t=h();return function(e,r,s,n){return M(e,r,dt(t,s,n,1))}}(),Tt=function(){const t=V(),e=h();return function(r,s,n){ut(r,s);const o=yt(s),c=r.targetGeometry;return i(e,jt(s)),a(e,e,C(o,o)),M(t,n,e),c.x+=t[0],c.y+=t[1],r}}();var Vt;const Ct=[0,0];let Ft=Vt=class extends r{constructor(t){super(t),this._viewpoint2D={center:V(),rotation:0,scale:0,spatialReference:void 0},this.center=[0,0],this.extent=new W,this.id=0,this.inverseTransform=h(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=h(),this.transformNoRotation=h(),this.displayMat3=k(),this.displayViewMat3=k(),this.viewMat3=k(),this.viewMat2d=f(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,r=t.targetGeometry;e.center[0]=r.x,e.center[1]=r.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=r.spatialReference}this._update()}copy(t){const e=this.size,r=this.viewpoint;return r&&e?(this.viewpoint=ut(r,t.viewpoint),this._set("size",U(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new Vt({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,r){return Z(e)?M(t,e,this.inverseTransform):(Ct[0]=e,Ct[1]=r,M(t,Ct,this.inverseTransform))}toScreen(t,e,r){return Z(e)?M(t,e,this.transform):(Ct[0]=e,Ct[1]=r,M(t,Ct,this.transform))}toScreenNoRotation(t,e,r){return Z(e)?M(t,e,this.transformNoRotation):(Ct[0]=e,Ct[1]=r,M(t,Ct,this.transformNoRotation))}getScreenTransform(t,e){const{center:r}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size");return gt(t,r,n,e,0,s),t}_update(){const{center:t,spatialReference:r,scale:s,rotation:n}=this._viewpoint2D,i=this._get("pixelRatio")||1,a=this._get("size"),p=new e({targetGeometry:new Q(t[0],t[1],r),scale:s,rotation:n});if(this._set("viewpoint",p),!a||!r||!s)return;this.resolution=yt(p),this.rotation=n,this.scale=s,this.spatialReference=r,U(this.center,t);const f=0!==a[0]?2/a[0]:0,h=0!==a[1]?-2/a[1]:0;y(this.displayMat3,f,0,0,0,h,0,-1,1,1);const k=j(this.viewMat3),x=T(a[0]/2,a[1]/2),v=T(-a[0]/2,-a[1]/2),b=o(n);g(k,k,x),d(k,k,b),g(k,k,v),w(this.displayViewMat3,this.displayMat3,k);const R=c(this.viewMat2d,x);return u(R,R,b),m(R,R,v),pt(this.extent,p,a),dt(this.transform,p,a,i),l(this.inverseTransform,this.transform),wt(this.transformNoRotation,p,a,i),this.worldScreenWidth=function(t,e){return Math.round(kt(t)/e)}(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};t([s({readOnly:!0})],Ft.prototype,"id",void 0),t([s({value:1,json:{write:!0}})],Ft.prototype,"pixelRatio",null),t([s({json:{write:!0}})],Ft.prototype,"size",null),t([s()],Ft.prototype,"spatialReference",void 0),t([s({type:e,json:{write:!0}})],Ft.prototype,"viewpoint",null),Ft=Vt=t([n("esri.views.2d.ViewState")],Ft);const Pt=Ft;export{vt as a,bt as b,ut as c,lt as d,Pt as default,At as e,ct as f,ot as g,Rt as h,xt as i,ft as j,mt as k,Gt as l,kt as m,_t as p,St as r,Mt as s,Tt as t};
