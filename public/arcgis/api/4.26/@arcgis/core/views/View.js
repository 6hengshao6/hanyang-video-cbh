/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Map.js";import i from"../TimeExtent.js";import a from"../core/Accessor.js";import{c as s}from"../chunks/asyncUtils.js";import r from"../core/Collection.js";import{C as n}from"../chunks/CollectionFlattener.js";import o from"../core/Error.js";import l from"../core/Evented.js";import{HandleOwner as c,HandleOwnerMixin as h}from"../core/HandleOwner.js";import{m as p}from"../chunks/handleUtils.js";import d from"../core/Loadable.js";import{L as u}from"../chunks/Logger.js";import{a as m,i as y,r as f,l as g,d as w,g as _,u as v,f as C}from"../chunks/maybe.js";import{EsriPromiseMixin as M}from"../core/Promise.js";import{createDeferred as T,createAbortError as x,isAbortError as b,onAbort as R,throwIfAborted as S,isAborted as P,after as k}from"../core/promiseUtils.js";import{on as E,watch as j,syncAndInitial as I,sync as A,initial as L,whenOnce as F,when as O}from"../core/reactiveUtils.js";import{property as V}from"../core/accessorSupport/decorators/property.js";import{s as N}from"../chunks/ensureType.js";import{h as D}from"../chunks/typedArrayUtil.js";import{subclass as z}from"../core/accessorSupport/decorators/subclass.js";import{O as U,G as Z,o as q}from"../chunks/GraphicsCollection.js";import W from"../geometry/Extent.js";import H from"../geometry/HeightModelInfo.js";import G from"../geometry/SpatialReference.js";import{B,g as K,f as Y}from"../chunks/unitUtils.js";import{T as Q}from"../chunks/TimeReference.js";import{BasemapView as $}from"./BasemapView.js";import{schedule as J,M as X,S as ee,m as te,addFrameTask as ie}from"../core/scheduling.js";import{W as ae}from"../chunks/WatchUpdatingTracking.js";import{d as se}from"../chunks/collectionUtils2.js";import re from"./Magnifier.js";import ne from"../Camera.js";import oe from"../Viewpoint.js";import{c as le}from"../chunks/screenUtils.js";import{c as ce,g as he,m as pe,d as de,b as ue,a as me,D as ye,G as fe,l as ge,e as we,n as _e,I as ve,k as Ce,A as Me,t as Te,h as xe,f as be,C as Re,H as Se}from"../chunks/vec3.js";import{s as Pe}from"../chunks/vec4.js";import{c as ke}from"../chunks/vec4f64.js";import Ee from"../geometry/Point.js";import{canProject as je}from"../geometry/support/webMercatorUtils.js";import{V as Ie}from"../chunks/ViewingMode.js";import{c as Ae,b as Le,a as Fe,d as Oe,l as Ve,r as Ne}from"../chunks/mathUtils.js";import{w as De}from"../chunks/ray.js";import{c as ze}from"../chunks/intersectionUtils.js";import{e as Ue,h as Ze,j as qe,k as We,t as He}from"../chunks/sphere.js";import{s as Ge,e as Be,c as Ke,a as Ye,i as Qe,t as $e,d as Je,f as Xe,b as et,g as tt,h as it,O as at,j as st,k as rt,z as nt,l as ot}from"../chunks/viewpointUtils.js";import{n as lt}from"../chunks/compilerUtils.js";import{a as ct}from"../chunks/mat4.js";import{c as ht}from"../chunks/mat4f64.js";import{j as pt,c as dt,k as ut,f as mt,l as yt,i as ft,m as gt,n as wt,o as _t,p as vt}from"../chunks/frustum.js";import Ct from"./ViewAnimation.js";import{t as Mt}from"../chunks/mat3.js";import{c as Tt}from"../chunks/mat3f64.js";import{c as xt,a as bt}from"../chunks/mathUtils2.js";import{C as Rt,P as St}from"../chunks/Camera.js";import{a as Pt}from"../chunks/Intersector2.js";import kt,{f as Et}from"../core/Handles.js";import{P as jt}from"../chunks/PropertiesPool.js";import{N as It}from"../chunks/NestedMap.js";import{R as At,T as Lt,I as Ft}from"../chunks/Scheduler.js";import{V as Ot}from"../chunks/InputManager.js";import{e as Vt,V as Nt}from"../chunks/ViewEvents.js";import{E as Dt}from"../chunks/interfaces5.js";import{c as zt}from"../chunks/screenUtils2.js";import Ut from"./input/Input.js";import Zt from"./navigation/Navigation.js";import{s as qt,d as Wt}from"../chunks/heightModelInfoUtils.js";import{isLoaded as Ht,canProjectWithoutEngine as Gt,project as Bt,load as Kt}from"../geometry/projection.js";import"../Basemap.js";import"../chunks/collectionUtils.js";import"../core/JSONSupport.js";import"../core/lang.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/metadata.js";import"../chunks/ArrayPool.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../chunks/nextTick.js";import"../chunks/object.js";import"../config.js";import"../chunks/string.js";import"../chunks/loadAll.js";import"../core/urlUtils.js";import"../chunks/writer.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../chunks/reader.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../chunks/jsonMap.js";import"../geometry/Geometry.js";import"../chunks/Ellipsoid.js";import"../core/accessorSupport/decorators/cast.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalItem.js";import"../chunks/assets.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/messages.js";import"../chunks/writeUtils.js";import"../chunks/layerUtils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../Ground.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/common.js";import"../chunks/enumeration.js";import"../chunks/opacityUtils.js";import"../chunks/editableLayers.js";import"../chunks/basemapUtils.js";import"../support/LayersMixin.js";import"../layers/Layer.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Identifiable.js";import"../support/TablesMixin.js";import"../chunks/timeUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../layers/support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../chunks/Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../chunks/datetime.js";import"../chunks/Cyclical.js";import"../chunks/byteSizeEstimations.js";import"../chunks/quatf64.js";import"../chunks/vec2f64.js";import"../chunks/plane.js";import"../chunks/vector.js";import"../chunks/scaleUtils.js";import"../chunks/earthUtils.js";import"../chunks/ElevationProvider.js";import"../chunks/spatialReferenceSupport.js";import"../chunks/vec2.js";import"../chunks/boundedPlane.js";import"../chunks/lineSegment.js";import"../chunks/verticalOffsetUtils.js";import"../chunks/quat.js";import"../chunks/vec3f32.js";import"../chunks/ObservableValue.js";import"../chunks/debugFlags.js";import"../chunks/Queue.js";import"../chunks/IViewEvents.js";import"./input/gamepad/GamepadSettings.js";import"./input/gamepad/GamepadInputDevice.js";import"./navigation/gamepad/GamepadSettings.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";let Yt=class extends U{constructor(e){super(e),this.handles.add(this.on("before-add",(e=>{m(e.item)||e.item.parent===this.owner&&(u.getLogger(this.declaredClass).warn("Analysis inside the collection must be unique. Not adding this element again."),e.preventDefault())})))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};Yt=e([z("esri.support.AnalysesCollection")],Yt);class Qt{constructor(e,t,i){this.layer=e,this.view=t,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=T(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,R(this._controller.signal,(()=>{const t=new o("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(t)}))}tryRecycle(e){if(!this.done||!this.layerView||!("tryRecycleWith"in this.layerView))return null;const t=this.layer.type,i=this._controller.signal;for(let a=0;a<e.length;a++){const s=e[a];if(s.type!==t)continue;const r=this.layerView.tryRecycleWith(s,{signal:i});if(r){e.splice(a,1),this.layer=s;const t=this.layerView,i=t.view;return this.promise=Promise.race([r.then((()=>(S(this._controller.signal),s.emit("layerview-destroy",{view:i,layerView:t}),i.emit("layerview-destroy",{view:i,layerView:t}),s.emit("layerview-create",{view:i,layerView:t}),i.emit("layerview-create",{view:i,layerView:t}),t))),new Promise(((e,t)=>R(this._controller.signal,(()=>t(x())))))]),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:t,view:i}=this;t.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:t,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:t,view:i}=this;this._map=i.map;try{let a,s;if(await t.load({signal:e}),"prefetchResources"in t&&await(t.prefetchResources?.({signal:e})),function(e){return"createLayerView"in e&&null!=e.createLayerView}(t))a=await t.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(t))throw new o("layer:view-not-supported","No layerview implementation was found");const s=await this.layerViewImporter.importLayerView(t);S(e),a="default"in s?new s.default({layer:t,view:i}):new s({layer:t,view:i})}const r=()=>{s=f(s),a.destroyed||a.destroy(),a.layer=null,a.parent=null,a.view=null,this.done=!0};s=R(e,r),S(e);try{await a.when()}catch(e){throw r(),e}const n=this._map?.allLayers?.includes(t);if(!n)return r(),void this._deferred.reject(new o("view:no-layerview-for-layer","The layer has been removed from the map",{layer:t}));this.layerView=a,t.emit("layerview-create",{view:i,layerView:a}),i.emit("layerview-create",{layer:t,layerView:a}),this.done=!0,this._deferred.resolve(a)}catch(e){t.emit("layerview-create-error",{view:i,error:e}),i.emit("layerview-create-error",{layer:t,error:e}),this.done=!0,this._deferred.reject(new o("layerview:create-error","layerview creation failed",{layer:t,error:e}))}}}let $t=class extends a{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new ae,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const e=this.view.map?.allLayers;if(e)for(const t of e)this.layerViewImporter.hasLayerViewModule(t)&&this.layerViewImporter.importLayerView(t)},this._reschedule=()=>(m(this._workPromise)&&(this._workPromise=T(),this._workPromise.promise.catch((()=>{}))),this.removeHandles("reschedule"),this.addHandles(J(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{const e=this.view.map;if(this._map!==e&&(this.clear(),this._map=e),m(this._workPromise))return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const t=new Set,i=[],a=this.view.ready,s=e=>{if(!m(e))for(const r of e)if(r){t.add(r);const e=this._layerLayerViewInfoMap.get(r);e&&a?e.start():e||this._recyclingInfoMap.has(r)||i.push(r),"layers"in r&&r.layers&&s(r.layers)}};for(const e of this._rootCollectionNames)s(this.get(e));for(const[e,a]of this._layerLayerViewInfoMap)if(!t.has(e)){this._layerLayerViewInfoMap.delete(a.layer);const e=a.tryRecycle(i);e?(this._recyclingInfoMap.set(a.layer,a),e.then((()=>{this._recyclingInfoMap.delete(a.layer),this._layerLayerViewInfoMap.set(a.layer,a),this._reschedule()})).catch((()=>{this._recyclingInfoMap.delete(a.layer),a.destroy(),this._reschedule()}))):a.destroy()}for(const[e,i]of this._recyclingInfoMap)t.has(e)||(this._recyclingInfoMap.delete(i.layer),i.destroy());for(const e of i)this._createLayerView(e);this._refreshCollections();const r=[e?.ground?.layers,e?.basemap?.baseLayers,e?.basemap?.referenceLayers,e?.layers].filter((e=>!!e));t.forEach((e=>"layers"in e&&r.push(e.layers))),this.addHandles(r.map((e=>this._watchUpdatingTracking.addOnCollectionChange((()=>e),this._reschedule))),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.own([E((()=>this.view?.map?.allLayers),"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),j((()=>{const e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]}),(()=>this._reschedule()),I)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),se(this._recyclingInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,y(this._workPromise)&&(this._workPromise.reject(x()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return y(this._workPromise)||this._watchUpdatingTracking.updating||N(this._layerLayerViewInfoMap,(e=>!e.done))}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new o("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let a=0;for(const s of e){const e=this._layerLayerViewInfoMap.get(s);if(!e||!e.layerView)continue;const r=e.layerView;r.layer=s,r.parent=i,t.getItemAt(a)!==r&&t.splice(a,0,r),s.layers&&this._populateLayerViewsOwners(s.layers,r.layerViews,r),a+=1}a<t.length&&t.splice(a,t.length)}_createLayerView(e){e.load().catch((()=>{})),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new Qt(e,this.view,this.layerViewImporter);t.promise.then((()=>this._refreshCollections()),(t=>{t&&(b(t)||"cancelled:layerview-create"===t.name)||u.getLogger(this.declaredClass).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:t}),this._refreshCollections()})),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};e([V()],$t.prototype,"_workPromise",void 0),e([V({readOnly:!0})],$t.prototype,"_watchUpdatingTracking",void 0),e([V({readOnly:!0})],$t.prototype,"_layersToLayerViews",null),e([V({readOnly:!0})],$t.prototype,"_rootCollectionNames",null),e([V()],$t.prototype,"layerViewImporter",void 0),e([V()],$t.prototype,"supportsGround",void 0),e([V({readOnly:!0})],$t.prototype,"updating",null),e([V({readOnly:!0})],$t.prototype,"updatingRemaining",null),e([V({constructOnly:!0})],$t.prototype,"view",void 0),$t=e([z("esri.views.LayerViewManager")],$t);const Jt=$t;var Xt,ei,ti;function ii(e,t){return 0!=(e&t)}function ai(e,t,i,a,s,r){0!==e&&(i?(r.min=Math.min(r.min,t),r.max=Math.max(r.max,t)):null!=a?(r.min-=Math.max(0,(t-r.min)*(1-a)),r.max+=Math.max(0,(t-r.max)*(1-a))):s&&(r.min-=Math.max(0,t-r.min-s),r.max+=Math.max(0,t-r.max-s)))}!function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(Xt||(Xt={})),function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"}(ei||(ei={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(ti||(ti={}));const si={selection:Xt.NONE,interactionType:ei.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ti.TUMBLE};function ri(e,t,i,a){return t=t||e.viewForward,ce(a,t),he(a,a,Math.sign(pe(t,i))),a}function ni(e,t,i=si){if(!function(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i||t.interactionType===ei.TUMBLE&&ii(t.selection,Xt.TILT))}(e,i)||!e.state.constraints.altitude)return 0;const a=function(e,t){return t.min=e.min,t.max=e.max,t}(e.state.constraints.altitude,oi);!function(e,t,i){const a=t.interactionType;if(a===ei.NONE)return;const{min:s,max:r}=i,{interactionStartCamera:n,interactionFactor:o}=t;if(!n)return;const l=a===ei.TUMBLE||a===ei.ZOOM,c=ni(e,n),h=0===c?0:e.renderCoordsHelper.getAltitude(n.eye);i.min=s,i.max=r,ai(c,h,l,o,.05*h,i)}(e,i,a);const s=e.renderCoordsHelper.getAltitude(t.eye),r=Ae(s,a.min,a.max)-s;return Math.abs(r)<=1e-6?0:r}const oi={min:0,max:0},li=de(),ci=de(),hi=de(),pi=de();function di(e,t,i=si){if(!e.state.isLocal)return 0;const a=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||a===1/0)return 0;mi.min=0,mi.max=a,function(e,t,i){const a=t.interactionType;if(a===ei.NONE)return;const{min:s,max:r}=i,{interactionStartCamera:n,interactionFactor:o}=t;if(!n)return;const l=a===ei.ZOOM||a===ei.PAN,c=di(e,n),h=0===c?0:ui(e,n);i.min=s,i.max=r,ai(c,h,l,o,.05*h,i)}(e,i,mi);const s=ui(e,t),r=mi.max-s;return r>=-1e-6?0:r}function ui(e,t){const i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?ye(t.eye,i.renderLocation):0}const mi={min:0,max:0},yi=de(),fi=de(),gi=de(),wi=de(),_i=de();function vi(e,t,i=Ci.EYE){const a=e.state.constraints;if(!a.collision.enabled)return!1;const s=Ge(e,t.eye),r=e.renderCoordsHelper.getAltitude(t.eye),n=s+a.collision.elevationMargin;if(r>=n)return!1;const o=ge(t.eye);if(ue(Mi,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(Ti,n,t.eye),i===Ci.EYE_AND_CENTER)t.center=me(Mi,t.eye,Mi);else if(i===Ci.EYE_AND_CENTER_SCALE){const e=(o-r+n)/o;t.center=he(Mi,t.center,e)}return!0}var Ci;!function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"}(Ci||(Ci={}));const Mi=de(),Ti=de();function xi(e,t,i){e.worldUpAtPosition(t,bi),ue(Ri,i,t);const a=ge(Ri);return 0===a?0:Le(pe(Ri,bi)/a)}const bi=de(),Ri=de();function Si(e,t,i=si,a=si,s){if(!e.state.constraints.tilt)return 0;const r=t.distance,n=e.state.constraints.tilt(r,Oi);return function(e,t,i){if(t.interactionType===ei.NONE)return;const{interactionStartCamera:a,interactionFactor:s}=t;if(!a)return;const{min:r,max:n}=i,o=Si(e,a,si,t),l=0===o?0:xi(e.renderCoordsHelper,a.center,a.eye);i.min=r,i.max=n,t.interactionType===ei.TUMBLE?(ii(t.selection,Xt.ALTITUDE)&&ji(e,a,i),ai(o,l,!0,s,Fi,i)):ai(o,l,!1,s,Fi,i)}(e,i,n),a.interactionType===ei.TUMBLE&&ii(a.selection,Xt.ALTITUDE)&&ji(e,a.interactionStartCamera,n),i.tiltMode===ti.LOOK_AROUND||a.tiltMode===ti.LOOK_AROUND?function(e,t,i,a){switch(a&&(a.requiresTwoSteps=!1),e.viewingMode){case"global":return function(e,t,i,a){const s=Pi(e,t,Vi),r=Ae(s.tiltAtCenter,i.min,i.max);if(!ki(s.tiltAtCenter-r))return 0;let n,o;return s.centerIsOnSurface?(n=function(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:a}=e;let s=a,r=t.clampTilt(i,a);const n=Ei(e,r);if(t.clampTilt(n,a)===r)return r;let o=0;for(;o<10&&ki(r-s);){const i=(s+r)/2,a=Ei(e,i);ki(t.clampTilt(a,i)-i)?s=i:r=i,o++}return r}(s),o=function(e,t){const i=Fe(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),a=Fe(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-a:a-i}(s,n)):(n=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),a&&n<Math.PI/2&&(a.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=function(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}(s,n)),a&&(a.eyeCenterDistance=Ei(s,n)),o}(e,t,i,a);case"local":return function(e,t,i,a){const s=xi(e.renderCoordsHelper,t.center,t.eye),r=Ae(s,i.min,i.max),n=s-r;if(!ki(n))return 0;if(a){const i=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=e.renderCoordsHelper.getAltitude(t.eye)-i,n=Math.cos(r);Math.abs(n)>1e-4?a.eyeCenterDistance=s/n:a.eyeCenterDistance=t.distance}return n}(e,t,i,a)}}(e,t,n,s):function(e,t,i){const a=xi(e.renderCoordsHelper,t.center,t.eye),s=a-Ae(a,i.min,i.max);return ki(s)?s:0}(e,t,n)}function Pi(e,t,i){const a=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=a+B(e.spatialReference).radius,r=e.renderCoordsHelper.intersectManifold(t.ray,a,Li);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,y(r)?(i.eyeCenterDistance=ye(t.eye,r),i.tiltAtCenter=xi(e.renderCoordsHelper,r,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=xi(e.renderCoordsHelper,t.center,t.eye):(qe(We(He,s),t.ray,Li),i.eyeCenterDistance=ye(t.eye,Li),i.tiltAtCenter=Le(-pe(t.viewForward,_e(Li,Li)))),i.radius=s,i.eyeRadius=ge(t.eye),i.constraints=e.state.constraints,i}function ki(e){return Math.abs(e)>1e-9}function Ei(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-Ae(t,0,Math.PI),a=Fe(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-a,r=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&r>1){const t=Math.PI-a,s=Math.PI-i-t;return Math.sin(s)/Math.sin(i)*e.eyeRadius}return r*e.eyeRadius}function ji(e,t,i){const a=e.state.constraints;if(e.state.isLocal||!a.altitude||!t)return;const s=ve(t.center),r=Math.sqrt(s),n=t.distance,o=B(e.spatialReference).radius,l=a.altitude.min+o,c=a.altitude.max+o,h=(l*l-n*n-s)/(-2*r*n),p=(c*c-n*n-s)/(-2*r*n);i.min=Math.max(i.min,Math.min(Math.PI-Le(p),i.max)),i.max=Math.min(i.max,Math.PI-Le(h))}const Ii=de(),Ai=ht(),Li=de(),Fi=Oe(5),Oi={min:0,max:0},Vi={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},Ni={eyeCenterDistance:0,requiresTwoSteps:!1},Di=e=>e*e,zi=e=>1-Di(1-e),Ui=e=>e*e*e,Zi=e=>1-Ui(1-e),qi=e=>e<.5?Ui(2*e)/2:(Zi(2*(e-.5))+1)/2,Wi=e=>e*e*e*e,Hi=e=>1-Wi(1-e),Gi=e=>e*e*e*e*e,Bi=e=>1-Gi(1-e),Ki=e=>1-Math.cos(e*Math.PI/2),Yi=e=>1-Ki(1-e),Qi=e=>2**(10*(e-1)),$i=e=>1-Qi(1-e),Ji=e=>-(Math.sqrt(1-e*e)-1),Xi=e=>1-Ji(1-e);function ea(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return a=>a<i?e*a*a:t*a-t+1}function ta(e,t){return(i,a)=>i<t?t*e(i/t,a):1-e((1-i)/(1-t),a)*(1-t)}const ia=ta(ea(1),1),aa=ta(ea(1),0),sa=ta(ea(1),.5),ra=ta(ea(2),1),na=ta(ea(2),0),oa=ta(ea(2),.5),la=ta(ea(3),1),ca=ta(ea(3),0),ha=ta(ea(3),.5),pa=ta(ea(4),1),da=ta(ea(4),0),ua=ta(ea(4),.5),ma={linear:function(e){return e},"in-quad":Di,"out-quad":zi,"in-out-quad":e=>e<.5?Di(2*e)/2:(zi(2*(e-.5))+1)/2,"in-coast-quad":ia,"out-coast-quad":aa,"in-out-coast-quad":sa,"in-cubic":Ui,"out-cubic":Zi,"in-out-cubic":qi,"in-coast-cubic":ra,"out-coast-cubic":na,"in-out-coast-cubic":oa,"in-quart":Wi,"out-quart":Hi,"in-out-quart":e=>e<.5?Wi(2*e)/2:(Hi(2*(e-.5))+1)/2,"in-coast-quart":la,"out-coast-quart":ca,"in-out-coast-quart":ha,"in-quint":Gi,"out-quint":Bi,"in-out-quint":e=>e<.5?Gi(2*e)/2:(Bi(2*(e-.5))+1)/2,"in-coast-quint":pa,"out-coast-quint":da,"in-out-coast-quint":ua,"in-sine":Ki,"out-sine":Yi,"in-out-sine":e=>e<.5?Ki(2*e)/2:(Yi(2*(e-.5))+1)/2,"in-expo":Qi,"out-expo":$i,"in-out-expo":e=>e<.5?Qi(2*e)/2:($i(2*(e-.5))+1)/2,"in-circ":Ji,"out-circ":Xi,"in-out-circ":e=>e<.5?Ji(2*e)/2:(Xi(2*(e-.5))+1)/2};function ya(e,t,i=wa,a=t){a!==t&&a.copyFrom(t),a.computeUp(e.state.viewingMode);let s=!1;for(let t=0;t<_a;t++){let t=0;for(const r of ga)if(ii(i.selection,r.type)){const n=Math.abs(r.error(e,a,i));r.apply(e,a,i)&&(s=!0,t+=n)}if(0===t)break}const r=ii(i.selection,Xt.COLLISION),n=function(e,t){switch(e){case ei.PAN:return Ci.EYE_AND_CENTER;case ei.ASCEND:return t.state.isGlobal?Ci.EYE_AND_CENTER_SCALE:Ci.EYE_AND_CENTER;default:return Ci.EYE}}(i.interactionType,e);return r&&vi(e,a,n)&&(s=!0),s&&a.computeUp(e.state.viewingMode),s}function fa(e){const t=Math.min(1,e/150);return qi(t)}const ga=[{type:Xt.TILT,error:function(e,t,i){return Si(e,t,i)*t.distance},apply:function e(t,i,a=si,s=!0){Ni.eyeCenterDistance=0,Ni.requiresTwoSteps=!1;const r=Si(t,i,a,void 0,Ni);if(0===r)return!1;switch(ct(Ai,-r,i.viewRight),a.tiltMode){case ti.LOOK_AROUND:we(Ii,i.viewForward,Ai),he(Ii,Ii,Ni.eyeCenterDistance),i.center=me(Li,i.eye,Ii);break;case ti.TUMBLE:ue(Ii,i.center,i.eye),we(Ii,Ii,Ai),i.eye=ue(Li,i.center,Ii);break;default:lt(a.tiltMode)}return i.up=we(Li,i.up,Ai),!Ni.requiresTwoSteps||!s||e(t,i,a,!1)}},{type:Xt.ALTITUDE,error:ni,apply:function(e,t,i=si){const a=ni(e,t,i);if(0===a)return!1;const s=e.renderCoordsHelper,r=s.getAltitude(t.eye)+a,n=ri(t,i.interactionDirection,function(e,t,i,a){return e.renderCoordsHelper.worldUpAtPosition(t.eye,a),he(a,a,i),a}(e,t,Math.sign(a),ci),li),o=ce(hi,t.viewForward),l=s.intersectInfiniteManifold(De(t.eye,n),r,pi);return t.eye=y(l)?l:s.setAltitude(pi,r,t.eye),t.center=ze(pi,t.eye,o,t.center),!0}},{type:Xt.DISTANCE,error:di,apply:function(e,t,i=si){const a=di(e,t,i);if(0===a)return!1;const s=e.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const r=ui(e,t)+a,n=ce(yi,t.eye),o=ri(t,i.interactionDirection,function(e,t,i){return fe(wi,e.eye,t)}(t,s.renderLocation),gi);if(!Ue(Ze(s.renderLocation,r),De(t.eye,o),_i))return!1;t.eye=_i;const l=ue(fi,t.eye,n);t.center=me(_i,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,_i);return y(h)&&(t.center=h),!0}}],wa={selection:Xt.ALL,interactionType:ei.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ti.TUMBLE},_a=5;function va(e){return Ae((e-1e5)/9e5,0,1)}const Ca=1e4,Ma=.085,Ta=1e5;class xa{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=B(t),this._unitInMeters=K(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,i,a,s){s||(s={near:0,far:0});let r=e[2]*this._unitInMeters;const n=r,o=r-a,l=this._elevationProvider?.visibleElevationBounds;l&&(r=o>=0?n-this._unitInMeters*l.min:this._unitInMeters*l.max-n);const c={x:(i=y(i)?i:new W({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},h=Math.max(c.x,c.y,c.z);ue(Ia,t,e),ja[0]=Ia[0]>0?i.xmax:i.xmin,ja[1]=Ia[1]>0?i.ymax:i.ymin,ja[2]=Ia[2]>0?h/2:-h/2,ue(ja,ja,e),_e(Ia,Ia);const p=1.1*pe(ja,Ia)*this._unitInMeters,d=Math.sqrt(r*(r+2*this._referenceEllipsoid.radius)),u=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),m=u*ka*this._unitInMeters,f=u*Ea*this._unitInMeters,g=Ae((r-f)/(m-f),0,1)**3,w=Math.min(Ve(d,p,g),d)*Math.max(Math.log(Math.abs(o)),1);return Ra(Math.min(w,Math.max(34064e4,h))/this._unitInMeters,Sa,this._unitInMeters,s)}}class ba{constructor(e){this._referenceEllipsoid=B(e)}compute(e,t,i,a,s){s||(s={near:0,far:0});const r=ge(e),n=r-this._referenceEllipsoid.radius,o=this._referenceEllipsoid.radius+Math.min(0,a),l=Math.abs(n-a),c=Math.max(l,Math.abs(n)),h=Math.sqrt(c*(c+2*o)),p=r+this._referenceEllipsoid.radius;return Ra(1.2*Ve(h,p,va(c)),Ae(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,s)}}function Ra(e,t,i,a){const s=Pa/i;return e/t>s?(a.far=e,a.near=a.far/t):(a.near=s,a.far=a.near*t),a}const Sa=2e4,Pa=2,ka=.001,Ea=1e-4,ja=de(),Ia=de();let Aa=class extends a{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e))))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;y(e.spatialReference)&&Be(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera((e=>vi(this.view,e,Ci.EYE_AND_CENTER)))}};e([V({constructOnly:!0})],Aa.prototype,"view",void 0),Aa=e([z("esri.views.3d.state.ElevationCollisionConstraint")],Aa);let La=class extends a{constructor(e){var t,i,a;super(e),this.nearFarHeuristic=(t=e.view.state.viewingMode,i=e.view.basemapTerrain,a=e.view.renderCoordsHelper.spatialReference,t===Ie.Global?new ba(a):new xa(i,a))}initialize(){this.addHandles([j((()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far]),(()=>this._clipDistanceNearFarChanged())),j((()=>this.view.constraints?.clipDistance?.mode),(()=>this._updateNearFar())),this.view.state.events.on("before-camera-change",(e=>this._updateCameraNearFar(e))),j((()=>this.view.renderDataExtent),(()=>this._updateNearFar()),A),j((()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max]),(()=>this._updateAltitude()),A),j((()=>this.view.constraints?.tilt?.max),(()=>this._updateTiltMax()),A),j((()=>this.view.constraints?.tilt?.mode),(()=>this._updateTilt()),A),j((()=>this.view.state?.camera),(()=>this._updateTiltAutoMax()),A),j((()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled]),(()=>this._updateCollision()),A)]),this.view.state.isLocal&&this.addHandles(j((()=>this.view.renderDataExtent),(e=>this._updateLocalSurfaceDistance(e)),L)),this._updateNearFar(),this.view.state.viewingMode!==Ie.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Aa({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&"auto"!==e.mode&&this.view.state.updateCamera((t=>this._updateCameraNearFarManual(t,e)))}_updateNearFar(){this.view.state.updateCamera((e=>this._updateCameraNearFar(e)))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;"manual"===(t?t.mode:"auto")?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,Ge(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,t=!e||"stay-above"===e,i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(Xt.COLLISION);const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Ie.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&"auto"!==e.mode&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;"manual"===(e?e.mode:"auto")?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(Oe(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||"auto"!==e.mode)return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(Ne(i))}}_updateLocalSurfaceDistance(e){if(m(e))return;let t=Math.max(e.width,e.height);if(t<=0)return;null!=e.zmax&&null!=e.zmin&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,a=3*t/Math.atan(i.camera.fov/2);a!==i.constraints.distance&&(i.constraints.distance=a)}_reapplyConstraints(e=Xt.ALL){this.view.state.updateCamera((t=>ya(this.view,t,{selection:e,interactionType:ei.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:ti.TUMBLE})))}};e([V({constructOnly:!0})],La.prototype,"view",void 0),e([V({readOnly:!0})],La.prototype,"surfaceCollisionConstraint",void 0),La=e([z("esri.views.3d.state.ConstraintsManager")],La);class Fa{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}constructor(e){this.renderCoordsHelper=e,this.frustum=dt(),this._points=ut(),this.lines=new Array(12),this._origin=de(),this._direction=de(),this._altitude=null;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:de(),endpoint:null}}update(e){mt(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),ce(this._origin,e.eye),ce(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)ce(this._points[t],e[t]);yt(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return ft(this.frustum,e)}intersectsRay(e){return gt(this.frustum,e)}intersectsLineSegment(e,t){return wt(this.frustum,e,t)}intersectsPoint(e){return _t(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const i=t+4;Oa(this.lines[t],e[t],e[i]),Oa(this.lines[t+4],e[t],3===t?e[0]:e[t+1]),Oa(this.lines[t+8],e[i],3===t?e[4]:e[i+1])}}}function Oa(e,t,i){e.origin=t,e.endpoint=i,fe(e.direction,t,i)}var Va;Fa.planePointIndices=vt,Fa.nearFarLineIndices=[[pt.NEAR_BOTTOM_LEFT,pt.FAR_BOTTOM_LEFT],[pt.NEAR_BOTTOM_RIGHT,pt.FAR_BOTTOM_RIGHT],[pt.NEAR_TOP_RIGHT,pt.FAR_TOP_RIGHT],[pt.NEAR_TOP_LEFT,pt.FAR_TOP_LEFT]],function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"}(Va||(Va={}));let Na=class extends a{constructor(e){super(e),this.state=Va.Ready}get active(){return this.state===Va.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=Va.Stopped,!0)}finishController(){this.state=Va.Finished}get steppingFinished(){return!1}};e([V({constructOnly:!0})],Na.prototype,"view",void 0),e([V({readOnly:!0})],Na.prototype,"active",null),e([V()],Na.prototype,"state",void 0),e([V({readOnly:!0})],Na.prototype,"isInteractive",null),Na=e([z("esri.views.3d.state.controllers.CameraController")],Na);const Da=de(),za=de(),Ua=de(),Za=de(),qa=de(),Wa=de(),Ha={upward:be(0,0,1),forward:be(0,1,0),sideway:be(1,0,0)},Ga=Tt();class Ba{constructor(e=Ie.Global){this.viewingMode=e,this.center=de(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=Ce(Ha.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Ie.Global){const i=(ge(this.center)+ge(e.center))/2;t.pan=xt(this.center,e.center)*i}else t.pan=ye(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const a=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(i,a),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,i){this.viewingMode===Ie.Global?bt(e.center,t.center,i.pan,this.center):Me(this.center,e.center,t.center,i.pan),this.distance=isFinite(t.distance)?Ve(e.distance,t.distance,i.zoom):e.distance,this.pitch=Ve(e.pitch,t.pitch,i.rotate);let a=e.yaw;const s=t.yaw;Math.abs(s-a)>=Math.PI&&(a+=2*(a<s?1:-1)*Math.PI),this.yaw=Ve(a,s,i.rotate)}copyFrom(e){ce(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,ce(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,Ga);ce(this.center,e.center),ue(Za,e.center,e.eye),Te(Za,Za,t),Te(qa,e.up,t),this.distance=ge(Za),0!==this.distance&&(Za[0]/=this.distance,Za[1]/=this.distance,Za[2]/=this.distance),this.pitch=this._eyeUpToPitch(Za),this.yaw=this._eyeUpToYaw(Za,qa),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,Ga);Mt(t,t),this._axisAngleVec3(Ha.sideway,this.pitch-Math.PI/2,Ha.forward,Za),this._axisAngleVec3(Ha.upward,this.yaw,Za),this._axisAngleVec3(Ha.sideway,this.pitch-Math.PI/2,Ha.upward,qa),this._axisAngleVec3(Ha.upward,this.yaw,qa),he(Za,Za,this.distance),Te(Za,Za,t),Te(qa,qa,t),e.center=this.center,e.eye=ue(Za,this.center,Za),e.up=qa}_axisAngleVec3(e,t,i,a=i){const s=Math.cos(t),r=Math.sin(t);return he(Da,i,s),xe(za,e,i),he(za,za,r),he(Ua,e,(1-s)*pe(e,i)),me(a,me(a,Da,za),Ua)}_lookAtOrientation(e,t=Tt()){return this._upAtLookAt(e,Ua),xe(Da,this.lookAtDirection,Ua),_e(Da,Da),0===Da[0]&&0===Da[1]&&0===Da[2]&&ce(Da,Ha.sideway),xe(za,Ua,Da),_e(za,za),t[0]=Da[0],t[1]=za[0],t[2]=Ua[0],t[3]=Da[1],t[4]=za[1],t[5]=Ua[1],t[6]=Da[2],t[7]=za[2],t[8]=Ua[2],t}_upAtLookAt(e,t){return this.viewingMode===Ie.Local?ce(t,Ha.upward):_e(t,e)}_eyeUpToPitch(e){return Math.PI-xt(Ha.upward,e)}_eyeUpToYaw(e,t){const i=Wa;return Math.abs(t[2])<.5?(ce(i,t),e[2]>0&&he(i,i,-1)):ce(i,e),xe(za,i,Ha.upward),_e(za,za),xt(Ha.sideway,za,Ha.upward)}}const Ka=X(500),Ya=X(8e3);class Qa{constructor(e){this._createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:2},this.source=e(),this.target=e()}clone(){const e=new Qa(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,i){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=null!=i.desiredScreenFlow?i.desiredScreenFlow:2,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}let $a=class{constructor(){this.segments=[]}get time(){return this.segments.reduce(((e,t)=>ee(e+t.time)),ee(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,a=0;const s=this.definition;for(let r=0;r<this.segments.length;r++){const n=this.segments[r],o=n.definition;if(e<=n.time||r===this.segments.length-1){if(t=this.segmentInterpolateComponentsAt(n,0===n.time?0:e/n.time,t),s.hasPan&&!isNaN(t.pan)&&isFinite(s.compared.pan)?t.pan=(i+o.compared.pan*t.pan)/s.compared.pan:t.pan=1,s.hasRotate&&!isNaN(t.rotate)&&isFinite(s.compared.rotate)?t.rotate=(a+o.compared.rotate*t.rotate)/s.compared.rotate:t.rotate=1,s.hasZoom&&!isNaN(t.zoom)&&isFinite(o.compared.targetZoom)){const e=t.zoom*(o.compared.targetZoom-o.compared.sourceZoom)+o.compared.sourceZoom,i=this.segments[0].definition.compared.sourceZoom,a=this.segments[this.segments.length-1].definition.compared.targetZoom;t.zoom=(e-i)/(a-i)}else t.zoom=1;return t}e-=n.time,i+=o.compared.pan,a+=o.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){return e.interpolateComponentsAt(t,i)}};class Ja{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,i=t.sourceZoom,a=t.targetZoom;this._zoomSign=i>a?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(i);const s=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(a))/2;this._rotatePixels=t.rotate*s}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:i,hasPan:a,hasRotate:s}=this.definition;let r=0,n=0;i&&(a&&(r=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(n=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const o=this.definition.desiredPixelFlow;if(i&&a&&s){const e=r+n+r*n;this._zoomPixelFlow=r*n/e*o,this._panPixelFlow=n/e*o,this._rotatePixelFlow=r/e*o}else if(i&&a){const e=1+r;this._zoomPixelFlow=r/e*o,this._panPixelFlow=1/e*o}else if(i&&s){const e=1+n;this._zoomPixelFlow=n/e*o,this._rotatePixelFlow=1/e*o}else if(a&&s){const e=this._panPixelsAtSource/this._rotatePixels,t=1+e;this._panPixelFlow=e/t*o,this._rotatePixelFlow=1/t*o}else a?this._panPixelFlow=o:i?this._zoomPixelFlow=o:s&&(this._rotatePixelFlow=o);this._time=s?this.rotateTime:i?this.zoomTime:a?this.panTime:ee(0)}get rotateTime(){return this.definition.hasRotate?ee(this._rotatePixels/this._rotatePixelFlow):ee(0)}get zoomTime(){return this.definition.hasZoom?ee(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):ee(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return ee(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return ee(this._panPixelsAtSource/this._panPixelFlow)}return ee(0)}_interpolateComponentsZoom(e){if(0===e||1===e)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(t*(t/i)**-e-t)/(i-t)}return e}_interpolateComponentsPan(e){if(0===e||1===e)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),a=this._interpolateComponentsPan(e),s=this._interpolateComponentsRotate(e);return t?(t.zoom=i,t.pan=a,t.rotate=s):t={zoom:i,pan:a,rotate:s},t}}function Xa(e,t,i){const a=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(a);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function es(e,t,i){const a=1/t,s=Math.log(e.compared.sourceZoom*a),r=1/e.desiredPixelFlow,n=1/Math.LN2,o=t-e.compared.sourceZoom,l=1/o,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(o))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*a*r*n*l*c-e.halfWindowSize*s*r*n*l+e.halfWindowSize*s*r*n*c/(o*o)}function ts(e,t,i){const a=t-e.compared.sourceZoom,s=1/a,r=1/t,n=Math.log(e.compared.sourceZoom*r),o=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(a))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*r*o+2*s*n+2*r-2*n*o/(a*a)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function is(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function as(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function ss(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function rs(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function ns(e,t,i){const a=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,r=1/Math.LN2,n=-t+e.compared.targetZoom,o=1/n,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*a*s*r*o+e.halfWindowSize*a*s*r*l/(n*n)+e.halfWindowSize*s*r*o*l/t}function os(e,t,i){const a=t-e.compared.targetZoom,s=1/a,r=1/t,n=Math.log(t/e.compared.targetZoom),o=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*r*o-2*s*n+2*r+2*n*o/(a*a)-o/(t*t))/(e.desiredPixelFlow*Math.LN2)}function ls(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function cs(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function hs(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}class ps extends $a{constructor(e,t){super(),this._preallocSegments=[new Ja,new Ja,new Ja],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;t&&t.apex&&(i=function(e,t){let i=function(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),a=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return a<i?null!=t.maximumDistance?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,a):a}(e,t);const a={ascensionFactor:null!=t.ascensionFactor?t.ascensionFactor:.5,descensionFactor:null!=t.descensionFactor?t.descensionFactor:.5},s=0===a.ascensionFactor,r=0===a.descensionFactor,n=s?is:Xa,o=s?as:es,l=s?ss:ts,c=r?ls:rs,h=r?cs:ns,p=r?hs:os,d=t=>n(e,t,a)+function(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}(e,t,a)+c(e,t,a),u=t=>o(e,t,a)+function(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}(e,t,a)+h(e,t,a),m=t=>l(e,t,a)+function(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}(e,t,a)+p(e,t,a);let y=d(i);const f=function(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,a=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*a);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-a):s*(t+a)}(e);let g;const w=t.maximumIterations||20,_=null!=t.maximumDistance?t.maximumDistance:1/0;for(g=0;g<w;g++){const t=1e-6,a=(u(i)+t)/m(i);if(isNaN(a)||i>=_&&a<0){if(!isFinite(_))return null;i=_,y=d(i);break}if(i-=a,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const s=d(i);if(Math.abs(s-y)/y<=.005)break;y=s}return y>.7*f||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,null==i?this._updateWithoutApex():this._updateWithApex(i,t?.apex)}segmentInterpolateComponentsAt(e,t,i){return i=e.interpolateComponentsAt(t,i),e===this._ascensionSegment?i.zoom=zi(i.zoom):e===this._descensionSegment&&(i.zoom=Di(i.zoom)),i}_updateWithApex(e,t){const[i,a,s]=this._preallocSegments,r=t?.ascensionFactor??.5,n=Math.min(1-r,null!=t?.ascensionFactor&&null!=t.descensionFactor?t.descensionFactor:.5),o=1-r-n;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*r,i.definition.compared.rotate=this.definition.compared.rotate*r,i.update(),this._ascensionSegment=i,this.segments.push(i),o>0&&(a.definition?a.definition.copyFrom(this.definition):a.definition=this.definition.clone(),a.definition.copyFrom(this.definition),a.definition.compared.sourceZoom=e,a.definition.compared.targetZoom=e,a.definition.compared.pan=this.definition.compared.pan*o,a.definition.compared.rotate=this.definition.compared.rotate*o,a.update(),this.segments.push(a)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=e,s.definition.compared.pan=this.definition.compared.pan*n,s.definition.compared.rotate=this.definition.compared.rotate*n,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}}const ds={zoom:0,pan:0,rotate:0},us=de();class ms{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=X(0),this._animation=new class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=X(0),this.definition=new Qa(e),this.path=new ps}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(te(isFinite(this.path.time)?this.path.time:ee(0)),i),this._easing=i.easing??(this._time>=1e3?sa:$i)}cameraAt(e,t){t=t||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,ds);return t.interpolate(this.definition.source,this.definition.target,i),t}_normalizedEasing(e){const t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){const i=null!=t.speedFactor?t.speedFactor:1;null!=t.duration?e=t.duration:null!=t.speedFactor&&(e=X(e/i));const a=null!=t.minDuration?t.minDuration:Ka/i,s=null!=t.maxDuration?t.maxDuration:Ya/i;return X(Math.min(Math.max(a,e),s))}}((()=>new Ba(e))),this._current=new Ba(e)}update(e,t,i){const a=this._animation.definition.source,s=this._animation.definition.target,r=ue(us,t.center,e.center),n=ge(r);n>=1e-5?(r[0]/=n,r[1]/=n,r[2]/=n):(r[0]=0,r[1]=1,r[0]=0),ce(a.lookAtDirection,r),ce(s.lookAtDirection,r),a.copyFromRenderCamera(e),s.copyFromRenderCamera(t),this._current.copyFrom(a),this._animation.update(a,s,i),this.currentTime=X(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Rt,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=X(this.currentTime+te(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}}let ys=class extends Na{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(x()),this._asyncResult=null),this.state===Va.Finished||this.state===Va.Stopped?(g(e),this.state===Va.Finished?e.resolve():e.reject(x())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=Va.Running,y(this.viewAnimation)&&this.viewAnimation.when((()=>this.updateStateFromViewAnimation()),(()=>this.updateStateFromViewAnimation()))}updateStateFromViewAnimation(){!y(this.viewAnimation)||this.state!==Va.Ready&&this.state!==Va.Running||(this.viewAnimation.state===Ct.State.FINISHED?this.finish():this.viewAnimation.state===Ct.State.STOPPED&&(this.state=Va.Stopped))}onControllerEnd(){y(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===Va.Finished?this.viewAnimation.finish():this.state===Va.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Va.Finished?this._asyncResult.resolve():this._asyncResult.reject(x()))}finish(){this.finishController()}};ys=e([z("esri.views.3d.state.controllers.AnimationController")],ys);let fs=class extends ys{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new ms(this.view.state.viewingMode),this.viewAnimation="interaction"===this.mode?null:new Ct}get isInteractive(){return"interaction"===this.mode}begin(e,t){this._hasTarget=!0;const i=this.animationSettings(t);gs.copyFrom(this.view.state.camera);const a=Pt(this.view.state.viewingMode);this.intersectionHelper.intersectRay(gs.ray,a,ws)&&(gs.center=ws),this.animation.update(gs,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:"string"==typeof e.easing?ma[e.easing]:e.easing}}};e([V({constructOnly:!0})],fs.prototype,"mode",void 0),e([V({readOnly:!0})],fs.prototype,"isInteractive",null),fs=e([z("esri.views.3d.state.controllers.PointToPointAnimationController")],fs);const gs=new Rt,ws=de();let _s=class extends Na{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e),this._handles=new kt}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=Va.Running,this._handles.add(this.view.basemapTerrain.on("elevation-change",(e=>this._handleElevationChangeEvent(e)))),this._applyCorrection()}onControllerEnd(){this._handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){y(e.spatialReference)&&!Be(this.view,this.desiredCamera,e.extent,e.spatialReference)||this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera((e=>{e.copyViewFrom(this.desiredCamera),vi(this.view,e,Ci.EYE_AND_CENTER)||this.constraintEnabled||(this.state=Va.Stopped)}))}};e([V({constructOnly:!0})],_s.prototype,"desiredCamera",null),_s=e([z("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],_s);class vs{constructor(e,t,i){this.target=e,this.options=t,this.view=i,this.state="pending",this._animationController=null,this._promise=new Promise(((e,t)=>{this._resolveCallback=e,this._rejectCallback=t;const i=new AbortController;y(this.options.signal)&&R(this.options.signal,(()=>{this.abort()})),this._abortController=i,this.waitForReady()}))}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}resolve(e){if("finished"!==this.state)return this.state="finished",this._resolveCallback(e)}reject(e){if("finished"!==this.state)return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),"wait-for-animation-finish"===this.state&&!e&&y(this._animationController)&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject(x())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await F((()=>this.view.ready),this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}createViewPoint(){"finished"!==this.state&&(this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null,Ke(this.view,this.target,this._abortController.signal).then((e=>{if("finished"===this.state)return;const t=e?this._getCameraFromViewpoint(e):null;if(!m(t))if(this.options.animate){if(m(this._animationController))return;this.startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()}),(e=>{this.reject(e)})))}_getCameraFromViewpoint(e){const t=!!(this.target instanceof oe&&this.target.camera||this.target instanceof ne),i=e.camera;if(m(i))return null;if(!this.view.stateManager.isCompatible(i)){const e=i.position,t=e&&e.spatialReference,a=t?t.wkid:"none",s=this.view.spatialReference?.wkid;return this.reject(new o("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${s})`,{camera:i})),null}const a=Ye(this.view,i);return m(a)?(this.reject(new o("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:a,isFullySpecified:t}}startAnimation(e,t){this.state="wait-for-animation-finish";const i=t.viewAnimation;if(m(i))return void this.reject(new o("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!t.active||m(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let a;e.isFullySpecified?(a=new _s({view:this.view,desiredCamera:e.camera}),vi(this.view,e.camera,Ci.EYE_AND_CENTER)):ya(this.view,e.camera),t.begin(e.camera,this.options);const s=e=>{if(!m(this.view.state))switch(t.state){case Va.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case Va.Ready:case Va.Rejected:case Va.Running:case Va.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(e)}}};i.when((()=>{const i=this.view.state.cameraController;a&&(i&&i.active?i instanceof fs&&y(i.viewAnimation)&&i.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=a):y(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&"finished"===t.state&&(this.view.state.cameraController=a))}),(e=>s(e))),t.asyncResult={resolve:()=>s(),reject:e=>s(e)}}_getAnimationController(){let e=null,t=null;const i=this.view.state.cameraController;return i instanceof fs&&(i.updateStateFromViewAnimation(),i.active&&(e=i,t=e.viewAnimation)),null!=e||(e=new fs({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(y(t)&&t.stop(),this.reject(new o("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}var Cs;function Ms(e=D("enable-feature:high-quality-idle")){const t=new It;return e&&(t.set(At.INTERACTING,Cs.Antialiasing,!0),t.set(At.IDLE,Cs.Antialiasing,!0),t.set(At.INTERACTING,Cs.HighQualityTransparency,!0),t.set(At.IDLE,Cs.HighQualityTransparency,!0),t.set(At.INTERACTING,Cs.RealisticAtmosphere,!0),t.set(At.IDLE,Cs.RealisticAtmosphere,!0),t.set(At.IDLE,Cs.SSAO,!0),t.set(At.IDLE,Cs.WaterReflection,!0),t.set(At.IDLE,Cs.PhysicalPixelRendering,!0)),t.set(At.ANIMATING,Cs.ShadowMapUpdate,!0),t.set(At.INTERACTING,Cs.ShadowMapUpdate,!0),t.set(At.IDLE,Cs.ShadowMapUpdate,!0),t.set(At.IDLE,Cs.HighQualityVoxel,!0),t}!function(e){e[e.Antialiasing=0]="Antialiasing",e[e.HighQualityTransparency=1]="HighQualityTransparency",e[e.HighQualityVoxel=2]="HighQualityVoxel",e[e.RealisticAtmosphere=3]="RealisticAtmosphere",e[e.SSAO=4]="SSAO",e[e.WaterReflection=5]="WaterReflection",e[e.ShadowMapUpdate=6]="ShadowMapUpdate",e[e.PhysicalPixelRendering=7]="PhysicalPixelRendering"}(Cs||(Cs={})),D.add("enable-feature:high-quality-idle",!0);let Ts=class extends a{get camera(){const e=this._get("camera");if(!this.ready)return e;const t=Qe(this.view,this.view.state.camera,Ss);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableElevationCache(!0),this.setStateCamera(Ye(this.view,e),{applyConstraints:!1})||u.getLogger(this.declaredClass).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=Qe(this.view,this.view.state.contentCamera,Ss);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Ye(this.view,e);m(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.removeHandles(js),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,a=Re(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.addHandles([j((()=>this.contentCamera),(()=>{e.sticky||(this.removeHandles(js),this.test.contentCameraResetState.clear())})),j((()=>this.zoom),(e=>{void 0!==e&&void 0!==t&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(e-t)/2),Math.abs(e-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s))})),j((()=>this.view.state.camera),(e=>{const t=Se(a,e.center);this.test.contentCameraResetState.set("camera.center",t/i),t>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}))],js),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():u.getLogger(this.declaredClass).error("#center=","Invalid center",e):u.getLogger(this.declaredClass).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):u.getLogger(this.declaredClass).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=$e(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return y(t)?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||u.getLogger(this.declaredClass).error("#extent=","Invalid extent",e):u.getLogger(this.declaredClass).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):u.getLogger(this.declaredClass).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Je(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||u.getLogger(this.declaredClass).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,a=this._get("padding"),s=Math.round(t[St.TOP]/i),r=Math.round(t[St.RIGHT]/i),n=Math.round(t[St.BOTTOM]/i),o=Math.round(t[St.LEFT]/i);return null!=a&&a.top===s&&a.right===r&&a.bottom===n&&a.left===o?a:{top:s,right:r,bottom:n,left:o}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,ks),this.view.state.updateCamera((e=>e.padding=ks)))}_paddingToArray(e,t,i){e?Pe(i,e.top||0,e.right||0,e.bottom||0,e.left||0):Pe(i,0,0,0,0);for(let e=0;e<4;e++)i[e]=Math.round(i[e]*t)}get screenCenter(){const e=this.padding;return le((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?Xe(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||u.getLogger(this.declaredClass).error("#viewpoint=","Invalid viewpoint",e);else{const t=y(e.camera)?e.camera.position:e.targetGeometry,i=y(t)&&t.spatialReference;u.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else u.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?et(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||void 0===e||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||u.getLogger(this.declaredClass).error("#zoom=","Invalid zoom",e)}get _pixelRatio(){return y(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRendering?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view?.qualitySettings.maximumPixelRatio)}get _rasterPixelRatio(){return y(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?._stage?.renderer.isFeatureEnabled(Cs.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?._stage?.renderer;return e&&(e.isFeatureEnabled(Cs.PhysicalPixelRendering,At.IDLE)||e.isFeatureEnabled(Cs.PhysicalPixelRendering,At.INTERACTING)||e.isFeatureEnabled(Cs.PhysicalPixelRendering,At.ANIMATING))}constructor(e){super(e),this._propertiesPool=new jt({frustum:Fa},this),this._cameraSetByUser=!1,this._gotoOperation=null,this.constraintsManager=null,this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._cameraChangeTime=0,this._updatingIgnoreRenderState=!1,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:e=>this._devicePixelRatioOverride=e,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},set updatingIgnoreRenderState(e){this.viewStateManager._updatingIgnoreRenderState=e},get updatingIgnoreRenderState(){return this.viewStateManager._updatingIgnoreRenderState||y(this.renderState)}}}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([E((()=>this.view.state.events),"before-camera-change",(e=>e&&this._updateElevation(e))),j((()=>this.view.state?.camera),((e,t)=>this._cameraChangedHandler(e,t)),A)]),O((()=>this.view.state?.camera),(e=>this._updateElevation(e)),{once:!0,sync:!0}),this.addHandles([ie({prepare:()=>this._prepareFrame()}),j((()=>this.view.state.cameraController),(()=>{this._cameraSetByUser=!0,this.removeHandles(Es)})),E((()=>this.view.state.events),"camera-projection-changed",(()=>this.notifyChange("scale")))])}destroy(){this.exit(),this._propertiesPool=w(this._propertiesPool)}init(){this.constraintsManager=new La({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const e=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;e&&this.isCompatible(e)?this._setInitialView(e):this.view.state.viewingMode===Ie.Local&&this.addHandles(O((()=>this.view.basemapTerrain.ready),(()=>{this.removeHandles(Es),this._setInitialView(this.view.dataExtent)}),{once:!0,initial:!0}),Es)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(Es),this.constraintsManager=w(this.constraintsManager))}async goTo(e,t){const i={animate:!0,...t};return y(this._gotoOperation)&&this._gotoOperation.abort(i.animate),this._gotoOperation=new vs(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation}debugSetCameraOnContent(){this.setStateCamera(tt(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t?.cameraController;i&&(t.updateCamera((t=>i.stepController(e,t))),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){y(this._gotoOperation)&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:a}of bs){const s=e.has(i),r=this._isOverridden(i);!s&&r&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||r)&&a.forEach((t=>e.add(t)))}return t}_setInitialView(e){if(m(e)||this._cameraSetByUser)return;if(e instanceof ne)return void this.setStateCamera(Ye(this.view,e),{applyConstraints:!1});if(e instanceof oe){if(e.targetGeometry instanceof W){const t=it(this.view,e.targetGeometry,0,.5,at.LOCKED);return void(y(t)&&this.setStateCamera(Ye(this.view,t),{applyConstraints:!0}))}const t={applyConstraints:!e.camera},i=this._viewpointToCamera(e);return void this.setStateCamera(i,t)}const t=it(this.view,e,0,.5,at.LOCKED);y(t)&&this.setStateCamera(Ye(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&xs.includes(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!m(e)&&(e instanceof oe?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof ne?this.isCompatible(e.position):e.spatialReference&&je(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=Rs){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=Ps){const{heading:a,tilt:s}=this._getPreservingHeadingTilt(),r=st(this.view,a,s,e,t,at.ADJUST);return m(r)?null:(i.copyFrom(this.view.state.camera),i.eye=r.eye,i.center=r.center,i.up=r.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),a=it(this.view,e,t,i,at.ADJUST,Ss);return a?Ye(this.view,a):null}_scaleToCamera(e){if(null==e)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,a=t.location.latitude;if(null==a)return null;const s=rt(this.view,e,a);return this._centerPointAtDistanceToCamera(i,s)}_zoomToCamera(e){return this._scaleToCamera(nt(this.view,e))}_viewpointToCamera(e){return Ye(this.view,ot(this.view,e))}setStateCamera(e,t){return!(m(e)||!this.view.state.stopActiveCameraController()||(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera((i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&ya(this.view,i)})),t.applyConstraints||(this.view.state.cameraController=new _s({view:this.view,desiredCamera:e})),0))}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._pixelRatio,a=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(0!==a&&0!==s&&(t.width===a&&t.height===s||(t.width=a,t.height=s),this.view.state)){const e=this.view.state.camera;e.fullWidth===a&&e.fullHeight===s&&e.pixelRatio===i||(Ps.copyFrom(e),Ps.pixelRatio!==i&&(this._paddingToArray(this.padding,i,ks),Ps.padding=ks),Ps.fullWidth=a,Ps.fullHeight=s,Ps.pixelRatio=i,this.view.state.camera=Ps),this._updateViewState()}}_updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,a=t?Ge(this.view,e.eye):0;e.relativeElevation=i-a}_updateViewState(){y(this.test.renderState)?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=At.ANIMATING:this.view.interacting?this.view.state.mode=At.INTERACTING:(this.view.state.mode===At.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=Is?this.view.state.mode=At.INTERACTING:this.view.state.mode=At.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio,this.view.state.contentPixelRatio=Math.min(this._pixelRatio,this.view.qualitySettings.maximumPixelRatio)}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};e([V({type:ne,dependsOn:["view.state.camera","ready"]})],Ts.prototype,"camera",null),e([V({type:ne,dependsOn:["view.state.contentCamera","ready"]})],Ts.prototype,"contentCamera",null),e([V({type:Ee})],Ts.prototype,"center",null),e([V({type:W})],Ts.prototype,"extent",null),e([V({readOnly:!0})],Ts.prototype,"frustum",null),e([V({readOnly:!0})],Ts.prototype,"hasInitialView",null),e([V({readOnly:!0,type:Boolean})],Ts.prototype,"ready",void 0),e([V({type:Number})],Ts.prototype,"scale",null),e([V()],Ts.prototype,"padding",null),e([V({readOnly:!0})],Ts.prototype,"screenCenter",null),e([V({constructOnly:!0})],Ts.prototype,"view",void 0),e([V({type:oe})],Ts.prototype,"viewpoint",null),e([V({type:Number})],Ts.prototype,"zoom",null),e([V({readOnly:!0})],Ts.prototype,"_pixelRatio",null),e([V({readOnly:!0})],Ts.prototype,"_rasterPixelRatio",null),e([V({readOnly:!0})],Ts.prototype,"_usePhysicalPixelRendering",null),e([V({readOnly:!0})],Ts.prototype,"_usePhysicalPixelRenderingAny",null),e([V()],Ts.prototype,"_windowDevicePixelRatio",void 0),e([V()],Ts.prototype,"_devicePixelRatioOverride",void 0),Ts=e([z("esri.views.3d.state.ViewStateManager")],Ts);const xs=["camera","viewpoint","extent","scale","center","zoom"],bs=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Rs={heading:0,tilt:0},Ss=new ne,Ps=new Rt,ks=ke(),Es="pending-initial-view",js="content-camera-reset",Is=300,As=100;let Ls=class extends a{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(Lt.TEXTURE_UNLOAD)??Ft}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach((e=>this._releaseTextureRequest(e))),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t,i){const a=this.makeUid(e);let s=this._textureRequests.get(a);if(!s){const e=t();s={referenceCount:0,texture:e,textureAsync:null,abortController:null,onRemove:i},this._stage&&(this._stage.add(e),this._stage.loadImmediate(e)),this._textureRequests.set(a,s)}return s.referenceCount++,{uid:a,texture:s.texture,release:()=>this._release(a)}}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule((()=>this._releaseNow(e)))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.onRemove&&e.onRemove(),e.texture?this._stage?.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return y(t)?`${e}.${t}px`:e}};function Fs(e){return e.visible&&null!=e.getEditableFlag&&e.getEditableFlag(Dt.USER)&&e.getEditableFlag(Dt.MANAGER)}e([V()],Ls.prototype,"_frameTask",void 0),e([V()],Ls.prototype,"updating",null),Ls=e([z("esri.views.3d.support.TextureCollection")],Ls);class Os{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}isInteracting(){return this._hoveredManipulators.size>0||this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,t){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Vs(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),"end"===e.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!Ns(e))break;const a=zt(e),s=this._intersect(a,e.pointerType,t.forEachTool);if(m(s))break;const r=s.manipulator,n=s.tool;!(y(r)&&y(n)&&r.interactive)||r.grabbable&&r.grabbableForEvent(e)||!r.grabbing||r.dragging||this._ungrabManipulatorBeforeDragging(r,e,t),y(r)&&y(n)&&r.interactive&&r.grabbable&&r.grabbableForEvent(e)&&!r.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:r,tool:n,start:a,pointerType:e.pointerType}),1===this._grabbedManipulators.size&&m(t.activeTool)&&(this._revertToNullActiveTool=!0,t.setActiveTool(s.tool)),r.grabbing=!0,r.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:a}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,t);break;case"pointer-drag":{if(!Ns(e))break;const a=this._grabbedManipulators.get(e.pointerId),s=_(a,(({manipulator:e})=>e)),r=_(a,(({tool:e})=>e));if(m(s)||m(r))break;const n=zt(e);n.x=Ae(n.x,0,t.view.width),n.y=Ae(n.y,0,t.view.height);const o=v(a).start,l=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":"update"!==e.action&&1!==this._grabbedManipulators.size||(s.dragging=!0,l?s.events.emit("drag",{action:"update",start:o,screenPoint:n}):s.events.emit("drag",{action:"start",start:o,screenPoint:n,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:r,manipulator:s,start:o}));break;case"end":s.dragging=!1,l&&s.events.emit("drag",{action:"end",start:o,screenPoint:n}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,t)}i();break}case"immediate-click":{const a=zt(e),s=this._intersect(a,e.pointerType,t.forEachTool);if(e.native.shiftKey||t.forEachTool((e=>{if((!y(s)||s.tool!==e||e.automaticManipulatorSelection)&&e.manipulators){let t=!1;e.manipulators.forEach((({manipulator:e})=>{e.selected&&(e.selected=!1,t=!0)})),t&&e.onManipulatorSelectionChanged&&e.onManipulatorSelectionChanged()}})),m(s))break;const{manipulator:r,tool:n}=s;if(!r.interactive)break;r.selectable&&n.automaticManipulatorSelection&&(r.selected=!r.selected,n.onManipulatorSelectionChanged&&n.onManipulatorSelectionChanged());const o=e.native.shiftKey;r.events.emit("immediate-click",{screenPoint:a,button:e.button,pointerType:e.pointerType,shiftKey:o,stopPropagation:i});break}case"click":{const a=zt(e),s=this._intersect(a,e.pointerType,t.forEachTool),r=y(s)?s.manipulator:null;if(m(r)||!r.interactive)break;const n=e.native.shiftKey;r.events.emit(e.type,{screenPoint:a,button:e.button,pointerType:e.pointerType,shiftKey:n}),i();break}case"double-click":{const a=zt(e),s=this._intersect(a,e.pointerType,t.forEachTool),r=y(s)?s.manipulator:null;if(m(r)||!r.interactive)break;const n=e.native.shiftKey;r.events.emit("double-click",{screenPoint:a,button:e.button,pointerType:e.pointerType,shiftKey:n,stopPropagation:i});break}case"immediate-double-click":{const a=zt(e),s=this._intersect(a,e.pointerType,t.forEachTool),r=y(s)?s.manipulator:null;if(m(r)||!r.interactive)break;const n=e.native.shiftKey;r.events.emit("immediate-double-click",{screenPoint:a,button:e.button,pointerType:e.pointerType,shiftKey:n,stopPropagation:i});break}}this._onFocusChange(t.forEachTool)}_ungrabManipulatorBeforeDragging(e,t,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:zt(t)}),this._grabbedManipulators.forEach((({manipulator:t},i)=>{t===e&&this._grabbedManipulators.delete(i)})),this._afterManipulatorUngrab(i.setActiveTool)}_handlePointerEnd(e,t){const i=_(this._grabbedManipulators.get(e.pointerId),(({manipulator:e})=>e));m(i)||i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:zt(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorUngrab(t.setActiveTool))}_cursorFromMap(e){let t=null;return N(e,(({manipulator:e})=>!(m(e)||!e.interactive||(e.grabbing&&e.grabCursor?(t=e.grabCursor,0):!e.cursor||(t=e.cursor,0))))),t}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const t=new Set,i=new Set;this._grabbedManipulators.forEach((({tool:e})=>{t.add(e)})),this._hoveredManipulators.forEach((({tool:e})=>{i.add(e)})),e((e=>{e.hasGrabbedManipulators=t.has(e),e.hasHoveredManipulators=i.has(e);const a=this._grabbedManipulators.values(),s=Et(a,(({tool:t})=>t===e));e.firstGrabbedManipulator=y(s)?s.manipulator:null}))}clearPointers(e,{forEachTool:t,setActiveTool:i},a=!0,s){const r=(t,i)=>t===e&&(m(s)||s===i);this._grabbedManipulators.forEach((({tool:e,manipulator:t,pointerType:i},a)=>{r(e,t)&&(this._grabbedManipulators.delete(a),t.grabbing=!1,t.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:i}))})),this._draggedManipulators.forEach((({tool:e,manipulator:t},i)=>{r(e,t)&&(this._draggedManipulators.delete(i),t.dragging=!1,t.events.emit("drag",{action:"cancel"}))})),a&&this._hoveredManipulators.forEach((({tool:e,manipulator:t},i)=>{r(e,t)&&(this._hoveredManipulators.delete(i),t.hovering=!1)})),this._afterManipulatorUngrab(i),this._onFocusChange(t)}_intersect(e,t,i){let a=null;return i((i=>{if(null==i.manipulators||!Fs(i))return!1;const s=i.manipulators.intersect(e,t);return!m(s)&&(a={tool:i,manipulator:s},!0)})),a}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach(((t,i)=>{this._updateHoveredStateForPointerAtScreenPosition(le(t.x,t.y),i,t.pointerType,e)}))}handleHoverEvent(e,t){"pointer-up"!==e.type&&"immediate-click"!==e.type&&"pointer-move"!==e.type||!Vs(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(zt(e),e.pointerId,e.pointerType,t)}_updateHoveredStateForPointerAtScreenPosition(e,t,i,a){let s=this._intersect(e,i,a);const r=_(this._hoveredManipulators.get(t),(({manipulator:e})=>e));y(s)&&!s.manipulator.interactive&&(s=null),y(s)&&r===s.manipulator||(y(r)&&(r.hovering=!1),y(s)?(s.manipulator.hovering=!0,this._hoveredManipulators.set(t,s)):this._hoveredManipulators.delete(t),this._onFocusChange(a))}_afterManipulatorUngrab(e){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}}function Vs(e){return"mouse"===e}function Ns(e){return"mouse"!==e.pointerType||0===e.button}const Ds="attached",zs="tools";let Us=class extends c{constructor(e){super(e),this._manipulatorState=new Os,this.tools=new r,this.cursor=null,this._interacting=!1,this._interactingTimeoutId=null,this._forEachTool=e=>{for(const t of this.tools.items)if(e(t))return}}initialize(){var e;this.handles.add([this.view.on(Vt,(e=>{this._handleInputEvent(e)}),Ot.TOOL),...(e=this.tools,[e.on("before-add",(t=>{const i=t.item;if(null==i||e.includes(i))return u.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()})),e.on("after-remove",(e=>{const t=e.item;t.active&&(t.view.activeTool=null),t.destroy()}))]),this.tools.on("before-add",(({item:e})=>{this._updateToolEditableFlag(e)})),this.tools.on("before-remove",(({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()})),this.tools.on("change",(()=>{this._refreshToolWatchers()}))])}destroy(){this.detach(),this.handles.removeAll()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(y(e)&&!this.view.ready)return void u.getLogger(this.declaredClass).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),y(t)&&t.deactivate(),y(e)&&e.activate(),this._removeIncompleteTools(e);for(const e of this.tools){this._updateToolEditableFlag(e);const t=Fs(e);!m(this.activeTool)&&t||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!t)}this._updateCursor()}get updating(){return this.updatingHandles.updating||this.tools.some((e=>e.updating))||(this.textures?.updating??!1)}get interacting(){return this._interacting}_clearInteractingTimeout(){null!=this._interactingTimeoutId&&(clearTimeout(this._interactingTimeoutId),this._interactingTimeoutId=null)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutId=setTimeout((()=>this._interacting=!1),100)}attach(){"3d"===this.view.type?(this._set("textures",new Ls(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([j((()=>{const{state:e}=this.view;return"camera"in e&&e.camera}),(()=>this._forEachManipulator((e=>e.onViewChange())))),this.view.elevationProvider?.on("elevation-change",(e=>this._forEachManipulator((t=>t.onElevationChange(e))))),p((()=>this._set("textures",w(this.textures))))],Ds)):this.handles.add(j((()=>this.view.extent),(()=>this._forEachManipulator((e=>e.onViewChange())))))}detach(){y(this.activeTool)&&(this.activeTool=null),this.tools.removeAll(),this.handles.remove(Ds),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool((t=>{t.manipulators&&t.manipulators.forEach((({manipulator:i})=>e(i,t)))}))}_handleInputEvent(e){let t=!1;const i={...e,stopPropagation:()=>{t=!0,e.stopPropagation()}};y(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool((e=>{!t&&e.visible&&e.handleInputEvent(i)})),!t&&"key-down"===e.type&&"Escape"===e.key&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),!t&&y(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),(this._manipulatorState.isInteracting()||t||y(this.activeTool)&&this.activeTool.interacting)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.handles.remove(zs),this._forEachTool((e=>{if(e instanceof a){const t=j((()=>[e.cursor,e.visible,e.editable]),(()=>{Fs(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}));this.handles.add(t,zs)}e.manipulators&&this.handles.add([e.manipulators.on("after-remove",(t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)})),e.manipulators.on("change",(()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}))],zs)})),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(Dt.MANAGER,m(this.activeTool)||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;m(e)&&this._forEachTool((t=>!(!y(t.cursor)||!t.visible||(e=t.cursor,0)))),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter((t=>(m(e)||t!==e)&&!t.created&&t.removeIncompleteOnCancel)).forEach((e=>{this.tools.remove(e)}))}};e([V({constructOnly:!0,nonNullable:!0})],Us.prototype,"view",void 0),e([V({readOnly:!0,nonNullable:!0})],Us.prototype,"textures",void 0),e([V({value:null})],Us.prototype,"activeTool",null),e([V({readOnly:!0,type:r})],Us.prototype,"tools",void 0),e([V({readOnly:!0})],Us.prototype,"cursor",void 0),e([V({readOnly:!0})],Us.prototype,"updating",null),e([V()],Us.prototype,"_interacting",void 0),e([V({readOnly:!0})],Us.prototype,"interacting",null),Us=e([z("esri.views.ToolViewManager")],Us);const Zs=Us;let qs,Ws=null;async function Hs(e){Ws||(Ws=import("../chunks/geometryServiceUtils.js").then((e=>qs=e))),await Ws,S(e)}async function Gs(e,t,i,a){if(!e)return null;const s=e.spatialReference;return Ht()||Gt(s,t)?Bt(e,t):qs?qs.projectGeometry(e,t,i,a):(await Promise.race([Hs(a),Kt(a)]),Gs(e,t,i,a))}let Bs=class extends a{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=C(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return y(this.userSpatialReference)?this.userSpatialReference:v(this._spatialReferenceTask.spatialReference)}get extent(){return v(this._extentTask.extent)}get heightModelInfo(){return v(this._heightModelInfoTask.heightModelInfo)}get vcsWkid(){return v(this._heightModelInfoTask.vcsWkid)}get latestVcsWkid(){return v(this._heightModelInfoTask.latestVcsWkid)}get viewingMode(){return m(this.userSpatialReference)||this.userSpatialReference.equals(v(this._spatialReferenceTask.spatialReference))?v(this._spatialReferenceTask.viewingMode):null}get tileInfo(){return v(this._tileInfoTask.tileInfo)}get mapCollections(){const e=this.map?.(),t=[];return y(this.priorityCollection)&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _allLayers(){return this._collectLayers(this.mapCollections)}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;let i=null;for(const t of e){const e=this._getSupportedSpatialReferences(t);if(e.length>0){const t=this._narrowDownSpatialReferenceCandidates(i,e);y(t)&&(i=t)}if(y(i)&&1===i.length)break}if(t&&(m(i)||1!==i.length))return{updating:!0};const a=this._pickSpatialReferenceCandidate(i);return{spatialReference:y(a)?a.spatialReference:null,viewingMode:y(a)?a.viewingMode:null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:t}=this._collectLayers([{parent:this.map?.()?.basemap,layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const t=e[0].tileInfo;return{tileInfo:t&&t.spatialReference.equals(this.spatialReference)?t:null,updating:!1}}return{updating:t}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:t}=this._allLayers;for(const t of e)if(qt(t)){const e=Wt(t);if(e)return{heightModelInfo:e,vcsWkid:t.spatialReference?.vcsWkid,latestVcsWkid:t.spatialReference?.latestVcsWkid,updating:!1}}return{updating:t}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,t=e.updating,i=[];for(const t of e.layers){const e="fullExtents"in t&&t.fullExtents||(y(t.fullExtent)?[t.fullExtent]:[]),a=this.requiresExtentInSpatialReference?null:e[0],s=e.find((e=>e.spatialReference.equals(this.spatialReference)))??a;if(s)return{candidates:[{extent:s,layer:t}],updating:!1};if(this._getSupportedSpatialReferences(t).length>0)for(const a of e)i.push({extent:a,layer:t})}return{candidates:i,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(m(e)||0===e.length)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),a=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&a.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:y(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(y(this._projectExtentTask.task)&&(this._projectExtentTask.task=C(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:a.clone(),task:s((async e=>{try{const t=await Gs(i.extent,a,i.layer.portalItem,e);this._projectExtentTask={...this._projectExtentTask,task:null,output:t}}catch(t){if(P(e))return;this._projectExtentTask={...this._projectExtentTask,task:null}}}))},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(m(e))return t;const i=[],a=(e,t)=>y(e)?y(t)?e===t&&e:e:t;for(const s of e)for(const e of t){if(!s.spatialReference.equals(e.spatialReference))continue;const t=a(s.viewingMode,e.viewingMode);if(!1!==t){i.push({spatialReference:s.spatialReference,viewingMode:t});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return m(e)||e.length<1?y(t)?{spatialReference:t,viewingMode:null}:null:(y(t)&&e.length>1&&e.some((({spatialReference:e})=>e.equals(t)))&&(e=e.filter((({spatialReference:e})=>e.equals(t)))),e.length>1&&e.some((({viewingMode:e})=>e!==Ie.Local))&&(e=e.filter((({viewingMode:e})=>e!==Ie.Local))),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(0===t.length)return[];const i=[];for(const a of t){const t=this.getSpatialReferenceSupport({spatialReference:a,layer:e});if(y(t)){const e=y(t.constraints)?t.constraints:[{spatialReference:a,viewingMode:null}];for(const{spatialReference:t,viewingMode:a}of e)(!this.requiresExtentInSpatialReference||m(this.userSpatialReference)||t.equals(this.userSpatialReference))&&i.push({spatialReference:t,viewingMode:a})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find((({extent:e})=>t.equals(e.spatialReference)))||e[0]}_collectLayers(e){if("loaded"!==this._loadMaybe(this.map?.()))return{layers:[],updating:!0};const t={layers:[],preloading:-1,updating:!1};for(const i of e)if(this._collectCollection(i,t),t.preloading===this.sourcePreloadCount)break;return{layers:t.layers,updating:t.updating}}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":t.updating||t.layers.push(i),"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&null!=e.loadStatus?"not-loaded"===e.loadStatus?(e.load().catch((()=>{})),"loading"):e.loadStatus:"loaded"}};var Ks;e([V()],Bs.prototype,"required",void 0),e([V({constructOnly:!0})],Bs.prototype,"map",void 0),e([V({constructOnly:!0})],Bs.prototype,"getSpatialReferenceSupport",void 0),e([V()],Bs.prototype,"defaultSpatialReference",void 0),e([V()],Bs.prototype,"userSpatialReference",void 0),e([V()],Bs.prototype,"sourcePreloadCount",void 0),e([V()],Bs.prototype,"priorityCollection",void 0),e([V()],Bs.prototype,"requiresExtentInSpatialReference",void 0),e([V()],Bs.prototype,"suspended",void 0),e([V({readOnly:!0})],Bs.prototype,"ready",null),e([V({readOnly:!0})],Bs.prototype,"heightModelInfoReady",null),e([V({readOnly:!0})],Bs.prototype,"spatialReference",null),e([V({readOnly:!0})],Bs.prototype,"extent",null),e([V({readOnly:!0})],Bs.prototype,"heightModelInfo",null),e([V({readOnly:!0})],Bs.prototype,"vcsWkid",null),e([V({readOnly:!0})],Bs.prototype,"latestVcsWkid",null),e([V({readOnly:!0})],Bs.prototype,"viewingMode",null),e([V({readOnly:!0})],Bs.prototype,"tileInfo",null),e([V({readOnly:!0})],Bs.prototype,"mapCollections",null),e([V({readOnly:!0})],Bs.prototype,"_allLayers",null),e([V({readOnly:!0})],Bs.prototype,"_spatialReferenceTask",null),e([V({readOnly:!0})],Bs.prototype,"_tileInfoTask",null),e([V({readOnly:!0})],Bs.prototype,"_heightModelInfoTask",null),e([V({readOnly:!0})],Bs.prototype,"_extentCandidatesTask",null),e([V()],Bs.prototype,"_extentTask",null),e([V()],Bs.prototype,"_projectExtentTask",void 0),Bs=e([z("esri.views.support.DefaultsFromMap")],Bs);let Ys=Ks=class extends(h(l.EventedMixin(M(a)))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new n({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:e=>e.layerViews}),this.groundView=null,this.basemapView=null,this.fatalError=null,this.graphics=new Z,this.analyses=new Yt,this.typeSpecificPreconditionsReady=!0,this.layerViews=new r,this.magnifier=new re,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.timeReference=new Q,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new Ut,this.navigation=new Zt,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new Nt(this),this.persistableViewModels=new r,this._isValid=!1,this._readyCycleForced=!1,this._currentSpatialReference=null,this.handles.add(j((()=>this.preconditionsReady),(e=>{e?(this._currentSpatialReference=this.spatialReference,Ks.views.add(this)):(this._currentSpatialReference=null,Ks.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?(this.toolViewManager?.detach(),y(this.analysisViewManager)&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown()):e&&!this.ready&&(this._startup(),y(this.analysisViewManager)&&this.analysisViewManager.attach(),this.toolViewManager.attach())}),A))}initialize(){this.addResolvingPromise(this.validate().then((()=>(this._isValid=!0,F((()=>this.ready)))))),this.basemapView=new $({view:this}),this.layerViewManager=new Jt({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new Zs({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([j((()=>this.initialExtentRequired),(e=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:e}),{sync:!0,initial:!0}),j((()=>this.ready),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)}),{sync:!0}),j((()=>this._userSpatialReference),(e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)}),{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let e=null;this.handles.add([j((()=>this.defaultsFromMap?.ready),(t=>{const i=this.map?.allLayers.length>0;if(t&&!this.spatialReference&&i){if(y(e))return;const t=p((()=>e=C(e)));e=s((async t=>{try{await k(this.spatialReferenceWarningDelay,null,t)}catch{return}finally{e=null}u.getLogger(this.declaredClass).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})),this.handles.add(t,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")}),{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=w(this.graphics),this.analyses=w(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),w(this.analysisViewManager),this.toolViewManager=w(this.toolViewManager),this.layerViewManager=w(this.layerViewManager),this.basemapView=w(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,e?.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return u.getLogger(this.declaredClass).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Bs({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:e=>this.getSpatialReferenceSupport(e),...this._defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||d.isLoadable(this.map)&&!this.map.loaded||0===this.width||0===this.height||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._currentSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(u.getLogger(this.declaredClass).warn("#map","The provided map is already destroyed",{map:e}),e=null),d.isLoadable(e)&&e.load().catch((()=>{})),this.constructed&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",e))}get spatialReference(){let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&this.defaultsFromMap?.required?.heightModelInfo&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e}set spatialReference(e){const t=!Y(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return y(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}importLayerView(e){throw new o("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return y(this.getSpatialReferenceSupport({spatialReference:e}))}when(e,t){return this.isResolved()&&!this.ready&&u.getLogger(this.declaredClass).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(O((()=>!1===this.preconditionsReady),(()=>this._readyCycleForced=!1),{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};Ys.views=new r,e([V()],Ys.prototype,"_userSpatialReference",void 0),e([V()],Ys.prototype,"activeTool",null),e([V({readOnly:!0})],Ys.prototype,"allLayerViews",void 0),e([V()],Ys.prototype,"groundView",void 0),e([V()],Ys.prototype,"animation",null),e([V()],Ys.prototype,"basemapView",void 0),e([V()],Ys.prototype,"center",null),e([V({readOnly:!0})],Ys.prototype,"_defaultsFromMapSettings",null),e([V()],Ys.prototype,"defaultsFromMap",null),e([V()],Ys.prototype,"fatalError",void 0),e([V({type:W})],Ys.prototype,"extent",null),e([V(q(Z,"graphics"))],Ys.prototype,"graphics",void 0),e([V(q(Yt,"analyses"))],Ys.prototype,"analyses",void 0),e([V({readOnly:!0,type:H})],Ys.prototype,"heightModelInfo",null),e([V({readOnly:!0})],Ys.prototype,"interacting",null),e([V({readOnly:!0})],Ys.prototype,"navigating",null),e([V({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Ys.prototype,"preconditionsReady",null),e([V({readOnly:!0})],Ys.prototype,"typeSpecificPreconditionsReady",void 0),e([V({type:r,readOnly:!0})],Ys.prototype,"layerViews",void 0),e([V()],Ys.prototype,"resolution",null),e([V({type:re})],Ys.prototype,"magnifier",void 0),e([V({value:null,type:t})],Ys.prototype,"map",null),e([V()],Ys.prototype,"padding",void 0),e([V({readOnly:!0})],Ys.prototype,"ready",void 0),e([V({type:G})],Ys.prototype,"spatialReference",null),e([V()],Ys.prototype,"spatialReferenceWarningDelay",void 0),e([V()],Ys.prototype,"stationary",null),e([V({readOnly:!0})],Ys.prototype,"supportsGround",void 0),e([V({type:i})],Ys.prototype,"timeExtent",void 0),e([V({type:Q,nonNullable:!0})],Ys.prototype,"timeReference",void 0),e([V()],Ys.prototype,"tools",null),e([V()],Ys.prototype,"toolViewManager",void 0),e([V({readOnly:!0})],Ys.prototype,"type",void 0),e([V({type:Number})],Ys.prototype,"scale",void 0),e([V({readOnly:!0})],Ys.prototype,"updating",void 0),e([V({readOnly:!0})],Ys.prototype,"initialExtentRequired",void 0),e([V({readOnly:!0})],Ys.prototype,"initialExtent",null),e([V()],Ys.prototype,"cursor",null),e([V({readOnly:!0})],Ys.prototype,"input",void 0),e([V({type:Zt,nonNullable:!0})],Ys.prototype,"navigation",void 0),e([V()],Ys.prototype,"layerViewManager",void 0),e([V()],Ys.prototype,"analysisViewManager",void 0),e([V()],Ys.prototype,"width",void 0),e([V()],Ys.prototype,"height",void 0),e([V({readOnly:!0})],Ys.prototype,"resizing",void 0),e([V({value:null,readOnly:!0})],Ys.prototype,"size",null),e([V({readOnly:!0})],Ys.prototype,"suspended",void 0),e([V({readOnly:!0})],Ys.prototype,"viewEvents",void 0),e([V({readOnly:!0})],Ys.prototype,"persistableViewModels",void 0),e([V()],Ys.prototype,"_isValid",void 0),e([V()],Ys.prototype,"_readyCycleForced",void 0),e([V()],Ys.prototype,"_currentSpatialReference",void 0),Ys=Ks=e([z("esri.views.View")],Ys);const Qs=Ys;export{ys as A,Xt as C,Fa as F,ei as I,fs as P,Cs as R,Va as S,ti as T,Ts as V,Ta as a,ya as b,va as c,vi as d,Qs as default,Na as e,As as f,Ls as g,Yt as h,Ca as i,$i as o,fa as p,Ma as r,Ms as s,xi as v};
