/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"./Handles.js";import{b as t,d as s,a as r,i}from"../chunks/maybe.js";import{L as o,subclass as n,B as a}from"./accessorSupport/decorators/subclass.js";import{g as c}from"../chunks/get.js";import{a as l}from"../chunks/metadata.js";import{r as h}from"../chunks/typedArrayUtil.js";import{clone as u,equals as d}from"./lang.js";import{L as _}from"../chunks/Logger.js";import{O as p}from"../chunks/ArrayPool.js";import{F as f,t as v,r as g,a as m,b as y,i as b}from"../chunks/tracking.js";import{g as O}from"../chunks/utils.js";import{property as E,s as j}from"./accessorSupport/decorators/property.js";import{r as A,w as I}from"../chunks/watch.js";import"../chunks/ensureType.js";import"../chunks/object.js";import"./Error.js";import"../config.js";import"../chunks/string.js";import"../chunks/handleUtils.js";import"./scheduling.js";import"../chunks/nextTick.js";import"./promiseUtils.js";class S{constructor(e,t){this._observers=e,this._observer=t}remove(){h(this._observers,this._observer)}}class C{constructor(){this._observers=null,this.destroyed=!1}observe(e){if(this.destroyed||e.destroyed)return T;null==this._observers&&(this._observers=[]);const t=this._observers;let s=!1,r=!1;const i=t.length;for(let o=0;o<i;++o){const i=t[o];if(i.destroyed)r=!0;else if(i===e){s=!0;break}}return s||(t.push(e),r&&this._removeDestroyedObservers()),new S(t,e)}_removeDestroyedObservers(){const e=this._observers;if(!e||0===e.length)return;const t=e.length;let s=0;for(let r=0;r<t;++r){for(;r+s<t&&e[r+s].destroyed;)++s;if(s>0){if(!(r+s<t))break;e[r]=e[r+s]}}e.length=t-s}destroy(){if(this.destroyed)return;this.destroyed=!0;const e=this._observers;if(null!=e){for(const t of e)t.onCommitted();this._observers=null}}}const T={remove:()=>{}};var w;!function(e){e[e.DEFAULTS=0]="DEFAULTS",e[e.COMPUTED=1]="COMPUTED",e[e.SERVICE=2]="SERVICE",e[e.PORTAL_ITEM=3]="PORTAL_ITEM",e[e.WEB_SCENE=4]="WEB_SCENE",e[e.WEB_MAP=5]="WEB_MAP",e[e.USER=6]="USER"}(w||(w={}));const k=w.USER+1;function D(e){switch(e){case"defaults":return w.DEFAULTS;case"service":return w.SERVICE;case"portal-item":return w.PORTAL_ITEM;case"web-scene":return w.WEB_SCENE;case"web-map":return w.WEB_MAP;case"user":return w.USER;default:return null}}function N(e){switch(e){case w.DEFAULTS:return"defaults";case w.SERVICE:return"service";case w.PORTAL_ITEM:return"portal-item";case w.WEB_SCENE:return"web-scene";case w.WEB_MAP:return"web-map";case w.USER:return"user"}return t(void 0)}function U(e){return N(e)}class P{constructor(e,t,s){this.properties=e,this.propertyName=t,this.metadata=s,this.observerObject=new R,this._accessed=null,this._handles=null,this.observerObject.flags=f.Dirty|(s.nonNullable?f.NonNullable:0)|(s.hasOwnProperty("value")?f.HasDefaultValue:0)|(void 0===s.get?f.DepTrackingInitialized:0)|(void 0===s.dependsOn?f.AutoTracked:0),L.register(this,this.observerObject,this.observerObject)}destroy(){L.unregister(this.observerObject),this.observerObject.destroy(),this._accessed=null,this._clearObservationHandles()}getComputed(){const e=this.observerObject;v(e);const t=this.properties.store,s=this.propertyName,r=e.flags,i=t.get(s);if(r&f.Computing)return i;if(~r&f.Dirty&&t.has(s))return i;e.flags|=f.Computing;const o=this.properties.host;let n;r&f.AutoTracked?n=g(this,this.metadata.get,o):(m(o,this),n=this.metadata.get.call(o)),t.set(s,n,w.COMPUTED);const a=t.get(s);return a===i?e.flags&=~f.Dirty:y(this.commit,this),e.flags&=~f.Computing,a}onObservableAccessed(e){e!==this.observerObject&&(null===this._accessed&&(this._accessed=[]),this._accessed.includes(e)||this._accessed.push(e))}onTrackingEnd(){this._clearObservationHandles();const e=this.observerObject;e.flags|=f.DepTrackingInitialized;const t=this._accessed;if(null===t)return;let s=this._handles;null===s&&(s=this._handles=[]);for(let r=0;r<t.length;++r)s.push(t[r].observe(e));t.length=0}notifyChange(){const e=this.observerObject;e.onInvalidated(),e.onCommitted()}invalidate(){this.observerObject.onInvalidated()}commit(){const e=this.observerObject;e.flags&=~f.Dirty,e.onCommitted()}_clearObservationHandles(){const e=this._handles;if(null!==e){for(let t=0;t<e.length;++t)e[t].remove();e.length=0}}}class R extends C{constructor(){super(...arguments),this.flags=0}onInvalidated(){~this.flags&f.Overriden&&(this.flags|=f.Dirty);const e=this._observers;if(e&&e.length>0)for(const t of e)t.onInvalidated()}onCommitted(){const e=this._observers;if(e&&e.length>0){const t=e.slice();for(const e of t)e.onCommitted()}}destroy(){this.flags&f.Dirty&&this.onCommitted(),super.destroy()}}const L=new FinalizationRegistry((e=>{e.destroy()}));class M{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const t=new M;return this._values.forEach(((s,r)=>{e&&e.has(r)||t.set(r,u(s))})),t}get(e){return this._values.get(e)}originOf(){return w.USER}keys(){return[...this._values.keys()]}set(e,t){this._values.set(e,t)}delete(e){this._values.delete(e)}has(e){return this._values.has(e)}forEach(e){this._values.forEach(e)}}function z(e,t,s){return void 0!==e}function H(e,t,s,r){return!(void 0===e||null==s&&e.observerObject.flags&f.NonNullable&&(r.lifecycle,o.INITIALIZING,1))}_.getLogger("esri.core.accessorSupport.Properties");class B{constructor(e){this.host=e,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=o.INITIALIZING,this.store=new M,this._origin=w.USER;const s=t(this.host.constructor.__accessorMetadata__);for(const e in s){const t=new P(this,e,s[e]);this.properties.set(e,t)}this.metadatas=s}initialize(){this.lifecycle=o.CONSTRUCTING}constructed(){this.lifecycle=o.CONSTRUCTED}destroy(){this.destroyed=!0;for(const[t,s]of this.properties){if(s.metadata.autoDestroy){const r=this.internalGet(t);r&&(e=r)&&"function"==typeof e.destroy&&(r.destroy(),~s.observerObject.flags&f.NonNullable&&this._internalSet(s,null))}s.destroy()}var e}get initialized(){return this.lifecycle!==o.INITIALIZING}get(e){const t=this.properties.get(e);if(t.metadata.get)return t.getComputed();v(t.observerObject);const s=this.store;return s.has(e)?s.get(e):t.metadata.value}originOf(e){const t=this.store.originOf(e);if(void 0===t){const t=this.properties.get(e);if(void 0!==t&&t.observerObject.flags&f.HasDefaultValue)return"defaults"}return N(t)}has(e){return!!this.properties.has(e)&&this.store.has(e)}keys(){return[...this.properties.keys()]}internalGet(e){const t=this.properties.get(e);if(z(t))return this.store.has(e)?this.store.get(e):t.metadata.value}internalSet(e,t){const s=this.properties.get(e);z(s)&&this._internalSet(s,t)}getDependsInfo(e,t,s){const r=this.properties.get(t);if(!z(r))return"";const i=new Set,o=g({onObservableAccessed:e=>i.add(e),onTrackingEnd:()=>{}},(()=>r.metadata.get?.call(e)));let n=`${s}${e.declaredClass.split(".").pop()}.${t}: ${o}\n`;if(0===i.size)return n;s+="  ";for(const e of i){if(!(e instanceof P))continue;const t=e.properties.host,r=e.propertyName,i=O(t);n+=i?i.getDependsInfo(t,r,s):`${s}${r}: undefined\n`}return n}setAtOrigin(e,t,s){const r=this.properties.get(e);if(z(r))return this._setAtOrigin(r,t,s)}isOverridden(e){const t=this.properties.get(e);return void 0!==t&&!!(t.observerObject.flags&f.Overriden)}clearOverride(e){const t=this.properties.get(e),s=t?.observerObject;s&&s.flags&f.Overriden&&(s.flags&=~f.Overriden,t.notifyChange())}override(e,t){const s=this.properties.get(e);if(!H(s,0,t,this))return;const r=s.metadata.cast;if(r){const e=this._cast(r,t),{valid:s,value:i}=e;if(G.release(e),!s)return;t=i}s.observerObject.flags|=f.Overriden,this._internalSet(s,t)}set(e,t){const s=this.properties.get(e);if(!H(s,0,t,this))return;const r=s.metadata.cast;if(r){const e=this._cast(r,t),{valid:s,value:i}=e;if(G.release(e),!s)return;t=i}const i=s.metadata.set;i?i.call(this.host,t):this._internalSet(s,t)}setDefaultOrigin(e){this._origin=D(e)}getDefaultOrigin(){return N(this._origin)}notifyChange(e){const t=this.properties.get(e);void 0!==t&&t.notifyChange()}invalidate(e){const t=this.properties.get(e);void 0!==t&&t.invalidate()}commit(e){const t=this.properties.get(e);void 0!==t&&t.commit()}_internalSet(e,t){const s=this.lifecycle!==o.INITIALIZING?this._origin:w.DEFAULTS;this._setAtOrigin(e,t,s)}_setAtOrigin(e,t,s){const r=this.store,i=e.propertyName;r.has(i,s)&&d(t,r.get(i))&&~e.observerObject.flags&f.Overriden&&s===r.originOf(i)||(e.invalidate(),r.set(i,t,s),e.commit(),b(this.host,e))}_cast(e,t){const s=G.acquire();return s.valid=!0,s.value=t,e&&(s.value=e.call(this.host,t,s)),s}}const G=new p(class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}});var W,F;function V(e){if(null==e)return{value:e};if(Array.isArray(e))return{type:[e[0]],value:null};switch(typeof e){case"object":return e.constructor?.__accessorMetadata__||e instanceof Date?{type:e.constructor,value:e}:e;case"boolean":return{type:Boolean,value:e};case"string":return{type:String,value:e};case"number":return{type:Number,value:e};case"function":return{type:e,value:null};default:return}}const $=Symbol("Accessor-Handles"),x=Symbol("Accessor-Initialized");class Z{static createSubclass(e={}){if(Array.isArray(e))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:t,declaredClass:s,constructor:r}=e;delete e.declaredClass,delete e.properties,delete e.constructor;const i=this;class o extends i{constructor(...e){super(...e),this.inherited=null,r&&r.apply(this,e)}}l(o.prototype);for(const t in e){const s=e[t];o.prototype[t]="function"==typeof s?function(...e){const r=this.inherited;let o;this.inherited=function(...e){if(i.prototype[t])return i.prototype[t].apply(this,e)};try{o=s.apply(this,e)}catch(e){throw this.inherited=r,e}return this.inherited=r,o}:e[t]}for(const e in t){const s=V(t[e]);E(s)(o.prototype,e)}return n(s)(o)}constructor(...e){if(this[W]=null,this[F]=!1,this.constructor===Z)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new B(this)}),e.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,e))}postscript(e){const t=this.__accessor__,s=t.ctorArgs||e;t.initialize(),s&&(this.set(s),t.ctorArgs=null),t.constructed(),this.initialize(),this[x]=!0}initialize(){}[a](){this[$]=s(this[$])}destroy(){this.destroyed||(A(this),this.__accessor__.destroy())}get constructed(){return this.__accessor__&&this.__accessor__.initialized||!1}get initialized(){return this[x]}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(e){this.get(e)}get(e){return c(this,e)}hasOwnProperty(e){return this.__accessor__?this.__accessor__.has(e):Object.prototype.hasOwnProperty.call(this,e)}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(e,t){return j(this,e,t),this}watch(e,t,s){return I(this,e,t,s)}own(e){this.addHandles(e)}addHandles(t,s){let i=this[$];r(i)&&(i=this[$]=new e),i.add(t,s)}removeHandles(e){const t=this[$];r(t)||t.remove(e)}removeAllHandles(){const e=this[$];r(e)||e.removeAll()}hasHandles(e){const t=this[$];return!!i(t)&&t.has(e)}_override(e,t){void 0===t?this.__accessor__.clearOverride(e):this.__accessor__.override(e,t)}_clearOverride(e){return this.__accessor__.clearOverride(e)}_overrideIfSome(e,t){null==t?this.__accessor__.clearOverride(e):this.__accessor__.override(e,t)}_isOverridden(e){return this.__accessor__.isOverridden(e)}notifyChange(e){this.__accessor__.notifyChange(e)}_get(e){return this.__accessor__.internalGet(e)}_set(e,t){return this.__accessor__.internalSet(e,t),this}}W=$,F=x;export{w as O,k as a,N as b,C as c,Z as default,U as i,D as n};
