/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Error.js";import{i as s,a as i,u as o}from"../chunks/maybe.js";import{M as n}from"../chunks/MultiOriginJSONSupport.js";import{watch as r}from"../core/reactiveUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import"../chunks/typedArrayUtil.js";import{subclass as l}from"../core/accessorSupport/decorators/subclass.js";import p from"./Layer.js";import{BlendLayer as m}from"./mixins/BlendLayer.js";import{CustomParametersMixin as c}from"./mixins/CustomParametersMixin.js";import{B as u,ImageryTileMixin as d}from"./mixins/ImageryTileMixin.js";import{O as h}from"../chunks/OperationalLayer.js";import{PortalLayer as f}from"./mixins/PortalLayer.js";import{RefreshableLayer as g}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as y}from"./mixins/ScaleRangeLayer.js";import{TemporalLayer as b}from"./mixins/TemporalLayer.js";import{p as j}from"../chunks/commonProperties2.js";import v from"./support/Field.js";import"../geometry.js";import{L as x}from"../chunks/Logger.js";import{isAbortError as w}from"../core/promiseUtils.js";import{i as C}from"../chunks/crsUtils.js";import S from"./support/DimensionalDefinition.js";import I from"../geometry/Extent.js";import{g as k,b as D,a as T,e as L,f as R,i as P,h as M}from"../chunks/xmlUtilities.js";import U from"../geometry/Polygon.js";import A from"./support/RasterInfo.js";import{g as E}from"../chunks/RasterSymbolizer.js";import{y as O}from"../chunks/vectorFieldUtils.js";import{createPopupTemplate as V}from"../support/popupUtils.js";import"../core/lang.js";import"../chunks/object.js";import"../config.js";import"../chunks/string.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/metadata.js";import"../chunks/ArrayPool.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../core/JSONSupport.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Evented.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../geometry/SpatialReference.js";import"../chunks/unitUtils.js";import"../chunks/jsonMap.js";import"../chunks/Ellipsoid.js";import"../chunks/writer.js";import"../geometry/Geometry.js";import"../chunks/reader.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/common.js";import"../chunks/vec4.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/screenUtils.js";import"../chunks/mat4f32.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../rasterRenderers.js";import"../renderers/ClassBreaksRenderer.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../chunks/enumeration.js";import"./support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../symbols/Symbol.js";import"../Color.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../chunks/Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/compilerUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../symbols/support/jsonUtils.js";import"../chunks/layerUtils.js";import"../renderers/FlowRenderer.js";import"../renderers/RasterColormapRenderer.js";import"../renderers/support/ColormapInfo.js";import"../chunks/colorRampUtils.js";import"../chunks/colorUtils2.js";import"../renderers/RasterShadedReliefRenderer.js";import"../renderers/RasterStretchRenderer.js";import"../chunks/stretchRendererUtils.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils.js";import"../renderers/VectorFieldRenderer.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils4.js";import"../chunks/utils5.js";import"../chunks/utils6.js";import"../chunks/asyncUtils.js";import"../chunks/assets.js";import"../chunks/ItemCache.js";import"../chunks/MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils7.js";import"./support/PixelBlock.js";import"../chunks/pixelRangeUtils.js";import"../chunks/arcgisLayerUrl.js";import"./support/MultidimensionalSubset.js";import"./support/RasterFunction.js";import"../chunks/RasterJobHandler.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"../chunks/messages.js";import"./support/TileInfo.js";import"./support/LOD.js";import"../chunks/TileKey.js";import"../chunks/multidimensionalUtils.js";import"../chunks/RawBlockCache.js";import"../chunks/rasterProjectionHelper.js";import"../chunks/pe.js";import"../geometry/projection.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/rasterFunctionHelper.js";import"./support/rasterFunctionConstants.js";import"../chunks/stretchUtils.js";import"../chunks/rasterRendererHelper.js";import"../chunks/generateRendererUtils.js";import"../chunks/dataUtils.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../chunks/domains.js";import"./support/CodedValueDomain.js";import"./support/Domain.js";import"./support/InheritedDomain.js";import"./support/RangeDomain.js";import"../chunks/fieldType.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../TimeInterval.js";import"./support/TimeInfo.js";import"../chunks/TimeReference.js";import"../chunks/datetime.js";const F=5e4;function $(e,t,s=0){const i="--"+t.boundary,o=[];for(let e=0;e<i.length;e++)o.push(i.charCodeAt(e));const n=[],r="\n--"+t.boundary+"--";for(let e=0;e<r.length;e++)n.push(r.charCodeAt(e));const a=[10],l=[13,10],p=[],m=o.length,c=new Uint8Array(e,s),u=Math.min(F,c.length-m);let d=0,h=0;for(let e=0;e<u;e++){for(h=0;h<m&&c[e+h]===o[h];h++);h===m&&(d&&p.push(N(c.subarray(d,e),t)),e+=m-1,c[e+1]===a[0]?e+=1:c[e+1]===l[0]&&c[e+2]===l[1]&&(e+=2),d=e+1)}const f=n.length;for(let e=c.length-f-10;e<c.length-f;e++){for(h=0;h<f&&c[e+h]===n[h];h++);if(h===f){p.push(N(c.subarray(d,e),t));break}}return p}function N(e,t){const s=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split("\n"),i=Math.min(s.length,7),o={contentDisposition:"inline"};let n=0;for(let r=0;r<i;r++)if(s[r].length<4)n=n+s[r].length+1;else if("content"===s[r].slice(0,7).toLowerCase()){if(n=n+s[r].length+1,!s[r].includes(":"))continue;const e=s[r].substring(0,s[r].indexOf(":")).trim(),t=s[r].substring(s[r].indexOf(":")+1).trim();switch(e.toLowerCase()){case"content-type":o.contentType=t;break;case"content-description":o.contentDescription=t;break;case"content-transfer-encoding":o.contentTransferEncoding=t;break;case"content-id":o.contentID=t;break;case"content-disposition":o.contentDisposition=t;break;case"content-location":o.contentLocation=t}}else{if(o.contentDisposition.toLowerCase().includes("inline")&&s[r].length>=4&&o.contentType?.toLowerCase().indexOf("image")>-1){let t=!0,s=e.subarray(n,e.length);if(o.contentType.toLowerCase().indexOf("tif")>0){if("base64"===o.contentTransferEncoding){let e="";const t=s;for(let s=0;s<t.length;s+=65535){const i=t.subarray(s,s+65535>t.length-1?t.length-1:s+65535);e+=String.fromCharCode.apply(null,i)}const i=atob(e);s=new Uint8Array(i.length);for(let e=0;e<s.length;e++)s[e]=i.charCodeAt(e)}t=73===s[0]&&73===s[1]||77===s[0]&&77===s[1]}if(t){let t=s.buffer;"base64"!==o.contentTransferEncoding&&(t=new ArrayBuffer(e.length-n),s=new Uint8Array(t),s.set(e.subarray(n,e.length))),o.contentData=t}break}if((""===t.start||o.contentID===t.start)&&o.contentType){if(o.contentType.includes("text")||o.contentType.includes("xml")){o.contentData=String.fromCharCode.apply(null,e.subarray(n,e.length));break}o.contentData=e.subarray(n,e.length)}}return o}function G(e){return e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e}function B(e){const t={};for(let s=0;s<e.childNodes.length;s++){const i=e.childNodes[s];if(1!==i.nodeType)continue;const o=M(i).toLowerCase();switch(o){case"title":case"abstract":t[o]=k(i);break;case"identifier":t.id=k(i);break;case"wgs84boundingbox":{const e=L(i,"LowerCorner"),s=L(i,"UpperCorner");t.lonLatEnvelope=new I({xmin:e[0],ymin:e[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(B(i))}}return t}function _(e,t){if(e.coverageSummaries)for(let s=0;s<e.coverageSummaries.length;s++)e.coverageSummaries[s].abstract=e.coverageSummaries[s].abstract||e.abstract,e.coverageSummaries[s].lonLatEnvelope=e.coverageSummaries[s].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[s].title=e.coverageSummaries[s].title||e.title,_(e.coverageSummaries[s],t);null!=e.id&&t.push(e)}function q(e){const t=D(e.querySelector("Operation[name=GetCapabilities]"),"Get")?.getAttribute("xlink:href")||"",s=D(e.querySelector("Operation[name=DescribeCoverage]"),"Get")?.getAttribute("xlink:href")||"",i=D(e.querySelector("Operation[name=GetCoverage]"),"Get")?.getAttribute("xlink:href")||"";return{getCapabilities:G(t),describeCoverage:G(s),getCoverage:G(i)}}function W(e,t){const s=R(e,"1.0.0"===t?"interpolationMethod":"InterpolationMethod"),i="1.0.0"===t?e.getAttribute("default"):k(e,"InterpolationMethods/Default");return null!=i?[i].concat(s.filter((e=>e.toLowerCase()!==i.toLowerCase()))):s}function z(e){return null==e?["nearest"]:e.map((e=>{const t=e.toLowerCase();return t.includes("nearest")?"nearest":t.includes("linear")?"bilinear":t.includes("cubic")?"cubic":null})).filter((e=>!!e))}function H(e){const t=T(e,"pos"),s=L(t[0]),i=L(t[1]);return new I({xmin:s[0],ymin:s[1],xmax:i[0],ymax:i[1],spatialReference:{wkid:4326}})}function Y(e,t){const s=R(e,t);return s?.length&&""!==s[0]&&!isNaN(Number(s[0]))?s.map((e=>Number(e))):null}function J(e){return null==e?null:e.every((t=>t===e[0]))?e[0]:e}function Q(e){const t=[],s=T(e,"RangeSet");let i=[];for(let e=0;e<s.length;e++){const o=k(s[e],"name"),n=k(s[e],"label"),r=[],a=Y(s[e],"nullValues/singleValue"),l=T(s[e],"AxisDescription");for(let e=0;e<l.length;e++){const t=k(l[e],"name"),s=k(l[e],"label"),o=R(l[e],"singleValue");if(0===o.length){const t=k(l[e],"min"),s=k(l[e],"max"),i=Number(k(l[e],"res"))||1;if(null!==t&&null!==s)for(let e=parseInt(t,10);e<=parseInt(s,10);e+=i)o.push(e.toString())}"band"===t.toLowerCase()&&(i=o),r.push({name:t,label:s,values:o})}t.push({name:o,label:n,nullValues:a,axis:r})}return{rangeSet:t,bandNames:i}}function K(e){const t=T(e,"timeposition");if(t.length>0){const e=[];for(let s=0;s<t.length;s++)e.push(new Date(k(t[s])));return{begin:e[0],end:e[e.length-1],values:e}}const s=D(e,"timePeriod")||D(e,"TimePeriod");return s?{begin:new Date(k(s,"beginPosition")||k(s,"BeginPosition")),end:new Date(k(s,"endPosition")||k(s,"EndPosition")),...function(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const s=["Years","Months","Days","Hours","Minutes","Seconds"];let i,o,n;return t.includes("PT")?(t=t.slice(2),n=["H","M","S"].findIndex((e=>t.includes(e))),i=s[3+n],o=parseFloat(t.substring(0,t.length-1))):(t=t.slice(1),n=["Y","M","D"].findIndex((e=>t.includes(e))),n>-1&&(i=s[n]),o=parseFloat(t.substring(0,t.length-1))),{resolution:o,units:i}}(k(s,"timeResolution")||k(s,"TimeResolution"))}:null}function X(e){const t=D(e,"spatialDomain"),s=D(t,"Envelope")||D(t,"EnvelopeWithTimePeriod"),i=s.getAttribute("srsName").split(":"),o=i[i.length-1],n=T(s,"pos"),r=L(n[0]),a=L(n[1]),l=parseInt(o,10),p=isNaN(l)?null:{wkid:l},m=new I({xmin:r[0],ymin:r[1],xmax:a[0],ymax:a[1],spatialReference:p}),c=D(t,"RectifiedGrid"),u=k(c,"low").split(" "),d=k(c,"high").split(" "),h=parseInt(d[0],10)-parseInt(u[0],10)+1,f=parseInt(d[1],10)-parseInt(u[1],10)+1,g=L(t,"origin/pos"),y=T(t,"offsetVector"),b={envelope:m,columns:h,rows:f,offset:{x:parseFloat(k(y[0]).split(" ")[0]),y:parseFloat(k(y[1]).split(" ")[1])},origin:{x:g[0],y:g[1]}},j=D(e,"temporalDomain")||D(e,"TemporalDomain");return{spatialDomain:b,temporalDomain:j?K(j):null}}function Z(e,t){const s=[],i=T(e,"Field");let o,n=[];for(let e=0;e<i.length;e++){const r=k(i[e],"Identifier"),a=k(i[e],"Description"),l=k(i[e],"Definition"),p=k(i[e],"Abstract"),m=k(i[e],"Title"),c=Y(i[e],"NullValue"),u=W(i[e],"1.1.0"),d=[],h=T(i[e],"Axis");for(let e=0;e<h.length;e++){const s=h[e].getAttribute("identifier"),i=k(h[e],"UOM"),r=k(h[e],"DataType"),a=R(h[e],"Key");t&&!s.toLowerCase().includes("band")||(n=a,o=c),d.push({identifier:s,uom:i,dataType:r,values:a,bandNoDataValues:o})}s.push({identifier:r,description:a,definition:l,abstract:p,title:m,supportedInterpolations:u,axis:d,nullValues:c})}return{rangeSet:s,bandNames:n,bandNoDataValues:o}}function ee(e){const t=D(e,"SpatialDomain"),s=D(t,"GridCRS"),i=k(s,"GridBaseCRS"),o=k(s,"GridOrigin"),n=o?.split(" ").map((e=>parseFloat(e)))??[0,0],r=L(s,"GridOffsets"),a=T(t,"BoundingBox");let l,p,m,c;for(let e=0;e<a.length;e++){const t=a[e].getAttribute("crs")?.toLowerCase();if(null!=t)if(t.includes("imagecrs")){const t=L(a[e],"LowerCorner"),s=L(a[e],"UpperCorner");l=s[0]-t[0]+1,p=s[1]-t[1]+1}else if(t.indexOf("epsg")>0){const s=t.split(":");m=parseInt(s[s.length-1],10);const i=L(a[e],"LowerCorner"),o=L(a[e],"UpperCorner");c=new I({xmin:i[0],ymin:i[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:m}})}}const u=l>p,d=c.xmax-c.xmin>c.ymax-c.ymin;let h=!1;C(m)&&(u===d?h=!1:(h=!0,c=new I({xmin:c.ymin,ymin:c.xmin,xmax:c.ymax,ymax:c.xmax,spatialReference:{wkid:m}})));const f={columns:l,rows:p,origin:{x:n[0],y:n[1]},offset:{x:r[0],y:r[r.length-1]},gridBaseCRS:i,envelope:c,useEPSGAxis:h},g=D(e,"temporalDomain")||D(e,"TemporalDomain");return{spatialDomain:f,temporalDomain:g?K(g):null}}function te(e){const t=D(e,"Envelope")||D(e,"EnvelopeWithTimePeriod"),s=t.getAttribute("srsName"),i=s.slice(s.lastIndexOf("/")+1),o=t.getAttribute("axisLabels").split(" ").map((e=>e.trim())).filter((e=>""!==e.trim())),n=L(t,"lowerCorner"),r=L(t,"upperCorner"),a=!["y","lat","latitude","north","nor","n","b"].includes(o[0].toLowerCase());let l;const p=parseInt(i,10),m=isNaN(p)?null:{wkid:p};l=new I(a?{xmin:n[0],ymin:n[1],xmax:r[0],ymax:r[1],spatialReference:m}:{xmin:n[1],ymin:n[0],xmax:r[1],ymax:r[0],spatialReference:m});const c={mins:n,maxs:r},u=t.getAttribute("uomLabels").trim().split(" ");let d,h;if(P(t,"EnvelopeWithTimePeriod")){d=new Date(k(e,"beginPosition")||k(e,"BeginPosition")),h=new Date(k(e,"endPosition")||k(e,"EndPosition"));const t=u?.findIndex((e=>"oledatetime"===e?.toLowerCase()));t>-1&&(u[t]="ISO8601")}return{envelope:l,axisLabels:o,uomLabels:u.length?u:null,envelopeAllDims:c,beginPosition:d,endPosition:h,isEastFirst:a}}function se(e,t){const s=[],i=T(e,"DataRecord"),o=[];let n,r=[];for(let e=0;e<i.length;e++){const a=T(i[e],"field"),l=[];for(let e=0;e<a.length;e++){const s=a[e].getAttribute("name"),i=k(a[e],"description")||"",p=D(a[e],"uom")?.getAttribute("code")||"",m=L(a[e],"interval"),c=Y(a[e],"nilValue")?.[0];t&&!s.toLowerCase().includes("band")||(o.push(s),m?.length&&(n=n||[],n.push({min:m[0],max:m[1],avg:-1,stddev:-1})),r.push(c)),l.push({name:s,description:i,uom:p,allowedValues:m,nilValue:c})}s.push(l)}return r.some((e=>null!=e))||(r=null),{rangeType:s,bandNames:o,bandStats:n,bandNoDataValues:r}}function ie(e){let t=1,s="";return Math.abs(e-1/24)<1/24*.01?s="Hours":Math.abs(e-1)<.01?s="Days":e<1?(t=Math.round(24*e),s="Hours"):e>27.99&&e<31.01||Math.round(e/30)<12?s="Months":e>364.99&&e<366.01&&(s="Years"),{interval:t,intervalUnit:s}}function oe(e,t){const s=D(e,"RectifiedGrid"),i=L(s,"low"),o=L(s,"high"),n=[];for(let e=0;e<i.length;e++)n.push(o[e]-i[e]+1);const r=k(s,"axisLabels").split(" "),a=L(s,"origin/pos"),l=T(s,"offsetVector"),p=[];for(let e=0;e<l.length;e++){const t=L(l[e]),s=t.findIndex((e=>0!==e));p[s]=t[s]}let m,c,u,d=!1;return t?.length&&r?.length&&(d=[...t].sort(((e,t)=>e<t?-1:1)).join(",")===[...r].sort(((e,t)=>e<t?-1:1)).join(",")),["y","lat","latitude","north","nor","n","b"].includes((d?r:t)[0].toLowerCase())?(m=n[1],c=n[0],u={y:Math.abs(p[0]),x:Math.abs(p[1])}):(m=n[0],c=n[1],u={x:Math.abs(p[0]),y:Math.abs(p[1])}),{columns:m,rows:c,origin:a,offset:p,resolution:u,gridSamples:n,axisLabels:r,hasSameAxisLabelsAsBoundedBy:d}}function ne(e){const t=D(e,"EarthObservation");if(!t)return null;const s=D(t,"phenomenonTime"),i=s?K(s):null,o=D(t,"phenomenonTime"),n=o?K(o):null,r=k(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let a=null;if(r){const e=r.split(" ").map((e=>e.trim())).filter((e=>null!=e&&""!==e));if(e.length){const t=[];for(let s=0;s<e.length/2;s+=2)t.push(e[s],e[s+1]);a=new U({rings:[t],spatialReference:{wkid:4326}})}}return{observation:{phenomenonTime:i,resultTime:n,footprint:a,identifier:k(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:k(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:k(e,"metaDataProperty/EarthObservationMetaData/status")}}}const re=["nearest neighbor","bilinear","bicubic"],ae=["nearest","linear","cubic"],le="response is not a supported multipart/related mediaType with inline tiff,  switching to compability mode";let pe=class extends u{constructor(){super(...arguments),this.datasetFormat="WCSServer"}async open(e){await this.init();const s=e?.signal,i=await this._getCapabilities(s);if(this.capabilities=i,!this.version){let e=i.capabilitiesVersion?.slice(0,3);"2.0"===e||"1.1"===e||"1.0"===e?this.version=i.capabilitiesVersion:(e=i.supportedVersions.find((e=>"2.0.1"===e))||i.supportedVersions.find((e=>"2.0"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.1"===e.slice(0,3)))||i.supportedVersions.find((e=>"1.0"===e.slice(0,3)))||"1.0.0",this.version=e)}const o=i.coverages.filter((e=>null==e.coverageSubType||""===e.coverageSubType||e.coverageSubType?.toLowerCase().startsWith("rectifiedgrid")));null==this.coverageId&&(this.coverageId=o[0].id);const n=o.find((e=>e.id===this.coverageId));if(null==n)throw new t("wcsraster-open",`the coverageId ${this.coverageId} does not exist in capabilities`);const r=await this._describeCoverage(s);this.coverageInfo=r[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=n.lonLatEnvelope,this.coverageInfo.supportedInterpolations=z(i.supportedInterpolations)),this.datasetName=this.coverageInfo.title;const{rasterInfo:a}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(a,512,512),this._set("rasterInfo",a),null==a.spatialReference)throw new t("wcsraster-open",`coverage without spatial referernce is not supported: ${this.coverageId}`);const{pixelType:l,bandCount:p}=await this._getPixelTypeAndBandCount(s);a.pixelType=l,1===a.bandCount&&p>1&&(a.bandCount=p),this.updateTileInfo()}async fetchRawTile(e,o,n,r={}){if(this.isBlockOutside(e,o,n))return null;const{nativePixelSize:a,spatialReference:l}=this.rasterInfo,p=2**e,m=a.x*p,c=a.y*p,{blockWidth:u,blockHeight:d}=this.getBlockWidthHeight(e),{origin:h}=this.rasterInfo.storageInfo.tileInfo,f=this.getTileExtent({x:m,y:c},o,n,h,l,[u,d]),g=this.rasterInfo.extent,y=f.xmax>g.xmax,b=f.ymin<g.ymin,j=y||b;let v=f,x=u,w=d;if(j&&(v=f.clone().intersection(g),s(v)&&(y&&(x=Math.floor((v.xmax-v.xmin)/m),v.xmax=v.xmin+m*x),b&&(w=Math.floor((v.ymax-v.ymin)/c),v.ymin=v.ymax-c*w))),i(v)||x<=1||w<=1)return null;const C=await this._getCoverage(v,x,w,p,r);if(!C)return null;const{coverageDescription:S}=this.coverageInfo;let{noDataValue:I,multidimensionalInfo:k}=this.rasterInfo;const{multidimensionalDefinition:D}=r;if(s(k)&&s(D)&&D.length){const e=D[0].variableName;if("2.0"===S.version){const t=S.rangeType[0].find((t=>t.name===e));I=t?.nilValue}else if("1.1"===S.version){const t=S.range.find((t=>t.identifier===e));I=t?.nullValues}}const T=await this.decodePixelBlock(C,{width:x,height:w,planes:null,pixelType:null,noDataValue:Array.isArray(I)?I[0]:I});if(null==T)return null;if(T&&(T.width!==x||T.height!==w))throw new t("wcsraster-fetch",`the reponse has unexpected dimension width: ${T.width}, height: {pixelBlock.height}`);return j?O(T,{x:0,y:0},{width:d,height:d}):T}async _getCapabilities(e){const s={service:"WCS",request:"GetCapabilities"};this.version&&(s.version=this.version,s.acceptVersions=this.version);try{const{data:i}=await this.request(this.url,{query:s,responseType:"xml",signal:e});return function(e,s=null){let i=null;i="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e;const o=i.documentElement.getAttribute("version"),n=(o||s||"1.0.0").slice(0,3);let r;if("2.0"===n)r=function(e){const t=D(e,"ServiceIdentification"),s=k(t,"Title"),i=R(t,"ServiceTypeVersion"),o=R(t,"Profile"),n=q(D(e,"OperationsMetadata")),r=T(e,"Contents/CoverageSummary"),a=[];for(let e=0;e<r.length;e++){const t=r[e],s=k(t,"CoverageId"),i=D(t,"WGS84BoundingBox");let o;if(i){const e=L(i,"LowerCorner"),t=L(i,"UpperCorner");o=new I({xmin:e[0],ymin:e[1],xmax:t[0],ymax:t[1],spatialReference:{wkid:4326}})}const n=k(t,"CoverageSubtype")||"RectifiedGridCoverage";a.push({id:s,lonLatEnvelope:o,coverageSubType:n})}const l=D(e,"ServiceMetadata");return{name:s,supportedVersions:i,supportedFormats:R(l,"formatSupported"),supportedInterpolations:R(l,"interpolationSupported").concat(R(l,"InterpolationSupported")),onlineResources:n,profiles:o,coverages:a}}(i);else if("1.1"===n)r=function(e){const t=k(e,"ServiceIdentification/Title"),s=R(e,"ServiceIdentification/ServiceTypeVersion"),i=q(D(e,"OperationsMetadata")),o=[],n=D(e,"Contents");for(let e=0;e<n.childNodes.length;e++){const t=n.childNodes[e];1===t.nodeType&&P(t,"CoverageSummary")&&_(B(t),o)}return{name:t,onlineResources:i,coverages:o,supportedVersions:s,supportedFormats:R(n,"SupportedFormat")}}(i);else{if("1.0"!==n)throw new t("wcsraster:parsecapabilities","the capabilities version is not supported");r=function(e){const t=k(e,"Service/name"),s=D(e,"Capability"),i=D(s,"GetCapabilities/Get/OnlineResource")?.getAttribute("xlink:href")??"",o=D(s,"DescribeCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",n=D(s,"GetCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",r={getCapabilities:G(i),describeCoverage:G(o),getCoverage:G(n)},a=T(e,"CoverageOfferingBrief"),l=[];for(let e=0;e<a.length;e++){const t=a[e],s=k(t,"name"),i=T(t,"pos"),o=L(i[0]),n=L(i[1]),r=new I({xmin:o[0],ymin:o[1],xmax:n[0],ymax:n[1],spatialReference:{wkid:4326}});l.push({id:s,lonLatEnvelope:r})}return{name:t,onlineResources:r,coverages:l,supportedVersions:["1.0.0"]}}(i)}return r.capabilitiesVersion=o,r}(i)}catch(e){if(!w(e))throw new t("wcslayer:open","wcs capabilities is not valid or supported");throw e}}async _describeCoverage(e){const s={service:"WCS",request:"DescribeCoverage",version:this.version},i=this.version?.slice(0,3);"1.0"===i?s.coverage=this.coverageId:"1.1"===i?s.identifiers=this.coverageId:"2.0"===i&&(s.coverageId=this.coverageId);try{const{data:t}=await this.request(this.url,{query:s,responseType:"xml",signal:e});return function(e,t){let s=null;if(s="string"==typeof e?(new DOMParser).parseFromString(e,"text/xml"):e,"1.0.0"===t)return T(s,"CoverageOffering").map((e=>function(e){const t={version:"1.0"};let s,i=[];for(let n=0;n<e.childNodes.length;n++){const r=e.childNodes[n];if(1===r.nodeType)if(P(r,"description"))t.description=k(r);else if(P(r,"name"))t.name=k(r);else if(P(r,"label"))t.label=k(r);else if(P(r,"supportedFormats"))t.supportedFormats=R(r,"formats");else if(P(r,"supportedCRSs"))t.supportedCRSs={requestResponseCRSs:R(o=r,"requestResponseCRSs").map((e=>e.split(":")[1])),nativeCRSs:R(o,"nativeCRSs").map((e=>e.split(":")[1]))};else if(P(r,"supportedInterpolations"))t.supportedInterpolations=W(r,"1.0.0");else if(P(r,"lonLatEnvelope"))t.lonLatEnvelope=H(r);else if(P(r,"rangeSet")){const e=Q(r);t.rangeSet=e.rangeSet,i=e.bandNames;const o=e.rangeSet[0].nullValues;o?.length&&(s=J(o))}else P(r,"domainSet")&&(t.domainSet=X(r))}var o;const n=z(t.supportedInterpolations),{name:r,description:a,label:l,lonLatEnvelope:p,supportedFormats:m}=t,{spatialDomain:c}=t.domainSet,u={x:Math.abs(c.offset.x),y:Math.abs(c.offset.y)},d=function(e){if(!e.temporalDomain)return null;const{begin:t,end:s,values:i,units:o,resolution:n}=e.temporalDomain;return{variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:i?.map((e=>e.getTime())),hasRegularIntervals:!i,interval:n,intervalUnit:o,extent:[t.getTime(),s.getTime()]}]}]}}(t.domainSet),h=new A({width:c.columns,height:c.rows,pixelSize:u,extent:c.envelope,spatialReference:c.envelope.spatialReference,bandCount:i.length||1,noDataValue:s,multidimensionalInfo:d});return{id:r,title:t.name,description:a||l,lonLatEnvelope:p,rasterInfo:h,bandNames:i,supportedFormats:m,supportedInterpolations:n,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}(e)));const i=T(s,"CoverageDescription");return"1.1.0"===t||"1.1.1"===t||"1.1.2"===t?i.map((e=>function(e,t){const s=[],i=[],o={supportedFormats:s,supportedCRSs:i,version:"1.1"};let n,r=[];for(let t=0;t<e.childNodes.length;t++){const a=e.childNodes[t];if(1!==a.nodeType)continue;const l=M(a).toLowerCase();switch(l){case"title":case"abstract":case"identifier":o[l]=k(a);break;case"supportedformat":{const e=k(a);s.includes(e)||s.push(e)}break;case"supportedcrs":{const e=k(a);i.includes(e)||i.push(e)}break;case"range":{const e=Z(a,!!o.domain?.temporalDomain);o.range=e.rangeSet,r=e.bandNames;const{bandNoDataValues:t}=e;t?.length&&(n=J(t))}break;case"domain":o.domain=ee(a)}}const a=z(o.range[0].supportedInterpolations),{identifier:l,abstract:p,title:m,domain:c,range:u}=o,d={x:Math.abs(c.spatialDomain.offset.x),y:Math.abs(c.spatialDomain.offset.y)},h=function(e,t){if(!t.temporalDomain)return null;const s=e.filter((e=>!e.identifier.toLowerCase().includes("field_1")&&!e.axis.some((e=>e.identifier.includes("band"))))),i=[];if(s.length&&s.forEach((e=>{const t=e.axis.map((e=>{const t=e.values.map((t=>"ISO8601"===e.uom?(t=t.trim()).toLowerCase().includes("z")?new Date(t).getTime():new Date(t+"Z").getTime():parseFloat(t.trim()))),s=[Math.min.apply(null,t),Math.max.apply(null,t)];return{name:e.identifier.trim(),description:"",field:e.identifier.trim(),unit:e.uom?e.uom.trim():"",hasRegularIntervals:!1,values:t,extent:s}}));i.push({name:e.identifier.trim(),description:e.description?.trim()??"",unit:"",dimensions:t})})),t.temporalDomain){const{begin:e,end:s,values:o,units:n,resolution:r}=t.temporalDomain;i.some((e=>e.dimensions.some((e=>"stdtime"===e.name.toLowerCase()))))||i.forEach((t=>{t.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:o?.map((e=>e.getTime())),hasRegularIntervals:!o,interval:r,intervalUnit:n,extent:[e.getTime(),s.getTime()]})}))}return i.length?{variables:i}:null}(u,c);h&&(n=u[0].nullValues,1===n?.length&&(n=n[0]));const f=new A({width:c.spatialDomain.columns,height:c.spatialDomain.rows,pixelSize:d,extent:c.spatialDomain.envelope,spatialReference:c.spatialDomain.envelope.spatialReference,bandCount:r.length||1,noDataValue:n,multidimensionalInfo:h});return{id:l,title:o.title,description:p||m,lonLatEnvelope:null,bandNames:r,rasterInfo:f,supportedFormats:s,supportedInterpolations:a,coverageDescription:o,version:t,useEPSGAxis:c.spatialDomain.useEPSGAxis}}(e,t))):i.map((e=>function(e){const t={version:"2.0"};let s,i,o=[];for(let n=0;n<e.childNodes.length;n++){const r=e.childNodes[n];if(1===r.nodeType)if(P(r,"coverageId"))t.coverageId=k(r);else if(P(r,"ServiceParameters"))t.serviceParameters={supportedFormats:R(r,"nativeFormat")};else if(P(r,"boundedBy"))t.boundedBy=te(r);else if(P(r,"rangeType")){const e=se(r,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=e.rangeType,o=e.bandNames,s=e.bandStats;const{bandNoDataValues:n}=e;n?.length&&(i=J(n))}else if(P(r,"domainSet"))t.domainSet=oe(r,t.boundedBy?.axisLabels);else if(P(r,"metadata")){const e=D(r,"EOMetadata");t.eoMetadata=e?ne(e):null}}const{coverageId:n,boundedBy:r,domainSet:a,rangeType:l,serviceParameters:p}=t,m=function(e,t,s){if(s.axisLabels.length<=2)return null;const i=[];for(let t=0;t<e.length;t++){const s=e[t];for(let e=0;e<s.length;e++)s[e].name.toLowerCase().includes("band")||i.push(s[e])}const o=[];if(i.length){const e=[];for(let i=2;i<s.axisLabels.length;i++){const o=(t.uomLabels?.length??0)>i?t.uomLabels?.[i]:"",n=s.axisLabels[i].toLowerCase().includes("time")||"iso8601"===o.toLowerCase()||"oledatetime"===o.toLowerCase();let r,a;if(n){const e=ie(s.offset[i]);r=e.interval,a=e.intervalUnit}else r=s.offset[i],a=o;const l=[];n?(l.push((new Date).setTime(24*(t.envelopeAllDims.mins[i]-25569)*3600*1e3)),l.push((new Date).setTime(24*(t.envelopeAllDims.maxs[i]-25569)*3600*1e3))):(l.push(t.envelopeAllDims.mins[i]),l.push(t.envelopeAllDims.maxs[i])),e.push({name:s.axisLabels[i].trim(),description:s.axisLabels[i].trim(),unit:t.uomLabels&&t.uomLabels.length>i?t.uomLabels[i].trim():"",hasRegularIntervals:!0,extent:l,interval:r,intervalUnit:a})}if(i.forEach((t=>{const{allowedValues:s}=t,i=2===s?.length?[{min:s[0],max:s[1],avg:-1,stddev:-1}]:null;o.push({name:t.name.trim(),description:t.description?.trim()??"",unit:t.uom.trim(),statistics:i,dimensions:e})})),o.length)return{variables:o}}return null}(l,r,a);return!s&&m&&(s=m?.variables[0].statistics),null!=m&&(i=l[0][0].nilValue),{id:n,title:n,description:n,lonLatEnvelope:null,bandNames:o,rasterInfo:new A({width:a.columns,height:a.rows,pixelSize:a.resolution,extent:r.envelope,spatialReference:r.envelope.spatialReference,bandCount:o.length||1,statistics:s,noDataValue:i,multidimensionalInfo:m}),supportedFormats:p.supportedFormats,supportedInterpolations:null,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}(e)))}(t,this.version)}catch(e){if(!w(e))throw new t("wcslayer:open","wcs coverage description is not valid or supported");throw e}}async _getPixelTypeAndBandCount(e){const{pixelSize:i,extent:n,multidimensionalInfo:r}=this.rasterInfo,a=n.center,l=new I({xmin:a.x-i.x,xmax:a.x+i.x,ymin:a.y-i.y,ymax:a.y+i.y,spatialReference:n.spatialReference});let p=[];if(s(r)){const e=r.variables[0];p=[],e.dimensions.forEach((t=>{p.push(new S({variableName:e.name,dimensionName:t.name,values:t.hasRegularIntervals?t.extent[0]:t.values?.[0],isSlice:!0}))}))}const{coverageDescription:m}=this.coverageInfo,c={interpolation:"nearest",multidimensionalDefinition:p,signal:o(e)},{version:u}=m,{ioConfig:d}=this,h="2.0"===u&&null==d.allowAnyMediaType||"1.1"===u&&null==d.use2GridOffsets;let f;try{f=await this._getCoverage(l,2,2,1,c,!0)}catch(e){if(!h)throw e;if("1.1"===u){if(!e.details?.isResolutionMismatch)throw e;d.use2GridOffsets=!0}}if(!f&&h&&("2.0"===u&&(d.allowAnyMediaType=!0),f=await this._getCoverage(l,2,2,1,c),f&&x.getLogger(this.declaredClass).warn("wcsraster:getcoverage",le)),!f)throw new t("wcsraster-open","unable to determine pixel type");const g=await this.decodePixelBlock(f,{width:2,height:2,planes:null,pixelType:null});if(null==g)throw new t("wcsraster-open","unable to determine pixel type");return{pixelType:g.pixelType,bandCount:g.getPlaneCount()??0}}async _getCoverage(e,s,i,o,n,r=!1){const{coverageDescription:a}=this.coverageInfo,{version:l}=a,p="2.0"===l?this._getCoverage201Parameters(e,s,i,o,n,a):"1.1"===l?this._getCoverage110Parameters(e,s,i,n,a):this._getCoverage100Parameters(e,s,i,n),m="2.0"===l?await this.request(this._constructWCS201Url(p),{signal:n.signal,responseType:"array-buffer"}):await this.request(this.url,{query:p,signal:n.signal,responseType:"array-buffer"});if("1.0"===l)return m.data;if("2.0"===l&&!1!==this.ioConfig.allowAnyMediaType&&"tiff"===E(m.data))return r&&(this.ioConfig.allowAnyMediaType=!0,x.getLogger(this.declaredClass).warn("wcsraster:getcoverage",le)),m.data;const c=function(e){const t=function(e){const t=e.getHeader?.("Content-Type")?.split(";");if(!(t?.[0].trim()??"").startsWith("multipart/"))return null;const s={boundary:"",start:"",type:""};for(let e=1;e<t.length;e++){const i=t[e].indexOf("=");if(i>0){const o=t[e].slice(0,i).trim(),n=t[e].slice(i+1).trim();s[o]=n.startsWith('"')?n.slice(1,n.length-1):n}}return s}(e);return t?{isMultipart:!0,data:t.boundary?$(e.data,t,0):null}:{isMultipart:!1,data:null}}(m);if(c.isMultipart&&c.data){const e=c.data.find((e=>e.contentType?.toLowerCase().includes("image")&&null!=e.contentData));return r&&"base64"===e?.contentTransferEncoding&&x.getLogger(this.declaredClass).warn("wcsraster:getcoverage","response is base64 encoded which may impact layer display performance"),e?.contentData}const u=new Uint8Array(m.data,0,Math.min(m.data.byteLength,2e3)),d=String.fromCharCode.apply(null,u).toLowerCase().includes("exception"),h=d&&String.fromCharCode.apply(null,u).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");if(d)throw new t("wcsraster:getcoverage","server returns an exception",{isResolutionMismatch:h});throw new t("wcsraster:getcoverage","response is not a supported multipart mediaType with inline tiff")}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?"nearest"===e?0:"bilinear"===e?1:"cubic"===e?2:0:0}_getCoverage100Parameters(e,t,i,o){const n=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,r=e.spatialReference.wkid,a=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"GEOTIFF",{bandIds:l,interpolation:p}=o,m=this._getInterpolationIndex(p),c=l?l.map((e=>this.coverageInfo.bandNames[e])):null,u=re[m],{multidimensionalDefinition:d}=o;let h;if(s(d)&&s(this.rasterInfo.multidimensionalInfo)){const e=d.find((e=>"StdTime"===e.dimensionName));let t=e?.values;t&&t.length>0&&(t[0]instanceof Array&&(t=t[0]),h=t.map((e=>this._convertToISOTime(e))).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:a,crs:`EPSG:${r}`,bbox:n,width:t,height:i,time:h,interpolation:u,band:c?.join(",")}}_getCoverage110Parameters(e,t,i,o,n){const{multidimensionalDefinition:r,bandIds:a,interpolation:l}=o,p=e.spatialReference.wkid,m=`urn:ogc:def:crs:EPSG::${p}`,c=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",u=this._getInterpolationIndex(l),d=ae[u],h=null==l||0===this.coverageInfo.supportedInterpolations?.indexOf(l),f=n.domain.spatialDomain,g=f.origin.x<=f.envelope.xmin&&f.origin.y<=f.envelope.ymin,y=e.width/t,b=e.height/i*(g?1:-1),j=g?[e.xmin,e.ymin]:[e.xmin,e.ymax],v=f.useEPSGAxis&&C(p),x=v?`${j[1]},${j[0]}`:`${j[0]},${j[1]}`,w=this.ioConfig.use2GridOffsets,S=v?w?`${b},${y}`:`${b},0,0,${y}`:w?`${y},${b}`:`${y},0,0,${b}`,I=y/2,k=e.xmin+I,D=e.xmax-I,T=Math.abs(b)/2,L=e.ymin+T,R=e.ymax-T,P=v?`${L},${k},${R},${D},${m}`:`${k},${L},${D},${R},${m}`,M=n.range.find((e=>e.axis.some((e=>e.identifier.toLowerCase().includes("band")))));let U,A=M&&d&&a?h?`${M.identifier}[${M.axis[0].identifier}[${a.join(",")}]]`:`${M.identifier}:${d}[${M.axis[0].identifier}[${a.join(",")}]]`:null;if(s(r)&&r.length)for(let e=0;e<r.length;e++){let t=r[e].values;const s=r[e].dimensionName?.toLowerCase(),i=r[e].variableName?.toLowerCase();if(t.length>0)if(t[0]instanceof Array&&(t=t[0]),"stdtime"===s)U=t.map((e=>this._convertToISOTime(e))).join(",");else{const e=n.range.find((e=>e.identifier.toLowerCase()===i));if(e){const i=e.axis.find((e=>e.identifier.toLowerCase()===s));i&&(A=h?e.identifier+"["+i.identifier+"["+t.join(",")+"]]":e.identifier+":"+d+"["+i.identifier+"["+t.join(",")+"]]")}}}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:c,crs:`EPSG:${p}`,boundingbox:P,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:x,gridOffsets:S,gridBaseCRS:m,timeSequence:U,rangeSubset:A}}_convertToISOTime(e,t=!1){return(t?new Date(24*(e-25569)*60*60*1e3):new Date(e)).toISOString()}_getCoverage201Parameters(e,t,i,o,n,r){const{multidimensionalDefinition:a,interpolation:l}=n,p=this._getInterpolationIndex(l);let m=null;const{supportedInterpolations:c}=this.capabilities;if(c?.length)switch(p){case 0:m=c.find((e=>e.toLowerCase().includes("nearest")));break;case 1:m=c.find((e=>e.toLowerCase().includes("linear")));break;case 2:m=c.find((e=>e.toLowerCase().includes("cubic")||e.toLowerCase().includes("quadratic")))}const u=(this.coverageInfo.supportedFormats||[]).find((e=>e.toLowerCase().includes("tiff")))||"image/tiff",{bandNames:d}=this.coverageInfo,{boundedBy:h,domainSet:f,rangeType:g}=r,y=h.isEastFirst?0:1,b=1-y,{axisLabels:j}=h,v=j[y],x=j[b],w=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,C=w,S=[];S.push(`${v}(${e.xmin},${e.xmax})`),S.push(`${x}(${e.ymin},${e.ymax})`);const I=[];if(j.length>2)for(let e=2;e<j.length;e++){const t=f.origin[e];if(j[e].toLowerCase().includes("time")){let s=t.toString();h.uomLabels?.[e].toLowerCase().includes("ole")&&(I.push(j[e]),s=this._convertToISOTime(t,!0)),S.push(j[e]+",http://www.opengis.net("+s+")")}else S.push(j[e]+",http://www.opengis.net("+t+")")}let k=null;if(s(a)&&a.length){const e=[];g.forEach((t=>t.forEach((t=>e.push(t.name)))));const t=[];for(let s=0;s<a.length;s++){const i=j.find((e=>e===a[s].dimensionName)),o=e.find((e=>e===a[s].variableName));if(t.includes(o)||t.push(o),i){let e=a[s].values;if(e.length>0){Array.isArray(e[0])&&(e=e[0]);let t="";t=i.toLowerCase().includes("time")?e.map((e=>this._convertToISOTime(e))).join(","):e.join(",");const s=S.findIndex((e=>0===e.indexOf(i+",http://www.opengis.net")));-1===s&&S.push(i+",http://www.opengis.net("+t+")"),-1===s||S[s].includes("("+t+")")||S.splice(s,1,i+",http://www.opengis.net("+t+")")}}}t.length&&(k=t.join(","))}else d?.length>=2&&(k=(n.bandIds?n.bandIds.map((e=>d[e])):d).join(","));const D=S.join("&subset="),T=!r.domainSet.hasSameAxisLabelsAsBoundedBy&&!1!==this.ioConfig.allowScaleFactor,L=T?null:`${v}(${t}),${x}(${i})`,R=T?1/o:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:k,interpolation:m,scaleSize:L,scaleFactor:R,subset:D,format:u,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:w,subsettingcrs:C}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},s=[];return Object.keys(t).forEach((e=>{const i=t[e];null!=i&&("subset"===e?i.split("&subset=").forEach((e=>{e&&s.push(`subset=${encodeURIComponent(e)}`)})):s.push(`${e}=${encodeURIComponent(i)}`))})),`${encodeURI(this.url)}?${s.join("&")}`}};e([a({type:String,json:{write:!0}})],pe.prototype,"datasetFormat",void 0),e([a()],pe.prototype,"tileType",void 0),e([a({type:String,json:{write:!0}})],pe.prototype,"version",void 0),e([a({type:String,json:{write:!0}})],pe.prototype,"coverageId",void 0),pe=e([l("esri.layers.support.rasterDatasets.WCSRaster")],pe);const me=pe,ce=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let ue=class extends(m(y(h(f(c(d(b(g(n(p)))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=s(e)?e.signal:null;return this.addResolvingPromise(this._openRaster(t)),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){return[new v({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})]}createPopupTemplate(e){return V({fields:this.rasterFields,title:this.title},e)}async _openRaster(e){const i=new me({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await i.open({signal:e}),!i.rasterInfo)throw i.destroy(),new t("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:o}=i;this._set("rasterInfo",o),this._set("spatialReference",o.spatialReference),null==this.title&&this.setAtOrigin("title",i.datasetName,"service"),null==this.coverageId&&this.setAtOrigin("coverageId",i.coverageInfo.id,"service");const{multidimensionalInfo:n}=o;if(s(n)){const e=n.variables[0].dimensions.find((({name:e})=>"StdTime"===e));if(e){let t=e.extent?.[0]??e.values[0];Array.isArray(t)&&(t=t[0]);let s=e.extent?.[1]??e.values[e.values.length-1];Array.isArray(s)&&(s=s[1]);const i=ce.has(e.intervalUnit?.toLowerCase())?e.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:t,end:s},timeReference:null,interval:i?{value:e.interval,unit:i}:null})}}this.raster=i,this._configDefaultSettings(),this.addHandles(r((()=>this.customParameters),(e=>this.raster.ioConfig.customFetchParameters=e)))}};e([a({type:String,nonNullable:!0,json:{write:!0}})],ue.prototype,"coverageId",void 0),e([a()],ue.prototype,"coverageInfo",null),e([a()],ue.prototype,"version",void 0),e([a()],ue.prototype,"isReference",void 0),e([a()],ue.prototype,"raster",void 0),e([a({readOnly:!0})],ue.prototype,"type",void 0),e([a(j)],ue.prototype,"popupEnabled",void 0),e([a()],ue.prototype,"popupTemplate",void 0),e([a({readOnly:!0})],ue.prototype,"defaultPopupTemplate",null),e([a({readOnly:!0,type:[v]})],ue.prototype,"fields",void 0),e([a({readOnly:!0,type:[v]})],ue.prototype,"rasterFields",null),ue=e([l("esri.layers.WCSLayer")],ue);const de=ue;export{de as default};
