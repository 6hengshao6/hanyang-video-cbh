/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../request.js";import r from"../core/Collection.js";import i from"../core/Error.js";import{clone as s}from"../core/lang.js";import{i as o}from"../chunks/maybe.js";import{M as a}from"../chunks/MultiOriginJSONSupport.js";import{g as n}from"../chunks/object.js";import{waitTick as l,throwIfAbortError as c}from"../core/promiseUtils.js";import{watch as p,on as m,sync as u}from"../core/reactiveUtils.js";import{urlToObject as d,objectToQuery as h}from"../core/urlUtils.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import{r as y}from"../chunks/reader.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{w}from"../chunks/writer.js";import v from"../geometry/Extent.js";import j from"./Layer.js";import x,{W as S}from"./WebTileLayer.js";import{BlendLayer as M}from"./mixins/BlendLayer.js";import{O as L}from"../chunks/OperationalLayer.js";import{PortalLayer as I}from"./mixins/PortalLayer.js";import{RefreshableLayer as T}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as b}from"./mixins/ScaleRangeLayer.js";import{c as k}from"../chunks/imageBitmapUtils.js";import C from"./support/TileInfo.js";import P from"./support/WMTSSublayer.js";import{A as R,F as U}from"../chunks/unitUtils.js";import E from"../geometry/Point.js";import{i as A}from"../chunks/crsUtils.js";import{v as O}from"../chunks/xmlUtils.js";import V from"./support/LOD.js";import"../config.js";import"../chunks/typedArrayUtil.js";import"../kernel.js";import"../chunks/Logger.js";import"../chunks/string.js";import"../chunks/ArrayPool.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/metadata.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../core/JSONSupport.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../chunks/jsonMap.js";import"../chunks/Ellipsoid.js";import"../geometry/support/webMercatorUtils.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/common.js";import"../chunks/vec4.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/screenUtils.js";import"../chunks/mat4f32.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../chunks/commonProperties2.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/persistableUrlUtils.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"./support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../chunks/opacityUtils.js";import"../chunks/asyncUtils.js";import"../chunks/layerUtils.js";import"../portal/Portal.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalItem.js";import"../chunks/assets.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/portalItemUtils.js";import"../geometry/projection.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/TileKey.js";import"./support/TileMatrixSet.js";import"./support/WMTSStyle.js";class _{constructor(e,t=0,r=e.lods.length-1){this.tileInfo=e,this.minLOD=t,this.maxLOD=r}getAvailability(e,t,r){const i=this.tileInfo?.lodAt(e);return!i||e<this.minLOD||e>this.maxLOD?"unavailable":i.cols&&i.rows?r>=i.cols[0]&&r<=i.cols[1]&&t>=i.rows[0]&&t<=i.rows[1]?"available":"unavailable":"available"}async fetchAvailability(e,t,r,i){return await l(i),this.getAvailability(e,t,r)}async fetchAvailabilityUpsample(e,t,r,i,s){await l(s),i.level=e,i.row=t,i.col=r;const o=this.tileInfo;for(o.updateTileInfo(i);;){const e=this.getAvailability(i.level,i.row,i.col);if("unavailable"!==e)return e;if(!o.upsampleTile(i))return"unavailable"}}}const F=90.71428571428571;function N(e){const t=e.replace(/ows:/gi,"");if(!D("Contents",(new DOMParser).parseFromString(t,"text/xml").documentElement))throw new i("wmtslayer:wmts-capabilities-xml-is-not-valid","the wmts get capabilities response is not compliant",{text:e})}function W(e){return e.nodeType===Node.ELEMENT_NODE}function D(e,t){for(let r=0;r<t.childNodes.length;r++){const i=t.childNodes[r];if(W(i)&&i.nodeName===e)return i}return null}function B(e,t){const r=[];for(let i=0;i<t.childNodes.length;i++){const s=t.childNodes[i];W(s)&&s.nodeName===e&&r.push(s)}return r}function K(e,t){const r=[];for(let i=0;i<t.childNodes.length;i++){const s=t.childNodes[i];W(s)&&s.nodeName===e&&r.push(s)}return r.map((e=>e.textContent)).filter(o)}function $(e,t){return e.split(">").forEach((e=>{t&&(t=D(e,t))})),t&&t.textContent}function G(e,t,r,i){let s;return Array.prototype.slice.call(i.childNodes).some((i=>{if(i.nodeName.includes(e)){const e=D(t,i),o=e&&e.textContent;if(o===r||r.split(":")&&r.split(":")[1]===o)return s=i,!0}return!1})),s}function q(e,t){const r=[],i=e.layerMap?.get(t);if(!i)return null;const s=B("ResourceURL",i),o=B("Dimension",i);let a,n,l,c;return o.length&&(a=$("Identifier",o[0]),n=K("Default",o[0])||K("Value",o[0])),o.length>1&&(l=$("Identifier",o[1]),c=K("Default",o[1])||K("Value",o[1])),e.dimensionMap.set(t,{dimensions:n,dimensions2:c}),s.forEach((e=>{let t=e.getAttribute("template");if("tile"===e.getAttribute("resourceType")){if(a&&n.length)if(t.includes("{"+a+"}"))t=t.replace("{"+a+"}","{dimensionValue}");else{const e=t.toLowerCase().indexOf("{"+a.toLowerCase()+"}");e>-1&&(t=t.substring(0,e)+"{dimensionValue}"+t.substring(e+a.length+2))}if(l&&c.length)if(t.includes("{"+l+"}"))t=t.replace("{"+l+"}","{dimensionValue2}");else{const e=t.toLowerCase().indexOf("{"+l.toLowerCase()+"}");e>-1&&(t=t.substring(0,e)+"{dimensionValue2}"+t.substring(e+l.length+2))}r.push({template:t,format:e.getAttribute("format"),resourceType:"tile"})}})),r}function H(e){e=e.toLowerCase();let t=parseInt(e.split(":").pop(),10);900913!==t&&3857!==t||(t=102100);const r=function(e){return e.includes("crs84")||e.includes("crs:84")?z.CRS84:e.includes("crs83")||e.includes("crs:83")?z.CRS83:e.includes("crs27")||e.includes("crs:27")?z.CRS27:null}(e);return o(r)&&(t=r),{wkid:t}}function J(e,t){const r=H(t),[i,s]=$("TopLeftCorner",e).split(" ").map((e=>parseFloat(e))),o=t.includes("epsg")&&A(r.wkid);return new E(o?{x:s,y:i,spatialReference:r}:{x:i,y:s,spatialReference:r})}var z;function Q(e,t,r,i,s){const o=H(t),a=$("Identifier",e);let n=parseFloat($("ScaleDenominator",e));const l=X(o.wkid,n,i);n*=96/F;const c=+$("MatrixWidth",e),p=+$("MatrixHeight",e),{maxCol:m=c-1,maxRow:u=p-1,minCol:d=0,minRow:h=0}=s.get(a)??{},{x:f,y}=J(e,t);return new V({cols:[d,m],level:r,levelValue:a,origin:[f,y],scale:n,resolution:l,rows:[h,u]})}function X(e,t,r){let i;return i=R.hasOwnProperty(""+e)?R.values[R[e]]:"default028mm"===r?6370997*Math.PI/180:U(e).metersPerDegree,7*t/25e3/i}!function(e){e[e.CRS84=4326]="CRS84",e[e.CRS83=4269]="CRS83",e[e.CRS27=4267]="CRS27"}(z||(z={}));const Y={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},Z=new Set(["version","service","request","layer","style","format","tilematrixset","tilematrix","tilerow","tilecol"]);let ee=class extends(M(T(b(L(I(a(j))))))){constructor(...e){super(...e),this.copyright="",this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType="WebTiledLayer",this.resourceInfo=null,this.serviceMode="RESTful",this.sublayers=null,this.type="wmts",this.version="1.0.0",this.addHandles([p((()=>this.activeLayer),((e,t)=>{t&&(t.layer=null),e&&(e.layer=this)}),u),m((()=>this.sublayers),"after-add",(({item:e})=>{e.layer=this}),u),m((()=>this.sublayers),"after-remove",(({item:e})=>{e.layer=null}),u),p((()=>this.sublayers),((e,t)=>{if(t)for(const e of t)e.layer=null;if(e)for(const t of e)t.layer=this}),u)])}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){if("KVP"===this.serviceMode||"RESTful"===this.serviceMode)return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},e).catch(c).then((()=>this._fetchService(e))).catch((e=>{throw c(e),new i("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:e})}))),Promise.resolve(this);console.error("WMTS mode could only be 'KVP' or 'RESTful'")}get activeLayer(){return this._get("activeLayer")}set activeLayer(e){this._set("activeLayer",e)}readActiveLayerFromService(e,t,r){this.activeLayer||(this.activeLayer=new P);let i=t.layers.find((e=>e.id===this.activeLayer.id));return i||(i=t.layers[0]),this.activeLayer.read(i,r),this.activeLayer}readActiveLayerFromItemOrWebDoc(e,t){const{templateUrl:r,wmtsInfo:i}=t,s=r?this._getLowerCasedUrlParams(r):null,o=i?.layerIdentifier;let a=null;const n=i?.tileMatrixSet;n&&(Array.isArray(n)?n.length&&(a=n[0]):a=n);const l=s?.format,c=s?.style;return new P({id:o,imageFormat:l,styleId:c,tileMatrixSetId:a})}writeActiveLayer(e,t,r,i){const s=this.activeLayer;t.templateUrl=this.getUrlTemplate(s.id,s.tileMatrixSetId,s.imageFormat,s.styleId);const o=n("tileMatrixSet.tileInfo",s);t.tileInfo=o?o.toJSON(i):null,t.wmtsInfo={...t.wmtsInfo,layerIdentifier:s.id,tileMatrixSet:s.tileMatrixSetId}}readCustomParameters(e,t){const r=t.wmtsInfo;return r?this._mergeParams(r.customParameters,r.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(e,t){return t.templateUrl.includes("?")?"KVP":"RESTful"}readSublayersFromService(e,t,r){const i=function(e,t){return e.map((e=>{const r=new P;return r.read(e,t),r}))}(t.layers,r);return i}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets?.map((e=>e.tileInfo?.spatialReference)).toArray().filter(o)??[]}get tilemapCache(){const e=this.activeLayer?.tileMatrixSet?.tileInfo;return e?new _(e):void 0}get title(){return this.activeLayer?.title??"Layer"}set title(e){this._overrideIfSome("title",e)}get url(){return this._get("url")}set url(e){e&&"/"===e.substr(-1)?this._set("url",e.slice(0,-1)):this._set("url",e)}createWebTileLayer(e){const t=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),r=this._getTileMatrixSetById(e.tileMatrixSetId),i=r?.tileInfo,s=e.fullExtent,o=new S({layerIdentifier:e.id,tileMatrixSet:e.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(o.customLayerParameters=this.customLayerParameters),this.customParameters&&(o.customParameters=this.customParameters),new x({fullExtent:s,urlTemplate:t,tileInfo:i,wmtsInfo:o})}async fetchTile(e,r,i){const s=this.getTileUrl(e,r,i),{data:o}=await t(s,{responseType:"image"});return o}async fetchImageBitmapTile(e,r,i){const s=this.getTileUrl(e,r,i),{data:o}=await t(s,{responseType:"blob"});return k(o,s)}findSublayerById(e){return this.sublayers?.find((t=>t.id===e))}getTileUrl(e,t,r){const i=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId),s=i?.tileInfo?.lods[e],o=s?s.levelValue||`${s.level}`:`${e}`;let a=this.resourceInfo?"":function(e,t,r,i,s,o,a,n){const l=function(e,t,r){const i=q(e,t),s=i?.filter((e=>e.format===r));return(s?.length?s:i)??[]}(e,t,i);if(!(l?.length>0))return"";const{dimensionMap:c}=e,p=c.get(t).dimensions?.[0],m=c.get(t).dimensions2?.[0];return l[a%l.length].template.replace(/\{Style\}/gi,s??"").replace(/\{TileMatrixSet\}/gi,r??"").replace(/\{TileMatrix\}/gi,o).replace(/\{TileRow\}/gi,""+a).replace(/\{TileCol\}/gi,""+n).replace(/\{dimensionValue\}/gi,p).replace(/\{dimensionValue2\}/gi,m)}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,o,t,r);return a||(a=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replace(/\{level\}/gi,o).replace(/\{row\}/gi,`${t}`).replace(/\{col\}/gi,`${r}`)),a=this._appendCustomLayerParameters(a),a}getUrlTemplate(e,t,r,i){if(!this.resourceInfo){const r=function(e,t,r,i){const{dimensionMap:s}=e,o=q(e,t);let a="";if(o&&o.length>0){const e=s.get(t).dimensions&&s.get(t).dimensions[0],n=s.get(t).dimensions2&&s.get(t).dimensions2[0];a=o[0].template,a.indexOf(".xxx")===a.length-4&&(a=a.slice(0,a.length-4)),a=a.replace(/\{Style\}/gi,i),a=a.replace(/\{TileMatrixSet\}/gi,r),a=a.replace(/\{TileMatrix\}/gi,"{level}"),a=a.replace(/\{TileRow\}/gi,"{row}"),a=a.replace(/\{TileCol\}/gi,"{col}"),a=a.replace(/\{dimensionValue\}/gi,e),a=a.replace(/\{dimensionValue2\}/gi,n)}return a}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},e,t,i);if(r)return r}if("KVP"===this.serviceMode)return this.url+"?SERVICE=WMTS&VERSION="+this.version+"&REQUEST=GetTile&LAYER="+e+"&STYLE="+i+"&FORMAT="+r+"&TILEMATRIXSET="+t+"&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}";if("RESTful"===this.serviceMode){let s="";return Y[r.toLowerCase()]&&(s=Y[r.toLowerCase()]),this.url+e+"/"+i+"/"+t+"/{level}/{row}/{col}"+s}return""}async _fetchService(e){let t;if(this.resourceInfo)"KVP"===this.resourceInfo.serviceMode&&(this.url+=this.url.includes("?")?"":"?"),t={ssl:!1,data:this.resourceInfo};else try{t=await this._getCapabilities(this.serviceMode,e),N(t.data)}catch{const r="KVP"===this.serviceMode?"RESTful":"KVP";try{t=await this._getCapabilities(r,e),N(t.data),this.serviceMode=r}catch(e){throw new i("wmtslayer:unsupported-service-data","Services does not support RESTful or KVP service modes.",{error:e})}}var r;this.resourceInfo?t.data=((r=t.data).layers.forEach((e=>{e.tileMatrixSets?.forEach((e=>{const t=e.tileInfo;t&&96!==t.dpi&&(t.lods?.forEach((r=>{r.scale=96*r.scale/t.dpi,r.resolution=X(t.spatialReference?.wkid,r.scale*F/96,e.id)})),t.dpi=96)}))})),r):t.data=function(e,t){e=e.replace(/ows:/gi,"");const r=(new DOMParser).parseFromString(e,"text/xml").documentElement,s=new Map,o=new Map,a=D("Contents",r);if(!a)throw new i("wmtslayer:wmts-capabilities-xml-is-not-valid");const n=D("OperationsMetadata",r),l=n?.querySelector("[name='GetTile']"),c=l?.getElementsByTagName("Get"),p=c&&Array.prototype.slice.call(c),m=t.url?.indexOf("https"),u=void 0!==m&&m>-1;let d,h,f=t.serviceMode,y=t?.url;if(p&&p.length&&p.some((e=>{const t=D("Constraint",e);return!t||G("AllowedValues","Value",f,t)?(y=e.attributes[0].nodeValue,!0):(!t||G("AllowedValues","Value","RESTful",t)||G("AllowedValues","Value","REST",t)?h=e.attributes[0].nodeValue:t&&!G("AllowedValues","Value","KVP",t)||(d=e.attributes[0].nodeValue),!1)})),!y)if(h)y=h,f="RESTful";else if(d)y=d,f="KVP";else{const e=D("ServiceMetadataURL",r);y=e?.getAttribute("xlink:href")}const g=y.indexOf("1.0.0/");-1===g&&"RESTful"===f?y+="/":g>-1&&(y=y.substring(0,g)),"KVP"===f&&(y+=g>-1?"":"?"),u&&(y=y.replace(/^http:/i,"https:"));const w=$("ServiceIdentification>ServiceTypeVersion",r),j=$("ServiceIdentification>AccessConstraints",r),x=j&&/^none$/i.test(j)?null:j,S=B("Layer",a),M=B("TileMatrixSet",a),L=S.map((e=>{const t=$("Identifier",e);return s.set(t,e),function(e,t,r,i,s){const o=$("Abstract",t),a=K("Format",t),n=function(e){const t=D("WGS84BoundingBox",e),r=t?$("LowerCorner",t).split(" "):["-180","-90"],i=t?$("UpperCorner",t).split(" "):["180","90"];return{xmin:parseFloat(r[0]),ymin:parseFloat(r[1]),xmax:parseFloat(i[0]),ymax:parseFloat(i[1]),spatialReference:{wkid:4326}}}(t),l=function(e){const t=[];return O(e,{BoundingBox:e=>{if(!e.getAttribute("crs"))return;const r=e.getAttribute("crs").toLowerCase(),i=H(r),s=r.includes("epsg")&&A(i.wkid);let o,a,n,l;O(e,{LowerCorner:e=>{[o,a]=e.textContent.split(" ").map((e=>Number.parseFloat(e))),s&&([o,a]=[a,o])},UpperCorner:e=>{[n,l]=e.textContent.split(" ").map((e=>Number.parseFloat(e))),s&&([n,l]=[l,n])}}),t.push({xmin:o,ymin:a,xmax:n,ymax:l,spatialReference:i})}}),t}(t),c=function(e,t){return B("Style",e).map((e=>{const r=D("LegendURL",e),i=D("Keywords",e),s=i?K("Keyword",i):[];let o=r&&r.getAttribute("xlink:href");return t&&(o=o&&o.replace(/^http:/i,"https:")),{abstract:$("Abstract",e),id:$("Identifier",e),isDefault:"true"===e.getAttribute("isDefault"),keywords:s,legendUrl:o,title:$("Title",e)}}))}(t,i),p=$("Title",t),m=function(e,t,r){return B("TileMatrixSetLink",t).map((t=>function(e,t,r){const i=D("TileMatrixSet",t).textContent,s=K("TileMatrix",t),o=r.find((e=>{const t=D("Identifier",e),r=t&&t.textContent;return!!(r===i||i.split(":")&&i.split(":")[1]===r)})),a=D("TileMatrixSetLimits",t),n=a&&B("TileMatrixLimits",a),l=new Map;if(n?.length)for(const e of n){const t=D("TileMatrix",e).textContent,r=+D("MinTileRow",e).textContent,i=+D("MaxTileRow",e).textContent,s=+D("MinTileCol",e).textContent,o=+D("MaxTileCol",e).textContent;l.set(t,{minCol:s,maxCol:o,minRow:r,maxRow:i})}const c=$("SupportedCRS",o).toLowerCase(),p=function(e,t){return J(D("TileMatrix",e),t)}(o,c),m=p.spatialReference,u=D("TileMatrix",o),d=[parseInt($("TileWidth",u),10),parseInt($("TileHeight",u),10)],h=[];s.length?s.forEach(((e,t)=>{const r=G("TileMatrix","Identifier",e,o);h.push(Q(r,c,t,i,l))})):B("TileMatrix",o).forEach(((e,t)=>{h.push(Q(e,c,t,i,l))}));const f=function(e,t,r,i,s){const o=D("BoundingBox",t);let a,n,l,c,p,m;if(o&&(a=$("LowerCorner",o).split(" "),n=$("UpperCorner",o).split(" ")),a&&a.length>1&&n&&n.length>1)l=parseFloat(a[0]),p=parseFloat(a[1]),c=parseFloat(n[0]),m=parseFloat(n[1]);else{const e=D("TileMatrix",t),o=parseInt($("MatrixWidth",e),10),a=parseInt($("MatrixHeight",e),10);l=r.x,m=r.y,c=l+o*i[0]*s.resolution,p=m-a*i[1]*s.resolution}return function(e,t,r){return"1.0.0"===e&&A(t.wkid)&&!(r.spatialReference.isGeographic&&r.x<-90&&r.y>=-90)}(e,r.spatialReference,r)?new v(p,l,m,c,r.spatialReference):new v(l,p,c,m,r.spatialReference)}(e,o,p,d,h[0]).toJSON(),y=new C({dpi:96,spatialReference:m,size:d,origin:p,lods:h}).toJSON();return{id:i,fullExtent:f,tileInfo:y}}(e,t,r)))}(s,t,r);return{id:e,fullExtent:n,fullExtents:l,description:o,formats:a,styles:c,title:p,tileMatrixSets:m}}(t,e,M,u,w)}));return{copyright:x,dimensionMap:o,layerMap:s,layers:L,serviceMode:f,tileUrl:y}}(t.data,{serviceMode:this.serviceMode,url:this.url}),t.data&&this.read(t.data,{origin:"service"})}async _getCapabilities(e,r){const i=this._getCapabilitiesUrl(e);return await t(i,{...r,responseType:"text"})}_getTileMatrixSetById(e){const t=this.findSublayerById(this.activeLayer.id),r=t?.tileMatrixSets?.find((t=>t.id===e));return r}_appendCustomParameters(e){return this._appendParameters(e,this.customParameters)}_appendCustomLayerParameters(e){return this._appendParameters(e,{...s(this.customParameters),...this.customLayerParameters})}_appendParameters(e,t){const r=d(e),i={...r.query,...t},s=h(i);return""===s?r.path:`${r.path}?${s}`}_getCapabilitiesUrl(e){this.url=this.url.split("?")[0];const t="KVP"===e?`${this.url}?request=GetCapabilities&service=WMTS&version=${this.version}`:`${this.url}/${this.version}/WMTSCapabilities.xml`;return this._appendCustomParameters(t)}_getLowerCasedUrlParams(e){if(!e)return null;const t=d(e).query;if(!t)return null;const r={};return Object.keys(t).forEach((e=>{r[e.toLowerCase()]=t[e]})),r}_mergeParams(e,t){const r=this._getLowerCasedUrlParams(t);if(r){const t=Object.keys(r);t.length&&(e=e?s(e):{},t.forEach((t=>{e.hasOwnProperty(t)||Z.has(t)||(e[t]=r[t])})))}return e}};e([f()],ee.prototype,"dimensionMap",void 0),e([f()],ee.prototype,"layerMap",void 0),e([f({type:P,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],ee.prototype,"activeLayer",null),e([y("service","activeLayer",["layers"])],ee.prototype,"readActiveLayerFromService",null),e([y(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],ee.prototype,"readActiveLayerFromItemOrWebDoc",null),e([w(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:C},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],ee.prototype,"writeActiveLayer",null),e([f({type:String,value:"",json:{write:!0}})],ee.prototype,"copyright",void 0),e([f({type:["show","hide"]})],ee.prototype,"listMode",void 0),e([f({json:{read:!0,write:!0}})],ee.prototype,"blendMode",void 0),e([f({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],ee.prototype,"customParameters",void 0),e([y(["portal-item","web-document"],"customParameters")],ee.prototype,"readCustomParameters",null),e([f({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],ee.prototype,"customLayerParameters",void 0),e([f({type:v,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:"fullExtent"}},"portal-item":{read:{source:"fullExtent"}}}}})],ee.prototype,"fullExtent",void 0),e([f({readOnly:!0})],ee.prototype,"fullExtents",null),e([f({type:["WebTiledLayer"]})],ee.prototype,"operationalLayerType",void 0),e([f()],ee.prototype,"resourceInfo",void 0),e([f()],ee.prototype,"serviceMode",void 0),e([y(["portal-item","web-document"],"serviceMode",["templateUrl"])],ee.prototype,"readServiceMode",null),e([f({type:r.ofType(P)})],ee.prototype,"sublayers",void 0),e([y("service","sublayers",["layers"])],ee.prototype,"readSublayersFromService",null),e([f({readOnly:!0})],ee.prototype,"supportedSpatialReferences",null),e([f({readOnly:!0})],ee.prototype,"tilemapCache",null),e([f({json:{read:{source:"title"}}})],ee.prototype,"title",null),e([f({json:{read:!1},readOnly:!0,value:"wmts"})],ee.prototype,"type",void 0),e([f({json:{origins:{service:{read:{source:"tileUrl"}},"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}}}}})],ee.prototype,"url",null),e([f()],ee.prototype,"version",void 0),ee=e([g("esri.layers.WMTSLayer")],ee);const te=ee;export{te as default};
