/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Collection.js";import s from"../core/Error.js";import{L as r}from"../chunks/Logger.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import"../chunks/typedArrayUtil.js";import{subclass as i}from"../core/accessorSupport/decorators/subclass.js";import n from"./Layer.js";import a from"../core/Accessor.js";import{u as p,i as l}from"../chunks/maybe.js";import{parseWhereClause as m}from"../core/sql.js";import{e as u}from"../chunks/geohashUtils.js";import h from"../geometry/Polygon.js";import{initializeProjection as c,project as d}from"../geometry/projection.js";import{W as y}from"../chunks/unitUtils.js";import{c as j}from"../chunks/featureConversionUtils.js";import{a as g}from"../chunks/OptimizedFeature.js";import{executeQueryStreaming as f,fetchKnowledgeGraph as b}from"../rest/knowledgeGraphService.js";import k from"../rest/knowledgeGraph/GraphQueryStreaming.js";import w from"../rest/support/Query.js";import"../geometry.js";import T from"../PopupTemplate.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/DictionaryRenderer.js";import"../renderers/DotDensityRenderer.js";import"../renderers/HeatmapRenderer.js";import"../renderers/PieChartRenderer.js";import"../renderers/Renderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import{fromJSON as S,r as M}from"../renderers/support/jsonUtils.js";import"../core/workers/workers.js";import{F as D}from"../chunks/FeatureStore.js";import{Q as I}from"../chunks/QueryEngine.js";import{c as C,a as L}from"../chunks/clientSideDefaults.js";import{d as E}from"../chunks/fieldProperties.js";import{BlendLayer as x}from"./mixins/BlendLayer.js";import{FeatureReductionLayer as v}from"./mixins/FeatureReductionLayer.js";import{RefreshableLayer as G}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as F}from"./mixins/ScaleRangeLayer.js";import N from"./support/Field.js";import{fixRendererFields as R}from"./support/fieldUtils.js";import O from"../rest/support/FeatureSet.js";import{createPopupTemplate as U}from"../support/popupUtils.js";import _ from"../core/workers/RemoteClient.js";import P from"../geometry/Extent.js";import Q from"../geometry/Polyline.js";import{f as A}from"../chunks/typeUtils.js";import V from"../rest/knowledgeGraph/EntityType.js";import $ from"../rest/knowledgeGraph/RelationshipType.js";import"../chunks/ArrayPool.js";import"../core/Evented.js";import"../chunks/handleUtils.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../core/lang.js";import"../chunks/metadata.js";import"../config.js";import"../chunks/object.js";import"../chunks/string.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../core/promiseUtils.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"../geometry/SpatialReference.js";import"../core/JSONSupport.js";import"../chunks/writer.js";import"../chunks/jsonMap.js";import"../chunks/Ellipsoid.js";import"../geometry/Geometry.js";import"../chunks/reader.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/zmUtils.js";import"../chunks/extentUtils.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/common.js";import"../chunks/vec4.js";import"../geometry/support/jsonUtils.js";import"../chunks/mat4.js";import"../chunks/pe.js";import"../chunks/assets.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/zscale.js";import"../chunks/aaBoundingBox.js";import"../chunks/OptimizedFeatureSet.js";import"../rest/knowledgeGraph/GraphQueryResult.js";import"../rest/knowledgeGraph/GraphQueryStreamingResult.js";import"../rest/knowledgeGraph/KnowledgeGraph.js";import"../rest/knowledgeGraph/DataModel.js";import"../rest/knowledgeGraph/ServiceDefinition.js";import"../rest/knowledgeGraph/Entity.js";import"../rest/knowledgeGraph/GraphNamedObject.js";import"../rest/knowledgeGraph/GraphObject.js";import"../rest/knowledgeGraph/Relationship.js";import"../rest/knowledgeGraph/FieldIndex.js";import"../rest/knowledgeGraph/GraphObjectType.js";import"../rest/knowledgeGraph/GraphProperty.js";import"../rest/knowledgeGraph/SearchIndex.js";import"../rest/knowledgeGraph/Path.js";import"../rest/knowledgeGraph/GraphApplyEditsResult.js";import"../rest/knowledgeGraph/GraphQuery.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/enumeration.js";import"../chunks/DataLayerSource.js";import"../chunks/FullTextSearch.js";import"../core/Clonable.js";import"../rest/support/StatisticDefinition.js";import"../chunks/domains.js";import"./support/CodedValueDomain.js";import"./support/Domain.js";import"./support/InheritedDomain.js";import"./support/RangeDomain.js";import"../chunks/fieldType.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../chunks/locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/arcadeOnDemand.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../Color.js";import"../chunks/colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../chunks/Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../Graphic.js";import"../chunks/compilerUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties.js";import"../symbols/support/jsonUtils.js";import"../chunks/layerUtils.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../chunks/DictionaryLoader.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/support/HeatmapColorStop.js";import"../chunks/heatmapUtils.js";import"../chunks/vec4f64.js";import"../core/reactiveUtils.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../intl.js";import"../chunks/messages.js";import"../chunks/BoundsStore.js";import"../chunks/PooledRBush.js";import"../chunks/quickselect.js";import"../chunks/optimizedFeatureQueryEngineAdapter.js";import"../chunks/centroid.js";import"../chunks/utils9.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils4.js";import"../chunks/utils5.js";import"../chunks/projectionSupport.js";import"../chunks/json.js";import"../chunks/QueryEngineResult.js";import"../chunks/quantizationUtils.js";import"../chunks/ItemCache.js";import"../core/sql/WhereClause.js";import"../chunks/executionError.js";import"../chunks/datetime.js";import"../chunks/_commonjsHelpers.js";import"../chunks/utils10.js";import"../chunks/generateRendererUtils.js";import"../chunks/SnappingCandidate.js";import"../chunks/QueryEngineCapabilities.js";import"../chunks/timeSupport.js";import"./support/FieldsIndex.js";import"../chunks/Scheduler.js";import"../chunks/ObservableValue.js";import"../chunks/debugFlags.js";import"../chunks/defaultsJSON.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/mat4f32.js";import"./support/AggregateField.js";import"./support/ExpressionInfo.js";import"../chunks/FeatureReduction.js";import"./support/FeatureReductionBinning.js";import"../chunks/commonProperties2.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"./support/LabelClass.js";import"../chunks/labelUtils.js";import"../chunks/defaults.js";import"./support/FeatureReductionCluster.js";import"./support/FeatureReductionSelection.js";import"../chunks/clusterUtils.js";class J{constructor(){this._featureLookup=new Map}static getInstance(){return J.instance||(J.instance=new J),J.instance}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e)}))}readFromStoreByList(e){const t=[];return e.forEach((e=>{const s=this.readFromStoreById(e);s&&t.push(s)})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,s){const r=[];return e.forEach((e=>{if(!e||!e.id)return;e.properties||(e.properties=[]);let o,i=null;if(s&&(i=e.properties[s]?j(e.properties[s]):null),"originId"in e&&"destinationId"in e&&(e.properties.ESRI__ORIGIN_ID=e.originId,e.properties.ESRI__DESTINATION_ID=e.destinationId),e.properties[t]=e.id,e.id&&this._featureLookup.has(e.id)){const s=this._featureLookup.get(e.id);o=new g(i?JSON.parse(JSON.stringify(i)):s?.geometry?JSON.parse(JSON.stringify(s.geometry)):null,JSON.parse(JSON.stringify(Object.assign(e.properties,s?.attributes))),null,e.properties[t])}else o=new g(i?JSON.parse(JSON.stringify(i)):null,e.properties,null,e.properties[t]);this._featureLookup.set(e.id,o),r.push(o)})),r}}const q="ESRI__ID",B="ESRI__LAYOUT_GEOMETRY",z=r.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");let W=class extends a{constructor(e){super(e),this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this._processingCacheUpdatesLookup=new Map,this._memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((s=>{s.name&&(t.set(s.name,"entity"),this._processingCacheUpdatesLookup.set(s.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(s.name),s.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(s.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((s=>{s.name&&(t.set(s.name,"relationship"),this._processingCacheUpdatesLookup.set(s.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(s.name),s.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(s.name,{name:e.name??"",geometryType:e.geometryType})})))})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((s,r)=>{if("entity"===t.get(r))this.entityTypeNames.add(r);else{if("relationship"!==t.get(r))return z.warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);this.relationshipTypeNames.add(r)}const o=new Map;s.members?.forEach((e=>{this._memberIdTypeLookup.set(e.id,r);const t=this.getById(e.id);t&&o.set(e.id,t)})),this.sublayerCaches.set(r,o)}))}async addToLayerInclusionSet(e,t=!1){e.forEach(((e,t)=>{if(!this.inclusionModeDefinition)throw new s("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const r=this.inclusionModeDefinition.namedTypeDefinitions.get(e);if(r.useAllData)throw new s("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");r.members||(r.members=new Map),r.members.set(t,{id:t}),this._memberIdTypeLookup.set(t,e)}}else{const s=new Map;s.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:s}),this._memberIdTypeLookup.set(t,e)}})),t&&await this.refreshCacheContent(Array.from(e.keys()))}getById(e){return J.getInstance().readFromStoreById(e)}async getData(e,t,s){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=e||new w({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,s=this._processingCacheUpdatesLookup.get(t.objectType.name??""),o=p(r.outFields),i=p(r.geometry);let n="",a="";i&&i.extent&&(n=u(i.extent.ymin,i.extent.xmin,12),a=u(i.extent.ymax,i.extent.xmax,12)),o&&1===o.length&&o[0]===q&&"1=1"===p(r.where)||await Promise.all(s??[]);const l=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],m=[];return l.forEach((s=>{if(s.geometry=e.linkChartDiagramLookup.get(s.attributes[t.objectIdField]),s.attributes[B]=s.geometry,n&&a){const r=e.linkChartGeohashLookup.get(s.attributes[t.objectIdField]);r?r>=n&&r<=a&&m.push(s):m.push(s)}else m.push(s)})),m}return this.retrieveDataFromService(r,t,s)}async refreshCacheContent(e,t,r){const o=J.getInstance(),i=[],n=new Map,a=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&a.set(e.name,e)})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&a.set(e.name,e)})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this._memberIdTypeLookup.has(e)){const t=this._memberIdTypeLookup.get(e);n.has(t)?n.get(t)?.push(e):n.set(t,[e])}})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?n.set(t,null):e.members&&e.members.forEach((e=>{n.has(t)&&null!==n.get(t)?n.get(t)?.push(e.id):n.set(t,[e.id])}))})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&n.set(e.name,null)})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&n.set(e.name,null)})));for(const[e,p]of n){const n=new Promise((i=>{(async()=>{const i=new Set,n=[];let l,m="",u=!1;if(t||a.get(e)?.properties?.forEach((e=>{e.name&&i.add(e.name)})),r&&this.geographicLookup.has(e)){const t=this.geographicLookup.get(e)?.name;t&&i.add(t)}if(this.entityTypeNames.has(e))m=`MATCH (n:${e}) ${p?"WHERE id(n) IN $ids ":""}return ID(n)`,i.forEach((e=>{m+=`, n.${e}`,n.push(e)}));else{if(!this.relationshipTypeNames.has(e))throw new s("knowledge-graph:layer-data-manager",`The graph type of ${e} could not be determined.  Was this type set in the KG data model?`);u=!0,m=`MATCH ()-[n:${e}]->() ${p?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`}l=new k(p?{openCypherQuery:m,bindParameters:{ids:p}}:{openCypherQuery:m});const h=(await f(this.knowledgeGraph,l)).resultRowsStream.getReader();for(;;){const{done:t,value:s}=await h.read();if(t)break;const r=[];for(let e=0;e<s.length;e++){const t=s[e];let o=0,i=0;const a={properties:{}};for(a.id=t[o],o++,i++,u&&(a.originId=t[o],o++,i++,a.destinationId=t[o],o++,i++);o<t.length;o++)a.properties[n[o-i]]=t[o];r.push(a)}const i=o.writeToStore(r,q,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map);const a=this.sublayerCaches.get(e);i.forEach((e=>{a?.set(e.attributes[q],e)}))}})().then((()=>{i(null)}))}));i.push(n),this._processingCacheUpdatesLookup.get(e)?.push(n)}await Promise.all(i)}removeFromLayer(e){const t=new Set;e.forEach((e=>{this._memberIdTypeLookup.get(e)&&t.add(this._memberIdTypeLookup.get(e)),this._memberIdTypeLookup.delete(e),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((t=>{t.members?.has(e)&&t.members.delete(e)}))})),t.forEach((t=>{this.sublayerCaches.get(t)?.forEach(((s,r)=>{e.includes(r)&&this.sublayerCaches.get(t)?.delete(r)}))}))}async retrieveDataFromService(e,t,s){const r=J.getInstance(),o=new Set,i=[];let n,a="",u=[],j=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);const g="relationship"===t.graphType;if(!this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)if(l(e.objectIds)&&j&&j.length>0){const t=p(e.objectIds);e.objectIds=j.filter((e=>t.includes(e)))}else if(l(e.objectIds))j=p(e.objectIds);else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=j}if(l(e.outFields)){const s=p(e.outFields);s.includes("*")?t.fields.forEach((e=>{o.add(e.name)})):s.forEach((e=>{e!==q&&e!==t.geometryFieldName&&o.add(e)}))}if(l(e.geometry)){const s=p(e.geometry);let r;if(s?.extent?.spatialReference&&!s.spatialReference?.isWGS84?(await c(s.extent.spatialReference,y),r=d(s.extent,y)):r=s.extent,l(e.where)&&"1=1"!==p(e.where)){const s=await m(p(e.where).toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{s.fieldNames.includes(e.name)&&o.add(e.name)}))}a=g?`Match ()-[n:${t.objectType.name}]-() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,p(e).returnGeometry&&t.geometryFieldName&&o.add(t.geometryFieldName),o.forEach((e=>{a+=`, n.${e}`,i.push(e)})),n=new k({openCypherQuery:a,bindParameters:{param_filter_geom:new h({rings:[[[r.xmin,r.ymin],[r.xmin,r.ymax],[r.xmax,r.ymax],[r.xmax,r.ymin],[r.xmin,r.ymin]]]})}})}else{let s="";if(l(e.where)&&"1=1"!==p(e.where)){const r=await m(p(e.where),t.fieldsIndex);t.fields.forEach((e=>{r.fieldNames.includes(e.name)&&o.add(e.name)}));const i=["column-reference","string","number","binary-expression"],n=["=","<","<=","<>",">",">=","AND","OR","LIKE"];let a=!1;const l=e=>{if("column-reference"===e.type)return`n.${e.column}`;if("string"===e.type)return`'${e.value}'`;if("number"===e.type)return`${e.value}`;if("binary-expression"===e.type&&i.includes(e.left.type)&&i.includes(e.right.type)&&n.includes(e.operator))return`${l(e.left)} ${e.operator} ${l(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else{if("column-reference"!==e.left.type)return a=!0,"";t+=`lower(n.${e.left.column})`}if(t+=" CONTAINS (","string"!==e.right.type)return a=!0,"";{let s=e.right.value;"%"===s.charAt(0)&&(s=s.slice(1)),"%"===s.charAt(s.length-1)&&(s=s.slice(0,-1)),t+=`'${s.toLowerCase()}')`}return t}return a=!0,""};s=l(r.parseTree),a&&(s="")}let r="";r=g?`Match ()-[n:${t.objectType.name}]-()`:`Match (n:${t.objectType.name})`;let a=!1;j&&(a=!0,r+=" WHERE ID(n) IN $ids"),s&&(r+=a?" AND":" WHERE",r+=` ${s}`),r+=" return ID(n)",g&&(r+=", id(startNode(n)), id(endNode(n))"),p(e).returnGeometry&&t.geometryFieldName&&o.add(t.geometryFieldName),o.forEach((e=>{r+=`, n.${e}`,i.push(e)})),n=new k(j?{openCypherQuery:r,bindParameters:{ids:j}}:{openCypherQuery:r})}const b=(await f(t.parentCompositeLayer.dataManager.knowledgeGraph,n,s)).resultRowsStream.getReader();for(;;){const{done:e,value:s}=await b.read();if(e)break;const o=[];for(let e=0;e<s.length;e++){const t=s[e];let r=0,n=0;const a={properties:{}};for(a.id=t[r],r++,n++,g&&(a.originId=t[r],r++,n++,a.destinationId=t[r],r++,n++);r<t.length;r++)a.properties[i[r-n]]=t[r];o.push(a)}u=u.concat(r.writeToStore(o,q,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return u}};e([o()],W.prototype,"knowledgeGraph",void 0),e([o()],W.prototype,"inclusionModeDefinition",void 0),e([o()],W.prototype,"entityTypeNames",void 0),e([o()],W.prototype,"relationshipTypeNames",void 0),e([o()],W.prototype,"geographicLookup",void 0),e([o()],W.prototype,"sublayerCaches",void 0),W=e([i("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],W);const H=E(),K=t=>{let s=class extends t{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return e([o(H.fields)],s.prototype,"fields",void 0),e([o(H.fieldsIndex)],s.prototype,"fieldsIndex",void 0),s=e([i("esri.layers.knowledgeGraphLayer.KnowledgeGraphSubLayerBase")],s),s};let Z=class extends(v(K(x(F(G(n)))))){constructor(e){if(super(e),this.capabilities=C(!1,!1),this.displayField="",this.geometryFieldName=null,this.hasM=!1,this.hasZ=!1,this.objectIdField=q,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new _(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const s=w.fromJSON(e);return this.queryFeaturesJSON(s,t)}}},(()=>null)),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=B;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?A.fromJSON(t.geometryType):null,t?.name&&e.objectType.properties&&e.objectType.properties[t.name]?(this.hasM=e.objectType.properties[t.name].hasM,this.hasZ=e.objectType.properties[t.name].hasZ):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=e.fieldType;"esriFieldTypeOID"===t&&(t="esriFieldTypeInteger"),this.fields.push(N.fromJSON({name:e.name,type:t,alias:e.alias,defaultValue:null,editable:e.editable,nullable:e.nullable}))})),this.fields.push(N.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=S(L(A.toJSON("polyline")).renderer):this.renderer=S(L(A.toJSON("point")).renderer):this.renderer=S(L(A.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){R(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return U(this,e)}createQuery(){return new w({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];throw new Error("Field not found")}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:s,queryEngine:r}=await this._setupQueryObjects(e),o=O.fromJSON(await r.executeQuery(s.toJSON(),t?.signal));return o.features.forEach((e=>{e.sourceLayer=this})),o}async queryFeaturesJSON(e,t){const{resolvedQuery:s,queryEngine:r}=await this._setupQueryObjects(e);return await r.executeQuery(s.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:s,queryEngine:r}=await this._setupQueryObjects(e);return r.executeQueryForCount(s.toJSON(),t?.signal)}async queryExtent(e={},t){const s={...e,returnGeometry:!0},{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(s),i=await o.executeQueryForExtent(r.toJSON(),t?.signal);let n;return n=null!=i.extent?.xmin&&null!=i.extent?.xmax&&null!=i.extent?.ymin&&null!=i.extent?.ymax?new P(i.extent):new P,{count:i.count,extent:n}}async queryObjectIds(e,t){const s=w.from(e);let r;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(s,this,t);r=this.loadQueryEngine(e)}return r.executeQueryForIds(s.toJSON(),t?.signal)}loadQueryEngine(e){const t=new D({geometryType:A.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),s=new I({fields:this.fields.map((e=>e.toJSON())),geometryType:A.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return s.featureStore.addMany(e),s}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new w({where:"1=1",outFields:[q]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,t){const s=w.from(e),r=p(s.geometry);let o;if(r&&!r.spatialReference?.isWGS84&&(await c(r.spatialReference,y),s.geometry=d(r instanceof h||r instanceof Q?r:r.extent,y)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const e=await this.parentCompositeLayer.dataManager.getData(s,this,t);o=this.loadQueryEngine(e)}return{resolvedQuery:s,queryEngine:o}}};e([o()],Z.prototype,"capabilities",void 0),e([o({readOnly:!0})],Z.prototype,"defaultPopupTemplate",null),e([o()],Z.prototype,"definitionExpression",void 0),e([o()],Z.prototype,"displayField",void 0),e([o()],Z.prototype,"elevationInfo",void 0),e([o()],Z.prototype,"geometryType",void 0),e([o()],Z.prototype,"geometryFieldName",void 0),e([o()],Z.prototype,"graphType",void 0),e([o()],Z.prototype,"hasM",void 0),e([o()],Z.prototype,"hasZ",void 0),e([o()],Z.prototype,"labelsVisible",void 0),e([o()],Z.prototype,"labelingInfo",void 0),e([o()],Z.prototype,"objectIdField",void 0),e([o()],Z.prototype,"objectType",void 0),e([o()],Z.prototype,"parentCompositeLayer",void 0),e([o({type:T,json:{name:"popupInfo",write:!0}})],Z.prototype,"popupTemplate",void 0),e([o({types:M,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],Z.prototype,"renderer",null),e([o()],Z.prototype,"source",void 0),e([o({json:{read:!1}})],Z.prototype,"type",void 0),Z=e([i("esri.layers.knowledgeGraph.KnowledgeGraphSubLayer")],Z);const Y=Z;let X=class extends(x(F(n))){constructor(e){super(e),this.layers=new t,this.sublayerIdsCache=new Map,this.tables=new t,this.type="knowledge-graph",this._originalInclusionList=e.inclusionModeDefinition}normalizeCtorArgs(e){return{url:e.url,title:e.title}}_initializeLayerProperties(e){const t=new Set,o=new Map;let i=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new s("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?(e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&o.set(e.name,e)})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&o.set(e.name,e)})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((s,a)=>{if(!o.get(a))return r.getLogger(this.declaredClass).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(a);o.get(a)instanceof $||"strictOrigin"in o.get(a)?t.has(a)||(t.add(a),n.push(o.get(a))):o.get(a)instanceof V||"properties"in o.get(a)?t.has(a)||(t.add(a),i.push(o.get(a))):(r.getLogger(this.declaredClass).warn(`A named type, ${a}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(a))}))):(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const a=new W({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=n,this.dataManager=a}load(){return this.addResolvingPromise(b(this.url).then((e=>{this._initializeLayerProperties({knowledgeGraph:e,inclusionModeDefinition:this._originalInclusionList}),this.loadLayerAssumingLocalCache()}))),Promise.resolve(this)}loadLayerAssumingLocalCache(){this.memberEntityTypes.forEach((e=>{const t=new Y({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.memberRelationshipTypes.forEach((e=>{const t=new Y({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{e.members?.forEach((e=>{this.sublayerIdsCache.has(t)?this.sublayerIdsCache.get(t)?.push(e.id):this.sublayerIdsCache.set(t,[e.id])}))})),Array.from(this.sublayerIdsCache.values()).forEach((e=>e.sort()))}};e([o()],X.prototype,"dataManager",void 0),e([o()],X.prototype,"knowledgeGraph",void 0),e([o()],X.prototype,"layers",void 0),e([o()],X.prototype,"memberEntityTypes",void 0),e([o()],X.prototype,"memberRelationshipTypes",void 0),e([o()],X.prototype,"sublayerIdsCache",void 0),e([o()],X.prototype,"tables",void 0),e([o({json:{read:!1}})],X.prototype,"type",void 0),X=e([i("esri.layers.KnowledgeGraphLayer")],X);const ee=X;export{ee as default};
