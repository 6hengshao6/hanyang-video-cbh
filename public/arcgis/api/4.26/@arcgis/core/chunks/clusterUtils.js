/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{h as r}from"./typedArrayUtil.js";import{L as s}from"./Logger.js";import{a as t}from"./maybe.js";import i from"../layers/support/AggregateField.js";import n from"../layers/support/ExpressionInfo.js";import a from"../renderers/support/AuthoringInfo.js";import o from"../renderers/visualVariables/SizeVariable.js";import l from"../renderers/visualVariables/support/SizeStop.js";import{_ as u}from"./tslib.es6.js";import{clone as c}from"../core/lang.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{w as d}from"./writer.js";import{i as m}from"./sizeVariableUtils.js";const v={Base64:0,Hex:1,String:2,Raw:3},h=8,g=(1<<h)-1;function x(e,r){const s=(65535&e)+(65535&r);return(e>>16)+(r>>16)+(s>>16)<<16|65535&s}function b(e,r,s,t,i,n){return x((a=x(x(r,e),x(t,n)))<<(o=i)|a>>>32-o,s);var a,o}function w(e,r,s,t,i,n,a){return b(r&s|~r&t,e,r,i,n,a)}function y(e,r,s,t,i,n,a){return b(r&t|s&~t,e,r,i,n,a)}function z(e,r,s,t,i,n,a){return b(r^s^t,e,r,i,n,a)}function E(e,r,s,t,i,n,a){return b(s^(r|~t),e,r,i,n,a)}function S(e,r=v.Hex){const s=r||v.Base64,t=function(e,r){e[r>>5]|=128<<r%32,e[14+(r+64>>>9<<4)]=r;let s=1732584193,t=-271733879,i=-1732584194,n=271733878;for(let r=0;r<e.length;r+=16){const a=s,o=t,l=i,u=n;s=w(s,t,i,n,e[r],7,-680876936),n=w(n,s,t,i,e[r+1],12,-389564586),i=w(i,n,s,t,e[r+2],17,606105819),t=w(t,i,n,s,e[r+3],22,-1044525330),s=w(s,t,i,n,e[r+4],7,-176418897),n=w(n,s,t,i,e[r+5],12,1200080426),i=w(i,n,s,t,e[r+6],17,-1473231341),t=w(t,i,n,s,e[r+7],22,-45705983),s=w(s,t,i,n,e[r+8],7,1770035416),n=w(n,s,t,i,e[r+9],12,-1958414417),i=w(i,n,s,t,e[r+10],17,-42063),t=w(t,i,n,s,e[r+11],22,-1990404162),s=w(s,t,i,n,e[r+12],7,1804603682),n=w(n,s,t,i,e[r+13],12,-40341101),i=w(i,n,s,t,e[r+14],17,-1502002290),t=w(t,i,n,s,e[r+15],22,1236535329),s=y(s,t,i,n,e[r+1],5,-165796510),n=y(n,s,t,i,e[r+6],9,-1069501632),i=y(i,n,s,t,e[r+11],14,643717713),t=y(t,i,n,s,e[r],20,-373897302),s=y(s,t,i,n,e[r+5],5,-701558691),n=y(n,s,t,i,e[r+10],9,38016083),i=y(i,n,s,t,e[r+15],14,-660478335),t=y(t,i,n,s,e[r+4],20,-405537848),s=y(s,t,i,n,e[r+9],5,568446438),n=y(n,s,t,i,e[r+14],9,-1019803690),i=y(i,n,s,t,e[r+3],14,-187363961),t=y(t,i,n,s,e[r+8],20,1163531501),s=y(s,t,i,n,e[r+13],5,-1444681467),n=y(n,s,t,i,e[r+2],9,-51403784),i=y(i,n,s,t,e[r+7],14,1735328473),t=y(t,i,n,s,e[r+12],20,-1926607734),s=z(s,t,i,n,e[r+5],4,-378558),n=z(n,s,t,i,e[r+8],11,-2022574463),i=z(i,n,s,t,e[r+11],16,1839030562),t=z(t,i,n,s,e[r+14],23,-35309556),s=z(s,t,i,n,e[r+1],4,-1530992060),n=z(n,s,t,i,e[r+4],11,1272893353),i=z(i,n,s,t,e[r+7],16,-155497632),t=z(t,i,n,s,e[r+10],23,-1094730640),s=z(s,t,i,n,e[r+13],4,681279174),n=z(n,s,t,i,e[r],11,-358537222),i=z(i,n,s,t,e[r+3],16,-722521979),t=z(t,i,n,s,e[r+6],23,76029189),s=z(s,t,i,n,e[r+9],4,-640364487),n=z(n,s,t,i,e[r+12],11,-421815835),i=z(i,n,s,t,e[r+15],16,530742520),t=z(t,i,n,s,e[r+2],23,-995338651),s=E(s,t,i,n,e[r],6,-198630844),n=E(n,s,t,i,e[r+7],10,1126891415),i=E(i,n,s,t,e[r+14],15,-1416354905),t=E(t,i,n,s,e[r+5],21,-57434055),s=E(s,t,i,n,e[r+12],6,1700485571),n=E(n,s,t,i,e[r+3],10,-1894986606),i=E(i,n,s,t,e[r+10],15,-1051523),t=E(t,i,n,s,e[r+1],21,-2054922799),s=E(s,t,i,n,e[r+8],6,1873313359),n=E(n,s,t,i,e[r+15],10,-30611744),i=E(i,n,s,t,e[r+6],15,-1560198380),t=E(t,i,n,s,e[r+13],21,1309151649),s=E(s,t,i,n,e[r+4],6,-145523070),n=E(n,s,t,i,e[r+11],10,-1120210379),i=E(i,n,s,t,e[r+2],15,718787259),t=E(t,i,n,s,e[r+9],21,-343485551),s=x(s,a),t=x(t,o),i=x(i,l),n=x(n,u)}return[s,t,i,n]}(function(e){const r=[];for(let s=0,t=e.length*h;s<t;s+=h)r[s>>5]|=(e.charCodeAt(s/h)&g)<<s%32;return r}(e),e.length*h);switch(s){case v.Raw:return t;case v.Hex:return function(e){const r="0123456789abcdef",s=[];for(let t=0,i=4*e.length;t<i;t++)s.push(r.charAt(e[t>>2]>>t%4*8+4&15)+r.charAt(e[t>>2]>>t%4*8&15));return s.join("")}(t);case v.String:return function(e){const r=[];for(let s=0,t=32*e.length;s<t;s+=h)r.push(String.fromCharCode(e[s>>5]>>>s%32&g));return r.join("")}(t);case v.Base64:return function(e){const r=[];for(let s=0,t=4*e.length;s<t;s+=3){const t=(e[s>>2]>>s%4*8&255)<<16|(e[s+1>>2]>>(s+1)%4*8&255)<<8|e[s+2>>2]>>(s+2)%4*8&255;for(let i=0;i<4;i++)8*s+6*i>32*e.length?r.push("="):r.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t>>6*(3-i)&63))}return r.join("")}(t)}}var V;let _=V=class extends o{writeLevels(e,r,s){for(const s in e){const e=this.levels[s];return void(r.stops=e)}}clone(){return new V({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:m(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:m(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map((e=>e.clone())),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:c(this.levels)})}};u([p()],_.prototype,"levels",void 0),u([d("levels")],_.prototype,"writeLevels",null),_=V=u([f("esri.views.2d.engine.LevelDependentSizeVariable")],_);const j=s.getLogger("esri.views.2d.layers.support.clusterUtils");r.add("esri-cluster-arcade-enabled",!0);const F=r("esri-cluster-arcade-enabled"),$=(e,r,s,i,n)=>{const o=r.clone();if(!k(o))return o;if(o.authoringInfo||(o.authoringInfo=new a),o.authoringInfo.isAutoGenerated=!0,"visualVariables"in o){const r=(o.visualVariables||[]).filter((e=>"$view.scale"!==e.valueExpression)),a=C(r);r.forEach((r=>{"rotation"===r.type?r.field?r.field=U(e,r.field,"avg_angle","number"):r.valueExpression&&(r.field=L(e,r.valueExpression,"avg_angle","number"),r.valueExpression=null):r.normalizationField?(r.field=U(e,r.field,"avg_norm","number",r.normalizationField),r.normalizationField=null):r.field?r.field=U(e,r.field,"avg","number"):r.valueExpression&&(r.field=L(e,r.valueExpression,"avg","number"),r.valueExpression=null)})),t(a)&&!R(r)&&n&&(r.push(T(s,i)),o.dynamicClusterSize=!0),o.visualVariables=r}switch(o.type){case"simple":break;case"pie-chart":for(const r of o.attributes)r.field?r.field=U(e,r.field,"sum","number"):r.valueExpression&&(r.field=L(e,r.valueExpression,"sum","number"),r.valueExpression=null);break;case"unique-value":o.field?o.field=U(e,o.field,"mode","string"):o.valueExpression&&(o.field=L(e,o.valueExpression,"mode","string"),o.valueExpression=null);break;case"class-breaks":o.normalizationField?(o.field=U(e,o.field,"avg_norm","number",o.normalizationField),o.normalizationField=null):o.field?o.field=U(e,o.field,"avg","number"):o.valueExpression&&(o.field=L(e,o.valueExpression,"avg","number"),o.valueExpression=null)}return o},C=e=>{for(const r of e)if("size"===r.type)return r;return null};function A(e,r,s){const i=e.clone();let n=!1;if("visualVariables"in i){const e=(i.visualVariables||[]).filter((e=>"$view.scale"!==e.valueExpression)),a=C(e);t(a)&&(i.visualVariables||(i.visualVariables=[]),i.visualVariables.push(T(r,s)),i.dynamicClusterSize=!0,n=!0)}return{renderer:i,didInject:n}}const R=e=>{for(const r of e)if("cluster_count"===r.field)return!0;return!1},T=(e,r)=>{const s=[new l({value:0,size:0}),new l({value:1})];if(t(r))return new o({field:"cluster_count",stops:[...s,new l({value:2,size:0})]});const i=Object.keys(r).reduce(((t,i)=>({...t,[i]:[...s,new l({value:Math.max(2,r[i].minValue),size:e.clusterMinSize}),new l({value:Math.max(3,r[i].maxValue),size:e.clusterMaxSize})]})),{});return new _({field:"cluster_count",levels:i})},k=r=>{const s=s=>j.error(new e("Unsupported-renderer",s,{renderer:r}));if(!r)return!1;switch(r.type){case"unique-value":if(r.field2||r.field3)return s("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(r.normalizationField){const e=r.normalizationType;if("field"!==e)return s(`FeatureReductionCluster does not support a normalizationType of ${e}`),!1}break;case"simple":case"pie-chart":break;default:return s(`FeatureReductionCluster does not support renderers of type ${r.type}`),!1}if(!F){if("valueExpression"in r&&r.valueExpression)return s("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in r&&r.visualVariables||[]).some((e=>!(!("valueExpression"in e)||!e.valueExpression))))return s("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function L(e,r,s,t){const a=S(r),o="mode"===s?`cluster_type_${a}`:"sum"===s?`cluster_sum_${a}`:`cluster_avg_${a}`;return e.some((e=>e.name===o))||e.push(new i({name:o,isAutoGenerated:!0,onStatisticExpression:new n({expression:r,returnType:t}),statisticType:s})),o}function U(e,r,s,t,a){if("cluster_count"===r||e.some((e=>e.name===r)))return r;const o=function(e,r,s){switch(e){case"sum":return`cluster_sum_${r}`;case"avg":case"avg_angle":return`cluster_avg_${r}`;case"mode":return`cluster_type_${r}`;case"avg_norm":{const e=s,t="field";return"cluster_avg_"+S(r.toLowerCase()+",norm:"+t+","+e.toLowerCase())}}}(s,r,a);return e.some((e=>e.name===o))||("avg_norm"===s?e.push(new i({name:o,isAutoGenerated:!0,onStatisticExpression:new n({expression:`$feature.${r} / $feature.${a}`,returnType:t}),statisticType:"avg"})):e.push(new i({name:o,isAutoGenerated:!0,onStatisticField:r,statisticType:s}))),o}export{S as a,A as b,$ as c,T as d,C as f,k as i,v as o};
