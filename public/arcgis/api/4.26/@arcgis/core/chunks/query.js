/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../request.js";import{i as t}from"./maybe.js";import{urlToObject as r,join as n}from"../core/urlUtils.js";import{getJsonType as i}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as a}from"../geometry/support/normalizeUtils.js";import{m as o}from"./urlUtils2.js";import{p as s}from"./pbfQueryUtils.js";import{a as u}from"./queryZScale.js";const l="Layer does not support extent calculation.";function m(e,r){const n=e.geometry,a=e.toJSON();delete a.compactGeometryEnabled,delete a.defaultSpatialReferenceEnabled;const o=a;let s,u,l;if(t(n)&&(u=n.spatialReference,l=n.spatialReference.wkid||JSON.stringify(n.spatialReference),o.geometryType=i(n),o.geometry=function(e,t){if(t&&"extent"===e.type)return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&"point"===e.type)return`${e.x},${e.y}`;const r=e.toJSON();return delete r.spatialReference,JSON.stringify(r)}(n,e.compactGeometryEnabled),o.inSR=l),a.groupByFieldsForStatistics&&(o.groupByFieldsForStatistics=a.groupByFieldsForStatistics.join(",")),a.objectIds&&(o.objectIds=a.objectIds.join(",")),a.orderByFields&&(o.orderByFields=a.orderByFields.join(",")),!a.outFields||!a.returnDistinctValues&&(r?.returnCountOnly||r?.returnExtentOnly||r?.returnIdsOnly)?delete o.outFields:a.outFields.includes("*")?o.outFields="*":o.outFields=a.outFields.join(","),a.outSR?(o.outSR=a.outSR.wkid||JSON.stringify(a.outSR),s=e.outSpatialReference):n&&(a.returnGeometry||a.returnCentroid)&&(o.outSR=o.inSR,s=u),a.returnGeometry&&delete a.returnGeometry,a.outStatistics&&(o.outStatistics=JSON.stringify(a.outStatistics)),a.fullText&&(o.fullText=JSON.stringify(a.fullText)),a.pixelSize&&(o.pixelSize=JSON.stringify(a.pixelSize)),a.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&t(u)&&t(e.quantizationParameters)&&t(e.quantizationParameters.extent)&&u.equals(e.quantizationParameters.extent.spatialReference)&&delete a.quantizationParameters.extent.spatialReference,o.quantizationParameters=JSON.stringify(a.quantizationParameters)),a.parameterValues&&(o.parameterValues=JSON.stringify(a.parameterValues)),a.rangeValues&&(o.rangeValues=JSON.stringify(a.rangeValues)),a.dynamicDataSource&&(o.layer=JSON.stringify({source:a.dynamicDataSource}),delete a.dynamicDataSource),a.timeExtent){const e=a.timeExtent,{start:t,end:r}=e;null==t&&null==r||(o.time=t===r?t:`${t??"null"},${r??"null"}`),delete a.timeExtent}return e.defaultSpatialReferenceEnabled&&t(u)&&t(s)&&u.equals(s)&&(o.defaultSR=o.inSR,delete o.inSR,delete o.outSR),o}async function y(e,r,n,i){const a=t(r.timeExtent)&&r.timeExtent.isEmpty?{data:{features:[]}}:await x(e,r,"json",i);return u(r,n,a.data),a}async function c(e,r,n,i){if(t(r.timeExtent)&&r.timeExtent.isEmpty)return{data:n.createFeatureResult()};const a=await f(e,r,i),o=a;return o.data=s(a.data,n),o}function f(e,t,r){return x(e,t,"pbf",r)}function d(e,r,n){return t(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):x(e,r,"json",n,{returnIdsOnly:!0})}function p(e,r,n){return t(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):x(e,r,"json",n,{returnIdsOnly:!0,returnCountOnly:!0})}function S(e,r,n){return t(r.timeExtent)&&r.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):x(e,r,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}).then((e=>{const t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(l);if(t.hasOwnProperty("count"))throw new Error(l);return e}))}function x(i,s,u,l={},y={}){const c="string"==typeof i?r(i):i,f=s.geometry?[s.geometry]:[];return l.responseType="pbf"===u?"array-buffer":"json",a(f,null,l).then((r=>{const i=r&&r[0];t(i)&&((s=s.clone()).geometry=i);const a=o({...c.query,f:u,...y,...m(s,y)});return e(n(c.path,"query"),{...l,query:{...a,...l.query}})}))}export{p as a,d as b,S as c,c as d,y as e,f,x as r};
