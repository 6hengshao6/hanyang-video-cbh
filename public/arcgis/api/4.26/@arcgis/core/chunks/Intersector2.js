/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{i as t,e as r}from"./maybe.js";import{j as s}from"./mat4.js";import{c as i,I as e}from"./mat4f64.js";import{k as a,A as n,d as o,a as h,e as c,g as d,l,c as f,n as m,U as u}from"./vec3.js";import{t as y}from"./vec4.js";import{c as p}from"./vec4f64.js";import{c as g,g as O,b as _}from"./ray.js";import{V as L}from"./ViewingMode.js";import{e as E}from"./boundedPlane.js";import{I as A,g as v}from"./verticalOffsetUtils.js";var T,b;!function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL"}(T||(T={}));class j{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=b.ALL}}!function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"}(b||(b={}));class I{constructor(t,r,s){this.object=t,this.geometryId=r,this.triangleNr=s}}class w extends I{constructor(r,s,i,e){super(r,s,i),this.center=t(e)?a(e):null}}class M{constructor(t){this.layerUid=t}}class N extends M{constructor(t,r){super(t),this.graphicUid=r}}function U(r){return t(r)&&t(r.dist)}function x(t){return(r,s,i)=>(n(V,r,s,i),!E(t,V))}function R(t){return U(t)&&t.intersector===T.OBJECT&&!!t.target}function B(r){return U(r)&&r.intersector===T.HUD&&!!r.target&&"center"in r.target&&t(r.target.center)}const V=o(),D=1e-5;class C{constructor(t){this.options=new j,this._results=new P,this.transform=new A,this.tolerance=D,this.verticalOffset=null,this._ray=g(),this._rayEnd=o(),this._rayBeginTransformed=o(),this._rayEndTransformed=o(),this.viewingMode=t??L.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,r,s){this.resetWithRay(O(t,r,this._ray),s)}resetWithRay(t,r){this.camera=r,t!==this._ray&&_(t,this._ray),0!==this.options.verticalOffset?this.viewingMode===L.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,h(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(r=null,s,i,e,a){this.point=s,this.filterPredicate=e,this.tolerance=i??D;const n=v(this.verticalOffset);if(t(r)&&r.length>0){const s=a?t=>{a(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const i of r){const r=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();t(r)?(t(n)?r.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,s,n):r.forEachAlongRay(this._ray.origin,this._ray.direction,s),this.options.selectionMode&&this.options.hud&&r.forEachDegenerateObject(s)):i.objects.forAll((t=>s(t)))}}this.sortResults()}intersectObject(r){const s=r.geometries;if(!s)return;const i=r.transformation,a=v(this.verticalOffset);for(const n of s){if(!n.visible)continue;const{material:s,id:o}=n;this.transform.setAndInvalidateLazyTransforms(i,n.shaderTransformation),c(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),c(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;t(a)&&(a.objectTransform=this.transform),s.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((s,i,a,n,c,d)=>{if(s>=0){if(t(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,s))return;const l=n?this._results.hud:this._results,f=n?t=>{const n=new w(r,o,a,d);t.set(T.HUD,n,s,i,e,c)}:t=>t.set(T.OBJECT,{object:r,geometryId:o,triangleNr:a},s,i,h,c);if((null==l.min.drapedLayerOrder||c>=l.min.drapedLayerOrder)&&(null==l.min.dist||s<l.min.dist)&&f(l.min),this.options.store!==b.MIN&&(null==l.max.drapedLayerOrder||c<l.max.drapedLayerOrder)&&(null==l.max.dist||s>l.max.dist)&&f(l.max),this.options.store===b.ALL)if(n){const t=new S(this._ray);f(t),this._results.hud.all.push(t)}else{const t=new J(this._ray);f(t),this._results.all.push(t)}}}))}}sortResults(t=this._results.all){t.sort(((t,s)=>t.dist!==s.dist?r(t.dist,0)-r(s.dist,0):t.drapedLayerOrder!==s.drapedLayerOrder?r(t.drapedLayerOrder,Number.MAX_VALUE)-r(s.drapedLayerOrder,Number.MAX_VALUE):r(s.drapedLayerGraphicOrder,Number.MIN_VALUE)-r(t.drapedLayerGraphicOrder,Number.MIN_VALUE)))}}function G(t){return new C(t)}class P{constructor(){this.min=new J(g()),this.max=new J(g()),this.hud={min:new S(g()),max:new S(g()),all:new Array},this.ground=new J(g()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class J{get ray(){return this._ray}get distanceInRenderSpace(){return t(this.dist)?(d(H,this.ray.direction,this.dist),l(H)):null}getIntersectionPoint(t){return!!U(this)&&(d(H,this.ray.direction,this.dist),h(t,this.ray.origin,H),!0)}getTransformedNormal(t){return f(W,this.normal),W[3]=0,y(W,W,this.transformation),f(t,W),m(t,t)}constructor(t){this.intersector=T.OBJECT,this.normal=o(),this.transformation=i(),this._ray=g(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=T.OBJECT,_(t,this._ray)}set(t,i,a,n,o,h,c){this.intersector=t,this.dist=a,f(this.normal,r(n,u)),s(this.transformation,r(o,e)),this.target=i,this.drapedLayerOrder=h,this.drapedLayerGraphicOrder=c}copy(t){_(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,f(this.normal,t.normal),s(this.transformation,t.transformation)}}class S extends J{constructor(){super(...arguments),this.intersector=T.HUD}}function X(t){return new J(t)}const H=o(),W=p();export{D,N as G,T as I,M as L,b as S,G as a,R as b,B as c,U as i,X as n,x as s};
