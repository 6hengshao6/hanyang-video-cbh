/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{h as r}from"./typedArrayUtil.js";import{L as t}from"./Logger.js";import{t as o}from"./screenUtils.js";import{g as s}from"./capabilities2.js";const a=8,l=a-2,n=t.getLogger("esri.views.2d.layers.features.support.rendererUtils"),i=e=>{if(!("visualVariables"in e)||!e.visualVariables||!e.visualVariables.length)return e;const r=e.clone(),t=r.visualVariables.map((e=>p(e)?c(e):e));return r.visualVariables=t,r};function u(e){return e.map((e=>p(e)?c(e.clone()):e))}function p(e){return("size"===e.type||"color"===e.type||"opacity"===e.type)&&null!=e.stops}function c(e){return e.stops=(r=e.type,(t=e.stops??[]).length<=a?t:(n.warn(`Found ${t.length} Visual Variable stops, but MapView only supports ${a}. Displayed stops will be simplified.`),t.length>2*a?function(e,r){const[t,...s]=r,a=s.pop(),n=s[0].value,i=s[s.length-1].value,u=(i-n)/l,p=[];for(let t=n;t<i;t+=u){let a=0;for(;t>=s[a].value;)a++;const l=s[a],n=r[a-1],i=t-n.value,u=l.value===n.value?1:i/(l.value-n.value);if("color"===e){const e=s[a],o=r[a-1],l=e.color.clone();l.r=f(o.color.r,l.r,u),l.g=f(o.color.g,l.g,u),l.b=f(o.color.b,l.b,u),l.a=f(o.color.a,l.a,u),p.push({value:t,color:l,label:e.label})}else if("size"===e){const e=s[a],l=r[a-1],n=o(e.size),i=f(o(l.size),n,u);p.push({value:t,size:i,label:e.label})}else{const e=s[a],o=f(r[a-1].opacity,e.opacity,u);p.push({value:t,opacity:o,label:e.label})}}return[t,...p,a]}(r,t):function(e){const[r,...t]=e,o=t.pop();for(;t.length>l;){let e=0,r=0;for(let o=1;o<t.length;o++){const s=t[o-1],a=t[o],l=Math.abs(a.value-s.value);l>r&&(r=l,e=o)}t.splice(e,1)}return[r,...t,o]}(t))),e;var r,t}function f(e,r,t){return(1-t)*e+t*r}function b(){if(r("heatmap-force-raster"))return"raster";const{supportsTextureFloat:e,supportsTextureHalfFloat:t,supportsColorBufferFloat:o,supportsColorBufferFloatBlend:a,supportsColorBufferHalfFloat:l}=s("2d");return e&&o&&a||t&&l?"symbol":r("heatmap-allow-raster-fallback")?"raster":"none"}function m(t){if(!t)return!0;switch(t.type){case"dot-density":if(!s("2d").supportsTextureFloat)return n.error(new e("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),!1;break;case"heatmap":{const t=b();if("none"===t||"raster"===t&&!r("heatmap-force-raster")){const r=s("2d"),o=["supportsTextureFloat","supportsTextureHalfFloat","supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter((e=>!r[e])).join(", ");if("none"===t)return n.errorOnce(new e("webgl-missing-extension",`Missing WebGL${r.type} requirements for Heatmap: ${o}`)),!1;"raster"===t&&n.warnOnce(`Missing WebGL${r.type} requirements for accelerated Heatmap: ${o}. Feature support may be limited.`)}break}}return!0}export{i as a,b as g,m as i,u as s};
