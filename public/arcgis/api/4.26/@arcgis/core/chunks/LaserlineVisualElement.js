/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{i as e,a as t,p as i,k as s}from"./maybe.js";import{d as n,s as r,b as a,f as h,c as l,a as c,k as o}from"./vec3.js";import{c as d,b as _,e as u}from"./lineSegment.js";import{V as g}from"./VisualElement.js";import{b as f,d as p,e as P,g as b,h as m}from"./frustum.js";import{w as V}from"./ray.js";import{V as L}from"./ViewingMode.js";import{n as E}from"./DoubleArray.js";import{g as y}from"./glUtil.js";import{n as R}from"./InterleavedLayout.js";import{b as D,c as S}from"./glUtil3D.js";import{V as q}from"./VertexAttribute.js";import{R as M,S as C,P as v}from"./Program2.js";import{L as T}from"./LaserlinePath.glsl.js";import{B as A,d as w,U as I}from"./enums3.js";import{m as x,b as j,a as O}from"./renderState.js";import{B}from"./FramebufferObject.js";import{R as N}from"./RenderSlot.js";import{D as U,c as H,u as W}from"./Material.js";import{_ as z}from"./tslib.es6.js";import{p as G,S as X}from"./ShaderTechniqueConfiguration.js";import{d as k}from"./mathUtils.js";import{N as F}from"./interfaces2.js";import{L as J,d as K}from"./Laserlines.glsl.js";class Q extends C{initializeProgram(e){return new v(e.rctx,Q.shader.get().build(this.configuration),Y)}initializePipeline(){return x({blending:j(A.ONE,A.ONE_MINUS_SRC_ALPHA),colorWrite:O})}}Q.shader=new M(T,(()=>import("./LaserlinePath.glsl.js").then((e=>e.L))));const Y=new Map([[q.START,0],[q.END,1],[q.UP,2],[q.EXTRUDE,3]]);class Z{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=n(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const t=E(3*e.length);let i=0;for(const s of e)t[i++]=s[0],t[i++]=s[1],t[i++]=s[2];this.buffers=[t]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const e=this._buffers[0],t=3*Math.floor(e.length/3/2);r(this._origin,e[t],e[t+1],e[t+2])}else r(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(t){const i=this._ensureVAO(t);e(i)&&(t.bindVAO(i),t.drawArrays(w.TRIANGLES,0,this._count))}dispose(){e(this._vao)&&this._vao.dispose()}_ensureVAO(e){return t(this._buffers)?null:(t(this._vao)&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,t){const i=this._createDataBuffer(t);return this._dirty=!1,new D(e,Y,{data:y(te)},{data:B.createVertex(e,I.STATIC_DRAW,i)})}_ensureVertexData(e,t){if(!this._dirty)return;const i=this._createDataBuffer(t);e.vertexBuffers.data?.setData(i),this._dirty=!1}_numberOfRenderVertices(e){return 2*(e.length/3-1)*3}_createDataBuffer(e){const t=e.reduce(((e,t)=>e+this._numberOfRenderVertices(t)),0);this._count=t;const i=te.createBuffer(t),s=this._origin;let n=0,h=0;for(const t of e){for(let e=0;e<t.length;e+=3){const l=r(ee,t[e],t[e+1],t[e+2]);0===e?h=this._renderCoordsHelper.getAltitude(l):this._renderCoordsHelper.setAltitude(l,h);const c=this._renderCoordsHelper.worldUpAtPosition(l,$),o=n+2*e,d=a(ee,l,s);if(e<t.length-3){i.up.setVec(o,c),i.up.setVec(o+3,c),i.up.setVec(o+5,c);for(let e=0;e<6;e++)i.start.setVec(o+e,d);i.extrude.setValues(o,0,-1),i.extrude.setValues(o+1,1,-1),i.extrude.setValues(o+2,1,1),i.extrude.setValues(o+3,0,-1),i.extrude.setValues(o+4,1,1),i.extrude.setValues(o+5,0,1)}if(e>0){i.up.setVec(o-2,c),i.up.setVec(o-4,c),i.up.setVec(o-5,c);for(let e=-6;e<0;e++)i.end.setVec(o+e,d)}}n+=this._numberOfRenderVertices(t)}return i.buffer}}const $=n(),ee=n(),te=R().vec3f(q.START).vec3f(q.END).vec3f(q.UP).vec2f(q.EXTRUDE);class ie extends X{constructor(){super(...arguments),this.contrastControlEnabled=!1}}z([G()],ie.prototype,"contrastControlEnabled",void 0);class se extends F{constructor(){super(...arguments),this.innerColor=h(1,1,1),this.innerWidth=1,this.glowColor=h(1,.5,0),this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.75,this.globalAlphaContrastBoost=2,this.angleCutoff=k(6),this.pointDistanceOrigin=n(),this.pointDistanceTarget=n(),this.lineVerticalPlaneSegment=d(),this.intersectsLineSegment=d(),this.intersectsLineRadius=3,this.heightManifoldTarget=n(),this.lineStartWorld=n(),this.lineEndWorld=n()}}class ne extends C{initializeProgram(e){return new v(e.rctx,ne.shader.get().build(this.configuration),U)}initializePipeline(){return x({blending:j(A.ONE,A.ONE_MINUS_SRC_ALPHA),colorWrite:O})}}ne.shader=new M(J,(()=>import("./Laserlines.glsl.js").then((e=>e.L))));class re extends ie{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.spherical=!1}}z([G()],re.prototype,"heightManifoldEnabled",void 0),z([G()],re.prototype,"pointDistanceEnabled",void 0),z([G()],re.prototype,"lineVerticalPlaneEnabled",void 0),z([G()],re.prototype,"intersectsLineEnabled",void 0),z([G()],re.prototype,"spherical",void 0);class ae{constructor(e,t={contrastControlEnabled:!1}){this._config=t,this._technique=null,this._heightManifoldEnabled=!1,this._pointDistanceEnabled=!1,this._lineVerticalPlaneEnabled=!1,this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._viewingMode=L.Local,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._passParameters=H(e,new se)}get renderSlots(){return[this._config.contrastControlEnabled?N.LASERLINES_CONTRAST_CONTROL:N.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._passParameters.heightManifoldTarget}set heightManifoldTarget(e){l(this._passParameters.heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._passParameters.pointDistanceTarget}set pointDistanceTarget(e){l(this._passParameters.pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._passParameters.pointDistanceOrigin}set pointDistanceOrigin(e){l(this._passParameters.pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._passParameters.lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){_(e,this._passParameters.lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._passParameters.intersectsLineSegment}set intersectsLineSegment(e){_(e,this._passParameters.intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._passParameters.intersectsLineRadius}set intersectsLineRadius(e){e!==this._passParameters.intersectsLineRadius&&(this._passParameters.intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get viewingMode(){return this._viewingMode}set viewingMode(e){e!==this._viewingMode&&(this._viewingMode=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(t){t!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=t,e(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){t(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Z(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){t(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new Z(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){W(this._passParameters,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=S(t),this._techniqueRepository=e.techniqueRepository,this._techniqueConfig=new re;const i=new ie;i.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(Q,i)}uninitializeRenderContext(){this._quadVAO=i(this._quadVAO),this._technique=s(this._technique),this._pathVerticalPlaneData=i(this._pathVerticalPlaneData),this._pathTechnique=s(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._techniqueConfig.spherical=this._viewingMode===L.Global,this._technique=this._techniqueRepository.releaseAndAcquire(ne,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,t){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,t),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,t){const i=e.rctx;this._updatePassParameters(e),i.bindTechnique(t,this._passParameters,e.bindParameters),i.bindVAO(this._quadVAO),i.drawArrays(w.TRIANGLE_STRIP,0,4)}_renderPath(e){if(t(this._pathVerticalPlaneData)||t(this._pathTechnique))return;const i=e.rctx,s=this._pathTechnique;i.bindTechnique(s,{...this._passParameters,origin:this._pathVerticalPlaneData.origin},e.bindParameters),this._pathVerticalPlaneData.draw(e.rctx)}_updatePassParameters(e){if(!this._intersectsLineEnabled)return;const t=e.bindParameters.camera;if(this._intersectsLineInfinite){if(p(V(this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector),he),he.c0=-Number.MAX_VALUE,!P(t.frustum,he))return;b(he,this._passParameters.lineStartWorld),m(he,this._passParameters.lineEndWorld)}else l(this._passParameters.lineStartWorld,this._passParameters.intersectsLineSegment.origin),c(this._passParameters.lineEndWorld,this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector)}_requestRender(){this._context&&this._context.requestRender()}}const he=f();class le extends g{constructor(e){super(e.view),this._angleCutoff=K,this._style={},this._heightManifoldTarget=n(),this._heightManifoldEnabled=!1,this._intersectsLine=d(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this._renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(t){e(t)?(l(this._heightManifoldTarget,t),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(t(e))return void(this.intersectsLine=null);const i=this.view.renderCoordsHelper.worldUpAtPosition(e,ce);this.intersectsLine=u(e,i),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(t){e(t)?(_(t,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(t){this._lineVerticalPlaneSegment=e(t)?_(t):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(t){this._pointDistanceLine=e(t)?{origin:o(t.origin),target:t.target?o(t.target):null}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||e(this._pointDistanceLine)||e(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){e(this._renderer)||(this._renderer=new ae({renderCoordsHelper:this.view.renderCoordsHelper},{contrastControlEnabled:!0}),this._renderer.viewingMode=this.view.state.viewingMode,this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this._renderer.renderSlots,this._renderer))}_syncStyle(){t(this._renderer)||(this._renderer.setParameters(this._style),null!=this._style.intersectsLineRadius&&(this._renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){t(this._renderer)||this._renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){t(this._renderer)||(this._renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this._renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){t(this._renderer)||(this._renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this._renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){t(this._renderer)||(this._renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){t(this._renderer)||(this._renderer.pathVerticalPlaneEnabled=e(this._pathVerticalPlaneBuffers)&&this.visible,e(this._pathVerticalPlaneBuffers)&&(this._renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){t(this._renderer)||(this._renderer.lineVerticalPlaneEnabled=e(this._lineVerticalPlaneSegment)&&this.visible,e(this._lineVerticalPlaneSegment)&&(this._renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){if(t(this._renderer))return;const i=this._pointDistanceLine,s=e(i);this._renderer.pointDistanceEnabled=s&&null!=i.target&&this.visible,s&&(this._renderer.pointDistanceOrigin=i.origin,null!=i.target&&(this._renderer.pointDistanceTarget=i.target))}_disposeRenderer(){e(this._renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this._renderer),this._renderer=null)}}const ce=n();export{le as L};
