/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../Color.js";import o from"../core/Error.js";import{l as s}from"./fontUtils.js";import{a as e,p as r}from"./screenUtils.js";import{f as i,e as l,k as m}from"./utils6.js";import{S as a,s as p,k as n}from"./previewUtils.js";import{f as c}from"./renderUtils.js";import{getColorLuminance as y}from"../views/support/colorUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"./vec4.js";import"./maybe.js";import"./ensureType.js";import"./typedArrayUtil.js";import"./Logger.js";import"../config.js";import"./object.js";import"../core/lang.js";import"./string.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"../geometry/SpatialReference.js";import"./unitUtils.js";import"./Ellipsoid.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"./aaBoundingRect.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"./Symbol3DAnchorPosition2D.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils.js";import"./parser.js";import"./mat4f32.js";import"./mat4.js";import"./_commonjsHelpers.js";import"./assets.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./colorUtils2.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";const j="picture-fill",u="picture-marker",h="simple-fill",b="simple-line",d="simple-marker",f="text",g="Aa",S=a.size,w=a.maxSize,v=a.maxOutlineSize,L=a.lineWidth,k=225,M=document.createElement("canvas");function x(t,o){const s=M.getContext("2d"),e=[];return o&&(o.weight&&e.push(o.weight),o.size&&e.push(o.size+"px"),o.family&&e.push(o.family)),s.font=e.join(" "),s.measureText(t).width}const D=7.2/2.54,U=72/2.54;function P(t){const o=t?.size;return{width:null!=o&&"object"==typeof o&&"width"in o?e(o.width):null,height:null!=o&&"object"==typeof o&&"height"in o?e(o.height):null}}function z(t,o){return t>o?"dark":"light"}function C(t,o){const s="number"==typeof o?.size?o?.size:null,m=null!=s?e(s):null,a=null!=o?.maxSize?e(o.maxSize):null,n=null!=o?.rotation?o.rotation:"angle"in t?t.angle:null,c=i(t);let y=l(t);"dark"!==E(t,245)||o?.ignoreWhiteSymbols||(y={width:.75,...y,color:"#bdc3c7"});const k={shape:null,fill:c,stroke:y,offset:[0,0]};y?.width&&(y.width=Math.min(y.width,v));const M=y?.width||0;let z=null!=o?.size&&(null==o?.scale||o?.scale),C=0,F=0,O=!1;switch(t.type){case d:{const s=t.style,{width:r,height:i}=P(o),l=r===i&&null!=r?r:null!=m?m:Math.min(e(t.size),a||w);switch(C=l,F=l,s){case"circle":k.shape={type:"circle",cx:0,cy:0,r:.5*l},z||(C+=M,F+=M);break;case"cross":k.shape={type:"path",path:[{command:"M",values:[0,.5*F]},{command:"L",values:[C,.5*F]},{command:"M",values:[.5*C,0]},{command:"L",values:[.5*C,F]}]};break;case"diamond":k.shape={type:"path",path:[{command:"M",values:[0,.5*F]},{command:"L",values:[.5*C,0]},{command:"L",values:[C,.5*F]},{command:"L",values:[.5*C,F]},{command:"Z",values:[]}]},z||(C+=M,F+=M);break;case"square":k.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"Z",values:[]}]},z||(C+=M,F+=M),n&&(O=!0);break;case"triangle":k.shape={type:"path",path:[{command:"M",values:[.5*C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"Z",values:[]}]},z||(C+=M,F+=M),n&&(O=!0);break;case"x":k.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,F]},{command:"M",values:[C,0]},{command:"L",values:[0,F]}]},n&&(O=!0);break;case"path":k.shape={type:"path",path:t.path||""},z||(C+=M,F+=M),n&&(O=!0),z=!0}break}case b:{const{width:t,height:s}=P(o),e=null!=s?s:null!=m?m:M,r=null!=t?t:L;y&&(y.width=e),C=r,F=e;const i=k?.stroke?.cap||"butt",l="round"===i;z=!0,k.stroke&&(k.stroke.cap="butt"===i?"square":i),k.shape={type:"path",path:[{command:"M",values:[l?e/2:0,F/2]},{command:"L",values:[l?C-e/2:C,F/2]}]};break}case j:case h:{const t="object"==typeof o?.symbolConfig&&!!o?.symbolConfig?.isSquareFill,{width:s,height:e}=P(o);C=!t&&s!==e||null==s?null!=m?m:S:s,F=!t&&s!==e||null==e?C:e,z||(C+=M,F+=M),z=!0,k.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[C,0]},{command:"L",values:[C,F]},{command:"L",values:[0,F]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:p.fill[0];break}case u:{const s=Math.min(e(t.width),a||w),r=Math.min(e(t.height),a||w),{width:i,height:l}=P(o),p=i===l&&null!=i?i:null!=m?m:Math.max(s,r),c=s/r;C=c<=1?Math.ceil(p*c):p,F=c<=1?p:Math.ceil(p/c),k.shape={type:"image",x:-Math.round(C/2),y:-Math.round(F/2),width:C,height:F,src:t.url||""},n&&(O=!0);break}case f:{const s=t,i=o?.overrideText||s.text||g,l=s.font,{width:p,height:n}=P(o),c=null!=n?n:null!=m?m:Math.min(e(l.size),a||w),y=x(i,{weight:l.weight,size:c,family:l.family}),j=/[\uE600-\uE6FF]/.test(i);C=p??(j?c:y),F=c;let u=.25*function(t){if(0===t.length)return 0;if(t.length>2){const o=r(1),s=parseFloat(t);switch(t.slice(-2)){case"px":return s;case"pt":return s*o;case"in":return 72*s*o;case"pc":return 12*s*o;case"mm":return s*D*o;case"cm":return s*U*o}}return parseFloat(t)}((l?c:0).toString());j&&(u+=5),k.shape={type:"text",text:i,x:s.xoffset||0,y:s.yoffset||u,align:"middle",alignBaseline:s.verticalAlignment,decoration:l&&l.decoration,rotated:s.rotated,kerning:s.kerning},k.font=l&&{size:c,style:l.style,decoration:l.decoration,weight:l.weight,family:l.family};break}}return{shapeDescriptor:k,size:[C,F],renderOptions:{node:o?.node,scale:z,opacity:o?.opacity,rotation:n,useRotationSize:O,effectView:o?.effectView}}}async function F(t,e){const{shapeDescriptor:r,size:i,renderOptions:l}=C(t,e);if(!r.shape)throw new o("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,o){const s=o.fill,e=t.color;if("pattern"===s?.type&&e&&t.type!==j){const t=await m(s.src,e.toCss(!0));s.src=t,o.fill=s}}(t,r),await async function(t,o,e,r){if(!("font"in t)||!t.font||"text"!==o.shape.type)return;try{await s(t.font)}catch{}const{width:i}=P(r),l=/[\uE600-\uE6FF]/.test(o.shape.text);null!=i||l||(e[0]=x(o.shape.text,{weight:o.font?.weight,size:o.font?.size,family:o.font?.family}))}(t,r,i,e);const a=[[r]];if("object"==typeof e?.symbolConfig&&e?.symbolConfig?.applyColorModulation){const t=.6*i[0];a.unshift([{...r,offset:[-t,0],fill:n(r.fill,-.3)}]),a.push([{...r,offset:[t,0],fill:n(r.fill,.3)}]),i[0]+=2*t,l.scale=!1}return c(a,i,l)}function E(o,s=k){const e=i(o),r=l(o),m=!e||"type"in e?null:new t(e),a=r?.color?new t(r?.color):null,p=m?z(y(m),s):null,n=a?z(y(a),s):null;return n?p?p===n?p:s>=k?"light":"dark":n:p}export{E as getContrastingBackgroundTheme,C as getRenderSymbolParameters,F as previewSymbol2D};
