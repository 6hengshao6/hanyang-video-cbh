/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../config.js";import t from"../core/Error.js";import{h as r}from"./typedArrayUtil.js";import{L as o}from"./Logger.js";import i from"../geometry/Point.js";import{geographicToWebMercator as s}from"../geometry/support/webMercatorUtils.js";import n from"../portal/Portal.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/Multipoint.js";import"../geometry/Polygon.js";import"../geometry/Polyline.js";import"./trimExtend.js";import"../rest/support/GeneralizeParameters.js";import"../rest/support/LengthsParameters.js";import"../rest/support/OffsetParameters.js";import{p as m}from"./project.js";import"../rest/support/RelationParameters.js";import"../rest/support/TrimExtendParameters.js";import a from"../rest/support/ProjectParameters.js";const c=o.getLogger("esri.widgets.support.geolocationUtils"),u={maximumAge:0,timeout:15e3,enableHighAccuracy:!0};function p(){return function(){const e=r("esri-geolocation");return e||c.warn("geolocation-unsupported","Geolocation unsupported."),e}()&&function(){const e=window.isSecureContext;return e||c.warn("insecure-context","Geolocation requires a secure origin."),e}()}function l(e){return e||(e=u),new Promise(((r,o)=>{setTimeout((()=>o(new t("geolocation:timeout","getting the current geolocation position timed out"))),15e3),navigator.geolocation.getCurrentPosition(r,o,e??void 0)}))}function g(r,o){const{position:c,view:u}=r,p=function(e){const t=e&&e.coords||{},r={accuracy:t.accuracy,altitude:t.altitude,altitudeAccuracy:t.altitudeAccuracy,heading:t.heading,latitude:t.latitude,longitude:t.longitude,speed:t.speed};return e?{coords:r,timestamp:e.timestamp}:e}(c),l=p?.coords;if(!l)throw new t("geometry-service:no-coords","Geolocation has no coordinates");return function(r,o,i){if(!o)return Promise.resolve(r);const c=o.spatialReference;return c.isWGS84?Promise.resolve(r):c.isWebMercator?Promise.resolve(s(r)):function(t){if(e.geometryServiceUrl)return Promise.resolve(e.geometryServiceUrl);const r=n.getDefault();return r.load(t).catch((()=>{})).then((()=>r.get("helperServices.geometry.url")))}(i).then((e=>{if(!e)throw new t("geometry-service:missing-url","Geometry service URL is missing");const o=new a({geometries:[r],outSpatialReference:c});return m(e,o,i).then((e=>e[0]))}))}(function({longitude:e,latitude:t,altitude:r}){return new i({longitude:e,latitude:t,z:r||void 0,spatialReference:{wkid:4326}})}(l),u,o)}export{l as g,g as p,p as s};
