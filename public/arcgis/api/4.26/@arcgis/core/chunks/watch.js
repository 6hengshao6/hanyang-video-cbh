/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{O as e,A as t}from"./ArrayPool.js";import{equals as s,equalsShallow as r}from"../core/lang.js";import{n,i as o}from"./maybe.js";import{schedule as i}from"../core/scheduling.js";import{v as l}from"./get.js";import{r as c}from"./tracking.js";import{p as u,o as a}from"./utils.js";class d extends e{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=n(this._set)}acquire(...e){const t=super.acquire(...e);return this._set.delete(t),t}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}function h(e,t){for(const s of e.entries())if(t(s[0]))return!0;return!1}function f(e,t){const s=new Set;return o(e)&&e.forEach((e=>s.add(e))),o(t)&&t.forEach((e=>s.add(e))),s}let _=0;const v=0;function m(){return++_}class p{constructor(e){this._accessed=[],this._handles=[],this._observerObject=new g(e),y.register(this,this._observerObject,this._observerObject)}destroy(){y.unregister(this._observerObject),this._accessed.length=0,this._observerObject?.destroy(),this.clear()}onObservableAccessed(e){const t=this._accessed;t.includes(e)||t.push(e)}onTrackingEnd(){const e=this._handles,t=this._accessed,s=this._observerObject;for(let r=0;r<t.length;++r)e.push(t[r].observe(s));t.length=0}clear(){const e=this._handles;for(let t=0;t<e.length;++t)e[t].remove();e.length=0}}class g{constructor(e){this._notify=e,this._invalidCount=0,this.destroyed=!1}onInvalidated(){this._invalidCount++}onCommitted(){if(this.destroyed)return;const e=this._invalidCount;if(1===e)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}destroy(){this.destroyed=!0,this._notify=b}}const y=new FinalizationRegistry((e=>{e.destroy()}));function b(){}let k=!1;const q=[];function j(e,t){let s=new p((function o(){if(!s||n)return;if(k)return void O(o);const i=r;s.clear(),k=!0,n=!0,r=c(s,e),n=!1,k=!1,t(r,i),C()})),r=null,n=!1;return n=!0,r=c(s,e),n=!1,{remove:function(){s&&(s.destroy(),s=null,r=null)}}}function w(e,t){let s=new p((function(){t(r,n)})),r=null;function n(){return s?(s.clear(),r=c(s,e),r):null}return n(),{remove:function(){s&&(s.destroy(),s=null),r=null}}}function V(e){let t=new p((function r(){t&&!s&&(k?O(r):(t.clear(),k=!0,s=!0,c(t,e),s=!1,k=!1,C()))})),s=!1;return s=!0,c(t,e),s=!1,{remove:function(){t&&(t.destroy(),t=null)}}}function O(e){q.includes(e)||q.unshift(e)}function C(){for(;q.length;)q.pop()()}var T;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(T||(T={}));class U{constructor(){this.uid=m(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,t,r,n,o){return this.pool.acquire(T.Untracked,e,t,r,n,o,s)}static acquireTracked(e,t,s,r){return this.pool.acquire(T.Tracked,e,t,s,null,null,r)}notify(e,t){this.type===T.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)}acquire(e,t,s,r,n,o,i){this.uid=m(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=s,this.getValue=r,this.target=n,this.path=o,this.equals=i}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=m(),this.removed=!0}}U.pool=new d(U);const S=new t,E=new Set;let A;function x(e){E.delete(e),E.add(e),A||(A=i(F))}function z(e){if(e.removed)return;const t=e.oldValue,s=e.getValue();e.equals(t,s)||(e.oldValue=s,e.notify(s,t))}function R(e){for(const t of E.values())t.target===e&&(t.removed=!0)}function F(){let e=10;for(;A&&e--;){A=null;const e=I(),t=S.acquire();for(const s of e){const e=s.uid;z(s),e===s.uid&&s.removed&&t.push(s)}for(const e of E)e.removed&&(t.push(e),E.delete(e));for(const e of t)U.pool.release(e);S.release(t),S.release(e),N.forEach((e=>e()))}}function I(){const e=S.acquire();e.length=E.size;let t=0;for(const s of E)e[t]=s,++t;return E.clear(),e}const N=new Set;function P(e){return N.add(e),{remove(){N.delete(e)}}}function B(e,t,r,n=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:n?function(e,t,r){const n=u(e,t,r,((e,t,r)=>{let o=!1;return j((()=>l(e,t)),((i,l)=>{e.__accessor__.destroyed?n.remove():o||(o=!0,s(l,i)||r.call(e,i,l,t,e),o=!1)}))}));return n}(e,t,r):function(e,t,s){let r=u(e,t,s,((e,t,s)=>{let n,o,i=w((()=>l(e,t)),((i,l)=>{e.__accessor__.destroyed||n&&n.uid!==o?r.remove():(n||(n=U.acquireUntracked(i,s,l,e,t),o=n.uid),x(n))}));return{remove:a((()=>{i.remove(),n&&(n.uid!==o||n.removed||(n.removed=!0,x(n)),n=null),r=i=null}))}}));return r}(e,t,r)}function D(e,t,s=!1,n=r){return s?function(e,t,s){let r=!1;return j(e,((e,n)=>{r||(r=!0,s(n,e)||t(e,n),r=!1)}))}(e,t,n):function(e,t,s){let r,n,o=w(e,((e,i)=>{r&&r.uid!==n?o.remove():(r||(r=U.acquireTracked(e,t,i,s),n=r.uid),x(r))}));return{remove:a((()=>{o.remove(),r&&(r.uid!==n||r.removed||(r.removed=!0,x(r)),r=null),o=null}))}}(e,t,n)}function G(e){return h(E,(t=>t.oldValue===e))}export{v as N,d as R,p as S,V as a,D as b,P as c,m as g,G as i,R as r,h as s,f as u,B as w};
