/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{i as e}from"./maybe.js";import{throwIfAborted as n}from"../core/promiseUtils.js";import"./typedArrayUtil.js";import t from"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import l from"../layers/support/Field.js";import{noDominantCategoryField as i}from"../smartMapping/statistics/support/predominanceUtils.js";import{i as a,a as o,c as r}from"./utils13.js";import{l as s,p as u}from"./utils10.js";const c=/_value$/i,f=Math.LOG10E;function m(e){return e.map((e=>e.toJSON()))}function p(e,n){const t=[],l=e.layer,i="featureReduction"in l?l.featureReduction:null,a="binning"===i?.type,o=null!=i&&"fields"in i?i.fields?.map((e=>e.name?.toLowerCase())).filter(Boolean):[];if(!a||!n)return t;for(const e of n)o.includes(e.toLowerCase())||t.push(e);return t}function d(e,n,t){const l=[];if(n)for(const i of n){const n=e.getField(i);n&&t&&"availableFields"in t&&!t.availableFields?.includes(n.name)&&l.push(n.name)}return l}function g(e,n){const t=e&&e.features,l=t&&t[0]&&t[0].attributes,i={};for(const e in l)i[e.replace(c,"").toLowerCase()]=l[e];return null!=i.totalcount&&i.totalcount>=i.count&&(i.nullcount=i.totalcount-i.count),delete i.totalcount,i.min===i.max&&null!=i.min&&null==i.stddev&&(i.stddev=i.variance=0),n&&(["min","max","avg","stddev","sum","variance"].forEach((e=>{null!=i[e]&&(i[e]=Math.ceil(i[e]))})),i.min===i.max&&null!=i.min&&(i.avg=i.min,i.stddev=i.variance=0)),i}function y(e){const n=[],t=e.classBreaks,l=t[0].minValue,i=t[t.length-1].maxValue;t.forEach((e=>{n.push([e.minValue,e.maxValue])}));const a={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,layer:e.layer};return{min:l,max:i,intervals:n,sqlExpr:v(a),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function v(e){const{field:n,normalizationType:t,normalizationField:l,normalizationTotal:i,layer:o}=e,s=a(o,n);let u=n;return"percent-of-total"===t?u=`((${s?r(n):n} / ${i}) * 100)`:"log"===t?u=`(log(${n}) * ${f})`:"field"===t?u=`(${s?r(n):n} / ${l})`:"natural-log"===t?u=`(log(${s?r(n):n}))`:"square-root"===t&&(u=`(power(${s?r(n):n}, 0.5))`),u}function h(e,n){let t;if(n=n.toLowerCase(),e)for(const l in e)if(l.toLowerCase()!==n){t=e[l];break}return t}function w(e,n){let t;if(n=n.toLowerCase(),e)for(const l in e)if(l.toLowerCase()===n){t=e[l];break}return t}function x(e,n,t,l,i){const a={},o="countOFExpr";e&&e.features&&e.features.forEach((e=>{const n=e.attributes,t=h(n,o),l=w(n,o);null!=t&&null!=l&&0!==t&&(a[t]=l)}));const r=[];return s(n,t,l).forEach(((e,n)=>{const t=(n+1).toString();r.push({minValue:e[0],maxValue:e[1],count:a.hasOwnProperty(t)?a[t]:0})})),{bins:r,minValue:n,maxValue:t,normalizationTotal:i}}function F(e,t){const l=e&&e.features,{field:i,field2:a,field3:o,fieldDelimiter:r,layer:s,view:c,signal:f,labels:m}=t,p=`countOF${i&&a?"Expr":i||"Expr"}`,d={};let g=!1;if(l.forEach((e=>{const n=e.attributes,t=w(n,p);let l=i?w(n,i):h(n,p),s=a?w(n,a):null,c=o?w(n,o):null;null===l&&0===t&&(g=!0),(null==l||"string"==typeof l&&""===l.trim())&&(l=null),a&&(null==s||"string"==typeof s&&""===s.trim())&&(s=null),o&&(null==c||"string"==typeof c&&""===c.trim())&&(c=null);let f=l;a&&(f=`${u(f)}${r}${u(s)}`,o&&(f=`${f}${r}${u(c)}`)),null==d[f]?d[f]={count:t,data:f}:d[f].count=d[f].count+t})),i&&g){const e=i+" is NULL";return s.queryFeatureCount({whereClause:e,view:c,signal:f}).then((e=>(e=e||0,d.null.count=d.null.count+e,b(d,m)))).catch((()=>(n(f),b(d,m))))}return Promise.resolve(b(d,m))}function b(e,n){if(n)for(const t in e)e[t].label=n[t];return{count:e}}async function E(e,n,l){const i=e?l.getField(e):null,a=i?l.getFieldDomain(i.name):null;if(a)return a;const{uniqueValueInfos:o}=await l.uniqueValues({field:e,sqlWhere:n.sqlWhere,features:n.features,useFeaturesInView:n.useFeaturesInView,view:n.view,signal:n.signal}),r=o.map((e=>({code:e.value})));return new t({codedValues:r})}async function $(e,n){if(!e.returnAllCodedValues)return[];const{field:t,field2:l,field3:i}=e;if(t&&!l){const e=t?n.getField(t):null,l=e?n.getFieldDomain(e.name):null;return l?[l]:[]}const a=[];return t&&(a.push(E(t,e,n)),l&&(a.push(E(l,e,n)),i&&a.push(E(i,e,n)))),Promise.all(a)}function V(e,n){return o(e,new Date(0),n,"milliseconds").sqlExpression}function j(e){return{viewingMode:"2d"===e.type?"map":e.viewingMode,scale:e.scale,spatialReference:e.spatialReference?.toJSON()}}function C(e,n){const t=e.map((e=>e.value)),l=n.filter((e=>!t.includes(e)));for(const n of l)e.push({value:n,count:0});e.sort(((e,t)=>n.indexOf(e.value)-n.indexOf(t.value)));for(const n of e)n.value===i&&(n.value=null);return{predominantCategoryInfos:e}}function T(n){const t="featureReduction"in n?n.featureReduction:null;return((null!=t&&"fields"in t?t.fields:null)??[]).map((e=>{const t=function(e,n){switch(e.statisticType){case"avg":case"avg_angle":return"double";case"count":return"integer";case"min":case"max":case"sum":return e.onStatisticField?n.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?null:"double":null;case"mode":return e.onStatisticField?n.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?"string":"double":null;default:return null}}(e,n.fieldsIndex);return t?new l({type:t,name:e.name,alias:e.alias}):null})).filter(e)}export{g as a,j as b,d as c,F as d,m as e,x as f,v as g,y as h,$ as i,C as j,p as k,T as l,V as m};
