/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../request.js";import t from"../core/Error.js";import{throwIfAborted as r,isAbortError as i}from"../core/promiseUtils.js";import{p as a,a as s,d as n}from"./Rasterizer.js";import{M as o}from"../core/scheduling.js";import{c}from"./imageutils2.js";const h=[137,80,78,71,13,10,26,10],u=[71,73,70];class d{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){return this._resourceMap.get(e)??null}async fetchResource(d,l){const p=this._resourceMap.get(d);if(p)return{width:p.width,height:p.height};let g=this._inFlightResourceMap.get(d);return g?g.then((e=>({width:e.width,height:e.height}))):(g=async function(d,l){const{arrayBuffer:p,mediaType:g}=await async function(r,a){let s;const n=";base64,";if(r.includes(n)){const e=r.indexOf(n),t=r.indexOf(n)+n.length,i=r.substring(t),a=atob(i),o=new Uint8Array(a.length);for(let e=0;e<a.length;e++)o[e]=a.charCodeAt(e);s={arrayBuffer:o.buffer,mediaType:r.substring(0,e).replace("data:","")}}else try{const t=await e(r,{responseType:"array-buffer",...a});s={arrayBuffer:t.data,mediaType:t.getHeader("Content-Type")}}catch(e){if(!i(e))throw new t("mapview-invalid-resource",`Could not fetch requested resource at ${r}`)}return s}(d,l),f="image/png"===g;return"image/gif"===g&&function(e){if(!function(e){const t=new Uint8Array(e);return!u.some(((e,r)=>e!==t[r]))}(e))return!1;const t=new DataView(e),r=t.getUint8(10);let i=13+(128&r?3*2**(1+(7&r)):0),a=0,s=!1;for(;!s;){switch(t.getUint8(i++)){case 33:if(!n())return!1;break;case 44:o();break;case 59:s=!0;break;default:return!1}if(a>1)return!0}function n(){switch(t.getUint8(i++)){case 249:i++,i+=4,c();break;case 1:a++,i++,i+=12,c();break;case 254:c();break;case 255:i++,i+=8,i+=3,c();break;default:return!1}return!0}function o(){a++,i+=8;const e=t.getUint8(i++);i+=128&e?3*2**(1+(7&e)):0,i++,c()}function c(){let e;for(;e=t.getUint8(i++);)i+=e}return!1}(p)?async function(e,t){const r=s(e),i=n(r,!0),{width:a,height:h}=r.lsd,u=document.createElement("canvas");u.width=a,u.height=h;const d=u.getContext("2d",{willReadFrequently:!0}),l=[],p=[];for(const e of i){p.push(o(e.delay||100));const t=new ImageData(e.patch,e.dims.width,e.dims.height),r=c(t),i=3===e.disposalType?d.getImageData(e.dims.left,e.dims.top,e.dims.width,e.dims.height):void 0;d.drawImage(r,e.dims.left,e.dims.top);const s=d.getImageData(0,0,a,h);l.push(s),1===e.disposalType||(2===e.disposalType?d.clearRect(e.dims.left,e.dims.top,e.dims.width,e.dims.height):3===e.disposalType&&d.putImageData(i,e.dims.left,e.dims.top))}return{frameDurations:p,getFrame:e=>l[e],width:a,height:h}}(p):f&&function(e){if(!function(e){const t=new Uint8Array(e);return!h.some(((e,r)=>e!==t[r]))}(e))return!1;const t=new DataView(e),r=new Uint8Array(e);let i,a=8;do{const e=t.getUint32(a);if(i=String.fromCharCode.apply(String,Array.prototype.slice.call(r.subarray(a+4,a+8))),"acTL"===i)return!0;a+=12+e}while("IEND"!==i&&a<r.length);return!1}(p)?async function(e,t){const i=a(e);if(i instanceof Error)throw i;await i.createImages(),r(t);const{frames:s,width:n,height:c}=i,h=document.createElement("canvas");h.width=n,h.height=c;const u=h.getContext("2d",{willReadFrequently:!0}),d=[],l=[];for(const e of s){l.push(o(e.delay||100));const t=e.imageElement;0===e.blendOp?u.globalCompositeOperation="copy":u.globalCompositeOperation="source-over";const r=2===e.disposeOp?u.getImageData(e.left,e.top,e.width,e.height):void 0;u.drawImage(t,e.left,e.top);const i=u.getImageData(0,0,n,c);d.push(i),0===e.disposeOp||(1===e.disposeOp?u.clearRect(e.left,e.top,e.width,e.height):2===e.disposeOp&&u.putImageData(r,e.left,e.top))}return{frameDurations:l,getFrame:e=>d[e],width:n,height:c}}(p,l):async function(r,a){const s=window.URL.createObjectURL(r);try{const{data:t}=await e(s,{...a,responseType:"image"});return t}catch(e){if(!i(e))throw new t("mapview-invalid-resource",`Could not fetch requested resource at ${s}`);throw e}finally{window.URL.revokeObjectURL(s)}}(new Blob([p],{type:g}),l)}(d,l),this._inFlightResourceMap.set(d,g),g.then((e=>(this._inFlightResourceMap.delete(d),this._resourceMap.set(d,e),{width:e.width,height:e.height})),(()=>({width:0,height:0}))))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}}export{d as C};
