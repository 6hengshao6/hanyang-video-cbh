/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{createResolver as e}from"../core/promiseUtils.js";import{Q as t}from"./Queue.js";import{A as s}from"./AttributeStoreView.js";import{T as i}from"./TileContainer.js";import{e as a,u as r,i as o}from"./maybe.js";import{a as n}from"./screenUtils.js";import{g as l}from"./unitUtils.js";import{m as u}from"./lengthUtils.js";import{F as v,i as h}from"./color.js";import{T as c,b as m}from"./utils19.js";import{g as p}from"./capabilities2.js";function d(e,t){const s=t.length;if(e<t[0].value||1===s)return t[0].size;for(let i=1;i<s;i++)if(e<t[i].value){const s=(e-t[i-1].value)/(t[i].value-t[i-1].value);return t[i-1].size+s*(t[i].size-t[i-1].size)}return t[s-1].size}class f{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=c}getSizeVVFieldStops(e){const t=this._vvSizeFieldStops;if(t)switch(t.type){case"static":return t;case"level-dependent":return a(t.levels[e],(()=>{let s=1/0,i=0;for(const a in t.levels){const t=parseFloat(a),r=Math.abs(e-t);r<s&&(s=r,i=t)}if(s===1/0)return{sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const a=2**((e-i)/2),o=r(t.levels[i]),n=new Float32Array(o.values);return n[2]*=a,n[3]*=a,{sizes:r(o.sizes),values:n}}));default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(e){o(this._vvInfo)&&this._updateVisualVariables(this._vvInfo.vvRanges,e)}setInfo(e,t,s){this._updateEffects(s),this._vvInfo=t,this._technique=m(e),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,e)}getVariation(){return{...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:p("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(e){o(e)?this.outsideLabelsVisible=e.excludedLabelsVisible:this.outsideLabelsVisible=!1}_updateVisualVariables(e,t){const s=this._vvMaterialParameters;if(s.vvOpacityEnabled=!1,s.vvSizeEnabled=!1,s.vvColorEnabled=!1,s.vvRotationEnabled=!1,!e)return;const i=e.size;if(i){if(s.vvSizeEnabled=!0,i.minMaxValue){const e=i.minMaxValue;let s,a;if(v(e.minSize)&&v(e.maxSize))if(h(e.minSize)&&h(e.maxSize))s=n(e.minSize),a=n(e.maxSize);else{const i=t.scale;s=n(d(i,e.minSize.stops)),a=n(d(i,e.maxSize.stops))}this.vvSizeMinMaxValue.set([e.minDataValue,e.maxDataValue,s,a])}if(i.scaleStops&&(this.vvSizeScaleStopsValue=n(d(t.scale,i.scaleStops.stops))),i.unitValue){const e=l(t.spatialReference)/u[i.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=e/t.resolution}i.fieldStops&&(this._vvSizeFieldStops=i.fieldStops)}const a=e.color;a&&(s.vvColorEnabled=!0,this.vvColorValues.set(a.values),this.vvColors.set(a.colors));const r=e.opacity;r&&(s.vvOpacityEnabled=!0,this.vvOpacityValues.set(r.values),this.vvOpacities.set(r.opacities));const o=e.rotation;o&&(s.vvRotationEnabled=!0,s.vvRotationType=o.type)}}class b extends i{constructor(e){super(e),this._rendererInfo=new f,this._materialItemsRequestQueue=new t,this.attributeView=new s((()=>this.onAttributeStoreUpdate()))}destroy(){this.children.forEach((e=>e.destroy())),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear()}setRendererInfo(e,t,s){this._rendererInfo.setInfo(e,t,s),this.requestRender()}async getMaterialItems(t,s){if(!t||0===t.length)return[];const i=e();return this._materialItemsRequestQueue.push({items:t,abortOptions:s,resolver:i}),this.requestRender(),i.promise}doRender(e){if(e.context.capabilities.enable("textureFloat"),e.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let t=this._materialItemsRequestQueue.pop();for(;t;)this._processMaterialItemRequest(e,t),t=this._materialItemsRequestQueue.pop()}super.doRender(e)}renderChildren(e){for(const t of this.children)t.commit(e);this._rendererInfo.update(e.state),super.renderChildren(e)}updateTransforms(e){if(this.children.some((e=>e.hasData)))for(const t of this.children)t.setTransform(e)}createRenderParams(e){const t=super.createRenderParams(e);return t.rendererInfo=this._rendererInfo,t.attributeView=this.attributeView,t}onAttributeStoreUpdate(){}_processMaterialItemRequest(e,{items:t,abortOptions:s,resolver:i}){const{painter:a,pixelRatio:r}=e,o=t.map((e=>a.textureManager.rasterizeItem(e.symbol,r,e.glyphIds,s)));Promise.all(o).then((e=>{if(!this.stage)return void i.reject();const s=e.map(((e,s)=>({id:t[s].id,mosaicItem:e})));i.resolve(s)}),i.reject)}}export{b as F};
