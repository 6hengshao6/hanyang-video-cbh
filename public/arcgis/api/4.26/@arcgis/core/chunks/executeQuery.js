/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../core/Error.js";import{h as r}from"./typedArrayUtil.js";import{i as o,a as e}from"./maybe.js";import{whenOrAbort as a}from"../core/promiseUtils.js";import{D as s}from"./DataLayerSource.js";import{a as n}from"./executeQueryJSON.js";import{e as i}from"./executeQueryPBF.js";import f from"../rest/support/FeatureSet.js";import c from"../rest/support/Query.js";async function u(t,r,o,s){return m(t,r,o,s).then((t=>async function(t,r,o,s){const n=o?.infoFor3D;if(!p(t,n)||e(n)||!r.assetMaps||!r.features||!r.features.length)return f.fromJSON(r);const{meshFeatureSetFromJSON:i}=await a(import("./meshFeatureSet.js"),s);return i(t,n,r)}(r,t,o,s)))}async function m(a,f,u,m){const d={...m},y=function(r,a){let n=c.from(r);n.sourceSpatialReference=n.sourceSpatialReference??a?.sourceSpatialReference??null,(a?.gdbVersion||a?.dynamicDataSource)&&(n=n===r?n.clone():n,n.gdbVersion=r.gdbVersion||a.gdbVersion,n.dynamicDataSource=r.dynamicDataSource?s.from(r.dynamicDataSource):a.dynamicDataSource);const i=a?.infoFor3D;if(o(i)&&p(r,i)){n=n===r?n.clone():n,n.formatOf3DObjects=null;for(const t of i.queryFormats){if("3D_glb"===t){n.formatOf3DObjects=t;break}"3D_gltf"!==t||n.formatOf3DObjects||(n.formatOf3DObjects=t)}if(!n.formatOf3DObjects)throw new t("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(e(n.outFields)||!n.outFields.includes("*")){n=n===r?n.clone():n,e(n.outFields)&&(n.outFields=[]);const{originX:t,originY:o,originZ:a,translationX:s,translationY:f,translationZ:c,scaleX:u,scaleY:m,scaleZ:l,rotationX:p,rotationY:d,rotationZ:y,rotationDeg:D}=i.transformFieldRoles;n.outFields.push(t,o,a,s,f,c,u,m,l,p,d,y,D)}}return n}(f,u),D=null!=f.outStatistics?.[0],j=r("featurelayer-pbf-statistics"),b=!D||j;let S;if("pbf"===u?.format&&b)try{S=await i(a,y,d)}catch(t){if("query:parsing-pbf"!==t.name)throw t;u.format="json"}return"json"!==u?.format&&b||(S=await n(a,y,d)),l(u?.fieldsIndex,S.fields),S}function l(t,r){if(o(t)&&o(r))for(const o of r){const r=t.get(o.name);r&&Object.assign(o,r.toJSON())}}function p(t,r){return o(r)&&!0===t.returnGeometry&&"xyFootprint"!==t.multipatchOption&&!t.outStatistics}export{m as a,u as e,l as n};
