/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{L as t}from"./Logger.js";import{a as o,l as r,i as n}from"./maybe.js";import{i as s,a as u}from"./aaBoundingBox.js";import{f as c}from"./aaBoundingRect.js";import{isPoint as i,isPolygon as l,isPolyline as a,isMultipoint as f}from"../geometry/support/jsonUtils.js";import{O as d,a as h}from"./OptimizedFeature.js";import{O as m}from"./OptimizedFeatureSet.js";function g(e,t){return e?t?4:3:t?3:2}const y=t.getLogger("esri.layers.graphics.featureConversionUtils"),p={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},b=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s},w=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s,e[o+2]=t[r+2]},I=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s,e[o+2]=t[r+3]},M=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s,e[o+2]=t[r+2],e[o+3]=t[r+3]};function G(e,t,o,r){if(e){if(o)return t&&r?M:w;if(t&&r)return I}else if(t&&r)return w;return b}function T({scale:e,translate:t},o){return Math.round((o-t[0])/e[0])}function N({scale:e,translate:t},o){return Math.round((t[1]-o)/e[1])}function P({scale:e,translate:t},o,r){return o*e[r]+t[r]}function F(e,t,o){return e?t?o?L(e):Z(e):o?v(e):j(e):null}function j(e){const t=e.coords;return{x:t[0],y:t[1]}}function x(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function Z(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function k(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function v(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function L(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function E(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function U(e,t){return e&&t?E:e?k:t?z:x}function q(e,t,o,r,s){const u=U(o,r);for(const{geometry:o,attributes:r}of t){const t=n(o)?u(new d,o):null;e.push(new h(t,r,null,s?r[s]:void 0))}return e}function O(e,t,o=U(null!=t.z,null!=t.m)){return o(e,t)}function S(e,t,r){if(o(e))return null;const n=g(t,r),s=[];for(let t=0;t<e.coords.length;t+=n){const o=[];for(let r=0;r<n;r++)o.push(e.coords[t+r]);s.push(o)}return t?r?{points:s,hasZ:t,hasM:r}:{points:s,hasZ:t}:r?{points:s,hasM:r}:{points:s}}function A(e,t,o,r,s){const u=g(o,r);for(const{geometry:o,attributes:r}of t){const t=n(o)?R(new d,o,u):null;e.push(new h(t,r,null,s?r[s]:void 0))}return e}function R(e,t,o=g(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const r=e.coords;let n=0;for(const e of t.points)for(let t=0;t<o;t++)r[n++]=e[t];return e}function $(e,t,o){if(!e)return null;const r=g(t,o),{coords:n,lengths:s}=e,u=[];let c=0;for(const e of s){const t=[];for(let o=0;o<e;o++){const e=[];for(let t=0;t<r;t++)e.push(n[c++]);t.push(e)}u.push(t)}return t?o?{paths:u,hasZ:t,hasM:o}:{paths:u,hasZ:t}:o?{paths:u,hasM:o}:{paths:u}}function V(e,t,o,r,s){const u=g(o,r);for(const{geometry:o,attributes:r}of t){const t=n(o)?Y(new d,o,u):null;e.push(new h(t,r,null,s?r[s]:void 0))}return e}function Y(e,t,o=g(t.hasZ,t.hasM)){const{lengths:r,coords:n}=e;let s=0;for(const e of t.paths){for(const t of e)for(let e=0;e<o;e++)n[s++]=t[e];r.push(e.length)}return e}function _(e,t,o){if(!e)return null;const r=g(t,o),{coords:n,lengths:s}=e,u=[];let c=0;for(const e of s){const t=[];for(let o=0;o<e;o++){const e=[];for(let t=0;t<r;t++)e.push(n[c++]);t.push(e)}u.push(t)}return t?o?{rings:u,hasZ:t,hasM:o}:{rings:u,hasZ:t}:o?{rings:u,hasM:o}:{rings:u}}function B(e,t,o,r,s){for(const{geometry:u,centroid:c,attributes:i}of t){const t=n(u)?C(new d,u,o,r):null,l=s?i[s]:void 0;n(c)?e.push(new h(t,i,x(new d,c),l)):e.push(new h(t,i,null,l))}return e}function C(e,t,o=t.hasZ,r=t.hasM){return D(e,t.rings,o,r),e}function D(e,t,o,r){const n=g(o,r),{lengths:s,coords:u}=e;let c=0;pe(e);for(const e of t){for(const t of e)for(let e=0;e<n;e++)u[c++]=t[e];s.push(e.length)}return e}const H=[],J=[];function K(e,t,o,r,n){H[0]=e;const[s]=Q(J,H,t,o,r,n);return be(H),be(J),s}function Q(t,o,r,n,s,u){if(be(t),!r){for(const e of o){const o=u?e.attributes[u]:void 0;t.push(new h(null,e.attributes,null,o))}return t}switch(r){case"esriGeometryPoint":return q(t,o,n,s,u);case"esriGeometryMultipoint":return A(t,o,n,s,u);case"esriGeometryPolyline":return V(t,o,n,s,u);case"esriGeometryPolygon":return B(t,o,n,s,u);default:y.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${r}'`)),be(t)}return t}function W(t,o,r,n,s,u){const c=t.length;switch(r){case"esriGeometryPoint":q(t,o,n,s,u);break;case"esriGeometryMultipoint":A(t,o,n,s,u);break;case"esriGeometryPolyline":V(t,o,n,s,u);break;case"esriGeometryPolygon":B(t,o,n,s,u);break;default:y.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${r}'`))}for(let e=0;e<o.length;e++)t[e+c].geometryType=r,t[e+c].insertAfter=o[e].insertAfter,t[e+c].groupId=o[e].groupId;return t}function X(e,t,o,r){J[0]=e,oe(H,J,t,o,r);const n=H[0];return be(H),be(J),n}function ee(t,r,n){if(o(t))return null;const s=new d;return"hasZ"in t&&null==r&&(r=t.hasZ),"hasM"in t&&null==n&&(n=t.hasM),i(t)?U(null!=r?r:null!=t.z,null!=n?n:null!=t.m)(s,t):l(t)?C(s,t,r,n):a(t)?Y(s,t,g(r,n)):f(t)?R(s,t,g(r,n)):void y.error("convertFromGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${t}'`))}function te(t,r,n,s){const u=t&&("coords"in t?t:t.geometry);if(o(u))return null;switch(r){case"esriGeometryPoint":{let e=j;return n&&s?e=L:n?e=Z:s&&(e=v),e(u)}case"esriGeometryMultipoint":return S(u,n,s);case"esriGeometryPolyline":return $(u,n,s);case"esriGeometryPolygon":return _(u,n,s);default:return y.error("convertToGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${r}'`)),null}}function oe(t,r,s,u,c){if(be(t),o(s))return function(e,t){for(const o of t)e.push({attributes:o.attributes});return e}(t,r);switch(s){case"esriGeometryPoint":return function(e,t,o,r){let s=j;o&&r?s=L:o?s=Z:r&&(s=v);for(const o of t){const{geometry:t,attributes:r}=o,u=n(t)?s(t):null;e.push({attributes:r,geometry:u})}return e}(t,r,u,c);case"esriGeometryMultipoint":return function(e,t,o,r){for(const{geometry:s,attributes:u}of t)e.push({attributes:u,geometry:n(s)?S(s,o,r):null});return e}(t,r,u,c);case"esriGeometryPolyline":return function(e,t,o,r){for(const{geometry:s,attributes:u}of t)e.push({attributes:u,geometry:n(s)?$(s,o,r):null});return e}(t,r,u,c);case"esriGeometryPolygon":return function(e,t,o,r){for(const{geometry:s,attributes:u,centroid:c}of t){const t=n(s)?_(s,o,r):null;if(n(c)){const o=j(c);e.push({attributes:u,centroid:o,geometry:t})}else e.push({attributes:u,geometry:t})}return e}(t,r,u,c);default:y.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${s}'`))}return t}function re(e){const{objectIdFieldName:t,spatialReference:o,transform:r,fields:n,hasM:s,hasZ:u,features:c,geometryType:i,exceededTransferLimit:l,uniqueIdField:a,queryGeometry:f,queryGeometryType:d}=e,h={features:oe([],c,i,u,s),fields:n,geometryType:i,objectIdFieldName:t,spatialReference:o,uniqueIdField:a,queryGeometry:te(f,d,!1,!1)};return r&&(h.transform=r),l&&(h.exceededTransferLimit=l),s&&(h.hasM=s),u&&(h.hasZ=u),h}function ne(t,o){const r=new m,{hasM:n,hasZ:s,features:u,objectIdFieldName:c,spatialReference:i,geometryType:l,exceededTransferLimit:a,transform:f,fields:d}=t;return d&&(r.fields=d),r.geometryType=l??null,r.objectIdFieldName=c??o??null,r.spatialReference=i??null,r.objectIdFieldName?(u&&Q(r.features,u,l,s,n,r.objectIdFieldName),a&&(r.exceededTransferLimit=a),n&&(r.hasM=n),s&&(r.hasZ=s),f&&(r.transform=f),r):(y.error(new e("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),r)}function se(e){const{transform:t,features:o,hasM:r,hasZ:s}=e;if(!t)return e;for(const e of o)n(e.geometry)&&de(e.geometry,e.geometry,r,s,t),n(e.centroid)&&de(e.centroid,e.centroid,r,s,t);return e.transform=null,e}function ue(e,t){const{geometryType:o,features:r,hasM:n,hasZ:s}=t;if(!e)return t;for(let t=0;t<r.length;t++){const u=r[t],c=u.weakClone();c.geometry=new d,ce(c.geometry,u.geometry,n,s,o,e),u.centroid&&(c.centroid=new d,ce(c.centroid,u.centroid,n,s,"esriGeometryPoint",e)),r[t]=c}return t.transform=e,t}function ce(e,t,r,n,s,u,c=r,i=n){if(pe(e),o(t)||!t.coords.length)return null;const l=p[s],{coords:a,lengths:f}=t,d=g(r,n),h=g(r&&c,n&&i),m=G(r,n,c,i);if(!f.length)return m(e.coords,a,0,0,T(u,a[0]),N(u,a[1])),pe(e,d,0),e;let y,b,w,I,M=0,P=0,F=P;for(const t of f){if(t<l)continue;let o=0;P=F,w=y=T(u,a[M]),I=b=N(u,a[M+1]),m(e.coords,a,P,M,w,I),o++,M+=d,P+=h;for(let r=1;r<t;r++,M+=d)w=T(u,a[M]),I=N(u,a[M+1]),w===y&&I===b||(m(e.coords,a,P,M,w-y,I-b),P+=h,o++,y=w,b=I);o>=l&&(e.lengths.push(o),F=P)}return be(e.coords,F),e.coords.length?e:null}function ie(e,t,o,r,n,s,u=o,c=r){if(pe(e),!t||!t.coords.length)return null;const i=p[n],{coords:l,lengths:a}=t,f=g(o,r),d=g(o&&u,r&&c),h=G(o,r,u,c);if(!a.length)return h(e.coords,l,0,0,l[0],l[1]),pe(e,f,0),e;let m=0;const y=s*s;for(const t of a){if(t<i){m+=t*f;continue}const o=e.coords.length/d,r=m,n=m+(t-1)*f;h(e.coords,l,e.coords.length,r,l[r],l[r+1]),ae(e.coords,l,f,y,h,r,n),h(e.coords,l,e.coords.length,n,l[n],l[n+1]);const s=e.coords.length/d-o;s>=i?e.lengths.push(s):be(e.coords,o*d),m+=t*f}return e.coords.length?e:null}function le(e,t,o,r){const n=e[t],s=e[t+1],u=e[o],c=e[o+1],i=e[r],l=e[r+1];let a=u,f=c,d=i-a,h=l-f;if(0!==d||0!==h){const e=((n-a)*d+(s-f)*h)/(d*d+h*h);e>1?(a=i,f=l):e>0&&(a+=d*e,f+=h*e)}return d=n-a,h=s-f,d*d+h*h}function ae(e,t,o,r,n,s,u){let c,i=r,l=0;for(let e=s+o;e<u;e+=o)c=le(t,e,s,u),c>i&&(l=e,i=c);i>r&&(l-s>o&&ae(e,t,o,r,n,s,l),n(e,t,e.length,l,t[l],t[l+1]),u-l>o&&ae(e,t,o,r,n,l,u))}function fe(e,t,r,n){if(o(t)||!t.coords||!t.coords.length)return null;const i=g(r,n);let l=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,d=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=i){const o=e[t],r=e[t+1];l=Math.min(l,o),f=Math.max(f,o),a=Math.min(a,r),d=Math.max(d,r)}}return s(e)?u(e,l,a,f,d):c(l,a,f,d,e),e}function de(e,t,o,n,s){const{coords:u,lengths:c}=t,i=g(o,n);if(!u.length)return e!==t&&pe(e),e;r(s);const{originPosition:l,scale:a,translate:f}=s,d=we;d.originPosition=l;const h=d.scale;h[0]=a[0]??1,h[1]=-(a[1]??1),h[2]=a[2]??1,h[3]=a[3]??1;const m=d.translate;if(m[0]=f[0]??0,m[1]=f[1]??0,m[2]=f[2]??0,m[3]=f[3]??0,!c.length){for(let t=0;t<i;++t)e.coords[t]=P(d,u[t],t);return e!==t&&pe(e,i,0),e}let y=0;for(let t=0;t<c.length;t++){const o=c[t];e.lengths[t]=o;for(let t=0;t<i;++t)e.coords[y+t]=P(d,u[y+t],t);let r=e.coords[y],n=e.coords[y+1];y+=i;for(let t=1;t<o;t++,y+=i){r+=u[y]*h[0],n+=u[y+1]*h[1],e.coords[y]=r,e.coords[y+1]=n;for(let t=2;t<i;++t)e.coords[y+t]=P(d,u[y+t],t)}}return e!==t&&pe(e,u.length,c.length),e}function he(e,t,o,r,n,s){if(pe(e),e.lengths.push(...t.lengths),o===n&&r===s)for(let o=0;o<t.coords.length;o++)e.coords.push(t.coords[o]);else{const u=g(o,r),c=G(o,r,n,s),i=t.coords;for(let t=0;t<i.length;t+=u)c(e.coords,i,e.coords.length,t,i[t],i[t+1])}return e}function me(e,t,o,r){let n=0,s=e[r*t],u=e[r*(t+1)];for(let c=1;c<o;c++){const o=s+e[r*(t+c)],i=u+e[r*(t+c)+1],l=(o-s)*(i+u);s=o,u=i,n+=l}return.5*n}function ge(e,t){const{coords:o,lengths:r}=e;let n=0,s=0;for(let e=0;e<r.length;e++){const u=r[e];s+=me(o,n,u,t),n+=u}return Math.abs(s)}function ye(e,t){if(o(e))return null;const r=e.clone(),n=e.coords,s=e.lengths;let u=0;for(let e=0;e<s.length;e++){const o=s[e];let c=n[t*u],i=n[t*u+1];for(let e=1;e<o;e++){const o=c+n[t*(u+e)],s=i+n[t*(u+e)+1];r.coords[t*(u+e)]=o,r.coords[t*(u+e)+1]=s,c=o,i=s}u+=o}return r}function pe(e,t=0,o=0){be(e.lengths,o),be(e.coords,t)}function be(e,t=0){e.length!==t&&(e.length=t)}const we={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};export{ye as A,ie as a,F as b,ee as c,$ as d,_ as e,S as f,fe as g,C as h,te as i,re as j,D as k,se as l,ne as m,Q as n,X as o,K as p,ce as q,he as r,ue as s,T as t,de as u,N as v,O as w,ge as x,W as y,Y as z};
