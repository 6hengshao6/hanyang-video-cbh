/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{L as e}from"./Logger.js";import{c as t}from"./mathUtils.js";import{i as s,a as r}from"./maybe.js";import{b as i}from"./screenUtils.js";import{k as o}from"./vec2.js";import{s as a,b as n,m as l,g as p,a as u,c,l as h,D as f,e as d,d as m}from"./vec3.js";import{O as g}from"./vec4f64.js";import{P as S}from"./frustum.js";import{c as _,d as P,f as A,a as O}from"./lineSegment.js";import{c as T,d as v,s as E,n as b}from"./plane.js";import{B as j,d as y}from"./BufferView.js";import{S as N}from"./ShaderOutput.js";import{i as C,s as x,c as R,d as I,D as L,G as w,w as V}from"./DefaultBufferWriter.js";import{D as M,b as U,M as D}from"./Material.js";import{R as B}from"./RenderSlot.js";import{i as W}from"./Util2.js";import{V as q}from"./VertexAttribute.js";import{b as H,c as X}from"./TriangleMaterial.js";import{S as F,P as z,R as G}from"./Program2.js";import{N as k}from"./NativeLine.glsl.js";import{B as Q,d as Z}from"./enums3.js";import{s as J,m as K,a as Y,d as $}from"./renderState.js";import{_ as ee}from"./tslib.es6.js";import{p as te}from"./ShaderTechniqueConfiguration.js";import{D as se}from"./DefaultTechniqueConfiguration.js";class re extends F{get _stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==N.Highlight}initializeProgram(e){return new z(e.rctx,re.shader.get().build(this.configuration),M)}initializePipeline(){const e=this.configuration,t=J(Q.SRC_ALPHA,Q.ONE,Q.ONE_MINUS_SRC_ALPHA,Q.ONE_MINUS_SRC_ALPHA),s=(t,s=null,r=null)=>K({blending:s,depthTest:C,depthWrite:r,colorWrite:Y,stencilWrite:e.hasOccludees?x:null,stencilTest:e.hasOccludees?t?R:I:null});return e.output===N.Color?(this._occludeePipelineState=s(!0,e.transparent||this._stippleEnabled?t:null,$),s(!1,e.transparent||this._stippleEnabled?t:null,$)):s(!1)}get primitiveType(){return Z.LINES}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}re.shader=new G(k,(()=>import("./NativeLine.glsl.js").then((e=>e.N))));class ie extends se{constructor(){super(...arguments),this.output=N.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}}var oe;ee([te({count:N.COUNT})],ie.prototype,"output",void 0),ee([te()],ie.prototype,"hasSlicePlane",void 0),ee([te()],ie.prototype,"hasVertexColors",void 0),ee([te()],ie.prototype,"transparent",void 0),ee([te()],ie.prototype,"draped",void 0),ee([te()],ie.prototype,"stippleEnabled",void 0),ee([te()],ie.prototype,"stippleOffColorEnabled",void 0),ee([te()],ie.prototype,"stipplePreferContinuous",void 0),ee([te()],ie.prototype,"hasOccludees",void 0),ee([te({constValue:!1})],ie.prototype,"stippleRequiresClamp",void 0),ee([te({constValue:!1})],ie.prototype,"stippleScaleWithLineWidth",void 0),ee([te({constValue:!1})],ie.prototype,"stippleRequiresStretchMeasure",void 0),function(e){e[e.START=0]="START",e[e.END=1]="END"}(oe||(oe={}));class ae extends U{constructor(e){super(e,new pe),this._configuration=new ie}getConfiguration(e,t){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=t.slot===B.DRAPED_MATERIAL;const r=s(this.parameters.stipplePattern);return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&s(this.parameters.stippleOffColor),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}intersect(t,s,r,i,d,m){if(!r.options.selectionMode||!t.visible)return;if(!W(s))return void e.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const g=t.vertexAttributes.get(q.POSITION).data,_=r.camera,T=Ae;o(T,r.point),a(Oe[0],T[0]-2,T[1]+2,0),a(Oe[1],T[0]+2,T[1]+2,0),a(Oe[2],T[0]+2,T[1]-2,0),a(Oe[3],T[0]-2,T[1]-2,0);for(let e=0;e<4;e++)if(!_.unprojectFromRenderScreen(Oe[e],Te[e]))return;v(_.eye,Te[0],Te[1],ve),v(_.eye,Te[1],Te[2],Ee),v(_.eye,Te[2],Te[3],be),v(_.eye,Te[3],Te[0],je);let j=Number.MAX_VALUE,y=0;for(let e=0;e<g.length-5;e+=3){if(ue[0]=g[e]+s[12],ue[1]=g[e+1]+s[13],ue[2]=g[e+2]+s[14],ce[0]=g[e+3]+s[12],ce[1]=g[e+4]+s[13],ce[2]=g[e+5]+s[14],E(ve,ue)<0&&E(ve,ce)<0||E(Ee,ue)<0&&E(Ee,ce)<0||E(be,ue)<0&&E(be,ce)<0||E(je,ue)<0&&E(je,ce)<0)continue;if(_.projectToRenderScreen(ue,de),_.projectToRenderScreen(ce,me),de[2]<0&&me[2]>0){n(he,ue,ce);const e=_.frustum,t=-E(e[S.NEAR],ue)/l(he,b(e[S.NEAR]));p(he,he,t),u(ue,ue,he),_.projectToRenderScreen(ue,de)}else if(de[2]>0&&me[2]<0){n(he,ce,ue);const e=_.frustum,t=-E(e[S.NEAR],ce)/l(he,b(e[S.NEAR]));p(he,he,t),u(ce,ce,he),_.projectToRenderScreen(ce,me)}else if(de[2]<0&&me[2]<0)continue;de[2]=0,me[2]=0;const t=P(A(de,me,_e),T);t<j&&(j=t,c(ge,ue),c(Se,ce),y=e/3)}const N=r.rayBegin,C=r.rayEnd;if(j<4){let e=Number.MAX_VALUE;if(O(A(ge,Se,_e),A(N,C,Pe),fe)){n(fe,fe,N);const t=h(fe);p(fe,fe,1/t),e=t/f(N,C)}m(e,fe,y,!1)}}intersectDraped(e,s,r,i,o,a){if(!r.options.selectionMode)return;const n=e.vertexAttributes.get(q.POSITION).data,l=e.vertexAttributes.get(q.SIZE),p=l?l.data[0]:0,u=i[0],c=i[1],h=((p+1)/2+4)*e.screenToWorldRatio;let f=Number.MAX_VALUE,d=0;for(let e=0;e<n.length-5;e+=3){const s=n[e],r=n[e+1],i=u-s,o=c-r,a=n[e+3]-s,l=n[e+4]-r,p=t((a*i+l*o)/(a*a+l*l),0,1),h=a*p-i,m=l*p-o,g=h*h+m*m;g<f&&(f=g,d=e/3)}f<h*h&&o(a.dist,a.normal,d,!1)}requiresSlot(e,t){return!(t!==N.Color&&t!==N.Highlight&&t!==N.ObjectAndLayerIdColor||e!==B.OPAQUE_MATERIAL&&e!==B.DRAPED_MATERIAL)}createGLMaterial(e){return new ne(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?H:X;return r(this.parameters.stipplePattern)?new L(e):new le(e.clone().vec3f(q.AUXPOS1).vec2f(q.UV0))}}class ne extends w{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===N.Color&&this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(re,e)}}class le{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(q.POSITION).length}write(e,t,s,r,i){V(s,this.vertexBufferLayout,e,t,r,i),this._writeAuxpos1(e,s,r,i),this._writeUV0(e,s,r,i)}_writeAuxpos1(e,t,s,r){const i=s.getField(q.AUXPOS1,j),o=t.indices.get(q.POSITION),a=t.vertexAttributes.get(q.POSITION).data,n=e,l=i.typedBufferStride,p=i.typedBuffer;r*=l;for(let e=0;e<o.length-1;e+=2)for(const t of[1,0]){const s=3*o[e+t],i=a[s],u=a[s+1],c=a[s+2],h=n[0]*i+n[4]*u+n[8]*c+n[12],f=n[1]*i+n[5]*u+n[9]*c+n[13],d=n[2]*i+n[6]*u+n[10]*c+n[14];p[r]=h,p[r+1]=f,p[r+2]=d,r+=l}}_writeUV0(e,t,s,r){const i=s.getField(q.UV0,y),o=t.indices.get(q.POSITION),n=t.vertexAttributes.get(q.POSITION).data,l=t.vertexAttributes.get(q.DISTANCETOSTART)?.data,p=i.typedBufferStride,u=i.typedBuffer;let h=0;u[r*=p]=oe.START,u[r+1]=h,r+=p;const m=3*o[0],g=a(ue,n[m],n[m+1],n[m+2]);e&&d(g,g,e);const S=ce,_=o.length-1;let P=1;const A=l?(e,t,s)=>h=l[s]:(e,t,s)=>h+=f(e,t);for(let t=1;t<_;t+=2){const s=3*o[t];a(S,n[s],n[s+1],n[s+2]),e&&d(S,S,e),A(g,S,P++);for(let e=0;e<2;++e)u[r]=1-e,u[r+1]=h,r+=p;c(g,S)}const O=3*o[_];a(S,n[O],n[O+1],n[O+2]),e&&d(S,S,e),A(g,S,P),u[r]=oe.END,u[r+1]=h}}class pe extends D{constructor(){super(...arguments),this.color=g,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1,this.stippleTexture=null}}const ue=m(),ce=m(),he=m(),fe=m(),de=i(),me=i(),ge=m(),Se=m(),_e=_(),Pe=_(),Ae=m(),Oe=[i(),i(),i(),i()],Te=[m(),m(),m(),m()],ve=T(),Ee=T(),be=T(),je=T();export{ae as N};
