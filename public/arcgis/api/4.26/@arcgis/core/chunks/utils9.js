/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{J as e}from"./jsonMap.js";import{i as t,a as i}from"./maybe.js";import{f as r,e as n,c as s,b as a,W as o}from"./unitUtils.js";import{canProjectWithoutEngine as l}from"../geometry/projection.js";import{d as m}from"./extentUtils.js";import{fromJSON as f,isExtent as u,isPolygon as c,isPolyline as p}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as y}from"../geometry/support/normalizeUtils.js";import{a as g,q as S,r as R,b as w,d,e as h,f as j}from"./featureConversionUtils.js";import{O as x}from"./OptimizedFeature.js";import{c as U,p as O}from"./projectionSupport.js";const F=new e({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),M=Object.freeze({}),b=new x,N=new x,_=new x,J={esriGeometryPoint:w,esriGeometryPolyline:d,esriGeometryPolygon:h,esriGeometryMultipoint:j};function P(e,t,r,n=e.hasZ,s=e.hasM){if(i(t))return null;const a=e.hasZ&&n,o=e.hasM&&s;if(r){const i=S(_,t,e.hasZ,e.hasM,"esriGeometryPoint",r,n,s);return w(i,a,o)}return w(t,a,o)}function v(e,r,n,s,a,o,l=r,m=n){const f=r&&l,u=n&&m,c=t(s)?"coords"in s?s:s.geometry:null;if(i(c))return null;if(a){let t=g(N,c,r,n,e,a,l,m);return o&&(t=S(_,t,f,u,e,o)),J[e]?.(t,f,u)??null}if(o){const t=S(_,c,r,n,e,o,l,m);return J[e]?.(t,f,u)??null}return R(b,c,r,n,l,m),J[e]?.(b,f,u)??null}async function z(e,t,i){const{outFields:r,orderByFields:n,groupByFieldsForStatistics:s,outStatistics:a}=e;if(r)for(let e=0;e<r.length;e++)r[e]=r[e].trim();if(n)for(let e=0;e<n.length;e++)n[e]=n[e].trim();if(s)for(let e=0;e<s.length;e++)s[e]=s[e].trim();if(a)for(let e=0;e<a.length;e++)a[e].onStatisticField&&(a[e].onStatisticField=a[e].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),G(e,t,i)}async function G(e,t,r){if(!e)return null;let{where:l}=e;if(e.where=l=l&&l.trim(),(!l||/^1 *= *1$/.test(l)||t&&t===l)&&(e.where=null),!e.geometry)return e;let c=await async function(e){const{distance:t,units:i}=e,r=e.geometry;if(null==t||"vertexAttributes"in r)return r;const l=r.spatialReference,m=i?F.fromJSON(i):n(l),f=l&&(s(l)||a(l))?r:await U(l,o).then((()=>O(r,o)));return(await async function(){return(await import("./geometryEngineJSON.js").then((e=>e.g))).geodesicBuffer}())(f.spatialReference,f,t,m)}(e);if(e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel){const{spatialReference:t}=e.geometry;c=m(c),c.spatialReference=t}if(c){await U(c.spatialReference,r),c=function(e,t){const i=e.spatialReference;return q(e,t)&&u(e)?{spatialReference:i,rings:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]}:e}(c,r);const t=(await y(f(c)))[0];if(i(t))throw M;const n="quantizationParameters"in e&&e.quantizationParameters?.tolerance||"maxAllowableOffset"in e&&e.maxAllowableOffset||0,s=n&&q(c,r)?{densificationStep:8*n}:void 0,a=t.toJSON(),o=await O(a,a.spatialReference,r,s);if(!o)throw M;o.spatialReference=r,e.geometry=o}return e}function q(e,t){if(!e)return!1;const i=e.spatialReference;return(u(e)||c(e)||p(e))&&!r(i,t)&&!l(i,t)}function A(e){return e&&B in e?JSON.parse(JSON.stringify(e,Z)):e}const B="_geVersion",Z=(e,t)=>e!==B?t:void 0;export{M as Q,G as a,A as c,v as g,z as n,P as t};
