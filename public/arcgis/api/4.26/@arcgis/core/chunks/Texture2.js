/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{n as e}from"./compilerUtils.js";import t from"../core/Error.js";import r from"../core/Evented.js";import{i as a,n as s}from"./mathUtils.js";import{a as i,c as o,i as n,r as l}from"./maybe.js";import{throwIfAborted as h,onAbort as m,createAbortError as _}from"../core/promiseUtils.js";import{t as d,a as p}from"./typedArrayUtil.js";import{isBlobProtocol as c,isDataProtocol as u}from"../core/urlUtils.js";import{r as T}from"./requestImageUtils.js";import{l as g}from"../request.js";import{T as A}from"./TextureOnly.glsl.js";import{P as E,T as f}from"./basicInterfaces.js";import{g as R}from"./assets.js";import{C as w,P as C,c as B,b as D,T as G,a as M,g as x,h as I,d as y}from"./enums3.js";import{T as S}from"./Texture.js";import{g as F,F as P,v as O}from"./FramebufferObject.js";import{a as U,C as N}from"./Material.js";import{L}from"./Logger.js";import{c as v}from"./glUtil3D.js";import{a as b}from"./Util2.js";import{C as H}from"./context-util.js";let V;var j;!function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"}(j||(j={}));let X=null,k=null;async function q(){return i(k)&&(k=function(){if(i(V)){const e=e=>R(`esri/libs/basisu/${e}`);V=import("./basis_transcoder.js").then((e=>e.b)).then((({default:t})=>t({locateFile:e}).then((e=>(e.initializeBasis(),delete e.then,e)))))}return V}(),X=await k),k}function z(e,t,r,a,s){const i=F(t?w.COMPRESSED_RGBA8_ETC2_EAC:w.COMPRESSED_RGB8_ETC2),o=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(r*a*i*o)}function W(e){return e.getNumImages()>=1&&!e.isUASTC()}function K(e){return e.getFaces()>=1&&e.isETC1S()}function Y(e,t,r,a,s,i,o,n){const{compressedTextureETC:l,compressedTextureS3TC:h}=e.capabilities,[m,_]=l?a?[j.ETC2_RGBA,w.COMPRESSED_RGBA8_ETC2_EAC]:[j.ETC1_RGB,w.COMPRESSED_RGB8_ETC2]:h?a?[j.BC3_RGBA,w.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[j.BC1_RGB,w.COMPRESSED_RGB_S3TC_DXT1_EXT]:[j.RGBA32,C.RGBA],d=t.hasMipmap?r:Math.min(1,r),p=[];for(let e=0;e<d;e++)p.push(new Uint8Array(o(e,m))),n(e,m,p[e]);const c=p.length>1,u=c?B.LINEAR_MIPMAP_LINEAR:B.LINEAR,T={...t,samplingMode:u,hasMipmap:c,internalFormat:_,width:s,height:i};return new S(e,T,{type:"compressed",levels:p})}const $=L.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil");function J(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Q=J("DXT1"),Z=J("DXT3"),ee=J("DXT5");class te extends U{constructor(e,t){super(),this._data=e,this.type=N.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new r,this._passParameters=new A,this.params=t||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:D.REPEAT,t:D.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||E.STRETCH,this.estimatedTexMemRequired=te._estimateTexMemRequired(this._data,this.params),this._startPreload()}_startPreload(){const e=this._data;i(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(c(e.src)||"auto"===e.preload&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const t=!e.paused;if(e.src=e.src,t&&e.autoplay){const t=()=>{e.removeEventListener("canplay",t),e.play()};e.addEventListener("canplay",t)}}}_startPreloadImageElement(e){u(e.src)||c(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static _getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static _estimateTexMemRequired(e,t){if(i(e))return 0;if(d(e)||p(e))return t.encoding===f.KTX2_ENCODING?function(e,t){if(i(X))return e.byteLength;const r=new X.KTX2File(new Uint8Array(e)),a=K(r)?z(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),t):0;return r.close(),r.delete(),a}(e,!!t.mipmap):t.encoding===f.BASIS_ENCODING?function(e,t){if(i(X))return e.byteLength;const r=new X.BasisFile(new Uint8Array(e)),a=W(r)?z(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),t):0;return r.close(),r.delete(),a}(e,!!t.mipmap):e.byteLength;const{width:r,height:a}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?te._getDataDimensions(e):t;return(t.mipmap?4/3:1)*r*a*(t.components||4)||0}dispose(){this._data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(e){return{target:G.TEXTURE_2D,pixelFormat:C.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?B.LINEAR_MIPMAP_LINEAR:B.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?e.parameters.maxMaxAnisotropy:1)}}get glTexture(){return this._glTexture}load(e,t){if(n(this._glTexture))return this._glTexture;if(n(this._loadingPromise))return this._loadingPromise;const r=this._data;return i(r)?(this._glTexture=new S(e,this._createDescriptor(e),null),this._glTexture):"string"==typeof r?this._loadFromURL(e,t,r):r instanceof Image?this._loadFromImageElement(e,t,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(e,t,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(e,r,t):(d(r)||p(r))&&this.params.encoding===f.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,r)):(d(r)||p(r))&&this.params.encoding===f.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,r)):(d(r)||p(r))&&this.params.encoding===f.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,r)):p(r)?this._loadFromPixelData(e,r):d(r)?this._loadFromPixelData(e,new Uint8Array(r)):null}get requiresFrameUpdates(){return this._data instanceof HTMLVideoElement}frameUpdate(e,t,r){if(!(this._data instanceof HTMLVideoElement)||i(this._glTexture))return r;if(this._data.readyState<re.HAVE_CURRENT_DATA||r===this._data.currentTime)return r;if(n(this._powerOfTwoStretchInfo)){const{framebuffer:r,vao:a,sourceTexture:s}=this._powerOfTwoStretchInfo;s.setData(this._data),this._drawStretchedTexture(e,t,r,a,s,this._glTexture)}else{const{videoWidth:e,videoHeight:t}=this._data,{width:r,height:a}=this._glTexture.descriptor;e!==r||t!==a?this._glTexture.updateData(0,0,0,Math.min(e,r),Math.min(t,a),this._data):this._glTexture.setData(this._data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this._data.currentTime}_loadFromDDSData(e,t){return this._glTexture=function(e,t,r){const{textureData:s,internalFormat:i,width:n,height:l}=o(function(e,t){const r=new Int32Array(e,0,31);if(542327876!==r[0])return $.error("Invalid magic number in DDS header"),null;if(!(4&r[20]))return $.error("Unsupported format, must contain a FourCC code"),null;const s=r[21];let i,o;switch(s){case Q:i=8,o=w.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Z:i=16,o=w.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case ee:i=16,o=w.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return $.error("Unsupported FourCC code:",(n=s,String.fromCharCode(255&n,n>>8&255,n>>16&255,n>>24&255))),null}var n;let l=1,h=r[4],m=r[3];0==(3&h)&&0==(3&m)||($.warn("Rounding up compressed texture size to nearest multiple of 4."),h=h+3&-4,m=m+3&-4);const _=h,d=m;131072&r[2]&&!1!==t&&(l=Math.max(1,r[7])),1===l||a(h)&&a(m)||($.warn("Ignoring mipmaps of non power of two sized compressed texture."),l=1);let p,c,u=r[1]+4;const T=[];for(let t=0;t<l;++t)c=(h+3>>2)*(m+3>>2)*i,p=new Uint8Array(e,u,c),T.push(p),u+=c,h=Math.max(1,h>>1),m=Math.max(1,m>>1);return{textureData:{type:"compressed",levels:T},internalFormat:o,width:_,height:d}}(r,t.hasMipmap??!1));return t.samplingMode=s.levels.length>1?B.LINEAR_MIPMAP_LINEAR:B.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=i,t.width=n,t.height=l,new S(e,t,s)}(e,this._createDescriptor(e),t),this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>async function(e,t,r){i(X)&&(X=await q());const a=new X.KTX2File(new Uint8Array(r));if(!K(a))return null;a.startTranscoding();const s=Y(e,t,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),((e,t)=>a.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,r)=>a.transcodeImage(r,e,0,0,t,0,-1,-1)));return a.close(),a.delete(),s}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>async function(e,t,r){i(X)&&(X=await q());const a=new X.BasisFile(new Uint8Array(r));if(!W(a))return null;a.startTranscoding();const s=Y(e,t,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),((e,t)=>a.getImageTranscodedSizeInBytes(0,e,t)),((e,t,r)=>a.transcodeImage(r,0,e,t,0,0)));return a.close(),a.delete(),s}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){b(this.params.width>0&&this.params.height>0);const r=this._createDescriptor(e);return r.pixelFormat=1===this.params.components?C.LUMINANCE:3===this.params.components?C.RGB:C.RGBA,r.width=this.params.width,r.height=this.params.height,this._glTexture=new S(e,r,t),this._glTexture}_loadFromURL(e,t,r){return this._loadAsync((async a=>{const s=await T(r,{signal:a});return h(a),this._loadFromImage(e,s,t)}))}_loadFromImageElement(e,t,r){return r.complete?this._loadFromImage(e,r,t):this._loadAsync((async a=>{const s=await g(r,r.src,!1,a);return h(a),this._loadFromImage(e,s,t)}))}_loadFromVideoElement(e,t,r){return r.readyState>=re.HAVE_CURRENT_DATA?this._loadFromImage(e,r,t):this._loadFromVideoElementAsync(e,t,r)}_loadFromVideoElementAsync(e,r,a){return this._loadAsync((s=>new Promise(((i,o)=>{const n=()=>{a.removeEventListener("loadeddata",h),a.removeEventListener("error",d),l(p)},h=()=>{a.readyState>=re.HAVE_CURRENT_DATA&&(n(),i(this._loadFromImage(e,a,r)))},d=e=>{n(),o(e||new t("Failed to load video"))};a.addEventListener("loadeddata",h),a.addEventListener("error",d);const p=m(s,(()=>d(_())))}))))}_loadFromImage(e,t,r){const s=te._getDataDimensions(t);this.params.width=s.width,this.params.height=s.height;const i=this._createDescriptor(e);return i.pixelFormat=3===this.params.components?C.RGB:C.RGBA,!this._requiresPowerOfTwo(e,i)||a(s.width)&&a(s.height)?(i.width=s.width,i.height=s.height,this._glTexture=new S(e,i,t),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,t,s,i,r),this._glTexture)}_loadAsync(e){const t=new AbortController;this._loadingController=t;const r=e(t.signal);this._loadingPromise=r;const a=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(a,a),r}_requiresPowerOfTwo(e,t){const r=D.CLAMP_TO_EDGE,a="number"==typeof t.wrapMode?t.wrapMode===r:t.wrapMode.s===r&&t.wrapMode.t===r;return e.type===H.WEBGL1&&(t.hasMipmap||!a)}_makePowerOfTwoTexture(t,r,a,i,o){const{width:n,height:l}=a,h=s(n),m=s(l);let _;switch(i.width=h,i.height=m,this.params.powerOfTwoResizeMode){case E.PAD:i.textureCoordinateScaleFactor=[n/h,l/m],_=new S(t,i),_.updateData(0,0,0,n,l,r);break;case E.STRETCH:case null:case void 0:_=this._stretchToPowerOfTwo(t,r,i,o());break;default:e(this.params.powerOfTwoResizeMode)}return i.hasMipmap&&_.generateMipmap(),_}_stretchToPowerOfTwo(e,t,r,a){const s=new S(e,r),i=new P(e,{colorTarget:x.TEXTURE,depthStencilTarget:I.NONE},s),o=new S(e,{target:G.TEXTURE_2D,pixelFormat:r.pixelFormat,dataType:M.UNSIGNED_BYTE,wrapMode:D.CLAMP_TO_EDGE,samplingMode:B.LINEAR,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},t),n=v(e),l=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,a,i,n,o,s),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:n,sourceTexture:o,framebuffer:i}:(n.dispose(!0),o.dispose(),i.detachColorTexture(),i.dispose()),e.bindFramebuffer(l),s}_drawStretchedTexture(e,t,r,a,s,i){this._passParameters.texture=s,e.bindFramebuffer(r);const o=e.getViewport();e.setViewport(0,0,i.descriptor.width,i.descriptor.height),e.bindTechnique(t,this._passParameters,null),e.bindVAO(a),e.drawArrays(y.TRIANGLE_STRIP,0,O(a,"geometry")),e.bindFramebuffer(null),e.setViewport(o.x,o.y,o.width,o.height),this._passParameters.texture=null}unload(){if(n(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:r}=this._powerOfTwoStretchInfo;t.dispose(!0),r.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(n(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),n(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}var re;!function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(re||(re={}));export{te as T,q as l};
