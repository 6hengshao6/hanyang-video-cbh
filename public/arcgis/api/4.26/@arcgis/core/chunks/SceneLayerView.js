/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{clone as e}from"../core/lang.js";import{i as t,a as r,e as n}from"./maybe.js";import{a as i}from"./FeatureLikeLayerView3D.js";import{fixFields as s,unpackFieldNames as o,collectLabelingFields as a,collectFilterFields as l}from"../layers/support/fieldUtils.js";import{_ as d}from"./tslib.es6.js";import u from"../core/Accessor.js";import{L as c}from"./Logger.js";import{r as p}from"./tracking.js";import{property as y}from"../core/accessorSupport/decorators/property.js";import{subclass as f}from"../core/accessorSupport/decorators/subclass.js";import{S as m}from"./watch.js";import{HandleOwner as g}from"../core/HandleOwner.js";import"./ensureType.js";import"./typedArrayUtil.js";import{u as h,a as w,i as F}from"./DefinitionExpressionSceneLayerView.js";import{whenOnce as b}from"../core/reactiveUtils.js";import{project as E,canProjectWithoutEngine as I,isLoaded as x,load as _}from"../geometry/projection.js";import j from"../views/layers/LayerView.js";const A={setAttribute(){},rollback(){},commit(){}};var v;function U(t,n){const i=n.attributes[t.objectIdField],s=t.sessions.get(i);if(s)return s;const o=e(n.attributes),a=new Set;if(null==i)return A;const l=t.i3sOverrides.createInteractiveEditSession(i),d=new Map;let u=v.EDITING;const c={setAttribute(e,s){if(u!==v.EDITING)return;const o=t.fieldsIndex.get(e);if(r(o))return;const c=t.attributeStorageInfo.findIndex((e=>e.name===o.name));if(c<0)return;l.set(c,s);const p=t.attributeStorageInfo[c];let y=!1;a.add(e),t.forEachNode(((e,r)=>{const o=((e,t)=>{const r=d.get(e);if(null==r){const r=t.indexOf(i);return d.set(e,r),r}return r})(e,r);if(-1===o)return;const a=t.getAttributeData(e.index);if(a){const r=a[p.name];r&&(r[o]=s,t.setAttributeData(e.index,a,n),y=!0)}})),y&&t.clearMemCache()},rollback(){if(u===v.EDITING){for(const e of a)this.setAttribute(e,o[e]);l.rollback(),u=v.ROLLED_BACK,t.sessions.delete(i)}},commit(){u===v.EDITING&&(l.commit(),u=v.COMMITTED,t.sessions.delete(i))}};return t.sessions.set(i,c),c}function N(e,t){const r=[...t.addedFeatures,...t.updatedFeatures,...t.deletedFeatures];for(const t of r)t.objectId&&e.i3sOverrides.updateGeometry(t.objectId)}function S(e,r){const n=function(e,t){const r=t.edits.updateFeatures;if(!r||0===r.length)return new D;const n=function(e){const t=new Set;if(!e.updatedFeatures)return t;for(const r of e.updatedFeatures)null!=r.objectId&&null==r.error&&t.add(r.objectId);return t}(t),s=new D,o=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)o.set(e.attributeStorageInfo[t].name,t);const a=e.fieldsIndex,l=e.objectIdField,d=r.filter((e=>{const t=i(a,e.attributes,l);return n.has(t)}));return e.forEachNode(((t,r)=>{const n=new Set(r);for(const o of d){const d=i(a,o.attributes,l);if(!n.has(d))continue;const u=r.indexOf(d);for(const r in o.attributes){const n=e.fieldsIndex.normalizeFieldName(r),i=O(s,t.index,n),a=o.attributes[r];i.push({featureIndex:u,featureId:d,value:a})}}})),s}(e,r);if(0===n.size)return;const s=new Map;for(let t=0;t<e.attributeStorageInfo.length;t++)s.set(e.attributeStorageInfo[t].name,t);let o=!1;n.forEach(((r,n)=>{const i=e.getAttributeData(n);let a=!1;r.forEach(((r,n)=>{const l=t(i)?i[n]:null,d=s.get(n);for(const{featureIndex:t,value:n,featureId:i}of r)l&&(l[t]=n,a=!0,o=!0),e.i3sOverrides.updateAttributeValue(i,d,n)})),a&&e.setAttributeData(n,i,null)})),o&&e.clearMemCache()}function O(e,t,r){const n=function(e,t){const r=e.get(t);if(r)return r;const n=new L;return e.set(t,n),n}(e,t),i=null!=r&&n.get(r);if(i)return i;const s=new Array;return n.set(r,s),s}!function(e){e[e.EDITING=0]="EDITING",e[e.ROLLED_BACK=1]="ROLLED_BACK",e[e.COMMITTED=2]="COMMITTED"}(v||(v={}));const L=Map,D=Map;function T(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:r}=this;return e.outFields?s(t,[...o(t,e.outFields),...r]):s(t,r)}}}}const M=e=>{let t=class extends e{constructor(){super(...arguments),this._numUpdating=0,this._asyncUpdateState=new Map}get updating(){return this._numUpdating>0}autoUpdateAsync(e,t){return function(e,t){const r=()=>{if(!n||i)return t();n.clear(),i=!0;const e=p(n,t);return i=!1,e};let n=new m((()=>{n&&!i&&e(r)})),i=!1;return e(r),{remove:()=>{n&&(n.destroy(),n=null)}}}((t=>this._updateAsync(e,t)),t)}async _updateAsync(e,t){if(!this._startAsyncUpdate(e)){try{const r=await t();this._set(e,r)}catch(t){c.getLogger(this.declaredClass).warn(`Async update of "${String(e)}" failed. Async update functions should not throw exceptions.`)}this._endAsyncUpdate(e)&&this._updateAsync(e,t)}}_startAsyncUpdate(e){const t=this._asyncUpdateState.get(e)??q.None;return t&q.Updating?(this._asyncUpdateState.set(e,t|q.Invalidated),!0):(++this._numUpdating,this._asyncUpdateState.set(e,t|q.Updating),!1)}_endAsyncUpdate(e){--this._numUpdating;const t=(this._asyncUpdateState.get(e)??q.None)&~q.Updating;return t&q.Invalidated?(this._asyncUpdateState.set(e,t&~q.Invalidated),!0):(this._asyncUpdateState.set(e,t),!1)}};return d([y({readOnly:!0})],t.prototype,"updating",null),d([y()],t.prototype,"_numUpdating",void 0),t=d([f("esri.core.AsyncUpdate")],t),t};var q;!function(e){e[e.None=0]="None",e[e.Updating=1]="Updating",e[e.Invalidated=2]="Invalidated"}(q||(q={}));let k=class extends(M(u)){};k=d([f("esri.core.AsyncUpdate")],k);const R="esri.views.3d.layers.support.SceneLayerViewRequiredFields";let V=class extends(M(g)){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:r,labelingFields:i,viewFilterFields:o}=this;return s(e,[...n(t,[]),...n(r,[]),...n(i,[]),...n(o,[])])}constructor(e){super(e)}initialize(){this.handles.add([this.autoUpdateAsync("rendererFields",(async()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?C((r=>t.collectRequiredFields(r,e))):null})),this.autoUpdateAsync("labelingFields",(async()=>{const{layer:e}=this;return e.labelsVisible?C((t=>a(t,e))):null})),this.autoUpdateAsync("viewFilterFields",(()=>{const{layer:e,filter:t}=this.layerView;return C((r=>l(r,e,t)))}))])}};async function C(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(e){return c.getLogger(R).error(e),null}}d([y()],V.prototype,"layerView",void 0),d([y()],V.prototype,"layer",null),d([y()],V.prototype,"requiredFields",null),d([y()],V.prototype,"rendererFields",void 0),d([y()],V.prototype,"labelingFields",void 0),d([y()],V.prototype,"viewFilterFields",void 0),V=d([f(R)],V);const P="esri.views.layers.SceneLayerView",G=c.getLogger(P);let z=class extends j{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryEngine=null,this._projectionEngineLoaded=!1}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return h(this._layerFilter)}get _layerFilter(){const e=this.layer.filter;if(r(e)||e.geometries.length<1)return null;const n=this._geometryEngine;if(r(n)||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return w;const i=e.geometries.getItemAt(0).spatialReference,s=e.geometries.toArray().map((e=>{try{e=n.simplify(e)}catch(e){return G.warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(null==e)return null;if(e.spatialReference.equals(i))return e;try{return E(e,i)}catch(e){return G.warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}})).filter(t).sort(((e,t)=>e.extent.xmin-t.extent.xmin)),o=new Set,a=new Array,l=new Array;for(let e of s){const t=e.extent.xmin;if(a.length=0,o.forEach((r=>{if(t>=r.extent.xmax)return l.push(r),void o.delete(r);e.extent.ymin<=r.extent.ymax&&e.extent.ymax>=r.extent.ymin&&n.intersects(e,r)&&a.push(r)})),a.length>0){a.push(e);try{e=n.union(a)}catch(e){G.warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}a.pop(),a.forEach((e=>o.delete(e)))}o.add(e)}return o.forEach((e=>l.push(e))),l.length>0?{spatialRelationship:e.spatialRelationship,geometries:l}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(r(e)||e.geometries.length<=1)return!1;const t=e.geometries.getItemAt(0).spatialReference;return e.geometries.some((({spatialReference:e})=>!e.equals(t)&&!I(e,t)))}get layerFilterUpdating(){return F(this._layerFilter)}initialize(){b((()=>!this._geometryEngine&&t(this.layer.filter)&&this.layer.filter.geometries.length)).then((async()=>this._geometryEngine=await import("../geometry/geometryEngine.js"))),this._projectionEngineLoaded=x(),b((()=>!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)).then((async()=>{await _(),this._projectionEngineLoaded=!0}))}destroy(){}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}};d([y()],z.prototype,"layer",void 0),d([y()],z.prototype,"availableFields",null),d([y()],z.prototype,"maximumNumberOfFeatures",null),d([y({readOnly:!0})],z.prototype,"maximumNumberOfFeaturesExceeded",null),d([y()],z.prototype,"filter",void 0),d([y({readOnly:!0})],z.prototype,"layerFilter",null),d([y({readOnly:!0})],z.prototype,"_layerFilter",null),d([y()],z.prototype,"_geometryEngine",void 0),d([y()],z.prototype,"_projectionEngineLoaded",void 0),d([y()],z.prototype,"_filterNeedsProjectionEngine",null),d([y()],z.prototype,"layerFilterUpdating",null),z=d([f(P)],z);const B=z;export{V as S,S as a,B as b,U as c,T as d,N as p};
