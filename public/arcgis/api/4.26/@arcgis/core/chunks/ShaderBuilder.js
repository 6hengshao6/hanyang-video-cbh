/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{i as e,a as r}from"./maybe.js";import t from"../core/Error.js";import{L as n}from"./Logger.js";var s;!function(e){e[e.Pass=0]="Pass",e[e.Draw=1]="Draw"}(s||(s={}));class i{constructor(r,t,n,i,o=null){this.name=r,this.type=t,this.arraySize=o,this.bind={[s.Pass]:null,[s.Draw]:null},e(n)&&e(i)&&(this.bind[n]=i)}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}}const o=n.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class a{constructor(){this._includedModules=new Map}include(e,r){if(this._includedModules.has(e)){const t=this._includedModules.get(e);if(t!==r){o.error("Trying to include shader module multiple times with different sets of options.");const r=new Set;for(const n of Object.keys(t))t[n]!==e[n]&&r.add(n);for(const n of Object.keys(e))t[n]!==e[n]&&r.add(n);r.forEach((r=>console.error(`  ${r}: current ${t[r]} new ${e[r]}`)))}}else this._includedModules.set(e,r),e(this.builder,r)}}class c extends a{constructor(){super(...arguments),this.vertex=new h,this.fragment=new h,this.attributes=new l,this.varyings=new d,this.extensions=new _,this.constants=new f}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){const r=this.extensions.generateSource(e),t=this.attributes.generateSource(e),n=this.varyings.generateSource(e),s="vertex"===e?this.vertex:this.fragment,i=s.uniforms.generateSource(),o=s.code.generateSource(),a="vertex"===e?g:S,c=this.constants.generateSource().concat(s.constants.generateSource());return`#version 300 es\n${r.join("\n")}\n\n${a}\n\n${c.join("\n")}\n\n${i.join("\n")}\n\n${t.join("\n")}\n\n${n.join("\n")}\n\n${o.join("\n")}`}generateBind(r,t){const n=new Map;this.vertex.uniforms.entries.forEach((t=>{const s=t.bind[r];e(s)&&n.set(t.name,s)})),this.fragment.uniforms.entries.forEach((t=>{const s=t.bind[r];e(s)&&n.set(t.name,s)}));const s=Array.from(n.values()),i=s.length;return(e,r,n)=>{for(let o=0;o<i;++o)s[o](t,e,r,n)}}}class u{constructor(){this._entries=new Map}add(e){if(!Array.isArray(e))return this._add(e);for(const r of e)this._add(r)}get(e){return this._entries.get(e)}_add(e){if(r(e))o.error(`Trying to add null Uniform from ${(new Error).stack}.`);else{if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new t(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}}generateSource(){return Array.from(this._entries.values()).map((r=>e(r.arraySize)?`uniform ${r.type} ${r.name}[${r.arraySize}];`:`uniform ${r.type} ${r.name};`))}get entries(){return Array.from(this._entries.values())}}class m{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}}class h extends a{constructor(){super(...arguments),this.uniforms=new u,this.code=new m,this.constants=new f}get builder(){return this}}class l{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(e){return"fragment"===e?[]:this._entries.map((e=>`in ${e[1]} ${e[0]};`))}}class d{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(e){return this._entries.map((r=>"vertex"===e?`out ${r[1]} ${r[0]};`:`in ${r[1]} ${r[0]};`))}}class _{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const r="vertex"===e?_.ALLOWLIST_VERTEX:_.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>r.includes(e))).map((e=>`#extension ${e} : enable`))}}_.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],_.ALLOWLIST_VERTEX=[];class f{constructor(){this._entries=new Set}add(e,r,t){let n="ERROR_CONSTRUCTOR_STRING";switch(r){case"float":n=f._numberToFloatStr(t);break;case"int":n=f._numberToIntStr(t);break;case"bool":n=t.toString();break;case"vec2":n=`vec2(${f._numberToFloatStr(t[0])},                            ${f._numberToFloatStr(t[1])})`;break;case"vec3":n=`vec3(${f._numberToFloatStr(t[0])},                            ${f._numberToFloatStr(t[1])},                            ${f._numberToFloatStr(t[2])})`;break;case"vec4":n=`vec4(${f._numberToFloatStr(t[0])},                            ${f._numberToFloatStr(t[1])},                            ${f._numberToFloatStr(t[2])},                            ${f._numberToFloatStr(t[3])})`;break;case"ivec2":n=`ivec2(${f._numberToIntStr(t[0])},                             ${f._numberToIntStr(t[1])})`;break;case"ivec3":n=`ivec3(${f._numberToIntStr(t[0])},                             ${f._numberToIntStr(t[1])},                             ${f._numberToIntStr(t[2])})`;break;case"ivec4":n=`ivec4(${f._numberToIntStr(t[0])},                             ${f._numberToIntStr(t[1])},                             ${f._numberToIntStr(t[2])},                             ${f._numberToIntStr(t[3])})`;break;case"mat2":case"mat3":case"mat4":n=`${r}(${Array.prototype.map.call(t,(e=>f._numberToFloatStr(e))).join(", ")})`}return this._entries.add(`const ${r} ${e} = ${n};`),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const S="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n\nout vec4 fragColor;",g="precision highp float;\nprecision highp sampler2D;";export{s as B,c as S,i as U};
