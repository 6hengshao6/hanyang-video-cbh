/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{c as e,l as t}from"./mathUtils.js";import{d as i,f as s,s as r,c as h,E as a,g as n,a as c,A as o}from"./vec3.js";import{p as l,g as m,i as g,a as u}from"./maybe.js";import{M as d}from"../core/scheduling.js";import{s as f}from"./vec2.js";import{c as j}from"./glUtil3D.js";import{R as E,S as p,P as _}from"./Program2.js";import{D as B}from"./Material.js";import{S as G}from"./SSAOBlur.glsl.js";import{m as F,a as b}from"./renderState.js";import{S as z,g as M}from"./SSAO.glsl.js";import{a as q}from"./vec2f64.js";import{N as Y}from"./interfaces2.js";import{d as J,T as y,P as O,a as Z,c as H,b as x,g as S,h as I}from"./enums3.js";import{v as X,F as W}from"./FramebufferObject.js";import{T as R}from"./Texture.js";class U{constructor(e=i()){this.intensity=e}}class w{constructor(e=i(),t=s(.57735,.57735,.57735)){this.intensity=e,this.direction=t}}class K{constructor(e=i(),t=s(.57735,.57735,.57735),r=!0,h=1,a=1){this.intensity=e,this.direction=t,this.castShadows=r,this.specularStrength=h,this.environmentStrength=a}}class P{constructor(){this.r=[0],this.g=[0],this.b=[0]}}function T(e,t,i){(i=i||e).length=e.length;for(let s=0;s<e.length;s++)i[s]=e[s]*t[s];return i}function L(e,t,i){(i=i||e).length=e.length;for(let s=0;s<e.length;s++)i[s]=e[s]*t;return i}function V(e,t,i){(i=i||e).length=e.length;for(let s=0;s<e.length;s++)i[s]=e[s]+t[s];return i}function N(e){return(e+1)*(e+1)}function D(e,t,i){const s=e[0],r=e[1],h=e[2],a=i||[];return a.length=N(t),t>=0&&(a[0]=.28209479177),t>=1&&(a[1]=.4886025119*s,a[2]=.4886025119*h,a[3]=.4886025119*r),t>=2&&(a[4]=1.09254843059*s*r,a[5]=1.09254843059*r*h,a[6]=.31539156525*(3*h*h-1),a[7]=1.09254843059*s*h,a[8]=.54627421529*(s*s-r*r)),a}const A=[],C=[],v=[],k=[0],Q=[0],$=i(),ee=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class te{constructor(){this.color=i(),this.intensity=1}}class ie{constructor(){this.direction=i(),this.ambient=new te,this.diffuse=new te}}const se=.4;class re{constructor(){this._shOrder=2,this._legacy=new ie,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new P,this._mainLight=new K(i(),s(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(t){(function(t,i,s,n){!function(e,t){const i=N(e),s=t||{r:[],g:[],b:[]};s.r.length=s.g.length=s.b.length=i;for(let e=0;e<i;e++)s.r[e]=s.g[e]=s.b[e]=0}(i,n),r(s.intensity,0,0,0);let c=!1;const o=A,l=C,m=v;o.length=0,l.length=0,m.length=0;for(const e of t)e instanceof K&&!c?(h(s.direction,e.direction),h(s.intensity,e.intensity),s.specularStrength=e.specularStrength,s.environmentStrength=e.environmentStrength,s.castShadows=e.castShadows,c=!0):e instanceof K||e instanceof w?o.push(e):e instanceof U?l.push(e):e instanceof P&&m.push(e);(function(t,i){const s=(r=i.r.length,e(Math.floor(Math.sqrt(r)-1),0,2));var r;for(const e of t)a($,e.direction),D($,s,k),T(k,ee),L(k,e.intensity[0],Q),V(i.r,Q),L(k,e.intensity[1],Q),V(i.g,Q),L(k,e.intensity[2],Q),V(i.b,Q)})(o,n),function(e,t){D($,0,k);for(const i of e)t.r[0]+=k[0]*ee[0]*i.intensity[0]*4*Math.PI,t.g[0]+=k[0]*ee[0]*i.intensity[1]*4*Math.PI,t.b[0]+=k[0]*ee[0]*i.intensity[2]*4*Math.PI}(l,n);for(const e of m)V(n.r,e.r),V(n.g,e.g),V(n.b,e.b)})(t,this._shOrder,this._mainLight,this._sphericalHarmonics),h(this._legacy.direction,this._mainLight.direction);const i=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*i,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*i,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*i,n(this._legacy.diffuse.color,this._mainLight.intensity,i),h(he,this._legacy.diffuse.color),n(he,he,.4*this.globalFactor),c(this._legacy.ambient.color,this._legacy.ambient.color,he)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),h(this._mainLight.direction,e.mainLight.direction),h(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,i,s){if(o(this._mainLight.intensity,e.mainLight.intensity,i.mainLight.intensity,s),this._mainLight.environmentStrength=t(e.mainLight.environmentStrength,i.mainLight.environmentStrength,s),this._mainLight.specularStrength=t(e.mainLight.specularStrength,i.mainLight.specularStrength,s),h(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=t(e.globalFactor,i.globalFactor,s),this.noonFactor=t(e.noonFactor,i.noonFactor,s),e.sh.r.length===i.sh.r.length)for(let r=0;r<i.sh.r.length;r++)this._sphericalHarmonics.r[r]=t(e.sh.r[r],i.sh.r[r],s),this._sphericalHarmonics.g[r]=t(e.sh.g[r],i.sh.g[r],s),this._sphericalHarmonics.b[r]=t(e.sh.b[r],i.sh.b[r],s);else for(let e=0;e<i.sh.r.length;e++)this._sphericalHarmonics.r[e]=i.sh.r[e],this._sphericalHarmonics.g[e]=i.sh.g[e],this._sphericalHarmonics.b[e]=i.sh.b[e]}}const he=i();class ae extends p{initializeProgram(e){return new _(e.rctx,ae.shader.get().build(),B)}initializePipeline(){return F({colorWrite:b})}}ae.shader=new E(G,(()=>import("./SSAOBlur.glsl.js").then((e=>e.S))));class ne extends p{initializeProgram(e){return new _(e.rctx,ne.shader.get().build(),B)}initializePipeline(){return F({colorWrite:b})}}ne.shader=new E(z,(()=>import("./SSAO.glsl.js").then((e=>e.S))));class ce extends Y{constructor(){super(...arguments),this.projScale=1}}class oe extends ce{constructor(){super(...arguments),this.intensity=1}}class le extends Y{}class me extends le{constructor(){super(...arguments),this.blurSize=q()}}const ge=2;class ue{constructor(e,t,i,s){this._view=e,this._techniqueRepository=t,this._rctx=i,this._requestRender=s,this._quadVAO=null,this._passParameters=new oe,this._drawParameters=new me}dispose(){this.enabled=!1,this._quadVAO=l(this._quadVAO)}disposeOffscreenBuffers(){m(this._ssaoFBO,(e=>e.resize(0,0))),m(this._blur0FBO,(e=>e.resize(0,0))),m(this._blur1FBO,(e=>e.resize(0,0)))}set enabled(e){e?this._enable():this._disable()}get enabled(){return g(this._enableTime)}get active(){return this.enabled&&this._ssaoTechnique.compiled&&this._blurTechnique.compiled}get colorTexture(){return g(this._blur1FBO)?this._blur1FBO.colorTexture:null}render(e,t,i,s){if(u(this._enableTime)||u(i)||u(s)||u(this._ssaoFBO)||u(this._blur0FBO)||u(this._blur1FBO))return;if(!this.active)return this._enableTime=t,void this._requestRender();0===this._enableTime&&(this._enableTime=t);const r=this._rctx,h=e.camera,a=this._view.qualitySettings.fadeDuration,n=a>0?Math.min(a,t-this._enableTime)/a:1;this._passParameters.normalTexture=s,this._passParameters.depthTexture=i,this._passParameters.projScale=1/h.computeRenderPixelSizeAtDist(1),this._passParameters.intensity=4*de/M(h)**6*n;const c=h.fullViewport,o=c[2],l=c[3],m=o/2,g=l/2;this._ssaoFBO.resize(o,l),this._blur0FBO.resize(m,g),this._blur1FBO.resize(m,g),u(this._quadVAO)&&(this._quadVAO=j(this._rctx)),r.bindFramebuffer(this._ssaoFBO),r.setViewport(0,0,o,l),r.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),r.bindVAO(this._quadVAO);const d=X(this._quadVAO,"geometry");r.drawArrays(J.TRIANGLE_STRIP,0,d);const E=r.bindTechnique(this._blurTechnique,this._passParameters,e);r.setViewport(0,0,m,g),r.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,f(this._drawParameters.blurSize,0,2/l),E.bindDraw(this._drawParameters,e,this._passParameters),r.setViewport(0,0,m,g),r.drawArrays(J.TRIANGLE_STRIP,0,d),r.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,f(this._drawParameters.blurSize,2/o,0),E.bindDraw(this._drawParameters,e,this._passParameters),r.drawArrays(J.TRIANGLE_STRIP,0,d),r.setViewport(c[0],c[1],c[2],c[3]),n<1&&this._requestRender()}_enable(){if(g(this._enableTime))return;const e={target:y.TEXTURE_2D,pixelFormat:O.RGBA,dataType:Z.UNSIGNED_BYTE,samplingMode:H.LINEAR,wrapMode:x.CLAMP_TO_EDGE,width:0,height:0},t={colorTarget:S.TEXTURE,depthStencilTarget:I.NONE};this._ssaoFBO=new W(this._rctx,t,e),this._blur0FBO=new W(this._rctx,t,e),this._blur1FBO=new W(this._rctx,t,e);const i=Uint8Array.from(atob("eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM"),(e=>e.charCodeAt(0)));this._passParameters.noiseTexture=new R(this._rctx,{target:y.TEXTURE_2D,pixelFormat:O.RGB,dataType:Z.UNSIGNED_BYTE,hasMipmap:!0,width:32,height:32},i),u(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(ne)),u(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(ae)),this._enableTime=d(0),this._requestRender()}_disable(){this._enableTime=null,this._passParameters.noiseTexture=l(this._passParameters.noiseTexture),this._blur1FBO=l(this._blur1FBO),this._blur0FBO=l(this._blur0FBO),this._ssaoFBO=l(this._ssaoFBO)}get gpuMemoryUsage(){return(g(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(g(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(g(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const de=.5;export{U as A,w as F,K as M,re as S,ue as a,ge as b,se as c};
