/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import{L as a}from"./Logger.js";import{i as n,a as r,u as i,t as o}from"./maybe.js";import{createResolver as s}from"../core/promiseUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import"./typedArrayUtil.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{E as u}from"./interfaces5.js";import p from"../core/Collection.js";import"../geometry.js";import{clone as h}from"../core/lang.js";import{c as d}from"./mathUtils.js";import{c as m}from"./screenUtils.js";import{f}from"./vec3.js";import{project as y}from"../geometry/projection.js";import{h as v,c as g}from"./hydratedFeatures.js";import{d as E}from"./elevationInfoUtils.js";import{V as b}from"./ViewingMode.js";import{m as _}from"./drawUtils.js";import M from"../geometry/Point.js";var x;!function(t){t[t.WhenToolEditable=0]="WhenToolEditable",t[t.WhenToolNotEditable=1]="WhenToolNotEditable",t[t.Always=2]="Always"}(x||(x={}));class S{constructor(){this._isToolEditable=!0,this._manipulators=new p,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,e=x.WhenToolEditable){this.addMany([t],e)}addMany(t,e=x.WhenToolEditable){for(const a of t){const t={manipulator:a,visibilityPredicate:e,attached:!1};this._manipulators.add(t),this._attached&&this._updateManipulatorAttachment(t)}}remove(t){for(let e=0;e<this._manipulators.length;e++)if(this._manipulators.getItemAt(e).manipulator===t){const t=this._manipulators.splice(e,1)[0];this._detachManipulator(t);break}}removeAll(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._manipulators.removeAll()}attach(){this._manipulators.forEach((t=>{this._updateManipulatorAttachment(t)})),this._attached=!0}detach(){this._manipulators.forEach((t=>{this._detachManipulator(t)})),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach((({manipulator:t})=>{t.destroy&&t.destroy()})),this._manipulators.destroy(),this._resourceContexts=null}on(t,e){return this._manipulators.on(t,(t=>{e(t)}))}forEach(t){for(const e of this._manipulators.items)t(e)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach((e=>t.push(e.manipulator))),t}intersect(t,e){let a=null,r=Number.MAX_VALUE;return this._manipulators.forEach((({manipulator:i,attached:o})=>{if(!o||!i.interactive)return;const s=i.intersectionDistance(t,e);n(s)&&s<r&&(r=s,a=i)})),a}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const e=t.manipulator;e.grabbing=!1,e.dragging=!1,e.hovering=!1,e.selected=!1,e.detach&&e.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===x.Always||(this._isToolEditable?t.visibilityPredicate===x.WhenToolEditable:t.visibilityPredicate===x.WhenToolNotEditable)}}let A=class extends e{constructor(t){super(t),this.manipulators=new S,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[u.MANAGER,!0],[u.USER,!0]]),this._creationFinishedResolver=s()}get active(){return null!=this.view&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(u.USER)}set editable(t){this.setEditableFlag(u.USER,t)}get updating(){return!1}get interacting(){return this.active&&!this.created}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){r(this.view)?a.getLogger(this.declaredClass).error("Can't activate tool if view is not defined."):(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===u.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){return this._editableFlags.get(t)??!1}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(u.USER)&&this.getEditableFlag(u.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized)if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};function w(t,e){return t.events.on("drag",function(t,e){let a=null,i=null;return o=>{if("cancel"===o.action)return void(n(i)&&(i.execute({action:"cancel"}),a=null,i=null));const s={action:o.action,screenStart:o.start,screenEnd:o.screenPoint};"start"===o.action&&r(a)&&(a=new V,i=new V,e(t,a,i,o.pointerType,s)),n(a)&&a.execute(s),"end"===o.action&&n(a)&&(a=null,i=null)}}(t,e))}function j(t,e){const a=[t.x,t.y,t.z??0],n=e,r=[Math.cos(n),Math.sin(n)],i=Math.sqrt(r[0]*r[0]+r[1]*r[1]);if(0===i)return null;r[0]/=i,r[1]/=i;const o=t=>{const e=(t.x-a[0])*r[0]+(t.y-a[1])*r[1];t.x=a[0]+e*r[0],t.y=a[1]+e*r[1]};return t=>(o(t.mapStart),o(t.mapEnd),{...t,axis:r})}function R(t,e){let a=null;return i=>{if("start"===i.action&&(a=function(t,e,a){const i=t.geometry,o=v(e);if(r(i))return null;if("mesh"===i.type)return function(t,e,a,i){if(n(e.transform))return function(t,e,a,i){const o=C(a.getOriginPoint(e.spatialReference),i),s=e.spatialReference;return r(o)?null:{move:(e,r,i)=>{const l=_(o.clone(),e,r,i);if(l.spatialReference.equals(s))a.origin=f(l.x,l.y,l.z);else{const t=y(l,s);n(t)&&(a.origin=f(t.x,t.y,t.z))}t.notifyMeshTransformChanged(),t.notifyGeometryChanged()}}}(t,e,e.transform,a);if(!e.spatialReference.equals(a))return null;let o=0,s=0,l=0;return{move:(a,n,r)=>{const c=a-o,u=n-s,p=r-l;if(c||u||p){const h=new M(e.origin.x+c,e.origin.y+u,e.origin.z+p,e.origin.spatialReference);e.centerAt(h,{geographic:i===b.Global}),t.notifyGeometryChanged(),o=a,s=n,l=r}}}}(t,i,o,a);const s=C(i,o),l=i.spatialReference;return r(s)?null:{move:(e,a,n)=>{const r=_(s.clone(),e,a,n);r.spatialReference.equals(l)?t.geometry=r:t.geometry=y(r,l)}}}(t,i.mapStart.spatialReference,e)),r(a))return null;const o=i.mapEnd.x-i.mapStart.x,s=i.mapEnd.y-i.mapStart.y,l=i.mapEnd.z-i.mapStart.z;return a.move(o,s,l),{...i,translationX:o,translationY:s,translationZ:l}}}function C(t,e){return r(t)?null:t.spatialReference.equals(e)?t.clone():y(t,e)}function T(t,e=null,a){let i=null;const o=n(e)&&!t.spatialReference?.equals(e)?t=>n(t)?y(t,e):t:t=>t,s={exclude:[],...a};return e=>{if("start"===e.action&&(i=o(t.toMap(e.screenStart,s))),r(i))return null;const a=o(t.toMap(e.screenEnd,s));return n(a)?{...e,mapStart:i,mapEnd:a}:null}}function z(t,e){const a=t.map((t=>i(R(t,e)))).filter((t=>n(t)));return t=>{const e=t.mapEnd.x-t.mapStart.x,n=t.mapEnd.y-t.mapStart.y,r=t.mapEnd.z-t.mapStart.z;return a.forEach((e=>e(t))),{...t,translationX:e,translationY:n,translationZ:r}}}function F(t,e){const a=new Map;for(const n of e)a.set(n,h(t[n]));return e=>(a.forEach(((e,a)=>{t[a]=e})),e)}function I(t){return n(t.geometry)&&"mesh"===t.geometry.type?function(t,e){const a=n(e.transform)?e.transform.clone():null,r=e.vertexAttributes.clonePositional();return n=>(e.transform=a,e.vertexAttributes=r,t.notifyGeometryChanged(),n)}(t,t.geometry):F(t,["geometry"])}function U(t){const e=t.map((t=>i(I(t)))).filter((t=>n(t)));return t=>(e.forEach((e=>e(t))),t)}function G(){let t=0,e=0,a=0;return n=>{"start"===n.action&&(t=n.mapStart.x,e=n.mapStart.y,a=n.mapStart.z);const r=n.mapEnd.x-t,i=n.mapEnd.y-e,o=n.mapEnd.z-a;return t=n.mapEnd.x,e=n.mapEnd.y,a=n.mapEnd.z,{...n,mapDeltaX:r,mapDeltaY:i,mapDeltaZ:o,mapDeltaSpatialReference:n.mapStart.spatialReference}}}function O(){let t=0,e=0;return a=>{"start"===a.action&&(t=a.screenStart.x,e=a.screenStart.y);const n=a.screenEnd.x-t,r=a.screenEnd.y-e;return t=a.screenEnd.x,e=a.screenEnd.y,{...a,screenDeltaX:n,screenDeltaY:r}}}function P(t,e){let a=null,n=0,r=0;return i=>{if("start"===i.action&&(a=t.toScreen?.(e),null!=a&&(a.x<0||a.x>t.width||a.y<0||a.y>t.height?a=null:(n=i.screenStart.x-a.x,r=i.screenStart.y-a.y))),null==a)return null;const o=d(i.screenEnd.x-n,0,t.width),s=d(i.screenEnd.y-r,0,t.height),l=m(o,s);return i.screenStart=a,i.screenEnd=l,i}}t([l({constructOnly:!0})],A.prototype,"view",void 0),t([l({readOnly:!0})],A.prototype,"active",null),t([l({value:!0})],A.prototype,"visible",null),t([l({value:!0})],A.prototype,"editable",null),t([l({readOnly:!0})],A.prototype,"manipulators",void 0),t([l({readOnly:!0})],A.prototype,"updating",null),t([l({readOnly:!0})],A.prototype,"interacting",null),t([l()],A.prototype,"cursor",null),t([l({readOnly:!0})],A.prototype,"automaticManipulatorSelection",void 0),t([l()],A.prototype,"hasFocusedManipulators",null),t([l()],A.prototype,"hasGrabbedManipulators",void 0),t([l()],A.prototype,"hasHoveredManipulators",void 0),t([l()],A.prototype,"firstGrabbedManipulator",void 0),t([l({readOnly:!0})],A.prototype,"created",void 0),t([l({readOnly:!0})],A.prototype,"removeIncompleteOnCancel",void 0),A=t([c("esri.views.interactive.InteractiveToolBase")],A);const D=()=>{};class V{constructor(){this.execute=D}next(t,e=new V){return n(t)&&(this.execute=a=>{const r=t(a);n(r)&&e.execute(r)}),e}}function W(t,e,a=[]){if("2d"===t.type)return t=>t;let r=null;return i=>{"start"===i.action&&(r=t.toMap(i.screenStart,{exclude:a}),n(r)&&(r.z=E(r,t,e)));const o=t.toMap(i.screenEnd,{exclude:a});n(o)&&(o.z=E(o,t,e));const s=n(r)&&n(o)?{sceneStart:r,sceneEnd:o}:null;return{...i,scenePoints:s}}}function q(t,e,a){const n=o(e.elevationProvider.getElevation(t.x,t.y,t.z??0,t.spatialReference,"scene"))??0,r=g(t);return r.z=n,r.hasZ=!0,r.z=E(r,e,a),r}function N(t,e){if("2d"===t.type)return t=>t;let a=null;return r=>{"start"===r.action&&(a=q(r.mapStart,t,e));const i=q(r.mapEnd,t,e),o=n(a)&&n(i)?{sceneStart:a,sceneEnd:i}:null;return{...r,scenePoints:o}}}export{V as E,A as I,S as M,T as a,I as b,w as c,R as d,P as e,j as f,O as g,G as h,z as i,U as j,N as k,F as r,W as s};
