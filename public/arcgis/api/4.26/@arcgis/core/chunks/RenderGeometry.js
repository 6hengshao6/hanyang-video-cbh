/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import t from"../core/Accessor.js";import s from"../core/Evented.js";import r from"../core/Handles.js";import{s as i}from"./ensureType.js";import{p as a,a as n,i as o,u as h,k as d,d as c,e as l}from"./maybe.js";import{M as u,P as p,s as m}from"../core/scheduling.js";import{watch as g,syncAndInitial as _,on as f}from"../core/reactiveUtils.js";import{g as y,s as w}from"./watch.js";import{property as T}from"../core/accessorSupport/decorators/property.js";import{h as R,n as v,z as x}from"./typedArrayUtil.js";import{subclass as b}from"../core/accessorSupport/decorators/subclass.js";import{n as S,m as C,c as O,q as E,t as A,u as M,f as D,j as I}from"./mat4.js";import{f as P,b as L,d as H,j,c as G,E as V,e as N,s as U}from"./vec3.js";import{V as B}from"./ViewingMode.js";import{b as F,d as W,e as z,c as q}from"./glUtil3D.js";import{R as k,O as Y}from"./interfaces4.js";import{c as X,o as $,a as Q}from"./aaBoundingRect.js";import{V as Z,R as J}from"./basicInterfaces.js";import{c as K}from"./vec2f32.js";import{g as ee,h as te,T as se,P as re,a as ie,b as ae,c as ne,j as oe,U as he,B as de,d as ce}from"./enums3.js";import{F as le,a as ue,B as pe,v as me}from"./FramebufferObject.js";import{S as ge}from"./ShaderOutput.js";import{a as _e,T as fe}from"./TextureOnly.glsl.js";import{N as ye}from"./NestedMap.js";import{S as we,p as Te}from"./ShaderTechniqueConfiguration.js";import{C as Re}from"./Camera.js";import{L as ve}from"./Logger.js";import{a as xe,l as be,v as Se,b as Ce,s as Oe}from"./Util2.js";import{f as Ee,c as Ae}from"./vec4f64.js";import{projectBuffer as Me}from"../geometry/projection.js";import{A as De}from"./Attribute.js";import{C as Ie,R as Pe,D as Le,A as He,M as je}from"./Material.js";import{a as Ge,G as Ve,D as Ne}from"./DefaultBufferWriter.js";import{R as Ue,W as Be,O as Fe,T as We,P as ze,U as qe}from"./TriangleMaterial.js";import{V as ke}from"./VertexAttribute.js";import{a as Ye,f as Xe}from"./vec2f64.js";import{S as $e,C as Qe,W as Ze}from"./WaterSurface.glsl.js";import{M as Je}from"./MultipassGeometryTest.glsl.js";import{M as Ke}from"./MultipassTerrainTest.glsl.js";import{R as et}from"./RenderSlot.js";import{T as tt}from"./TransparencyPassType.js";import{S as st,a as rt,A as it}from"./SSAOHelper.js";import{c as at,l as nt,b as ot}from"./mathUtils.js";import{c as ht}from"./mat3f64.js";import{c as dt}from"./mat4f64.js";import{s as ct,j as lt,h as ut,l as pt,a as mt,b as gt,e as _t,i as ft,n as yt,k as wt}from"./vec2.js";import{s as Tt,t as Rt}from"./vec4.js";import{T as vt}from"./Texture.js";import{O as xt}from"./Intersector.js";import{S as bt,n as St,I as Ct}from"./Intersector2.js";import{g as Ot}from"./glUtil.js";import{A as Et}from"./AppleAmdDriverHelper.js";import{V as At}from"./VertexNormal.glsl.js";import{c as Mt,o as Dt,a as It,b as Pt,g as Lt,d as Ht}from"./OrderIndependentTransparency.js";import{P as jt}from"./BooleanPassUniform.js";import"./interfaces2.js";import"./ShaderBuilder.js";import{R as Gt,S as Vt,P as Nt}from"./Program2.js";import{D as Ut}from"./DefaultTechniqueConfiguration.js";import{m as Bt,d as Ft,a as Wt,s as zt}from"./renderState.js";import{R as qt,b as kt}from"./MemCache.js";import{S as Yt}from"./LineStipple.glsl.js";import{T as Xt,n as $t}from"./Scheduler.js";import{c as Qt}from"./sphere.js";import{b as Zt}from"./mathUtils2.js";var Jt,Kt,es,ts,ss,rs;!function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(Jt||(Jt={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(Kt||(Kt={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(es||(es={})),function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"}(ts||(ts={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(ss||(ss={}));class is{constructor(e,t){this.vec3=e,this.id=t}}function as(e,t,s,r){return new is(P(e,t,s),r)}!function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded",e[e.ObjectAndLayerIdColor=4]="ObjectAndLayerIdColor"}(rs||(rs={}));class ns{get extent(){return this._extent}constructor(e,t){this.index=e,this.renderTargets=t,this._extent=X(),this.resolution=0,this.renderLocalOrigin=as(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new os,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTexture(e){return this.validTargets[e]?this.renderTargets.getTarget(e).getTexture():null}get _needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=e===rs.ColorAndWater?this.renderTargets.getTarget(k.Color):e===rs.Highlight?this.renderTargets.getTarget(k.Highlight):e===rs.ObjectAndLayerIdColor?this.renderTargets.getTarget(k.ObjectAndLayerIdColor):this.renderTargets.getTarget(k.Occluded);return t?t.getTexture():null}getColorTextureNoRasterImage(){return this._needsColorWithoutRasterImage?this.getValidTexture(k.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(k.Color):null}getNormalTexture(e){const t=e===rs.ColorAndWater?this.renderTargets.getTarget(k.Water):null;return t?t.getTexture():null}draw(e,t){const s=this.computeRenderTargetValidityBitfield();for(const s of this.renderTargets.renderTargets)s.type!==k.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[s.type]=e.drawTarget(this,s,t):this.validTargets[s.type]=!1;return s^this.computeRenderTargetValidityBitfield()?Z.CHANGED:Z.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[k.Color]|+e[k.ColorNoRasterImage]<<1|+e[k.Highlight]<<2|+e[k.Water]<<3|+e[k.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];$(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];$(this._extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Q(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===Y.INNER?0:this.resolution,0,this.resolution,this.resolution)}}class os{constructor(){this.extents=[X(),X(),X()],this.numViews=0}}class hs{constructor(e,t){this._size=K(),this._fbo=null,this._fbo=new le(e,{colorTarget:ee.TEXTURE,depthStencilTarget:te.NONE},{target:se.TEXTURE_2D,pixelFormat:re.RGBA,dataType:ie.UNSIGNED_BYTE,wrapMode:ae.CLAMP_TO_EDGE,samplingMode:ne.LINEAR_MIPMAP_LINEAR,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=a(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this._size[0]=e,this._size[1]=t,this._fbo.resize(this._size[0],this._size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){const e=this._fbo.colorTexture;e.descriptor.hasMipmap&&e.generateMipmap()}disposeRenderTargetMemory(){this._fbo?.resize(0,0)}get gpuMemoryUsage(){return this._fbo?.gpuMemoryUsage??0}}class ds{constructor(e,t,s,r=!0){this.output=t,this.type=s,this.valid=!1,this.lastUsed=1/0,this.fbo=new hs(e,r)}}class cs{constructor(e){this.renderTargets=[new ds(e,ge.Color,k.Color),new ds(e,ge.Color,k.ColorNoRasterImage),new ds(e,ge.Highlight,k.Highlight,!1),new ds(e,ge.Normal,k.Water),new ds(e,ge.Color,k.Occluded)],R("enable-feature:objectAndLayerId-rendering")&&this.renderTargets.push(new ds(e,ge.ObjectAndLayerIdColor,k.ObjectAndLayerIdColor))}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,s){if(e)t.lastUsed=s;else if(s-t.lastUsed>ls)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const ls=1e3;class us{constructor(e){this._context=e,this._perConstructorInstances=new ye,this._frameCounter=0,this._keepAliveFrameCount=ms}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t=gs){const s=t.key;let r=this._perConstructorInstances.get(e,s);if(n(r)){const i=new e(this._context,t,(()=>this.release(i)));r=new ps(i),this._perConstructorInstances.set(e,s,r)}return++r.refCount,r.technique}releaseAndAcquire(e,t,s){if(o(s)){if(t.key===s.key)return s;this.release(s)}return this.acquire(e,t)}release(e){if(n(e)||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);n(t)||(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==ms&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,s)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,s))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,s)=>{e.push((async(e,t)=>{const s=t.shader;s&&(await s.reload(),e.forEach((e=>e.technique.reload(this._context))))})(t,s))})),await Promise.all(e)}}class ps{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}const ms=-1,gs=new we;class _s{constructor(e,t,s,r){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=s,this.requestRender=r,this._id2glMaterialRef=new ye}dispose(){this._textureRepository.destroy()}acquire(e,t,s){if(this._ownMaterial(e),!e.requiresSlot(t,s))return null;let r=this._id2glMaterialRef.get(s,e.id);if(n(r)){const t=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:s});r=new fs(t),this._id2glMaterialRef.set(s,e.id,r)}return r.ref(),r.glMaterial}release(e,t){const s=this._id2glMaterialRef.get(t,e.id);o(s)&&(s.unref(),s.referenced||(a(s.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){o(e.repository)&&e.repository!==this&&ve.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class fs{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,xe(this._refCnt>=0)}get referenced(){return this._refCnt>0}}const ys={orderedRepackingEnabled:!1};class ws{constructor(e){this._originSR=e,this._origins=new Map,this._objects=new Map,this._gridSize=5e5,this._rootOriginId="root/"+y()}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){const t=null;if(o(t))return this._origins.set(this._rootOriginId,as(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);const s=as(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,s),s}const s=this._gridSize,r=Math.round(e[0]/s),i=Math.round(e[1]/s),a=Math.round(e[2]/s),n=`${r}/${i}/${a}`;let h=this._origins.get(n);const d=.5*s;if(L(Ts,e,t.vec3),Ts[0]=Math.abs(Ts[0]),Ts[1]=Math.abs(Ts[1]),Ts[2]=Math.abs(Ts[2]),Ts[0]<d&&Ts[1]<d&&Ts[2]<d){if(h){const t=Math.max(...Ts);if(L(Ts,e,h.vec3),Ts[0]=Math.abs(Ts[0]),Ts[1]=Math.abs(Ts[1]),Ts[2]=Math.abs(Ts[2]),Math.max(...Ts)<t)return h}return t}return h||(h=as(r*s,i*s,a*s,n),this._origins.set(n,h)),h}_drawOriginBox(e,t=Ee(1,1,0,1)){const s=window.view,r=s._stage,i=t.toString();if(!this._objects.has(i)){this._material=new Ue({width:2,color:t}),r.add(this._material);const e=new Be({pickable:!1}),s=new Fe({castShadow:!1});r.add(s),e.add(s),r.add(e),this._objects.set(i,s)}const a=this._objects.get(i),n=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],o=n.length,h=new Array(3*o),d=new Array,c=.5*this._gridSize;for(let t=0;t<o;t++)h[3*t]=e[0]+(1&n[t]?c:-c),h[3*t+1]=e[1]+(2&n[t]?c:-c),h[3*t+2]=e[2]+(4&n[t]?c:-c),t>0&&d.push(t-1,t);Me(h,this._originSR,0,h,s.renderSpatialReference,0,o);const l=new Ge(this._material,[[ke.POSITION,new De(h,3,!0)]],[[ke.POSITION,d]],null,Ie.Line);r.add(l),a.addGeometry(l)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}}const Ts=H();class Rs{constructor(e,t,s){this.shadowMap=e,this.ssaoHelper=t,this.slicePlane=s,this.slot=et.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=tt.NONE,this._camera=new Re,this._inverseViewport=Ye(),this.oldLighting=new st,this.newLighting=new st,this._fadedLighting=new st,this._lighting=this.newLighting,this.ssr=new $e,this.multipassTerrain=new Ke,this.multipassGeometry=new Je,this.overlays=[],this.cloudsFade=new Qe}get camera(){return this._camera}set camera(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:s}=this;e>=1?this._lighting=s:(this._fadedLighting.lerpLighting(t,s,e),this._lighting=this._fadedLighting)}}class vs{constructor(e,t,s,r=null){this.rctx=e,this.sliceHelper=r,this.lastFrameCamera=new Re,this.output=ge.Color,this.renderOccludedMask=bs,this.bindParameters=new Rs(t,s,o(r)?r.plane:null)}resetRenderOccludedMask(){this.renderOccludedMask=bs}}class xs extends vs{constructor(e,t,s,r,i){super(e,s,r,i),this.offscreenRenderingHelper=t,this.sliceHelper=i,this.time=u(0)}}const bs=Pe.Occlude|Pe.OccludeAndTransparent|Pe.OccludeAndTransparentStencil;let Ss=class extends Re{constructor(){super(...arguments),this._projectionMatrix=dt()}get projectionMatrix(){return this._projectionMatrix}};var Cs;e([T()],Ss.prototype,"_projectionMatrix",void 0),e([T({readOnly:!0})],Ss.prototype,"projectionMatrix",null),Ss=e([b("esri.views.3d.webgl-engine.lib.CascadeCamera")],Ss),function(e){e[e.Highlight=0]="Highlight",e[e.Default=1]="Default"}(Cs||(Cs={}));class Os{constructor(){this.camera=new Ss,this.lightMat=dt()}}class Es{get depthTexture(){return this._depthTexture}get textureSize(){return this._textureSize}get numCascades(){return this._numCascades}get cascadeDistances(){return Tt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,t){this._rctx=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this._maxNumCascades=4,this._projectionView=dt(),this._projectionViewInverse=dt(),this._modelViewLight=dt(),this._splitSchemeLambda=0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Ae(),this._cascades=[new Os,new Os,new Os,new Os],this._lastOrigin=null,this._maxTextureSize=Math.min(R("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(e){this._maxNumCascades=at(Math.floor(e),1,4)}get maxCascades(){return this._maxNumCascades}set enabled(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get ready(){return this._enabled&&o(this._depthTexture)}getSnapshot(e){return this.enabled?this._snapshots[e]:null}get cascades(){for(let e=0;e<this._numCascades;++e)Vs[e]=this._cascades[e];return Vs.length=this._numCascades,Vs}start(e,t,s){xe(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();const{near:r,far:i}=this._clampNearFar(s);this._computeCascadeDistances(i,r),this._setupMatrices(e,t);const{viewMatrix:a,projectionMatrix:n}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,n,a,t);this._lastOrigin=null,this.clear()}finish(e){xe(this.enabled),this._rctx.bindFramebuffer(e)}getShadowMapMatrices(e){if(!this._lastOrigin||!j(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||H(),G(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){S(Ns,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)Us[16*t+e]=Ns[e]}}return Us}takeCascadeSnapshotTo(e,t){xe(this.enabled);const s=this._ensureSnapshot(t);this._bindFbo();const r=this._rctx,i=r.bindTexture(s,vt.TEXTURE_UNIT_FOR_UPDATES);r.gl.copyTexSubImage2D(se.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),r.bindTexture(i,vt.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(oe.COLOR_BUFFER_BIT|oe.DEPTH_BUFFER_BIT)}_computeTextureSize(e,t){const s=.5*Math.log(e*e+t*t)*Math.LOG2E,r=2**Math.round(s+.35);return Math.min(this._maxTextureSize,2*r)}_ensureDepthTexture(){if(o(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const e={target:se.TEXTURE_2D,pixelFormat:re.RGBA,dataType:ie.UNSIGNED_BYTE,wrapMode:ae.CLAMP_TO_EDGE,samplingMode:ne.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new vt(this._rctx,e),this._fbo=new le(this._rctx,{colorTarget:ee.TEXTURE,depthStencilTarget:te.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}_ensureSnapshot(e){let t=this._snapshots[e];if(o(t)&&t.descriptor.width===this._textureSize)return t;this._discardSnapshot(e);const s={target:se.TEXTURE_2D,pixelFormat:re.RGBA,dataType:ie.UNSIGNED_BYTE,wrapMode:ae.CLAMP_TO_EDGE,samplingMode:ne.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return t=new vt(this._rctx,s),this._snapshots[e]=t,t}_discardDepthTexture(){this._fbo=a(this._fbo),this._depthTexture=a(this._depthTexture)}_discardSnapshot(e){this._snapshots[e]=a(this._snapshots[e])}_discardAllSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)}_constructCascade(e,t,s,r){const i=this._cascades[e],a=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),h=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);xe(o<h);for(let e=0;e<8;++e){Tt(Ms,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?o:h,1);const t=Ds[e];Rt(t,Ms,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}V(Gs,Ds[0]),i.camera.viewMatrix=S(As,this._modelViewLight,Gs);for(let e=0;e<8;++e)N(Ds[e],Ds[e],i.camera.viewMatrix);let d=Ds[0][2],c=Ds[0][2];for(let e=1;e<8;++e)d=Math.min(d,Ds[e][2]),c=Math.max(c,Ds[e][2]);d-=200,c+=200,i.camera.near=-c,i.camera.far=-d,function(e,t,s,r,i){const a=1/Ds[0][3],n=1/Ds[4][3];xe(a<n);let o=a+Math.sqrt(a*n);const h=Math.sin(ot(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=h,function(e,t,s,r,i,a,n,o){ct(Bs,0,0);for(let t=0;t<4;++t)lt(Bs,Bs,e[t]);ut(Bs,Bs,.25),ct(Fs,0,0);for(let t=4;t<8;++t)lt(Fs,Fs,e[t]);ut(Fs,Fs,.25),pt(Ws[0],e[4],e[5],.5),pt(Ws[1],e[5],e[6],.5),pt(Ws[2],e[6],e[7],.5),pt(Ws[3],e[7],e[4],.5);let h=0,d=mt(Ws[0],Bs);for(let e=1;e<4;++e){const t=mt(Ws[e],Bs);t<d&&(d=t,h=e)}gt(zs,Ws[h],e[h+4]);const c=zs[0];let l,u;zs[0]=-zs[1],zs[1]=c,gt(qs,Fs,Bs),_t(qs,zs)<0&&ft(zs,zs),pt(zs,zs,qs,s),yt(zs,zs),l=u=_t(gt(ks,e[0],Bs),zs);for(let t=1;t<8;++t){const s=_t(gt(ks,e[t],Bs),zs);s<l?l=s:s>u&&(u=s)}wt(r,Bs),ut(ks,zs,l-t),lt(r,r,ks);let p=-1,m=1,g=0,_=0;for(let t=0;t<8;++t){gt(Ys,e[t],r),yt(Ys,Ys);const s=zs[0]*Ys[1]-zs[1]*Ys[0];s>0?s>p&&(p=s,g=t):s<m&&(m=s,_=t)}Se(p>0,"leftArea"),Se(m<0,"rightArea"),ut(Xs,zs,l),lt(Xs,Xs,Bs),ut($s,zs,u),lt($s,$s,Bs),Qs[0]=-zs[1],Qs[1]=zs[0];const f=Ce(r,e[_],$s,lt(ks,$s,Qs),1,i),y=Ce(r,e[g],$s,ks,1,a),w=Ce(r,e[g],Xs,lt(ks,Xs,Qs),1,n),T=Ce(r,e[_],Xs,ks,1,o);Se(f,"rayRay"),Se(y,"rayRay"),Se(w,"rayRay"),Se(T,"rayRay")}(Ds,o,h,Is,Ps,Ls,Hs,js),function(e,t,s,r,i){gt(er,s,r),ut(er,er,.5),tr[0]=er[0],tr[1]=er[1],tr[2]=0,tr[3]=er[1],tr[4]=-er[0],tr[5]=0,tr[6]=er[0]*er[0]+er[1]*er[1],tr[7]=er[0]*er[1]-er[1]*er[0],tr[8]=1,tr[Zs(0,2)]=-_t(Ks(tr,0),e),tr[Zs(1,2)]=-_t(Ks(tr,1),e);let a=_t(Ks(tr,0),s)+tr[Zs(0,2)],n=_t(Ks(tr,1),s)+tr[Zs(1,2)],o=_t(Ks(tr,0),r)+tr[Zs(0,2)],h=_t(Ks(tr,1),r)+tr[Zs(1,2)];a=-(a+o)/(n+h),tr[Zs(0,0)]+=tr[Zs(1,0)]*a,tr[Zs(0,1)]+=tr[Zs(1,1)]*a,tr[Zs(0,2)]+=tr[Zs(1,2)]*a,a=1/(_t(Ks(tr,0),s)+tr[Zs(0,2)]),n=1/(_t(Ks(tr,1),s)+tr[Zs(1,2)]),tr[Zs(0,0)]*=a,tr[Zs(0,1)]*=a,tr[Zs(0,2)]*=a,tr[Zs(1,0)]*=n,tr[Zs(1,1)]*=n,tr[Zs(1,2)]*=n,tr[Zs(2,0)]=tr[Zs(1,0)],tr[Zs(2,1)]=tr[Zs(1,1)],tr[Zs(2,2)]=tr[Zs(1,2)],tr[Zs(1,2)]+=1,a=_t(Ks(tr,1),t)+tr[Zs(1,2)],n=_t(Ks(tr,2),t)+tr[Zs(2,2)],o=_t(Ks(tr,1),s)+tr[Zs(1,2)],h=_t(Ks(tr,2),s)+tr[Zs(2,2)],a=-.5*(a/n+o/h),tr[Zs(1,0)]+=tr[Zs(2,0)]*a,tr[Zs(1,1)]+=tr[Zs(2,1)]*a,tr[Zs(1,2)]+=tr[Zs(2,2)]*a,a=_t(Ks(tr,1),t)+tr[Zs(1,2)],n=_t(Ks(tr,2),t)+tr[Zs(2,2)],o=-n/a,tr[Zs(1,0)]*=o,tr[Zs(1,1)]*=o,tr[Zs(1,2)]*=o,i[0]=tr[0],i[1]=tr[1],i[2]=0,i[3]=tr[2],i[4]=tr[3],i[5]=tr[4],i[6]=0,i[7]=tr[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=tr[6],i[13]=tr[7],i[14]=0,i[15]=tr[8]}(Is,Ps,Hs,js,i.projectionMatrix),i.projectionMatrix[10]=2/(s-r),i.projectionMatrix[14]=-(s+r)/(s-r)}(s,r,d,c,i.camera),C(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const l=this._textureSize/2;i.camera.viewport=[e%2==0?0:l,0===Math.floor(e/2)?0:l,l,l]}_setupMatrices(e,t){C(this._projectionView,e.projectionMatrix,e.viewMatrix),O(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===B.Global?e.eye:U(Gs,0,0,1);E(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],s)}_clampNearFar(e){let{near:t,far:s}=e;return t<2&&(t=2),s<2&&(s=2),t>=s&&(t=2,s=4),{near:t,far:s}}_computeCascadeDistances(e,t){this._numCascades=Math.min(1+Math.floor(be(e/t,4)),this._maxNumCascades);const s=(e-t)/this._numCascades,r=(e/t)**(1/this._numCascades);let i=t,a=t;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=nt(i,a,this._splitSchemeLambda),i*=r,a+=s}get gpuMemoryUsage(){return this._snapshots.reduce(((e,t)=>e+ue(t)),this._fbo?.gpuMemoryUsage??0)}get test(){const e=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(t){e._splitSchemeLambda=t},get splitSchemeLambda(){return e._splitSchemeLambda}}}}const As=dt(),Ms=Ae(),Ds=[];for(let e=0;e<8;++e)Ds.push(Ae());const Is=Ye(),Ps=Ye(),Ls=Ye(),Hs=Ye(),js=Ye(),Gs=H(),Vs=[],Ns=dt(),Us=new Float32Array(64),Bs=Ye(),Fs=Ye(),Ws=[Ye(),Ye(),Ye(),Ye()],zs=Ye(),qs=Ye(),ks=Ye(),Ys=Ye(),Xs=Ye(),$s=Ye(),Qs=Ye();function Zs(e,t){return 3*t+e}const Js=Ye();function Ks(e,t){return ct(Js,e[t],e[t+3]),Js}const er=Ye(),tr=ht();class sr{constructor(){this.adds=new p,this.removes=new p,this.updates=new p({allocator:e=>e||new rr,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return 0===this.adds.length&&0===this.removes.length&&0===this.updates.length}}class rr{}class ir{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function ar(e){const t=new Map,s=e=>{let s=t.get(e);return s||(s=new ir,t.set(e,s)),s};return e.removes.forAll((e=>{nr(e)&&s(e.material).removes.push(e)})),e.adds.forAll((e=>{nr(e)&&s(e.material).adds.push(e)})),e.updates.forAll((e=>{nr(e.renderGeometry)&&s(e.renderGeometry.material).updates.push(e)})),t}function nr(e){return e.geometry.indexCount>=1}class or{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}destroy(){this._map.forEach(((e,t)=>{o(e)&&this._repository.release(this._material,t)}))}load(e,t,s){if(!this._material.requiresSlot(t,s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,t,s));const r=this._map.get(s);if(o(r)){if(r.ensureResources(e)===J.LOADED)return r;this._repository.requestRender()}return null}}class hr extends At{constructor(e=H()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}}class dr extends Vt{initializeConfiguration(e,t){t.spherical=e.viewingMode===B.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Nt(e.rctx,dr.shader.get().build(this.configuration),Le)}_setPipelineState(e){const t=this.configuration,s=e===tt.NONE,r=e===tt.FrontFace;return Bt({blending:t.output!==ge.Normal&&t.output!==ge.Highlight&&t.transparent?s?Mt:Dt(e):null,depthTest:{func:It(e)},depthWrite:s?t.writeDepth?Ft:null:Pt(e),colorWrite:Wt,polygonOffset:s||r?null:Lt(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}dr.shader=new Gt(Ze,(()=>import("./WaterSurface.glsl.js").then((e=>e.W))));class cr extends Ut{constructor(){super(...arguments),this.output=ge.Color,this.transparencyPassType=tt.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.isDraped=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}e([Te({count:ge.COUNT})],cr.prototype,"output",void 0),e([Te({count:tt.COUNT})],cr.prototype,"transparencyPassType",void 0),e([Te()],cr.prototype,"spherical",void 0),e([Te()],cr.prototype,"receiveShadows",void 0),e([Te()],cr.prototype,"hasSlicePlane",void 0),e([Te()],cr.prototype,"transparent",void 0),e([Te()],cr.prototype,"enableOffset",void 0),e([Te()],cr.prototype,"writeDepth",void 0),e([Te()],cr.prototype,"hasScreenSpaceReflections",void 0),e([Te()],cr.prototype,"doublePrecisionRequiresObfuscation",void 0),e([Te()],cr.prototype,"hasCloudsReflections",void 0),e([Te()],cr.prototype,"isDraped",void 0),e([Te()],cr.prototype,"hasMultipassTerrain",void 0),e([Te()],cr.prototype,"cullAboveGround",void 0),e([Te({constValue:jt.Water})],cr.prototype,"pbrMode",void 0),e([Te({constValue:!0})],cr.prototype,"useCustomDTRExponentForWater",void 0),e([Te({constValue:!0})],cr.prototype,"highStepCount",void 0),e([Te({constValue:!1})],cr.prototype,"useFillLights",void 0);class lr extends Ve{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}_updateCloudsReflectionState(e){const t=o(e.cloudsFade.data);t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===ge.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(dr,e)}}class ur extends We{constructor(e){super(e,new pr),this._configuration=new cr,this.animation=new He}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Ht,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<mr;const s=this.animation.advance(e);return this.setParameters({timeElapsed:m(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&s}requiresSlot(e,t){switch(t){case ge.Normal:return e===et.DRAPED_WATER;case ge.Color:if(this.parameters.isDraped)return e===et.DRAPED_MATERIAL;break;case ge.Alpha:break;case ge.Highlight:return e===et.OPAQUE_MATERIAL||e===et.DRAPED_MATERIAL;default:return!1}let s=et.OPAQUE_MATERIAL;return this.parameters.transparent&&(s=this.parameters.writeDepth?et.TRANSPARENT_MATERIAL:et.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===s}createGLMaterial(e){return new lr(e)}createBufferWriter(){return new Ne(ze)}}class pr extends je{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=Xe(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=Ee(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1}}const mr=35e3;class gr{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}}function _r(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let s=!0;for(;s;)s=!1,e.forEach((r=>{const i=t.get(r.to);i&&(r.to=i.to,t.delete(i.from),e.removeUnordered(i),s=!0)}))}class fr extends gr{constructor(e,t,s){super(t,s),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return o(this.geometry.highlights)&&this.isVisible}get hasOccludees(){return o(this.geometry.occludees)}}class yr{constructor(){this.first=0,this.count=0}}class wr{constructor(){this._numElements=0,this._instances=new Map,this.holes=new p({allocator:e=>e||new gr,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=Tr(),this.drawCommandsHighlight=Tr(),this.drawCommandsOccludees=Tr(),this.drawCommandsShadowHighlightRest=Tr()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,s){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,r.from=t,r.to=s,this._numElements+=r.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;if(!this.needsMultipleCommands()){const t=this.drawCommandsDefault.pushNew(),s=this.holes.front();return o(this.vao)&&1===this.holes.length&&s.to===Math.floor(this.vao.size/e)?(t.first=0,void(t.count=s.from)):(t.first=1/0,t.count=0,this._instances.forEach((e=>{t.first=Math.min(t.first,e.from),t.count=Math.max(t.count,e.to)})),void(t.count-=t.first))}const t=Array.from(this._instances.values()).sort(((e,t)=>e.from===t.from?e.to-t.to:e.from-t.from));for(const e of t)e.isVisible&&(Rr(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e),Rr(e.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,e))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function Tr(){return new p({allocator:e=>e||new yr,deallocator:e=>e})}function Rr(e,t){const s=e.back();if(null==s){const s=e.pushNew();return s.first=t.from,void(s.count=t.numElements)}if(i=t,(r=s).first+r.count>=i.from){const e=t.from-s.first+t.numElements;s.count=e}else{const s=e.pushNew();s.first=t.from,s.count=t.numElements}var r,i}class vr{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach((e=>e.vao.dispose())),this.buffers.length=0}findBuffer(e){return this.buffers.find((t=>t.instances.has(e)))}}const xr=kt+1;class br{constructor(e,t,s){this._rctx=e,this._locations=t,this._layout=s,this._cache=e.newCache(`VaoCache ${y()}`,Sr)}dispose(){this._cache.destroy()}newVao(e){const t=e.toString(),s=this._cache.pop(t);if(o(s)){const r=s.pop();return s.length>0&&this._cache.put(t,s,e*s.length,xr),r}const r=new F(this._rctx,this._locations,{geometry:this._layout},{geometry:pe.createVertex(this._rctx,he.STATIC_DRAW)});return r.vertexBuffers.geometry.setSize(e),r}deleteVao(e){if(n(e))return null;const t=e.size,s=t.toString(),r=this._cache.pop(s);return o(r)?(r.push(e),this._cache.put(s,r,t*r.length,-1)):this._cache.put(s,[e],t,-1),null}}function Sr(e,t){if(t===qt.ALL)return void e.forEach((e=>e.dispose()));const s=e.pop(),r=e.length*s.size;return s.dispose(),r}class Cr{constructor(e,t,s){this._rctx=e,this._materialRepository=t,this.material=s,this._dataByOrigin=new Map,this._appleAmdDriverHelper=null,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new or(this.material,this._materialRepository),this._bufferWriter=s.createBufferWriter(),this._vaoCache=new br(e,s.vertexAttributeLocations,Ot(this._bufferWriter.vertexBufferLayout)),this._rctx.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper=new Et(this._rctx))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.dispose())),this._dataByOrigin.clear(),this._vaoCache.dispose(),this._appleAmdDriverHelper?.dispose()}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof ur}get rendersOccluded(){return!this.isEmpty&&this.material.renderOccluded!==Pe.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach((t=>e+=t.buffers.reduce(((e,t)=>e+t.instances.size),0))),e}forEachGeometry(e){this._dataByOrigin.forEach((t=>t.buffers.forEach((t=>t.instances.forEach((t=>e(t.geometry)))))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter,s=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,i=this._dataByOrigin.get(e.localOrigin.id),a=i?.findBuffer(e.id);if(n(a))return;const o=a.instances.get(e.id);if(r.updateType&(ss.GEOMETRY|ss.TRANSFORMATION)){const r=Vr(t.elementCount(o.geometry.geometry)*s),i=t.vertexBufferLayout.createView(r.buffer);this._writeGeometry(e,i,0),a.vao.vertexBuffers.geometry.setSubData(r,o.from*s,0,o.numElements*s),Ur()}r.updateType&(ss.HIGHLIGHT|ss.OCCLUDEE|ss.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,t){const s=new ye;for(const t of e){const e=t.localOrigin;if(n(e))continue;let r=s.get(e.id,null);n(r)&&(r=new Or(e.vec3),s.set(e.id,null,r)),r.changes.push(t)}for(const e of t){const t=e.localOrigin;if(n(t))continue;const r=this._dataByOrigin.get(t.id),i=r?.findBuffer(e.id);if(n(i))continue;let a=s.get(t.id,i);n(a)&&(a=new Or(t.vec3),s.set(t.id,i,a)),a.changes.push(e)}return s}_addAndRemoveGeometries(e,t){const{_bufferWriter:s,_dataByOrigin:r}=this,i=s.vertexBufferLayout.stride/4,a=this._computeDeltas(e,t);a.forEach(((e,t)=>{const h=e.get(null),d=o(h)?h.changes:[];a.delete(t,null);let c=r.get(t);if(e.forEach(((e,o)=>{if(a.delete(t,o),n(o))return void xe(!1,"No VAO for removed geometries");if(o.instances.size===e.changes.length)return this._vaoCache.deleteVao(o.vao),v(c.buffers,o),void(0===c.buffers.length&&0===d.length&&r.delete(t));const h=o.numElements,l=o.vao.size/4,u=d.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),p=e.changes.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),m=Math.min((h+u-p)*i,jr),g=m>l;m>Pr&&m<l/2?(e.changes.forEach((({id:e})=>o.deleteInstance(e))),o.instances.forEach((({geometry:e})=>d.push(e))),this._vaoCache.deleteVao(o.vao),v(c.buffers,o)):g?this._applyAndRebuild(o,d,e):this._applyRemoves(o,e)})),d.length>0)for(n(c)&&(c=new vr(h.origin),r.set(t,c)),c.buffers.forEach((e=>this._applyAdds(e,d)));d.length>0;)c.buffers.push(this._applyAndRebuild(new wr,d,null))}))}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.buffers.forEach((e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,i(e.instances,(t=>(e.updateDrawState(t),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees))),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees}))}))}_applyAndRebuild(e,t,s){if(o(s))for(const t of s.changes)e.deleteInstance(t.id);const r=this._bufferWriter,i=r.vertexBufferLayout.stride,a=i/4,n=Math.floor(jr/a);let h=e.numElements;for(;t.length>0;){const s=t.pop(),i=r.elementCount(s.geometry);if(h+i>n&&h>0){t.push(s);break}h+=i;const a=new fr(s,0,0);xe(null==e.instances.get(s.id)),e.addInstance(s.id,a)}const d=h*a,c=Vr(d),l=r.vertexBufferLayout.createView(c.buffer);let u=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach(((t,s)=>{this._writeGeometry(t.geometry,l,u);const i=u;u+=r.elementCount(t.geometry.geometry),e.updateInstance(s,i,u),e.updateDrawState(t)})),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Nr(d)),e.vao.vertexBuffers.geometry.setSubData(c,0,0,u*a),Ur(),e.holes.clear();const p=e.holes.pushNew();return p.from=u,p.to=Math.floor(e.vao.size/i),e.updateDrawCommands(i),e}_applyRemoves(e,t){if(0===t.changes.length)return;for(const s of t.changes){const t=s.id,r=e.instances.get(t);if(!r)continue;e.deleteInstance(t);const i=Ir.back();if(i){if(i.to===r.from){i.to=r.to;continue}if(i.from===r.to){i.from=r.from;continue}}const a=Ir.pushNew();a.from=r.from,a.to=r.to}_r(Ir);const s=this._bufferWriter.vertexBufferLayout.stride/4,r=Ir.reduce(((e,t)=>Math.max(e,t.numElements)),0)*s,i=Vr(r);i.fill(0,0,r);const a=e.vao.vertexBuffers.geometry;Ir.forAll((e=>a.setSubData(i,e.from*s,0,e.numElements*s))),Ur(),e.holes.pushArray(Ir.data,Ir.length),Ir.forAll(((e,t)=>Ir.data[t]=null)),Ir.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(0===t.length)return;if(!function(e){return o(e.vao)}(e))return void this._applyAndRebuild(e,t,null);const s=this._bufferWriter,r=s.vertexBufferLayout.stride/4,i=e.numElements,a=t.reduce(((e,t)=>e+s.elementCount(t.geometry)),0),h=Math.min((i+a)*r,jr),d=4*h;if(e.vao.size<Nr(jr-Pr)&&d>e.vao.size)return void this._applyAndRebuild(e,t,null);_r(e.holes);const c=new Array;for(const r of t){const t=s.elementCount(r.geometry),i=Er(e.holes,t);c.push(i)}const l=e.vao.vertexBuffers.geometry;let u=0,p=0,m=0;const g=Vr(h),_=s.vertexBufferLayout.createView(g.buffer);t.forEach(((t,i)=>{const a=c[i];if(n(a))return;if(m!==a){const e=m-p;e>0&&l.setSubData(g,p*r,0,e*r),p=a,u=0}const o=s.elementCount(t.geometry);this._writeGeometry(t,_,u),u+=o,m=a+o;const h=new fr(t,a,a+o);xe(null==e.instances.get(t.id)),e.addInstance(t.id,h),e.drawCommandsDirty=!0}));const f=m-p;f>0&&l.setSubData(g,p*r,0,f*r),x(t,((e,t)=>n(c[t]))),Ur()}_writeGeometry(e,t,s){const r=e.localOrigin.vec3;Oe(Ar,-r[0],-r[1],-r[2]);const i=C(Mr,Ar,e.transformation);O(Dr,i),A(Dr,Dr),this._bufferWriter.write(i,Dr,e.geometry,t,s)}updateAnimation(e){return this.material.update(e)}requiresSlot(e,t){return this.material.requiresSlot(e,t)}prepareTechnique(e){const{output:t,bindParameters:s}=e;if(!this.requiresSlot(s.slot,t))return null;const r=t===ge.Highlight||t===ge.ShadowHighlight;if(r&&!this._hasHighlights)return null;const i=t===ge.ShadowExcludeHighlight,a=!(r||i);this._appleAmdDriverHelper?.resetIndicesType();for(const n of this._dataByOrigin.values())for(const h of n.buffers){if(r&&!h.hasHighlights)continue;const n=(r?h.drawCommandsHighlight:i&&h.needsMultipleCommands()?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,d=a&&h.drawCommandsOccludees||null;if(n?.length||d?.length){const r=this._glMaterials.load(e.rctx,s.slot,t),i=o(r)?r.beginSlot(s):null;if(o(i))return i}}return null}render(e,t){const{output:s,bindParameters:r}=e,i=s===ge.Highlight||s===ge.ShadowHighlight,a=s===ge.ShadowExcludeHighlight,n=!(i||a),o=this._rctx;this._appleAmdDriverHelper?.resetIndicesType(),o.bindTechnique(t,this.material.parameters,r);for(const e of this._dataByOrigin.values())for(const s of e.buffers){if(i&&!s.hasHighlights)continue;const h=(i?s.drawCommandsHighlight:a&&s.needsMultipleCommands()?s.drawCommandsShadowHighlightRest:s.drawCommandsDefault)||null,d=n&&s.drawCommandsOccludees||null;(h?.length||d?.length)&&(t.program.bindDraw(new hr(e.origin),r,this.material.parameters),t.ensureAttributeLocations(s.vao),o.bindVAO(s.vao),h?.length&&(t.bindPipelineState(o,r.slot,!1),h.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))),d?.length&&(t.bindPipelineState(o,r.slot,!0),d.forAll((e=>o.drawArrays(t.primitiveType,e.first,e.count)))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class Or{constructor(e){this.origin=e,this.changes=new Array}}function Er(e,t){let s;if(!e.some((e=>!(e.numElements<t||(s=e,0)))))return null;const r=s.from;return s.from+=t,s.from>=s.to&&e.removeUnordered(s),r}const Ar=dt(),Mr=dt(),Dr=dt(),Ir=new p({allocator:e=>e||new gr,deallocator:null}),Pr=65536,Lr=4*Pr,Hr=16777216,jr=Hr/4;let Gr=new Float32Array(Pr);function Vr(e){return Gr.length<e&&(Gr=new Float32Array(e)),Gr}function Nr(e){const t=4*e;return t<Lr?Lr:Math.max(Math.min(Math.ceil(1.5*t/Lr)*Lr,Hr),t)}function Ur(){Gr=new Float32Array(2)}let Br=class extends t{constructor(e){super(e),this._pending=new Fr,this._changes=new sr,this._materialRenderers=new Map,this._sortedMaterialRenderers=new p,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return i(this._materialRenderers,(e=>e.rendersOccluded))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size&&0===this._geometries.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=ar(this._changes);let t=!1,s=!1,r=!1;return e.forEach(((e,i)=>{let a=this._materialRenderers.get(i);if(!a&&e.adds.length>0&&(a=new Cr(this.rctx,this._materialRepository,i),this._materialRenderers.set(i,a),t=!0,s=!0,r=!0),!a)return;const n=s||a.hasHighlights,o=r||a.hasWater;a.modify(e),s=s||n!==a.hasHighlights,r=r||o!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(i),a.dispose(),t=!0)})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),s&&(this._hasHighlights=i(this._materialRenderers,(e=>e.hasHighlights))),r&&(this._hasWater=i(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}addGeometries(e,t){if(0===e.length)return;const s=this._validateRenderGeometries(e);for(const e of s)this._geometries.set(e.id,e);const r=this._pending.empty;for(const e of s)this._pending.adds.add(e);r&&this.notifyChange("updating"),t===ts.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const s=this._pending.empty,r=this._pending.adds;for(const t of e)r.has(t)?(this._pending.removed.add(t),r.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t),this._geometries.delete(h(t.id));s&&!this._pending.empty&&this.notifyChange("updating"),t===ts.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const s=0===this._changes.updates.length;for(const s of e){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(s),e.updateType=t}switch(s&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case ss.TRANSFORMATION:case ss.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case ss.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((s=>t=s.updateAnimation(e)||t)),t}render(e){this._sortedMaterialRenderers.forAll((t=>{if(t.material.shouldRender(e)){const s=t.prepareTechnique(e);o(s)&&t.render(e,s)}}))}intersect(e,t,s,r,i){return this._geometries.forEach((a=>{if(r&&!r(a))return;this._intersectRenderGeometry(a,s,t,0,e,i);const n=this.rendererContext.longitudeCyclical;n&&(a.boundingSphere[0]-a.boundingSphere[3]<n.min&&this._intersectRenderGeometry(a,s,t,n.range,e,i),a.boundingSphere[0]+a.boundingSphere[3]>n.max&&this._intersectRenderGeometry(a,s,t,-n.range,e,i)),i++})),i}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,s)=>{s.insertOrder=e++,this._sortedMaterialRenderers.push(t)})),this._sortedMaterialRenderers.sort(((e,t)=>{const s=t.material.renderPriority-e.material.renderPriority;return 0!==s?s:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,s,r,i,a){if(!e.visible)return;let n=0;r+=e.transformation[12],n=e.transformation[13],Wr[0]=s[0]-r,Wr[1]=s[1]-n,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,i,Wr,((s,r,n)=>{!function(e,t,s,r,i,a,n){const o=new xt(a,n,t),h=t=>{t.set(Ct.OVERLAY,o,e.dist,e.normal,e.transformation,s,r)};if((null==i.results.min.drapedLayerOrder||s>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&h(i.results.min),i.options.store!==bt.MIN&&(null==i.results.max.drapedLayerOrder||s<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&h(i.results.max),i.options.store===bt.ALL){const e=St(i.ray);h(e),i.results.all.push(e)}}(t,n,e.material.renderPriority,a,i,e.layerUid,e.graphicUid)}),t)}_notifyGraphicGeometryChanged(e){if(n(this.drapeSource.notifyGraphicGeometryChanged))return;let t;for(const s of e){const e=s.graphicUid;o(e)&&e!==t&&(this.drapeSource.notifyGraphicGeometryChanged(e),t=e)}}_notifyGraphicVisibilityChanged(e){if(n(this.drapeSource.notifyGraphicVisibilityChanged))return;let t;for(const s of e){const e=s.graphicUid;o(e)&&e!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(e),t=e)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return n(e.localOrigin)&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};e([T()],Br.prototype,"drapeSource",void 0),e([T()],Br.prototype,"updating",null),e([T()],Br.prototype,"rctx",null),e([T()],Br.prototype,"rendererContext",void 0),e([T()],Br.prototype,"_materialRepository",null),e([T()],Br.prototype,"_localOriginFactory",null),e([T({readOnly:!0})],Br.prototype,"isEmpty",null),e([T()],Br.prototype,"_materialRenderers",void 0),e([T()],Br.prototype,"_geometries",void 0),Br=e([b("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Br);class Fr{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}const Wr=Ye();class zr extends Vt{initializeProgram(e){return new Nt(e.rctx,zr.shader.get().build(),Le)}initializePipeline(){return this.configuration.hasAlpha?Bt({blending:zt(de.SRC_ALPHA,de.ONE,de.ONE_MINUS_SRC_ALPHA,de.ONE_MINUS_SRC_ALPHA),colorWrite:Wt}):Bt({colorWrite:Wt})}}zr.shader=new Gt(_e,(()=>import("./TextureOnly.glsl.js").then((e=>e.a))));class qr extends we{constructor(){super(...arguments),this.hasAlpha=!1}}e([Te()],qr.prototype,"hasAlpha",void 0);let kr=class extends t{get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._handles=new r,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new p,this._passParameters=new fe,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this._camera=new Re,this.worldToPCSRatio=1,this.events=new s,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView,t=e.waterTextureRepository;this._stippleTextureRepository=new Yt(e.renderingContext),this._shaderTechniqueRepository=new us({rctx:this._rctx,viewingMode:B.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._renderContext=new vs(this._rctx,new Es(this._rctx,this.view.state.viewingMode),new rt(this.view,this._shaderTechniqueRepository,this._rctx,(()=>{}))),this._handles.add([g((()=>t.updating),(()=>this.events.emit("content-changed")),_),g((()=>this.spatialReference),(e=>this._localOriginFactory=new ws(e)),_),f((()=>this.view.allLayerViews),"after-changes",(()=>this._sortedDrapeSourceRenderersDirty=!0))]),this._materialRepository=new _s(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&Qr)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")}),(()=>this.events.emit("content-changed"))),this._bindParameters.slot=et.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=W(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=tt.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new it(P(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(Xt.STAGE,this))}destroy(){this._handles.destroy(),this._renderers.forEach((e=>e.destroy())),this._renderers.clear(),this._debugTextureTechnique=d(this._debugTextureTechnique),this._passParameters.texture=a(this._passParameters.texture),this._bindParameters.highlightDepthTexture=a(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=c(this._shaderTechniqueRepository),this._temporaryFBO=a(this._temporaryFBO),this._quadVAO=a(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedDrapeSourceRenderersDirty||i(this._renderers,(e=>e.updating))}get hasOverlays(){return o(this._overlays)&&o(this._overlayRenderTarget)}get gpuMemoryUsage(){return o(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Br)}createDrapeSourceRenderer(e,t,s){const r=this._renderers.get(e);o(r)&&r.destroy();const i=new t({...s,rendererContext:this,drapeSource:e});return this._renderers.set(e,i),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(g((()=>e.fullOpacity),(()=>this.events.emit("content-changed"))),e),i}removeDrapeSourceRenderer(e){if(n(e))return;const t=this._renderers.get(e);n(t)||(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),t.destroy())}collectUnusedRenderTargetMemory(e){let t=!1;if(o(this._overlayRenderTarget))for(const s of this._overlayRenderTarget.renderTargets){const[r,i]=this.overlays,a=r.validTargets[s.type]||!i.validTargets[s.type];t=this._overlayRenderTarget.validateUsageForTarget(a,s,e)||t}return t}get overlays(){return l(this._overlays,[])}ensureDrapeTargets(e){o(this._overlays)&&this._overlays.forEach((t=>t.hasTargetWithoutRasterImage=w(e,(e=>e.drapeTargetType===es.WithoutRasterImage))))}ensureDrapeSources(e){o(this._overlays)&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=w(e,(e=>e.drapeSourceType===Jt.Features)),t.hasDrapedRasterSource=w(e,(e=>e.drapeSourceType===Jt.RasterImage))}))}ensureOverlays(e,t){n(this._overlays)&&(this._overlayRenderTarget=new cs(this._rctx),this._overlays=[new ns(Y.INNER,this._overlayRenderTarget),new ns(Y.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=a(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e){this._processDrapeSources(e,(()=>!0))}_processDrapeSources(e,t){let s=!1;for(const[r,i]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&i.commitChanges()&&(s=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,s=!0,this._updateSortedDrapeSourceRenderers()),s&&(o(this._overlays)&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources($t,(e=>e.updatePolicy===qe.SYNC))}get isEmpty(){return!z.OVERLAY_DRAW_DEBUG_TEXTURE&&!i(this._renderers,(e=>!e.isEmpty))}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._renderers.forEach((s=>t=s.updateAnimation(e)||t)),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawTarget(e,t,s){const r=e.canvasGeometries;if(0===r.numViews)return!1;this._screenToWorldRatio=s*e.mapUnitsPerPixel;const i=t.output;if(this.isEmpty||i===ge.Highlight&&!this.hasHighlights||i===ge.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;const a=t.fbo;if(!a.isValid())return!1;const n=2*e.resolution,h=e.resolution;a.resize(n,h);const d=this._rctx;if(this._camera.pixelRatio=e.pixelRatio*s,this._renderContext.output=i,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=i===ge.Normal?et.DRAPED_WATER:et.DRAPED_MATERIAL,e.applyViewport(this._rctx),a.bind(d),e.index===Y.INNER&&(d.setClearColor(0,0,0,0),d.clearSafe(oe.COLOR_BUFFER_BIT)),t.type===k.Occluded&&(this._renderContext.renderOccludedMask=Qr),z.OVERLAY_DRAW_DEBUG_TEXTURE&&t.type!==k.Occluded)for(let t=0;t<r.numViews;t++)this._setViewParameters(r.extents[t],e),this._drawDebugTexture(e.resolution,Xr[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll((({drapeSource:s,renderer:c})=>{if(t.type===k.ColorNoRasterImage&&s.drapeSourceType===Jt.RasterImage)return;const{fullOpacity:l}=s,u=o(l)&&l<1&&i===ge.Color;u&&(this.bindTemporaryFramebuffer(this._rctx,n,h),d.clearSafe(oe.COLOR_BUFFER_BIT));for(let t=0;t<r.numViews;t++)this._setViewParameters(r.extents[t],e),c.render(this._renderContext);u&&o(this._temporaryFBO)&&(a.bind(d),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),l,e.index))})),d.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,s){n(this._temporaryFBO)&&(this._temporaryFBO=new hs(e,!1)),this._temporaryFBO.resize(t,s),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,s,r){let i=0;for(const a of this._renderers.values())i=a.intersect?.(e,t,s,r,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this.view.map.allLayers;this._renderers.forEach(((t,s)=>{const r=e.indexOf(s.layer),i=r>=0,a=this._renderers.size*(s.renderGroup??(i?Kt.MapLayer:Kt.ViewLayer))+(i?r:0);this._sortedRenderers.push(new Yr(s,t,a))})),this._sortedRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t){const s=this._camera;s.viewport=[0,0,t.resolution,t.resolution],M(s.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],s.near,s.far),D(s.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=i(this._renderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=i(this._renderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=i(this._renderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,e,t);const s=this._rctx;s.bindTechnique(this._debugTextureTechnique,this._passParameters,null),s.bindVAO(this._quadVAO),s.drawArrays(ce.TRIANGLE_STRIP,0,me(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t,s){if(U(this._passParameters.color,s[0],s[1],s[2]),this._passParameters.texture)return;const r=new Uint8Array(e*t*4);let i=0;for(let s=0;s<t;s++)for(let a=0;a<e;a++){const n=Math.floor(a/10),o=Math.floor(s/10);n<2||o<2||10*n>e-20||10*o>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&n&&1&o?1&a^1&s?0:255:1&n^1&o?0:128)}this._passParameters.texture=new vt(this._rctx,{target:se.TEXTURE_2D,pixelFormat:re.RGBA,dataType:ie.UNSIGNED_BYTE,samplingMode:ne.NEAREST,width:e,height:t},r);const a=new qr;a.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(zr,a),this._quadVAO=q(this._rctx)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};e([T()],kr.prototype,"_sortedDrapeSourceRenderersDirty",void 0),e([T({autoDestroy:!0})],kr.prototype,"_shaderTechniqueRepository",void 0),e([T({autoDestroy:!0})],kr.prototype,"_stippleTextureRepository",void 0),e([T({constructOnly:!0})],kr.prototype,"view",void 0),e([T()],kr.prototype,"worldToPCSRatio",void 0),e([T()],kr.prototype,"spatialReference",void 0),e([T({type:Boolean,readOnly:!0})],kr.prototype,"updating",null),e([T()],kr.prototype,"isEmpty",null),kr=e([b("esri.views.3d.terrain.OverlayRenderer")],kr);class Yr{constructor(e,t,s){this.drapeSource=e,this.renderer=t,this.index=s}}const Xr=[[1,.5,.5],[.5,.5,1]],$r=-2,Qr=Pe.OccludeAndTransparent;class Zr{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=dt(),this._shaderTransformation=null,this._shaderTransformationDirty=!0,this._boundingSphere=Qt(),this._boundingSphereDirty=!0,this.id=y(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.shaderTransformer=t.shaderTransformer,this.castShadow=t.castShadow??!1}get transformation(){return this._transformation}get boundingInfo(){return this.geometry.boundingInfo}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=this._boundingSphereDirty=!0}shaderTransformationChanged(){this._shaderTransformationDirty=!0}get boundingSphere(){return!this._boundingSphereDirty||n(this.boundingInfo)||(N(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*Zt(this.shaderTransformation),this._boundingSphereDirty=!1),this._boundingSphere}get hasShaderTransformation(){return o(this.shaderTransformer)}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return n(this.shaderTransformer)?this.transformation:(!this._shaderTransformationDirty&&this._shaderTransformation||(this._shaderTransformation=I(this._shaderTransformation||dt(),this.shaderTransformer(this.transformation)),this._shaderTransformationDirty=!1),this._shaderTransformation)}get indices(){return this.geometry.indices}get vertexAttributes(){return this.geometry.vertexAttributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}export{Rs as B,sr as C,$r as D,ws as G,Cr as M,kr as O,Zr as R,Br as S,zr as T,pr as W,Jt as a,Kt as b,ts as c,rs as d,hr as e,as as f,ss as g,Es as h,Cs as i,xs as j,qr as k,us as l,_s as m,or as n,Qr as o,ur as p,es as q,ar as s,ys as t};
