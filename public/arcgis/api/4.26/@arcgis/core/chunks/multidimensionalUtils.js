/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{i as e,a as n}from"./maybe.js";import t from"../layers/support/DimensionalDefinition.js";function a(e,n,t){const i=n.shift();if(0===t.length){const e=[];t.push({sliceId:-1,multidimensionalDefinition:e})}const s=t.length;for(let n=0;n<s;n++){const n=t.shift().multidimensionalDefinition;i.values?.forEach((a=>{t.push({sliceId:-1,multidimensionalDefinition:[...n,{variableName:e,dimensionName:i.name,values:[a]}]})}))}n.length&&a(e,n,t)}function i(e,n){const t=[];let i=0;return(n?e.variables.filter((e=>e.name.toLowerCase()===n.toLowerCase())):[...e.variables].sort(((e,n)=>e.name>n.name?1:-1))).forEach((e=>{const n=[],s=[...e.dimensions].sort(((e,n)=>e.name>n.name?-1:1));a(e.name,s,n),n.forEach((e=>{t.push({...e,sliceId:i++})}))})),t}function s(n,t,a){let i=n;if(t&&(t=[...t].sort(((e,n)=>e.dimensionName<n.dimensionName?-1:1))).forEach((({dimensionName:e,values:n,isSlice:t})=>{n.length&&(i=i.filter((a=>{const i=a.multidimensionalDefinition.find((n=>n.dimensionName===e));if(null==i)return!1;const s=i.values[0];return"number"==typeof s?"number"==typeof n[0]?n.includes(s):n.some((e=>e[0]<=s&&e[1]>=s)):"number"==typeof n[0]?n.some((e=>s[0]<=e&&s[1]>=e)):t?n.some((e=>e[0]===s[0]&&e[0]===s[1])):n.some((e=>e[0]>=s[0]&&e[0]<=s[1]||e[1]>=s[0]&&e[1]<=s[1]||e[0]<s[0]&&e[1]>s[1]))})))})),i.length&&a&&e(a.start)&&e(a.end)){const e=a.start.getTime(),n=a.end.getTime(),t=i[0].multidimensionalDefinition.findIndex((e=>"StdTime"===e.dimensionName));t>-1&&(i=i.filter((a=>{const i=a.multidimensionalDefinition[t].values[0];return e<=i&&n>=i})))}return i.map((e=>e.sliceId))}function r(e,n){return Array.isArray(e)?n[0]===n[1]?e[0]===n[0]||e[1]===n[0]:e[0]>=n[0]&&e[0]<=n[1]&&e[1]>=n[0]&&e[1]<=n[1]:e>=n[0]&&e<=n[1]}function l(e,n){return e[0]<=n[0]&&e[1]>=n[0]||e[0]<=n[1]&&e[1]>=n[1]||e[0]>=n[0]&&e[1]<=n[1]}function o(e){return 1===e.length?[e[0],e[0]]:[e[0],e[e.length-1]]}function u(e,n,t){if(!n?.subsetDefinitions?.length)return e;let a;if(t){const{variables:i}=n;if(i.length&&!i.includes(t))return null;const s=n.subsetDefinitions.find((n=>n.dimensionName===e.name&&n.variableName===t));if(!s?.values?.length)return e;a=o(s.values)}else{const t=n.dimensions.find((({name:n})=>n===e.name));a=t?.extent}const i=a;if(!i||!i?.length)return e;const s=e.values.filter((e=>r(e,i)));return{...e,extent:[...i],values:s}}function m(e,n,t){if(!n?.subsetDefinitions?.length)return!1;const{variables:a}=n;if(a.length&&e.some((({variableName:e})=>e&&!a.includes(e))))return!0;for(let a=0;a<e.length;a++){const i=e[a],s=n.subsetDefinitions.find((e=>(""===i.variableName||e.variableName===i.variableName)&&e.dimensionName===i.dimensionName));if(s?.values.length){const e=o(s.values);if(i.isSlice||2!==i.values.length||Array.isArray(i.values[0])||i.values[0]===i.values[1]||!t){if(i.values.some((n=>!r(n,e))))return!0}else if(!l(i.values,e))return!0}}return!1}function c(a,i){if(n(a))return{isOutside:!1};const{geometry:s,timeExtent:r,multidimensionalDefinition:l}=i;let o=null;if(e(r)&&(o=function(e,a){const i=e.dimensions.find((({name:e})=>"StdTime"===e));if(null==i||n(a.start)&&n(a.end))return a;a=a.clone();const{start:s,end:r}=a.toJSON(),l=s===r?[s]:null!=s&&null!=r?[s,r]:[s??r];return 2===l.length&&i?.extent.length&&(l[0]=Math.max(l[0],i.extent[0]),l[1]=Math.min(l[1],i.extent[1]??i.extent[0]),l[1]<l[0])||m([new t({variableName:"",dimensionName:"StdTime",isSlice:1===l.length,values:l})],e,!0)?null:(a.start=new Date(l[0]),a.end=new Date(l[1]??l[0]),a)}(a,r),n(o)))return{isOutside:!0};const{areaOfInterest:u}=a;if(u&&s){const e="point"===s.type?s:"extent"===s.type?s.center:"polygon"===s.type?s.centroid:null;if(e&&!u.contains(e))return{isOutside:!0}}return e(l)&&l.length&&m(l,a,!0)?{isOutside:!0}:{isOutside:!1,intersection:{geometry:s,timeExtent:o,multidimensionalDefinition:l}}}function f(t,a={}){const{multidimensionalInfo:i,keyProperties:s}=t;if(n(i))return null;const{variableName:r,multidimensionalSubset:l,multidimensionalDefinition:o}=a,u=e(o)?o[0]?.variableName:null,m=r||u||s?.DefaultVariable;let{variables:c}=i;return l?.variables?.length&&(c=c.filter((({name:e})=>l.variables.includes(e)))),m?c.find((({name:e})=>e===m))??c[0]:c[0]}function d(e,n={}){const a=f(e,n);if(!a)return null;const i=[],{dimensions:s,name:r}=a;if(0===s.length)return[new t({variableName:r,dimensionName:"",values:[],isSlice:!0})];for(let e=0;e<s.length;e++){const a=u(s[e],n.multidimensionalSubset,r);if(!a)return null;const{values:l,extent:o}=a;let m=l?.[0]??o[0];"stdz"===a.name.toLowerCase()&&!a.hasRanges&&Math.abs(o[1])<=Math.abs(o[0])&&(m=l?.length?l[l.length-1]:o[1]),i.push(new t({variableName:r,dimensionName:a.name,values:[m],isSlice:!n.useRangeForRangedDimensionInfo||!!a.hasRanges}))}return i}function h(e){return!(n(e)||!e.length)&&e.some((e=>{if(null==e.values)return!0;const n=e.values.length;return 0===n||n>1||!e.isSlice&&Array.isArray(e.values[0])}))}function g(t,a){if(n(a)||n(t))return null;let i=a.variables.map((e=>({...e})));return t?.variables?.length&&(i=i.filter((({name:e})=>t.variables.includes(e))),i.forEach((n=>{n.dimensions=n.dimensions.map((e=>u(e,t,n.name))).filter(e)}))),i}function v(e,n){const{values:t}=n;if(t?.length)return Array.isArray(t[0])!==Array.isArray(e)?-1:Array.isArray(t[0])?t.findIndex((n=>n[0]===e[0]&&n[1]===e[1])):t.indexOf(e);const{extent:a}=n;if(Array.isArray(e)||e<a[0]||e>a[1])return-1;const i=n.interval||1;if("ISO8601"!==n.unit)return Math.round((e-a[0])/i);const s=a[0];let r=-1;switch(n.intervalUnit?.toLowerCase()||"seconds"){case"seconds":r=Math.round((e-s)/1e3/i);break;case"minutes":r=Math.round((e-s)/6e4/i);break;case"hours":r=Math.round((e-s)/36e5/i);break;case"days":r=Math.round((e-s)/864e5/i);break;case"months":{const n=new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear(),t=new Date(s).getUTCMonth(),a=new Date(e).getUTCMonth();r=0===n?a-t:a+11-t+12*(n-1)}break;case"years":r=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/i);break;case"decades":r=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/i)}return r}function b(e){let n=e.values?.length;if(n)return n;const{extent:t,unit:a}=e,i=e.interval||1,s=t?t[1]-t[0]:0;if("ISO8601"!==a)return Math.round(s/i);switch(e.intervalUnit?.toLowerCase()??"seconds"){case"seconds":n=Math.round(s/1e3/i);break;case"minutes":n=Math.round(s/6e4/i);break;case"hours":n=Math.round(s/36e5/i);break;case"days":n=Math.round(s/864e5/i);break;case"months":{const e=new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear(),a=new Date(t[1][0]).getUTCMonth(),i=new Date(t[1][1]).getUTCMonth();n=0===e?i-a+1:i+11-a+12*(e-1)+1}break;case"years":n=Math.round((new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear())/i);break;case"decades":n=Math.round((new Date(t[1]).getUTCFullYear()-new Date(t[0]).getUTCFullYear())/10/i);break;default:n=0}return n}function D(e,n){let t=0;const a=e[0].variableName,i=[...n.variables].sort(((e,n)=>e.name>n.name?1:-1));for(let n=0;n<i.length;n++){const s=i[n],r=[...s.dimensions].sort(((e,n)=>e.name>n.name?-1:1));if(s.name!==a){t+=r.map((e=>b(e))).reduce(((e,n)=>e*n));continue}const l=r.map((e=>b(e))),o=r.length;for(let n=0;n<o;n++){const a=e.find((e=>e.dimensionName===r[n].name));if(null==a)return null;const i=v(a.values[0],r[n]);if(-1===i)return null;l.shift(),t+=n===o-1?i:i*l.reduce(((e,n)=>e*n))}break}return t}export{d as a,h as b,D as c,i as d,s as e,f,g,m as h,c as i};
