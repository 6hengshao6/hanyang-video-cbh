/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{e as t,g as r,a as i,b as n}from"../geometry/Extent.js";import{isPolygon as s,isExtent as o,getJsonType as l}from"../geometry/support/jsonUtils.js";import{n as a}from"./unitUtils.js";import{h as u}from"./featureConversionUtils.js";import{O as p}from"./OptimizedFeature.js";import{c}from"./projectionSupport.js";import{g as f}from"./utils9.js";function m(e,t){return e?t?4:3:t?3:2}function y(e,t,r,i,n){if(!e)return!1;const s=m(t,r),{coords:o,lengths:l}=e;let a=!1,u=0;for(const e of l)a=R(a,o,s,u,e,i,n),u+=e*s;return a}function R(e,t,r,i,n,s,o){let l=e,a=i;for(let e=i,u=i+n*r;e<u;e+=r){a=e+r,a===u&&(a=i);const n=t[e],p=t[e+1],c=t[a],f=t[a+1];(p<o&&f>=o||f<o&&p>=o)&&n+(o-p)/(f-p)*(c-n)<s&&(l=!l)}return l}const S="feature-store:unsupported-query",g={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},d={spatialRelationship:{esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},queryGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},layerGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1}};function h(e,l,a,c,R){if(s(l)&&"esriGeometryPoint"===a&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=u(new p,l,!1,!1);return Promise.resolve((t=>function(e,t,r,i){return y(e,!1,!1,i.coords[0],i.coords[1])}(e,0,0,t)))}if(s(l)&&"esriGeometryMultipoint"===a){const t=u(new p,l,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>function(e,t,r,i,n,s){const o=m(n,s),{coords:l,lengths:a}=i;if(!a)return!1;for(let t=0,r=0;t<a.length;t++,r+=o)if(!y(e,!1,!1,l[r],l[r+1]))return!1;return!0}(t,0,0,e,c,R)))}if(o(l)&&"esriGeometryPoint"===a&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>i(l,f(a,c,R,e))));if(o(l)&&"esriGeometryMultipoint"===a&&"esriSpatialRelContains"===e)return Promise.resolve((e=>n(l,f(a,c,R,e))));if(o(l)&&"esriSpatialRelIntersects"===e){const e=function(e){return"mesh"===e?t:r(e)}(a);return Promise.resolve((t=>e(l,f(a,c,R,t))))}return import("./geometryEngineJSON.js").then((e=>e.g)).then((t=>{const r=t[g[e]].bind(null,l.spatialReference,l);return e=>r(f(a,c,R,e))}))}async function I(t,r,i){const{spatialRel:n,geometry:s}=t;if(s){if(null==(o=n)||!0!==d.spatialRelationship[o])throw new e(S,"Unsupported query spatial relationship",{query:t});var o;if(a(s.spatialReference)&&a(i)){if(!function(e){return null!=e&&!0===d.queryGeometry[l(e)]}(s))throw new e(S,"Unsupported query geometry type",{query:t});if(!function(e){return null!=e&&!0===d.layerGeometry[e]}(r))throw new e(S,"Unsupported layer geometry type",{query:t});if(t.outSR)return c(t.geometry&&t.geometry.spatialReference,t.outSR)}}}function G(e){if(o(e))return!0;if(s(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}async function v(e,t){if(!e)return null;const r=t.featureAdapter,{startTimeField:i,endTimeField:n}=e;let s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;if(i&&n)await t.forEach((e=>{const t=r.getAttribute(e,i),l=r.getAttribute(e,n);null==t||isNaN(t)||(s=Math.min(s,t)),null==l||isNaN(l)||(o=Math.max(o,l))}));else{const e=i||n;await t.forEach((t=>{const i=r.getAttribute(t,e);null==i||isNaN(i)||(s=Math.min(s,i),o=Math.max(o,i))}))}return{start:s,end:o}}function b(e,t,r){if(!t||!e)return null;const{startTimeField:i,endTimeField:n}=e;if(!i&&!n)return null;const{start:s,end:o}=t;return null===s&&null===o?null:void 0===s&&void 0===o?()=>!1:i&&n?function(e,t,r,i,n){return null!=i&&null!=n?s=>{const o=e.getAttribute(s,t),l=e.getAttribute(s,r);return(null==o||o<=n)&&(null==l||l>=i)}:null!=i?t=>{const n=e.getAttribute(t,r);return null==n||n>=i}:null!=n?r=>{const i=e.getAttribute(r,t);return null==i||i<=n}:void 0}(r,i,n,s,o):function(e,t,r,i){return null!=r&&null!=i&&r===i?i=>e.getAttribute(i,t)===r:null!=r&&null!=i?n=>{const s=e.getAttribute(n,t);return s>=r&&s<=i}:null!=r?i=>e.getAttribute(i,t)>=r:null!=i?r=>e.getAttribute(r,t)<=i:void 0}(r,i||n,s,o)}export{h as a,b,G as c,I as d,v as g};
