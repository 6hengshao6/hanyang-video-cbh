/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{i as e,a as t,d as s}from"./maybe.js";import{j as i,m as r,k as a}from"./mat4.js";import{c as o}from"./mat4f64.js";import{A as n,e as h,D as c,f as l,s as m,a as d,j as u,c as p,d as _,b as f,m as b,g,l as T}from"./vec3.js";import{c as A,a as v}from"./sphere.js";import{b as O}from"./mathUtils2.js";import{O as S}from"./basicInterfaces.js";import{a as E,C as y,b as R,R as I,i as L}from"./Material.js";import{O as j,b as P,r as C,s as N,c as U,d as x,e as M,f as D,g as w,h as V,i as B,G as W}from"./DefaultBufferWriter.js";import{a as F,i as G}from"./Util2.js";import J from"../core/Evented.js";import H from"../core/Handles.js";import{P as z}from"../core/scheduling.js";import{O as k}from"./Octree.js";import{h as X}from"./typedArrayUtil.js";import{L as Y}from"./Logger.js";import{c as Z}from"./mathUtils.js";import{b as Q}from"./screenUtils.js";import{k as q}from"./vec2.js";import{O as K}from"./vec4f64.js";import{P as $}from"./frustum.js";import{c as ee,d as te,f as se,a as ie}from"./lineSegment.js";import{c as re,d as ae,s as oe,n as ne}from"./plane.js";import{n as he}from"./InterleavedLayout.js";import{S as ce}from"./ShaderOutput.js";import{R as le}from"./RenderSlot.js";import{V as me}from"./VertexAttribute.js";import{V as de}from"./glUtil3D.js";import{L as ue}from"./MarkerSizing.glsl.js";import{R as pe,a as _e,C as fe,b as be}from"./RibbonLine.glsl.js";import{S as ge,P as Te,R as Ae}from"./Program2.js";import{c as ve,o as Oe,a as Se,b as Ee,O as ye}from"./OrderIndependentTransparency.js";import{T as Re}from"./TransparencyPassType.js";import{d as Ie}from"./enums3.js";import{m as Le,d as je,a as Pe}from"./renderState.js";class Ce extends E{get geometries(){return this._geometries}get transformation(){return this._transformation}set transformation(e){i(this._transformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}constructor(t={}){super(),this.type=y.Object,this._geometries=new Array,this._transformation=o(),this._bvObjectSpace=new Ue,this._bvWorldSpace=new Ue,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==t.castShadow||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new Ne);const s=t.geometries;e(s)&&(this._geometries=Array.from(s))}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){F(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._hasVolatileTransformation=this._hasVolatileTransformation||e.hasVolatileTransformation,this._emit("objectGeometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("objectGeometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("objectGeometryUpdated",{object:this,geometry:e}),this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometries)e.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new j(S.MaskOccludee);for(const t of this._geometries)t.occludees=P(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=C(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new j(S.Highlight);for(const t of this._geometries)t.highlights=P(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=C(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return r(t,this.transformation,e.transformation)}_getCombinedShaderTransformation(e){return r(o(),this.transformation,e.shaderTransformation)}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(const t of this._geometries){const s=t.boundingInfo;e(s)&&(xe(s,this._bvObjectSpace,t.shaderTransformation),xe(s,this._bvWorldSpace,this._getCombinedShaderTransformation(t)))}n(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),n(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const s=_(),i=_(),r=O(this.transformation);for(const e of this._geometries){const a=e.boundingInfo;if(t(a))continue;const o=e.shaderTransformation,n=O(o);h(s,a.center,o);const l=c(s,this._bvObjectSpace.bounds),m=a.radius*n;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+m),h(i,s,this.transformation);const d=c(i,this._bvWorldSpace.bounds),u=m*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],d+u)}this._bvDirty=!1}_invalidateBoundingVolume(){this._bvDirty=!0,e(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(t,s){e(this._parentLayer)&&this._parentLayer.events.emit(t,s)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}}class Ne{constructor(){this.min=l(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=l(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Ue extends Ne{constructor(){super(...arguments),this.bounds=A()}init(){m(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),m(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),v(this.bounds)}}function xe(e,t,s){const i=e.bbMin,r=e.bbMax;if(a(s)){const e=m(Me,s[12],s[13],s[14]);d(De,i,e),d(we,r,e);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],De[e]),t.max[e]=Math.max(t.max[e],we[e])}else if(h(De,i,s),u(i,r))for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],De[e]),t.max[e]=Math.max(t.max[e],De[e]);else{h(we,r,s);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],De[e],we[e]),t.max[e]=Math.max(t.max[e],De[e],we[e]);for(let e=0;e<3;++e){p(De,i),p(we,r),De[e]=r[e],we[e]=i[e],h(De,De,s),h(we,we,s);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],De[e],we[e]),t.max[e]=Math.max(t.max[e],De[e],we[e])}}}const Me=_(),De=_(),we=_();var Ve;!function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(Ve||(Ve={}));const Be=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","objectGeometryUpdated"];class We extends E{get objects(){return this._objects}constructor(e,t=""){super(),this.apiLayerUid=t,this.type=y.Layer,this.events=new J,this.sliceable=!1,this._objects=new z,this._objectsAdded=new z,this._stageHandles=new H,this.apiLayerUid=t,this.visible=e?.visible??!0,this.pickable=e?.pickable??!0,this.updatePolicy=e?.updatePolicy??Ve.ASYNC,this._disableOctree=e?.disableOctree??!1}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of Be)this._stageHandles.add(this.events.on(t,(s=>e.handleEvent(t,s))))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(t){this._objects.push(t),t.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:t}),e(this._octree)&&this._objectsAdded.push(t)}remove(t){this._objects.removeUnordered(t)&&(t.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:t}),e(this._octree)&&(this._objectsAdded.removeUnordered(t)||this._octree.remove([t])))}addMany(t){this._objects.pushArray(t);for(const e of t)e.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:t}),e(this._octree)&&this._objectsAdded.pushArray(t)}removeMany(t){const s=new Array;if(this._objects.removeUnorderedMany(t,t.length,s),0!==s.length){for(const e of s)e.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:s}),e(this._octree)){for(let e=0;e<s.length;)this._objectsAdded.removeUnordered(s[e])?(s[e]=s[s.length-1],s.length-=1):++e;this._octree.remove(s)}}}sync(){e(this._stage)&&this.updatePolicy!==Ve.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(t,s){e(this._octree)&&!this._objectsAdded.includes(t)&&this._octree.update(t,s)}getSpatialQueryAccelerator(){return t(this._octree)&&this._objects.length>50&&!this._disableOctree?(this._octree=new k((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)):e(this._octree)&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=s(this._octree),this._objectsAdded.clear()}}function Fe(t){return e(t)&&t.type===y.Layer}const Ge=new Map([[me.POSITION,0],[me.SUBDIVISIONFACTOR,1],[me.UV0,2],[me.AUXPOS1,3],[me.AUXPOS2,4],[me.COLOR,5],[me.COLORFEATUREATTRIBUTE,5],[me.SIZE,6],[me.SIZEFEATUREATTRIBUTE,6],[me.OPACITYFEATUREATTRIBUTE,7],[me.OBJECTANDLAYERIDCOLOR,8]]);class Je extends ge{initializeProgram(e){return new Te(e.rctx,Je.shader.get().build(this.configuration),Ge)}_makePipelineState(e,t){const s=this.configuration,i=e===Re.NONE,r=e===Re.FrontFace;return Le({blending:s.output===ce.Color||s.output===ce.Alpha?i?ve:Oe(e):null,depthTest:{func:Se(e)},depthWrite:i?s.writeDepth?je:null:Ee(e),colorWrite:Pe,stencilWrite:s.hasOccludees?N:null,stencilTest:s.hasOccludees?t?U:x:null,polygonOffset:i||r?s.hasPolygonOffset?He:null:ye})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?He:null;this._occluderPipelineTransparent=Le({blending:ve,polygonOffset:t,depthTest:M,depthWrite:null,colorWrite:Pe,stencilWrite:null,stencilTest:D}),this._occluderPipelineOpaque=Le({blending:ve,polygonOffset:t,depthTest:M,depthWrite:null,colorWrite:Pe,stencilWrite:w,stencilTest:V}),this._occluderPipelineMaskWrite=Le({blending:null,polygonOffset:t,depthTest:B,depthWrite:null,colorWrite:null,stencilWrite:N,stencilTest:U})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Ie.LINES:Ie.TRIANGLE_STRIP}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===le.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===le.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}Je.shader=new Ae(pe,(()=>import("./RibbonLine.glsl.js").then((e=>e.R))));const He={factor:0,units:-4};var ze;!function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"}(ze||(ze={}));class ke extends R{constructor(e){super(e,new Ye),this._configuration=new _e,this._vertexAttributeLocations=Ge,this._layout=this.createLayout()}isClosed(e,t){return Ke(this.parameters,e,t)}getConfiguration(t,s){this._configuration.output=t,this._configuration.draped=s.slot===le.DRAPED_MATERIAL;const i=e(this.parameters.stipplePattern)&&t!==ce.Highlight;var r;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&e(this.parameters.stippleOffColor),this._configuration.stippleScaleWithLineWidth=i&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins="round"===this.parameters.join,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=!!e(this.parameters.markerParameters)&&(r=this.parameters.markerParameters).anchor===ue.Tip&&r.hideOnShortSegments&&"begin-end"===r.placement&&r.worldSpace,this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&e(this.parameters.innerColor),this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===I.OccludeAndTransparentStencil,this._configuration.transparencyPassType=s.transparencyPassType,this._configuration.hasMultipassTerrain=s.multipassTerrain.enabled,this._configuration.cullAboveGround=s.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,s,i,r,a){if(!s.options.selectionMode)return;const o=e.vertexAttributes.get(me.POSITION).data,n=e.vertexAttributes.get(me.SIZE);let h=this.parameters.width;if(this.parameters.vvSize){const t=e.vertexAttributes.get(me.SIZEFEATUREATTRIBUTE).data[0];h*=Z(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else n&&(h*=n.data[0]);const c=i[0],l=i[1],m=(h/2+4)*e.screenToWorldRatio;let d=Number.MAX_VALUE,u=0;for(let e=0;e<o.length-5;e+=3){const t=o[e],s=o[e+1],i=c-t,r=l-s,a=o[e+3]-t,n=o[e+4]-s,h=Z((a*i+n*r)/(a*a+n*n),0,1),m=a*h-i,p=n*h-r,_=m*m+p*p;_<d&&(d=_,u=e/3)}d<m*m&&r(a.dist,a.normal,u,!1)}intersect(e,t,s,i,r,a){if(!s.options.selectionMode||!e.visible)return;if(!G(t))return void Y.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const o=e.vertexAttributes,n=o.get(me.POSITION).data;let h=this.parameters.width;if(this.parameters.vvSize){const e=o.get(me.SIZEFEATUREATTRIBUTE).data[0];h*=Z(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o.has(me.SIZE)&&(h*=o.get(me.SIZE).data[0]);const l=s.camera,u=it;q(u,s.point);const _=h*l.pixelRatio/2+4*l.pixelRatio;m(ut[0],u[0]-_,u[1]+_,0),m(ut[1],u[0]+_,u[1]+_,0),m(ut[2],u[0]+_,u[1]-_,0),m(ut[3],u[0]-_,u[1]-_,0);for(let e=0;e<4;e++)if(!l.unprojectFromRenderScreen(ut[e],pt[e]))return;ae(l.eye,pt[0],pt[1],_t),ae(l.eye,pt[1],pt[2],ft),ae(l.eye,pt[2],pt[3],bt),ae(l.eye,pt[3],pt[0],gt);let A=Number.MAX_VALUE,v=0;const O=qe(this.parameters,o,e.indices)?n.length-2:n.length-5;for(let e=0;e<O;e+=3){$e[0]=n[e]+t[12],$e[1]=n[e+1]+t[13],$e[2]=n[e+2]+t[14];const s=(e+3)%n.length;if(et[0]=n[s]+t[12],et[1]=n[s+1]+t[13],et[2]=n[s+2]+t[14],oe(_t,$e)<0&&oe(_t,et)<0||oe(ft,$e)<0&&oe(ft,et)<0||oe(bt,$e)<0&&oe(bt,et)<0||oe(gt,$e)<0&&oe(gt,et)<0)continue;if(l.projectToRenderScreen($e,rt),l.projectToRenderScreen(et,at),rt[2]<0&&at[2]>0){f(tt,$e,et);const e=l.frustum,t=-oe(e[$.NEAR],$e)/b(tt,ne(e[$.NEAR]));g(tt,tt,t),d($e,$e,tt),l.projectToRenderScreen($e,rt)}else if(rt[2]>0&&at[2]<0){f(tt,et,$e);const e=l.frustum,t=-oe(e[$.NEAR],et)/b(tt,ne(e[$.NEAR]));g(tt,tt,t),d(et,et,tt),l.projectToRenderScreen(et,at)}else if(rt[2]<0&&at[2]<0)continue;rt[2]=0,at[2]=0;const i=te(se(rt,at,ht),u);i<A&&(A=i,p(ot,$e),p(nt,et),v=e/3)}const S=s.rayBegin,E=s.rayEnd;if(A<_*_){let e=Number.MAX_VALUE;if(ie(se(ot,nt,ht),se(S,E,ct),st)){f(st,st,S);const t=T(st);g(st,st,1/t),e=t/c(S,E)}a(e,st,v,!1)}}createLayout(){const e=he().vec3f(me.POSITION).f32(me.SUBDIVISIONFACTOR).vec2f(me.UV0).vec3f(me.AUXPOS1).vec3f(me.AUXPOS2);return this.parameters.vvSize?e.f32(me.SIZEFEATUREATTRIBUTE):e.f32(me.SIZE),this.parameters.vvColor?e.f32(me.COLORFEATUREATTRIBUTE):e.vec4f(me.COLOR),this.parameters.vvOpacity&&e.f32(me.OPACITYFEATUREATTRIBUTE),X("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(me.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Ze(this._layout,this.parameters)}requiresSlot(e,t){return!(t!==ce.Color&&t!==ce.Alpha&&t!==ce.Highlight&&t!==ce.Depth&&t!==ce.ObjectAndLayerIdColor||e!==le.DRAPED_MATERIAL&&(this.parameters.renderOccluded===I.OccludeAndTransparentStencil?e!==le.OPAQUE_MATERIAL&&e!==le.OCCLUDER_MATERIAL&&e!==le.TRANSPARENT_OCCLUDER_MATERIAL:t===ce.Color||t===ce.Alpha?e!==(this.parameters.writeDepth?le.TRANSPARENT_MATERIAL:le.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e!==le.OPAQUE_MATERIAL))}createGLMaterial(e){return new Xe(e)}validateParameters(t){"miter"!==t.join&&(t.miterLimit=0),e(t.markerParameters)&&(t.markerScale=t.markerParameters.width/t.width)}}class Xe extends W{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==ce.Color&&this._output!==ce.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(Je,e)}}class Ye extends de{constructor(){super(...arguments),this.width=0,this.color=K,this.join="miter",this.cap=fe.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class Ze{constructor(e,t){this._parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const s=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=s;break;case"round":this.numJoinSubdivisions=be+s}}_isClosed(e){return qe(this._parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.indices.get(me.POSITION).length/2+1,s=this._isClosed(e);let i=s?2:4;return i+=((s?t:t-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),i+=2,this._parameters.wireframe&&(i=2+4*(i-2)),i}write(t,s,i,r,a){const o=lt,n=mt,l=dt,d=i.vertexAttributes.get(me.POSITION).data,u=i.indices&&i.indices.get(me.POSITION),_=i.vertexAttributes.get(me.DISTANCETOSTART)?.data;u&&u.length!==2*(d.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,b=0;this._parameters.vvSize?b=i.vertexAttributes.get(me.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(me.SIZE)&&(f=i.vertexAttributes.get(me.SIZE).data[0]);let g=[1,1,1,1],T=0;this._parameters.vvColor?T=i.vertexAttributes.get(me.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(me.COLOR)&&(g=i.vertexAttributes.get(me.COLOR).data);const A=X("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null;let v=0;this._parameters.vvOpacity&&(v=i.vertexAttributes.get(me.OPACITYFEATUREATTRIBUTE).data[0]);const O=d.length/3,S=new Float32Array(r.buffer),E=X("enable-feature:objectAndLayerId-rendering")?new Uint8Array(r.buffer):null,y=this.vertexBufferLayout.stride/4;let R=a*y;const I=R;let L=0;const j=_?(e,t,s)=>L=_[s]:(e,t,s)=>L+=c(e,t),P=X("enable-feature:objectAndLayerId-rendering"),C=(t,s,i,r,a,o,n)=>{if(S[R++]=s[0],S[R++]=s[1],S[R++]=s[2],S[R++]=r,S[R++]=n,S[R++]=a,S[R++]=t[0],S[R++]=t[1],S[R++]=t[2],S[R++]=i[0],S[R++]=i[1],S[R++]=i[2],S[R++]=this._parameters.vvSize?b:f,this._parameters.vvColor)S[R++]=T;else{const e=Math.min(4*o,g.length-4);S[R++]=g[e],S[R++]=g[e+1],S[R++]=g[e+2],S[R++]=g[e+3]}this._parameters.vvOpacity&&(S[R++]=v),P&&(e(A)&&(E[4*R]=A[0],E[4*R+1]=A[1],E[4*R+2]=A[2],E[4*R+3]=A[3]),R++)};R+=y,m(n,d[0],d[1],d[2]),t&&h(n,n,t);const N=this._isClosed(i);if(N){const e=d.length-3;m(o,d[e],d[e+1],d[e+2]),t&&h(o,o,t)}else m(l,d[3],d[4],d[5]),t&&h(l,l,t),C(n,n,l,1,ze.LEFT_CAP_START,0,0),C(n,n,l,1,ze.RIGHT_CAP_START,0,0),p(o,n),p(n,l);const U=N?0:1,x=N?O:O-1;for(let e=U;e<x;e++){const s=(e+1)%O*3;m(l,d[s],d[s+1],d[s+2]),t&&h(l,l,t),j(o,n,e),C(o,n,l,0,ze.LEFT_JOIN_END,e,L),C(o,n,l,0,ze.RIGHT_JOIN_END,e,L);const i=this.numJoinSubdivisions;for(let t=0;t<i;++t){const s=(t+1)/(i+1);C(o,n,l,s,ze.LEFT_JOIN_END,e,L),C(o,n,l,s,ze.RIGHT_JOIN_END,e,L)}C(o,n,l,1,ze.LEFT_JOIN_START,e,L),C(o,n,l,1,ze.RIGHT_JOIN_START,e,L),p(o,n),p(n,l)}N?(m(l,d[3],d[4],d[5]),t&&h(l,l,t),L=j(o,n,x),C(o,n,l,0,ze.LEFT_JOIN_END,U,L),C(o,n,l,0,ze.RIGHT_JOIN_END,U,L)):(L=j(o,n,x),C(o,n,n,0,ze.LEFT_CAP_END,x,L),C(o,n,n,0,ze.RIGHT_CAP_END,x,L)),Qe(S,I+y,S,I,y),R=Qe(S,R-y,S,R,y),this._parameters.wireframe&&this._addWireframeVertices(r,I,R,y)}_addWireframeVertices(e,t,s,i){const r=new Float32Array(e.buffer,s*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,s-t);let o=0;const n=e=>o=Qe(a,e,r,o,i);for(let e=0;e<a.length-1;e+=2*i)n(e),n(e+2*i),n(e+1*i),n(e+2*i),n(e+1*i),n(e+3*i)}}function Qe(e,t,s,i,r){for(let a=0;a<r;a++)s[i++]=e[t++];return i}function qe(e,t,s){return Ke(e,t.get(me.POSITION).data,s?s.get(me.POSITION):null)}function Ke(e,t,s){return!!e.isClosed&&(s?s.length>2:t.length>6)}const $e=_(),et=_(),tt=_(),st=_(),it=_(),rt=Q(),at=Q(),ot=_(),nt=_(),ht=ee(),ct=ee(),lt=_(),mt=_(),dt=_(),ut=[Q(),Q(),Q(),Q()],pt=[_(),_(),_(),_()],_t=re(),ft=re(),bt=re(),gt=re(),Tt=he().vec3f(me.POSITION),At=he().vec3f(me.POSITION).vec2f(me.UV0),vt=he().vec3f(me.POSITION).vec4u8(me.COLOR);he().vec3f(me.POSITION).vec4u8(me.OBJECTANDLAYERIDCOLOR),he().vec3f(me.POSITION).vec2f(me.UV0).vec4u8(me.OBJECTANDLAYERIDCOLOR);const Ot=he().vec3f(me.POSITION).vec4u8(me.COLOR).vec4u8(me.OBJECTANDLAYERIDCOLOR);class St extends R{intersect(e,t,s,i,r,a){return L(e,s,i,r,void 0,a)}}export{Ce as O,At as P,ke as R,St as T,Ve as U,We as W,Ot as a,vt as b,Tt as c,Fe as i};
