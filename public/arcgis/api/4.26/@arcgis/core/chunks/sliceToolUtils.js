/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../analysis/SlicePlane.js";import{h as t}from"./typedArrayUtil.js";import{L as r}from"./Logger.js";import{d as s,r as i}from"./mathUtils.js";import{u as o,i as n,a}from"./maybe.js";import{f as c}from"./screenUtils.js";import{y as d,g as l,m as u,o as g,r as m,i as p,n as f,z as h}from"./mat4.js";import{c as b}from"./mat4f64.js";import{r as _}from"./quat.js";import{f as T,c as O,l as E,s as I,a as w,g as C,b as A,d as R,n as j,m as S,h as P,k as v,I as L}from"./vec3.js";import{tryProjectWithZConversion as N}from"../geometry/projection.js";import{b as M,A as U}from"./vector.js";import{f as V,i as y,c as k,r as W,n as x,u as H}from"./boundedPlane.js";import{f as F,j as D}from"./plane.js";import{c as G,s as B,d as q,k as X}from"./ray.js";import{a as Y,f as z}from"./vec4f64.js";import{O as Z,L as $,a as J}from"./LineVisualElement.js";import{b as K,M as Q,R as ee,w as te,d as re}from"./manipulatorUtils.js";import{c as se}from"./vec4.js";import{d as ie,c as oe,e as ne,f as ae}from"./GeometryUtil.js";import{D as ce,R as de}from"./Material.js";import{S as le}from"./ShaderOutput.js";import{S as ue}from"./ShaderTechniqueConfiguration.js";import{D as ge,G as me}from"./DefaultBufferWriter.js";import{R as pe}from"./RenderSlot.js";import{T as fe,P as he,R as be}from"./TriangleMaterial.js";import{g as _e,N as Te}from"./interfaces2.js";import{R as Oe,S as Ee,P as Ie}from"./Program2.js";import{a as we}from"./View.glsl.js";import{F as Ce}from"./Float4PassUniform.js";import{F as Ae}from"./FloatPassUniform.js";import{S as Re}from"./ShaderBuilder.js";import{V as je}from"./VertexAttribute.js";import{B as Se,e as Pe}from"./enums3.js";import{m as ve,s as Le,a as Ne}from"./renderState.js";import{R as Me}from"./RenderCoordsHelper.js";import{a as Ue}from"./ray2.js";import{C as Ve}from"./basicInterfaces.js";import{C as ye}from"./ColorMaterial.js";import{N as ke}from"./NativeLineMaterial.js";import{M as We,a as xe}from"./interfaces5.js";const He=t("mac")?"Meta":"Control",Fe="Shift",De=2,Ge=1.15,Be=1.15,qe=2500,Xe=.02,Ye=Math.cos(s(45)),ze=Math.cos(s(5)),Ze=.95,$e=.3,Je=T(1,.5,0),Ke=2,Qe=1,et=Y([...Je,.7]),tt=[0,0,0,.04],rt=Y([...Je,.5]),st=z(1,1,1,1),it=z(1,.8,.6,1),ot=z(1,.93,.86,1),nt=Y([...Je,1]),at=Y([...Je,1]),ct=3,dt=11,lt=22.5,ut=40,gt=48,mt=2.25,pt=Y([...Je,1]),ft=4,ht=1,bt=.3,_t=6,Tt=4,Ot=1600,Et=.4,It=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new Re,{vertex:r,fragment:s,attributes:i,varyings:o}=t;return we(r,e),i.add(je.POSITION,"vec3"),i.add(je.UV0,"vec2"),o.add("vUV","vec2"),r.code.add(_e`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),s.uniforms.add([new Ce("backgroundColor",(e=>e.backgroundColor)),new Ce("gridColor",(e=>e.gridColor)),new Ae("gridWidth",(e=>e.gridWidth))]),s.code.add(_e`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
fragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}},Symbol.toStringTag,{value:"Module"}));class wt extends Te{constructor(){super(...arguments),this.backgroundColor=z(1,0,0,.5),this.gridColor=z(0,1,0,.5),this.gridWidth=4}}class Ct extends Ee{initializeProgram(e){return new Ie(e.rctx,Ct.shader.get().build(this.configuration),ce)}initializePipeline(){return ve({blending:Le(Se.ONE,Se.ONE,Se.ONE_MINUS_SRC_ALPHA,Se.ONE_MINUS_SRC_ALPHA),depthTest:{func:Pe.LESS},colorWrite:Ne})}}Ct.shader=new Oe(It,(()=>Promise.resolve().then((()=>It))));class At extends fe{constructor(e){super(e,new jt),this._configuration=new ue}createBufferWriter(){return new ge(he)}requiresSlot(e,t){return t===le.Color&&e===pe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(e){return new Rt(e)}getConfiguration(){return this._configuration}}class Rt extends me{constructor(e){super(e),this.ensureTechnique(Ct,null)}beginSlot(){return o(this.technique)}}class jt extends wt{constructor(){super(...arguments),this.renderOccluded=de.Occlude}}class St extends Z{constructor(e){super(e),this._material=null,this._renderOccluded=de.OccludeAndTransparent,this._gridWidth=1,this._gridColor=z(1,0,0,1),this._backgroundColor=z(1,0,0,1),this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(e){this._gridWidth!==e&&(this._gridWidth=e,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(e){se(this._gridColor,e),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){se(this._backgroundColor,e),this._updateMaterial()}createExternalResources(){this._material=new At(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(e){n(this._material)&&e(this._material)}createGeometries(e){if(n(this._material)){const t=ie(this._material);e.addGeometry(t)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){n(this._material)&&this._material.setParameters(this._materialParameters)}}function Pt(e,t,r,s,i,o,n,a){return function(e,t,r,s,i,o){const n=S(e,t),a=B.get(),c=B.get();switch(s===rr.HORIZONTAL_OR_VERTICAL?Math.abs(n)>Ye?rr.HORIZONTAL:rr.VERTICAL:s){case rr.VERTICAL:{const s=Math.abs(n)<=ze?e:r.viewUp;P(a,s,t),O(c,t);break}case rr.HORIZONTAL:P(a,r.viewUp,t),P(c,t,a);break;case rr.TILTED:{const s=Math.abs(n)<=ze?t:r.viewUp;P(a,s,e),P(c,e,a);break}}const d=P(B.get(),a,c);S(d,r.viewForward)>0&&C(c,c,-1),j(i,a),j(o,c)}(t,n.worldUpAtPosition(e,B.get()),i,o,a.basis1,a.basis2),C(a.basis1,a.basis1,r),C(a.basis2,a.basis2,s),O(a.origin,e),D(a.basis2,a.basis1,a.origin,a.plane),a}function vt(e,t,r,s,i,o){const n=O(B.get(),i.origin);w(n,n,C(B.get(),i.basis1,e.direction[0]<0?1:-1)),w(n,n,C(B.get(),i.basis2,e.direction[1]<0?1:-1));const a=E(i.basis1),c=E(i.basis2),d=A(B.get(),r,n),l=A(B.get(),t,n);let u=0,g=0;if(Bt(e)){const t=Gt(i),r=Gt(o);u=a-.5*e.direction[0]*S(i.basis1,l)/a,g=c-.5*e.direction[1]*S(i.basis2,l)/c;const s=r/t;u*=s,g*=s}const m=u+.5*e.direction[0]*S(i.basis1,d)/a,p=g+.5*e.direction[1]*S(i.basis2,d)/c,f=C(B.get(),i.basis1,m/a),h=C(B.get(),i.basis2,p/c);(m<=0||Ft(o.origin,f,s)<=Ot)&&O(f,o.basis1),(p<=0||Ft(o.origin,h,s)<=Ot)&&O(h,o.basis2);const b=O(B.get(),n);return w(b,b,C(B.get(),f,e.direction[0]<0?-1:1)),w(b,b,C(B.get(),h,e.direction[1]<0?-1:1)),V(b,f,h,o)}function Lt(e,t){return Et*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Nt(e,t,r,s){const i=P(B.get(),t,r);return P(i,i,t),F(e,i,s)}function Mt(e,t){return K(e.basis1,e.basis2,e.origin,t)}function Ut(e,t,r,s){const i=t.worldUpAtPosition(e.origin,B.get()),o=B.get();switch(r){case tr.HEADING:O(o,i);break;case tr.TILT:O(o,e.basis1)}return F(e.origin,o,s)}function Vt(e,t,r,s){const i=Ht(r,xt.NEGATIVE_X),o=q.get();m(o,t,i.edge*Math.PI/2);const n=j(B.get(),i.basis);let a=C(B.get(),n,i.direction*s.computeScreenPixelSizeAt(i.position)*ut);w(a,a,i.position);const d=s.projectToRenderScreen(a,c(B.get())),l=function(e,t){const[r,s,i,o]=e.viewport,n=Math.min(i,o)/16;let a=!0;return t[0]<r+n?(t[0]=r+n,a=!1):t[0]>r+i-n&&(t[0]=r+i-n,a=!1),t[1]<s+n?(t[1]=s+n,a=!1):t[1]>s+o-n&&(t[1]=s+o-n,a=!1),a}(s,d);Ue(s,d,ir),j(ir.direction,ir.direction);const u=B.get();!l&&y(r,ir,u)&&(a=u),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=v(a),l?e.state|=sr:e.state&=~sr}function yt(e,t,r,s){const i=E(s.basis1),o=E(s.basis2),n=Dt(s),a=Gt(s),c=I(B.get(),0,0,0);w(c,C(B.get(),s.basis1,t.direction[0]),C(B.get(),s.basis2,t.direction[1])),w(c,s.origin,c);let g=0,m=1;if(Bt(t))1===t.direction[0]&&-1===t.direction[1]?g=or:1===t.direction[0]&&1===t.direction[1]?g=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(g=3*Math.PI/2),m=a;else{const e=0!==t.direction[0]?1:2;g=1===e?or:0,m=(1===e?o:i)-n}const p=d(q.get(),g);l(p,p,I(B.get(),m,m,m)),u(p,r,p),p[12]=0,p[13]=0,p[14]=0,e.modelTransform=p,e.renderLocation=c}function kt(e,t,r,s){const i=s.worldUpAtPosition(r.origin,B.get()),o=Ht(r,xt.POSITIVE_X),n=d(q.get(),o.edge*Math.PI/2);g(n,n,-Jt(r,i)),u(n,t,n),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=o.position}function Wt(e,t,r){const s=Ht(r,xt.POSITIVE_Y),i=d(q.get(),s.edge*Math.PI/2);g(i,i,or),u(i,t,i),i[12]=0,i[13]=0,i[14]=0,e.modelTransform=i,e.renderLocation=s.position}var xt;function Ht(e,t){switch(t){case xt.POSITIVE_X:return{basis:e.basis1,direction:1,position:w(B.get(),e.origin,e.basis1),edge:t};case xt.POSITIVE_Y:return{basis:e.basis2,direction:1,position:w(B.get(),e.origin,e.basis2),edge:t};case xt.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:A(B.get(),e.origin,e.basis1),edge:t};case xt.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:A(B.get(),e.origin,e.basis2),edge:t}}}function Ft(e,t,r){const s=r.projectToRenderScreen(w(B.get(),e,t),c(B.get())),i=r.projectToRenderScreen(A(B.get(),e,t),c(B.get()));return L(A(s,s,i))}function Dt(e){const t=E(e.basis1),r=E(e.basis2);return bt*Math.min(t,r)}function Gt(e){return Dt(e)}function Bt(e){return 0!==e.direction[0]&&0!==e.direction[1]}function qt(e,t=cr.CENTER_ON_ARROW){const r=t===cr.CENTER_ON_CALLOUT?ut:0,s=[T(r,0,-gt/2),T(r,0,gt/2)],i=function(e,t){const r=A(R(),e[e.length-1],e[e.length-2]);j(r,r),C(r,r,lt),w(r,r,e[e.length-1]);{const t=A(R(),e[0],e[1]);return j(t,t),C(t,t,lt),w(t,t,e[0]),[t,...e,r]}}(s),o=(e,t)=>function(e,t,r){const s=new ye({color:st,cullFace:Ve.Back,renderOccluded:de.Opaque}),i=new ye({color:it,cullFace:Ve.Back,renderOccluded:de.Opaque}),o=new ye({color:ot,cullFace:Ve.Back,renderOccluded:de.Opaque}),n=new ye({color:at,transparent:!0,writeDepth:!1,cullFace:Ve.Front,renderOccluded:de.Transparent}),a=a=>{e=e.slice(0);const c=A(B.get(),e[0],e[1]);j(c,c);const d=A(B.get(),e[e.length-1],e[e.length-2]);if(j(d,d),t>0){const r=C(R(),d,-t);e[e.length-1]=w(r,r,e[e.length-1]);const s=C(R(),c,-t);e[0]=w(s,s,e[0])}const g=a?Be:1,m=lt*g,O=dt*g,E=p(q.get());if(t>0){const e=m/4,r=I(B.get(),0,e,0),s=1+t/e;f(E,E,r),l(E,E,I(B.get(),s,s,s)),f(E,E,C(r,r,-1/s))}const S=p(b()),P=T(0,1,0),v=h(b(),_(X.get(),P,d));v[12]=e[e.length-1][0],v[13]=e[e.length-1][1],v[14]=e[e.length-1][2],u(v,v,E);const L=function(e,t,r){const s=[];for(let t=0;t<12;t++){const r=t/12*2*Math.PI;s.push([Math.cos(r)*e,Math.sin(r)*e])}return ae(r,s,t,[],[],!1)}(ct*(a?Ge:1)+t,e,r?n:o);L.transformation=S;const N=[L],M=ne(r?n:s,m,O,24,!1,!1,!0);M.transformation=v,N.push(M);const U=ne(r?n:i,m,O,24,!1,!0,!1);U.transformation=v,N.push(U);const V=h(b(),_(X.get(),P,c));return V[12]=e[0][0],V[13]=e[0][1],V[14]=e[0][2],u(V,V,E),N.push(M.instantiate({transformation:V})),N.push(U.instantiate({transformation:V})),N};return{normal:a(!1),focused:a(!0)}}(s,e,t),n=o(0,!1),a=o(mt,!0),c=new ke({color:nt,renderOccluded:de.OccludeAndTransparent}),d=oe(c,[[r,0,0],[r-ut,0,0]]),g=oe(c,[[r,0,0],[r-ut,0,0]]);return new Q({view:e,renderObjects:[...n.normal.map((e=>new ee(e,xe.Unfocused|er))),...a.normal.map((e=>new ee(e,xe.Unfocused|er))),new ee(d,xe.Unfocused|er|sr),...n.focused.map((e=>new ee(e,xe.Focused|er))),...a.focused.map((e=>new ee(e,xe.Focused|er))),new ee(g,xe.Focused|er|sr)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[i]},collisionPriority:1,radius:dt,state:er})}function Xt(e,t){const r=re(e,{customStateMask:er,texture:t});return r.state=er,r}function Yt(e){return new $({view:e,attached:!1,color:et,width:Qe,writeDepthEnabled:!1,renderOccluded:de.OccludeAndTransparent,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function zt(e){return new St({view:e,attached:!1,backgroundColor:[...tt],gridColor:rt,gridWidth:4,renderOccluded:de.OccludeAndTransparent})}function Zt(e,t){const r=Bt(t),s=r?[T(1,0,0),T(0,0,0),T(0,1,0)]:[T(1,0,0),T(-1,0,0)],i=pt,o=r?ft:ht,n=o*De,a=ht,c=e=>e>1?(e=>new be({color:i,width:e,renderOccluded:de.OccludeAndTransparent}))(e):new ke({color:i,renderOccluded:de.OccludeAndTransparent}),d=[new ee(oe(c(o),s),xe.Unfocused|nr),new ee(oe(c(n),s),xe.Focused|nr),new ee(oe(c(a),s),ar)],l=new Q({view:e,renderObjects:d,collisionType:{type:"line",paths:[s]},radius:r?_t:Tt,...te});return l.state=nr,l}function $t(t,r,s,o=new e){if(a(t))return null;const{renderCoordsHelper:n}=r,c=n.fromRenderCoords(t.origin,r.spatialReference);if(a(c))return null;const d=N(c,s);if(a(d))return null;o.position=d;const l=2*E(t.basis1),u=2*E(t.basis2),g=Me.renderUnitScaleFactor(r.spatialReference,s);o.width=l*g,o.height=u*g;const m=n.worldUpAtPosition(t.origin,B.get());return o.tilt=i(Jt(t,m)),o.heading=n.headingAtPosition(t.origin,t.basis1)-90,o}function Jt(e,t){return M(t,e.basis2,e.basis1)+or}function Kt(e,t){if(a(e)||a(e.position))return null;const r=J(e.position,t.spatialReference,t.elevationProvider);if(a(r))return null;const s=Me.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),i=e.width*s,o=e.height*s;return{position:r,heading:e.heading,tilt:e.tilt,renderWidth:i,renderHeight:o}}function Qt(e,t,i,o=k()){if(a(e))return null;const c=function(e,t,i,o,n,a,c=k()){return a.toRenderCoords(e,c.origin)?(a.worldBasisAtPosition(c.origin,U.X,c.basis1),a.worldBasisAtPosition(c.origin,U.Y,c.basis2),D(c.basis2,c.basis1,c.origin,c.plane),W(c,-s(t),x(c),c),W(c,s(i),c.basis1,c),C(c.basis1,c.basis1,o/2),C(c.basis2,c.basis2,n/2),H(c),c):(r.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,o);return!i.tiltEnabled&&n(c)&&function(e,t,r){const s=t.worldUpAtPosition(e.origin,B.get()),i=e.basis1,o=Jt(e,s),n=Math.round(o/or)*or;W(e,n-o,i,r)}(c,t.renderCoordsHelper,c),c}!function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"}(xt||(xt={}));const er=We.Custom1;var tr,rr;!function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"}(tr||(tr={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(rr||(rr={}));const sr=We.Custom2,ir=G(),or=Math.PI/2,nr=We.Custom1,ar=We.Custom2;var cr;function dr(e){const t="building-scene-3d"===e.type?e:null;return n(t)}!function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(cr||(cr={}));export{Qe as A,Bt as B,sr as C,er as D,nr as E,ar as F,rt as G,Gt as H,Xe as I,cr as O,qe as P,tr as R,rr as S,Qt as a,$t as b,qt as c,Xt as d,Zt as e,zt as f,Yt as g,Ke as h,dr as i,Fe as j,He as k,Ut as l,Lt as m,Pt as n,Mt as o,Kt as p,kt as q,vt as r,Wt as s,yt as t,Vt as u,et as v,tt as w,Nt as x,Ze as y,$e as z};
