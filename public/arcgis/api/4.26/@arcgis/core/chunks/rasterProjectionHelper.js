/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../core/Error.js";import{a as t,i as n}from"./maybe.js";import{g as o}from"./unitUtils.js";import{e as i,f as s,g as r,h as a,j as l}from"./pe.js";import{isLoaded as c,load as f,project as u,canProjectWithoutEngine as m,getTransformation as h}from"../geometry/projection.js";import x from"../geometry/Extent.js";import p from"../geometry/Polygon.js";import g from"../geometry/Point.js";import y from"../geometry/SpatialReference.js";var d;function M(e,t,n){return!m(e,t,n)}function w(t,n,o){const i=M(t,n,o);if(i&&!c())throw new e("rasterprojectionhelper-project","projection engine is not loaded");return i}!function(e){e[e.None=0]="None",e[e.North=1]="North",e[e.South=2]="South",e[e.Both=3]="Both"}(d||(d={}));const R=(e,t,n,o=0)=>{if(1===n[0])return[0,0];let i=1,s=-1,r=1,a=-1;for(let t=0;t<e.length;t+=2)isNaN(e[t])||(i=i>e[t]?e[t]:i,s=s>e[t]?s:e[t],r=r>e[t+1]?e[t+1]:r,a=a>e[t+1]?a:e[t+1]);const{cols:l,rows:c}=t,f=(s-i)/l/n[0],u=(a-r)/c/n[1],m=2*o;let h=0,x=!1,p=[0,0];for(let t=0;t<l-3;t++){for(let n=0;n<c-3;n++){const o=t*c*2+2*n,i=(e[o]+e[o+4]+e[o+4*c]+e[o+4*c+4])/4,s=(e[o+1]+e[o+5]+e[o+4*c+1]+e[o+4*c+5])/4,r=Math.abs((i-e[o+2*c+2])/f),a=Math.abs((s-e[o+2*c+3])/u);if(r+a>h&&(h=r+a,p=[r,a]),m&&h>m){x=!0;break}}if(x)break}return p},P={3395:20037508.342789244,3410:17334193.943686873,3857:20037508.342788905,3975:17367530.445161372,4087:20037508.342789244,4088:20015108.787169147,6933:17367530.445161372,32662:20037508.342789244,53001:20015086.79602057,53002:10007543.39801029,53003:20015086.79602057,53004:20015086.79602057,53016:14152803.599503474,53017:17333573.624304302,53034:20015086.79602057,53079:20015114.352186374,53080:20015114.352186374,54001:20037508.342789244,54002:10018754.171394624,54003:20037508.342789244,54004:20037508.342789244,54016:14168658.027268292,54017:17367530.44516137,54034:20037508.342789244,54079:20037508.342789244,54080:20037508.342789244,54100:20037508.342789244,54101:20037508.342789244},S=32,b=4,G=b,N=new Map,E=new Map,k=500;async function T(){c()||await f()}function v(e,t,n){return w(e.spatialReference,t)?n?h(t,e.spatialReference,e):h(e.spatialReference,t,e):null}function C(e,i,s,r=null){const a=e.spatialReference;if(a.equals(i))return e;w(a,i,r);const l=s.center,c=new x({xmin:l.x-e.x/2,xmax:l.x+e.x/2,ymin:l.y-e.y/2,ymax:l.y+e.y/2,spatialReference:a}),f=u(c,i,r),m=Y(i);let h;if(t(f)||n(m)&&f.width>=m){const t=o(a)/o(i);h={x:e.x*t,y:e.y*t}}else h={x:f.width,y:f.height};return h}function _(e,t=.01){return o(e)?t/o(e):0}function j(e,t,n=null,o=!0){const i=e.spatialReference;if(i.equals(t))return e;w(i,t,n);const s=u(e,t,n);return o&&s?(z([e],[s],i,t),s):s}function z(e,t,o,i){const s=q(o,!0),r=q(i,!0),a=_(o,k),l=_(i,k);if(a&&n(s)&&n(r))for(let n=0;n<e.length;n++){const o=t[n];if(!o)continue;const{x:i}=e[n],{x:c}=o;c>=r[1]-l&&Math.abs(i-s[0])<a?o.x-=r[1]-r[0]:c<=r[0]+l&&Math.abs(i-s[1])<a&&(o.x+=r[1]-r[0])}}function W(e){const{inSR:t,outSR:o,datumTransformation:l}=e,c=L(t),{points:f,mask:u}=I(e,c);if(!t.isGeographic){const e=t.wkid?i.coordsys(t.wkid):i.fromString(t.isGeographic?s.PE_TYPE_GEOGCS:s.PE_TYPE_PROJCS,t.wkt);r.projToGeog(e,f.length,f)}if(n(l)&&l.steps.length){let e;const t=179.9955;if(o.isGeographic&&(e=f.map((([e])=>e>t?1:e<-t?-1:0))),l.steps.forEach((e=>{const t=e.wkid?i.geogtran(e.wkid):i.fromString(s.PE_TYPE_GEOGTRAN,e.wkt);a.geogToGeog(t,f.length,f,null,e.isInverse?s.PE_TRANSFORM_2_TO_1:s.PE_TRANSFORM_1_TO_2)})),e)for(let n=0;n<f.length;n++){const o=e[n],i=f[n][0],s=i>t?1:i<-t?-1:0;o&&s&&o!==s&&(f[n][0]=o>0?i+360:i-360)}}if(!o.isGeographic){const e=L(o,!0),t=n(e)&&e.isEnvelope?[e.bbox[1],e.bbox[3]]:[-90,90];!function(e,t){const[n,o]=t;for(let t=0;t<e.length;t++){const i=e[t][1];(i<n||i>o)&&(e[t]=[NaN,NaN])}}(f,t);const a=o.wkid?i.coordsys(o.wkid):i.fromString(o.isGeographic?s.PE_TYPE_GEOGCS:s.PE_TYPE_PROJCS,o.wkt);r.geogToProj(a,f.length,f)}let m=f;if(u&&f.length!==u.length){m=[];for(let e=0,t=0;e<u.length;e++)u[e]?m.push(f[t++]):m.push([NaN,NaN])}return m}function L(e,t=!1){let n=e.wkid||e.wkt;if(!n||e.isGeographic)return null;if(n=String(n),N.has(n)){const e=N.get(n);return t?e?.gcs:e?.pcs}const o=e.wkid?i.coordsys(e.wkid):i.fromString(e.isGeographic?s.PE_TYPE_GEOGCS:s.PE_TYPE_PROJCS,e.wkt),r=O(o,_(e,1e-4)),a=O(o,0,!0);return N.set(n,{pcs:r,gcs:a}),t?a:r}function O(e,t=0,n=!1){const o=l.generate(e),i=n?e.horizonGcsGenerate():e.horizonPcsGenerate();if(!o||!i?.length)return null;let s=!1,r=i.find((e=>1===e.getInclusive()&&1===e.getKind()));if(!r){if(r=i.find((e=>1===e.getInclusive()&&0===e.getKind())),!r)return null;s=!0}const a=n?0:(2===o.getNorthPoleLocation()?1:0)|(2===o.getSouthPoleLocation()?2:0),c=o.isPannableRectangle(),f=r.getCoord();if(s)return{isEnvelope:s,isPannable:c,vertices:f,coef:null,bbox:[f[0][0]-t,f[0][1]-t,f[1][0]+t,f[1][1]+t],poleLocation:a};let u=0;const m=[];let[h,x]=f[0],[p,g]=f[0];for(let e=0,t=f.length;e<t;e++){u++,u===t&&(u=0);const[n,o]=f[e],[i,s]=f[u];if(s===o)m.push([n,i,o,s,2]);else{const e=(i-n)/(s-o||1e-4),t=n-e*o;o<s?m.push([e,t,o,s,0]):m.push([e,t,s,o,1])}h=h<n?h:n,x=x<o?x:o,p=p>n?p:n,g=g>o?g:o}return{isEnvelope:!1,isPannable:c,vertices:f,coef:m,bbox:[h,x,p,g],poleLocation:a}}function I(e,n){const o=[],{cols:i,rows:s,xres:r,yres:a,usePixelCenter:l}=e;let{xmin:c,ymax:f}=e;if(l&&(c+=r/2,f-=a/2),t(n)){for(let e=0;e<i;e++)for(let t=0;t<s;t++)o.push([c+r*e,f-a*t]);return{points:o}}const u=new Uint8Array(i*s);if(n.isEnvelope){const{bbox:[e,t,l,m]}=n;for(let h=0,x=0;h<i;h++){const i=c+r*h,p=n.isPannable||i>=e&&i<=l;for(let e=0;e<s;e++,x++){const n=f-a*e;p&&n>=t&&n<=m&&(o.push([i,n]),u[x]=1)}}return{points:o,mask:u}}const m=n.coef,h=[];for(let e=0;e<s;e++){const t=f-a*e,n=[],o=[];for(let e=0;e<m.length;e++){const[i,s,r,a,l]=m[e];if(t===r&&r===a)n.push(i),n.push(s),o.push(2),o.push(2);else if(t>=r&&t<=a){const e=i*t+s;n.push(e),o.push(l)}}let i=n;if(n.length>2){let e=2===o[0]?0:o[0],t=n[0];i=[];for(let s=1;s<o.length;s++)2===o[s]&&s!==o.length-1||(o[s]!==e&&(i.push(0===e?Math.min(t,n[s-1]):Math.max(t,n[s-1])),e=o[s],t=n[s]),s===o.length-1&&i.push(0===o[s]?Math.min(t,n[s]):Math.max(t,n[s])));i.sort(((e,t)=>e-t))}else n[0]>n[1]&&(i=[n[1],n[0]]);h.push(i)}for(let e=0,t=0;e<i;e++){const n=c+r*e;for(let e=0;e<s;e++,t++){const i=f-a*e,s=h[e];if(2===s.length)n>=s[0]&&n<=s[1]&&(o.push([n,i]),u[t]=1);else if(s.length>2){let e=!1;for(let t=0;t<s.length;t+=2)if(n>=s[t]&&n<=s[t+1]){e=!0;break}e&&(o.push([n,i]),u[t]=1)}}}return{points:o,mask:u}}function A(e){const n=Y(e[0].spatialReference);if(e.length<2||t(n))return e[0];const o=_(e[0].spatialReference);if(1===(e=e.filter((e=>e.width>o))).length)return e[0];let{xmin:i,xmax:s,ymin:r,ymax:a}=e[0];for(let t=1;t<e.length;t++){const o=e[t];s=o.xmax+n*t,r=Math.min(r,o.ymin),a=Math.max(a,o.ymax)}return new x({xmin:i,xmax:s,ymin:r,ymax:a,spatialReference:e[0].spatialReference})}function B(e,o,i=null,s=!0){const r=e.spatialReference;if(r.equals(o))return e;const a=X(e),l=Y(r,!0),f=Y(o);if(0===a||t(l)||t(f)){const a=F(e,o,i,s);if(t(l)&&n(f)&&Math.abs(a.width-f)<_(o)&&c()){const i=L(r);if(n(i)&&i.poleLocation===d.None&&e.width<(i.bbox[2]-i.bbox[0])/2)return function(e,n){const o=Y(n);if(t(o))return null;let{xmin:i,ymin:s,xmax:r,ymax:a}=e;const l=e.spatialReference,c=new p({spatialReference:l,rings:[[[i,s],[r,s],[r,a],[i,a],[i,s]]]}),f=u(c,n);if(2!==f.rings.length||!f.rings[0].length||!f.rings[1].length)return null;const{rings:m}=f,h=_(l),g=new x({spatialReference:n});for(let e=0;e<2;e++){i=r=m[e][0][0],s=a=m[e][0][1];for(let t=0;t<m[e].length;t++)i=i>m[e][t][0]?m[e][t][0]:i,r=r<m[e][t][0]?m[e][t][0]:r,s=s>m[e][t][1]?m[e][t][1]:s,a=a<m[e][t][1]?m[e][t][1]:a;if(0===e)g.ymin=s,g.ymax=a,g.xmin=i,g.xmax=r;else if(g.ymin=Math.min(g.ymin,s),g.ymax=Math.max(g.ymax,a),Math.abs(r-o/2)<h)g.xmin=i,g.xmax=g.xmax+o;else{if(!(Math.abs(i+o/2)<h))return null;g.xmax=r+o}}return g}(e,o)||a}return a}const m=e.clone().normalize();if(1===m.length&&e.xmax<l&&e.xmax-l/2>_(r)){const{xmin:t,xmax:n}=e;for(let o=0;o<=a;o++){const i=0===o?t:-l/2,s=o===a?n-l*o:l/2;m[o]=new x({xmin:i,xmax:s,ymin:e.ymin,ymax:e.ymax,spatialReference:r})}}return A(m.map((e=>F(e,o,i,s))).filter(n))}function F(e,n,o=null,i=!0,s=!0){const r=e.spatialReference;if(r.equals(n)||!n)return e;w(r,n,o);const a=u(e,n,o);if(s&&n.isWebMercator&&a&&(a.ymax=Math.min(20037508.342787,a.ymax),a.ymin=Math.max(-20037508.342787,a.ymin),a.ymin>=a.ymax))return null;if(!i||!a)return a;const l=q(r,!0),c=q(n,!0);if(t(l)||t(c))return a;const f=_(r,.001),m=_(r,k),h=_(n,.001);if(Math.abs(a.xmin-c[0])<h&&Math.abs(a.xmax-c[1])<h){const t=Math.abs(e.xmin-l[0]),i=Math.abs(l[1]-e.xmax);if(t<f&&i>m){a.xmin=c[0];const t=[];t.push(new g(e.xmax,e.ymin,r)),t.push(new g(e.xmax,(e.ymin+e.ymax)/2,r)),t.push(new g(e.xmax,e.ymax,r));const i=t.map((e=>j(e,n,o))).filter((e=>!isNaN(e?.x))).map((e=>e.x));a.xmax=Math.max.apply(null,i)}if(i<f&&t>m){a.xmax=c[1];const t=[];t.push(new g(e.xmin,e.ymin,r)),t.push(new g(e.xmin,(e.ymin+e.ymax)/2,r)),t.push(new g(e.xmin,e.ymax,r));const i=t.map((e=>j(e,n,o))).filter((e=>!isNaN(e?.x))).map((e=>e.x));a.xmin=Math.min.apply(null,i)}}else{const e=_(n,.001);Math.abs(a.xmin-c[0])<e&&(a.xmin=c[0]),Math.abs(a.xmax-c[1])<e&&(a.xmax=c[1])}return a}function Y(e,t=!1){if(!e)return null;const n=t?20037508.342787:20037508.342788905;return e.isWebMercator?2*n:e.wkid&&e.isGeographic?360:2*P[e.wkid]||null}function q(e,t=!1){if(e.isGeographic)return[-180,180];const o=Y(e,t);return n(o)?[-o/2,o/2]:null}function J(e,t,n,o){let i=(e-t)/n;return i-Math.floor(i)!=0?i=Math.floor(i):o&&(i-=1),i}function X(e,n=!1){const o=Y(e.spatialReference);if(t(o))return 0;const i=n?0:-o/2,s=_(e.spatialReference),r=!n&&Math.abs(e.xmax-o/2)<s?o/2:e.xmax,a=!n&&Math.abs(e.xmin+o/2)<s?-o/2:e.xmin;return J(r,i,o,!0)-J(a,i,o,!1)}function K(e){const o=e.storageInfo.origin.x,i=Y(e.spatialReference,!0);if(t(i))return{originX:o,halfWorldWidth:null,pyramidsInfo:null};const s=i/2,{nativePixelSize:r,storageInfo:a,extent:l}=e,{maximumPyramidLevel:c,blockWidth:f,pyramidScalingFactor:u}=a;let m=r.x;const h=[],x=n(e.transform)&&"gcs-shift"===e.transform.type,p=o+(x?0:s),g=x?i-o:s-o;for(let e=0;e<=c;e++){const e=(l.xmax-o)/m/f,t=e-Math.floor(e)==0?e:Math.ceil(e),n=g/m/f,i=n-Math.floor(n)==0?n:Math.ceil(n),s=Math.floor(p/m/f),r=Math.round(p/m)%f,a=(f-Math.round(g/m)%f)%f;h.push({resolutionX:m,blockWidth:f,datsetColumnCount:t,worldColumnCountFromOrigin:i,leftMargin:r,rightPadding:a,originColumnOffset:s}),m*=u}return{originX:o,halfWorldWidth:s,pyramidsInfo:h,hasGCSSShiftTransform:x}}function U(e){const t=e.isAdaptive&&null==e.spacing;let o=e.spacing||[S,S],r=D(e),a={cols:r.size[0]+1,rows:r.size[1]+1};const l=r.outofBoundPointCount>0&&r.outofBoundPointCount<r.offsets.length/2;let c=r.outofBoundPointCount===r.offsets.length/2||t&&l?[0,0]:R(r.offsets,a,o,G);const f=(c[0]+c[1])/2,u=e.projectedExtent.spatialReference,m=e.srcBufferExtent.spatialReference;if(t&&(l||f>G)&&(M(u,m,e.datumTransformation)&&(u.isGeographic||n(L(u))),o=[b,b],r=D({...e,spacing:o}),a={cols:r.size[0]+1,rows:r.size[1]+1},c=R(r.offsets,a,o,G)),r.error=c,o[0]>1&&(r.coefficients=H(r.offsets,a,l)),e.includeGCSGrid&&!u.isGeographic&&!u.isWebMercator)if(m.isGeographic)r.gcsGrid={offsets:r.offsets,coefficients:r.coefficients,spacing:o};else{const t=L(u);if(n(t)&&!t.isEnvelope){const t=function(e){if(!e||e.isGeographic)return e;const t=String(e.wkid||e.wkt);let n;return E.has(t)?n=E.get(t):(n=(e.wkid?i.coordsys(e.wkid):i.fromString(s.PE_TYPE_PROJCS,e.wkt)).getGeogcs().getCode(),E.set(t,n)),new y({wkid:n})}(u),n=B(e.projectedExtent,t),{offsets:c}=D({...e,srcBufferExtent:n,spacing:o}),f=H(c,a,l);r.gcsGrid={offsets:c,coefficients:f,spacing:o}}}return r}function D(e){const{projectedExtent:t,srcBufferExtent:o,pixelSize:i,datumTransformation:s,rasterTransform:r}=e,a=t.spatialReference,l=o.spatialReference,c=w(a,l),{xmin:f,ymin:m,xmax:h,ymax:x}=t,p=Y(l),y=n(p)&&(e.hasWrapAround||"gcs-shift"===r?.type),d=e.spacing||[S,S],M=d[0]*i.x,R=d[1]*i.y,P=1===d[0],G=Math.ceil((h-f)/M-.1/d[0])+(P?0:1),N=Math.ceil((x-m)/R-.1/d[1])+(P?0:1),E=function(e){const{inSR:t,outSR:o,datumTransformation:i,preferPE:s}=e;if(t.equals(o)){const{points:t}=I(e,null);return t}if(t.isWebMercator&&o.isWGS84||t.isWGS84&&o.isWebMercator)return function(e){const{cols:t,rows:n,xres:o,yres:i,usePixelCenter:s,inSR:r,outSR:a}=e;let{xmin:l,ymax:c}=e;s&&(l+=o/2,c-=i/2);const f=[],m=[],h=Math.max(t,n);for(let e=0;e<h;e++){const s=l+o*Math.min(t,e),h=c-i*Math.min(n,e),x=u(new g({x:s,y:h,spatialReference:r}),a);e<=t&&f.push(x.x),e<=n&&m.push(x.y)}const x=[];for(let e=0;e<t;e++)for(let t=0;t<n;t++)x.push([f[e],m[t]]);return x}(e);if(w(t,o,i)&&s){if(t.isGeographic)return W(e);const o=L(t);if(n(o))return W(e)}return function(e){const{points:t}=I(e,null),{inSR:n,outSR:o,datumTransformation:i}=e,s=t.map((e=>new g(e[0],e[1],n))),r=u(s,o,i);return i&&z(s,r,n,o),r.map((e=>e?[e.x,e.y]:[NaN,NaN]))}(e)}({cols:G,rows:N,xmin:f,ymax:x,xres:M,yres:R,inSR:a,outSR:l,datumTransformation:s,preferPE:d[0]<=b,usePixelCenter:P}),T=[];let v,C=0;const j=P?-1:NaN,{xmin:O,xmax:A,ymax:B,width:F,height:q}=o,J=_(l,k),X=n(p)&&O>0&&A>p/2;let K=!1;if(c){const e=L(a);K=n(e)&&e.poleLocation>0}for(let e=0;e<G;e++){const t=[];for(let n=0;n<N;n++){let o=E[e*N+n];if(y&&o[0]>A&&o[0]>p/2-J?o[0]-=p:y&&0===e&&o[0]<0&&X&&!r&&(o[0]+=p),!o||isNaN(o[0])||isNaN(o[1]))T.push(j),T.push(j),t.push(null),C++;else{if(r){const e=r.inverseTransform(new g({x:o[0],y:o[1],spatialReference:l}));o=[e.x,e.y]}t.push(o),e>0&&y&&v[n]&&o[0]<v[n][0]&&(o[0]+=p,K&&o[0]>A&&o[0]>p&&(o[0]-=p)),T.push((o[0]-O)/F),T.push((B-o[1])/q)}}v=t}return{offsets:T,error:null,coefficients:null,outofBoundPointCount:C,spacing:d,size:P?[G,N]:[G-1,N-1]}}function H(e,t,n){const{cols:o,rows:i}=t,s=new Float32Array((o-1)*(i-1)*2*6),r=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),a=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let t=0;t<o-1;t++){for(let n=0;n<i-1;n++){let l=t*i*2+2*n;const c=e[l],f=e[l+1],u=e[l+2],m=e[l+3];l+=2*i;const h=e[l],x=e[l+1],p=e[l+2],g=e[l+3];let y=0,d=12*(n*(o-1)+t);for(let e=0;e<3;e++)s[d++]=r[y++]*c+r[y++]*u+r[y++]*p;y=0;for(let e=0;e<3;e++)s[d++]=r[y++]*f+r[y++]*m+r[y++]*g;y=0;for(let e=0;e<3;e++)s[d++]=a[y++]*c+a[y++]*h+a[y++]*p;y=0;for(let e=0;e<3;e++)s[d++]=a[y++]*f+a[y++]*x+a[y++]*g}if(n)for(let e=0;e<s.length;e++)isNaN(s[e])&&(s[e]=-1)}return s}function Q(e){const t=e.clone().normalize();return 1===t.length?t[0]:A(t)}function V(e,t,i){const{storageInfo:s,pixelSize:r}=t;let a=0,l=!1;const{pyramidResolutions:c}=s;if(n(c)&&c.length){const n=(e.x+e.y)/2,s=c[c.length-1],f=(s.x+s.y)/2,u=(r.x+r.y)/2;if(n<=u)a=0;else if(n>=f)a=c.length,l=n/f>8;else{let e,t=u;for(let o=1;o<=c.length;o++){if(e=(c[o-1].x+c[o-1].y)/2,n<=e){n===e?a=o:"down"===i?(a=o-1,l=n/t>8):a="up"===i||n-t>e-n||n/t>2?o:o-1;break}t=e}}const m=0===a?r:c[a-1];return l&&Math.min(m.x,m.y)*o(t.spatialReference)>19567&&(l=!1),{pyramidLevel:a,pyramidResolution:new g({x:m.x,y:m.y,spatialReference:t.spatialReference}),excessiveReading:l}}const f=Math.log(e.x/r.x)/Math.LN2,u=Math.log(e.y/r.y)/Math.LN2,m=t.storageInfo.maximumPyramidLevel||0;a="down"===i?Math.floor(Math.min(f,u)):"up"===i?Math.ceil(Math.max(f,u)):Math.round((f+u)/2),a<0?a=0:a>m&&(l=a>m+3,a=m);const h=2**a;return{pyramidLevel:a,pyramidResolution:new g({x:h*t.nativePixelSize.x,y:h*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:l}}function Z(e,t,i=512,s=!0){const{extent:r,spatialReference:a,pixelSize:l}=e,c=C(new g({x:l.x,y:l.y,spatialReference:a}),t,r);if(null==c)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const f=(c.x+c.y)/2,u=o(t),m=f*u*96*39.37,h=t.isGeographic?256/i*295828763.7958547:256/i*591657527.591555;let x="vector-magdir"===e.dataType||"vector-uv"===e.dataType;const p=B(r,t),y=Math.min(Math.ceil(Math.log(Math.min(e.width,e.height)/32)/Math.LN2),Math.ceil(Math.log(h/2/m)/Math.LN2));if(!x&&s&&(t.isGeographic||t.isWebMercator)&&(x=p.xmin*p.xmax<0,!x&&y<3)){const e=Y(t);if(n(e)){const t=2**y*f*i,n=Math.ceil(e/t);x=1===n||2===n&&e/2-p.xmax<t}}let d,M=m;const w=Math.min(2,Math.max(1.414,e.storageInfo?.pyramidScalingFactor||2));if(x){M=h;const e=t.isGeographic?1341104507446289e-21:.29858214164761665,n=e*(96*u*39.37),o=t.isGeographic?4326:3857;d=C(new g({x:e,y:e,spatialReference:{wkid:o}}),a,p),d.x*=M/n,d.y*=M/n}else{d={x:l.x,y:l.y};let e=0;for(;M<.5005*h&&e<y;)e++,M*=w,d.x*=w,d.y*=w;Math.max(M,h)/Math.min(M,h)<=1.001&&(M=h)}const R=[M],P=[{x:d.x,y:d.y}],S=Math.min(70.5310735,m)/1.001;for(;M>=S;)M/=w,d.x/=w,d.y/=w,R.push(M),P.push({x:d.x,y:d.y});return{projectedPixelSize:c,scales:R,srcResolutions:P,isCustomTilingScheme:!x}}export{Q as a,X as b,B as c,U as d,K as e,C as f,Y as g,Z as h,v as i,T as l,j as p,M as r,V as s};
