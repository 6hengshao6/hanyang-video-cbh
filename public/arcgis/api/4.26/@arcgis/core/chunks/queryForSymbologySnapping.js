/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../geometry.js";import{a as e,i as t}from"./maybe.js";import{throwIfAborted as n}from"../core/promiseUtils.js";import{m as o}from"./dehydratedFeatures.js";import{j as a}from"./elevationInfoUtils.js";import{E as s,i as r,j as i,a as c,S as d}from"./ElevationContext.js";import p from"../geometry/SpatialReference.js";import{l as f}from"./arcadeOnDemand.js";async function l(t,o,s,d,p){const{elevationProvider:f,renderCoordsHelper:l,spatialReference:h}=t,{elevationInfo:y}=o,j=r(y,!0),I=await i(j,h,p);n(p);const b=[],S=new Set,v=new Set;for(const{objectId:n,points:r}of d){const i=s(n);if(e(i)){for(const e of r)b.push(e[2]);S.add(n);continue}i.isDraped&&v.add(n);const d=i.graphic.geometry;m.setFromElevationInfo(a(d,y)),m.updateFeatureExpressionInfoContext(I,i.graphic,o),u.spatialReference=t.spatialReference;for(const{x:e,y:t,z:n}of r)u.x=e,u.y=t,u.z=n??0,c(u,f,m,l,g),b.push(g.z)}return{elevations:b,drapedObjectIds:v,failedObjectIds:S}}const m=new s,u=o(0,0,0,p.WGS84),g=new d;async function h(o,a,s){if(e(o)||0===a.candidates.length)return y;const r=o.graphics3DGraphicsByObjectID??o.graphics3DGraphics,i=[],c=[],{renderer:d}=o,p=t(d)&&"arcadeRequired"in d&&d.arcadeRequired?f():null,l=async(t,{graphic:n,graphics3DSymbol:a})=>{const r=await p,i=await o.getRenderingInfoAsync(n,d,r,{signal:s});return e(i)?[]:a.queryForSnapping(t,u,i,s)},{candidates:m,spatialReference:u}=a;for(let t=0;t<m.length;++t){const n=m[t],{objectId:o}=n,a="number"==typeof o?r?.get(o):void 0;if(e(a))continue;const{graphics3DSymbol:s}=a;s.symbologySnappingSupported&&(i.push(l(n,a)),c.push(t))}if(0===i.length)return y;const g=await Promise.all(i);n(s);const h=[],j=[];for(let e=0;e<g.length;++e){const t=g[e],n=c[e];for(const e of t)h.push(e),j.push(n)}return{candidates:h,sourceCandidateIndices:j}}const y={candidates:[],sourceCandidateIndices:[]};export{l as e,h as q};
