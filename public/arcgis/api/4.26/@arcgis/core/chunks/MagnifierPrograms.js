/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{r as t,V as e}from"./WGLContainer.js";import i from"../config.js";import s from"../request.js";import{b as a}from"./shapingUtils.js";import n from"../core/Error.js";import{a as r}from"./fontUtils.js";import{L as o}from"./Logger.js";import{e as h,c}from"./mathUtils.js";import{a as u,i as l,p as m,r as d,d as p}from"./maybe.js";import{throwIfNotAbortError as g,onAbort as _,createAbortError as f,throwIfAborted as w,isAbortError as y}from"../core/promiseUtils.js";import{a as v,c as b,e as x}from"./screenUtils.js";import{s as M,j as S,k as T}from"./vec2.js";import{c as z}from"./vec2f32.js";import{R}from"./Rasterizer.js";import{S as I,v as P,w as C,x as D,P as E,F as A,E as F}from"./definitions.js";import{M as B,W as k}from"./enums4.js";import{h as L}from"./typedArrayUtil.js";import{R as j}from"./Rect.js";import{P as U,a as N,c as V,B as O,T as G,b as $}from"./enums3.js";import{T as q}from"./Texture.js";import{P as Z}from"./pbf.js";import{p as H}from"./floatRGBA.js";import{l as W}from"./GeometryUtils2.js";import{a as Y,b as Q,d as X,e as J,f as K,h as tt,s as et,j as it,k as st,l as at,m as nt,n as rt}from"./color.js";import{M as ot}from"../core/scheduling.js";import{c as ht}from"./imageutils2.js";import{o as ct}from"./enums.js";import{f as ut,h as lt}from"./cimAnalyzer.js";import{o as mt}from"./Matcher.js";import{Q as dt}from"./QueueProcessor.js";import{C as pt}from"./CircularArray.js";import gt from"../core/Evented.js";import{c as _t}from"./DisjointTimerQuery.js";import{_ as ft}from"./tslib.es6.js";import wt from"../core/Accessor.js";import{HandleOwnerMixin as yt}from"../core/HandleOwner.js";import{t as vt}from"./throttle.js";import{property as bt}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as xt}from"../core/accessorSupport/decorators/subclass.js";import{S as Mt}from"./FeatureSetReader.js";import{m as St}from"./lengthUtils.js";import{T as Tt}from"./sizeVariableUtils.js";import zt from"../Viewpoint.js";import Rt from"../geometry/Point.js";import{t as It,j as Pt,s as Ct,k as Dt,l as Et,i as At,p as Ft}from"../views/2d/ViewState.js";import{V as Bt}from"./InputManager.js";import"../geometry.js";import{when as kt}from"../core/reactiveUtils.js";import{d as Lt,g as jt,f as Ut}from"./vec3.js";import{P as Nt,R as Vt,Z as Ot}from"./ZoomMomentumEstimator.js";import{a as Gt}from"./vec2f64.js";import{c as $t}from"./ProgramTemplate.js";const qt={shaders:{vertexShader:t("bitBlit/bitBlit.vert"),fragmentShader:t("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class Zt{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new j(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new j;let i=null,s=-1;for(let a=0;a<this._free.length;++a){const n=this._free[a];t<=n.width&&e<=n.height&&(null===i||n.y<=i.y&&n.x<=i.x)&&(i=n,s=a)}return null===i?new j:(this._free.splice(s,1),i.width<i.height?(i.width>t&&this._free.push(new j(i.x+t,i.y,i.width-t,e)),i.height>e&&this._free.push(new j(i.x,i.y+e,i.width,i.height-e))):(i.width>t&&this._free.push(new j(i.x+t,i.y,i.width-t,i.height)),i.height>e&&this._free.push(new j(i.x,i.y+e,t,i.height-e))),new j(i.x,i.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const i=this._free[e];if(i.y===t.y&&i.height===t.height&&i.x+i.width===t.x)i.width+=t.width;else if(i.x===t.x&&i.width===t.width&&i.y+i.height===t.y)i.height+=t.height;else if(t.y===i.y&&t.height===i.height&&t.x+t.width===i.x)i.x=t.x,i.width+=t.width;else{if(t.x!==i.x||t.width!==i.width||t.y+t.height!==i.y)continue;i.y=t.y,i.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}const Ht=t=>Math.floor(t/256);class Wt{constructor(t,e,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=i,this._binPack=new Zt(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const t=[117,149,181,207,207,181,149,117],e=[];for(let i=0;i<t.length;i++){const s=t[i];for(let t=0;t<11;t++)e.push(s)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(e)};this._recordGlyph(i)}async getGlyphItems(t,e,i){const s=this._getGlyphCache(t);return await this._fetchRanges(t,e,i),e.map((e=>this._getMosaicItem(s,t,e)))}bind(t,e,i,s){const a=this._getTexture(t,i);a.setSamplingMode(e),this._dirties[i]&&(a.setData(this._glyphData[i]),this._dirties[i]=!1),t.bindTexture(a,s)}_getGlyphCache(t){return this._glyphCache[t]||(this._glyphCache[t]={}),this._glyphCache[t]}_getTexture(t,e){return this._textures[e]||(this._textures[e]=new q(t,{pixelFormat:U.ALPHA,dataType:N.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[e]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(t,e,i){const s=function(t){const e=new Set;for(const i of t)e.add(Ht(i));return e}(e),a=[];s.forEach((e=>{a.push(this._fetchRange(t,e,i))})),await Promise.all(a)}async _fetchRange(t,e,i){if(e>256)return;const s=t+e;return a=this._rangePromises,n=s,r=()=>this._glyphSource.getRange(t,e,i),a.has(n)||a.set(n,r().then((()=>{a.delete(n)})).catch((t=>{a.delete(n),g(t)}))),a.get(n);var a,n,r}_getMosaicItem(t,e,i){if(!t[i]){const s=this._glyphSource.getGlyph(e,i);if(!s||!s.metrics)return(t=>({rect:new j(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:t,sdf:!0}))(i);const a=this._recordGlyph(s),n=this._currentPage,r=s.metrics;t[i]={rect:a,page:n,metrics:r,code:i,sdf:!0},this._invalidate()}return t[i]}_recordGlyph(t){const e=t.metrics;let i;if(0===e.width)i=new j(0,0,0,0);else{const s=3,a=e.width+2*s,n=e.height+2*s;i=this._binPack.allocate(a,n),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new Zt(this.width-4,this.height-4),i=this._binPack.allocate(a,n));const r=this._glyphData[this._currentPage],o=t.bitmap;let h,c;if(o)for(let t=0;t<n;t++){h=a*t,c=this.width*(i.y+t)+i.x;for(let t=0;t<a;t++)r[c+t]=o[h+t]}L("esri-glyph-debug")&&this._showDebugPage(r)}return i}_showDebugPage(t){const e=document.createElement("canvas"),i=e.getContext("2d"),s=new ImageData(this.width,this.height),a=s.data;e.width=this.width,e.height=this.height,e.style.border="1px solid black";for(let e=0;e<t.length;++e)a[4*e]=t[e],a[4*e+1]=0,a[4*e+2]=0,a[4*e+3]=255;i.putImageData(s,0,0),document.body.appendChild(e)}}class Yt{constructor(t){for(this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:{const e=t.getMessage();for(;e.next();)switch(e.tag()){case 3:{const t=e.getMessage();let i,s,a,n,r,o,h;for(;t.next();)switch(t.tag()){case 1:i=t.getUInt32();break;case 2:s=t.getBytes();break;case 3:a=t.getUInt32();break;case 4:n=t.getUInt32();break;case 5:r=t.getSInt32();break;case 6:o=t.getSInt32();break;case 7:h=t.getUInt32();break;default:t.skip()}t.release(),i&&(this._metrics[i]={width:a,height:n,left:r,top:o,advance:h},this._bitmaps[i]=s);break}default:e.skip()}e.release();break}default:t.skip()}}getMetrics(t){return this._metrics[t]}getBitmap(t){return this._bitmaps[t]}}class Qt{constructor(){this._ranges=[]}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class Xt{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e,i){const a=this._getFontStack(t);if(a.getRange(e))return Promise.resolve();const n=256*e,r=n+255,o=this._baseURL.replace("{fontstack}",t).replace("{range}",n+"-"+r);return s(o,{responseType:"array-buffer",...i}).then((t=>{a.addRange(e,new Yt(new Z(new Uint8Array(t.data),new DataView(t.data))))}))}getGlyph(t,e){const i=this._getFontStack(t);if(!i)return;const s=Math.floor(e/256);if(s>256)return;const a=i.getRange(s);return a?{metrics:a.getMetrics(e),bitmap:a.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new Qt),e}}const Jt=1e20;class Kt{constructor(t){this._svg=null,this.size=t;const e=document.createElement("canvas");e.width=e.height=t,this._context=e.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(t,e,i=31){this._initSVG();const s=this.createSVGString(t);return new Promise(((t,a)=>{const n=new Image;n.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),n.onload=()=>{n.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(n,0,0,this.size,this.size);const e=this._context.getImageData(0,0,this.size,this.size),s=new Uint8Array(this.size*this.size*4);for(let t=0;t<this.size*this.size;t++){const i=e.data[4*t+3]/255;this._gridOuter[t]=1===i?0:0===i?Jt:Math.max(0,.5-i)**2,this._gridInner[t]=1===i?Jt:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let t=0;t<this.size*this.size;t++){const e=this._gridOuter[t]-this._gridInner[t];H(.5-e/(2*i),s,4*t)}t(s)};const r=e&&e.signal;r&&_(r,(()=>a(f())))}))}_initSVG(){if(!this._svg){const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("style","position: absolute;"),t.setAttribute("width","0"),t.setAttribute("height","0"),t.setAttribute("aria-hidden","true"),t.setAttribute("role","presentation"),document.body.appendChild(t),this._svg=t}return this._svg}createSVGString(t){const e=this._initSVG(),i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d",t),e.appendChild(i);const s=i.getBBox(),a=s.width/s.height,n=this.size/2;let r,o,h,c;if(a>1){o=r=n/s.width;const t=n*(1/a);h=this.size/4,c=n-t/2}else r=o=n/s.height,h=n-n*a/2,c=this.size/4;const u=-s.x*r+h,l=-s.y*o+c;i.setAttribute("style",`transform: matrix(${r}, 0, 0, ${o}, ${u}, ${l})`);const m=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${e.innerHTML}</svg>`;return e.removeChild(i),m}_edt(t,e,i){const s=this._f,a=this._d,n=this._v,r=this._z;for(let o=0;o<e;o++){for(let a=0;a<i;a++)s[a]=t[a*e+o];this._edt1d(s,a,n,r,i);for(let s=0;s<i;s++)t[s*e+o]=a[s]}for(let o=0;o<i;o++){for(let i=0;i<e;i++)s[i]=t[o*e+i];this._edt1d(s,a,n,r,e);for(let i=0;i<e;i++)t[o*e+i]=Math.sqrt(a[i])}}_edt1d(t,e,i,s,a){i[0]=0,s[0]=-Jt,s[1]=+Jt;for(let e=1,n=0;e<a;e++){let a=(t[e]+e*e-(t[i[n]]+i[n]*i[n]))/(2*e-2*i[n]);for(;a<=s[n];)n--,a=(t[e]+e*e-(t[i[n]]+i[n]*i[n]))/(2*e-2*i[n]);n++,i[n]=e,s[n]=a,s[n+1]=+Jt}for(let n=0,r=0;n<a;n++){for(;s[r+1]<n;)r++;e[n]=(n-i[r])*(n-i[r])+t[i[r]]}}}function te(t){return t&&"static"===t.type}class ee{constructor(t,e,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Zt(this._pageWidth,this._pageHeight);const s=Math.floor(this._pageWidth),a=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*a)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[0]}getHeight(t){return t>=this._mosaicPages.length?-1:this._mosaicPages[t].size[1]}getPageTexture(t){return t<this._mosaicPages.length?this._mosaicPages[t].texture:null}has(t){return this._mosaicRects.has(t)}get itemCount(){return this._mosaicRects.size}getSpriteItem(t){return this._mosaicRects.get(t)}addSpriteItem(t,e,i,s,a,n,r=1){if(this._mosaicRects.has(t))return this._mosaicRects.get(t);let o,h,c;if(te(i))[o,h,c]=this._allocateImage(e[0],e[1]);else{o=new j(0,0,e[0],e[1]),h=this._mosaicPages.length;const t=void 0;this._mosaicPages.push({mosaicsData:i,size:[e[0]+2*I,e[1]+2*I],dirty:!0,texture:t})}if(o.width<=0||o.height<=0)return null;const u={rect:o,width:e[0],height:e[1],sdf:a,simplePattern:n,pixelRatio:r,page:h};return this._mosaicRects.set(t,u),te(i)&&this._copy({rect:o,spriteSize:e,spriteData:i.data,page:h,pageSize:c,repeat:s,sdf:a}),u}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const t=this._spriteCopyQueue.pop();t&&this._copy(t)}getSpriteItems(t){const e={};for(const i of t)e[i]=this.getSpriteItem(i);return e}getMosaicItemPosition(t){const e=this.getSpriteItem(t),i=e&&e.rect;if(!i)return null;i.width=e.width,i.height=e.height;const s=e.width,a=e.height,n=I,r=this._mosaicPages[e.page];return{size:[e.width,e.height],tl:[(i.x+n)/r[0],(i.y+n)/r[1]],br:[(i.x+n+s)/r[0],(i.y+n+a)/r[1]],page:e.page}}bind(t,e,i=0,s=0){const a=this._mosaicPages[i],n=a.mosaicsData;let r=a.texture;r||(r=function(t,e){return new q(t,{pixelFormat:U.RGBA,dataType:N.UNSIGNED_BYTE,width:e[0],height:e[1]},null)}(t,a.size),a.texture=r),r.setSamplingMode(e),te(n)?(t.bindTexture(r,s),a.dirty&&(r.setData(new Uint8Array(n.data.buffer)),r.generateMipmap())):(n.data.bindFrame(t,r,s),r.generateMipmap()),a.dirty=!1}static _copyBits(t,e,i,s,a,n,r,o,h,c,u){let l=s*e+i,m=o*n+r;if(u){m-=n;for(let r=-1;r<=c;r++,l=((r+c)%c+s)*e+i,m+=n)for(let e=-1;e<=h;e++)a[m+e]=t[l+(e+h)%h]}else for(let i=0;i<c;i++){for(let e=0;e<h;e++)a[m+e]=t[l+e];l+=e,m+=n}}_copy(t){if(t.page>=this._mosaicPages.length)return;const e=this._mosaicPages[t.page],i=e.mosaicsData;if(!te(e.mosaicsData))throw new n("mapview-invalid-resource","unsuitable data type!");const s=t.spriteData,a=i.data;a&&s||console.error("Source or target images are uninitialized!"),ee._copyBits(s,t.spriteSize[0],0,0,a,t.pageSize[0],t.rect.x+I,t.rect.y+I,t.spriteSize[0],t.spriteSize[1],t.repeat),e.dirty=!0}_allocateImage(t,e){t+=2*I,e+=2*I;const i=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil(W(t)),s=2**Math.ceil(W(e)),a=new j(0,0,t,e);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[a,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(t,e);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&te(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Zt(this._pageWidth,this._pageHeight),this._allocateImage(t,e)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const t of this._mosaicPages){const e=t.texture;e&&e.dispose();const i=t.mosaicsData;te(i)||i.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}}function ie(t){return ot(t.frameDurations.reduce(((t,e)=>t+e),0))}function se(t,e){const{width:i,height:s,getFrame:a}=t,n=t.frameDurations.slice(),r=n.pop();return n.push(ot(r+e)),{frameDurations:n,getFrame:a,width:i,height:s}}class ae{constructor(t,e,i,s){this._animation=t,this._repeatType=i,this._onFrameData=s,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let a=0;for(;e>a;)a+=this.timeToFrame,this.nextFrame();const n=this._animation.getFrame(this._currentFrame);this._onFrameData(n)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case ct.None:this._currentFrame-=this._direction;break;case ct.Loop:this._currentFrame=0;break;case ct.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(-1===this._currentFrame)switch(this._repeatType){case ct.None:this._currentFrame-=this._direction;break;case ct.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case ct.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame];const t=this._animation.getFrame(this._currentFrame);this._onFrameData(t)}}const ne=document.createElement("canvas"),re=ne.getContext("2d");class oe{constructor(t,e,i,s){this._animation=t,this._frameData=null,this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=function(t,e,i,s){const a=null==e.playAnimation||e.playAnimation,n=function(t,e,i,s){let a,{repeatType:n}=e;if(null==n&&(n=ct.Loop),!0===e.reverseAnimation&&(t=function(t){const{width:e,height:i}=t;return{frameDurations:t.frameDurations.reverse(),getFrame:e=>{const i=t.frameDurations.length-1-e;return t.getFrame(i)},width:e,height:i}}(t)),null!=e.duration&&(t=function(t,e){const{width:i,height:s,getFrame:a}=t,n=e/ie(t);return{frameDurations:t.frameDurations.map((t=>ot(t*n))),getFrame:a,width:i,height:s}}(t,ot(1e3*e.duration))),null!=e.repeatDelay){const i=1e3*e.repeatDelay;n===ct.Loop?t=se(t,ot(i)):n===ct.Oscillate&&(t=function(t,e){const{width:i,height:s,getFrame:a}=t,n=t.frameDurations.slice(),r=n.shift();return n.unshift(ot(r+e)),{frameDurations:n,getFrame:a,width:i,height:s}}(se(t,ot(i/2)),ot(i/2)))}if(null!=e.startTimeOffset)a=ot(1e3*e.startTimeOffset);else if(null!=e.randomizeStartTime){const s=ut(i),n=82749913,r=null!=e.randomizeStartSeed?e.randomizeStartSeed:n,o=lt(s,r);a=ot(o*ie(t))}else a=ot(0);return new ae(t,a,n,s)}(t,e,i,s);let r,o=n.timeToFrame;return function t(){r=a?setTimeout((()=>{n.nextFrame(),o=n.timeToFrame,t()}),o):void 0}(),{remove:()=>{a&&clearTimeout(r)}}}(this._animation,i,s,(t=>{this._frameData=t,e.requestRender()}))}destroy(){this._playHandle.remove()}bindFrame(t,e,i){t.bindTexture(e,i),u(this._frameData)||(e.updateData(0,I,I,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}}const he=z(),ce="arial-unicode-ms-regular",ue=o.getLogger("esri.views.2d.engine.webgl.TextureManager");function le(t,e){const i=Math.round(v(e)*window.devicePixelRatio),s=i>=128?2:4;return Math.min(t,i*s)}const me=(t,e,i)=>ue.error(new n(t,e,i));class de{static fromMosaic(t,e){return new de(t,e.page,e.sdf)}constructor(t,e,i){this.mosaicType=t,this.page=e,this.sdf=i}}class pe{constructor(t,e,a){this._requestRender=t,this.resourceManager=e,this._allowNonPowerOfTwo=a,this._invalidFontsMap=new Map,this._sdfConverter=new Kt(P),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new dt({concurrency:10,process:async(t,e)=>{w(e);try{return await s(t,{responseType:"image",signal:e})}catch(e){if(!y(e))throw new n("mapview-invalid-resource",`Could not fetch requested resource at ${t}`,e);throw e}}}),this._spriteMosaic=new ee(2048,2048,500),this._glyphSource=new Xt(`${i.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Wt(1024,1024,this._glyphSource),this._rasterizer=new R(e)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(t,e,i,s){if(u(t))return me("mapview-null-resource","Unable to rasterize null resource"),null;switch(t.type){case"text":case"esriTS":{const e=await this._rasterizeText(t,i,s);return e.forEach((t=>this._setTextureBinding(B.GLYPH,t))),{glyphMosaicItems:e}}default:{if(Y(t))return me("mapview-invalid-type",`MapView does not support symbol type: ${t.type}`,t),null;const i=await this._rasterizeSpriteSymbol(t,e,s);return mt(i)&&i&&this._setTextureBinding(B.SPRITE,i),{spriteMosaicItem:i}}}}bindTextures(t,e,i,s=!1){if(0===i.textureBinding)return;const a=this._bindingInfos[i.textureBinding-1],n=a.page,r=s?V.LINEAR_MIPMAP_LINEAR:V.LINEAR;switch(a.mosaicType){case B.SPRITE:{const i=this.sprites.getWidth(n),s=this.sprites.getHeight(n),a=M(he,i,s);return this._spriteMosaic.bind(t,r,n,D),e.setUniform1i("u_texture",D),void e.setUniform2fv("u_mosaicSize",a)}case B.GLYPH:{const i=this.glyphs.width,s=this.glyphs.height,a=M(he,i,s);return this._glyphMosaic.bind(t,r,n,C),e.setUniform1i("u_texture",C),void e.setUniform2fv("u_mosaicSize",a)}default:ue.error("mapview-texture-manager",`Cannot handle unknown type ${a.mosaicType}`)}}_hashMosaic(t,e){return 1|t<<1|(e.sdf?1:0)<<2|e.page<<3}_setTextureBinding(t,e){const i=this._hashMosaic(t,e);if(!this._hashToBindingIndex.has(i)){const s=de.fromMosaic(t,e),a=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,a),this._bindingInfos.push(s)}e.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(t,e,i){let s,n;if("cim"in t){const e=t;s=e.fontName,n=e.text}else{const e=t;s=r(e.font),n=e.text}const o=this._invalidFontsMap.has(s),h=e||Q(a(n)[0]);try{return await this._glyphMosaic.getGlyphItems(o?ce:s,h,i)}catch(t){return me("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(s,!0),this._glyphMosaic.getGlyphItems(ce,h,i)}}async _rasterizeSpriteSymbol(t,e,i){if(X(t))return;const s=function(t){switch(t.type){case"esriSMS":return`${t.style}.${t.path}`;case"esriSLS":return`${t.style}.${t.cap}`;case"esriSFS":return`${t.style}`;case"esriPFS":case"esriPMS":return t.imageData?`${t.imageData}${t.width}${t.height}`:`${t.url}${t.width}${t.height}`;default:return"mosaicHash"in t?t.mosaicHash:JSON.stringify(t)}}(t);if(this._spriteMosaic.has(s))return this._spriteMosaic.getSpriteItem(s);if(J(t)||K(t)&&!tt(t))return this._handleAsyncResource(s,t,i);const a=E,r=this._rasterizer.rasterizeJSONResource(t,a);if(r){const{size:e,image:i,sdf:a,simplePattern:n,rasterizationScale:o}=r;return this._addItemToMosaic(s,e,{type:"static",data:i},et(t),a,n,o)}return new n("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(t,e,i){if(this._ongoingRasterizations.has(t))return this._ongoingRasterizations.get(t);let s;s=J(e)?this._handleSVG(e,t,i):this._handleImage(e,t,i),this._ongoingRasterizations.set(t,s);try{await s,this._ongoingRasterizations.delete(t)}catch{this._ongoingRasterizations.delete(t)}return s}async _handleSVG(t,e,i){const s=[P,P],a=await this._sdfConverter.draw(t.path,i);return this._addItemToMosaic(e,s,{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)}async _handleGIFOrPNG(t,e,i){const s=it(t);await this.resourceManager.fetchResource(s,i);let a=this.resourceManager.getResource(s);if(u(a))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${s}.`);let r=a.width,o=a.height;if(a instanceof HTMLImageElement){"esriPMS"===t.type&&(r=Math.round(le(a.width,st(t))),o=Math.round(a.height*(r/a.width)));const i="cim"in t?t.cim.colorSubstitutions:void 0,{size:s,sdf:n,image:h}=this._rasterizer.rasterizeImageResource(r,o,a,i);return this._addItemToMosaic(e,s,{type:"static",data:h},et(t),n,!1)}this._allowNonPowerOfTwo||(r=h(a.width+2*I)-2*I,o=h(a.height+2*I)-2*I),r===a.width&&o===a.height||(a=function(t,e,i){ne.width=e,ne.height=i;const s=[],a=t.frameDurations.length;for(let n=0;n<a;n++){const a=t.getFrame(n);re.clearRect(0,0,e,i),a instanceof ImageData?re.drawImage(ht(a),0,0,e,i):re.drawImage(a,0,0,e,i),s.push(re.getImageData(0,0,e,i))}return{width:e,height:i,frameDurations:t.frameDurations,getFrame:t=>s[t]}}(a,r,o));const c=t.animatedSymbolProperties||{},l=t.objectId,m=new oe(a,this._requestRender,c,l);return this._addItemToMosaic(e,[m.width,m.height],{type:"animated",data:m},et(t),!1,!1)}async _handleImage(t,e,i){if(at(t)||nt(t))return this._handleGIFOrPNG(t,e,i);const s=it(t);try{let a;const n=this.resourceManager.getResource(s);if(l(n)&&n instanceof HTMLImageElement)a=n;else{const{data:t}=await this._imageRequestQueue.push(s,{...i});a=t}if(rt(s))if("width"in t&&"height"in t)a.width=v(t.width),a.height=v(t.height);else if("cim"in t){const e=t.cim;a.width=v(e.width??e.scaleX*e.size),a.height=v(e.size)}if(!a.width||!a.height)return null;let r=a.width,o=a.height;"esriPMS"===t.type&&(r=Math.round(le(a.width,st(t))),o=Math.round(a.height*(r/a.width)));const h="cim"in t?t.cim.colorSubstitutions:void 0,{size:c,sdf:u,image:m}=this._rasterizer.rasterizeImageResource(r,o,a,h);return this._addItemToMosaic(e,c,{type:"static",data:m},et(t),u,!1)}catch(t){if(!y(t))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${t.message}`)}}_addItemToMosaic(t,e,i,s,a,n,r){return this._spriteMosaic.addSpriteItem(t,e,i,s,a,n,r)}}const ge={shaders:{vertexShader:t("stencil/stencil.vert"),fragmentShader:t("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},_e=t=>`#define ${(t=>t.replace("-","_").toUpperCase())(t)}\n`;function fe(e){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:_e(e)+t("blend/blend.vert"),fragmentShader:_e(e)+t("blend/blend.frag")}}}const we=o.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class ye{constructor(){this._size=[0,0]}dispose(t){this._backBufferTexture=m(this._backBufferTexture),this._quad=m(this._quad)}draw(t,e,i,s,a){const{context:r,drawPhase:o}=t;if(this._setupShader(r),s&&"normal"!==s&&o!==k.LABEL)return void this._drawBlended(t,e,i,s,a);const h=fe("normal"),c=r.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!c)return void we.error(new n("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));r.useProgram(c),e.setSamplingMode(i),r.bindTexture(e,0),c.setUniform1i("u_layerTexture",0),c.setUniform1f("u_opacity",a),r.setBlendingEnabled(!0),r.setBlendFunction(O.ONE,O.ONE_MINUS_SRC_ALPHA);const u=this._quad;u.draw(),u.unbind(),c.dispose()}_drawBlended(t,e,i,s,a){const{context:r,state:o,pixelRatio:h,inFadeTransition:c}=t,{size:u}=o,m=r.getBoundFramebufferObject();let d,p;if(l(m)){const t=m.descriptor;d=t.width,p=t.height}else d=Math.round(h*u[0]),p=Math.round(h*u[1]);this._createOrResizeTexture(t,d,p);const g=this._backBufferTexture;m.copyToTexture(0,0,d,p,0,0,g),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),r.setBlendingEnabled(!0),r.setDepthTestEnabled(!1),r.setDepthWriteEnabled(!1);const _=fe(s),f=r.programCache.acquire(_.shaders.vertexShader,_.shaders.fragmentShader,_.attributes);if(!f)return void we.error(new n("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));r.useProgram(f),g.setSamplingMode(i),r.bindTexture(g,0),f.setUniform1i("u_backbufferTexture",0),e.setSamplingMode(i),r.bindTexture(e,1),f.setUniform1i("u_layerTexture",1),f.setUniform1f("u_opacity",a),f.setUniform1f("u_inFadeOpacity",c?1:0),r.setBlendFunction(O.ONE,O.ZERO);const w=this._quad;w.draw(),w.unbind(),f.dispose(),r.setBlendFunction(O.ONE,O.ONE_MINUS_SRC_ALPHA)}_setupShader(t){this._quad||(this._quad=new e(t,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(t,e,i){const{context:s}=t;null!==this._backBufferTexture&&e===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(e,i):this._backBufferTexture=new q(s,{target:G.TEXTURE_2D,pixelFormat:U.RGBA,internalFormat:U.RGBA,dataType:N.UNSIGNED_BYTE,wrapMode:$.CLAMP_TO_EDGE,samplingMode:V.LINEAR,flipped:!1,width:e,height:i}),this._size[0]=e,this._size[1]=i)}}const ve={shaders:{vertexShader:t("highlight/textured.vert"),fragmentShader:t("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},be={shaders:{vertexShader:t("highlight/textured.vert"),fragmentShader:t("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},xe=L("esri-2d-profiler");class Me{constructor(t,e){if(this._events=new gt,this._entries=new Map,this._timings=new pt(10),this._currentContainer=null,this._currentPass=null,this._currentBrush=null,this._currentSummary=null,!xe)return;this._ext=_t(t.gl,{}),this._debugOutput=e;const i=t.gl;if(this.enableCommandLogging)for(const t in i)if("function"==typeof i[t]){const e=i[t],s=t.includes("draw");i[t]=(...a)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:t,args:a,isDrawCommand:s}),this._currentSummary&&(this._currentSummary.commands++,s&&this._currentSummary.drawCommands++),e.apply(i,a))}}get enableCommandLogging(){return!("object"==typeof xe&&xe.disableCommands)}recordContainerStart(t){xe&&(this._currentContainer=t)}recordContainerEnd(){xe&&(this._currentContainer=null)}recordPassStart(t){xe&&(this._currentPass=t,this._initSummary())}recordPassEnd(){xe&&(this._currentPass=null,this._emitSummary())}recordBrushStart(t){xe&&(this._currentBrush=t)}recordBrushEnd(){xe&&(this._currentBrush=null)}recordStart(t){if(xe&&l(this._ext)){if(this._entries.has(t)){const e=this._entries.get(t),i=this._ext.resultAvailable(e.query),s=this._ext.disjoint();if(i&&!s){const i=this._ext.getResult(e.query)/1e6;let s=0;if(l(this._timings.enqueue(i))){const t=this._timings.entries,e=t.length;let i=0;for(const e of t)i+=e;s=i/e}const a=i.toFixed(2),n=s?s.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${t}, ${a} ms (${n} last 10 avg)\n${e.commandsLen} Commands (${e.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(e.summaries),console.log("Commands: ",e.commands),console.groupEnd()):console.log(`Frame report for ${t}, ${a} ms (${n} last 10 avg)`),this._debugOutput.innerHTML=`${a} (${n})`}for(const t of e.handles)t.remove();this._ext.deleteQuery(e.query),this._entries.delete(t)}const e={name:t,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(e.handles.push(this._events.on("command",(t=>{e.commandsLen++,e.commands.push(t),t.isDrawCommand&&e.drawCommands++}))),e.handles.push(this._events.on("summary",(t=>{e.summaries.push(t)})))),this._ext.beginTimeElapsed(e.query),this._entries.set(t,e)}}recordEnd(t){xe&&l(this._ext)&&this._entries.has(t)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._currentSummary&&this._events.emit("summary",this._currentSummary)}}class Se{constructor(t,e,i){this._debugMap=new Map,this._width=t*i,this._height=e*i,this._pixelRatio=i;const s=Math.ceil(this._width/1),a=Math.ceil(this._height/1);this._cols=s,this._rows=a,this._cells=Mt.create(s*a)}insertMetrics(t){const e=this._hasCollision(t);return 0===e&&this._markMetrics(t),e}getCellId(t,e){return t+e*this._cols}has(t){return this._cells.has(t)}hasRange(t,e){return this._cells.hasRange(t,e)}set(t){this._cells.set(t)}setRange(t,e){this._cells.setRange(t,e)}_collide(t,e,i,s){const a=t-i/2,n=e-s/2,r=a+i,o=n+s;if(r<0||o<0||a>this._width||n>this._height)return 1;const h=c(Math.floor(a/1),0,this._cols),u=c(Math.floor(n/1),0,this._rows),l=c(Math.ceil(r/1),0,this._cols),m=c(Math.ceil(o/1),0,this._rows);for(let t=u;t<=m;t++)for(let e=h;e<=l;e++){const i=this.getCellId(e,t);if(this.has(i))return 2}return 0}_mark(t,e,i,s,a){const n=t-i/2,r=e-s/2,o=n+i,h=r+s,u=c(Math.floor(n/1),0,this._cols),l=c(Math.floor(r/1),0,this._rows),m=c(Math.ceil(o/1),0,this._cols),d=c(Math.ceil(h/1),0,this._rows);for(let t=l;t<=d;t++)for(let e=u;e<=m;e++){const i=this.getCellId(e,t);this._debugMap.set(i,a),this.set(i)}return!1}_hasCollision(t){const e=t.id;let i=0,s=0;t.save();do{const e=t.boundsCount;i+=e;for(let i=0;i<e;i++){const e=t.boundsComputedAnchorX(i),a=t.boundsComputedAnchorY(i),n=(t.boundsWidth(i)+2)*this._pixelRatio,r=(t.boundsHeight(i)+2)*this._pixelRatio;switch(this._collide(e,a,n,r)){case 2:return 2;case 1:s++}}}while(t.peekId()===e&&t.next());return t.restore(),i===s?1:0}_markMetrics(t){const e=t.id;t.save();do{const e=t.boundsCount;for(let i=0;i<e;i++){const e=t.boundsComputedAnchorX(i),s=t.boundsComputedAnchorY(i),a=(t.boundsWidth(i)+2)*this._pixelRatio,n=(t.boundsHeight(i)+2)*this._pixelRatio;this._mark(e,s,a,n,t.id)}}while(t.peekId()===e&&t.next());t.restore()}}const Te=Math.PI;function ze(t,e){switch(e.transformationType){case Tt.Additive:return function(t,e){return t+(Re(e.minSize,t)||e.minDataValue)}(t,e);case Tt.Constant:return function(t,e){const i=t.stops;let s=i&&i.length&&i[0].size;return null==s&&(s=t.minSize),Re(s,e)}(e,t);case Tt.ClampedLinear:return function(t,e){const i=e.minDataValue,s=e.maxDataValue,a=(t-i)/(s-i),n=Re(e.minSize,t),r=Re(e.maxSize,t);return t<=i?n:t>=s?r:n+a*(r-n)}(t,e);case Tt.Proportional:return function(t,e){const i=t/e.minDataValue,s=Re(e.minSize,t),a=Re(e.maxSize,t);let n=null;return n=i*s,c(n,s,a)}(t,e);case Tt.Stops:return function(t,e){const[i,s,a]=function(t,e){if(!e)return;let i=0,s=e.length-1;return e.some(((e,a)=>t<e?(s=a,!0):(i=a,!1))),[i,s,(t-e[i])/(e[s]-e[i])]}(t,e.cache.ipData);if(i===s)return Re(e.stops[i].size,t);{const n=Re(e.stops[i].size,t);return n+(Re(e.stops[s].size,t)-n)*a}}(t,e);case Tt.RealWorldSize:return function(t,e){const i=St[e.valueUnit],s=Re(e.minSize,t),a=Re(e.maxSize,t),{valueRepresentation:n}=e;let r=null;return r="area"===n?2*Math.sqrt(t/Te)/i:"radius"===n||"distance"===n?2*t/i:t/i,c(r,s,a)}(t,e);case Tt.Identity:return t;case Tt.Unknown:return null}}function Re(t,e){return"number"==typeof t?t:ze(e,t)}const Ie=255;function Pe(t,e){const i=[];t.forEachTile((t=>i.push(t))),i.sort(((t,e)=>t.instanceId-e.instanceId)),i.forEach((t=>{l(t.labelMetrics)&&t.isReady&&e(t,t.labelMetrics.getCursor())}))}function Ce(t){return e=>v(ze(e,t))}function De(t,e){if(!function(t){return t.layer&&("feature"===t.layer.type||"csv"===t.layer.type||"geojson"===t.layer.type||"ogc-feature"===t.layer.type||"stream"===t.layer.type||"subtype-group"===t.layer.type||"wfs"===t.layer.type)}(e))return;const i="subtype-group"===e.layer.type?e.layer.sublayers.items:[e.layer],s=e.layer.geometryType,a=!function(t){for(const e of t){const t="featureReduction"in e&&e.featureReduction&&"labelingInfo"in e.featureReduction?e.featureReduction:void 0,i=[...e.labelingInfo||[],...t?.labelingInfo||[]];if(e.labelsVisible&&i.length&&i.some((t=>"none"===t.deconflictionStrategy)))return!0}return!1}(i),n={};if("subtype-group"!==e.layer.type){if("heatmap"===e.tileRenderer?.type)return;const t=function(t){const e=null!=t&&"visualVariables"in t&&t.visualVariables;if(!e)return null;for(const t of e)if("size"===t.type)return Ce(t);return null}(e.layer.renderer);n[0]=t}const r=e.tileRenderer;if(u(r))return;const o=e.layer.visible&&!e.suspended;t.push({tileRenderer:r,vvEvaluators:n,deconflictionEnabled:a,geometryType:s,visible:o})}class Ee{run(t,e,i){const s=[];for(let e=t.length-1;e>=0;e--)De(s,t[e]);this._transformMetrics(s),this._runCollision(s,e,i)}_runCollision(t,e,i){const[s,a]=e.state.size,n=new Se(s,a,e.pixelRatio);for(const{tileRenderer:e,deconflictionEnabled:s,visible:a}of t){const t=e.featuresView.attributeView;s?a?(this._prepare(e),this._collideVisible(n,e,i),this._collideInvisible(n,e)):Pe(e,((e,i)=>{for(;i.nextId();)t.setLabelMinZoom(i.id,Ie)})):Pe(e,((e,i)=>{for(;i.nextId();)t.setLabelMinZoom(i.id,0),a&&n.insertMetrics(i)}))}}_isFiltered(t,e,i){const s=e.getFilterFlags(t),a=!i.hasFilter||!!(s&A),n=u(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(s&F);return!(a&&n)}_prepare(t){const e=t.featuresView.attributeView,i=new Set;Pe(t,((s,a)=>{for(;a.nextId();)i.has(a.id)||(i.add(a.id),this._isFiltered(a.id,e,t.layerView)?e.setLabelMinZoom(a.id,254):0!==e.getLabelMinZoom(a.id)?e.setLabelMinZoom(a.id,Ie):e.setLabelMinZoom(a.id,0))}))}_collideVisible(t,e,i){const s=e.featuresView.attributeView,a=new Set;Pe(e,((e,n)=>{for(;n.nextId();)if(!a.has(n.id))if(e.key.level===i){if(0===s.getLabelMinZoom(n.id))switch(t.insertMetrics(n)){case 1:break;case 2:s.setLabelMinZoom(n.id,254),a.add(n.id);break;case 0:s.setLabelMinZoom(n.id,0),a.add(n.id)}}else s.setLabelMinZoom(n.id,254)}))}_collideInvisible(t,e){const i=e.featuresView.attributeView,s=new Set;Pe(e,((e,a)=>{for(;a.nextId();)if(!s.has(a.id)&&i.getLabelMinZoom(a.id)===Ie)switch(t.insertMetrics(a)){case 1:break;case 2:i.setLabelMinZoom(a.id,Ie),s.add(a.id);break;case 0:i.setLabelMinZoom(a.id,0),s.add(a.id)}}))}_transformMetrics(t){for(const{tileRenderer:e,geometryType:i,vvEvaluators:s}of t)Pe(e,((t,a)=>{const n=e.featuresView.attributeView,r=t.transforms.labelMat2d;r[4]=Math.round(r[4]),r[5]=Math.round(r[5]);const o="polyline"===i;for(;a.next();){const t=a.boundsCount,e=a.anchorX,i=a.anchorY;let h=a.size;const c=s[0];if(l(c)){const t=c(n.getVVSize(a.id));h=isNaN(t)||null==t||t===1/0?h:t}const u=a.directionX*(h/2),m=a.directionY*(h/2);for(let s=0;s<t;s++){let t=e,n=a.anchorY;if(o){let e=t+a.boundsX(s)+u,i=n+a.boundsY(s)+m;e=r[0]*e+r[2]*i+r[4],i=r[1]*e+r[3]*i+r[5],a.setBoundsComputedAnchorX(s,Math.floor(e)),a.setBoundsComputedAnchorY(s,Math.floor(i))}else{t=r[0]*e+r[2]*i+r[4],n=r[1]*e+r[3]*i+r[5];const o=t+a.boundsX(s)+u,h=n+a.boundsY(s)+m;a.setBoundsComputedAnchorX(s,o),a.setBoundsComputedAnchorY(s,h)}}}}))}}let Ae=class extends(yt(wt)){constructor(t){super(t),this._applyVisibilityPassThrottled=vt(this._applyVisibilityPass,32,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new Ee}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled=d(this._applyVisibilityPassThrottled)}get updating(){return L("esri-2d-log-updating")&&console.log(`Updating LabelManager ${this.updateRequested}:\n-> updateRequested: ${this.updateRequested}`),this.updateRequested}update(t){this._applyVisibilityPassThrottled(t)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view?.requestUpdate())}processUpdate(t){this._set("updateParameters",t),this.updateRequested&&(this.updateRequested=!1,this.update(t))}_applyVisibilityPass(t){const e=this.view;if(e)try{const i=e.featuresTilingScheme.getClosestInfoForScale(t.state.scale).level;this.collisionEngine.run(e.allLayerViews.items,t,i)}catch(t){}}};ft([bt()],Ae.prototype,"updateRequested",void 0),ft([bt({readOnly:!0})],Ae.prototype,"updateParameters",void 0),ft([bt()],Ae.prototype,"updating",null),ft([bt()],Ae.prototype,"view",void 0),Ae=ft([xt("esri.views.2d.layers.labels.LabelManager")],Ae);const Fe=Ae,Be="esri-zoom-box",ke={container:`${Be}__container`,overlay:`${Be}__overlay`,background:`${Be}__overlay-background`,box:`${Be}__outline`},Le="Shift";let je=class extends wt{constructor(t){super(t),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._rafId=null,this._handles=null,this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(t){this._handles&&this._handles.forEach((t=>{t.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",t),t&&(t.on("drag",[Le],(t=>this._handleDrag(t,1)),Bt.INTERNAL),t.on("drag",[Le,"Ctrl"],(t=>this._handleDrag(t,-1)),Bt.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(t,e,i,s){this._box.x=t,this._box.y=e,this._box.width=i,this._box.height=s,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(t,e,i,s,a){const n=this.view,r=n.toMap(b(t+.5*i,e+.5*s));let o=Math.max(i/n.width,s/n.height);-1===a&&(o=1/o),this._destroyOverlay(),this.navigation.end(),n.goTo({center:r,scale:n.scale*o})}_updateBox(t,e,i,s){const a=this._boxShape;a.setAttributeNS(null,"x",""+t),a.setAttributeNS(null,"y",""+e),a.setAttributeNS(null,"width",""+i),a.setAttributeNS(null,"height",""+s),a.setAttributeNS(null,"class",ke.box)}_updateBackground(t,e,i,s){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(t,e,i,s,this.view.width,this.view.height))}_createContainer(){const t=document.createElement("div");t.className=ke.container,this.view.root.appendChild(t),this._container=t}_createOverlay(){const t=this.view.width,e=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+t+" 0 L "+t+" "+e+" L 0 "+e+" Z"),i.setAttributeNS(null,"class",ke.background);const s=document.createElementNS("http://www.w3.org/2000/svg","rect"),a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),a.setAttributeNS(null,"class",ke.overlay),a.appendChild(i),a.appendChild(s),this._container.appendChild(a),this._backgroundShape=i,this._boxShape=s,this._overlay=a}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(t,e,i,s,a,n){const r=t+i,o=e+s;return"M 0 0 L "+a+" 0 L "+a+" "+n+" L 0 "+n+" ZM "+t+" "+e+" L "+t+" "+o+" L "+r+" "+o+" L "+r+" "+e+" Z"}_handleDrag(t,e){const i=t.x,s=t.y,a=t.origin.x,n=t.origin.y;let r,o,h,c;switch(i>a?(r=a,h=i-a):(r=i,h=a-i),s>n?(o=n,c=s-n):(o=s,c=n-s),t.action){case"start":this._start();break;case"update":this._update(r,o,h,c);break;case"end":this._end(r,o,h,c,e)}t.stopPropagation()}_redraw(){if(!this._rafId)return;if(this._rafId=null,!this._overlay)return;const{x:t,y:e,width:i,height:s}=this._box;this._updateBox(t,e,i,s),this._updateBackground(t,e,i,s),this._rafId=requestAnimationFrame(this._redraw)}};ft([bt()],je.prototype,"navigation",void 0),ft([bt()],je.prototype,"view",null),je=ft([xt("esri.views.2d.navigation.ZoomBox")],je);const Ue=je;let Ne=class extends wt{constructor(t){super(t),this.animationTime=0,this.momentumEstimator=new Nt(500,6,.92),this.momentum=null,this.tmpMomentum=Lt(),this.momentumFinished=!1,this.viewpoint=new zt({targetGeometry:new Rt,scale:0,rotation:0}),this._previousDrag=null,kt((()=>this.momentumFinished),(()=>this.navigation.stop()))}begin(t,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this._previousDrag=e}update(t,e){this.addToEstimator(e);let i=e.center.x,s=e.center.y;const a=this._previousDrag;i=a?a.center.x-i:-i,s=a?s-a.center.y:s,t.viewpoint=It(this.viewpoint,t.viewpoint,[i||0,s||0]),this._previousDrag=e}end(t,e){this.addToEstimator(e);const i=t.navigation.momentumEnabled;this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(t),this._previousDrag=null,this.navigation.end()}addToEstimator(t){const e=t.center.x,i=t.center.y,s=x(-e,i),a=Ut(-e,i,0);this.momentumEstimator.add(s,a,.001*t.timestamp)}onAnimationUpdate(t){this.navigation.animationManager?.animateContinous(t.viewpoint,((e,i)=>{const{momentum:s,animationTime:a,tmpMomentum:n}=this,r=.001*i;if(!(this.momentumFinished=!s||s.isFinished(a))){const i=s.valueDelta(a,r);jt(n,s.direction,i),It(e,e,n),t.constraints.constrainByGeometry(e)}this.animationTime+=r}))}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};ft([bt()],Ne.prototype,"momentumFinished",void 0),ft([bt()],Ne.prototype,"viewpoint",void 0),ft([bt()],Ne.prototype,"navigation",void 0),Ne=ft([xt("esri.views.2d.navigation.actions.Pan")],Ne);const Ve=Ne;let Oe=class extends wt{constructor(t){super(t),this._animationTime=0,this._momentumFinished=!1,this._previousAngle=0,this._previousRadius=0,this._previousCenter=null,this._rotationMomentumEstimator=new Vt(.6,.15,.95),this._rotationDirection=1,this._startAngle=0,this._startRadius=0,this._updateTimestamp=null,this._zoomDirection=1,this._zoomMomentumEstimator=new Ot,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new zt({targetGeometry:new Rt,scale:0,rotation:0}),this.addHandles(kt((()=>this._momentumFinished),(()=>this.navigation.stop())))}begin(t,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,t.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(t,e){null===this._updateTimestamp&&(this._updateTimestamp=e.timestamp);const i=e.angle,s=e.radius,a=e.center,n=Math.abs(180*(i-this._startAngle)/Math.PI),r=Math.abs(s-this._startRadius),o=this._startRadius/s;if(this._previousRadius&&this._previousCenter){const h=s/this._previousRadius;let c=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=c>=0?1:-1,this._zoomDirection=h>=1?1:-1,t.constraints.rotationEnabled?(null===this._zoomOnly&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=r-n>0),null===this._zoomOnly||this._zoomOnly?c=0:this.addToRotateEstimator(i-this._startAngle,e.timestamp)):c=0,this.addToZoomEstimator(e,o),this.navigation.setViewpoint([a.x,a.y],1/h,c,[this._previousCenter.x-a.x,a.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=s,this._previousCenter=a}end(t){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(t),this.navigation.end()}addToRotateEstimator(t,e){this._rotationMomentumEstimator.add(t,.001*e)}addToZoomEstimator(t,e){this._zoomMomentumEstimator.add(e,.001*t.timestamp)}canZoomIn(t){const e=t.scale,i=t.constraints.effectiveMaxScale;return 0===i||e>i}canZoomOut(t){const e=t.scale,i=t.constraints.effectiveMinScale;return 0===i||e<i}onAnimationUpdate(t){this.navigation.animationManager?.animateContinous(t.viewpoint,((e,i)=>{const s=!this.canZoomIn(t)&&this._zoomDirection>1||!this.canZoomOut(t)&&this._zoomDirection<1,a=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=s||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),r=.001*i;if(this._momentumFinished=a&&n,!this._momentumFinished){const i=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,r))*this._rotationDirection*180/Math.PI:0;let s=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,r)):1;const a=Gt(),n=Gt();if(this._previousCenter){M(a,this._previousCenter.x,this._previousCenter.y),Pt(n,t.size,t.padding),S(a,a,n);const{constraints:r,scale:o}=t,h=o*s;s<1&&!r.canZoomInTo(h)?(s=o/r.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):s>1&&!r.canZoomOutTo(h)&&(s=o/r.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),Ct(e,t.viewpoint,s,i,a,t.size),t.constraints.constrainByGeometry(e)}}this._animationTime+=r}))}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};ft([bt()],Oe.prototype,"_momentumFinished",void 0),ft([bt()],Oe.prototype,"viewpoint",void 0),ft([bt()],Oe.prototype,"navigation",void 0),Oe=ft([xt("esri.views.2d.navigation.actions.Pinch")],Oe);const Ge=Oe,$e=Gt(),qe=Gt();let Ze=class extends wt{constructor(t){super(t),this._previousCenter=Gt(),this.viewpoint=new zt({targetGeometry:new Rt,scale:0,rotation:0})}begin(t,e){this.navigation.begin(),M(this._previousCenter,e.center.x,e.center.y)}update(t,e){const{state:{size:i,padding:s}}=t;M($e,e.center.x,e.center.y),Dt(qe,i,s),t.viewpoint=Et(this.viewpoint,t.state.paddedViewState.viewpoint,At(qe,this._previousCenter,$e)),T(this._previousCenter,$e)}end(){this.navigation.end()}};ft([bt()],Ze.prototype,"viewpoint",void 0),ft([bt()],Ze.prototype,"navigation",void 0),Ze=ft([xt("esri.views.2d.actions.Rotate")],Ze);const He=Ze,We=new zt({targetGeometry:new Rt}),Ye=[0,0];let Qe=class extends wt{constructor(t){super(t),this._endTimer=null,this._lastEventTimestamp=null,this.animationManager=null,this.interacting=!1}initialize(){this.pan=new Ve({navigation:this}),this.rotate=new He({navigation:this}),this.pinch=new Ge({navigation:this}),this.zoomBox=new Ue({view:this.view,navigation:this})}destroy(){this.pan=p(this.pan),this.rotate=p(this.rotate),this.pinch=p(this.pinch),this.zoomBox=p(this.zoomBox),this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}async zoom(t,e=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return t<1?this.zoomIn(e):this.zoomOut(e);this.setViewpoint(e,t,0,[0,0])}async zoomIn(t){const e=this.view,i=e.constraints.snapToNextScale(e.scale);return this._zoomToScale(i,t)}async zoomOut(t){const e=this.view,i=e.constraints.snapToPreviousScale(e.scale);return this._zoomToScale(i,t)}setViewpoint(t,e,i,s){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,t,e,i,s),this.end()}setViewpointImmediate(t,e=0,i=[0,0],s=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,s,t,e,i)}continousRotateClockwise(){const t=this.get("view.viewpoint");this.animationManager?.animateContinous(t,(t=>{Et(t,t,-1)}))}continousRotateCounterclockwise(){const t=this.get("view.viewpoint");this.animationManager?.animateContinous(t,(t=>{Et(t,t,1)}))}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-10,0])}continousPanRight(){this._continuousPan([10,0])}continousPanUp(){this._continuousPan([0,10])}continousPanDown(){this._continuousPan([0,-10])}stop(){this.pan.stopMomentumNavigation(),this.animationManager?.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(t){const e=this.view.viewpoint;this.animationManager?.animateContinous(e,(e=>{It(e,e,t),this.view.constraints.constrainByGeometry(e)}))}_startTimer(t){return null!==this._endTimer||(this._endTimer=setTimeout((()=>{this._endTimer=null;const t=performance.now()-(this._lastEventTimestamp??0);t<250?this._endTimer=this._startTimer(t):this._set("interacting",!1)}),t)),this._endTimer}_getDefaultAnchor(){const{size:t,padding:{left:e,right:i,top:s,bottom:a}}=this.view;return Ye[0]=.5*(t[0]-i+e),Ye[1]=.5*(t[1]-a+s),Ye}async _zoomToScale(t,e=this._getDefaultAnchor()){const{view:i}=this,{constraints:s,scale:a,viewpoint:n,size:r,padding:o}=i,h=s.canZoomInTo(t),c=s.canZoomOutTo(t);if(!(t<a&&!h||t>a&&!c))return Ft(We,n,t/a,0,e,r,o),s.constrainByGeometry(We),i.goTo(We,{animate:!0})}_scaleRotateTranslateViewpoint(t,e,i,s,a){const{view:n}=this,{size:r,padding:o,constraints:h,scale:c,viewpoint:u}=n,l=c*i,m=h.canZoomInTo(l),d=h.canZoomOutTo(l);return(i<1&&!m||i>1&&!d)&&(i=1),It(u,u,a),Ft(t,u,i,s,e,r,o),h.constrainByGeometry(t)}};ft([bt()],Qe.prototype,"animationManager",void 0),ft([bt({type:Boolean,readOnly:!0})],Qe.prototype,"interacting",void 0),ft([bt()],Qe.prototype,"pan",void 0),ft([bt()],Qe.prototype,"pinch",void 0),ft([bt()],Qe.prototype,"rotate",void 0),ft([bt()],Qe.prototype,"view",void 0),ft([bt()],Qe.prototype,"zoomBox",void 0),Qe=ft([xt("esri.views.2d.navigation.MapViewNavigation")],Qe);const Xe=Qe,Je={shaders:{vertexShader:t("magnifier/magnifier.vert"),fragmentShader:t("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function Ke(t){return $t(t,Je)}export{ye as B,Fe as L,Xe as M,Me as P,pe as T,be as a,qt as b,Ke as c,ve as h,Je as m,ge as s};
