/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{v as e}from"./typedArrayUtil.js";import{L as l}from"./Logger.js";import{o as t}from"./ensureType.js";import{i as o}from"./maybe.js";import{f as a,c as n}from"./number.js";import{f as i,r}from"./numberUtils.js";import s from"../renderers/visualVariables/support/ColorStop.js";import{g as u}from"./utils6.js";import f from"../Color.js";import"../symbols.js";import c from"../symbols/SimpleLineSymbol.js";import p from"../renderers/support/HeatmapColorStop.js";const m="<",A=">",d=n("short-date");function g(e,l,t,o){let n="";0===l?n=`${m} `:l===t&&(n=`${A} `);let r=null;return r=o?a(e,d):i(e),n+r}const y=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwcdIkqhiWn5fHwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6JrzFUAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwaeIkqhiWl5/HwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6sKxboAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwadJEqhiWl5fPwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu75+IUcAAAAASUVORK5CYII="];async function h(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const l=e.visualVariables.find((e=>"color"===e.type));if(!l)return null;let t=null,o=null;if(l.stops){if(1===l.stops.length)return l.stops[0].color;t=l.stops[0].value,o=l.stops[l.stops.length-1].value}const a=null!=t&&null!=o?t+(o-t)/2:0,{getColor:n}=await import("./visualVariableUtils.js");return n(l,a)??null}async function b(e,l){const t=e.trailCap,o=e.trailWidth||1,a=l||await h(e)||e.color;return new c({cap:t,color:a,width:o})}const w=new f([64,64,64]);function v(e,l){const t=[],o=e.length-1;return 5===e.length?t.push(0,2,4):t.push(0,o),e.map(((e,a)=>t.includes(a)?g(e,a,o,l):null))}async function V(e,l,t){let o=!1,a=[],n=[];if(e.stops){const l=e.stops;a=l.map((e=>e.value)),o=l.some((e=>!!e.label)),o&&(n=l.map((e=>e.label)))}const i=a[0],r=a[a.length-1];if(null==i&&null==r)return null;const s=o?null:v(a,t??!1),u=await Promise.all(a.map((async(t,a)=>{const i="opacity"===e.type?await async function(e,l,t){const o=new f(t??w),a=(await import("./visualVariableUtils.js")).getOpacity(l,e);return null!=a&&(o.a=a),o}(t,e,l):(await import("./visualVariableUtils.js")).getColor(e,t);return{value:t,color:i,label:o?n[a]:s?.[a]??""}})));return u.reverse()}function E(e){let l=!1,t=[],o=[];t=e.map((e=>e.value)),l=e.some((e=>!!e.label)),l&&(o=e.map((e=>e.label??"")));const a=t[0],n=t[t.length-1];if(null==a&&null==n)return null;const i=l?null:v(t,!1);return t.map(((t,a)=>({value:t,color:I(t,e),label:l?o[a]:i?.[a]??""}))).reverse()}function I(e,l){const{startIndex:t,endIndex:o,weight:a}=function(e,l){let t=0,o=l.length-1;return l.some(((l,a)=>e<l.value?(o=a,!0):(t=a,!1))),{startIndex:t,endIndex:o,weight:(e-l[t].value)/(l[o].value-l[t].value)}}(e,l);if(t===o)return l[t].color;const n=f.blendColors(l[t].color,l[o].color,a);return new f(n)}function x(e,l){let t=[];if(e&&"multipart"===e.type)e.colorRamps.reverse().forEach(((o,a)=>{0===a?t.push({value:l.max,color:new f(o.toColor),label:"high"}):t.push({value:null,color:new f(o.toColor),label:""}),a===e.colorRamps.length-1?t.push({value:l.min,color:new f(o.fromColor),label:"low"}):t.push({value:null,color:new f(o.fromColor),label:""})}));else{let o,a;e&&"algorithmic"===e.type?(o=e.fromColor,a=e.toColor):(o=[0,0,0,1],a=[255,255,255,1]),t=[{value:l.max,color:new f(a),label:"high"},{value:l.min,color:new f(o),label:"low"}]}return t}function C(e){if(!e.colorStops)return[];const l=[...e.colorStops].filter((e=>e.color?.a>0));let t=l.length-1;if(l&&l[0]){const e=l[t];e&&1!==e.ratio&&(l.push(new p({ratio:1,color:e.color})),t++)}return l.map(((l,o)=>{let a="";return 0===o?a=e.legendOptions?.minLabel||"low":o===t&&(a=e.legendOptions?.maxLabel||"high"),{color:l.color,label:a,ratio:l.ratio}})).reverse()}const j=l.getLogger("esri.renderers.support.utils"),F={lte:"<=",gte:">=",lt:"<",gt:">",pct:"%",ld:"â€“"},S={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},B={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},U=n("short-date");async function z(e,l,o){t(e,l,(()=>[])).push(...o)}async function k(l){const t=new Map;if(!l)return t;if("visualVariables"in l&&l.visualVariables){const e=l.visualVariables.filter((e=>"color"===e.type));for(const l of e){const e=(await V(l)??[]).map((e=>e.color));await z(t,l.field||l.valueExpression,e)}}if("heatmap"===l.type){const e=C(l).map((e=>e.color));await z(t,l.field||l.valueExpression,e)}else if("pie-chart"===l.type){for(const e of l.attributes)await z(t,e.field||e.valueExpression,[e.color]);await z(t,"default",[l?.othersCategory?.color,u(l.backgroundFillSymbol,null)])}else if("dot-density"===l.type){for(const e of l.attributes)await z(t,e.field||e.valueExpression,[e.color]);await z(t,"default",[l.backgroundColor])}else if("unique-value"===l.type)if("predominance"===l.authoringInfo?.type)for(const e of l.uniqueValueInfos??[])await z(t,e.value.toString(),[u(e.symbol,null)]);else{const e=(l.uniqueValueInfos??[]).map((e=>u(e.symbol,null))),{field:o,field2:a,field3:n,valueExpression:i}=l;(o||i)&&await z(t,o||i,e),a&&await z(t,a,e),n&&await z(t,n,e)}else if("class-breaks"===l.type){const e=l.classBreakInfos.map((e=>u(e.symbol,null))),{field:o,valueExpression:a}=l;await z(t,o??a,e)}else"simple"===l.type&&await z(t,"default",[u(l.symbol,null)]);return"defaultSymbol"in l&&l.defaultSymbol&&await z(t,"default",[u(l.defaultSymbol,null)]),t.forEach(((l,o)=>{const a=e(l.filter(Boolean),((e,l)=>JSON.stringify(e)===JSON.stringify(l)));t.set(o,a)})),t}function q(e){const{values:l,colors:t,labelIndexes:o,isDate:n,dateFormatOptions:r}=e;return l.map(((e,u)=>{let f=null;if(!o||o.includes(u)){let t;t=n?a(e,r):i(e),t&&(f=function(e,l,t){let o="";return 0===l?o=F.lt+" ":l===t&&(o=F.gt+" "),o+e}(t,u,l.length-1))}return new s({value:e,color:t[u],label:f})}))}function M(e){let l=e.minValue,t=e.maxValue;const o=e.isFirstBreak?"":F.gt+" ",a="percent-of-total"===e.normalizationType?F.pct:"";return l=null==l?"":i(l),t=null==t?"":i(t),o+l+a+" "+F.ld+" "+t+a}function N(e){const l=e.classBreakInfos,t=e.normalizationType;let o=[];if(l&&l.length)if("standard-deviation"!==e.classificationMethod)if(e.round){o.push(l[0].minValue);for(const e of l)o.push(e.maxValue);o=r(o),l.forEach(((e,l)=>{e.label=M({minValue:0===l?o[0]:o[l],maxValue:o[l+1],isFirstBreak:0===l,normalizationType:t})}))}else l.forEach(((e,l)=>{e.label=M({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===l,normalizationType:t})}));else j.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")}function O(e){const l=e.map((e=>new Date(e))),t=l.length;let o=1/0,a=null;for(let e=0;e<t-1;e++){const n=l[e];let i=1/0,r=null;for(let o=e+1;o<t;o++){const e=l[o],t=(n.getFullYear()!==e.getFullYear()?"year":n.getMonth()!==e.getMonth()&&"month")||n.getDate()!==e.getDate()&&"day"||n.getHours()!==e.getHours()&&"hour"||n.getMinutes()!==e.getMinutes()&&"minute"||n.getSeconds()!==e.getSeconds()&&"second"||"millisecond",a=S[t];a<i&&(i=a,r=t)}i<o&&(o=i,a=r)}return a}function Q(e){const{value:l,domain:t,fieldInfo:o,dateFormatInterval:r}=e;let s=String(l);const u=t&&"codedValues"in t&&t.codedValues?t.getName(l):null;return u?s=u:"number"==typeof l&&(s=o&&"date"===o.type?a(l,r&&n(B[r])):i(l)),s}function R(e,l){return"normalizationField"in e&&e.normalizationField?{type:"normalized-field",field:e.field,normalizationField:e.normalizationField}:"field"in e&&e.field?H(e.field):"valueExpression"in e&&e.valueExpression?{type:"expression",expression:e.valueExpression,title:e.valueExpressionTitle,returnType:l}:null}function H(e){return{type:"field",field:e}}function K(l,t){const a=[];if("class-breaks"===l.type||"heatmap"===l.type)a.push(R(l,"number"));else if("unique-value"===l.type){const e=l.authoringInfo;if(e&&"relationship"===e.type){if(e.field1&&e.field2){const l=e.field1.field,t=e.field2.field,o=e.field1.normalizationField,n=e.field2.normalizationField;a.push(R({field:l,normalizationField:o})),a.push(R({field:t,normalizationField:n}))}}else{const e=l.uniqueValueInfos?.[0];let t=null;if(e&&e.value){const e=typeof l.uniqueValueInfos[0].value;"string"!==e&&"number"!==e||(t=e)}a.push(R(l,t)),[l.field2,l.field3].forEach((e=>e&&a.push(H(e))))}}else"attributes"in l&&l.attributes?.forEach((e=>a.push(R(e,"number"))));const n=t?t(l):"visualVariables"in l?l.visualVariables:null;return n&&n.forEach((e=>a.push(R(e,"number")))),e(a.filter(o),((e,l)=>"field"===e.type&&"field"===l.type?e.field===l.field:"normalized-field"===e.type&&"normalized-field"===l.type?e.field===l.field&&e.normalizationField===l.normalizationField:"expression"===e.type&&"expression"===l.type&&e.expression===l.expression))}export{y as R,m as S,Q as a,O as b,q as c,k as d,b as e,g as f,K as g,A as h,I as i,E as j,C as k,x as l,h as m,V as n,N as s,U as t};
