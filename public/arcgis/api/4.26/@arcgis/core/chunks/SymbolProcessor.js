/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import{b as t}from"./shapingUtils.js";import"../core/Error.js";import"./typedArrayUtil.js";import"./Logger.js";import{g as r,a as s,i,c as o,u as a}from"./maybe.js";import{isAbortError as n,throwIfAborted as l}from"../core/promiseUtils.js";import"./ensureType.js";import{subclass as m}from"../core/accessorSupport/decorators/subclass.js";import{d as c,h as p}from"./diffUtils.js";import u from"../geometry/SpatialReference.js";import{j as d}from"./visualVariablesUtils.js";import{b as h}from"./enums4.js";import{a as f,c as j,b as g,M as y,d as _}from"./Matcher.js";import{B as b}from"./BaseProcessor.js";import"./BidiEngine.js";import"./screenUtils.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./common.js";import"./vec2f32.js";import"./alignmentUtils.js";import"./number2.js";import"./Rect.js";import"../core/lang.js";import"./object.js";import"../config.js";import"./string.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../core/Accessor.js";import"../core/Handles.js";import"./get.js";import"./ArrayPool.js";import"../core/accessorSupport/decorators/property.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../core/JSONSupport.js";import"./unitUtils.js";import"./jsonMap.js";import"./Ellipsoid.js";import"./writer.js";import"./color.js";import"./enums.js";import"./enums3.js";import"./VertexElementDescriptor.js";import"./definitions.js";import"./visualVariablesUtils2.js";import"./TileStrategy.js";import"./QueueProcessor.js";import"./Queue.js";import"./aaBoundingRect.js";import"./mathUtils.js";import"./vec3.js";import"./vec4.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./TileInfoView.js";import"./TileKey2.js";import"./tileUtils.js";import"./libtess.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./MaterialKey.js";import"./cimAnalyzer.js";import"../Color.js";import"./colorUtils.js";import"./fontUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"./GeometryUtils.js";import"./utils7.js";import"./callExpressionWithFeature.js";import"./quantizationUtils.js";import"./floatRGBA.js";import"./featureConversionUtils.js";import"./aaBoundingBox.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./defaultsJSON.js";import"./GeometryUtils2.js";import"./earcut.js";import"./TurboLine.js";import"./LRUCache.js";import"./MemCache.js";import"./ExpandedCIM.js";import"./devEnvironmentUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./persistableUrlUtils.js";import"./styleUtils.js";import"../core/HandleOwner.js";import"./WatchUpdatingTracking.js";import"../core/reactiveUtils.js";class U{constructor(e){this._remoteClient=e,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}async fetchResource(e,t){const r=this._resourceMap,s=r.get(e);if(s)return s;let i=this._inFlightResourceMap.get(e);if(i)return i;try{i=this._remoteClient.invoke("tileRenderer.fetchResource",{url:e},{...t}),this._inFlightResourceMap.set(e,i),i.then((t=>(this._inFlightResourceMap.delete(e),r.set(e,t),t)))}catch(e){return n(e)?null:{width:0,height:0}}return i}getResource(e){return this._resourceMap.get(e)??null}}function v(e,t){return(!e.minScale||e.minScale>=t)&&(!e.maxScale||e.maxScale<=t)}function M(e){const t=e.message,s={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin,version:t.version},transferList:new Array};for(const e in t.data){const o=t.data[e];if(s.message.data[e]=null,i(o)){const t=o.stride,i=o.indices.slice(0),a=o.vertices.slice(0),n=o.records.slice(0),l={stride:t,indices:i,vertices:a,records:n,metrics:r(o.metrics,(e=>e.slice(0)))};s.transferList.push(i,a,n),s.message.data[e]=l}}return s}let S=class extends b{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new U(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(e){this._bufferIds.forEach((t=>{t.forEach(e)}))}async update(e,t){const r=t.schema.processors[0];if("symbol"!==r.type)return;const s=c(this._schema,r);(p(s,"mesh")||p(s,"target"))&&(e.mesh=!0,e.why?.mesh.push("Symbology changed"),this._schema=r,this._factory=this._createFactory(r),this._factory.update(r,this.tileStore.tileScheme.tileInfo))}onTileMessage(e,t,r,s){return l(s),this._onTileData(e,t,r,s)}onTileClear(e){return this._bufferData.delete(e.key.id),this._bufferIds.delete(e.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{clear:!0}})}onTileError(e,t,r){const s=r.signal,i={tileKey:e.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",i,{signal:s})}onTileUpdate(e){for(const t of e.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of e.added)this._bufferData.forEach((e=>{for(const r of e)r.message.tileKey===t.id&&this._updateTileMesh("append",t,M(r),[],!1,!1,null)}))}_addBufferData(e,t){this._bufferData.has(e)||this._bufferData.set(e,[]),this._bufferData.get(e)?.push(M(t))}_createFactory(e){const{geometryType:t,objectIdField:s,fields:i}=this.service,o={geometryType:t,fields:i,spatialReference:u.fromJSON(this.spatialReference)},a=new f(((e,t)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",e,t)),this.tileStore.tileScheme.tileInfo),{matcher:n,aggregateMatcher:l}=e.mesh;return this._store=a,this._matchers.feature=j(n,a,o,this._resourceManagerProxy),this._matchers.aggregate=r(l,(e=>j(e,a,o,this._resourceManagerProxy))),new g(t,s,a)}async _onTileData(e,t,r,o){l(o);const{type:a,addOrUpdate:n,remove:m,clear:c,end:p}=t,u=!!this._schema.mesh.sortKey;if(!n){const t={type:a,addOrUpdate:null,remove:m,clear:c,end:p,sort:u};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:t},o)}const d=this._processFeatures(e,n,r,o,t.status?.version);try{const r=await d;if(s(r)){const t={type:a,addOrUpdate:null,remove:m,clear:c,end:p,sort:u};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:t},o)}const n=[];for(const t of r){let r=!1;const s=t.message.bufferIds,o=e.key.id,a=t.message.tileKey;if(o!==a&&i(s)){if(!this.tileStore.get(a)){this._addBufferData(o,t),n.push(t);continue}let e=this._bufferIds.get(a);e||(e=new Set,this._bufferIds.set(a,e));const i=Array.from(s);for(const t of i){if(e.has(t)){r=!0;break}e.add(t)}}r||(this._addBufferData(o,t),n.push(t))}await Promise.all(n.map((r=>{const s=e.key.id===r.message.tileKey,i=s?t.remove:[],n=s&&t.end;return this._updateTileMesh(a,e,r,i,n,!!t.clear,o.signal)})))}catch(t){this._handleError(e,t,o)}}async _updateTileMesh(e,t,s,i,o,n,m){const c=e,p=s.message.tileKey,u=!!this._schema.mesh.sortKey;p!==t.key.id&&(o=!1);const d=r(s,(e=>e.message)),h=r(s,(e=>e.transferList))||[],f={type:c,addOrUpdate:d,remove:i,clear:n,end:o,sort:u},j={transferList:a(h)||[],signal:m};return l(j),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:p,data:f},j)}async _processFeatures(e,t,r,i,o){if(s(t)||!t.hasFeatures)return null;const a={transform:e.transform,hasZ:!1,hasM:!1},n=this._factory,m={viewingMode:"",scale:e.scale},c=await this._matchers.feature,p=await this._matchers.aggregate;l(i);const u=this._getLabelInfos(e,t);return await n.analyze(t.getCursor(),this._resourceManagerProxy,c,p,a,m),l(i),this._writeFeatureSet(e,t,a,u,n,r,o)}_writeFeatureSet(e,t,r,s,o,a,n){const l=t.getSize(),m=this._schema.mesh.matcher.symbologyType,c=new y(e.key.id,{features:l,records:l,metrics:0},m,a,m!==h.HEATMAP,n),p={viewingMode:"",scale:e.scale},u=t.getCursor();for(;u.next();)try{const t=u.getDisplayId(),a=i(s)?s.get(t):null;o.writeCursor(c,u,r,p,e.level,a,this._resourceManagerProxy)}catch(e){}const d=e.tileInfoView.tileInfo.isWrappable;return c.serialize(d)}_handleError(e,t,r){if(!n(t)){const s={tileKey:e.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",s,{signal:r.signal})}return Promise.resolve()}_getLabelingSchemaForScale(e){const t=this._schema.mesh.labels;if(s(t))return null;if("subtype"===t.type){const r={type:"subtype",classes:{}};let s=!1;for(const i in t.classes){const o=t.classes[i].filter((t=>v(t,e.scale)));s=s||!!o.length,r.classes[i]=o}return s?r:null}const r=t.classes.filter((t=>v(t,e.scale)));return r.length?{type:"simple",classes:r}:null}_getLabels(e,t){if("subtype"===t.type){const r=this.service.subtypeField,s=o(r,"Expected to find subtype Field"),i=e.readAttribute(s);return null==i?[]:t.classes[i]??[]}return t.classes}_getLabelInfos(e,r){const i=this._getLabelingSchemaForScale(e);if(s(i))return null;const o=new Map,a=r.getCursor();for(;a.next();){const e=a.getDisplayId(),r=[],s=d(e),n=s&&1!==a.readAttribute("cluster_count")?"aggregate":"feature",l=this._getLabels(a,i);for(const i of l){if(i.target!==n)continue;const o=a.getStorage(),l=s&&"feature"===n?o.getComputedStringAtIndex(a.readAttribute("referenceId"),i.fieldIndex):o.getComputedStringAtIndex(e,i.fieldIndex);if(!l)continue;const m=t(l.toString()),c=m[0],p=m[1];this._store.getMosaicItem(i.symbol,_(c)).then((e=>{r[i.index]={glyphs:e.glyphMosaicItems??[],rtl:p,index:i.index}}))}o.set(e,r)}return o}};S=e([m("esri.views.2d.layers.features.processors.SymbolProcessor")],S);const w=S;export{w as default};
