/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{a as n,i as t}from"./maybe.js";import{g as r,j as e,w as o}from"./unitUtils.js";import{c as a}from"./mat3f64.js";import{c as i,g as s}from"./mat4.js";import{c as l}from"./mat4f64.js";import{n as c}from"./mat3.js";import{computeTranslationToOriginAndRotation as u}from"../geometry/projection.js";import{g as f}from"./spatialReferenceEllipsoidUtils.js";import{M as p}from"./MeshTransform.js";import{t as g,a as m}from"./vec32.js";import{c as h,d as y,e as w,p as A,a as j,b as F,t as R,f as z}from"./projection.js";function v(n,t){return n.isGeographic||n.isWebMercator&&(t?.geographic??!0)}function x(t,r,e){return v(r.spatialReference,e)?function(t,r,e){const o=r.spatialReference,a=P(r,e,U),i=new Float64Array(t.position.length),s=function(n,t,r,e){g(e,n,t);const o=new Float64Array(n.length);return h(e,o,r)}(t.position,a,o,i),l=c(E,a),u=function(t,r,e,o,a){if(n(e))return null;const i=new Float32Array(e.length);return m(i,e,o),y(i,t,r,a,i),i}(s,i,t.normal,l,o),f=function(t,r,e,o,a){if(n(e))return null;const i=new Float32Array(e.length);m(i,e,o,4);for(let n=3;n<i.length;n+=4)i[n]=e[n];return w(i,t,r,a,i),i}(s,i,t.tangent,l,o);return{position:s,normal:u,tangent:f}}(t,r,e):function(n,t,r){const e=new Float64Array(n.position.length),o=n.position,a=t.x,i=t.y,s=t.z||0,{horizontal:l,vertical:c}=T(r?r.unit:null,t.spatialReference);for(let n=0;n<o.length;n+=3)e[n]=o[n]*l+a,e[n+1]=o[n+1]*l+i,e[n+2]=o[n+2]*c+s;return{position:e,normal:n.normal,tangent:n.tangent}}(t,r,e)}function b(r,e,o){const{position:a,normal:i,tangent:s}=r;if(n(e))return{position:a,normal:i,tangent:s};const l=e.localMatrix;return x({position:g(new Float64Array(a.length),a,l),normal:t(i)?R(i,new Float32Array(i.length),l):null,tangent:t(s)?z(s,new Float32Array(s.length),l):null},e.getOriginPoint(o),{geographic:e.geographic})}function M(n,t,r){if(r?.useTransform){const{position:e,normal:o,tangent:a}=n;return{vertexAttributes:{position:e,normal:o,tangent:a},transform:new p({origin:[t.x,t.y,t.z??0],geographic:v(t.spatialReference,r)})}}return{vertexAttributes:x(n,t,r),transform:null}}function G(t,r,e){return v(r.spatialReference,e)?function(t,r,e){const o=r.spatialReference;P(r,e,U);const a=i(q,U),s=new Float64Array(t.position.length),l=function(n,t,r,e){const o=A(n,t,e),a=new Float64Array(o.length);return g(a,o,r),a}(t.position,o,a,s),u=c(E,a),f=function(t,r,e,o,a){if(n(t))return null;const i=j(t,r,e,o,new Float32Array(t.length));return m(i,i,a),i}(t.normal,t.position,s,o,u),p=function(t,r,e,o,a){if(n(t))return null;const i=F(t,r,e,o,new Float32Array(t.length));return m(i,i,a,4),i}(t.tangent,t.position,s,o,u);return{position:l,normal:f,tangent:p}}(t,r,e):O(t,r,e)}function d(t,r,e,o){if(n(r))return G(t,e,o);const a=b(t,r,e.spatialReference);return e.equals(r.getOriginPoint(e.spatialReference))?O(a,e,o):G(a,e,o)}function O(n,t,r){const e=new Float64Array(n.position.length),o=n.position,a=t.x,i=t.y,s=t.z||0,{horizontal:l,vertical:c}=T(r?r.unit:null,t.spatialReference);for(let n=0;n<o.length;n+=3)e[n]=(o[n]-a)/l,e[n+1]=(o[n+1]-i)/l,e[n+2]=(o[n+2]-s)/c;return{position:e,normal:n.normal,tangent:n.tangent}}function P(n,t,r){u(n.spatialReference,[n.x,n.y,n.z||0],r,f(n.spatialReference));const{horizontal:e,vertical:o}=T(t?t.unit:null,n.spatialReference);return s(r,r,[e,e,o]),r}function T(t,a){if(n(t))return W;const i=a.isGeographic?1:r(a),s=a.isGeographic?1:e(a),l=o(1,t,"meters");return{horizontal:l*i,vertical:l*s}}const U=l(),q=l(),E=a(),W={horizontal:1,vertical:1};export{M as a,b,d as c,x as g,v as i,G as u};
