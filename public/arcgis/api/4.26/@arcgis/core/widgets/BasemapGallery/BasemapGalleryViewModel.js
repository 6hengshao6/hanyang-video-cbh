/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Basemap.js";import s from"../../core/Collection.js";import{HandleOwnerMixin as r}from"../../core/HandleOwner.js";import i from"../../core/Loadable.js";import{i as o,a}from"../../chunks/maybe.js";import{watch as n,on as p}from"../../core/reactiveUtils.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import{cast as c}from"../../core/accessorSupport/decorators/cast.js";import"../../chunks/typedArrayUtil.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import{canProjectWithoutEngine as u,isLoaded as h,load as f}from"../../geometry/projection.js";import{f as j}from"../../chunks/unitUtils.js";import{b as d}from"../../chunks/basemapUtils.js";import y from"../../core/Error.js";import{throwIfAborted as g}from"../../core/promiseUtils.js";import{f as b,n as k}from"../../chunks/layerUtils.js";import{s as w,V as v}from"../../chunks/ViewingMode.js";import{M as R,L as B}from"../../chunks/terrainUtils.js";import{T as P}from"../../chunks/TerrainConst.js";import{i as U}from"../../chunks/spatialReferenceSupport.js";import I from"./support/BasemapGalleryItem.js";import L from"./support/LocalBasemapsSource.js";import S from"./support/PortalBasemapsSource.js";import"../../chunks/collectionUtils.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../core/lang.js";import"../../chunks/metadata.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/ArrayPool.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/ensureType.js";import"../../chunks/loadAll.js";import"../../chunks/asyncUtils.js";import"../../core/urlUtils.js";import"../../chunks/writer.js";import"../../geometry/SpatialReference.js";import"../../chunks/jsonMap.js";import"../../chunks/Ellipsoid.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../request.js";import"../../chunks/reader.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/locale.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../core/Promise.js";import"../../portal/PortalItem.js";import"../../chunks/assets.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/messages.js";import"../../chunks/writeUtils.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/WatchUpdatingTracking.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../chunks/mat4.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../chunks/pe.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../geometry/Polyline.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/Util2.js";import"../../chunks/vec2f64.js";import"../../chunks/vec4f64.js";import"../../chunks/Scheduler.js";import"../../chunks/ObservableValue.js";import"../../chunks/debugFlags.js";import"../../chunks/interfaces4.js";import"../../geometry.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../layers/support/LOD.js";import"../../layers/support/TileInfo.js";import"../../chunks/TileKey.js";import"../../core/Identifiable.js";async function _(e,t={}){await async function(e,t){const{basemap:s,view:r}=e;if(await s.load(t),0===s.baseLayers.length)return;const i=s.baseLayers.concat(s.referenceLayers).toArray().filter((e=>!k(e))).map((e=>new y("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:e,operationalLayerType:e.operationalLayerType||"unknown"})));if(i.length)throw i[0];const n=s.baseLayers.getItemAt(0);if(k(n)){try{await n.load(t)}catch(e){const t="basemap-compatibility:unknown-error",s="Unknown basemap compatibility error",{name:r=t,message:i=s,details:o}=e;throw new y(r,i,o)}!function(e,t){const s=t.state.viewingMode;if(!s)return;let r,i;if("wmts"===e?.type){const o=R(e,t.spatialReference,s);if(a(o.tileInfo))throw new y("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view");r=o.tileInfo,i=o.fullExtent}else r=e.tileInfo,i=e.fullExtent;if(a(r))return;if(!U(r.spatialReference,s))throw new y(`basemapgalleryitem:spatial-reference-unsupported-${w(s)}`,`Basemap spatial reference is unsupported in ${w(s)} mode`);const n=r.spatialReference.isGeographic,p="vector-tile"===e?.type?r.getOrCreateCompatible(256,n?1:2):null;if(s===v.Global){let t=B(r,i,null,s);if(t&&"vector-tile"===e?.type&&o(i)&&p&&!B(p,i,null,s)&&(t=null),t){const e=r.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new y(`basemapgalleryitem:tiling-scheme-unsupported-${e}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(P.checkUnsupported(r))throw new y("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const m=t.get("basemapTerrain.tilingScheme");if(m&&!m.compatibleWith(r)&&("vector-tile"!==e?.type||!p||!m.compatibleWith(p)))throw new y("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}(n,r)}}(e,t),g(t)}async function E(e,t={}){const{basemap:s,view:r}=e;if(g(t),!r||"spatialReferenceLocked"in r&&!r.spatialReferenceLocked)return;if(await s.load(t),g(t),0===s.baseLayers.length)return;const i=s.baseLayers.getItemAt(0);if(!b(i))return;if(s.spatialReference){if(r.spatialReference.equals(s.spatialReference))return;T()}await i.load(t),g(t);const a=(("supportedSpatialReferences"in i?i.supportedSpatialReferences:null)||["tileInfo"in i?i.tileInfo?.spatialReference:null]).filter(o);0!==a.length&&a.every((e=>!r.spatialReference.equals(e)))&&T()}function T(){throw new y("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}const O=s.ofType(I);let x=class extends(r(i)){constructor(e){super(e),this._loadingProjectionEngine=!1,this.items=new O,this.source=new S,this.view=null}initialize(){const e=()=>this._recreateItems();this.handles.add([n((()=>"ready"===this.state?this.compatibilityFunction:null),(()=>this._updateItems())),p((()=>this.source?.basemaps),"change",e,{onListenerAdd:e})])}get activeBasemap(){return this.view?.map?.basemap??null}set activeBasemap(e){const s=this.view;if(!s?.map)return;const r="string"==typeof e?t.fromId(e):e;if(!r||!s.ready)return s.map.basemap=r,void this._clearOverride("activeBasemap");const i=r.spatialReference||this.items?.find((e=>this.basemapEquals(r,e.basemap)))?.spatialReference;if(i&&"spatialReferenceLocked"in s&&!s.spatialReferenceLocked){const t=s.spatialReference;if(o(i)&&!j(t,i)&&!u(s.spatialReference,i)&&!h())return this._override("activeBasemap",r),this._loadingProjectionEngine=!0,void f().then((()=>{this._get("activeBasemap")===e&&(s.map.basemap=e,s.spatialReference=i,this._clearOverride("activeBasemap"))}),(()=>{})).then((()=>{this._loadingProjectionEngine=!1}));s.map.basemap=r,this._clearOverride("activeBasemap"),o(i)&&!j(s.spatialReference,i)&&(s.spatialReference=i)}else s.map.basemap=r,this._clearOverride("activeBasemap")}get activeBasemapIndex(){const{state:e,items:t,activeBasemap:s}=this;if("ready"!==e)return-1;const r=t.findIndex((e=>e.basemap===s));return-1===r?t.findIndex((e=>this.basemapEquals(e.basemap,s))):r}get compatibilityFunction(){return"3d"===this.view?.type?_:E}set compatibilityFunction(e){this._overrideIfSome("compatibilityFunction",e)}castSource(e){return Array.isArray(e)||s.isCollection(e)?new L({basemaps:e}):function(e){return e&&"esri.portal.Portal"===e.declaredClass}(e)?new S({portal:e}):function(e){return e&&!(e instanceof S)&&(!!e.portal||!!e.query)}(e)?new S(e):function(e){return e&&"basemaps"in e&&"state"in e&&"refresh"in e}(e)?e:null}get state(){return this.view?.ready&&this.source?this._loadingProjectionEngine?"loading":"ready":"disabled"}basemapEquals(e,t){return d(e,t)}refresh(){this._recreateItems()}load(e){return this.addResolvingPromise(i.isLoadable(this.source)?this.source.load(e):null),Promise.resolve(this)}_recreateItems(){const e=this.source?.basemaps,{view:t,compatibilityFunction:s}=this;this.items.removeAll().forEach((e=>e.destroy())),e&&this.items.addMany(e.map((e=>new I({basemap:e,compatibilityFunction:s,view:t}))))}_updateItems(){for(const e of this.items)e.compatibilityFunction=this.compatibilityFunction,e.view=this.view}};e([m()],x.prototype,"_loadingProjectionEngine",void 0),e([m()],x.prototype,"activeBasemap",null),e([m({readOnly:!0})],x.prototype,"activeBasemapIndex",null),e([m()],x.prototype,"compatibilityFunction",null),e([m({readOnly:!0,type:O})],x.prototype,"items",void 0),e([m()],x.prototype,"source",void 0),e([c("source")],x.prototype,"castSource",null),e([m({readOnly:!0})],x.prototype,"state",null),e([m()],x.prototype,"view",void 0),x=e([l("esri.widgets.BasemapGallery.BasemapGalleryViewModel")],x);const A=x;export{A as default};
