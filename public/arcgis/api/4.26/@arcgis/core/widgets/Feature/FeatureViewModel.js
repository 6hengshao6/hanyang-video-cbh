/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import r from"../../core/Accessor.js";import s from"../../core/Handles.js";import{IdentifiableMixin as o}from"../../core/Identifiable.js";import{L as i}from"../../chunks/Logger.js";import{i as n,o as a}from"../../chunks/maybe.js";import{whenOrAbort as l,eachAlways as p,ignoreAbortErrors as u,isAbortError as c}from"../../core/promiseUtils.js";import{watch as d,initial as m,on as h}from"../../core/reactiveUtils.js";import{t as y}from"../../chunks/throttle.js";import{property as f}from"../../core/accessorSupport/decorators/property.js";import{cast as b}from"../../core/accessorSupport/decorators/cast.js";import"../../chunks/typedArrayUtil.js";import{subclass as j}from"../../core/accessorSupport/decorators/subclass.js";import g from"../../popup/content/TextContent.js";import"../../chunks/ensureType.js";import _,{g as I,a as C,i as F,b as v,f as w,c as A,d as M,e as x,h as k,j as R,k as T,l as E,m as P,n as S,o as L,p as V,q,r as U,t as O,u as D,v as Q,w as N}from"../Attachments/AttachmentsViewModel.js";import{HandleOwnerMixin as $}from"../../core/HandleOwner.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import B from"../../popup/content/FieldsContent.js";import z from"../../popup/content/MediaContent.js";import"../../popup/content/RelationshipContent.js";import G from"../../popup/ElementExpressionInfo.js";import H from"../../popup/ExpressionInfo.js";import J from"../../popup/FieldInfo.js";import W from"../../popup/content/support/ChartMediaInfoValueSeries.js";import Z from"../../request.js";import K from"../../core/Error.js";import{isNumericField as X}from"../../layers/support/fieldUtils.js";import"../../chunks/DataLayerSource.js";import{e as Y}from"../../chunks/executeQueryJSON.js";import"../../config.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/unitUtils.js";import"../../chunks/featureConversionUtils.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../geometry/Multipoint.js";import"../../geometry/Point.js";import"../../geometry/Polygon.js";import"../../geometry/Polyline.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/pbf.js";import"../../rest/support/FeatureSet.js";import ee from"../../rest/support/Query.js";import"../../rest/query/support/AttachmentInfo.js";import"../../rest/support/AttachmentQuery.js";import"../../geometry.js";import te from"../../rest/support/RelationshipQuery.js";import"../../rest/support/TopFeaturesQuery.js";import re from"../../rest/support/StatisticDefinition.js";import se from"../../layers/FeatureLayer.js";import{ClonableMixin as oe}from"../../core/Clonable.js";import ie from"../../core/Collection.js";import"../../PopupTemplate.js";import"../../core/JSONSupport.js";import"../../core/lang.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/object.js";import"../../chunks/string.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../popup/content.js";import"../../chunks/jsonMap.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../chunks/locale.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../core/Evented.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry/SpatialReference.js";import"../../chunks/Ellipsoid.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/zmUtils.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils2.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils3.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/Symbol3DAnchorPosition2D.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../intl.js";import"../../chunks/messages.js";import"../../chunks/assets.js";import"../../chunks/layerUtils.js";import"../../chunks/WatchUpdatingTracking.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/utils4.js";import"../../chunks/query.js";import"../../chunks/urlUtils2.js";import"../../chunks/pbfQueryUtils.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils5.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/FullTextSearch.js";import"../../rest/support/TopFilter.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../chunks/lengthUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/DictionaryLoader.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/vec4f64.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/sql.js";import"../../form/FormTemplate.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../layers/Layer.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../chunks/arcgisLayerUrl.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/mat4f32.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../support/timeUtils.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/TimeReference.js";import"../../chunks/datetime.js";import"../../chunks/featureLayerUtils.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/mixins/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../geometry/projection.js";import"../../chunks/pe.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../support/popupUtils.js";let ne=class extends _{constructor(e){super(e),this.description=null,this.title=null}};e([f()],ne.prototype,"description",void 0),e([f()],ne.prototype,"title",void 0),ne=e([j("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],ne);const ae=ne;let le=class extends($(r)){constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(d((()=>this.creator),(e=>{this._destroyContent(),this._createContent(e)}),m))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:t,destroyer:r}=this;e&&t&&(I(r,{graphic:t}).catch((()=>null)),this._set("created",null))}async _createContent(e){const t=this.graphic;if(!t||!e)return;const r=I(e,{graphic:t}).catch((()=>null));this._loadingPromise=r,this.notifyChange("state");const s=await r;r===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",s))}};e([f({readOnly:!0})],le.prototype,"created",void 0),e([f()],le.prototype,"creator",void 0),e([f()],le.prototype,"destroyer",void 0),e([f({type:t})],le.prototype,"graphic",void 0),e([f({readOnly:!0})],le.prototype,"state",null),le=e([j("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],le);const pe=le;let ue=class extends r{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:t}=this,r=[];return t?.forEach((t=>{if(t.hasOwnProperty("visible")&&!t.visible)return;const s=t.clone();s.label=C(s,e),r.push(s)})),r}};e([f()],ue.prototype,"attributes",void 0),e([f({type:[H]})],ue.prototype,"expressionInfos",void 0),e([f()],ue.prototype,"description",void 0),e([f({type:[J]})],ue.prototype,"fieldInfos",void 0),e([f({readOnly:!0})],ue.prototype,"formattedFieldInfos",null),e([f()],ue.prototype,"title",void 0),ue=e([j("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],ue);const ce=ue,de=i.getLogger("esri.widgets.Feature.support.relatedFeatureUtils"),me=new Map;function he(e){if(!F(e))return null;const[t,r]=e.split("/").slice(1);return{layerId:t,fieldName:r}}const ye={chartAnimation:!0};let fe=class extends r{constructor(e){super(e),this.abilities={...ye},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return{...ye,...e}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:t}=this,r=(e+t)%t;this.activeMediaInfoIndex=r}_pageContentElementMedia(e){const{activeMediaInfoIndex:t}=this,r=t+e;this._setContentElementMedia(r)}_formatMediaInfos(){const{mediaInfos:e,layer:t}=this,r=this.attributes??{},s=this.formattedAttributes??{},o=this.expressionAttributes??{},i=this.fieldInfoMap??new Map;return e?.map((e=>{const n=e?.clone();if(!n)return null;if(n.title=v({attributes:r,fieldInfoMap:i,globalAttributes:s,expressionAttributes:o,layer:t,text:n.title}),n.caption=v({attributes:r,fieldInfoMap:i,globalAttributes:s,expressionAttributes:o,layer:t,text:n.caption}),n.altText=v({attributes:r,fieldInfoMap:i,globalAttributes:s,expressionAttributes:o,layer:t,text:n.altText}),"image"===n.type){const{value:e}=n;return this._setImageValue({value:e,formattedAttributes:s,layer:t}),n.value.sourceURL?n:void 0}if("pie-chart"===n.type||"line-chart"===n.type||"column-chart"===n.type||"bar-chart"===n.type){const{value:e}=n;return this._setChartValue({value:e,chartType:n.type,attributes:r,formattedAttributes:s,layer:t,expressionAttributes:o}),n}return null})).filter(n)??[]}_setImageValue(e){const t=this.fieldInfoMap??new Map,{value:r,formattedAttributes:s,layer:o}=e,{linkURL:i,sourceURL:n}=r;if(n){const e=w(n,o);r.sourceURL=A({formattedAttributes:s,template:e,fieldInfoMap:t})}if(i){const e=w(i,o);r.linkURL=A({formattedAttributes:s,template:e,fieldInfoMap:t})}}_setChartValue(e){const{value:t,attributes:r,formattedAttributes:s,chartType:o,layer:i,expressionAttributes:n}=e,{popupTemplate:a,relatedInfos:l}=this,{fields:p,normalizeField:u}=t,c=i;if(t.fields=M(p,c),u&&(t.normalizeField=x(u,c)),!p.some((e=>!!(null!=s[e]||F(e)&&l?.size))))return;const d=a?.fieldInfos??[];p.forEach((e=>{if(F(e))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:d,fieldName:e,formattedAttributes:s,chartType:o,value:t})]);const i=this._getChartOption({value:t,attributes:r,chartType:o,formattedAttributes:s,expressionAttributes:n,fieldName:e,fieldInfos:d});t.series.push(i)}))}_getRelatedChartInfos(e){const{fieldInfos:t,fieldName:r,formattedAttributes:s,chartType:o,value:i}=e,n=[],a=he(r),l=a&&this.relatedInfos?.get(a.layerId.toString());if(!l)return n;const{relatedFeatures:p,relation:u}=l;if(!u||!p)return n;const{cardinality:c}=u;return p.forEach((e=>{const{attributes:l}=e;l&&Object.keys(l).forEach((e=>{e===a.fieldName&&n.push(this._getChartOption({value:i,attributes:l,formattedAttributes:s,fieldName:r,chartType:o,relatedFieldName:e,hasMultipleRelatedFeatures:p?.length>1,fieldInfos:t}))}))})),"one-to-many"===c||"many-to-many"===c?n:[n[0]]}_getTooltip({label:e,value:t,chartType:r}){return"pie-chart"===r?`${e}`:`${e}: ${t}`}_getChartOption(e){const{value:t,attributes:r,formattedAttributes:s,expressionAttributes:o,fieldName:i,relatedFieldName:n,fieldInfos:a,chartType:l,hasMultipleRelatedFeatures:p}=e,u=this.layer,c=this.fieldInfoMap??new Map,{normalizeField:d,tooltipField:m}=t,h=d?F(d)?r[he(d).fieldName]:r[d]:null,y=k(i)&&o&&void 0!==o[i]?o[i]:n&&void 0!==r[n]?r[n]:void 0!==r[i]?r[i]:s[i],f=new W({fieldName:i,value:void 0===y?null:y&&h?y/h:y});if(F(i)){const e=c.get(i.toLowerCase()),t=m&&c.get(m.toLowerCase()),o=e?.fieldName??i,a=p&&m?he(m).fieldName:t?.fieldName??m,u=p&&a?r[a]:s[a]??e?.label??e?.fieldName??n,d=p&&n?r[n]:s[o];return f.tooltip=this._getTooltip({label:u,value:d,chartType:l}),f}const b=R(a,i),j=x(i,u),g=m&&void 0!==s[m]?s[m]:C(b||new J({fieldName:j}),this.popupTemplate?.expressionInfos),_=s[j];return f.tooltip=this._getTooltip({label:g,value:_,chartType:l}),f}};e([f()],fe.prototype,"abilities",void 0),e([b("abilities")],fe.prototype,"castAbilities",null),e([f()],fe.prototype,"activeMediaInfoIndex",void 0),e([f({readOnly:!0})],fe.prototype,"activeMediaInfo",null),e([f()],fe.prototype,"attributes",void 0),e([f()],fe.prototype,"description",void 0),e([f()],fe.prototype,"fieldInfoMap",void 0),e([f()],fe.prototype,"formattedAttributes",void 0),e([f()],fe.prototype,"expressionAttributes",void 0),e([f({readOnly:!0})],fe.prototype,"formattedMediaInfos",null),e([f()],fe.prototype,"isAggregate",void 0),e([f()],fe.prototype,"layer",void 0),e([f({readOnly:!0})],fe.prototype,"formattedMediaInfoCount",null),e([f()],fe.prototype,"mediaInfos",void 0),e([f()],fe.prototype,"popupTemplate",void 0),e([f()],fe.prototype,"relatedInfos",void 0),e([f()],fe.prototype,"title",void 0),fe=e([j("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],fe);const be=fe,je=["$datastore","$map","$layer","$aggregatedfeatures"],ge=i.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");function _e(){return import("../../chunks/arcadeUtils.js").then((e=>e.aw))}async function Ie({graphic:e,view:t}){const{isAggregate:r,layer:s}=e;if(!r||!s||"2d"!==t?.type)return[];const o=await t.whenLayerView(s);if(!function(e){return"createQuery"in e&&"queryFeatures"in e}(o))return[];const i=o.createQuery(),n=e.getObjectId();i.aggregateIds=null!=n?[n]:[];const{features:a}=await o.queryFeatures(i);return a}async function Ce({expressionInfo:e,arcadeUtils:t,interceptor:r,spatialReference:s,map:o,graphic:i,view:n}){if(!e||!e.expression)return null;const a=t.createSyntaxTree(e.expression),l=je.filter((e=>t.hasVariable(a,e))),[p]=await Promise.all([Ie({graphic:i,view:n}),t.loadScriptDependencies(a,!0,l)]),u=t.getViewInfo({spatialReference:s}),c=t.createExecContext(i,u);c.interceptor=r,c.useAsync=!0,function({aggregatedFeatures:e,arcadeUtils:t,featureSetVars:r,context:s,viewInfo:o,map:i,graphic:n,interceptor:a}){r.forEach((r=>{const l=r.toLowerCase(),p=o.sr,u={map:i,spatialReference:p,interceptor:a};if("$map"===l&&(s.vars[l]=t.convertMapToFeatureSetCollection(u)),"$layer"===l&&(s.vars[l]=t.convertFeatureLayerToFeatureSet({layer:n.sourceLayer,spatialReference:p,interceptor:a})),"$datastore"===l&&(s.vars[l]=t.convertServiceUrlToWorkspace({url:n.sourceLayer.url,spatialReference:p,interceptor:a})),"$aggregatedfeatures"===l){const r=n.layer,{fields:o,objectIdField:i,geometryType:p,spatialReference:u,displayField:c}=r,d=new se({fields:o,objectIdField:i,geometryType:p,spatialReference:u,displayField:c,..."feature"===r.type?{templates:r.templates,typeIdField:r.typeIdField,types:r.types}:null,source:e});s.vars[l]=t.convertFeatureLayerToFeatureSet({layer:d,spatialReference:u,interceptor:a})}}))}({aggregatedFeatures:p,arcadeUtils:t,featureSetVars:l,context:c,viewInfo:u,map:o,graphic:i,interceptor:r});const d=t.createFunction(a,c);return t.executeAsyncFunction(d,c).catch((t=>ge.error("arcade-execution-error",{error:t,graphic:i,expressionInfo:e})))}async function Fe({expressionInfos:e,spatialReference:t,graphic:r,interceptor:s,map:o,view:i}){if(!e||!e.length)return{};const n=await _e(),a={};for(const l of e)a[`expression/${l.name}`]=Ce({expressionInfo:l,arcadeUtils:n,interceptor:s,spatialReference:t,map:o,graphic:r,view:i});const l=await p(a),u={};for(const e in l)u[e]="string"==typeof(c=l[e].value)?T(E(c)):Array.isArray(c)?function(e){return`<ul class="esri-widget__list">${e.map((e=>`<li>${"string"==typeof e?T(E(e)):e}</li>`)).join("")}</ul>`}(c):"esri.arcade.Dictionary"===c?.declaredClass?function(e){const t=e.keys().map((t=>{const r=e.field(t);return`<tr><th>${t}</th><td>${"string"==typeof r?T(E(r)):r}</td></tr>`})).join("");return`<table class="esri-widget__table">${t}</table>`}(c):c;var c;return u}let ve=class extends($(r)){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:e}=this;e&&e.abort(),this._abortController=null},this._createVM=()=>{const e=this.contentElement?.type;this.contentElementViewModel?.destroy();const t="fields"===e?new ce:"media"===e?new be:"text"===e?new pe:null;this._set("contentElementViewModel",t)},this._compile=async()=>{this._cancelQuery();const e=new AbortController;this._abortController=e,await this._compileExpression(),this._abortController===e&&(this._abortController=null)},this._compileThrottled=y(this._compile,1,this),this._compileExpression=async()=>{const{expressionInfo:e,graphic:t,interceptor:r,spatialReference:s,map:o,view:i,_abortController:n}=this;if(!(e&&t&&s&&o))return void this._set("contentElement",null);const a=await _e();if(n!==this._abortController)return;const l=await Ce({arcadeUtils:a,expressionInfo:e,graphic:t,interceptor:r,map:o,spatialReference:s,view:i});if(!l||"esri.arcade.Dictionary"!==l.declaredClass)return void this._set("contentElement",null);const p=await l.castAsJsonAsync(n?.signal),u=p?.type,c="media"===u?z.fromJSON(p):"text"===u?g.fromJSON(p):"fields"===u?B.fromJSON(p):null;this._set("contentElement",c)},this.handles.add([d((()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view]),(()=>this._compileThrottled()),m),d((()=>[this.contentElement]),(()=>this._createVM()),m)])}destroy(){this._cancelQuery(),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:r}=this;return e?"loading":t||r?"ready":"disabled"}get map(){return this.view?.map??null}set map(e){this._override("map",e)}};e([f()],ve.prototype,"_abortController",void 0),e([f({type:G})],ve.prototype,"expressionInfo",void 0),e([f({type:t})],ve.prototype,"graphic",void 0),e([f({readOnly:!0})],ve.prototype,"contentElement",void 0),e([f({readOnly:!0})],ve.prototype,"contentElementViewModel",void 0),e([f()],ve.prototype,"interceptor",void 0),e([f()],ve.prototype,"spatialReference",null),e([f({readOnly:!0})],ve.prototype,"state",null),e([f()],ve.prototype,"map",null),e([f()],ve.prototype,"view",void 0),ve=e([j("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],ve);const we=ve;let Ae=class extends(oe(o($(r)))){constructor(e){super(e),this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:e}=this;e&&e.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await u(this._query()),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._cancelQueryFeatureCount();const e=new AbortController;this._queryFeatureCountAbortController=e,await u(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null)},this._queryPageController=async()=>{const e=new AbortController;this._queryPageAbortController=e,await u(this._queryPage()),this._queryPageAbortController===e&&(this._queryPageAbortController=null)},this._queryThrottled=y(this._queryController,100,this),this._queryFeatureCountThrottled=y(this._queryFeatureCountController,100,this),this._queryPageThrottled=y(this._queryPageController,100,this),this._query=async()=>{const{_queryAbortController:e,relatedFeatures:t}=this;this._destroyRelatedFeatureViewModels(),this.featurePage=1,t.removeAll(),t.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:e?.signal})))},this.handles.add([d((()=>[this.displayCount,this.graphic,this.layer,this.map,this.orderByFieldsFixedCasing,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount]),(()=>this._queryThrottled()),m),d((()=>[this.featurePage,this.showAllEnabled]),(()=>this._queryPageThrottled())),d((()=>[this.layer,this.relationshipId,this.objectId,this.canQuery]),(()=>this._queryFeatureCountThrottled()))])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:t,featureCount:r}=this,s=Math.ceil(r/t)||1;this._set("featurePage",Math.min(Math.max(e,1),s))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:t}=this;return e&&t?.loaded?e.map((e=>{const r=e.clone();return r.field=x(e.field,t),r})):e??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canQuery(){const e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&"number"==typeof this.relationshipId&&"number"==typeof this.objectId&&e?.supportsCount&&e?.supportsPagination)}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e,0),10))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new ie}get relatedLayer(){const{layer:e,map:t,relationship:r}=this;return e?.loaded&&t&&r?P(t,e,r)??null:null}get relationship(){const{relationshipId:e,layer:t}=this;return"number"==typeof e?t?.relationships?.find((({id:t})=>t===e))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new ie}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:r,canQuery:s}=this;return t?"loading":e||r?"querying":s?"ready":"disabled"}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.forEach((e=>!e.destroyed&&e.destroy())),this.relatedFeatureViewModels.removeAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:t,relationshipId:r,objectId:s,_queryFeatureCountAbortController:o,canQuery:i,supportsCacheHint:n}=this;if(await(e?.load()),await(t?.load()),!i||!e||!t)return void this._set("featureCount",0);const l=t.createQuery(),p=new te({cacheHint:n,relationshipId:r,returnGeometry:!1,objectIds:[s],where:a(l.where,void 0)}),u=await e.queryRelatedFeaturesCount(p,{signal:o?.signal});this._set("featureCount",u[s]||0)}_sliceFeatures(e){const{showAllEnabled:t,displayCount:r}=this;return t?e:r?e.slice(0,r):[]}async _queryPage(){const{relatedFeatures:e,featurePage:t,showAllEnabled:r,_queryPageAbortController:s}=this;!r||t<2||e.addMany(await this._queryRelatedFeatures({signal:s?.signal}))}async _queryRelatedFeatures(e){const{orderByFieldsFixedCasing:t,showAllEnabled:r,featuresPerPage:s,displayCount:o,layer:i,relationshipId:l,featurePage:p,featureCount:u,relatedLayer:c,supportsCacheHint:d}=this,{canQuery:m,objectId:h}=this;if(!m||!i||!c)return[];const y=r?((p-1)*s+u)%u:0,f=r?s:o,b=c.objectIdField,j=[...t.map((e=>e.field)),b].filter(n),g=t.map((e=>`${e.field} ${e.order}`)),_=c.createQuery(),I=new te({orderByFields:g,start:y,num:f,outFields:j,cacheHint:d,relationshipId:l,returnGeometry:!1,objectIds:[h],where:a(_.where,void 0)}),C=await i.queryRelatedFeatures(I,{signal:e?.signal}),F=C[h]?.features||[];return F.forEach((e=>{e.sourceLayer=c,e.layer=c})),F}};e([f()],Ae.prototype,"_queryAbortController",void 0),e([f()],Ae.prototype,"_queryPageAbortController",void 0),e([f()],Ae.prototype,"_queryFeatureCountAbortController",void 0),e([f({value:1})],Ae.prototype,"featurePage",null),e([f()],Ae.prototype,"featuresPerPage",void 0),e([f({readOnly:!0})],Ae.prototype,"orderByFieldsFixedCasing",null),e([f({readOnly:!0})],Ae.prototype,"supportsCacheHint",null),e([f({readOnly:!0})],Ae.prototype,"canQuery",null),e([f()],Ae.prototype,"description",void 0),e([f({readOnly:!0})],Ae.prototype,"itemDescriptionFieldName",null),e([f({value:3})],Ae.prototype,"displayCount",null),e([f({type:t})],Ae.prototype,"graphic",void 0),e([f()],Ae.prototype,"layer",void 0),e([f()],Ae.prototype,"map",void 0),e([f({readOnly:!0})],Ae.prototype,"objectId",null),e([f({readOnly:!0})],Ae.prototype,"objectIdField",null),e([f()],Ae.prototype,"orderByFields",void 0),e([f({readOnly:!0})],Ae.prototype,"relatedFeatures",null),e([f({readOnly:!0})],Ae.prototype,"relatedLayer",null),e([f({readOnly:!0})],Ae.prototype,"relationship",null),e([f()],Ae.prototype,"featureCount",void 0),e([f({readOnly:!0})],Ae.prototype,"relatedFeatureViewModels",null),e([f()],Ae.prototype,"relationshipId",void 0),e([f()],Ae.prototype,"showAllEnabled",void 0),e([f()],Ae.prototype,"state",null),e([f()],Ae.prototype,"title",void 0),Ae=e([j("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],Ae);const Me=Ae;var xe;const ke="content-view-models",Re="relationship-view-models",Te={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0};let Ee=xe=class extends(o(r)){constructor(e){super(e),this._handles=new s,this._error=null,this._featureAbortController=null,this._graphicChangedThrottled=y(this._graphicChanged,1,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...Te},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=e=>{const{abilities:t}=this;return"attachments"===e.type&&!!t.attachmentsContent||"custom"===e.type&&!!t.customContent||"fields"===e.type&&!!t.fieldsContent||"media"===e.type&&!!t.mediaContent||"text"===e.type&&!!t.textContent||"expression"===e.type&&!!t.expressionContent||"relationship"===e.type&&!!t.relationshipContent},this._handles.add(d((()=>[this.graphic,this._effectivePopupTemplate,this.abilities]),(()=>this._graphicChangedThrottled()),m))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return n(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return S(L(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return V(this.graphic)}castAbilities(e){return{...Te,...e}}get isTable(){return this._sourceLayer?.isTable||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?e.clone():null)}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get map(){return this.view?.map||null}set map(e){this._override("map",e)}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const r=this.contentViewModels[e];r instanceof be&&r.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof be&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof be&&t.previous()}async updateGeometry(){const{graphic:e,spatialReference:t,_sourceLayer:r}=this;await(r?.load());const s=r?.objectIdField;if(!s||!e||!r)return;const o=e?.attributes?.[s];if(null==o)return;const i=[o];if(!e.geometry){const s=await q({layer:r,graphic:e,outFields:[],objectIds:i,returnGeometry:!0,spatialReference:t}),o=s?.geometry;o&&(e.geometry=o)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:e}=this;if(!e)return;const t=new AbortController;this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(t){c(t)||(this._error=t,i.getLogger(this.declaredClass).error("error","The popupTemplate could not be displayed for this feature.",{error:t,graphic:e,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContentElement(e,t){return"attachments"===e.type?this._compileAttachments(e,t):"custom"===e.type?this._compileCustom(e,t):"fields"===e.type?this._compileFields(e,t):"media"===e.type?this._compileMedia(e,t):"text"===e.type?this._compileText(e,t):"expression"===e.type?this._compileExpression(e,t):"relationship"===e.type?this._compileRelationship(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map(((e,t)=>this._compileContentElement(e,t))).filter(n):"string"==typeof e?this._compileText(new g({text:e}),0).text:e}_destroyContentViewModels(){this._handles?.remove(Re),this._handles?.remove(ke),this.contentViewModels.forEach((e=>e&&!e.destroyed&&e.destroy())),this._set("contentViewModels",[])}_matchesFeature(e,t){const r=e?.graphic?.getObjectId(),s=t?.getObjectId();return n(r)&&n(s)&&r===s}_setRelatedFeaturesViewModels({relatedFeatureViewModels:e,relatedFeatures:t,map:r}){const{view:s,spatialReference:o}=this;t?.filter(Boolean).forEach((t=>{e.find((e=>this._matchesFeature(e,t)))||e.add(new xe({abilities:{relationshipContent:!1},map:r,view:s,spatialReference:o,graphic:t}))})),e.forEach((r=>{const s=t?.find((e=>this._matchesFeature(r,e)));s||e.remove(r)}))}_setExpressionContentVM(e,t){const r=this.formattedAttributes,{contentElement:s,contentElementViewModel:o}=e,i=s?.type;o&&i&&("fields"===i&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:t,formattedAttributes:r}),o.set(this._createFieldsVMParams(s,t))),"media"===i&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:t,formattedAttributes:r}),o.set(this._createMediaVMParams(s,t))),"text"===i&&o.set(this._createTextVMParams(s)))}_compileRelationship(e,t){const{displayCount:r,orderByFields:s,relationshipId:o,title:i,description:n}=e,{_sourceLayer:a,graphic:l,map:p}=this,u=new Me({displayCount:r,graphic:l,orderByFields:s,relationshipId:o,layer:a,map:p,...this._compileTitleAndDesc({title:i,description:n})});return this.contentViewModels[t]=u,this._handles.add(h((()=>u.relatedFeatures),"change",(()=>this._setRelatedFeaturesViewModels(u))),Re),e}_compileExpression(e,t){const{expressionInfo:r}=e,{graphic:s,map:o,spatialReference:i,view:n}=this,a=new we({expressionInfo:r,graphic:s,interceptor:xe.interceptor,map:o,spatialReference:i,view:n});return this.contentViewModels[t]=a,this._handles.add(d((()=>a.contentElementViewModel),(()=>this._setExpressionContentVM(a,t)),m),ke),e}_compileAttachments(e,t){const{graphic:r}=this,{description:s,title:o}=e;return this.contentViewModels[t]=new ae({graphic:r,...this._compileTitleAndDesc({title:o,description:s})}),e}_compileCustom(e,t){const{graphic:r}=this,{creator:s,destroyer:o}=e;return this.contentViewModels[t]=new pe({graphic:r,creator:s,destroyer:o}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:r,_sourceLayer:s,graphic:o,formattedAttributes:i}=this,n=o?.attributes,a=this._expressionAttributes,l=i.global;return{title:v({attributes:n,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:s,text:e}),description:v({attributes:n,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:s,text:t})}}_createFieldsVMParams(e,t){const r=this._effectivePopupTemplate,s=this.formattedAttributes,o={...s?.global,...s?.content[t]},i=e?.fieldInfos||r?.fieldInfos,n=i?.filter((({fieldName:e})=>k(e)||F(e)||o.hasOwnProperty(e))),a=r?.expressionInfos,{description:l,title:p}=e;return{attributes:o,expressionInfos:a,fieldInfos:n,...this._compileTitleAndDesc({title:p,description:l})}}_compileFields(e,t){const r=e.clone(),s=new ce(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=s,r.fieldInfos=s.formattedFieldInfos.slice(0),r}_createMediaVMParams(e,t){const{abilities:r,graphic:s,_fieldInfoMap:o,_effectivePopupTemplate:i,relatedInfos:n,_sourceLayer:a,_expressionAttributes:l}=this,p=this.formattedAttributes,u=s?.attributes??{},{description:c,mediaInfos:d,title:m}=e;return{abilities:{chartAnimation:r.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:u,isAggregate:s?.isAggregate,layer:a,fieldInfoMap:o,formattedAttributes:{...p?.global,...p?.content[t]},expressionAttributes:l,mediaInfos:d,popupTemplate:i,relatedInfos:n,...this._compileTitleAndDesc({title:m,description:c})}}_compileMedia(e,t){const r=e.clone(),s=new be(this._createMediaVMParams(e,t));return r.mediaInfos=s.formattedMediaInfos.slice(0),this.contentViewModels[t]=s,r}_createTextVMParams(e){const{graphic:t,_fieldInfoMap:r,_sourceLayer:s,_expressionAttributes:o}=this;if(e&&e.text){const i=t?.attributes??{},n=this.formattedAttributes?.global??{};e.text=v({attributes:i,fieldInfoMap:r,globalAttributes:n,expressionAttributes:o,layer:s,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){const r=e.clone();return this.contentViewModels[t]=new pe(this._createTextVMParams(r)),r}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:r}=this;if(!e)return;const{lastEditInfoEnabled:s}=e,o=t?.editFieldsInfo;return s&&o?U(o,r?.attributes):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:r,graphic:s,_expressionAttributes:o}=this,i=s?.attributes??{},n=this.formattedAttributes?.global??{};return v({attributes:i,fieldInfoMap:t,globalAttributes:n,expressionAttributes:o,layer:r,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this;if(!t)return null;const r=e?.title;return I(r,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this;if(!t)return null;const r=e?.content;return I(r,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:r,graphic:s,_effectivePopupTemplate:o}=this,i=this.map,n=this.view,a=this.spatialReference;if(t!==this._featureAbortController||!s)return;await O({graphic:s,popupTemplate:o,layer:r,spatialReference:a},e);const{content:{value:l},title:{value:u}}=await p({content:this._getContent(),title:this._getTitle()}),{expressionAttributes:{value:c}}=await p({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:Fe({expressionInfos:o?.expressionInfos,spatialReference:a,graphic:s,map:i,interceptor:xe.interceptor,view:n})});t===this._featureAbortController&&s&&(this._expressionAttributes=c,this._graphicExpressionAttributes={...s.attributes,...c},this._set("formattedAttributes",this._createFormattedAttributes(l)),this._set("title",this._compileTitle(u)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:r}){const{_effectivePopupTemplate:s,graphic:o,relatedInfos:i,_sourceLayer:n,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;r.content[t]=D({fieldInfos:s?.fieldInfos,graphic:o,attributes:{...l,...e.attributes},layer:n,fieldInfoMap:a,relatedInfos:i})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:r}){if(e.fieldInfos){const{graphic:s,relatedInfos:o,_sourceLayer:i,_fieldInfoMap:n,_graphicExpressionAttributes:a}=this;r.content[t]=D({fieldInfos:e.fieldInfos,graphic:s,attributes:{...a,...e.attributes},layer:i,fieldInfoMap:n,relatedInfos:o})}}_createFormattedAttributes(e){const{_effectivePopupTemplate:t,graphic:r,relatedInfos:s,_sourceLayer:o,_fieldInfoMap:i,_graphicExpressionAttributes:n}=this,a=t?.fieldInfos,l={global:D({fieldInfos:a,graphic:r,attributes:n,layer:o,fieldInfoMap:i,relatedInfos:s}),content:[]};return Array.isArray(e)&&e.forEach(((e,t)=>{"fields"===e.type&&this._createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:l}),"media"===e.type&&this._createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:l})})),l}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(t,L(r),e)}async _queryRelatedInfos(e,t,r){const{relatedInfos:s,_sourceLayer:o}=this;s.clear();const i=n(o?.associatedLayer)?await(o?.associatedLayer.load(r)):o;if(!i||!e)return;const a=t.filter((e=>e&&F(e.fieldName)));if(!a||!a.length)return;t.forEach((e=>this._configureRelatedInfo(e,i)));const u=await function({relatedInfos:e,layer:t},r){const s={};return e.forEach(((e,o)=>{const{relation:i}=e;if(!i){const e=new K("relation-required","A relation is required on a layer to retrieve related records.");throw de.error(e),e}const{relatedTableId:n}=i;if("number"!=typeof n){const e=new K("A related table ID is required on a layer to retrieve related records.");throw de.error(e),e}const a=`${t.url}/${n}`,l=me.get(a),p=l??function(e,t){return Z(e,{query:{f:"json"},signal:t&&t.signal})}(a,r);l||me.set(a,p),s[o]=p})),l(p(s),r)}({relatedInfos:s,layer:i},r);Object.keys(u).forEach((e=>{const t=s.get(e.toString()),r=u[e]?.value;t&&r&&(t.layerInfo=r.data)}));const c=await function({graphic:e,relatedInfos:t,layer:r},s){const o={};return t.forEach(((t,i)=>{t.layerInfo&&(o[i]=async function(e,t,r,s){const o=r.layerId.toString(),{layerInfo:i,relation:n,relatedFields:a,outStatistics:l,url:u,sourceSpatialReference:c}=t;if(!i||!n)return null;const d=function({originRelationship:e,relationships:t,layerId:r}){let s=null;return t&&t.some((t=>(`${t.relatedTableId}`===r&&t.id===e?.id&&(s=t),!!s))),s}({originRelationship:n,relationships:i.relationships,layerId:o});if(d?.relationshipTableId&&d.keyFieldInRelationshipTable){const t=await function(e,t,r,s){const o=new te;return o.outFields=["*"],o.relationshipId="number"==typeof t.id?t.id:parseInt(t.id,10),o.objectIds=[e.attributes[r.objectIdField]],r.queryRelatedFeatures?.(o,s)??Promise.resolve({})}(e,d,r,s),o=t[e.attributes[r.objectIdField]];if(!o)return null;const n=o.features.map((e=>e.attributes[i.objectIdField]));if(l?.length&&i.supportsStatistics){const e=new ee;e.where=function(e,t,r){let s=0;const o=[];for(;s<t.length;)o.push(`${e} IN (${t.slice(s,1e3+s)})`),s+=1e3;return o.join(" OR ")}(i.objectIdField,n),e.outFields=a,e.outStatistics=l,e.sourceSpatialReference=c;const t={features:Promise.resolve(o),statsFeatures:Y(u,e)};return p(t)}}const m=d?.keyField;if(m){const r=X(function(e,t){if(null!=e){t=t.toLowerCase();for(const r of e)if(r&&r.name.toLowerCase()===t)return r}return null}(i.fields,m)),o=function(e,t){const r=t.toLowerCase();for(const t in e)if(t.toLowerCase()===r)return e[t];return null}(e.attributes,n.keyField),a=r?`${m}=${o}`:`${m}='${o}'`,l=Y(u,new ee({where:a,outFields:t.relatedFields,sourceSpatialReference:c}),s),d=t.outStatistics&&t.outStatistics.length>0&&i.supportsStatistics?Y(u,new ee({where:a,outFields:t.relatedFields,outStatistics:t.outStatistics,sourceSpatialReference:c}),s):null,h={features:l};return d&&(h.statsFeatures=d),p(h)}return null}(e,t,r,s))})),p(o)}({graphic:e,relatedInfos:s,layer:i},r);Object.keys(c).forEach((e=>{!function(e,t){if(!t)return;if(!e)return;const{features:r,statsFeatures:s}=e,o=r&&r.value;t.relatedFeatures=o?o.features:[];const i=s&&s.value;t.relatedStatsFeatures=i?i.features:[]}(c[e]?.value,s.get(e.toString()))}))}_configureRelatedInfo(e,t){const{relatedInfos:r}=this,s=he(e.fieldName);if(!s)return;const{layerId:o,fieldName:i}=s;if(!o)return;const n=r.get(o.toString())||function(e,t){const r=function(e,t){if(!t.relationships)return null;let r=null;const{relationships:s}=t;return s.some((t=>t.id===parseInt(e,10)&&(r=t,!0))),r}(e,t);if(r)return{url:`${t.url}/${r.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}(o,t);n&&(function({relatedInfo:e,fieldName:t,fieldInfo:r}){if(e.relatedFields?.push(t),r.statisticType){const s=new re({statisticType:r.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics?.push(s)}}({relatedInfo:n,fieldName:i,fieldInfo:e}),this.relatedInfos.set(o,n))}};Ee.interceptor=new class{constructor(e,t){this.preLayerQueryCallback=e,this.preRequestCallback=t,this.preLayerQueryCallback||(this.preLayerQueryCallback=e=>{}),this.preRequestCallback||(this.preLayerQueryCallback=e=>{})}}(Q,N),e([f()],Ee.prototype,"_error",void 0),e([f()],Ee.prototype,"_featureAbortController",void 0),e([f({readOnly:!0})],Ee.prototype,"_effectivePopupTemplate",null),e([f({readOnly:!0})],Ee.prototype,"_fieldInfoMap",null),e([f({readOnly:!0})],Ee.prototype,"_sourceLayer",null),e([f()],Ee.prototype,"abilities",void 0),e([b("abilities")],Ee.prototype,"castAbilities",null),e([f({readOnly:!0})],Ee.prototype,"content",void 0),e([f({readOnly:!0})],Ee.prototype,"contentViewModels",void 0),e([f()],Ee.prototype,"description",void 0),e([f({type:Boolean})],Ee.prototype,"defaultPopupTemplateEnabled",void 0),e([f({readOnly:!0})],Ee.prototype,"isTable",null),e([f({readOnly:!0})],Ee.prototype,"state",null),e([f({readOnly:!0})],Ee.prototype,"formattedAttributes",void 0),e([f({type:t,value:null})],Ee.prototype,"graphic",null),e([f({readOnly:!0})],Ee.prototype,"lastEditInfo",void 0),e([f({readOnly:!0})],Ee.prototype,"relatedInfos",void 0),e([f()],Ee.prototype,"spatialReference",null),e([f({readOnly:!0})],Ee.prototype,"title",void 0),e([f()],Ee.prototype,"map",null),e([f({readOnly:!0})],Ee.prototype,"waitingForContent",null),e([f()],Ee.prototype,"view",void 0),Ee=xe=e([j("esri.widgets.FeatureViewModel")],Ee);const Pe=Ee;export{ae as F,pe as a,ce as b,be as c,we as d,Pe as default,Me as e};
