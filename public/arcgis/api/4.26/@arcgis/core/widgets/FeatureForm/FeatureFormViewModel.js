/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import"../../intl.js";import s from"../../core/Evented.js";import{HandleOwnerMixin as r}from"../../core/HandleOwner.js";import{L as o}from"../../chunks/Logger.js";import{a as i,u as n,i as a,d as l}from"../../chunks/maybe.js";import{EsriPromiseMixin as p}from"../../core/Promise.js";import{watch as u}from"../../core/reactiveUtils.js";import{t as c}from"../../chunks/string.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import{o as d}from"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as y}from"../../core/accessorSupport/decorators/subclass.js";import h from"../../form/FormTemplate.js";import f from"../../core/Accessor.js";import{i as g}from"../../chunks/editableLayers.js";import j from"../../request.js";import{JSONSupportMixin as b}from"../../core/JSONSupport.js";import _ from"../../core/Loadable.js";import{p as V}from"../../chunks/arcgisLayerUrl.js";import{S as v}from"../../chunks/Subtype.js";import F,{p as x,i as C,g as k}from"./InputField.js";import{createArcadeProfile as E,createArcadeExecutor as S}from"../../arcade.js";import{debounce as I,isAbortError as T,createResolver as w}from"../../core/promiseUtils.js";import{W as A}from"../../chunks/WatchUpdatingTracking.js";import{fixFields as L}from"../../layers/support/fieldUtils.js";import R from"./InputFieldGroup.js";import{o as G}from"../../chunks/locale.js";import{f as M}from"../../chunks/messages.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../core/lang.js";import"../../chunks/unitUtils.js";import"../../chunks/jsonMap.js";import"../../chunks/object.js";import"../../chunks/Ellipsoid.js";import"../../chunks/writer.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../config.js";import"../../chunks/ArrayPool.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/Error.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../PopupTemplate.js";import"../../core/Clonable.js";import"../../core/Collection.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../chunks/enumeration.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../chunks/arcadeOnDemand.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils2.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils3.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../chunks/Symbol3DAnchorPosition2D.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/assets.js";import"../../form/ExpressionInfo.js";import"../../form/elements/GroupElement.js";import"../../form/elements/Element.js";import"../../form/support/elements.js";import"../../form/elements/FieldElement.js";import"../../form/elements/support/inputs.js";import"../../form/elements/inputs/BarcodeScannerInput.js";import"../../form/elements/inputs/TextInput.js";import"../../form/elements/inputs/Input.js";import"../../form/elements/inputs/ComboBoxInput.js";import"../../form/elements/inputs/DateTimePickerInput.js";import"../../form/elements/inputs/RadioButtonsInput.js";import"../../form/elements/inputs/SwitchInput.js";import"../../form/elements/inputs/TextAreaInput.js";import"../../form/elements/inputs/TextBoxInput.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/layerUtils.js";import"../../chunks/ArcadeDate.js";import"../../chunks/executionError.js";import"../../chunks/datetime.js";import"../../chunks/ImmutableArray.js";import"../../layers/FeatureLayer.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/support/AuthoringInfo.js";import"../../renderers/support/AuthoringInfoVisualVariable.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../renderers/mixins/VisualVariablesMixin.js";import"../../renderers/visualVariables/ColorVariable.js";import"../../renderers/visualVariables/VisualVariable.js";import"../../chunks/LegendOptions.js";import"../../renderers/visualVariables/support/ColorStop.js";import"../../renderers/visualVariables/OpacityVariable.js";import"../../renderers/visualVariables/support/OpacityStop.js";import"../../renderers/visualVariables/RotationVariable.js";import"../../renderers/visualVariables/SizeVariable.js";import"../../renderers/visualVariables/support/SizeStop.js";import"../../chunks/sizeVariableUtils.js";import"../../chunks/visualVariableUtils.js";import"../../chunks/compilerUtils.js";import"../../chunks/lengthUtils.js";import"../../renderers/support/ClassBreakInfo.js";import"../../chunks/commonProperties.js";import"../../symbols/support/jsonUtils.js";import"../../renderers/DictionaryRenderer.js";import"../../chunks/DictionaryLoader.js";import"../../chunks/LRUCache.js";import"../../chunks/MemCache.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/support/AttributeColorInfo.js";import"../../renderers/HeatmapRenderer.js";import"../../renderers/support/HeatmapColorStop.js";import"../../chunks/heatmapUtils.js";import"../../chunks/vec4f64.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../chunks/diffUtils.js";import"../../renderers/support/UniqueValue.js";import"../../renderers/support/UniqueValueClass.js";import"../../renderers/support/UniqueValueGroup.js";import"../../renderers/support/UniqueValueInfo.js";import"../../chunks/styleUtils.js";import"../../renderers/support/jsonUtils.js";import"../../chunks/MultiOriginJSONSupport.js";import"../../core/sql.js";import"../../layers/Layer.js";import"../../core/workers/workers.js";import"../../core/workers/Connection.js";import"../../chunks/Queue.js";import"../../core/workers/RemoteClient.js";import"../../chunks/editsZScale.js";import"../../chunks/queryZScale.js";import"../../chunks/zscale.js";import"../../rest/support/FeatureSet.js";import"../../layers/support/Field.js";import"../../chunks/fieldType.js";import"../../layers/mixins/APIKeyMixin.js";import"../../chunks/ArcGISService.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/mat4f32.js";import"../../chunks/mat4.js";import"../../chunks/_commonjsHelpers.js";import"../../layers/mixins/CustomParametersMixin.js";import"../../chunks/EditBusLayer.js";import"../../layers/mixins/FeatureEffectLayer.js";import"../../layers/support/FeatureEffect.js";import"../../layers/support/FeatureFilter.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../rest/support/Query.js";import"../../chunks/DataLayerSource.js";import"../../chunks/FullTextSearch.js";import"../../rest/support/StatisticDefinition.js";import"../../layers/mixins/FeatureLayerBase.js";import"../../geometry/HeightModelInfo.js";import"../../chunks/commonProperties2.js";import"../../support/timeUtils.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/TimeReference.js";import"../../chunks/featureLayerUtils.js";import"../../rest/support/AttachmentQuery.js";import"../../rest/support/RelationshipQuery.js";import"../../layers/support/GeometryFieldsInfo.js";import"../../layers/support/LayerFloorInfo.js";import"../../layers/support/Relationship.js";import"../../chunks/serviceCapabilitiesUtils.js";import"../../layers/mixins/FeatureReductionLayer.js";import"../../layers/support/AggregateField.js";import"../../layers/support/ExpressionInfo.js";import"../../chunks/FeatureReduction.js";import"../../layers/support/FeatureReductionBinning.js";import"../../layers/support/LabelClass.js";import"../../chunks/labelUtils.js";import"../../chunks/defaults.js";import"../../chunks/defaultsJSON.js";import"../../layers/support/FeatureReductionCluster.js";import"../../layers/support/FeatureReductionSelection.js";import"../../chunks/clusterUtils.js";import"../../chunks/OperationalLayer.js";import"../../layers/mixins/OrderedLayer.js";import"../../layers/mixins/PortalLayer.js";import"../../chunks/asyncUtils.js";import"../../portal/PortalItem.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../chunks/portalItemUtils.js";import"../../geometry/projection.js";import"../../chunks/pe.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../layers/mixins/PublishableLayer.js";import"../../layers/support/PublishingInfo.js";import"../../layers/mixins/RefreshableLayer.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../layers/mixins/TemporalLayer.js";import"../../TimeInterval.js";import"../../layers/support/TimeInfo.js";import"../../layers/support/FeatureTemplate.js";import"../../layers/support/FeatureType.js";import"../../chunks/fieldProperties.js";import"../../layers/support/FieldsIndex.js";import"../../chunks/labelingInfo.js";import"../../chunks/versionUtils.js";import"../../chunks/styleUtils2.js";import"../../rest/support/TopFeaturesQuery.js";import"../../rest/support/TopFilter.js";import"../../support/popupUtils.js";let D=class extends f{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.codedValue=null}};e([m()],D.prototype,"objectType",void 0),e([m()],D.prototype,"maxValue",void 0),e([m()],D.prototype,"minValue",void 0),e([m()],D.prototype,"codedValue",void 0),D=e([y("esri.layers.support.ContingentValue")],D);const U=D;let P=class extends f{constructor(e){super(e),this.isRetired=!1}};e([m()],P.prototype,"id",void 0),e([m()],P.prototype,"isRetired",void 0),e([m()],P.prototype,"subtype",void 0),e([m()],P.prototype,"values",void 0),P=e([y("esri.layers.support.Contingency")],P);const O=P;let N=class extends f{constructor(e){super(e)}};e([m()],N.prototype,"fieldGroup",void 0),e([m()],N.prototype,"type",void 0),N=e([y("esri.layers.support.ContingencyConstraintViolation")],N);const B=N;let $=class extends f{constructor(e){super(e)}};e([m()],$.prototype,"contingentValuesAllGroups",void 0),e([m()],$.prototype,"contingentValuesByFieldGroup",void 0),$=e([y("esri.layers.support.ContingentValuesResult")],$);const J=$;let H=class extends f{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};e([m()],H.prototype,"name",void 0),e([m()],H.prototype,"fields",void 0),e([m()],H.prototype,"isEditingRestrictive",void 0),e([m()],H.prototype,"contingencies",void 0),H=e([y("esri.layers.support.FieldGroup")],H);const q=H;var z;let W=z=class extends(b(_)){constructor(e){super(e),this.request=j,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get subtypeFieldName(){const{layer:e}=this;return"subtype-group"===e.type?e.subtypeField:e.typeIdField}static async createLoadedLayerContingentValuesCache(e){await e.load();const t=e.sourceJSON;if(void 0===e.layerId)return null;const s=t.hasContingentValuesDefinition;if(s)return new z({layer:e}).load();if(void 0===s){const t=V(e.url);if(i(t))return null;const s=t.url.path;if((await z._staticFetchEnterpriseFeatureRoot(s)).supportsQueryDataElements){const t=e.layerId.toString(),r=await z._staticFetchEnterpriseFieldGroup(s,t);if(r){const t=r.map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names})));return new z({layer:e,fieldGroupDefinitions:t}).load()}}}return null}async load(e){const t=this.layer.load(e).then((()=>this._initializeContingentValues(this.fieldGroupDefinitions,e)));return this.addResolvingPromise(t),this}validateContingencyConstraints(e,t){const s=Object.keys(e),r=[],o=[];for(const i of this.fieldGroups){const n=i.isEditingRestrictive?"error":"warning";if(t&&!i.fields.some((e=>t.includes(e))))continue;if(!i.fields.every((e=>s.includes(e)))){o.push(new B({fieldGroup:i,type:n}));continue}let a=!1;const l=e[this.subtypeFieldName],p=i.contingencies.filter((e=>!(!e.isRetired&&e.subtype)||e.subtype.code===l));for(const t of p){let s=!0;for(const r in t.values){const o=t.values[r];if("any"!==o.objectType)if("null"===o.objectType){if(null!=e[r]){s=!1;break}}else if("code"===o.objectType){if(e[r]!==o.codedValue.code){s=!1;break}}else if("range"===o.objectType){const t=e[r];if(t<o.minValue||t>o.maxValue){s=!1;break}}}if(s){a=!0;break}}a||r.push(new B({fieldGroup:i,type:n}))}return{invalid:r,incomplete:o}}getContingentValues(e,t,s=!1){const r=e[this.subtypeFieldName],o=null!=r,i={};let n=[];const a=this.fieldGroups.filter((e=>e.fields.includes(t)));n.push(new U({objectType:"any"}));for(const l of a){let a=[];const p=l.contingencies.filter((e=>!(e.isRetired||e.subtype&&o&&e.subtype.code!==r)));let u=!1;const c={};for(const s of p){let r,o=!0;for(const i in s.values){const n=s.values[i];if(t!==i){if(void 0!==e[i]&&"any"!==n.objectType)if("null"===n.objectType)null!==e[i]&&(o=!1);else if("code"===n.objectType)e[i]!==n.codedValue.code&&(o=!1);else if("range"===n.objectType){const t=e[i];(t<n.minValue||t>n.maxValue)&&(o=!1)}}else r=n,u=u||"range"===n.objectType}if(r&&o){if("any"===r.objectType){a.length=0,a.push(r);break}const e=this._generateKey(r);c[e]||a.push(r),c[e]=!0}}u&&(a=this._joinRange(a)),i[l.name]=a,n=s?this._filterIntersection(n,a):[]}return 1===a.length&&s&&(n=[]),new J({contingentValuesAllGroups:n,contingentValuesByFieldGroup:i})}_generateKey(e){switch(e.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return e.codedValue.name+e.codedValue.code.toString();case"range":return e.minValue.toString()+"-"+e.maxValue.toString()}}_joinRange(e){let t,s;e.sort(((e,t)=>"null"===e.objectType?-1:"null"===t.objectType?1:e.minValue-t.minValue));const r=[];for(const o of e)"null"!==o.objectType?null!=t&&null!=s?s<o.minValue?(r.push(new U({objectType:"range",minValue:t,maxValue:s})),t=o.minValue,s=o.maxValue):s<o.maxValue&&(s=o.maxValue):(t=o.minValue,s=o.maxValue):r.push(o);return r.push(new U({objectType:"range",minValue:t,maxValue:s})),r}_filterIntersection(e,t){if(0===e.length||0===t.length)return[];if("any"===e[0].objectType)return t;if("any"===t[0].objectType)return e;const s="range"===e[0].objectType||"range"===e[1]?.objectType,r="range"===t[0].objectType||"range"===t[1]?.objectType;return s||r?this._intersectRanges(e,t):this._intersectValues(e,t)}_intersectRanges(e,t){const s=[];let r,o=0;for(const i of e)for(;o<t.length;o++){const e=t[o];if("null"===i.objectType&&"null"===e.objectType)s.push(new U({objectType:"null"}));else{if("null"===i.objectType)break;if("null"===e.objectType)continue}if(i.maxValue<e.minValue)break;if(i.maxValue===e.minValue){s.push(new U({objectType:"range",minValue:i.maxValue,maxValue:e.minValue}));break}if(!(i.minValue>e.maxValue))if(i.minValue!==e.maxValue){if(r=i.minValue>e.minValue?i.minValue:e.minValue,i.maxValue<e.maxValue){s.push(new U({objectType:"range",minValue:r,maxValue:i.maxValue}));break}s.push(new U({objectType:"range",minValue:r,maxValue:e.maxValue}))}else s.push(new U({objectType:"range",minValue:i.minValue,maxValue:e.maxValue}))}return s}_intersectValues(e,t){const s=[];for(const r of e)t.some((e=>{if(r.objectType===e.objectType)switch(r.objectType){case"any":case"null":return!0;case"code":return r.codedValue.code===e.codedValue.code&&r.codedValue.name===e.codedValue.name}return!1}))&&s.push(r);return s}static async _staticFetchEnterpriseFeatureRoot(e,t){return j(e,{responseType:"json",query:{f:"json"},...t}).then((e=>e.data))}static async _staticFetchEnterpriseFieldGroup(e,t,s){return j(`${e}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...s}).then((e=>e.data.layerDataElements?.[0].dataElement.fieldGroups))}async _initializeContingentValues(e,t){const s=e??await this._fetchFieldGroupDefs(t);if(0===s.length)return void(this.fieldGroups=[]);const r=await this._fetchContingentValues(s,t);this.fieldGroups=r}async _fetchFieldGroupDefs(e){if(void 0===this.layer.layerId)return[];const t=this.layer.sourceJSON,s=this.layer.layerId.toString(),r=n(V(this.layer.url)).url.path;return t.hasContingentValuesDefinition?(await this._fetchAGOLFieldGroup(r,s,e)).map((e=>({name:e.name,isEditingRestrictive:e.restrictive,fields:e.fields.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))}))):void 0!==t.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(r,e).then((async t=>t.supportsQueryDataElements?(await this._fetchEnterpriseFieldGroup(r,s,e)).map((e=>({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fieldNames.names.map((e=>this.layer.fieldsIndex.normalizeFieldName(e)))}))):[]))}async _fetchAGOLFieldGroup(e,t,s){return j(`${e}/${t}/fieldgroups`,{responseType:"json",query:{f:"json"},...s}).then((e=>e.data.fieldGroups))}async _fetchEnterpriseFieldGroup(e,t,s){return z._staticFetchEnterpriseFieldGroup(e,t,s)}async _fetchEnterpriseFeatureRoot(e,t){return z._staticFetchEnterpriseFeatureRoot(e,t)}async _fetchContingentValues(e,t){if(void 0===this.layer.layerId)return[];const s=this.layer.sourceJSON,r=this.layer.layerId.toString(),o=n(V(this.layer.url)).url.path;if(s.hasContingentValuesDefinition){const s=await this._fetchAGOLContingentValues(o,r,t);return this._constructFieldGroupsAGOL(e,s)}const i=await this._fetchEnterpriseContingentValues(o,r,t);return this._constructFieldGroupsEnterprise(e,i)}_constructFieldGroupsAGOL(e,t){return e.map((e=>{const s=t.contingentValuesDefinition.fieldGroups.find((t=>t.name===e.name));if(s){let r=[];return r=t.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(e,t,s.subTypes):this._parseAGOLFieldGroup(e,t,s.contingentValues),new q({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:r})}return null})).filter(a)}_parseAGOLFieldGroupSubtype(e,t,s){let r=[];return s?.forEach((s=>{const o=this._getSubtypeAGOL(s.name);r=r.concat(this._parseAGOLFieldGroup(e,t,s.contingentValues,o))})),r}_parseAGOLFieldGroup(e,t,s,r=null){const o=[];for(const i of s??[]){const s=this._parseAGOLContingency(i,e,t,r);o.push(s)}return o}_parseAGOLContingency(e,t,s,r){const o=e.id,i=!!e.retired&&1===e.retired,n={};for(let o=0,i=0;o<t.fields.length;o++){const a=t.fields[o],l=s.typeCodes[e.types[o]];if("Code"===l){let t=e.values[i];i++;const o=this._getDomain(r,a),l=this.layer.getField(a);if("string"===l?.type){const e=s.stringDicts.find((e=>e.domain===o.name));e&&(t=e.entries[t])}const p=o.codedValues.find((e=>e.code===t)),u=new U({codedValue:p,objectType:"code"});n[a]=u}else if("Range"===l){const t=e.values[i];i++;const s=t.range[0],r=t.range[1],o=new U({minValue:s,maxValue:r,objectType:"range"});n[a]=o}else if("Any"===l){const e=new U({objectType:"any"});n[a]=e}else{const e=new U({objectType:"null"});n[a]=e}}return new O({id:o,isRetired:i,subtype:r,values:n})}_constructFieldGroupsEnterprise(e,t){const s=t.fieldGroups;return e.map((e=>{const r=s.find((t=>t.name===e.name));if(r){const s=r.contingencies.map((s=>{const r=s.id,o=s.isRetired||!1,i=this._getSubtypeEnterprise(s.subtypeCode),n={};for(let r=0;r<e.fields.length;r++){const o=e.fields[r];let a=s.values[r];if("number"==typeof a||"string"==typeof a){const e=this._getDomain(i,o),s=this.layer.getField(o);if("string"===s?.type)a=t.stringDictionary[a];else if("date"===s?.type){const e=new Date(`${a}+00:00`);a=e.getTime()}const r=e.codedValues.find((e=>e.code===a)),l=new U({codedValue:r,objectType:"code"});n[o]=l}else if("object"==typeof a){const e=a.minValue,t=a.maxValue,s=new U({minValue:e,maxValue:t,objectType:"range"});n[o]=s}else if(a){const e=new U({objectType:"any"});n[o]=e}else{const e=new U({objectType:"null"});n[o]=e}}return new O({id:r,isRetired:o,subtype:i,values:n})}));return new q({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:s})}return null})).filter(a)}async _fetchEnterpriseContingentValues(e,t,s){return j(`${e}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([t]),f:"json"},...s}).then((e=>e.data.contingentValueSets?.[0]))}async _fetchAGOLContingentValues(e,t,s){return j(`${e}/${t}/contingentValues`,{responseType:"json",query:{f:"json"},...s}).then((e=>e.data))}_getSubtypeEnterprise(e){const t=this.layer.sourceJSON;let s;if(t.subtypes){const r=t.subtypes.find((t=>t.code===e));s=v.fromJSON(r)}return s||null}_getSubtypeAGOL(e){const t=this.layer.sourceJSON;let s;if(t.subtypes){const r=t.subtypes.find((t=>t.name===e));s=v.fromJSON(r)}return s||null}_getDomain(e,t){const s=e?e.domains?.[t]:this.layer.getFieldDomain(t);return"inherited"===s?.type?this.layer.getFieldDomain(t):s}};e([m({constructOnly:!0})],W.prototype,"layer",void 0),e([m({constructOnly:!0})],W.prototype,"request",void 0),e([m({type:[q]})],W.prototype,"fieldGroups",void 0),e([m({constructOnly:!0})],W.prototype,"fieldGroupDefinitions",void 0),e([m()],W.prototype,"subtypeFieldName",null),W=z=e([y("esri.layers.support.LayerContingentValuesCache")],W);const Q=W;var K;const Y=Symbol("FormExpressionArcadeExecutor");let Z=class extends f{constructor(e){super(e),this[K]=!0,this._lastEvaluatedValue=null,this._abortController=new AbortController,this._stale=!1,this._updatingTracking=new A,this._executeAsyncDebounced=I((async(e,t,s)=>{const r=await this.executor.executeAsync(e,{...t,abortSignal:s});return s.aborted?this._lastEvaluatedValue:(this._lastEvaluatedValue=r,this._stale=!1,r)}))}get isAsync(){return this.executor.isAsync}get fieldsUsed(){return this.executor.fieldsUsed}get syntaxTree(){return this.executor.syntaxTree}get updating(){return this._updatingTracking.updating}get stale(){return this._stale}get geometryUsed(){return this.executor.geometryUsed}get variablesUsed(){return this.executor.variablesUsed}get lastEvaluatedValue(){return this._lastEvaluatedValue}abort(){this._abortController.abort()}execute(e,t){this._abortController=new AbortController;const s=this.executor.execute(e,{...t,abortSignal:this._abortController.signal});return this._lastEvaluatedValue=s,s}async executeAsync(e,t){return this._abortController=new AbortController,this._updatingTracking.addPromise(this._executeAsyncDebounced(e,t??{},this._abortController.signal))}markStale(){this._stale=!0}reset(){this.abort(),this._lastEvaluatedValue=null,this._stale=!1}};K=Y,e([m()],Z.prototype,"_lastEvaluatedValue",void 0),e([m()],Z.prototype,"_stale",void 0),e([m()],Z.prototype,"_updatingTracking",void 0),e([m({constructOnly:!0})],Z.prototype,"executor",void 0),e([m()],Z.prototype,"isAsync",null),e([m()],Z.prototype,"fieldsUsed",null),e([m()],Z.prototype,"syntaxTree",null),e([m()],Z.prototype,"updating",null),e([m()],Z.prototype,"stale",null),e([m()],Z.prototype,"geometryUsed",null),e([m()],Z.prototype,"variablesUsed",null),e([m()],Z.prototype,"lastEvaluatedValue",null),Z=e([y("esri.widgets.FeatureForm.FormExpressionArcadeExecutor")],Z);const X=async(e,t)=>{const s=E("form-calculation"),r=await S(e,s,{});return t?.fieldsIndex&&(r.fieldsUsed=L(t.fieldsIndex,r.fieldsUsed)),new Z({executor:r})},ee="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY";let te=class extends f{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}get _baseContext(){const{editType:e,layer:t,map:s,originalFeature:r,spatialReference:o}=this.arcadeContextInfo,i="feature"===t?.type?t:"scene"===t?.type&&a(t.associatedLayer)?t.associatedLayer:void 0;return[{$originalfeature:r,$editcontext:{editType:e},$layer:i,$featureset:i,$datastore:t?.url,$map:s},{spatialReference:o??void 0}]}set feature(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:t,_latestFieldValues:s,feature:r}=this,o=new Set;for(const i of e)if(s[i]=r.getAttribute(i),t.has(i))for(const e of t.get(i))o.add(e);return this._evaluate([...o])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(ee))return this._evaluate([...this._fieldReferencesLookup.get(ee)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:s}=this,r=new Map(this.inputFields.map((e=>[e.name,e]))),o=new Map(s.map((e=>[e,new Array])));for(const i of s){for(const s of i.fieldsUsed){d(e,s,(()=>new Set)).add(i);const n=r.get(s),{valueExpressionExecutor:l,editableExpressionExecutor:p}=n;a(l)&&l!==i&&(o.get(l).push(i),d(t,l,(()=>new Set)).add(n)),a(p)&&p!==i&&(o.get(p).push(i),d(t,p,(()=>new Set)).add(n))}i.geometryUsed&&d(e,ee,(()=>new Set)).add(i)}return o}async _evaluate(e){const t=new Map,{_dependencyGraph:s,_fieldsAffectedLookup:r,_latestFieldValues:o}=this;for(const r of e)se(r,t,s);for(const[e,{resolver:s,dependencyPromises:i}]of t)Promise.all(i).then((async()=>{const[t,s]=this._makeContext(o);return e.executeAsync(t,s)})).then((()=>{if(r.has(e))for(const t of r.get(e))this._latestFieldValues[t.name]=t.value;s.resolve()}),(t=>{!t||T(t)||re(t)||e.markStale(),s.reject(t)}));const i=(await Promise.allSettled(Array.from(t.values(),(({resolver:e})=>e.promise)))).filter((e=>"rejected"===e.status&&!(T(e.reason)||re(e.reason))));if(i.length>0)throw new AggregateError(i,"One or more expression executions failed")}_makeContext(e){const[t,s]=this._baseContext,r=this.feature.clone();return r.attributes=e,[{...t,$feature:r},s]}};e([m()],te.prototype,"_baseContext",null),e([m()],te.prototype,"feature",null),e([m()],te.prototype,"executors",void 0),e([m()],te.prototype,"inputFields",void 0),e([m()],te.prototype,"arcadeContextInfo",void 0),te=e([y("esri.widgets.FeatureForm.FormExpressionsManager")],te);const se=(e,t,s)=>{if(t.has(e))return;const r=w();t.set(e,{resolver:r,dependencyPromises:[]}),e.abort();const o=s.get(e);for(const e of o)se(e,t,s),t.get(e).dependencyPromises.push(r.promise)},re=e=>e&&"object"==typeof e&&"message"in e&&"Cancelled"===e.message,oe=new t({attributes:{}}),ie=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],ne=["visibilityExpression"],ae="#JSAPI_CONTINGENT_VALUE_ANY_HASH";let le=class extends(r(p(s.EventedAccessor))){constructor(e){super(e),this._expressionExecutorLookup=new Map,this._expressionLookup=new Map,this._expressionsManager=null,this._contingentValuesCache=null,this._featureClone=oe.clone(),this._initialFeature=oe.clone(),this.arcadeEditType="NA",this.contingencyConstraintViolations=new Map,this.inputFields=[],this.messages=null,this.strict=!1,this._isSupportedElement=this._isSupportedElement.bind(this)}initialize(){const e=async()=>{const e=await M("esri/widgets/FeatureForm/t9n/FeatureForm");this.messages=e;for(const t of this.allInputFields)t.messages=e};e();const t=u((()=>[this.layer,!!this.layer?.loaded,this.formTemplate]),(([e,t])=>{a(e)&&(t?this._updateInputFields():e.load().catch((()=>o.getLogger(this.declaredClass).error("Failed to load layer",e.loadError))))}),{equals:([e,t,s],[r,o,i])=>e===r&&t===o&&s===i,initial:!0}),s=u((()=>this._arcadeContextInfo),(e=>{a(this._expressionsManager)&&(this._expressionsManager.arcadeContextInfo=e)})),r=u((()=>this.layer),(e=>{const t="subtype-sublayer"===e?.type?e.parent:"feature"===e?.type?e:null;t&&this.addResolvingPromise(Q.createLoadedLayerContingentValuesCache(t).then((e=>{this._contingentValuesCache=e,this.notifyChange("fieldsWithContingentValues")})))}),{initial:!0});this.handles.add([G(e),t,s,r])}destroy(){this.feature=null,this.layer=null,this._contingentValuesCache=l(this._contingentValuesCache)}get _arcadeContextInfo(){const{_initialFeature:e,arcadeEditType:t,layer:s,spatialReference:r,view:o}=this;return{layer:g(s)?s:null,originalFeature:e,editType:t,spatialReference:r,map:o?.map}}get updating(){return this.updatingHandles.updating}get allInputFields(){return ue(this.inputFields)}get _layerFieldsByName(){return new Map(this.layer?.fields.map((e=>[e.name,e])))}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():oe.clone(),this._initialFeature=this._featureClone.clone(),this._resetInputFieldValues(this._featureClone),this.contingencyConstraintViolations.clear(),a(this._expressionsManager)&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally((()=>this._afterExpressionsEvaluated())))),this._set("feature",e)}get fieldsWithContingentValues(){if(i(this._contingentValuesCache))return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap((e=>e.fields));return new Set(e)}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){void 0===e?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get formDescription(){const{formTemplate:e,layer:t}=this;return!i(e)&&e.description&&t?x(e.description,this.getValues(),t.fieldsIndex):null}get formTitle(){const{formTemplate:e,layer:t}=this;return!i(e)&&e.title&&t?x(e.title,this.getValues(),t.fieldsIndex):null}get joinedContingentValues(){return this._joinContingentValues()}get layer(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){this._override("layer",e)}get spatialReference(){return this.layer?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}get submittable(){return!!this.valid||this.allInputFields.filter((e=>!e.valid)).every((({submittable:e})=>e))}get valid(){const e=this.allInputFields;return e.length>0&&e.every((({valid:e})=>e))}findField(e){return this.allInputFields.find((t=>t.name===e))}getValue(e){const{_featureClone:t,layer:s}=this,r=!!s?.getField(e);return t.getAttribute(e)??(r?null:void 0)}setValue(e,t){const{_featureClone:s,strict:r}=this,o=this.findField(e);t=""===t?null:t,o&&s.getAttribute(e)!==t&&(o.value=t,r&&!o.valid||(this._afterValueChange(o),a(this._expressionsManager)&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([o.name]).finally((()=>this._afterExpressionsEvaluated())))))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this.allInputFields,t=new Set(e.filter((e=>e.valid)).map((({name:e})=>e))),s=e.filter((e=>!e.valid)).map((({name:e})=>e)),r=this.getValues();if(this.validateContingencyConstraints(r,{includeIncompleteViolations:!0}).length>0)for(const[e,r]of this.contingencyConstraintViolations.entries())"error"===r.type&&(t.delete(e),s.push(e));this.emit("submit",{valid:[...t],invalid:s,values:r})}validateContingencyConstraints(e,t){const{_contingentValuesCache:s}=this,r=new Map;if(this.contingencyConstraintViolations=r,i(s))return[];const{invalid:o,incomplete:n}=s.validateContingencyConstraints(e),a=[...o,...t?.includeIncompleteViolations?n:[]];for(const e of a)for(const t of e.fieldGroup.fields)r.set(t,e);return a}notifyFeatureGeometryChanged(){const{_expressionsManager:e,feature:t,_featureClone:s}=this;s.geometry=t.geometry,a(e)&&this.updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally((()=>this._afterExpressionsEvaluated())))}_emitChangeEvent({name:e,valid:t,value:s}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:s,valid:t})}_updateInputFields(){const{_featureClone:e,_initialFeature:t,arcadeEditType:s,formTemplate:r,inputFields:o,messages:i,layer:n}=this,l={arcadeEditType:s,feature:e,initialFeature:t,layer:n,messages:i},p=o.slice(),u=a(r)&&r.elements&&r.elements.length>0?this._updateInputFieldsFromElements(p,r.elements,l):this._updateInputFieldsFromLayerFields(p,n?.fields,l);this.inputFields=u}_updateInputFieldsFromElements(e,t,s){const r=new Map;for(const t of e)if(C(t)){ce(r,t.groupElement,t);for(const e of t.inputFields)ce(r,e.fieldElement,e)}else ce(r,t.fieldElement,t);const o=new Map,i=this._updateInputFieldsRecursive({existingInputFieldsByElement:r,updatedElements:t.filter(this._isSupportedElement),sharedInitializationProperties:s,group:null,newExpressionExecutorPromises:o});this.updatingHandles.addPromise(Promise.all(Array.from(o.values())).then((()=>{const e=Array.from(this._expressionExecutorLookup.values()),t=ue(i);return this._createExpressionsManager(e,t),n(this._expressionsManager).evaluateAll().finally((()=>this._afterExpressionsEvaluated()))})));for(const[e,t]of r.entries())r.delete(e),t.destroy();return i}_updateInputFieldsRecursive(e){const{existingInputFieldsByElement:t,updatedElements:s,sharedInitializationProperties:r,group:o,newExpressionExecutorPromises:i}=e,n=[];for(const e of s){const s=t.has(e),a=s?t.get(e):pe(e)?this._makeInputFieldGroupFromGroupElement(e,r):this._makeInputFieldFromFieldElement(e,r,o);if(n.push(a),s)if(t.delete(e),C(a)){const{feature:e}=r;a.set({feature:e})}else a.set(r);else this._assignExpressionExecutors(a,e,i);if(pe(e)){const s=e.elements.filter((e=>this._isSupportedElement(e)));a.inputFields=this._updateInputFieldsRecursive({existingInputFieldsByElement:t,updatedElements:s,sharedInitializationProperties:r,group:a,newExpressionExecutorPromises:i})}}return n}_updateInputFieldsFromLayerFields(e,t,s){if(!Array.isArray(t))return o.getLogger(this.declaredClass).warn(this.declaredClass,"No attribute fields found."),[];const r=new Map;for(const t of e)if(C(t)){for(const e of t.inputFields)e.destroy();t.inputFields.length=0,t.destroy()}else a(t.fieldElement)?t.destroy():r.set(t.field,t);const i=[],{arcadeEditType:n,feature:l,initialFeature:p,layer:u,messages:c}=s;for(const e of t){const t=r.get(e)??new F({arcadeEditType:n,field:e,feature:l,initialFeature:p,layer:u,messages:c,value:l.getAttribute(e.name)??null});i.push(t),r.delete(e)}for(const[e,t]of r.entries())r.delete(e),t.destroy();return i}_resetInputFieldValues(e){for(const t of this.allInputFields)t.value=e.getAttribute(t.name)}_makeInputFieldFromFieldElement(e,t,s){const{arcadeEditType:r,feature:o,initialFeature:i,layer:n,messages:a}=t;return new F({arcadeEditType:r,fieldElement:e,field:this._layerFieldsByName.get(e.fieldName),value:o.getAttribute(e.fieldName)??null,feature:o,initialFeature:i,layer:n,group:s,messages:a})}_makeInputFieldGroupFromGroupElement(e,t){const{feature:s,initialFeature:r}=t;return new R({groupElement:e,inputFields:[],feature:s,initialFeature:r})}_assignExpressionExecutors(e,t,s){const r=pe(t)?ne:ie;for(const o of r){const r=t[o],{_expressionExecutorLookup:i}=this;if(a(r)&&""!==r){const t=`${o}Executor`,n=this._expressionLookup.get(r)??this._addToExpressionLookup(r);if(i.has(n))e[t]=i.get(n);else if(s.has(n)){const r=s.get(n).then((s=>(e[t]=s,s)));s.set(n,r)}else{const r=X(n,this.layer).then((s=>(e[t]=s,i.set(n,s),s)));s.set(n,r)}}}return[]}_createExpressionsManager(e,t){const{_arcadeContextInfo:s,_featureClone:r}=this;this._expressionsManager=new te({executors:e,feature:r,arcadeContextInfo:s,inputFields:t})}_afterValueChange(e){const{name:t,value:s}=e,{_featureClone:r,formTemplate:o,layer:i}=this;if(!i)return;const n=r.getAttribute(t);r.setAttribute(t,s);const{typeFieldName:l,types:p}=k(i);if(t===l&&s!==n){if("subtype-sublayer"===i.type){const e=i.parent?.findSublayerForFeature(r);r.sourceLayer=this.feature.sourceLayer=e}const e=new Set;for(const t of p)if(t.domains&&"object"==typeof t.domains)for(const s of Object.keys(t.domains))e.add(s);for(const t of e){const e=this.findField(t);e&&e.notifyChange("domain")}}if(a(o)){const{description:e,title:s}=o;s&&c(s,t)&&this.notifyChange("formTitle"),e&&c(e,t)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)}_afterExpressionsEvaluated(){const{_featureClone:e}=this;for(const t of this.allInputFields)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)}_addToExpressionLookup(e){const{_expressionLookup:t,formTemplate:s}=this,r=a(s)&&a(s.expressionInfos)?Object.values(s.expressionInfos).find((t=>t.name===e)):null,o=r?.expression??e;return t.set(e,o),e!==o&&t.set(o,o),o}_isSupportedElement(e){return"field"===e.type||"group"===e.type||(o.getLogger(this.declaredClass).warn("form-info::unsupported-element-type","Only element types 'field' and 'group' are supported",`Element ${e.label} has unsupported type '${e.type}'`),!1)}_joinContingentValues(){const e=this._contingentValuesCache;if(i(e))return[];const{typeFieldName:t}=k(this.layer),s=t?this.getValue(t):null,r=[];for(const t of e.fieldGroups){const{contingencies:e,fields:o,name:i}=t,n=[];for(const t of e)t.isRetired||a(t.subtype)&&t.subtype.code!==s||n.push({values:t.values});n.length>0&&r.push({name:i,fields:o,contingencies:n})}const[o,n]=this._generateJoinPlan(r);return[...o.flatMap((e=>this._joinFieldGroupContingencies(e))),...n.flatMap((e=>e.contingencies))]}_generateJoinPlan(e){const t=new Map,s=[],r=new Set;for(const o of e)for(const e of o.fields)if(t.has(e)){const i=t.get(e),n=o,a=[i.name,n.name].sort().join("|");if(r.has(a))continue;s.push([i,n]),r.add(a),t.set(e,n)}else t.set(e,o);const o=new Set(s.flat()),i=new Set(e);for(const e of o)i.delete(e);const n=new Map,a=new Map;for(const e of new Set(s.flat())){const t=Symbol(e.name);n.set(t,new Set([e])),a.set(e,t)}for(const[e,t]of s){const s=a.get(e),r=a.get(t);if(s===r)continue;const o=n.get(s),i=n.get(r);for(const e of i)o.add(e),a.set(e,s);n.delete(r)}return[[...n.values()].map((e=>[...e])),[...i]]}_joinFieldGroupContingencies(e){const t=e.slice(),s=t.shift();let r=t.shift(),o=this._generateJoinKey(s.fields,r.fields),n=new Set([...s.fields,...r.fields]),l=new Map;for(const e of s.contingencies){const[t]=this._hashContingency(e,o.codedValueFields,!0);l.has(t)?l.get(t)?.push(e):l.set(t,[e])}for(;t.length>0;){const e=new Map,s=t.shift(),a=this._generateJoinKey(n,s.fields);for(const t of r.contingencies){const[s,r]=this._hashContingency(t,o.codedValueFields),n=r?this._findMatchingContingenciesWithAnyHashMask(l,s):l.get(s);if(l.has(ae)&&n?.push(...this._findMatchingContingenciesContainingAny(t,l.get(ae),o.codedValueFields)),!i(n))for(const s of n){const r=o.rangeFields.length>0?this._joinContingenciesWithRangeDomains(s,t,o.rangeFields):this._joinContingencies(s,t);if(i(r))break;const[n]=this._hashContingency(r,a.codedValueFields,!0);e.has(n)?e.get(n)?.push(r):e.set(n,[r])}}l=e,r=s,o=a,n=new Set([...n,...r.fields])}const p=[];for(const e of r.contingencies){const[t,s]=this._hashContingency(e,o.codedValueFields),r=s?this._findMatchingContingenciesWithAnyHashMask(l,t):l.get(t);if(l.has(ae)&&r.push(...this._findMatchingContingenciesContainingAny(e,l.get(ae),o.codedValueFields)),!i(r))for(const t of r){const s=o.rangeFields.length>0?this._joinContingenciesWithRangeDomains(t,e,o.rangeFields):this._joinContingencies(t,e);a(s)&&p.push(s)}}return p}_joinContingencies(e,t){const s={values:{...e.values,...t.values}};for(const[t,r]of Object.entries(s.values))"any"===r.objectType&&a(e.values[t])&&(s.values[t]=e.values[t]);return s}_joinContingenciesWithRangeDomains(e,t,s){const r=this._joinContingencies(e,t);for(const o of s){const s=e.values[o],i=t.values[o],{leftIsNull:n,rightIsNull:a,bothAreNull:l,leftIsAny:p,rightIsAny:u,bothAreAny:c,leftIsRange:m,rightIsRange:d}=this._compareObjectTypes(s.objectType,i.objectType);if(l||c)continue;if(n&&u||a&&p){r.values[o]=new U({objectType:"null"});continue}if(n&&d||a&&m)return null;p?(s.minValue=-1/0,s.maxValue=1/0):u&&(i.minValue=-1/0,i.maxValue=1/0);const y=Math.max(s.minValue,i.minValue),h=Math.min(s.maxValue,i.maxValue);if(y>h)return null;r.values[o]=new U({objectType:"range",minValue:y,maxValue:h})}return r}_findMatchingContingenciesContainingAny(e,t,s){return t.filter((t=>s.every((s=>{const r=t.values[s],o=e.values[s];return"any"===r.objectType||"any"===o.objectType||r.codedValue?.code===o.codedValue?.code}))))}_findMatchingContingenciesWithAnyHashMask(e,t){const s=RegExp(`${t}$`),r=[];for(const[t,o]of e){if(t===ae)break;s.test(t)&&r.push(...o)}return r}_generateJoinKey(e,t){const s=Array.isArray(e)?new Set(e):e,r=Array.isArray(t)?new Set(t):t,o=s.size<r.size?s:r,n=o===s?r:s,a=new Set,l=new Set;for(const e of o)if(n.has(e)){const t=this.layer?.getFieldDomain(e,{feature:this.feature});if(i(t))continue;switch(t.type){case"coded-value":a.add(e);break;case"range":l.add(e)}}return{codedValueFields:[...a],rangeFields:[...l]}}_hashContingency(e,t,s=!1){if(t.length<1)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",!1];const r=[];let o=!1;for(const i of t){const t=e.values[i];if("any"===t.objectType){if(s)return[ae,!0];o=!0,r.push(`${i}:.*`)}else"null"===t.objectType?r.push(`${i}:#JSAPI_CONTINGENT_VALUE_NULL_HASH`):r.push(`${i}:${t.codedValue?.code}`)}return[r.sort().join("&"),o]}_compareObjectTypes(e,t){return{leftIsNull:"null"===e,rightIsNull:"null"===t,bothAreNull:"null"===e&&"null"===t,leftIsAny:"any"===e,rightIsAny:"any"===t,bothAreAny:"any"===e&&"any"===t,leftIsRange:"range"===e,rightIsRange:"range"===t}}};e([m()],le.prototype,"_featureClone",void 0),e([m()],le.prototype,"_arcadeContextInfo",null),e([m()],le.prototype,"updating",null),e([m({readOnly:!0})],le.prototype,"allInputFields",null),e([m()],le.prototype,"_layerFieldsByName",null),e([m()],le.prototype,"arcadeEditType",void 0),e([m()],le.prototype,"contingencyConstraintViolations",void 0),e([m()],le.prototype,"feature",null),e([m()],le.prototype,"fieldsWithContingentValues",null),e([m({type:h})],le.prototype,"formTemplate",null),e([m()],le.prototype,"formDescription",null),e([m()],le.prototype,"formTitle",null),e([m()],le.prototype,"inputFields",void 0),e([m()],le.prototype,"joinedContingentValues",null),e([m()],le.prototype,"layer",null),e([m()],le.prototype,"messages",void 0),e([m()],le.prototype,"spatialReference",null),e([m()],le.prototype,"state",null),e([m()],le.prototype,"strict",void 0),e([m()],le.prototype,"submittable",null),e([m()],le.prototype,"valid",null),e([m()],le.prototype,"view",void 0),e([m()],le.prototype,"getValues",null),e([m()],le.prototype,"submit",null),le=e([y("esri.widgets.FeatureForm.FeatureFormViewModel")],le);const pe=e=>"group"===e.type,ue=e=>e.reduce(((e,t)=>C(t)?[...e,...t.inputFields]:[...e,t]),[]),ce=(e,t,s)=>{a(t)&&e.set(t,s)},me=le;export{me as default};
