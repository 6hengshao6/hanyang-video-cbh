/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{substitute as t}from"../../intl.js";import i from"../../core/Accessor.js";import{HandleOwnerMixin as r}from"../../core/HandleOwner.js";import{i as s,u as o,a as n,j as l}from"../../chunks/maybe.js";import{g as a}from"../../chunks/watch.js";import{property as u}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import"../../chunks/typedArrayUtil.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import d,{C as m}from"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import{isNumericField as c,isStringField as h,isDateField as y,TypeValidationError as E,v as g,validateFieldValue as f,getFeatureEditFields as v,getFeatureGeometryFields as j,D as x,NumericRangeValidationError as b,g as _,getFieldRange as k}from"../../layers/support/fieldUtils.js";import{c as V}from"../../chunks/layerUtils.js";import{t as O,r as T}from"../../chunks/string.js";import"../../chunks/number.js";import"../../chunks/jsonMap.js";import"../../chunks/object.js";import"../../core/lang.js";import"../../chunks/locale.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/messages.js";import"../../core/Error.js";import"../../core/promiseUtils.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../chunks/tracking.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/WatchUpdatingTracking.js";import"../../core/reactiveUtils.js";import"../../chunks/enumeration.js";import"../../core/JSONSupport.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/unitUtils.js";import"../../chunks/Ellipsoid.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/aaBoundingRect.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/common.js";import"../../chunks/vec4.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";const U=e=>!!e.inputFields,F=(e,t)=>s(e)&&e.input?.type===t,D={typeFieldName:null,types:[]};function N(e,t,i){const r=Object.keys(t).filter((t=>O(e,t))),o=r.map((e=>t[e])),n=r.map((e=>i.get(e))).filter(s);return function(e,t){return T(T(e,(e=>`{${e.toLowerCase()}}`)),Object.fromEntries(Object.entries(t).map((([e,t])=>[e.toLowerCase(),t]))))}(e,function(e,t){const i=t.map(((t,i)=>{let r=e[i];if(t.domain&&"coded-value"===t.domain.type){const e=t.domain.codedValues.find((e=>e.code===r));e?.name&&(r=e.name)}return[t.name,r]}));return Object.fromEntries(i)}(o,n))}const A=e=>e?"subtype-sublayer"===e.type?{typeFieldName:e.parent?.subtypeField,types:e.parent?.subtypes??[]}:"types"in e&&e.types?{typeFieldName:e.typeIdField,types:e.types.map((({id:e,name:t,domains:i})=>({code:e,name:t,domains:i})))}:D:D;var w,L;!function(e){e.Text="text",e.Number="number",e.Date="date",e.Unsupported="unsupported"}(w||(w={})),function(e){e.TOO_SHORT="length-validation-error::too-short"}(L||(L={}));const q={type:"number"},I={type:"number",intlOptions:{notation:"scientific"}},S={type:"date",intlOptions:{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}};function R(e){return e>=1e7||e<=-1e7}let C=class extends(r(i)){constructor(e){super(e),this._storedValue=null,this.arcadeEditType="NA",this.editableExpressionExecutor=null,this.id=a().toString(),this.requiredExpressionExecutor=null,this.valueExpressionExecutor=null,this.visibilityExpressionExecutor=null,this.feature=null,this.field=null,this.fieldElement=null,this.layer=null,this.error=null,this.group=null,this.messages=null}get _configAllowsEdits(){const{fieldElement:e,layer:t,name:i}=this;if(s(e))return e.editableExpression?!!this.evaluatedEditableExpression:!1!==e.editable;if(t?.userHasUpdateItemPrivileges)return!0;const r=t&&"popupTemplate"in t?t?.popupTemplate?.fieldInfos?.find((({fieldName:e})=>e===i)):null;return r?.isEditable??!0}get _layerFieldAllowsEdits(){const{field:e,layer:t}=this;if(!t||!e)return!1;const i=V(t),r=i?.operations.supportsEditing,s=e.editable,o=P(i,this.arcadeEditType);return!!(r&&s&&o)}get isUsingValueExpression(){return this._shouldUseValueExpression()}get evaluatedEditableExpression(){const{editableExpressionExecutor:e}=this;return s(e)?!!e.lastEvaluatedValue:null}get evaluatedRequiredExpression(){const{requiredExpressionExecutor:e}=this;return s(e)?!!e.lastEvaluatedValue:null}get evaluatedVisibilityExpression(){const{visibilityExpressionExecutor:e}=this;return s(e)?!!e.lastEvaluatedValue:null}get evaluatedValueExpression(){const{valueExpressionExecutor:e}=this;return s(e)?e.lastEvaluatedValue:null}set initialFeature(e){this._set("initialFeature",e),this.notifyChange("valid")}get description(){return o(this.fieldElement)?.description}get domain(){const{layer:e}=this,{typeFieldName:t,types:i}=A(e);if(t===this.name&&n(this.field.domain))return new d({name:"__internal-type-based-coded-value-domain__",codedValues:i.map((({code:e,name:t})=>new m({code:e,name:t})))});const{feature:r}=this,o=e?.getFieldDomain(this.name,{feature:r}),a=l(this.fieldElement,"domain");return s(a)&&this._isDomainCompatible(a)?a:o}get editable(){return!!this._layerFieldAllowsEdits&&(this.evaluatedEditableExpression??this._configAllowsEdits)}get inputType(){return o(this.fieldElement)?.input?.type}get errorMessage(){return this._toErrorMessage()}get hint(){return o(this.fieldElement)?.hint}get includeTime(){const{fieldElement:e}=this,t=s(e)&&"datetime-picker"===e.input?.type?e.input.includeTime:void 0;return void 0===t||t}get label(){return s(this.fieldElement)&&this.fieldElement.label||this.field.alias||this.field.name}get maxLength(){if(this.type===w.Date)return-1;const{field:e,fieldElement:t}=this,i=e?.length,r=M(t)?t.input.maxLength:NaN;return null!=r&&!isNaN(r)&&r>=-1&&(-1===i||r<=i)?r:i}get minLength(){if(this.type===w.Date)return-1;const{field:e,fieldElement:t}=this,i=e?.length,r=M(t)?t.input.minLength:NaN;return null!=r&&!isNaN(r)&&r>=-1&&(-1===i||r<=i)?r:-1}get name(){return this.field?.name}get required(){const{editable:e,evaluatedRequiredExpression:t,field:i,visible:r}=this;return!!e&&(!1===i?.nullable||!(!r||!s(t))&&t)}set required(e){this._overrideIfSome("required",e)}get submittable(){const{field:e,required:t,valid:i,value:r}=this;return!(t&&n(r)||!i&&this.initialFeature.getAttribute(e.name)!==r)}get type(){const{field:e}=this;return c(e)?w.Number:h(e)?w.Text:y(e)?w.Date:w.Unsupported}get updating(){const{editableExpressionExecutor:e,valueExpressionExecutor:t}=this;return s(t)&&t.updating||s(e)&&e.updating}get valid(){const e=this.editable?this._validate():null;return this._set("error",e),null===e}get value(){if(this._shouldUseValueExpression()){const e=this.evaluatedValueExpression;if(this.type===w.Date){if(e instanceof Date)return e.getTime();if("number"!=typeof e)return parseInt(e,10)}return s(e)&&"object"==typeof e?e.toString():e}return this.get("_storedValue")}set value(e){this.notifyChange("evaluatedVisibilityExpression"),this.set("_storedValue",e)}get visible(){return!this._isEditorField()&&(s(this.evaluatedVisibilityExpression)?this.evaluatedVisibilityExpression:!!s(this.fieldElement)||this._isVisibleByDefault())}_isDomainCompatible(e){const{field:t}=this;if("coded-value"===e?.type){const i=typeof e.codedValues[0].code;if("string"===i&&h(t)||"number"===i&&c(t))return!0}return!!("range"===e?.type&&c(t)||y(t))}_validate(){const{domain:e,field:t,initialFeature:i,minLength:r,required:s,type:o,valid:n,value:l}=this,a=s&&null===l,u=void 0!==n;return!a&&i.getAttribute(t.name)===l&&u?null:a?E.INVALID_TYPE:"text"===o&&r>-1&&"string"==typeof l&&l.length<r?L.TOO_SHORT:e?null!==l||s?g(e,l):null:f(t,l)}_isVisibleByDefault(){const e=this.field?.type;return this.field?.visible&&"oid"!==e&&"global-id"!==e&&!this._isGeometryField()}_isEditorField(){return v(this.layer).includes(this.name)}_isGeometryField(){return j(this.layer).includes(this.name)}_shouldUseValueExpression(){return this._layerFieldAllowsEdits&&!this._configAllowsEdits&&s(this.valueExpressionExecutor)}_toErrorMessage(){const{domain:e,field:i,messages:r,minLength:s,value:o,required:n,type:l}=this,a=this.error;if(!r)return null;if(n&&null===o)return r.validationErrors.cannotBeNull;if(a===x.VALUE_OUT_OF_RANGE||a===b.OUT_OF_RANGE){const s=_(e)||k(i);return t(r.validationErrors.outsideRange,s,{format:{max:"date"===l?S:R(s.max)?I:q,min:"date"===l?S:R(s.min)?I:q}})}return a===x.INVALID_CODED_VALUE?r.validationErrors.invalidCodedValue:a===E.INVALID_TYPE?r.validationErrors.invalidType:a===L.TOO_SHORT?t(r.validationErrors.tooShort,{min:s}):null}};e([u()],C.prototype,"_storedValue",void 0),e([u()],C.prototype,"_configAllowsEdits",null),e([u()],C.prototype,"_layerFieldAllowsEdits",null),e([u()],C.prototype,"arcadeEditType",void 0),e([u()],C.prototype,"editableExpressionExecutor",void 0),e([u()],C.prototype,"requiredExpressionExecutor",void 0),e([u()],C.prototype,"valueExpressionExecutor",void 0),e([u()],C.prototype,"isUsingValueExpression",null),e([u()],C.prototype,"visibilityExpressionExecutor",void 0),e([u()],C.prototype,"evaluatedEditableExpression",null),e([u()],C.prototype,"evaluatedRequiredExpression",null),e([u()],C.prototype,"evaluatedVisibilityExpression",null),e([u()],C.prototype,"evaluatedValueExpression",null),e([u()],C.prototype,"feature",void 0),e([u()],C.prototype,"field",void 0),e([u({constructOnly:!0})],C.prototype,"fieldElement",void 0),e([u()],C.prototype,"initialFeature",null),e([u()],C.prototype,"layer",void 0),e([u({readOnly:!0})],C.prototype,"description",null),e([u()],C.prototype,"domain",null),e([u()],C.prototype,"editable",null),e([u({readOnly:!0})],C.prototype,"inputType",null),e([u({readOnly:!0})],C.prototype,"error",void 0),e([u({dependsOn:["error","messages","value"]})],C.prototype,"errorMessage",null),e([u()],C.prototype,"group",void 0),e([u({readOnly:!0})],C.prototype,"hint",null),e([u()],C.prototype,"includeTime",null),e([u()],C.prototype,"label",null),e([u()],C.prototype,"maxLength",null),e([u()],C.prototype,"minLength",null),e([u()],C.prototype,"messages",void 0),e([u({readOnly:!0})],C.prototype,"name",null),e([u()],C.prototype,"required",null),e([u()],C.prototype,"submittable",null),e([u()],C.prototype,"type",null),e([u()],C.prototype,"updating",null),e([u()],C.prototype,"valid",null),e([u({value:null})],C.prototype,"value",null),e([u()],C.prototype,"visible",null),C=e([p("esri.widgets.FeatureForm.InputField")],C);const P=(e,t)=>{if(!e)return!0;const{operations:i}=e;switch(t){case"INSERT":return i.supportsAdd;case"UPDATE":case"DELETE":return i.supportsUpdate;default:return!0}},M=e=>s(e)&&(F(e,"text-box")||F(e,"text-area")),H=C;export{F as a,H as default,A as g,U as i,N as p};
