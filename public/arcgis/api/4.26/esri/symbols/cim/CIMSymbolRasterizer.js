// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../Color ../../request ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ./cimAnalyzer ./CIMResourceManager ./CIMSymbolDrawHelper ./CIMSymbolHelper ./Rasterizer ./TextRasterizer ./utils ../support/cimSymbolUtils ../support/Symbol3DAnchorPosition2D".split(" "),function(B,P,Q,R,C,S,v,E,T,F,D,U,V,r,W,X){B.GeometryStyle=void 0;(function(A){A.Legend="legend";A.Preview="preview"})(B.GeometryStyle||(B.GeometryStyle={}));const Y=96/72;
let Z=function(){function A(a,b){this._spatialReference=a;this._avoidSDF=b;this._resourceCache=new Map;this._imageDataCanvas=null;this._pictureMarkerCache=new Map;this._textRasterizer=new V;this._cimResourceManager=new T;this._rasterizer=new U(this._cimResourceManager)}var w=A.prototype;w.rasterizeCIMSymbolAsync=async function(a,b,e,c,d,g,m,f){if(!a)return null;var {data:h}=a;if(!h||"CIMSymbolReference"!==h.type||!h.symbol)return null;({symbol:a}=h);g||(g=r.mapCIMSymbolToGeometryType(a));b=await D.OverrideHelper.resolveSymbolOverrides(h,
b,this._spatialReference,d,g,m,f);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));d=this._imageDataCanvas;m=this._cimResourceManager;f=[];D.CIMSymbolHelper.fetchResources(b,m,f);0<f.length&&await Promise.all(f);const {width:l,height:n}=e;a:{e=-l/2+1;f=l/2-1;h=n/2-1;var q=-n/2+1;switch(g){case "esriGeometryPoint":g={x:0,y:0};break a;case "esriGeometryPolyline":g={paths:[[[e,0],[0,0],[f,0]]]};break a;default:g="legend"===c?{rings:[[[e,h],[f,0],[f,q],[e,q],[e,h]]]}:{rings:[[[e,
h],[f,h],[f,q],[e,q],[e,h]]]}}}var k=D.CIMSymbolHelper.getEnvelope(b,g,m);if(!k)return null;e=(window.devicePixelRatio||1)*Y;h=1;q=f=0;switch(a.type){case "CIMPointSymbol":case "CIMTextSymbol":a=1;k.width>l&&(a=l/k.width);f=1;k.height>n&&(f=n/k.height);"preview"===c&&(k.width<l&&(a=l/k.width),k.height<n&&(f=n/k.height));h=Math.min(a,f);f=k.x+k.width/2;q=k.y+k.height/2;break;case "CIMLineSymbol":c=1;k.height>n&&(c=n/k.height);h=c;q=k.y+k.height/2;c=k.x*h+l/2;a=(k.x+k.width)*h+l/2;0>c&&({paths:k}=g,
k[0][0][0]-=c);a>l&&({paths:c}=g,c[0][2][0]-=a-l);break;case "CIMPolygonSymbol":f=k.x+k.width/2;q=k.y+k.height/2;c=k.x*h+l/2;a=(k.x+k.width)*h+l/2;const t=k.y*h+n/2;k=(k.y+k.height)*h+n/2;const {rings:p}=g;0>c&&(p[0][0][0]-=c,p[0][3][0]-=c,p[0][4][0]-=c);0>t&&(p[0][0][1]+=t,p[0][1][1]+=t,p[0][4][1]+=t);a>l&&(p[0][1][0]-=a-l,p[0][2][0]-=a-l);k>n&&(p[0][2][1]+=k-n,p[0][3][1]+=k-n)}d.width=l*e;d.height=n*e;d.width+=2;d.height+=2;c=d.getContext("2d");a=F.Transformation.createIdentity();a.translate(-f,
-q);a.scale(h*e,-h*e);a.translate(l*e/2+1,n*e/2+1);c.clearRect(0,0,d.width,d.height);(new F.CanvasDrawHelper(c,m,a,!0)).drawSymbol(b,g);return c.getImageData(0,0,d.width,d.height)};w.analyzeCIMSymbol=async function(a,b,e,c,d){const g=[];await E.analyzeCIMSymbol(a.data,b?{geometryType:c,spatialReference:this._spatialReference,fields:b}:null,this._cimResourceManager,g,this._avoidSDF);S.throwIfAborted(d);let m;for(const f of g){if("CIMPictureMarker"===f.cim.type||"CIMPictureFill"===f.cim.type||"CIMPictureStroke"===
f.cim.type)m||(m=[]),m.push(this._fetchPictureMarkerResource(f,d));e&&"text"===f.type&&"string"===typeof f.text&&f.text.includes("[")&&(f.text=r.createLabelOverrideFunction(e,f.text,f.cim.textCase))}m&&await Promise.all(m);return g};w.rasterizeCIMSymbol3D=function(a,b,e,c,d,g){const m=[];for(const h of a){c&&"function"===typeof c.scaleFactor&&(c.scaleFactor=c.scaleFactor(b,d,g));a=this._getRasterizedResource(h,b,e,c,d,g);if(!a)continue;let l=0,n=a.anchorX||0,q=a.anchorY||0,k=!1,t=0;var f=0;if("esriGeometryPoint"===
e)if(f=c&&c.scaleFactor?c.scaleFactor:1,t=r.evaluateValueOrFunction(h.offsetX,b,d,g)*f||0,f=r.evaluateValueOrFunction(h.offsetY,b,d,g)*f||0,"marker"===h.type)l=r.evaluateValueOrFunction(h.rotation,b,d,g)||0,k=h.rotateClockwise??!1;else if("text"===h.type){l=r.evaluateValueOrFunction(h.angle,b,d,g)||0;if(void 0!==h.horizontalAlignment)switch(h.horizontalAlignment){case "left":n=-.5;break;case "right":n=.5;break;default:n=0}if(void 0!==h.verticalAlignment)switch(h.verticalAlignment){case "top":q=.5;
break;case "bottom":q=-.5;break;case "baseline":q=-.25;break;default:q=0}}null!=a&&m.push({angle:l,rotateClockWise:k,anchorX:n,anchorY:q,offsetX:t,offsetY:f,rasterizedResource:a})}return this.getSymbolImage(m)};w.getSymbolImage=function(a){const b=document.createElement("canvas"),e=C.unwrapOrThrow(b.getContext("2d"));var c=0,d=0,g=0,m=0,f=[];for(var h=0;h<a.length;h++){var l=a[h],n=l.rasterizedResource;if(!n)continue;var q=n.size,k=l.offsetX;const G=l.offsetY,H=l.anchorX,I=l.anchorY,J=l.rotateClockWise||
!1;l=l.angle;var t=v.pt2px(k)-q[0]*(.5+H);let x=v.pt2px(G)-q[1]*(.5+I),z=t+q[0];var p=x+q[1];if(l){J&&(l=-l);var u=Math.sin(l*Math.PI/180);const y=Math.cos(l*Math.PI/180);q=t*y-x*u;const K=t*u+x*y,L=t*y-p*u,M=t*u+p*y,N=z*y-p*u;p=z*u+p*y;const O=z*y-x*u;u=z*u+x*y;t=Math.min(q,L,N,O);x=Math.min(K,M,p,u);z=Math.max(q,L,N,O);p=Math.max(K,M,p,u)}c=t<c?t:c;d=x<d?x:d;g=z>g?z:g;m=p>m?p:m;t=e.createImageData(n.size[0],n.size[1]);t.data.set(new Uint8ClampedArray(n.image.buffer));f.push({offsetX:k,offsetY:G,
rotateClockwise:J,angle:l,rasterizedImage:t,anchorX:H,anchorY:I})}b.width=g-c;b.height=m-d;a=-c;for(c=0;c<f.length;c++)d=f[c],g=this._imageDataToCanvas(d.rasterizedImage),h=a-d.rasterizedImage.width*(.5+d.anchorX),n=m-d.rasterizedImage.height*(.5-d.anchorY),d.angle?(k=(360-d.angle)*Math.PI/180,e.save(),e.translate(v.pt2px(d.offsetX),-v.pt2px(d.offsetY)),e.translate(a,m),e.rotate(k),e.translate(-a,-m),e.drawImage(g,h,n),e.restore()):e.drawImage(g,h+v.pt2px(d.offsetX),n-v.pt2px(d.offsetY));f=new X.Symbol3DAnchorPosition2D({x:a/
b.width-.5,y:m/b.height-.5});return{imageData:0!==b.width&&0!==b.height?e.getImageData(0,0,b.width,b.height):e.createImageData(1,1),anchorPosition:f}};w._fetchPictureMarkerResource=async function(a,b){const e=a.materialHash;this._pictureMarkerCache.get(e)||(a=(await R(a.cim.url,{responseType:"image",signal:b&&b.signal})).data,this._pictureMarkerCache.set(e,a))};w._imageDataToCanvas=function(a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const b=this._imageDataCanvas,
e=C.unwrapOrThrow(b.getContext("2d"));b.width=a.width;b.height=a.height;e.putImageData(a,0,0);return b};w._imageTo32Array=function(a,b,e,c){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const d=this._imageDataCanvas,g=C.unwrapOrThrow(d.getContext("2d"));d.width=b;d.height=e;g.drawImage(a,0,0,b,e);c&&(g.save(),c=new Q(c),g.fillStyle=c.toHex(),g.globalCompositeOperation="multiply",g.fillRect(0,0,b,e),g.globalCompositeOperation="destination-atop",g.drawImage(a,0,0,b,
e),g.restore());return new Uint32Array(g.getImageData(0,0,b,e).data.buffer)};w._getRasterizedResource=function(a,b,e,c,d,g){if("text"===a.type)return this._rasterizeTextResource(a,b,c,d,g);if("function"===typeof a.materialHash){var m=a.materialHash;m=m(b,d,g);var f=E.analyzeCIMResource(a.cim,a.materialOverrides)}else m=a.materialHash,f=a.cim;({analyzedCIM:f,hash:m}={analyzedCIM:f,hash:m});const h=c&&c.scaleFactor?c.scaleFactor:1;if("CIMPictureMarker"===a.cim.type){e=r.evaluateValueOrFunction(a.size,
b,d,g)*h;const {image:l,width:n,height:q}=C.unwrapOrThrow(this._getPictureResource(a,e,r.evaluateValueOrFunction(a.color,b,d,g)));return a={image:l,size:[n,q],sdf:!1,simplePattern:!1,anchorX:a.anchorPoint?a.anchorPoint.x:0,anchorY:a.anchorPoint?a.anchorPoint.y:0}}W.scaleCIMMarker(f,h,{preserveOutlineWidth:!1});b=f;m+=e;c&&(m+=JSON.stringify(c));e=this._resourceCache;if(e.has(m))return e.get(m);a=this._rasterizer.rasterizeJSONResource({cim:b,type:a.type,url:a.url,mosaicHash:m,size:null,path:null},
window.devicePixelRatio||1,this._avoidSDF);e.set(m,a);return a};w._rasterizeTextResource=function(a,b,e,c,d){var g=e&&e.scaleFactor?e.scaleFactor:1;e=r.evaluateValueOrFunction(a.text,b,c,d);if(!e||0===e.length)return null;const m=r.evaluateValueOrFunction(a.fontName,b,c,d),f=r.evaluateValueOrFunction(a.style,b,c,d),h=r.evaluateValueOrFunction(a.weight,b,c,d),l=r.evaluateValueOrFunction(a.decoration,b,c,d);g*=r.evaluateValueOrFunction(a.size,b,c,d);const n=r.evaluateValueOrFunction(a.horizontalAlignment,
b,c,d),q=r.evaluateValueOrFunction(a.verticalAlignment,b,c,d),k=r.colorToArray(r.evaluateValueOrFunction(a.color,b,c,d)),t=r.colorToArray(r.evaluateValueOrFunction(a.outlineColor,b,c,d));a=r.evaluateValueOrFunction(a.outlineSize,b,c,d);return this._textRasterizer.rasterizeText(e,{color:k,size:g,horizontalAlignment:n,verticalAlignment:q,font:{family:m,style:f,weight:h,decoration:l},halo:{size:a||0,color:t,style:f},pixelRatio:1,premultiplyColors:!this._avoidSDF})};w._getPictureResource=function(a,b,
e){a=this._pictureMarkerCache.get(a.materialHash);if(!a)return null;const c=a.height/a.width,d=b?1<c?v.pt2px(b):v.pt2px(b)/c:a.width;b=b?1<c?v.pt2px(b)*c:v.pt2px(b):a.height;return{image:this._imageTo32Array(a,d,b,e),width:d,height:b}};P._createClass(A,[{key:"resourceManager",get:function(){return this._cimResourceManager}}]);return A}();B.CIMSymbolRasterizer=Z;Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});