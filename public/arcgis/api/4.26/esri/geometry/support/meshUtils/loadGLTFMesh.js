// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../Color ../../../request ../../../core/MapUtils ../../../core/mathUtils ../../../core/maybe ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../MeshComponent ../MeshMaterialMetallicRoughness ../MeshTexture ../MeshVertexAttributes ../buffer/BufferView ../../../chunks/vec32 ../../../chunks/vec42 ../buffer/utils ./georeference ../../../views/3d/glTF/DefaultLoadingContext ../../../views/3d/glTF/loader ../../../views/3d/glTF/internal/indexUtils ../../../views/3d/glTF/internal/resourceUtils ../../../views/3d/webgl-engine/materials/DefaultMaterial_COLOR_GAMMA ../../../views/webgl/enums ../../../chunks/vec33 ../../../chunks/vec43 ../../../chunks/vec22".split(" "),
function(F,G,O,H,I,e,J,K,P,Q,R,S,T,U,m,y,B,z,V,W,X,Y,Z,aa,D,L,C,M){function ba(a){const b=a?.resolveFile;return b?{busy:!1,request:async(h,c,f)=>{h=b(h);return(await O(h,{responseType:"image"===c?"image":"binary"===c?"array-buffer":"json",signal:e.isSome(f)?f.signal:null})).data}}:null}function A(a,b){if(e.isNone(a))return"-";a=a.typedBuffer;return`${H.getOrCreateMapValue(b,a.buffer,()=>b.size)}/${a.byteOffset}/${a.byteLength}`}function ca(a){return e.isSome(a)?a.toString():"-"}function da(a){let b=
0;var h=!1,c=!1,f=!1,d=!1;const g=new Map,v=new Map,n=[];for(const k of a.parts){const {attributes:{position:u,normal:w,color:l,tangent:q,texCoord0:t}}=k;a=`\n      ${A(u,g)}/\n      ${A(w,g)}/\n      ${A(l,g)}/\n      ${A(q,g)}/\n      ${A(t,g)}/\n      ${ca(k.transform)}\n    `;let p=!1;a=H.getOrCreateMapValue(v,a,()=>{p=!0;return{start:b,length:u.count}});p&&(b+=u.count);w&&(f=!0);l&&(h=!0);q&&(c=!0);t&&(d=!0);n.push({gltf:k,writeVertices:p,region:a})}return{vertexAttributes:{position:z.createBuffer(m.BufferViewVec3f64,
b),normal:f?z.createBuffer(m.BufferViewVec3f,b):null,tangent:c?z.createBuffer(m.BufferViewVec4f,b):null,color:h?z.createBuffer(m.BufferViewVec4u8,b):null,texCoord0:d?z.createBuffer(m.BufferViewVec2f,b):null},parts:n,components:[]}}function ea(a,b){const h=new G(fa(a.color,a.opacity)),c=a.emissiveFactor?new G(ha(a.emissiveFactor)):null;var f=e.unwrap(e.applySome(a.textureColor,k=>b.get(k))),d=e.unwrap(e.applySome(a.textureNormal,k=>b.get(k))),g=e.unwrap(e.applySome(a.textureEmissive,k=>b.get(k))),
v=e.unwrap(e.applySome(a.textureOcclusion,k=>b.get(k)));a:{switch(a.alphaMode){case "OPAQUE":var n="opaque";break a;case "MASK":n="mask";break a;case "BLEND":n="blend";break a}n=void 0}return new S({color:h,colorTexture:f,normalTexture:d,emissiveColor:c,emissiveTexture:g,occlusionTexture:v,alphaMode:n,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,metallic:a.metallicFactor,roughness:a.roughnessFactor,metallicRoughnessTexture:e.unwrap(e.applySome(a.textureMetallicRoughness,k=>b.get(k))),colorTextureTransform:a.colorTextureTransform,
normalTextureTransform:a.normalTextureTransform,occlusionTextureTransform:a.occlusionTextureTransform,emissiveTextureTransform:a.emissiveTextureTransform,metallicRoughnessTextureTransform:a.metallicRoughnessTextureTransform})}function ia(a,b,h){if(b.writeVertices){const {position:w,normal:l,tangent:q,color:t,texCoord0:p}=a.vertexAttributes;var c=b.region.start;const {attributes:r,transform:E}=b.gltf;var f=r.position.count;y.transformMat4View(w.slice(c,f),r.position,E);if(e.isSome(r.normal)&&e.isSome(l)){var d=
J.normalFromMat4(K.create(),E),g=l.slice(c,f);y.transformMat3View(g,r.normal,d);I.hasScaling(d)&&y.normalizeView(g,g)}else e.isSome(l)&&L.fill(l,0,0,1,{dstIndex:c,count:f});e.isSome(r.tangent)&&e.isSome(q)?(d=J.normalFromMat4(K.create(),E),g=q.slice(c,f),B.transformMat3View(g,r.tangent,d),I.hasScaling(d)&&B.normalize(g,g)):e.isSome(q)&&C.fill(q,0,0,1,1,{dstIndex:c,count:f});e.isSome(r.texCoord0)&&e.isSome(p)?M.normalizeIntegerBufferView(p.slice(c,f),r.texCoord0):e.isSome(p)&&M.fill(p,0,0,{dstIndex:c,
count:f});e.isSome(r.color)&&e.isSome(t)?(d=r.color,c=t.slice(c,f),4===d.elementCount?d instanceof m.BufferViewVec4f?B.scaleView(c,d,255):d instanceof m.BufferViewVec4u8?C.copyView(c,d):d instanceof m.BufferViewVec4u16&&B.scaleView(c,d,1/256):(C.fill(c,255,255,255,255),c=m.BufferViewVec3u8.fromTypedArray(c.typedBuffer,c.typedBufferStride),d instanceof m.BufferViewVec3f?y.scaleView(c,d,255):d instanceof m.BufferViewVec3u8?L.copyView(c,d):d instanceof m.BufferViewVec3u16&&y.scaleView(c,d,1/256))):e.isSome(t)&&
C.fill(t.slice(c,f),255,255,255,255)}const {indices:v,attributes:n,primitiveType:k,material:u}=b.gltf;c=Y.convertPrimitiveToTriangles(v||n.position.count,k);if(b=b.region.start){f=c.slice();for(d=0;d<c.length;d++)f[d]+=b;c=f}a.components.push(new R({faces:c,material:h.get(u),trustSourceNormals:!0}))}function N(a){switch(a){case D.TextureWrapMode.CLAMP_TO_EDGE:return"clamp";case D.TextureWrapMode.MIRRORED_REPEAT:return"mirror";case D.TextureWrapMode.REPEAT:return"repeat"}}function x(a){return 255*
a**(1/aa.COLOR_GAMMA)}function fa(a,b){return Q.fromValues(x(a[0]),x(a[1]),x(a[2]),b)}function ha(a){return P.fromValues(x(a[0]),x(a[1]),x(a[2]))}F.loadGLTFMesh=async function(a,b,h){var c=new W.DefaultLoadingContext(ba(h));b=(await X.loadGLTF(c,b,h,!0)).model;c=b.lods.shift();const f=new Map,d=new Map;b.textures.forEach((l,q)=>{var t=f.set;var p=(Z.isEncodedMeshTexture(l.data),l.data);l=l.parameters.wrap;l={horizontal:N(l.s),vertical:N(l.t)};p=new T({data:p,wrap:l});return t.call(f,q,p)});b.materials.forEach((l,
q)=>d.set(q,ea(l,f)));b=da(c);for(var g of b.parts)ia(b,g,d);const {position:v,normal:n,tangent:k,color:u,texCoord0:w}=b.vertexAttributes;g={position:v.typedBuffer,normal:e.isSome(n)?n.typedBuffer:null,tangent:e.isSome(k)?k.typedBuffer:null,uv:e.isSome(w)?w.typedBuffer:null,color:e.isSome(u)?u.typedBuffer:null};h=V.georeferenceByTransform(g,a,h);return{transform:h.transform,components:b.components,spatialReference:a.spatialReference,vertexAttributes:new U.MeshVertexAttributes({position:h.vertexAttributes.position,
normal:h.vertexAttributes.normal,tangent:h.vertexAttributes.tangent,color:g.color,uv:g.uv})}};Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});