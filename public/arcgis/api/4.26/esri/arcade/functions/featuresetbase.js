// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../ArcadeDate ../ArcadePortal ../Dictionary ../executionError ../Feature ../featureSetCollection ../featureSetUtils ../ImmutableArray ../../chunks/languageUtils ../portalUtils ../featureset/actions/Adapted ../featureset/actions/AttributeFilter ../featureset/actions/OrderBy ../featureset/actions/Top ../featureset/sources/Empty ../featureset/sources/FeatureLayerMemory ../featureset/support/OrderbyClause ../featureset/support/shared ../featureset/support/sqlUtils ./fieldStats ../../core/promiseUtils ../../core/sql/WhereClause ../../layers/FeatureLayer ../../layers/support/Field".split(" "),
function(M,R,S,y,k,T,N,z,U,e,V,u,W,X,Y,Z,aa,ba,G,O,H,ca,v,I,C){async function J(h,b,d){const c=h.getVariables();if(0<c.length){const f=[];for(let a=0;a<c.length;a++)f.push(await b.evaluateIdentifier(d,{name:c[a]}));b={};for(d=0;d<c.length;d++)b[c[d]]=f[d];h.parameters=b}return h}function p(h,b,d=null){for(const c in h)if(c.toLowerCase()===b.toLowerCase())return h[c];return d}function P(h){if(null===h)return null;const b={type:p(h,"type",""),name:p(h,"name","")};if("range"===b.type)b.range=p(h,"range",
[]);else{b.codedValues=[];for(const d of p(h,"codedValues",[]))b.codedValues.push({name:p(d,"name",""),code:p(d,"code",null)})}return b}function K(h){if(null===h)return null;const b={},d=p(h,"wkt",null);null!==d&&(b.wkt=d);h=p(h,"wkid",null);null!==h&&(b.wkid=h);return b}function Q(h){if(null===h)return null;const b={hasZ:p(h,"hasz",!1),hasM:p(h,"hasm",!1)};var d=p(h,"spatialreference",null);d&&(b.spatialReference=K(d));d=p(h,"x",null);if(null!==d)return b.x=d,b.y=p(h,"y",null),b;d=p(h,"rings",null);
if(null!==d)return b.rings=d,b;d=p(h,"paths",null);if(null!==d)return b.paths=d,b;d=p(h,"points",null);if(null!==d)return b.points=d,b;for(const c of"xmin xmax ymin ymax zmin zmax mmin mmax".split(" "))d=p(h,c,null),null!==d&&(b[c]=d);return b}M.registerFunctions=function(h){"async"===h.mode&&(h.functions.timezone=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,1,2,b,d);if(e.isFeatureSet(a[0])){await a[0].load();if(1===a.length||null===a[1])return a[0].dateTimeReferenceFieldIndex.layerDateFieldsTimeZone;
if(!(a[1]instanceof y)||!1===a[1].hasField("type"))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);c=a[1].field("type");if(!1===e.isString(c))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);switch(e.toString(c).toLowerCase()){case "preferredtimezone":return a[0].dateTimeReferenceFieldIndex.layerPreferredTimeZone;case "editfieldsinfo":return a[0].dateTimeReferenceFieldIndex.layerEditFieldsTimeZone;case "timeinfo":return a[0].dateTimeReferenceFieldIndex.layerTimeInfoTimeZone;
case "field":if(a[1].hasField("fieldname")&&e.isString(a[1].field("fieldname")))return a[0].dateTimeReferenceFieldIndex.fieldTimeZone(e.toString(a[1].field("fieldname")))}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);}a=e.toDate(a[0],e.defaultTimeZone(b));if(null===a)return null;a=a.timeZone;return"system"===a?R.ArcadeDate.systemTimeZoneCanonicalName:a})},h.functions.sqltimestamp=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,1,3,b,d);c=
a[0];if(e.isDate(c)){if(1===a.length)return c.toSQLString();if(2===a.length)return c.changeTimeZone(e.toString(a[1])).toSQLString();throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);}if(e.isFeatureSet(c)){if(3!==a.length)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);await c.load();f=e.toString(a[1]);if(!1===e.isDate(a[2]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);c=c.fieldTimeZone(f);return null===c?a[2].toSQLString():
a[2].changeTimeZone(c).toSQLString()}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);})},h.signatures.push({name:"sqltimestamp",min:2,max:4}),h.functions.featuresetbyid=function(b,d){return h.standardFunctionAsync(b,d,(c,f,a)=>{e.pcCheck(a,2,4,b,d);if(a[0]instanceof N){c=e.toString(a[1]);f=e.defaultUndefined(a[2],null);const n=e.toBoolean(e.defaultUndefined(a[3],!0));null===f&&(f=["*"]);if(!1===e.isArray(f))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,
d);return a[0].featureSetById(c,n,f)}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);})},h.signatures.push({name:"featuresetbyid",min:2,max:4}),h.functions.getfeatureset=function(b,d){return h.standardFunctionAsync(b,d,(c,f,a)=>{e.pcCheck(a,1,2,b,d);if(e.isFeature(a[0]))return c=e.defaultUndefined(a[1],"datasource"),null===c&&(c="datasource"),c=e.toString(c).toLowerCase(),z.convertToFeatureSet(a[0].fullSchema(),c,b.lrucache,b.interceptor,b.spatialReference);throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,d);})},h.signatures.push({name:"getfeatureset",min:1,max:2}),h.functions.featuresetbyportalitem=function(b,d){return h.standardFunctionAsync(b,d,(c,f,a)=>{e.pcCheck(a,2,5,b,d);if(null===a[0])throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.PortalRequired,d);if(a[0]instanceof S){c=e.toString(a[1]);f=e.toString(a[2]);var n=e.defaultUndefined(a[3],null);const m=e.toBoolean(e.defaultUndefined(a[4],!0));null===n&&(n=["*"]);if(!1===e.isArray(n))throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,d);let g=null;b.services&&b.services.portal&&(g=b.services.portal);g=V.getPortal(a[0],g);return z.constructFeatureSetFromPortalItem(c,f,b.spatialReference,n,m,g,b.lrucache,b.interceptor)}if(!1===e.isString(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.PortalRequired,d);c=e.toString(a[0]);f=e.toString(a[1]);n=e.defaultUndefined(a[2],null);a=e.toBoolean(e.defaultUndefined(a[3],!0));null===n&&(n=["*"]);if(!1===e.isArray(n))throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,d);if(b.services&&b.services.portal)return z.constructFeatureSetFromPortalItem(c,f,b.spatialReference,n,a,b.services.portal,b.lrucache,b.interceptor);throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.PortalRequired,d);})},h.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),h.functions.featuresetbyname=function(b,d){return h.standardFunctionAsync(b,d,(c,f,a)=>{e.pcCheck(a,2,4,b,d);if(a[0]instanceof N){c=e.toString(a[1]);f=e.defaultUndefined(a[2],
null);const n=e.toBoolean(e.defaultUndefined(a[3],!0));null===f&&(f=["*"]);if(!1===e.isArray(f))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);return a[0].featureSetByName(c,n,f)}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);})},h.signatures.push({name:"featuresetbyname",min:2,max:4}),h.functions.featureset=function(b,d){return h.standardFunction(b,d,(c,f,a)=>{e.pcCheck(a,1,1,b,d);f=a[0];c={layerDefinition:{geometryType:"",objectIdField:"",
globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(e.isString(f))f=JSON.parse(f),void 0!==f.layerDefinition?(c.layerDefinition=f.layerDefinition,c.featureSet=f.featureSet,f.layerDefinition.spatialReference&&(c.layerDefinition.spatialReference=f.layerDefinition.spatialReference)):(c.featureSet.features=f.features,c.featureSet.geometryType=f.geometryType,c.layerDefinition.geometryType=c.featureSet.geometryType,c.layerDefinition.objectIdField=f.objectIdFieldName,
c.layerDefinition.typeIdField=f.typeIdFieldName,c.layerDefinition.globalIdField=f.globalIdFieldName,c.layerDefinition.fields=f.fields,f.spatialReference&&(c.layerDefinition.spatialReference=f.spatialReference));else if(a[0]instanceof y)if(f=JSON.parse(a[0].castToText(!0)),a=p(f,"layerdefinition"),null!==a){c.layerDefinition.geometryType=p(a,"geometrytype","");c.featureSet.geometryType=c.layerDefinition.geometryType;c.layerDefinition.globalIdField=p(a,"globalidfield","");c.layerDefinition.objectIdField=
p(a,"objectidfield","");c.layerDefinition.typeIdField=p(a,"typeidfield","");var n=p(a,"spatialreference",null);n&&(c.layerDefinition.spatialReference=K(n));for(const r of p(a,"fields",[]))n={name:p(r,"name",""),alias:p(r,"alias",""),type:p(r,"type",""),nullable:p(r,"nullable",!0),editable:p(r,"editable",!0),length:p(r,"length",null),domain:P(p(r,"domain"))},c.layerDefinition.fields.push(n);var m=p(f,"featureset",null);if(m){n={};for(var g of c.layerDefinition.fields)n[g.name.toLowerCase()]=g.name;
for(var l of p(m,"features",[])){m={};g=p(l,"attributes",{});for(var t in g)m[n[t.toLowerCase()]]=g[t];c.featureSet.features.push({attributes:m,geometry:Q(p(l,"geometry",null))})}}}else{c.layerDefinition.geometryType=p(f,"geometrytype","");c.featureSet.geometryType=c.layerDefinition.geometryType;c.layerDefinition.objectIdField=p(f,"objectidfieldname","");c.layerDefinition.typeIdField=p(f,"typeidfieldname","");if(l=p(f,"spatialreference",null))c.layerDefinition.spatialReference=K(l);for(const r of p(f,
"fields",[]))l={name:p(r,"name",""),alias:p(r,"alias",""),type:p(r,"type",""),nullable:p(r,"nullable",!0),editable:p(r,"editable",!0),length:p(r,"length",null),domain:P(p(r,"domain"))},c.layerDefinition.fields.push(l);l={};for(const r of c.layerDefinition.fields)l[r.name.toLowerCase()]=r.name;for(n of p(f,"features",[])){t={};g=p(n,"attributes",{});for(m in g)t[l[m.toLowerCase()]]=g[m];c.featureSet.features.push({attributes:t,geometry:Q(p(n,"geometry",null))})}}else throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,d);if(c.layerDefinition&&c.featureSet){b:{l=["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"];for(q of l)if(q===c.layerDefinition.geometryType){var q=!0;break b}q=!1}q=!1===q||null===c.layerDefinition.objectIdField||""===c.layerDefinition.objectIdField||!1===e.isArray(c.layerDefinition.fields)||!1===e.isArray(c.featureSet.features)?!1:!0}else q=!1;if(!1===q)throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,d);""===(c?.layerDefinition?.geometryType||"")&&(c.layerDefinition.geometryType="esriGeometryNull");return aa.create(c,b.spatialReference)})},h.signatures.push({name:"featureset",min:1,max:1}),h.functions.filter=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,2,2,b,d);if(e.isArray(a[0])||e.isImmutableArray(a[0])){c=[];var n=a[0];n instanceof U&&(n=n.toArray());f=null;if(e.isFunctionParameter(a[1]))f=a[1].createFunction(b);else throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,d);for(var m of n)a=f(m),ca.isPromiseLike(a)?!0===await a&&c.push(m):!0===a&&c.push(m);return c}if(e.isFeatureSet(a[0])){m=await a[0].load();m=v.WhereClause.create(a[1],m.getFieldsIndex());c=m.getVariables();if(0<c.length){f=[];for(n=0;n<c.length;n++)f.push(await h.evaluateIdentifier(b,{name:c[n]}));n={};for(let g=0;g<c.length;g++)n[c[g]]=f[g];m.parameters=n}return new W({parentfeatureset:a[0],whereclause:m})}throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,
d);})},h.signatures.push({name:"filter",min:2,max:2}),h.functions.orderby=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,2,2,b,d);if(e.isFeatureSet(a[0]))return c=new ba(a[1]),new X({parentfeatureset:a[0],orderbyclause:c});throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);})},h.signatures.push({name:"orderby",min:2,max:2}),h.functions.top=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,2,2,b,d);if(e.isFeatureSet(a[0]))return new Y({parentfeatureset:a[0],
topnum:a[1]});if(e.isArray(a[0]))return e.toNumber(a[1])>=a[0].length?a[0].slice(0):a[0].slice(0,e.toNumber(a[1]));if(e.isImmutableArray(a[0]))return e.toNumber(a[1])>=a[0].length()?a[0].slice(0):a[0].slice(0,e.toNumber(a[1]));throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);})},h.signatures.push({name:"top",min:2,max:2}),h.functions.first=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,1,1,b,d);return e.isFeatureSet(a[0])?(c=await a[0].first(c.abortSignal),
null!==c?(a=T.createFromGraphicLikeObject(c.geometry,c.attributes,a[0],b.timeReference),a._underlyingGraphic=c,a):c):e.isArray(a[0])?0===a[0].length?null:a[0][0]:e.isImmutableArray(a[0])?0===a[0].length()?null:a[0].get(0):null})},h.signatures.push({name:"first",min:1,max:1}),h.functions.attachments=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,1,2,b,d);f=c=-1;var n=null,m=!1;if(1<a.length)if(a[1]instanceof y){if(a[1].hasField("minsize")&&(c=e.toNumber(a[1].field("minsize"))),
a[1].hasField("metadata")&&(m=e.toBoolean(a[1].field("metadata"))),a[1].hasField("maxsize")&&(f=e.toNumber(a[1].field("maxsize"))),a[1].hasField("types")){var g=e.toStringArray(a[1].field("types"),!1);0<g.length&&(n=g)}}else if(null!==a[1])throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);if(e.isFeature(a[0])){g=a[0]._layer;g instanceof I&&(g=z.constructFeatureSet(g,b.spatialReference,["*"],!0,b.lrucache,b.interceptor));if(null===g||!1===e.isFeatureSet(g))return[];await g.load();
return g.queryAttachments(a[0].field(g.objectIdField),c,f,n,m)}if(null===a[0])return[];throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);})},h.signatures.push({name:"attachments",min:1,max:2}),h.functions.featuresetbyrelationshipname=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,2,4,b,d);c=a[0];const n=e.toString(a[1]);f=e.defaultUndefined(a[2],null);var m=e.toBoolean(e.defaultUndefined(a[3],!0));null===f&&(f=["*"]);if(!1===e.isArray(f))throw new k.ArcadeExecutionError(b,
k.ExecutionErrorCodes.InvalidParameter,d);if(null===a[0])return null;if(!e.isFeature(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);a=c._layer;a instanceof I&&(a=z.constructFeatureSet(a,b.spatialReference,["*"],!0,b.lrucache,b.interceptor));if(null===a||!1===e.isFeatureSet(a))return null;a=await a.load();const g=a.relationshipMetaData().filter(t=>t.name===n);if(0===g.length)return null;if(void 0!==g[0].relationshipTableId&&null!==g[0].relationshipTableId&&-1<g[0].relationshipTableId)return z.constructFeatureSetFromRelationship(a,
g[0],c.field(a.objectIdField),a.spatialReference,f,m,b.lrucache,b.interceptor);let l=a.serviceUrl();if(!l)return null;l="/"===l.charAt(l.length-1)?l+g[0].relatedTableId.toString():l+"/"+g[0].relatedTableId.toString();f=await z.constructFeatureSetFromUrl(l,a.spatialReference,f,m,b.lrucache,b.interceptor);await f.load();m=f.relationshipMetaData();m=m.filter(t=>t.id===g[0].id);if(!1===c.hasField(g[0].keyField)||null===c.field(g[0].keyField))return(c=await a.getFeatureByObjectId(c.field(a.objectIdField),
[g[0].keyField]))?(a=v.WhereClause.create(m[0].keyField+"\x3d @id",f.getFieldsIndex()),a.parameters={id:c.attributes[g[0].keyField]},f.filter(a)):new Z({parentfeatureset:f});a=v.WhereClause.create(m[0].keyField+"\x3d @id",f.getFieldsIndex());a.parameters={id:c.field(g[0].keyField)};return f.filter(a)})},h.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),h.functions.featuresetbyassociation=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,2,3,b,d);var n=
a[0],m=e.toString(e.defaultUndefined(a[1],"")).toLowerCase(),g=e.isString(a[2])?e.toString(a[2]):null;if(null===a[0])return null;if(!e.isFeature(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);var l=n._layer;l instanceof I&&(l=z.constructFeatureSet(l,b.spatialReference,["*"],!0,b.lrucache,b.interceptor));if(null===l||!1===e.isFeatureSet(l))return null;await l.load();a=l.serviceUrl();a=await z.constructAssociationMetaDataFeatureSetFromUrl(a,b.spatialReference);let t=
f=null;c=!1;if(null!==g&&""!==g&&void 0!==g){for(var q of a.terminals)q.terminalName===g&&(t=q.terminalId);null===t&&(c=!0)}var r=a.associations.getFieldsIndex();q=r.get("TOGLOBALID").name;g=r.get("FROMGLOBALID").name;const w=r.get("TOTERMINALID").name,L=r.get("FROMTERMINALID").name,D=r.get("FROMNETWORKSOURCEID").name,E=r.get("TONETWORKSOURCEID").name,B=r.get("ASSOCIATIONTYPE").name,da=r.get("ISCONTENTVISIBLE").name,ea=r.get("OBJECTID").name;for(var F of l.fields)if("global-id"===F.type){f=n.field(F.name);
break}let A=null;F=new u.SqlExpressionAdapted(new C({name:"percentalong",alias:"percentalong",type:"double"}),v.WhereClause.create("0",a.associations.getFieldsIndex()));n=new u.SqlExpressionAdapted(new C({name:"side",alias:"side",type:"string"}),v.WhereClause.create("''",a.associations.getFieldsIndex()));l={};for(var x in a.lkp)l[x]=a.lkp[x].sourceId;x=new u.StringToCodeAdapted(new C({name:"classname",alias:"classname",type:"string"}),null,l);l="";switch(m){case "midspan":l=`((${q}='${f}') OR ( ${g}='${f}')) AND (${B} IN (5))`;
x.codefield=v.WhereClause.create(`CASE WHEN (${q}='${f}') THEN ${D} ELSE ${E} END`,a.associations.getFieldsIndex());m=G.cloneField(u.AdaptedFeatureSet.findField(a.associations.fields,g));m.name="globalid";m.alias="globalid";A=new u.SqlExpressionAdapted(m,v.WhereClause.create(`CASE WHEN (${g}='${f}') THEN ${q} ELSE ${g} END`,a.associations.getFieldsIndex()));F=4<=a.unVersion?new u.OriginalField(u.AdaptedFeatureSet.findField(a.associations.fields,r.get("PERCENTALONG").name)):new u.SqlExpressionAdapted(new C({name:"percentalong",
alias:"percentalong",type:"double"}),v.WhereClause.create("0",a.associations.getFieldsIndex()));break;case "junctionedge":l=`((${q}='${f}') OR ( ${g}='${f}')) AND (${B} IN (4,6))`;x.codefield=v.WhereClause.create(`CASE WHEN (${q}='${f}') THEN ${D} ELSE ${E} END`,a.associations.getFieldsIndex());m=G.cloneField(u.AdaptedFeatureSet.findField(a.associations.fields,g));m.name="globalid";m.alias="globalid";A=new u.SqlExpressionAdapted(m,v.WhereClause.create(`CASE WHEN (${g}='${f}') THEN ${q} ELSE ${g} END`,
a.associations.getFieldsIndex()));n=new u.SqlExpressionAdapted(new C({name:"side",alias:"side",type:"string"}),v.WhereClause.create(`CASE WHEN (${B}=4) THEN 'from' ELSE 'to' END`,a.associations.getFieldsIndex()));break;case "connected":m=`${q}='@T'`;r=`${g}='@T'`;null!==t&&(m+=` AND ${w}=@A`,r+=` AND ${L}=@A`);l="(("+m+") OR ("+r+"))";l=e.multiReplace(l,"@T",f??"");m=e.multiReplace(m,"@T",f??"");null!==t&&(m=e.multiReplace(m,"@A",t.toString()),l=e.multiReplace(l,"@A",t.toString()));x.codefield=v.WhereClause.create("CASE WHEN "+
m+` THEN ${D} ELSE ${E} END`,a.associations.getFieldsIndex());f=G.cloneField(u.AdaptedFeatureSet.findField(a.associations.fields,g));f.name="globalid";f.alias="globalid";A=new u.SqlExpressionAdapted(f,v.WhereClause.create("CASE WHEN "+m+` THEN ${g} ELSE ${q} END`,a.associations.getFieldsIndex()));break;case "container":l=`${q}='${f}' AND ${B} = 2`;null!==t&&(l+=` AND ${w} = `+t.toString());x.codefield=D;l="( "+l+" )";A=new u.FieldRename(u.AdaptedFeatureSet.findField(a.associations.fields,g),"globalid",
"globalid");break;case "content":l=`(${g}='${f}' AND ${B} = 2)`;null!==t&&(l+=` AND ${L} = `+t.toString());x.codefield=E;l="( "+l+" )";A=new u.FieldRename(u.AdaptedFeatureSet.findField(a.associations.fields,q),"globalid","globalid");break;case "structure":l=`(${q}='${f}' AND ${B} = 3)`;null!==t&&(l+=` AND ${w} = `+t.toString());x.codefield=D;l="( "+l+" )";A=new u.FieldRename(u.AdaptedFeatureSet.findField(a.associations.fields,g),"globalid","globalId");break;case "attached":l=`(${g}='${f}' AND ${B} = 3)`;
null!==t&&(l+=` AND ${L} = `+t.toString());x.codefield=E;l="( "+l+" )";A=new u.FieldRename(u.AdaptedFeatureSet.findField(a.associations.fields,q),"globalid","globalId");break;default:throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);}c&&(l="1 \x3c\x3e 1");return new u.AdaptedFeatureSet({parentfeatureset:a.associations,adaptedFields:[new u.OriginalField(u.AdaptedFeatureSet.findField(a.associations.fields,ea)),new u.OriginalField(u.AdaptedFeatureSet.findField(a.associations.fields,
da)),A,n,x,F],extraFilter:l?v.WhereClause.create(l,a.associations.getFieldsIndex()):null})})},h.signatures.push({name:"featuresetbyassociation",min:2,max:6}),h.functions.groupby=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{e.pcCheck(a,3,3,b,d);if(!e.isFeatureSet(a[0]))throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);const n=await a[0].load();c=[];f=[];let m=!1;var g=[];if(e.isString(a[1]))g.push(a[1]);else if(a[1]instanceof y)g.push(a[1]);else if(e.isArray(a[1]))g=
a[1];else if(e.isImmutableArray(a[1]))g=a[1].toArray();else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);for(var l of g)if(e.isString(l)){g=v.WhereClause.create(e.toString(l),n.getFieldsIndex());var t=!0===O.isSingleField(g)?e.toString(l):"%%%%FIELDNAME";c.push({name:t,expression:g});"%%%%FIELDNAME"===t&&(m=!0)}else if(l instanceof y){g=l.hasField("name")?l.field("name"):"%%%%FIELDNAME";t=l.hasField("expression")?l.field("expression"):"";"%%%%FIELDNAME"===g&&(m=!0);
if(!g)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);c.push({name:g,expression:v.WhereClause.create(t||g,n.getFieldsIndex())})}else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);g=[];if(e.isString(a[2]))g.push(a[2]);else if(e.isArray(a[2]))g=a[2];else if(e.isImmutableArray(a[2]))g=a[2].toArray();else if(a[2]instanceof y)g.push(a[2]);else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);for(var q of g)if(q instanceof
y){l=q.hasField("name")?q.field("name"):"";g=q.hasField("statistic")?q.field("statistic"):"";t=q.hasField("expression")?q.field("expression"):"";if(!l||!g||!t)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);f.push({name:l,statistic:g.toLowerCase(),expression:v.WhereClause.create(t,n.getFieldsIndex())})}else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);if(m){q={};for(var r of n.fields)q[r.name.toLowerCase()]=1;for(const w of c)"%%%%FIELDNAME"!==
w.name&&(q[w.name.toLowerCase()]=1);for(const w of f)"%%%%FIELDNAME"!==w.name&&(q[w.name.toLowerCase()]=1);r=0;for(const w of c)if("%%%%FIELDNAME"===w.name){for(;1===q["field_"+r.toString()];)r++;q["field_"+r.toString()]=1;w.name="FIELD_"+r.toString()}}for(const w of c)await J(w.expression,h,b);for(const w of f)await J(w.expression,h,b);return a[0].groupby(c,f)})},h.signatures.push({name:"groupby",min:3,max:3}),h.functions.distinct=function(b,d){return h.standardFunctionAsync(b,d,async(c,f,a)=>{if(e.isFeatureSet(a[0])){e.pcCheck(a,
2,2,b,d);f=await a[0].load();c=[];var n=[];if(e.isString(a[1]))n.push(a[1]);else if(a[1]instanceof y)n.push(a[1]);else if(e.isArray(a[1]))n=a[1];else if(e.isImmutableArray(a[1]))n=a[1].toArray();else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);let t=!1;for(var m of n)if(e.isString(m)){n=v.WhereClause.create(e.toString(m),f.getFieldsIndex());var g=!0===O.isSingleField(n)?e.toString(m):"%%%%FIELDNAME";c.push({name:g,expression:n});"%%%%FIELDNAME"===g&&(t=!0)}else if(m instanceof
y){n=m.hasField("name")?m.field("name"):"%%%%FIELDNAME";g=m.hasField("expression")?m.field("expression"):"";"%%%%FIELDNAME"===n&&(t=!0);if(!n)throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);c.push({name:n,expression:v.WhereClause.create(g||n,f.getFieldsIndex())})}else throw new k.ArcadeExecutionError(b,k.ExecutionErrorCodes.InvalidParameter,d);if(t){m={};for(var l of f.fields)m[l.name.toLowerCase()]=1;for(const q of c)"%%%%FIELDNAME"!==q.name&&(m[q.name.toLowerCase()]=
1);l=0;for(const q of c)if("%%%%FIELDNAME"===q.name){for(;1===m["field_"+l.toString()];)l++;m["field_"+l.toString()]=1;q.name="FIELD_"+l.toString()}}for(const q of c)await J(q.expression,h,b);return a[0].groupby(c,[])}a:{if(1===a.length){if(e.isArray(a[0])){a=H.calculateStat("distinct",a[0],-1);break a}if(e.isImmutableArray(a[0])){a=H.calculateStat("distinct",a[0].toArray(),-1);break a}}a=H.calculateStat("distinct",a,-1)}return a})})};Object.defineProperty(M,Symbol.toStringTag,{value:"Module"})});