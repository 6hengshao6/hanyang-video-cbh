// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../../../request ../../Attachment ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../support/stats ../../../core/MD5 ../../../kernel ../../../geometry/support/jsonUtils ../../../layers/FeatureLayer ../../../layers/graphics/featureConversionUtils ../../../core/Error ../../../core/has ../../../core/Logger ../../../layers/support/source/DataLayerSource ../../../rest/query/executeQueryJSON ../../../config ../../../core/arrayUtils ../../../core/urlUtils ../../../core/unitUtils ../../../geometry/support/spatialReferenceUtils ../../../rest/query/operations/query ../../../rest/support/FeatureSet ../../../rest/support/Query ../../../rest/query/support/AttachmentInfo ../../../rest/support/AttachmentQuery ../../../rest/query/executeForCount ../../../geometry ../../../rest/query/executeForIds ../../../rest/support/RelationshipQuery ../../../geometry/support/normalizeUtils ../../../rest/support/TopFeaturesQuery ../../../rest/query/operations/pbfOptimizedFeatureSet ../../../rest/support/StatisticDefinition ../../Dictionary ../support/errorsupport".split(" "),
function(z,A,B,G,H,y,v,q,I,C,D,J,K,L,T,U,V,W,E,X,Y,Z,aa,ba,M,N,u,ca,da,O,ea,P,fa,ha,ia,Q,F,R,r){return function(h){function w(a){var b=S.call(this,a);b.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic";b._removeGeometry=!1;b._overrideFields=null;b.formulaCredential=null;b._pageJustIds=!1;b._requestStandardised=!1;b._useDefinitionExpression=!0;b._cachedDateMetaData={};a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;
b._wset=null;void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}z._inherits(w,h);var S=z._createSuper(w);h=w.prototype;h._maxQueryRate=function(){return v.defaultMaxRecords};h.end=function(){return this._layer};h.optimisePagingFeatureQueries=function(a){this._pageJustIds=a};h.convertQueryToLruCacheKey=function(a){a=this.urlQueryPath+","+v.stableStringify(a.toJSON());return C.createMD5Hash(a,C.outputTypes.String)};h.loadImpl=
async function(){if(!0===this._layer.loaded)return this._initialiseFeatureSet(),this;await this._layer.load();this._initialiseFeatureSet();return this};h._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){var a=[];for(var b of this.fields)if("oid"===b.type)a.push(b);
else for(const d of this._layer.outFields)if(d.toLowerCase()===b.name.toLowerCase()){a.push(b);break}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];b=[];for(var c of this.fields)if("oid"===c.type)a.push(c),b.push(c.name);else for(const d of this._overrideFields)if(d.toLowerCase()===c.name.toLowerCase()){a.push(c);b.push(c.name);break}this.fields=a;this._overrideFields=b}this._layer.source&&this._layer.source.sourceJSON&&
(c=this._layer.source.sourceJSON.currentVersion,!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=v.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==c&&null!==c&&10.61<=c&&(this._databaseType=v.FeatureServiceDatabaseType.Standardised)):void 0!==c&&null!==c&&(10.5<=c&&(this._databaseType=v.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),10.61<=c&&(this._databaseType=v.FeatureServiceDatabaseType.Standardised)));this.objectIdField=
this._layer.objectIdField;for(const d of this.fields)"global-id"===d.type&&(this.globalIdField=d.name);this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this.typeIdField=this._layer.typeIdField??"";this.types=this._layer.types};h._isInFeatureSet=function(){return v.IdState.InFeatureSet};h._refineSetBlock=async function(a){return a};h._candidateIdTransform=function(a){return a};h._getSet=async function(a){return null===this._wset?(await this._ensureLoaded(),this._wset=a=await this._getFilteredSet("",
null,null,null,a)):this._wset};h._runDatabaseProbe=async function(a){await this._ensureLoaded();const b=new u;this.datesInUnknownTimezone&&(b.timeReferenceUnknownClient=!0);b.where=a.replace("OBJECTID",this._layer.objectIdField);try{return await this._layer.queryObjectIds(b),!0}catch(c){return!1}};h._canUsePagination=function(){return this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsPagination?!0:!1};h._cacheableFeatureSetSourceKey=function(){return this._layer.url};
h.pbfSupportedForQuery=function(a){const b=this._layer?.capabilities?.query;return!a.outStatistics&&!0===b?.supportsFormatPBF&&!0===b?.supportsQuantizationEditMode};h.queryPBF=async function(a){a.quantizationParameters={mode:"edit"};a=await M.executeQueryPBF(this._layer.parsedUrl,a,new Q.OptimizedFeatureSetParserContext({}));return N.fromJSON(L.convertToFeatureSet(a.data)).unquantize()};h.nativeCapabilities=function(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,
databaseType:this._databaseType,requestStandardised:this._requestStandardised}};h.executeQuery=function(a,b){const c="execute"===b?E.executeQueryJSON:"executeForCount"===b?O.executeForCount:P.executeForIds,d="execute"===b&&this.pbfSupportedForQuery(a);let e=null;if(this.recentlyUsedQueries){const f=this.convertQueryToLruCacheKey(a);e=this.recentlyUsedQueries.getFromCache(f);null===e&&(e=!0!==d?c(this._layer.parsedUrl.path,a):this.queryPBF(a),this.recentlyUsedQueries.addToCache(f,e),e=e.catch(k=>{this.recentlyUsedQueries?.removeFromCache(f);
throw k;}))}this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:b});null===e&&(e=!0!==d?c(this._layer.parsedUrl.path,a):this.queryPBF(a));return e};h._getFilteredSet=async function(a,b,c,d,e){const f=await this.databaseType();if(this.isTable()&&b&&null!==a&&""!==a)return new y([],[],!0,null);if(this._canUsePagination())return this._getFilteredSetUsingPaging(a,b,c,d,e);let k="",g=!1;null!==d&&this._layer.capabilities&&this._layer.capabilities.query&&
!0===this._layer.capabilities.query.supportsOrderBy&&(k=d.constructClause(),g=!0);d=new u;this.datesInUnknownTimezone&&(d.timeReferenceUnknownClient=!0);d.where=null===c?null===b?"1\x3d1":"":q.toWhereClause(c,f);this._requestStandardised&&(d.sqlFormat="standard");d.spatialRelationship=this._makeRelationshipEnum(a);d.outSpatialReference=this.spatialReference;d.orderByFields=""!==k?k.split(","):null;d.geometry=null===b?null:b;d.relationParameter=this._makeRelationshipParam(a);a=await this.executeQuery(d,
"executeForIds");null===a&&(a=[]);this._checkCancelled(e);return new y([],a,g,null)};h._expandPagedSet=function(a,b,c,d,e){return this._expandPagedSetFeatureSet(a,b,c,d,e)};h._getFilteredSetUsingPaging=async function(a,b,c,d,e){let f="",k=!1;null!==d&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(f=d.constructClause(),k=!0);d=await this.databaseType();c=null===c?null===b?"1\x3d1":"":q.toWhereClause(c,d);this._layer.definitionExpression&&
this._useDefinitionExpression&&(c=""!==c?"(("+this._layer.definitionExpression+") AND ("+c+"))":this._layer.definitionExpression);d=this._maxQueryRate();var g=this._layer.capabilities?.query.maxRecordCount;null!=g&&g<d&&(d=g);g=null;if(!0===this._pageJustIds)g=new y([],["GETPAGES"],k,{spatialRel:this._makeRelationshipEnum(a),relationParam:this._makeRelationshipParam(a),outFields:this._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===b?null:b,where:c,orderByFields:f,returnGeometry:!1,
returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{g=!0;!0===this._removeGeometry&&(g=!1);const p=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields??["*"]);g=new y([],["GETPAGES"],k,{spatialRel:this._makeRelationshipEnum(a),relationParam:this._makeRelationshipParam(a),outFields:p.join(","),resultRecordCount:d,resultOffset:0,geometry:null===b?null:b,where:c,orderByFields:f,returnGeometry:g,returnIdsOnly:"false",
internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}await this._expandPagedSet(g,d,0,1,e);return g};h._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,
spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}};h._getPhysicalPage=async function(a,b,c){b=a.pagesDefinition.internal.lastRetrieved;
var d=a.pagesDefinition.internal.lastPage,e=new u;this._requestStandardised&&(e.sqlFormat="standard");this.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0);e.spatialRelationship=a.pagesDefinition.spatialRel;e.relationParameter=a.pagesDefinition.relationParam;e.outFields=a.pagesDefinition.outFields.split(",");e.num=a.pagesDefinition.resultRecordCount;e.start=a.pagesDefinition.internal.lastPage;e.geometry=a.pagesDefinition.geometry;e.where=a.pagesDefinition.where;e.orderByFields=""!==a.pagesDefinition.orderByFields?
a.pagesDefinition.orderByFields.split(","):null;e.returnGeometry=a.pagesDefinition.returnGeometry;e.outSpatialReference=this.spatialReference;e=await this.executeQuery(e,"execute");this._checkCancelled(c);if(a.pagesDefinition.internal.lastPage!==d)return"done";c=this._layer.objectIdField;for(d=0;d<e.features.length;d++)a.pagesDefinition.internal.set[b+d]=e.features[d].attributes[c];if(!1===this._pageJustIds)for(d=0;d<e.features.length;d++)this._featureCache[e.features[d].attributes[c]]=e.features[d];
if(void 0===e.exceededTransferLimit&&e.features.length!==a.pagesDefinition.resultRecordCount||!1===e.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=b+e.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return"done"};h._fieldsIncludingObjectId=function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(a.includes("*"))return a;let b=!1;for(const c of a)if(c.toUpperCase()===this.objectIdField.toUpperCase()){b=
!0;break}!1===b&&a.push(this.objectIdField);return a};h._getFeatures=async function(a,b,c,d){var e=[];-1!==b&&void 0===this._featureCache[b]&&e.push(b);if(!0===this._checkIfNeedToExpandKnownPage(a,this._maxProcessingRate()))return await this._expandPagedSet(a,this._maxProcessingRate(),0,0,d),this._getFeatures(a,b,c,d);let f=0;for(let g=a._lastFetchedIndex;g<a._known.length;g++){a._lastFetchedIndex+=1;f++;if(void 0===this._featureCache[a._known[g]]){let p=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var k=
this._layer._mode;void 0!==k._featureMap[a._known[g]]&&(k=k._featureMap[a._known[g]],null!==k&&(p=!0,this._featureCache[a._known[g]]=k))}if(!1===p&&(a._known[g]!==b&&e.push(a._known[g]),e.length>=this._maxProcessingRate()-1))break}if(f>=c&&0===e.length)break}if(0===e.length)return"success";a=new u;this._requestStandardised&&(a.sqlFormat="standard");this.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0);a.objectIds=e;a.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields??
["*"]);a.returnGeometry=!0;!0===this._removeGeometry&&(a.returnGeometry=!1);a.outSpatialReference=this.spatialReference;e=await this.executeQuery(a,"execute");this._checkCancelled(d);if(void 0!==e.error)throw new r.FeatureSetError(r.FeatureSetErrorCodes.RequestFailed,{reason:e.error});d=this._layer.objectIdField;for(a=0;a<e.features.length;a++)this._featureCache[e.features[a].attributes[d]]=e.features[a];return"success"};h._getDistinctPages=async function(a,b,c,d,e,f,k,g,p){await this._ensureLoaded();
var l=await this.databaseType();let t=c.parseTree.column;var n=this._layer.fields??[];for(var m=0;m<n.length;m++)if(n[m].name.toLowerCase()===t.toLowerCase()){t=n[m].name;break}m=new u;this._requestStandardised&&(m.sqlFormat="standard");this.datesInUnknownTimezone&&(m.timeReferenceUnknownClient=!0);l=null===f?null===e?"1\x3d1":"":q.toWhereClause(f,l);this._layer.definitionExpression&&this._useDefinitionExpression&&(l=""!==l?"(("+this._layer.definitionExpression+") AND ("+l+"))":this._layer.definitionExpression);
m.where=l;m.spatialRelationship=this._makeRelationshipEnum(d);m.relationParameter=this._makeRelationshipParam(d);m.geometry=null===e?null:e;m.returnDistinctValues=!0;m.returnGeometry=!1;m.outFields=[t];l=await this.executeQuery(m,"execute");this._checkCancelled(p);if(!l.hasOwnProperty("features"))throw new r.FeatureSetError(r.FeatureSetErrorCodes.InvalidStatResponse);m=!1;for(var x=0;x<n.length;x++)if(n[x].name===t){"date"===n[x].type&&(m=!0);break}for(n=0;n<l.features.length&&!(m?(x=l.features[n].attributes[t],
null!==x?g.push(new Date(x)):g.push(x)):g.push(l.features[n].attributes[t]),g.length>=k);n++);return 0===l.features.length?g:l.features.length===this._layer.capabilities?.query.maxRecordCount&&g.length<k?{calculated:!0,result:await this._getDistinctPages(a+l.features.length,b,c,d,e,f,k,g,p)}:g};h._distinctStat=async function(a,b,c,d,e,f,k){return{calculated:!0,result:await this._getDistinctPages(0,a,b,c,d,e,f,[],k)}};h.isTable=function(){return this._layer.isTable||null===this._layer.geometryType||
"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType};h._countstat=async function(a,b,c,d){const e=await this.databaseType();a=new u;this._requestStandardised&&(a.sqlFormat="standard");if(this.isTable()&&c&&null!==b&&""!==b)return{calculated:!0,result:0};d=null===d?null===c?"1\x3d1":"":q.toWhereClause(d,e);this._layer.definitionExpression&&this._useDefinitionExpression&&(d=""!==d?"(("+this._layer.definitionExpression+") AND ("+d+"))":this._layer.definitionExpression);
a.where=d;this.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0);a.where=d;a.spatialRelationship=this._makeRelationshipEnum(b);a.relationParameter=this._makeRelationshipParam(b);a.geometry=null===c?null:c;a.returnGeometry=!1;return{calculated:!0,result:await this.executeQuery(a,"executeForCount")}};h._stats=async function(a,b,c,d,e,f,k){await this._ensureLoaded();const g=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsSqlExpression,p=this._layer.capabilities&&
this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsStatistics,l=this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsDistinct;if("count"===a)return l?this._countstat(a,c,d,e):{calculated:!1};if(!1===p||!1===q.isSingleField(b)&&!1===g||!1===b.isStandardized)return""!==c||null!==e?{calculated:!1}:this._manualStat(a,b,f,k);if("distinct"===a)return!1===l?""!==c||null!==e?{calculated:!1}:this._manualStat(a,b,f,k):this._distinctStat(a,
b,c,d,e,f,k);k=await this.databaseType();if(this.isTable()&&d&&null!==c&&""!==c)return{calculated:!0,result:null};f=new u;this._requestStandardised&&(f.sqlFormat="standard");e=null===e?null===d?"1\x3d1":"":q.toWhereClause(e,k);this._layer.definitionExpression&&this._useDefinitionExpression&&(e=""!==e?"(("+this._layer.definitionExpression+") AND ("+e+"))":this._layer.definitionExpression);f.where=e;f.spatialRelationship=this._makeRelationshipEnum(c);f.relationParameter=this._makeRelationshipParam(c);
f.geometry=null===d?null:d;this.datesInUnknownTimezone&&(f.timeReferenceUnknownClient=!0);c=new F;c.statisticType=I.decodeStatType(a);c.onStatisticField=q.toWhereClause(b,k);c.outStatisticFieldName="ARCADE_STAT_RESULT";f.returnGeometry=!1;a="ARCADE_STAT_RESULT";f.outStatistics=[c];b=await this.executeQuery(f,"execute");if(!b.hasOwnProperty("features")||0===b.features.length)throw new r.FeatureSetError(r.FeatureSetErrorCodes.InvalidStatResponse);c=!1;d=b.fields??[];for(e=0;e<d.length;e++)if("ARCADE_STAT_RESULT"===
d[e].name.toUpperCase()){a=d[e].name;"date"===d[e].type&&(c=!0);break}return c?(c=b.features[0].attributes[a],null!==c&&(c=new Date(b.features[0].attributes[a])),{calculated:!0,result:c}):{calculated:!0,result:b.features[0].attributes[a]}};h._stat=function(a,b,c,d,e,f,k){return this._stats(a,b,c,d,e,f,k)};h._canDoAggregates=async function(a,b){await this._ensureLoaded();a=!1;var c=this._layer.capabilities?.query;const d=!0===c?.supportsSqlExpression;null!=c&&!0===c.supportsStatistics&&!0===c.supportsOrderBy&&
(a=!0);if(a)for(c=0;c<b.length-1;c++)!1===b[c].workingexpr?.isStandardized?a=!1:!1===q.isSingleField(b[c].workingexpr)&&!1===d&&(a=!1);return!1===a?!1:!0};h._makeRelationshipEnum=function(a){if(a.includes("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";
case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};h._makeRelationshipParam=function(a){return a.includes("esriSpatialRelRelation")?a.split(":")[1]:""};h._getAggregatePagesDataSourceDefinition=async function(a,b,c,d,e,f,k){await this._ensureLoaded();const g=await this.databaseType();let p="",l=!1,t=!1;null!==f&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(p=f.constructClause(),
t=!0);this._layer.capabilities&&this._layer.capabilities.query&&!1===this._layer.capabilities.query.supportsPagination&&(t=!1,l=!0,p=this._layer.objectIdField);f=[];for(var n=0;n<b.length;n++){const m=new F;m.onStatisticField=null!==b[n].workingexpr?q.toWhereClause(b[n].workingexpr,g):"";m.outStatisticFieldName=b[n].field;m.statisticType=b[n].toStatisticsName();f.push(m)}""===p&&(p=a.join(","));b=this._maxQueryRate();n=this._layer.capabilities?.query.maxRecordCount;null!=n&&n<b&&(b=n);e=null===e?
null===d?"1\x3d1":"":q.toWhereClause(e,g);this._layer.definitionExpression&&this._useDefinitionExpression&&(e=""!==e?"(("+this._layer.definitionExpression+") AND ("+e+"))":this._layer.definitionExpression);return new y([],["GETPAGES"],t,{groupbypage:!0,spatialRel:this._makeRelationshipEnum(c),relationParam:this._makeRelationshipParam(c),outFields:["*"],useOIDpagination:l,generatedOid:k,resultRecordCount:b,resultOffset:0,groupByFieldsForStatistics:a,outStatistics:f,geometry:null===d?null:d,where:e,
orderByFields:p,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})};h._getAgregagtePhysicalPage=async function(a,b,c){var d=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(d=""!==d?"("+d+") AND ("+a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()+")":a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString());b=a.pagesDefinition.internal.lastRetrieved;var e=
a.pagesDefinition.internal.lastPage;const f=new u;this._requestStandardised&&(f.sqlFormat="standard");f.where=d;f.spatialRelationship=a.pagesDefinition.spatialRel;f.relationParameter=a.pagesDefinition.relationParam;f.outFields=a.pagesDefinition.outFields;f.outStatistics=a.pagesDefinition.outStatistics;f.geometry=a.pagesDefinition.geometry;f.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;f.num=a.pagesDefinition.resultRecordCount;f.start=a.pagesDefinition.internal.lastPage;
f.returnGeometry=a.pagesDefinition.returnGeometry;this.datesInUnknownTimezone&&(f.timeReferenceUnknownClient=!0);f.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;if(this.isTable()&&f.geometry&&f.spatialRelationship)return[];d=await this.executeQuery(f,"execute");this._checkCancelled(c);if(!d.hasOwnProperty("features"))throw new r.FeatureSetError(r.FeatureSetErrorCodes.InvalidStatResponse);c=[];if(a.pagesDefinition.internal.lastPage!==e)return[];
for(e=0;e<d.features.length;e++)a.pagesDefinition.internal.set[b+e]=d.features[e].attributes[a.pagesDefinition.generatedOid];for(e=0;e<d.features.length;e++)c.push(new A({attributes:d.features[e].attributes,geometry:null}));if(!0===a.pagesDefinition.useOIDpagination)0===d.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=d.features[d.features.length-1].attributes[a.pagesDefinition.generatedOid];else if(void 0===d.exceededTransferLimit&&d.features.length!==
a.pagesDefinition.resultRecordCount||!1===d.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=b+d.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return c};w.create=function(a,b,c,d,e){a=new K({url:a,outFields:null===b?["*"]:b});return new w({layer:a,spatialReference:c,lrucache:d,interceptor:e})};h.relationshipMetaData=function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&
this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]};h.serviceUrl=function(){return v.extractServiceUrl(this._layer.parsedUrl.path)};h.queryAttachments=async function(a,b,c,d,e){var f=this._layer.capabilities;if(f?.data.supportsAttachment&&f?.operations.supportsQueryAttachments){f={objectIds:[a],returnMetadata:e};if(b&&0<b||c&&0<c)f.size=[b&&0<b?b:0,c&&0<c?c:b+1];d&&0<d.length&&(f.attachmentTypes=d);this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,
query:f,method:"attachments"});b=await this._layer.queryAttachments(f);const k=[];b&&b[a]&&b[a].forEach(g=>{const p=this._layer.parsedUrl.path+"/"+a.toString()+"/attachments/"+g.id.toString();let l=null;e&&g.exifInfo&&(l=R.convertJsonToArcade(g.exifInfo,"system",!0));k.push(new G(g.id,g.name,g.contentType,g.size,p,l))});return k}return[]};h.queryRelatedFeatures=async function(a){var b={f:"json",relationshipId:a.relationshipId.toString(),definitionExpression:a.where,outFields:a.outFields?.join(","),
returnGeometry:a.returnGeometry.toString()};void 0!==a.resultOffset&&null!==a.resultOffset&&(b.resultOffset=a.resultOffset.toString());void 0!==a.resultRecordCount&&null!==a.resultRecordCount&&(b.resultRecordCount=a.resultRecordCount.toString());a.orderByFields&&(b.orderByFields=a.orderByFields.join(","));a.objectIds&&0<a.objectIds.length&&(b.objectIds=a.objectIds.join(","));a.outSpatialReference&&(b.outSR=JSON.stringify(a.outSpatialReference.toJSON()));this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,
queryPayload:b,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"});b=await B(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:b});if(b.data){a={};if((b=b.data)&&b.relatedRecordGroups){const c=b.spatialReference;for(const d of b.relatedRecordGroups){const e=d.objectId,f=[];for(const k of d.relatedRecords){k.geometry&&(k.geometry.spatialReference=c);const g=new A({geometry:k.geometry?J.fromJSON(k.geometry):null,attributes:k.attributes});f.push(g)}a[e]=
{features:f,exceededTransferLimit:!0===b.exceededTransferLimit}}}return a}throw new r.FeatureSetError(r.FeatureSetErrorCodes.InvalidRequest);};h.getFeatureByObjectId=async function(a,b){const c=new u;c.outFields=b;c.returnGeometry=!1;c.outSpatialReference=this.spatialReference;c.where=this.objectIdField+"\x3d"+a.toString();this.datesInUnknownTimezone&&(c.timeReferenceUnknownClient=!0);this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:c,
method:"execute"});a=await E.executeQueryJSON(this._layer.parsedUrl.path,c);return 1===a.features.length?a.features[0]:null};h.getIdentityUser=async function(){await this.load();const a=D.id?.findCredential(this._layer.url);return a?a.userId:null};h.getOwningSystemUrl=async function(){await this.load();var a=D.id?.findServerInfo(this._layer.url);if(a)return a.owningSystemUrl;a=this._layer.url;const b=a.toLowerCase().indexOf("/rest/services");if(a=-1<b?a.substring(0,b):a)try{const c=await B(a+"/rest/info",
{query:{f:"json"}});a="";c.data&&c.data.owningSystemUrl&&(a=c.data.owningSystemUrl);return a}catch(c){}return""};h.getDataSourceFeatureSet=function(){const a=new w({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});a._useDefinitionExpression=!1;return a};z._createClass(w,[{key:"urlQueryPath",get:function(){return this._layer.parsedUrl.path||
""}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||"SDE.DEFAULT":""}},{key:"preferredTimeReference",get:function(){void 0===this._cachedDateMetaData.preferredTimeReference&&(this._cachedDateMetaData.preferredTimeReference=this._layer?.preferredTimeReference?.toJSON()??null);return this._cachedDateMetaData.preferredTimeReference}},{key:"dateFieldsTimeReference",get:function(){void 0===
this._cachedDateMetaData.dateFieldsTimeReference&&(this._cachedDateMetaData.dateFieldsTimeReference=this._layer?.dateFieldsTimeReference?.toJSON()??null);return this._cachedDateMetaData.dateFieldsTimeReference}},{key:"datesInUnknownTimezone",get:function(){return this._layer.datesInUnknownTimezone}},{key:"editFieldsInfo",get:function(){void 0===this._cachedDateMetaData.editFieldsInfo&&(this._cachedDateMetaData.editFieldsInfo=this._layer?.editFieldsInfo?.toJSON()??null);return this._cachedDateMetaData.editFieldsInfo}},
{key:"timeInfo",get:function(){void 0===this._cachedDateMetaData.timeInfo&&(this._cachedDateMetaData.timeInfo=this._layer?.timeInfo?.toJSON()??null);return this._cachedDateMetaData.timeInfo}}]);return w}(H)});