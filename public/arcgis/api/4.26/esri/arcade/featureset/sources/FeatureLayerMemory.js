// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../geometry/Geometry ../../../layers/FeatureLayer ../../../layers/support/FeatureType ../../../layers/support/Field ../../../rest/support/Query".split(" "),function(u,y,w,z,q,r,A,B,C,D,x,v){return function(e){function m(a){var b=E.call(this,a);b.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory";b._removeGeometry=
!1;b._overrideFields=null;b._forceIsTable=!1;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;!0===a.isTable&&(b._forceIsTable=!0);void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}u._inherits(m,e);var E=u._createSuper(m);e=m.prototype;e._maxQueryRate=function(){return r.defaultMaxRecords};e.end=function(){return this._layer};e.optimisePagingFeatureQueries=
function(){};e.loadImpl=async function(){if(!0===this._layer.loaded)return this._initialiseFeatureSet(),this;await this._layer.load();this._initialiseFeatureSet();return this};e._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){var a=[];for(var b of this.fields)if("oid"===
b.type)a.push(b);else for(const c of this._layer.outFields)if(c.toLowerCase()===b.name.toLowerCase()){a.push(b);break}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];b=[];for(const c of this.fields)if("oid"===c.type)a.push(c),b.push(c.name);else for(const d of this._overrideFields)if(d.toLowerCase()===c.name.toLowerCase()){a.push(c);b.push(c.name);break}this.fields=a;this._overrideFields=b}this.objectIdField=
this._layer.objectIdField;for(const c of this.fields)"global-id"===c.type&&(this.globalIdField=c.name);this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this._databaseType=r.FeatureServiceDatabaseType.Standardised;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};e.isTable=function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType};e._isInFeatureSet=function(){return r.IdState.InFeatureSet};e._candidateIdTransform=
function(a){return a};e._getSet=async function(a){return null===this._wset?(await this._ensureLoaded(),this._wset=a=await this._getFilteredSet("",null,null,null,a)):this._wset};e._changeFeature=function(a){const b={};for(const c of this.fields)b[c.name]=a.attributes[c.name];return new y({geometry:!0===this._removeGeometry?null:a.geometry,attributes:b})};e._getFilteredSet=async function(a,b,c,d,h){let k="",p=!1;null!==d&&(k=d.constructClause(),p=!0);if(this.isTable()&&b&&null!==a&&""!==a)return new q([],
[],!0,null);d=new v;d.where=null===c?null===b?"1\x3d1":"":A.toWhereClause(c,r.FeatureServiceDatabaseType.Standardised);d.spatialRelationship=this._makeRelationshipEnum(a);d.outSpatialReference=this.spatialReference;d.orderByFields=""!==k?k.split(","):null;d.geometry=null===b?null:b;d.returnGeometry=!0;d.relationParameter=this._makeRelationshipParam(a);a=await this._layer.queryFeatures(d);if(null===a)return new q([],[],p,null);this._checkCancelled(h);const t=[];a.features.forEach(n=>{const f=n.attributes[this._layer.objectIdField];
t.push(f);this._featureCache[f]=this._changeFeature(n)});return new q([],t,p,null)};e._makeRelationshipEnum=function(a){if(a.includes("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";
case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};e._makeRelationshipParam=function(a){return a.includes("esriSpatialRelRelation")?a.split(":")[1]:""};e._queryAllFeatures=async function(){if(this._wset)return this._wset;const a=new v;a.where="1\x3d1";await this._ensureLoaded();if(this._layer.source&&this._layer.source.items){const c=[];this._layer.source.items.forEach(d=>{const h=d.attributes[this._layer.objectIdField];c.push(h);this._featureCache[h]=this._changeFeature(d)});
return this._wset=new q([],c,!1,null)}const b=[];(await this._layer.queryFeatures(a)).features.forEach(c=>{const d=c.attributes[this._layer.objectIdField];b.push(d);this._featureCache[d]=this._changeFeature(c)});return this._wset=new q([],b,!1,null)};e._getFeatures=async function(a,b,c){const d=[];-1!==b&&void 0===this._featureCache[b]&&d.push(b);for(let h=a._lastFetchedIndex;h<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[h]]&&(a._known[h]!==b&&d.push(a._known[h]),
d.length>c));h++);if(0===d.length)return"success";throw new w.FeatureSetError(w.FeatureSetErrorCodes.MissingFeatures);};e._refineSetBlock=async function(a){return a};e._stat=async function(){return{calculated:!1}};e._canDoAggregates=async function(){return!1};e.relationshipMetaData=function(){return[]};m._cloneAttr=function(a){const b={};for(const c in a)b[c]=a[c];return b};e.nativeCapabilities=function(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,
databaseType:this._databaseType,requestStandardised:!0}};m.create=function(a,b){var c=a.layerDefinition.objectIdField,d=a.layerDefinition.typeIdField??"";const h=[];if(a.layerDefinition.types)for(var k of a.layerDefinition.types)h.push(D.fromJSON(k));let p=a.layerDefinition.geometryType;void 0===p&&(p=a.featureSet.geometryType||"");k=a.featureSet.features;const t=b.toJSON();if(""===c||void 0===c){var n=!1;for(var f of a.layerDefinition.fields)if("oid"===f.type||"esriFieldTypeOID"===f.type){c=f.name;
n=!0;break}if(!1===n){c="FID";f=!0;for(n=0;f;){let g=!0;for(var l of a.layerDefinition.fields)if(l.name===c){g=!1;break}!0===g?f=!1:(n++,c="FID"+n.toString())}a.layerDefinition.fields.push({type:"esriFieldTypeOID",name:c,alias:c});l=[];for(f=0;f<k.length;f++)l.push({geometry:a.featureSet.features[f].geometry,attributes:a.featureSet.features[f].attributes?this._cloneAttr(a.featureSet.features[f].attributes):{}}),l[f].attributes[c]=f;k=l}}l=[];for(const g of a.layerDefinition.fields)g instanceof x?
l.push(g):l.push(x.fromJSON(g));(a=p)||(a="");switch(a){case "esriGeometryPoint":a="point";break;case "esriGeometryPolyline":a="polyline";break;case "esriGeometryPolygon":a="polygon";break;case "esriGeometryExtent":a="extent";break;case "esriGeometryMultipoint":a="multipoint";break;case "":case "esriGeometryNull":a="esriGeometryNull"}if("esriGeometryNull"!==a)for(const g of k)g.geometry&&!1===g.geometry instanceof B&&(g.geometry.type=a,void 0===g.geometry.spatialReference&&(g.geometry.spatialReference=
t));else for(const g of k)g.geometry&&(g.geometry=null);d={outFields:["*"],source:k,fields:l,types:h,typeIdField:d,objectIdField:c,spatialReference:b};""!==a&&"esriGeometryNull"!==a&&null!==a&&(d.geometryType=a);d=new C(d);return new m({layer:d,spatialReference:b,isTable:null===a||""===a||"esriGeometryNull"===a})};e.queryAttachments=async function(){return[]};e.getFeatureByObjectId=async function(a){const b=new v;b.where=this.objectIdField+"\x3d"+a.toString();a=await this._layer.queryFeatures(b);
return 1===a.features.length?a.features[0]:null};e.getOwningSystemUrl=async function(){return""};e.getIdentityUser=async function(){return""};u._createClass(m,[{key:"gdbVersion",get:function(){return""}},{key:"preferredTimeReference",get:function(){return this._layer?.preferredTimeReference?.toJSON()??null}},{key:"dateFieldsTimeReference",get:function(){return this._layer?.dateFieldsTimeReference?.toJSON()??null}},{key:"datesInUnknownTimezone",get:function(){return this._layer?.datesInUnknownTimezone}},
{key:"editFieldsInfo",get:function(){return this._layer?.editFieldsInfo?.toJSON()??null}},{key:"timeInfo",get:function(){return this._layer?.timeInfo?.toJSON()??null}}]);return m}(z)});