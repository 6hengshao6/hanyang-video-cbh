// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/has ../../../../layers/support/CodedValueDomain ../../../../layers/support/Domain ../../../../layers/support/InheritedDomain ../../../../layers/support/RangeDomain ../../../../layers/support/Field ../../../statistics/support/predominanceUtils ../../utils ../../../../statistics/utils".split(" "),function(g,E,F,L,G,M,N,O,H,I,r,v){function z(a){const {field:c,normalizationType:b,normalizationField:d,normalizationTotal:e,
layer:f}=a;a=r.isIntegerField(f,c);let l=c;"percent-of-total"===b?l=`((${a?r.castIntegerFieldToFloat(c):c} / ${e}) * 100)`:"log"===b?l=`(log(${c}) * ${J})`:"field"===b?l=`(${a?r.castIntegerFieldToFloat(c):c} / ${d})`:"natural-log"===b?l=`(log(${a?r.castIntegerFieldToFloat(c):c}))`:"square-root"===b&&(l=`(power(${a?r.castIntegerFieldToFloat(c):c}, 0.5))`);return l}function A(a,c){let b;c=c.toLowerCase();if(a)for(const d in a)if(d.toLowerCase()!==c){b=a[d];break}return b}function t(a,c){let b;c=c.toLowerCase();
if(a)for(const d in a)if(d.toLowerCase()===c){b=a[d];break}return b}function w(a,c){if(c)for(const b in a)a[b].label=c[b];return{count:a}}async function x(a,c,b){var d=a?b.getField(a):null;if(d=d?b.getFieldDomain(d.name):null)return d;({uniqueValueInfos:a}=await b.uniqueValues({field:a,sqlWhere:c.sqlWhere,features:c.features,useFeaturesInView:c.useFeaturesInView,view:c.view,signal:c.signal}));a=a.map(e=>({code:e.value}));return new G({codedValues:a})}function B(a,c){switch(a.statisticType){case "avg":case "avg_angle":return"double";
case "count":return"integer";case "min":case "max":case "sum":return a.onStatisticField?c.get(a.onStatisticField)?.type??null:a.onStatisticExpression?"string"===a.onStatisticExpression.returnType?null:"double":null;case "mode":return a.onStatisticField?c.get(a.onStatisticField)?.type??null:a.onStatisticExpression?"string"===a.onStatisticExpression.returnType?"string":"double":null;default:return null}}const K=/_value$/i,J=Math.LOG10E;g.ensureFeaturesJSON=function(a){return a.map(c=>c.toJSON())};g.generateBinParams=
function(a){const c=[],b=a.classBreaks,d=b[0].minValue,e=b[b.length-1].maxValue;b.forEach(f=>{c.push([f.minValue,f.maxValue])});return{min:d,max:e,intervals:c,sqlExpr:z({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,layer:a.layer}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};g.getAggregateFieldType=B;g.getDomainsForFields=async function(a,c){if(!a.returnAllCodedValues)return[];const {field:b,field2:d,
field3:e}=a;if(b&&!d)return(c=(a=b?c.getField(b):null)?c.getFieldDomain(a.name):null)?[c]:[];const f=[];b&&(f.push(x(b,a,c)),d&&(f.push(x(d,a,c)),e&&f.push(x(e,a,c))));return Promise.all(f)};g.getFeatureReductionFields=function(a){const c="featureReduction"in a?a.featureReduction:null;return((null!=c&&"fields"in c?c.fields:null)??[]).map(b=>{const d=B(b,a.fieldsIndex);return d?new H({type:d,name:b.name,alias:b.alias}):null}).filter(E.isSome)};g.getFieldExpr=z;g.getHistogramFromFeatureSet=function(a,
c,b,d,e){const f={};a&&a.features&&a.features.forEach(n=>{var k=n.attributes;n=A(k,"countOFExpr");k=t(k,"countOFExpr");null!=n&&null!=k&&0!==n&&(f[n]=k)});const l=[];v.getEqualIntervalBins(c,b,d).forEach((n,k)=>{k=(k+1).toString();l.push({minValue:n[0],maxValue:n[1],count:f.hasOwnProperty(k)?f[k]:0})});return{bins:l,minValue:c,maxValue:b,normalizationTotal:e}};g.getMissingFields=function(a,c,b){const d=[];if(c)for(const e of c)(c=a.getField(e))&&b&&"availableFields"in b&&!b.availableFields?.includes(c.name)&&
d.push(c.name);return d};g.getMissingFieldsForBinning=function(a,c){const b=[];a=a.layer;a="featureReduction"in a?a.featureReduction:null;const d=null!=a&&"fields"in a?a.fields?.map(e=>e.name?.toLowerCase()).filter(Boolean):[];if("binning"!==a?.type||!c)return b;for(const e of c)d.includes(e.toLowerCase())||b.push(e);return b};g.getPredominantCategoriesFromUVInfos=function(a,c){const b=a.map(e=>e.value),d=c.filter(e=>!b.includes(e));for(const e of d)a.push({value:e,count:0});a.sort((e,f)=>c.indexOf(e.value)-
c.indexOf(f.value));for(const e of a)e.value===I.noDominantCategoryField&&(e.value=null);return{predominantCategoryInfos:a}};g.getSummaryStatisticsFromFeatureSet=function(a,c){a=(a=a&&a.features)&&a[0]&&a[0].attributes;const b={};for(const d in a)b[d.replace(K,"").toLowerCase()]=a[d];null!=b.totalcount&&b.totalcount>=b.count&&(b.nullcount=b.totalcount-b.count);delete b.totalcount;b.min===b.max&&null!=b.min&&null==b.stddev&&(b.stddev=b.variance=0);c&&("min max avg stddev sum variance".split(" ").forEach(d=>
{null!=b[d]&&(b[d]=Math.ceil(b[d]))}),b.min===b.max&&null!=b.min&&(b.avg=b.min,b.stddev=b.variance=0));return b};g.getUniqueValuesFromFeatureSet=function(a,c){a=a&&a.features;const {field:b,field2:d,field3:e,fieldDelimiter:f,layer:l,view:n,signal:k,labels:y}=c,C=`countOF${b&&d?"Expr":b||"Expr"}`,p={};let D=!1;a.forEach(q=>{var m=q.attributes;q=t(m,C);var h=b?t(m,b):A(m,C);let u=d?t(m,d):null;m=e?t(m,e):null;null===h&&0===q&&(D=!0);if(null==h||"string"===typeof h&&""===h.trim())h=null;d&&(null==u||
"string"===typeof u&&""===u.trim())&&(u=null);e&&(null==m||"string"===typeof m&&""===m.trim())&&(m=null);d&&(h=`${v.processNullValue(h)}${f}${v.processNullValue(u)}`,e&&(h=`${h}${f}${v.processNullValue(m)}`));null==p[h]?p[h]={count:q,data:h}:p[h].count+=q});return b&&D?l.queryFeatureCount({whereClause:b+" is NULL",view:n,signal:k}).then(q=>{p["null"].count+=q||0;return w(p,y)}).catch(()=>{F.throwIfAborted(k);return w(p,y)}):Promise.resolve(w(p,y))};g.getViewInfoParams=function(a){return{viewingMode:"2d"===
a.type?"map":a.viewingMode,scale:a.scale,spatialReference:a.spatialReference?.toJSON()}};g.msSinceUnixEpochSQL=function(a,c){return r.getDateDiffSQL(a,new Date(0),c,"milliseconds").sqlExpression};Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});