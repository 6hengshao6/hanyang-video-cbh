// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../Color ../../renderers/ClassBreaksRenderer ../../renderers/DictionaryRenderer ../../renderers/DotDensityRenderer ../../renderers/HeatmapRenderer ../../renderers/PieChartRenderer ../../renderers/Renderer ../../renderers/SimpleRenderer ../../renderers/UniqueValueRenderer ../../renderers/support/jsonUtils ../../symbols ../../core/Error ../../core/maybe ../../core/screenUtils ../../intl/messages ../../layers/support/AggregateField ../../layers/support/ExpressionInfo ../../renderers/support/AttributeColorInfo ../heuristics/outline ../heuristics/sizeRange ./size ./support/utils ../statistics/predominantCategories ../statistics/support/utils ../support/binningUtils ../support/utils ../support/adapters/support/layerUtils ../symbology/pieChart ../../symbols/support/cimSymbolUtils ../../symbols/SimpleLineSymbol".split(" "),
function(F,q,ka,la,ma,na,K,oa,pa,qa,ra,sa,l,x,N,G,z,A,O,P,Q,R,t,S,T,U,V,u,H,W,X){async function Y(a){if(!(a&&a.layer&&a.view&&a.attributes?.length))throw new l("pie-chart-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(10<a.attributes.length)throw new l("pie-chart-renderer:invalid-parameters","PieChart renderer does not support more than 10 attributes");a.forBinning&&U.verifyBinningParams(a,"pie-chart-renderer");const b={...a,layer:a.layer,view:a.view,attributes:a.attributes};
b.shape=b.shape||"pie";b.othersCategoryEnabled??(b.othersCategoryEnabled=!0);b.includeSizeVariable=a.includeSizeVariable||!1;var c=a.forBinning?u.binningCapableLayerTypes:I,d=u.createLayerAdapter(b.layer,c,a.forBinning);if(!d)throw new l("pie-chart-renderer:invalid-parameters","'layer' must be one of these types: "+u.getLayerTypeLabels(c).join(", "));b.layer=d;c=x.isSome(b.signal)?{signal:b.signal}:null;await Promise.all([a.view.when(),d.load(c)]);c=d.geometryType;a="polygon"===c;c="point"===c||"multipoint"===
c||a;b.outlineOptimizationEnabled=a?b.outlineOptimizationEnabled:!1;b.sizeOptimizationEnabled=c?b.sizeOptimizationEnabled:!1;if(!c)throw new l("pie-chart-renderer:not-supported","PieChart renderer is only supported for point and polygon layers");a=[];c=b.attributes;for(const g of c)c=await V.getFieldsList({field:g.field,valueExpression:g.valueExpression}),a.push(...c);if(d=t.verifyBasicFieldValidity(d,a.filter(Boolean),"pie-chart-renderer:invalid-parameters"))throw d;return b}async function Z(a){let b=
a.pieChartScheme,c=null;var d=null;d=await t.getBasemapInfo(a.basemap,a.view);c=x.isSome(d.basemapId)?d.basemapId:null;d=x.isSome(d.basemapTheme)?d.basemapTheme:null;if(b)return{scheme:H.cloneScheme(b),basemapId:c,basemapTheme:d};if(a=H.getSchemes({basemap:c,numColors:a.attributes.length,geometryType:a.layer.geometryType,basemapTheme:d}))b=a.primaryScheme,c=a.basemapId,d=a.basemapTheme;return{scheme:b,basemapId:c,basemapTheme:d}}async function aa(a,b){const {valueExpression:c,sqlExpression:d,sqlWhere:g}=
T.getSumOfAttributesExpr(a.attributes),k=await G.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");return R.createVisualVariables({layer:a.layer,basemap:a.basemap,valueExpression:c,sqlExpression:d,sqlWhere:g,sizeScheme:b,sizeOptimizationEnabled:a.sizeOptimizationEnabled,legendOptions:{title:k.sumOfCategories},view:a.view,signal:a.signal})}async function ba(a){if(!a||!a.layer)throw new l("pie-chart-cluster-renderer:missing-parameters","'layer' parameter is required");const b={...a};b.shape=
b.shape||"pie";b.defaultSymbolEnabled??(b.defaultSymbolEnabled=!0);a=a.layer;if(!u.getLayerTypes(I).includes(a.type))throw new l("pie-chart-cluster-renderer:invalid-parameters","'layer' must be one of these types: "+u.getLayerTypeLabels(I).join(", "));const c=x.isSome(b.signal)?{signal:b.signal}:null;await a.load(c);if("point"!==a.geometryType)throw new l("pie-chart-cluster-renderer:invalid-parameters","Cluster renderers are only supported for point layers");({renderer:a}=a);if(!a)throw new l("pie-chart-cluster-renderer:invalid-parameters",
"input layer does not have a renderer.");if(!ca.includes(a.type))throw new l("pie-chart-cluster-renderer:invalid-parameters",`Cannot create a pie chart renderer for clusters based on a ${a.type} renderer.`);if("valueExpression"in a&&a.valueExpression)throw new l("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer whose renderer contains a valueExpression.");if("unique-value"===a.type){if(a.field2)throw new l("pie-chart-cluster-renderer:invalid-parameters",
"Cannot create a pie chart renderer for clusters from a UniqueValueRenderer using more than one field.");if(null!=a.uniqueValueInfos&&10<a.uniqueValueInfos.length)throw new l("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer cannot be created from a UniqueValueRenderer with more than 10 unique value infos.");}if("class-breaks"===a.type){if(2>a.classBreakInfos.length)throw new l("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer renderer with a continuous color or size gradient.");
if(10<a.classBreakInfos.length)throw new l("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with more than 10 class break infos.");if("class-breaks-size"===a?.authoringInfo?.type)throw new l("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with breaks varied by size instead of color.");}return b}function da(a){const {renderer:b,defaultSymbolEnabled:c,defaultLabelBackup:d}=
a,{field:g,defaultSymbol:k,defaultLabel:n}=b;a=b.uniqueValueInfos??[];var p=k&&c,h=p?9:10;const v=t.createColors(L,h);h=a.slice(0,h).map((e,m)=>{const r=e.label;m=v[m];return{field:new z({name:B(e.value?.toString()),alias:r,onStatisticExpression:new A({title:`Field definition - ${r}`,expression:`Number(Text($feature["${g}"]) == "${e.value+""}")`,returnType:"number"}),statisticType:"sum"}),color:C(e.symbol,m)}})??[];p&&(p=n||d,h.push({field:new z({name:B("cluster_default"),alias:p,onStatisticExpression:new A({title:`Field definition - ${p}`,
expression:ea(g,a),returnType:"number"}),statisticType:"sum"}),color:C(k,M)}));return h}function fa(a){const {renderer:b,defaultSymbolEnabled:c,defaultLabelBackup:d}=a,{field:g,classBreakInfos:k,defaultSymbol:n,defaultLabel:p}=b;var h=(a=n&&c)?9:10;const v=t.createColors(L,h);h=k.slice(0,h).map((e,m)=>{const r=e.label||`${e.minValue} - ${e.maxValue}`;m=v[m];return{field:new z({name:B(r),alias:r,onStatisticExpression:new A({title:`Field definition - ${r}`,expression:`Number($feature["${g}"] >= ${e.minValue} && $feature["${g}"] < ${e.maxValue})`,
returnType:"number"}),statisticType:"sum"}),color:C(e.symbol,m)}});a&&(a=p||d,h.push({field:new z({name:B("cluster_default"),alias:a,onStatisticExpression:new A({title:`Field definition - ${a}`,expression:ha(g,k),returnType:"number"}),statisticType:"sum"}),color:C(n,M)}));return h}function B(a){return"SUM_"+(a+"").replace(/[^a-zA-Z0-9_]/g,"_")}function C(a,b){return"simple-marker"===a?.type&&a.color?a.color.clone():"cim"===a?.type&&(a=W.getCIMSymbolColor(a))?a.clone():b?b.clone():ia.clone()}function ea(a,
b){return`Number(!(${b.map(c=>`(Text($feature["${a}"]) == "${c.value+""}")`).join(" || ")}))`}function ha(a,b){return`Number(!(${b.map(c=>`($feature["${a}"] >= ${c.minValue} && $feature["${a}"] < ${c.maxValue})`).join(" || ")}))`}const I=[u.LayerType.CSVLayer,u.LayerType.FeatureLayer,u.LayerType.OGCFeatureLayer,u.LayerType.GeoJSONLayer,u.LayerType.WFSLayer],ca=["unique-value","class-breaks"],ia=new q("#aaaaaa"),M=new q("#5c5c5c"),L=[new q("#e60049"),new q("#0bb4ff"),new q("#50e991"),new q("#e6d800"),
new q("#9b19f5"),new q("#ffa300"),new q("#dc0ab4"),new q("#b3d4ff"),new q("#00bfa0"),new q("#f0cccc")];F.createRenderer=async function(a){const [b,c]=await Promise.all([Y(a),G.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")]);a=await Z(b);const d=a?.scheme;if(!d)throw new l("pie-chart-renderer:insufficient-info","Unable to find pie-chart scheme");var g=b.layer;const {includeSizeVariable:k,sizeOptimizationEnabled:n,outlineOptimizationEnabled:p,view:h,signal:v}=b;var e=d.sizeScheme,m=b.attributes,
r=m.map(f=>f.field).filter(x.isSome);const [J,w,y,D]=await Promise.all([1<r.length?S({layer:g,fields:r,view:h,signal:v}):null,k?aa(b,e):null,!k&&n?Q({layer:g,view:h,signal:v}).catch(t.errorCallback):null,p?P({layer:g,view:h,signal:v}).catch(t.errorCallback):null]);r=J&&J.predominantCategoryInfos?{uniqueValueInfos:J.predominantCategoryInfos}:{uniqueValueInfos:r.map(f=>({value:f,count:0}))};const ja=t.createColors(d.colors,m.length);m=m.map((f,E)=>({field:f.field,valueExpression:f.valueExpression,label:f.label,
valueExpressionTitle:f.valueExpressionTitle,color:ja[E]}));g=g.geometryType;e=null!=e&&"background"in e&&e.background;e=new K({attributes:m,othersCategory:{label:c.other,color:b.othersCategoryEnabled?d.colorForOthersCategory:null,threshold:.04},holePercentage:"donut"===b.shape?.45:0,backgroundFillSymbol:e?t.createSymbol(g,{type:"2d",color:e.color,outline:t.getSymbolOutlineFromScheme(e,g,D?.opacity)}):null,size:N.toPt(d.size),outline:new X(t.getSymbolOutlineFromScheme(d,"point",D?.opacity)),legendOptions:b.legendOptions});
w&&(n||w.visualVariables.forEach(f=>{"number"===typeof f.minSize&&"number"===typeof f.maxSize&&(f.minSize*=2.5,f.maxSize*=1.8)}),n&&"point"===g&&w.visualVariables.forEach(f=>{f?.minSize&&"object"===typeof f.minSize&&f.minSize?.stops?.forEach(E=>{E.size*=1.8})}),e.authoringInfo=w.authoringInfo.clone(),e.visualVariables=w.visualVariables?.map(f=>f.clone()));D?.visualVariables?.length&&(m=D.visualVariables.map(f=>f.clone()),e.visualVariables?e.visualVariables.push(...m):e.visualVariables=m);y?.minSize&&
("point"===g&&y.minSize.stops?.forEach(f=>{f.size*=2.5}),"polygon"===g&&y.minSize.stops?.forEach(f=>{f.size*=1.8}),e.visualVariables?e.visualVariables.push(y.minSize):e.visualVariables=[y.minSize]);return{renderer:e,pieChartScheme:H.cloneScheme(d),size:w,basemapId:a.basemapId,basemapTheme:a.basemapTheme,statistics:r}};F.createRendererForClustering=async function(a){a=await ba(a);const {layer:b,shape:c,defaultSymbolEnabled:d,legendOptions:g}=a;var {renderer:k}=b,n=(await G.fetchMessageBundle("esri/smartMapping/t9n/smartMapping")).other;
a=[];"unique-value"===k?.type&&(a=da({renderer:k,defaultSymbolEnabled:d,defaultLabelBackup:n}));"class-breaks"===k?.type&&(a=fa({renderer:k,defaultSymbolEnabled:d,defaultLabelBackup:n}));k=[];n=[];for(var p of a){const {field:h,color:v}=p;k.push(h);n.push(new O({color:v,field:h.name,label:h.alias}))}p=new K({attributes:n,legendOptions:g,holePercentage:"donut"===c?.45:0,outline:null,size:18,othersCategory:null});return{fields:k,renderer:p}};Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});