// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/deprecate ../core/Logger ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/subclass ../layers/FeatureLayer ../layers/support/featureQueryAll ./Network ./RulesTable ./support/NamedTraceConfiguration ./support/NetworkSystemLayers ./support/TerminalConfiguration ./support/typeUtils ../rest/support/Query".split(" "),function(u,h,x,f,m,R,
S,T,D,E,F,G,H,I,J,C,v,K){const y=f.getLogger("esri.networks.UtilityNetwork");f=function(g){function t(a){a=L.call(this,a);a.sharedNamedTraceConfigurations=[];a.type="utility";return a}u._inherits(t,g);var L=u._createSuper(t);g=t.prototype;g.load=async function(a){this.addResolvingPromise(u._get(u._getPrototypeOf(t.prototype),"load",this).call(this,a));this.addResolvingPromise(this._loadNamedTraceConfigurationsFromNetwork(a));return this};g.getTerminalConfiguration=function(a){let d=null,b=null;var c=
a.layer;let k=null;if("feature"===c?.type){if(k=c.layerId,null===k)return null}else return null;c=a.attributes;if(null==c)return null;for(const e of Object.keys(c))"ASSETGROUP"===e.toUpperCase()&&(d=a.getAttribute(e)),"ASSETTYPE"===e.toUpperCase()&&(b=a.getAttribute(e));if(!this.dataElement)return null;let l=null;a=this.dataElement.domainNetworks;for(var r of a)if(a=r.junctionSources?.find(e=>e.layerId===k))if(a=a.assetGroups?.find(e=>e.assetGroupCode===d))if(a=a.assetTypes?.find(e=>e.assetTypeCode===
b)){l=a.terminalConfigurationId;break}return null!=l?(r=this.dataElement.terminalConfigurations?.find(e=>e.terminalConfigurationId===l))?C.fromJSON(r):null:null};g.getTierNames=function(a){return this.dataElement?.domainNetworks.find(d=>d.domainNetworkName===a)?.tiers.map(d=>d.name)||[]};g.getRulesTable=async function(){return this._createRulesTable()};g.isUtilityLayer=function(a){return this._utilityLayerList.has(a.layerId)};g._loadNamedTraceConfigurationsFromNetwork=async function(a){if(0!==this.sharedNamedTraceConfigurations?.length){var d=
this.sharedNamedTraceConfigurations.map(b=>b.globalId);a=await this.queryNamedTraceConfigurations({globalIds:d},a);for(const b of this.sharedNamedTraceConfigurations)if(d=a?.find(c=>c.globalId===b.globalId))d=d.write({},{origin:"service"}),b.read(d,{origin:"service"})}};g._createRulesTable=async function(){const a=new E({url:this.rulesTableUrl});await a.load();var d=this.dataElement?.domainNetworks;if(!d)return null;const b=d.flatMap(c=>[...c.edgeSources,...c.junctionSources]);d=(await this._queryRulesTable(a)).map(c=>
this._hydrateRuleInfo(a,b,c));return new H({layer:a,rules:d})};g._queryRulesTable=async function(a){const d=new K({where:"1\x3d1",outFields:["*"]});return(await F.queryAllJSON(a,d)).features};g._hydrateRuleInfo=function(a,d,b){var c=a.fieldsIndex;a=c.get("RULETYPE");var k=c.get("CREATIONDATE"),l=c.get("FROMNETWORKSOURCEID"),r=c.get("FROMASSETGROUP"),e=c.get("FROMASSETTYPE"),z=c.get("FROMTERMINALID"),A=c.get("TONETWORKSOURCEID"),p=c.get("TOASSETGROUP");const M=c.get("TOASSETTYPE"),N=c.get("TOTERMINALID"),
O=c.get("VIANETWORKSOURCEID"),P=c.get("VIAASSETGROUP"),Q=c.get("VIAASSETTYPE");c=c.get("VIATERMINALID");a=b.attributes[a.name];k=new Date(b.attributes[k.name]);b=[{networkSourceId:b.attributes[l.name],assetGroupId:b.attributes[r.name],assetTypeId:b.attributes[e.name],terminalId:b.attributes[z.name]},{networkSourceId:b.attributes[A.name],assetGroupId:b.attributes[p.name],assetTypeId:b.attributes[M.name],terminalId:b.attributes[N.name]},{networkSourceId:b.attributes[O.name],assetGroupId:b.attributes[P.name],
assetTypeId:b.attributes[Q.name],terminalId:b.attributes[c.name]}];let q;(function(n){n[n.from=0]="from";n[n.to=1]="to";n[n.via=2]="via"})(q||(q={}));l={ruleType:a,creationDate:k};for(const n of[q.from,q.to,q.via]){if(a!==v.RuleType.RTEdgeJunctionEdgeConnectivity&&n===q.via)continue;const B=b[n];r=d.find(w=>w.sourceId===B.networkSourceId);e=r?.assetGroups.find(w=>w.assetGroupCode===B.assetGroupId);z=e?.assetTypes.find(w=>w.assetTypeCode===B.assetTypeId);A=this._getTerminal(a,z,B);if(a===v.RuleType.RTContainment||
a===v.RuleType.RTAttachment)A=null;p="";switch(n){case q.from:p="from";break;case q.to:p="to";break;case q.via:p="via"}l[`${p}NetworkSource`]=r;l[`${p}AssetGroup`]=e;l[`${p}AssetType`]=z;l[`${p}Terminal`]=A}return l};g._getTerminal=function(a,d,b){if(a===v.RuleType.RTAttachment||a===v.RuleType.RTContainment)return null;const c=d?.terminalConfigurationId;return this.terminalConfigurations?.find(k=>k.id===c)?.terminals?.find(k=>k.id===b.terminalId)??null};u._createClass(t,[{key:"serviceTerritoryFeatureLayerId",
get:function(){return this.dataElement?.serviceTerritoryFeatureLayerId??null}},{key:"networkSystemLayers",get:function(){return new J({rulesTableId:this.sourceJSON?.systemLayers.rulesTableId,rulesTableUrl:this.sourceJSON?`${this.featureServiceUrl}/${this.sourceJSON?.systemLayers.rulesTableId}`:null,subnetworksTableId:this.sourceJSON?.systemLayers.subnetworksTableId,subnetworksTableUrl:this.sourceJSON?`${this.featureServiceUrl}/${this.sourceJSON?.systemLayers.subnetworksTableId}`:null,dirtyAreasLayerId:this.sourceJSON?.systemLayers.dirtyAreasLayerId,
dirtyAreasLayerUrl:this.sourceJSON?`${this.featureServiceUrl}/${this.sourceJSON?.systemLayers.dirtyAreasLayerId}`:null})}},{key:"rulesTableId",get:function(){x.deprecatedProperty(y,"rulesTableId",{replacement:"networkSystemLayers.rulesTableId",version:"4.25"});return this.sourceJSON?.systemLayers.rulesTableId}},{key:"rulesTableUrl",get:function(){x.deprecatedProperty(y,"rulesTableUrl",{replacement:"networkSystemLayers.rulesTableUrl",version:"4.25"});return this.sourceJSON?`${this.featureServiceUrl}/${this.networkSystemLayers.rulesTableId}`:
null}},{key:"subnetworksTableId",get:function(){x.deprecatedProperty(y,"subnetworksTableId",{replacement:"networkSystemLayers.subnetworksTableId",version:"4.25"});return this.sourceJSON?.systemLayers.subnetworksTableId}},{key:"subnetworksTableUrl",get:function(){x.deprecatedProperty(y,"subnetworksTableUrl",{replacement:"networkSystemLayers.subnetworksTableUrl",version:"4.25"});return this.sourceJSON?`${this.featureServiceUrl}/${this.networkSystemLayers.subnetworksTableId}`:null}},{key:"terminalConfigurations",
get:function(){return this.dataElement?.terminalConfigurations.map(a=>C.fromJSON(a))||[]}},{key:"domainNetworkNames",get:function(){return this.dataElement?.domainNetworks.map(a=>a.domainNetworkName)||[]}},{key:"_utilityLayerList",get:function(){const a=new Set;this.dataElement?.domainNetworks?.map(d=>{d.edgeSources.map(b=>{a.add(b.layerId)});d.junctionSources.map(b=>{a.add(b.layerId)})});return a}}]);return t}(G);h.__decorate([m.property({type:[I],json:{origins:{"web-map":{read:{source:"traceConfigurations"},
write:{target:"traceConfigurations"}},service:{read:{source:"traceConfigurations"}}},read:!1}})],f.prototype,"sharedNamedTraceConfigurations",void 0);h.__decorate([m.property({type:["utility"],readOnly:!0,json:{read:!1,write:!1}})],f.prototype,"type",void 0);h.__decorate([m.property({readOnly:!0})],f.prototype,"serviceTerritoryFeatureLayerId",null);h.__decorate([m.property({readOnly:!0})],f.prototype,"networkSystemLayers",null);h.__decorate([m.property({readOnly:!0})],f.prototype,"rulesTableId",null);
h.__decorate([m.property({readOnly:!0})],f.prototype,"rulesTableUrl",null);h.__decorate([m.property({readOnly:!0})],f.prototype,"subnetworksTableId",null);h.__decorate([m.property({readOnly:!0})],f.prototype,"subnetworksTableUrl",null);h.__decorate([m.property({readOnly:!0})],f.prototype,"terminalConfigurations",null);h.__decorate([m.property({readOnly:!0})],f.prototype,"domainNetworkNames",null);return f=h.__decorate([D.subclass("esri.networks.UtilityNetwork")],f)});