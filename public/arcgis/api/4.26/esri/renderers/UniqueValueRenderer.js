// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../symbols ../core/Error ../core/lang ../core/Logger ../core/maybe ../core/object ../core/reactiveUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/decorators/cast ../core/accessorSupport/decorators/enumeration ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/accessorSupport/diffUtils ../core/accessorSupport/ensureType ../layers/support/fieldUtils ../portal/Portal ./Renderer ./mixins/VisualVariablesMixin ./support/commonProperties ./support/LegendOptions ./support/UniqueValue ./support/UniqueValueClass ./support/UniqueValueGroup ./support/UniqueValueInfo ../support/arcadeOnDemand ../chunks/persistableUrlUtils ../symbols/support/styleUtils ../symbols/WebStyleSymbol".split(" "),
function(D,k,Q,R,u,g,r,S,E,m,T,U,K,V,L,W,M,C,F,X,Y,N,Z,aa,ba,G,x,O,P,ca,da){function ea(e){const {field1:n,field2:v,field3:a,fieldDelimiter:b,uniqueValueInfos:c,valueExpression:d}=e,h=!(!n||!v);return[{classes:(c??[]).map(f=>{const {symbol:l,label:q,value:p,description:y}=f,[z,w,A]=h?p?.toString()?.split(b||"")||[]:[p];f=[];(n||d)&&f.push(z);v&&f.push(w);a&&f.push(A);return{symbol:l,label:q,values:[f],description:y}})}]}var B;const t=g.getLogger("esri.renderers.UniqueValueRenderer"),fa=M.ensureType(x);
g=B=function(e){function n(a){a=v.call(this,a);a._valueInfoMap={};a._isDefaultSymbolDerived=!1;a._isInfosSource=null;a.type="unique-value";a.backgroundFillSymbol=null;a.orderByClassesEnabled=!1;a.valueExpressionTitle=null;a.legendOptions=null;a.defaultLabel=null;a.portal=null;a.styleOrigin=null;a.diff={uniqueValueInfos(b,c){if(b||c){if(!b||!c)return{type:"complete",oldValue:b,newValue:c};var d=!1,h={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let f=0;f<c.length;f++){const l=
b.find(q=>q.value===c[f].value);l?W.diff(l,c[f])?(h.changed.push({type:"complete",oldValue:l,newValue:c[f]}),d=!0):h.unchanged.push({oldValue:l,newValue:c[f]}):(h.added.push(c[f]),d=!0)}for(let f=0;f<b.length;f++)c.find(l=>l.value===b[f].value)||(h.removed.push(b[f]),d=!0);return d?h:void 0}}};a._set("uniqueValueInfos",[]);a._set("uniqueValueGroups",[]);return a}D._inherits(n,e);var v=D._createSuper(n);e=n.prototype;e.castField=function(a){return null==a||"function"===typeof a?a:M.ensureString(a)};
e.writeField=function(a,b,c,d){"string"===typeof a?b[c]=a:d&&d.messages?d.messages.push(new R("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):t.error(".field: cannot write field to JSON since it's not a string value")};e.readPortal=function(a,b,c){return c.portal||F.getDefault()};e.readStyleOrigin=function(a,b,c){if(b.styleName)return Object.freeze({styleName:b.styleName});if(b.styleUrl)return a=P.fromJSON(b.styleUrl,c),Object.freeze({styleUrl:a})};
e.writeStyleOrigin=function(a,b,c,d){a.styleName?b.styleName=a.styleName:a.styleUrl&&(b.styleUrl=P.toJSON(a.styleUrl,d))};e.addUniqueValueInfo=function(a,b){this.styleOrigin?t.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(a="object"===typeof a?fa(a):new x({value:a,symbol:Q.ensureType(b)}),this.uniqueValueInfos?.push(a),this._valueInfoMap[a.value]=a,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())};
e.removeUniqueValueInfo=function(a){if(this.styleOrigin)t.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else{var b=this.uniqueValueInfos;if(b)for(let c=0;c<b.length;c++)if(b[c].value===a+""){delete this._valueInfoMap[a];b.splice(c,1);break}this._updateGroupsFromInfos();this._isInfosSource=!0;this._watchUniqueValueInfos()}};e.getUniqueValueInfo=async function(a,b){let c=b;this.valueExpression&&(r.isNone(b)||r.isNone(b.arcade))&&
(c={...c,arcade:await O.loadArcade()});return this._getUniqueValueInfo(a,c)};e.getSymbol=function(a,b){if(this.valueExpression&&(r.isNone(b)||r.isNone(b.arcade)))t.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");else return(a=this._getUniqueValueInfo(a,b))&&a.symbol||this.defaultSymbol};e.getSymbolAsync=async function(a,b){if(this.valueExpression&&(r.isNone(b)||r.isNone(b.arcade))){const c=await O.loadArcade(),{arcadeUtils:d}=c;d.hasGeometryOperations(this.valueExpression)&&
await d.enableGeometryOperations();b={...b,arcade:c}}return(a=this._getUniqueValueInfo(a,b))&&a.symbol||this.defaultSymbol};e.getSymbols=function(){const a=[];for(const b of this.uniqueValueInfos??[])b.symbol&&a.push(b.symbol);this.defaultSymbol&&a.push(this.defaultSymbol);return a};e.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce((a,b)=>a+b.getAttributeHash(),"")};e.getMeshHash=function(){const a=JSON.stringify(this.backgroundFillSymbol),b=JSON.stringify(this.defaultSymbol),
c=this.uniqueValueInfos?.reduce((d,h)=>d+h.getMeshHash(),"");return`${a}.${b}.${c}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`};e.clone=function(){const a=new B({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:u.clone(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,
visualVariables:u.clone(this.visualVariables),legendOptions:u.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:u.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(a._isDefaultSymbolDerived=!0);a._set("portal",this.portal);const b=u.clone(this.uniqueValueInfos),c=u.clone(this.uniqueValueGroups);this.styleOrigin&&(a._set("styleOrigin",Object.freeze(u.clone(this.styleOrigin))),Object.freeze(b),Object.freeze(c));a._set("uniqueValueInfos",
b);a._updateValueInfoMap();a._set("uniqueValueGroups",c);a._isInfosSource=this._isInfosSource;a._watchUniqueValueInfosAndGroups();return a};e.collectRequiredFields=async function(a,b){a=[this.collectVVRequiredFields(a,b),this.collectSymbolFields(a,b)];await Promise.all(a)};e.collectSymbolFields=async function(a,b){const c=[...this.getSymbols().map(d=>d.collectRequiredFields(a,b)),C.collectArcadeFieldNames(a,b,this.valueExpression)];C.collectField(a,b,this.field);C.collectField(a,b,this.field2);C.collectField(a,
b,this.field3);await Promise.all(c)};e.populateFromStyle=function(){return ca.fetchStyle(this.styleOrigin,{portal:this.portal}).then(a=>{const b=[];this._valueInfoMap={};a&&a.data&&Array.isArray(a.data.items)&&a.data.items.forEach(c=>{var d=new da({styleUrl:a.styleUrl,styleName:a.styleName,portal:this.portal,name:c.name});this.defaultSymbol||c.name!==a.data.defaultItem||(this.defaultSymbol=d,this._isDefaultSymbolDerived=!0);d=new x({value:c.name,symbol:d});b.push(d);this._valueInfoMap[c.name]=d});
this._set("uniqueValueInfos",Object.freeze(b));this._updateGroupsFromInfos(!0);this._isInfosSource=null;this._watchUniqueValueInfos();!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0);return this})};e._updateFieldDelimiter=function(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",",")};e._updateUniqueValues=function(){null!=this._isInfosSource&&(this._isInfosSource?this._updateGroupsFromInfos():
this._updateInfosFromGroups())};e._updateValueInfoMap=function(){this._valueInfoMap={};const {uniqueValueInfos:a}=this;if(a)for(const b of a)this._valueInfoMap[b.value+""]=b};e._watchUniqueValueInfosAndGroups=function(){this._watchUniqueValueInfos();this._watchUniqueValueGroups()};e._watchUniqueValueInfos=function(){this.removeHandles("uvInfos-watcher");const {uniqueValueInfos:a}=this;if(a){const b=[];for(const c of a)b.push(E.watch(()=>({symbol:c.symbol,value:c.value,label:c.label,description:c.description}),
(d,h)=>{d!==h&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(b,"uvInfos-watcher")}};e._watchUniqueValueGroups=function(){this.removeHandles("uvGroups-watcher");const {uniqueValueGroups:a}=this;if(a){const b=[];for(const c of a){b.push(E.watch(()=>({classes:c.classes}),(d,h)=>{d!==h&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const d of c.classes??[])b.push(E.watch(()=>({symbol:d.symbol,values:d.values,label:d.label,description:d.description}),
(h,f)=>{h!==f&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(b,"uvGroups-watcher")}};e._updateInfosFromGroups=function(){if(this.uniqueValueGroups){var a=[],{field:b,field2:c,field3:d,fieldDelimiter:h,uniqueValueGroups:f,valueExpression:l}=this;if(b||l){var q=!(!b||!c);for(const y of f)for(const z of y.classes??[]){const {symbol:w,label:A,values:H,description:I}=z;for(const J of H??[]){const {value:ha,value2:ia,value3:ja}=J;var p=[ha];c&&p.push(ia);d&&p.push(ja);
p=q?p.join(h||""):p[0];a.push(new x({symbol:w,label:A,value:p,description:I}))}}}this._set("uniqueValueInfos",a)}else this._set("uniqueValueInfos",null);this._updateValueInfoMap();this._watchUniqueValueInfos()};e._updateGroupsFromInfos=function(a=!1){if(this.uniqueValueInfos){var {field:b,field2:c,valueExpression:d,fieldDelimiter:h,uniqueValueInfos:f}=this;if((b||d)&&f.length){var l=!(!b||!c),q=f.map(p=>{const {symbol:y,label:z,value:w,description:A}=p,[H,I,J]=l?w?.toString()?.split(h||"")||[]:[w];
return new ba({symbol:y,label:z,description:A,values:[new aa({value:H,value2:I,value3:J})]})});q=[new G({classes:q})];a&&Object.freeze(q);this._set("uniqueValueGroups",q)}else this._set("uniqueValueGroups",[])}else this._set("uniqueValueGroups",null);this._watchUniqueValueGroups()};e._getUniqueValueInfo=function(a,b){return this.valueExpression?this._getUnqiueValueInfoForExpression(a,b):this._getUnqiueValueInfoForFields(a)};e._getUnqiueValueInfoForExpression=function(a,b){const {viewingMode:c,scale:d,
spatialReference:h,arcade:f}=r.unwrapOr(b,{});var l=this._cache.compiledFunc;b=r.unwrap(f).arcadeUtils;l||(l=b.createSyntaxTree(this.valueExpression),l=b.createFunction(l),this._cache.compiledFunc=l);a=b.executeFunction(l,b.createExecContext(a,b.getViewInfo({viewingMode:c,scale:d,spatialReference:h})));return this._valueInfoMap[a+""]};e._getUnqiueValueInfoForFields=function(a){const b=this.field,c=a.attributes;if("function"!==typeof b&&this.field2){a=this.field2;var d=this.field3;const h=[];b&&h.push(c[b]);
a&&h.push(c[a]);d&&h.push(c[d]);d=h.join(this.fieldDelimiter||"")}else"function"===typeof b?d=b(a):b&&(d=c[b]);return this._valueInfoMap[d+""]};n.fromPortalStyle=function(a,b){const c=new B(b&&b.properties);c._set("styleOrigin",Object.freeze({styleName:a}));c._set("portal",b&&b.portal||F.getDefault());b=c.populateFromStyle();b.catch(d=>{t.error(`#fromPortalStyle('${a}'[, ...])`,"Failed to create unique value renderer from style name",d)});return b};n.fromStyleUrl=function(a,b){b=new B(b&&b.properties);
b._set("styleOrigin",Object.freeze({styleUrl:a}));b=b.populateFromStyle();b.catch(c=>{t.error(`#fromStyleUrl('${a}'[, ...])`,"Failed to create unique value renderer from style URL",c)});return b};D._createClass(n,[{key:"_cache",get:function(){return{compiledFunc:null}}},{key:"field",set:function(a){this._set("field",a);this._updateFieldDelimiter();this._updateUniqueValues()}},{key:"field2",set:function(a){this._set("field2",a);this._updateFieldDelimiter();this._updateUniqueValues()}},{key:"field3",
set:function(a){this._set("field3",a);this._updateUniqueValues()}},{key:"valueExpression",set:function(a){this._set("valueExpression",a);this._updateUniqueValues()}},{key:"defaultSymbol",set:function(a){this._isDefaultSymbolDerived=!1;this._set("defaultSymbol",a)}},{key:"fieldDelimiter",set:function(a){this._set("fieldDelimiter",a);this._updateUniqueValues()}},{key:"uniqueValueGroups",set:function(a){this.styleOrigin?t.error("#uniqueValueGroups\x3d","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):
(this._set("uniqueValueGroups",a),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}},{key:"uniqueValueInfos",set:function(a){this.styleOrigin?t.error("#uniqueValueInfos\x3d","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",a),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}},{key:"arcadeRequired",get:function(){return this.arcadeRequiredForVisualVariables||
!!this.valueExpression}}]);return n}(Y.VisualVariablesMixin(X));k.__decorate([m.property({readOnly:!0})],g.prototype,"_cache",null);k.__decorate([U.enumeration({uniqueValue:"unique-value"})],g.prototype,"type",void 0);k.__decorate([m.property(N.rendererBackgroundFillSymbolProperty)],g.prototype,"backgroundFillSymbol",void 0);k.__decorate([m.property({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],g.prototype,"field",null);k.__decorate([T.cast("field")],g.prototype,
"castField",null);k.__decorate([L.writer("field")],g.prototype,"writeField",null);k.__decorate([m.property({type:String,value:null,json:{write:!0}})],g.prototype,"field2",null);k.__decorate([m.property({type:String,value:null,json:{write:!0}})],g.prototype,"field3",null);k.__decorate([m.property({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],g.prototype,"orderByClassesEnabled",void 0);k.__decorate([m.property({type:String,value:null,json:{write:!0}})],
g.prototype,"valueExpression",null);k.__decorate([m.property({type:String,json:{write:!0}})],g.prototype,"valueExpressionTitle",void 0);k.__decorate([m.property({type:Z.LegendOptions,json:{write:!0}})],g.prototype,"legendOptions",void 0);k.__decorate([m.property({type:String,json:{write:!0}})],g.prototype,"defaultLabel",void 0);k.__decorate([m.property(S.deepMerge({...N.rendererSymbolProperty},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],
g.prototype,"defaultSymbol",null);k.__decorate([m.property({type:String,value:null,json:{write:!0}})],g.prototype,"fieldDelimiter",null);k.__decorate([m.property({type:F,readOnly:!0})],g.prototype,"portal",void 0);k.__decorate([K.reader("portal",["styleName"])],g.prototype,"readPortal",null);k.__decorate([m.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],g.prototype,"styleOrigin",void 0);k.__decorate([K.reader("styleOrigin",["styleName","styleUrl"])],g.prototype,
"readStyleOrigin",null);k.__decorate([L.writer("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],g.prototype,"writeStyleOrigin",null);k.__decorate([m.property({type:[G],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(e,n,v)=>(n.uniqueValueGroups||ea(n)).map(a=>G.fromJSON(a,v))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],g.prototype,"uniqueValueGroups",null);k.__decorate([m.property({type:[x],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?
{enabled:!1}:{enabled:!0}}}}})],g.prototype,"uniqueValueInfos",null);return g=B=k.__decorate([V.subclass("esri.renderers.UniqueValueRenderer")],g)});