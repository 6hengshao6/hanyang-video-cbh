// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../geometry ../PopupTemplate ../renderers/ClassBreaksRenderer ../renderers/DictionaryRenderer ../renderers/DotDensityRenderer ../renderers/HeatmapRenderer ../renderers/PieChartRenderer ../renderers/Renderer ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/support/jsonUtils ../renderers/support/types ../request ../symbols ../core/Error ../core/handleUtils ../core/Logger ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/extensions/serializableProperty/reader ../geometry/support/typeUtils ./Layer ./mixins/ArcGISService ./mixins/BlendLayer ./mixins/CustomParametersMixin ./mixins/FeatureEffectLayer ./mixins/FeatureReductionLayer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/commonProperties ./support/Field ./support/fieldProperties ./support/fieldUtils ./support/LabelClass ./support/labelingInfo ./support/PurgeOptions ../renderers/support/styleUtils ../rest/support/Query ../support/popupUtils ../symbols/support/ElevationInfo ../geometry/SpatialReference ../geometry/Extent".split(" "),
function(C,n,c,r,D,ra,sa,ta,ua,va,wa,E,F,G,w,H,I,m,J,K,L,b,M,d,x,xa,ya,y,N,O,t,P,Q,R,S,T,U,V,W,X,Y,Z,l,aa,ba,u,ca,da,z,ea,fa,ha,ia,A,ja){function B(f,h){return new m("layer:unsupported",`Layer (${f.title}, ${f.id}) of type '${f.declaredClass}' ${h}`,{layer:f})}r=ba.defineFieldProperties();b=function(f){function h(...a){a=ka.call(this,...a);a.copyright=null;a.definitionExpression=null;a.displayField=null;a.elevationInfo=null;a.fields=null;a.fieldsIndex=null;a.geometryDefinition=null;a.geometryType=
null;a.labelsVisible=!0;a.labelingInfo=null;a.legendEnabled=!0;a.maxReconnectionAttempts=0;a.maxReconnectionInterval=20;a.maxScale=0;a.minScale=0;a.objectIdField=null;a.operationalLayerType="ArcGISStreamLayer";a.popupEnabled=!0;a.popupTemplate=null;a.purgeOptions=new z;a.screenSizePerspectiveEnabled=!0;a.sourceJSON=null;a.spatialReference=A.WGS84;a.type="stream";a.url=null;a.updateInterval=300;a.webSocketUrl=null;return a}n._inherits(h,f);var ka=n._createSuper(h);f=h.prototype;f.normalizeCtorArgs=
function(a,e){return"string"===typeof a?{url:a,...e}:a};f.load=function(a){if(!("WebSocket"in globalThis))return this.addResolvingPromise(Promise.reject(new m("stream-layer:websocket-unsupported","WebSocket is not supported in this browser. StreamLayer will not have real-time connection with the stream service."))),Promise.resolve(this);const e=L.isSome(a)?a.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Stream Service","Feed"]},a).catch(M.throwIfAbortError).then(()=>this._fetchService(e)));
return Promise.resolve(this)};f.readRenderer=function(a,e,g){e=e.layerDefinition||e;if(a=e.drawingInfo&&e.drawingInfo.renderer||void 0)return(a=G.read(a,e,g)||void 0)||K.getLogger(this.declaredClass).error("Failed to create renderer",{rendererDefinition:e.drawingInfo.renderer,layer:this,context:g}),a;if(e.defaultSymbol)return e.types&&e.types.length?new F({defaultSymbol:v(e.defaultSymbol,e,g),field:e.typeIdField,uniqueValueInfos:e.types.map(k=>({id:k.id,symbol:v(k.symbol,k,g)}))}):new E({symbol:v(e.defaultSymbol,
e,g)})};f.connect=async function(a){const [{createConnection:e}]=await Promise.all([new Promise((p,la)=>C(["./graphics/sources/connections/createConnection"],p,la)),this.load()]),g=this.geometryType?t.featureGeometryTypeKebabDictionary.toJSON(this.geometryType):null,{customParameters:k=null,definitionExpression:ma=null,geometryDefinition:na=null,maxReconnectionAttempts:oa=0,maxReconnectionInterval:pa=20,spatialReference:qa=this.spatialReference}=a||this.createConnectionParameters(),q=e(this.parsedUrl,
this.spatialReference,qa,g,{geometry:na,where:ma},oa,pa,k??void 0);a=J.handlesGroup([this.on("send-message-to-socket",p=>q.sendMessageToSocket(p)),this.on("send-message-to-client",p=>q.sendMessageToClient(p))]);q.once("destroy",a.remove);return q};f.createConnectionParameters=function(){return{spatialReference:this.spatialReference,customParameters:this.customParameters,definitionExpression:this.definitionExpression,geometryDefinition:this.geometryDefinition,maxReconnectionAttempts:this.maxReconnectionAttempts,
maxReconnectionInterval:this.maxReconnectionInterval}};f.createPopupTemplate=function(a){return ha.createPopupTemplate(this,a)};f.createQuery=function(){const a=new fa;a.returnGeometry=!0;a.outFields=["*"];a.where=this.definitionExpression||"1\x3d1";return a};f.getFieldDomain=function(a,e){if(!this.fields)return null;let g=null;this.fields.some(k=>{k.name===a&&(g=k.domain);return!!g});return g};f.getField=function(a){return this.fieldsIndex.get(a)};f.serviceSupportsSpatialReference=function(a){return!0};
f.sendMessageToSocket=function(a){this.emit("send-message-to-socket",a)};f.sendMessageToClient=function(a){this.emit("send-message-to-client",a)};f.write=function(a,e){const g=e?.messages;return this.webSocketUrl?(g?.push(B(this,"using a custom websocket connection cannot be written to web scenes and web maps")),null):this.parsedUrl?n._get(n._getPrototypeOf(h.prototype),"write",this).call(this,a,e):(g?.push(B(this,"using a client-side only connection without a url cannot be written to web scenes and web maps")),
null)};f._fetchService=async function(a){if(!this.webSocketUrl&&this.parsedUrl)this.sourceJSON||({data:a}=await H(this.parsedUrl.path,{query:{f:"json",...this.customParameters,...this.parsedUrl.query},responseType:"json",signal:a}),this.sourceJSON=a);else{if(!this.timeInfo?.trackIdField)throw new m("stream-layer:missing-metadata","The stream layer trackIdField must be specified.");if(!this.objectIdField){a=this.fields.find(e=>"oid"===e.type)?.name;if(!a)throw new m("stream-layer:missing-metadata",
"The stream layer objectIdField must be specified.");this.objectIdField=a}if(!this.fields)throw new m("stream-layer:missing-metadata","The stream layer fields must be specified.");this.fields.some(e=>e.name===this.objectIdField)||this.fields.push(new aa({name:this.objectIdField,alias:this.objectIdField,type:"oid"}));if(!this.geometryType)throw new m("stream-layer:missing-metadata","The stream layer geometryType must be specified.");this.webSocketUrl&&(this.url=this.webSocketUrl)}this.read(this.sourceJSON,
{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl});u.fixRendererFields(this.renderer,this.fieldsIndex);u.fixTimeInfoFields(this.timeInfo,this.fieldsIndex);this.objectIdField||(this.objectIdField="__esri_stream_id__");return ea.loadStyleRenderer(this,{origin:"service"})};n._createClass(h,[{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"renderer",set:function(a){u.fixRendererFields(a,this.fieldsIndex);this._set("renderer",
a)}}]);return h}(U.FeatureReductionLayer(T.FeatureEffectLayer(R.BlendLayer(Z.TemporalLayer(Y.ScaleRangeLayer(X.RefreshableLayer(Q.ArcGISService(V.OperationalLayer(W.PortalLayer(b.MultiOriginJSONMixin(S.CustomParametersMixin(P))))))))))));c.__decorate([d.property({type:String})],b.prototype,"copyright",void 0);c.__decorate([d.property({readOnly:!0})],b.prototype,"defaultPopupTemplate",null);c.__decorate([d.property({type:String,json:{name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],
b.prototype,"definitionExpression",void 0);c.__decorate([d.property({type:String})],b.prototype,"displayField",void 0);c.__decorate([d.property({type:ia})],b.prototype,"elevationInfo",void 0);c.__decorate([d.property(r.fields)],b.prototype,"fields",void 0);c.__decorate([d.property(r.fieldsIndex)],b.prototype,"fieldsIndex",void 0);c.__decorate([d.property({type:ja})],b.prototype,"geometryDefinition",void 0);c.__decorate([d.property({type:t.featureGeometryTypeKebabDictionary.apiValues,json:{read:{reader:t.featureGeometryTypeKebabDictionary.read}}})],
b.prototype,"geometryType",void 0);c.__decorate([d.property(l.labelsVisible)],b.prototype,"labelsVisible",void 0);c.__decorate([d.property({type:[ca],json:{read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:da.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],b.prototype,"labelingInfo",void 0);c.__decorate([d.property(l.legendEnabled)],b.prototype,"legendEnabled",void 0);c.__decorate([d.property({type:["show","hide"]})],b.prototype,"listMode",void 0);c.__decorate([d.property({type:x.Integer})],
b.prototype,"maxReconnectionAttempts",void 0);c.__decorate([d.property({type:x.Integer})],b.prototype,"maxReconnectionInterval",void 0);c.__decorate([d.property(l.maxScale)],b.prototype,"maxScale",void 0);c.__decorate([d.property(l.minScale)],b.prototype,"minScale",void 0);c.__decorate([d.property({type:String})],b.prototype,"objectIdField",void 0);c.__decorate([d.property({value:"ArcGISStreamLayer",type:["ArcGISStreamLayer"]})],b.prototype,"operationalLayerType",void 0);c.__decorate([d.property(l.popupEnabled)],
b.prototype,"popupEnabled",void 0);c.__decorate([d.property({type:D,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],b.prototype,"popupTemplate",void 0);c.__decorate([d.property({type:z})],b.prototype,"purgeOptions",void 0);c.__decorate([d.property({types:w.rendererTypes,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{name:"layerDefinition.drawingInfo.renderer",types:w.webSceneRendererTypes,write:!0}},write:{target:"layerDefinition.drawingInfo.renderer"}}})],
b.prototype,"renderer",null);c.__decorate([y.reader("service","renderer",["drawingInfo.renderer","defaultSymbol"]),y.reader("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],b.prototype,"readRenderer",null);c.__decorate([d.property(l.screenSizePerspectiveEnabled)],b.prototype,"screenSizePerspectiveEnabled",void 0);c.__decorate([d.property()],b.prototype,"sourceJSON",void 0);c.__decorate([d.property({type:A,json:{origins:{service:{read:{source:"spatialReference"}}}}})],
b.prototype,"spatialReference",void 0);c.__decorate([d.property({json:{read:!1}})],b.prototype,"type",void 0);c.__decorate([d.property(l.url)],b.prototype,"url",void 0);c.__decorate([d.property({type:Number})],b.prototype,"updateInterval",void 0);c.__decorate([d.property({type:String})],b.prototype,"webSocketUrl",void 0);b=c.__decorate([N.subclass("esri.layers.StreamLayer")],b);const v=O.createTypeReader({types:I.symbolTypesRenderer});return b});