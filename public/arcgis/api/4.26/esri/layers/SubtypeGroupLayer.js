// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Collection ../core/Error ../core/HandleOwner ../core/loadAll ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/sql ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/PropertyOrigin ./Layer ./mixins/APIKeyMixin ./mixins/ArcGISService ./mixins/BlendLayer ./mixins/CustomParametersMixin ./mixins/EditBusLayer ./mixins/FeatureLayerBase ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/featureLayerUtils ./support/fieldProperties ./support/fieldUtils ./support/Subtype ./support/SubtypeSublayer ./support/TimeInfo ./support/versionUtils ../rest/support/Query".split(" "),
function(B,n,f,u,p,e,C,w,D,x,y,E,z,g,r,ba,ca,F,G,v,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,h,V,W,X,t,Y,Z,aa){function A(c,k){return new p("layer:unsupported",`Layer (${c.title}, ${c.id}) of type '${c.declaredClass}' ${k}`,{layer:c})}r=V.defineFieldProperties();e=function(c){function k(...a){var b=q.call(this,...a);b._sublayersCollectionChanged=!1;b._sublayerLookup=new Map;b.fields=null;b.fieldsIndex=null;b.outFields=null;b.subtypes=null;b.sublayers=new (u.ofType(t));b.timeInfo=null;b.title="Layer";b.type="subtype-group";
b.addHandles(y.watch(()=>b.sublayers,(d,l)=>b._handleSublayersChange(d,l),y.sync));return b}n._inherits(k,c);var q=n._createSuper(k);c=k.prototype;c.destroy=function(){this.source?.destroy()};c.normalizeCtorArgs=function(a,b){return"string"===typeof a?{url:a,...b}:a};c.load=function(a){const b=w.isSome(a)?a.signal:null,d=this.loadFromPortal({supportedTypes:["Feature Service"]},a).catch(x.throwIfAbortError).then(async()=>{if(!this.url)throw new p("subtype-grouplayer:missing-url-or-source","SubtypeGroupLayer must be created with either a url or a portal item");
if(null==this.layerId)throw new p("subtype-grouplayer:missing-layerid","layerId is required for a SubtypeGroupLayer created with url");return this._initLayerProperties(await this.createGraphicsSource(b))}).then(()=>this._setUserPrivileges(this.serviceItemId,a)).then(()=>h.ensureLayerCredential(this,a));this.addResolvingPromise(d);return Promise.resolve(this)};c.readTitleFromService=function(a,{name:b}){return this.url?T.titleFromUrlAndName(this.url,b):b};c.addAttachment=async function(a,b){return h.addAttachment(this,
a,b,"SubtypeGroupLayer")};c.updateAttachment=async function(a,b,d){return h.updateAttachment(this,a,b,d,"SubtypeGroupLayer")};c.applyEdits=async function(a,b){return h.applyEdits(this,a,b)};c.on=function(a,b){return n._get(n._getPrototypeOf(k.prototype),"on",this).call(this,a,b)};c.createGraphicsSource=async function(a){const {default:b}=await x.whenOrAbort(new Promise((d,l)=>B(["./graphics/sources/FeatureLayerSource"],m=>d(Object.freeze(Object.defineProperty({__proto__:null,default:m},Symbol.toStringTag,
{value:"Module"}))),l)),a);return(new b({layer:this})).load({signal:a})};c.createQuery=function(){const a=h.createQuery(this),b=this.sublayers.map(d=>d.subtypeCode);a.where=E.sqlAnd(`${this.subtypeField} IN (${b.join(",")})`,this.definitionExpression);return a};c.deleteAttachments=async function(a,b){return h.deleteAttachments(this,a,b,"SubtypeGroupLayer")};c.fetchRecomputedExtents=async function(a){return h.fetchRecomputedExtents(this,a,"SubtypeGroupLayer")};c.getFieldDomain=function(a,b){return this._getLayerDomain(a)};
c.getField=function(a){return this.fieldsIndex.get(a)};c.findSublayerForFeature=function(a){const b=this.fieldsIndex.get(this.subtypeField);return this._sublayerLookup.get(a.attributes[b.name])};c.loadAll=function(){return C.loadAll(this,a=>{a(this.sublayers)})};c.queryAttachments=async function(a,b){return h.queryAttachments(this,a,b,"SubtypeGroupLayer")};c.queryFeatures=async function(a,b){const d=await this.load();a=aa.from(a)??d.createQuery();const l=w.unwrapOr(a.outFields,[]);l.includes(this.subtypeField)||
(l.push(this.subtypeField),a.outFields=l);b=await d.source.queryFeatures(a,b);if(b?.features)for(const m of b.features)m.layer=m.sourceLayer=this.findSublayerForFeature(m);return b};c.queryObjectIds=async function(a,b){return h.queryObjectIds(this,a,b,"SubtypeGroupLayer")};c.queryFeatureCount=async function(a,b){return h.queryFeatureCount(this,a,b,"SubtypeGroupLayer")};c.queryExtent=async function(a,b){return h.queryExtent(this,a,b,"SubtypeGroupLayer")};c.queryRelatedFeatures=async function(a,b){return h.queryRelatedFeatures(this,
a,b,"SubtypeGroupLayer")};c.queryRelatedFeaturesCount=async function(a,b){return h.queryRelatedFeaturesCount(this,a,b,"SubtypeGroupLayer")};c.write=function(a,b){const {origin:d,layerContainerType:l,messages:m}=b;if(this.isTable){if("web-scene"===d||"web-map"===d&&"tables"!==l)return m?.push(A(this,"using a table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&"web-map"===d&&"tables"===l)return m?.push(A(this,"using a non-table source cannot be written to tables in web maps")),
null;return this.sublayers?.length?n._get(n._getPrototypeOf(k.prototype),"write",this).call(this,a,b):(m?.push(new p("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)};c.serviceSupportsSpatialReference=function(a){return this.loaded?Z.serviceSupportsSpatialReference(this,a):!1};c._getLayerDomain=function(a){return(a=this.fieldsIndex.get(a))?
a.domain:null};c._initLayerProperties=async function(a){this._set("source",a);({sourceJSON:a}=a);a&&(this.sourceJSON=a,this.read(a,{origin:"service",url:this.parsedUrl}));if(this.isTable)throw new p("subtype-grouplayer:unsupported-source","SubtypeGroupLayer cannot be created using a layer with table source");if(!this.subtypes?.length)throw new p("subtype-grouplayer:missing-subtypes","SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields();W.fixTimeInfoFields(this.timeInfo,
this.fieldsIndex)};c.hasDataChanged=async function(){return h.hasDataChanged(this)};c._verifyFields=function(){const a=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+a+")");this.isTable||-1!==a.search(/\/FeatureServer\//i)||this.fields?.some(b=>"geometry"===b.type)||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+
a+")")};c._handleSublayersChange=function(a,b){b&&(b.forEach(d=>{d.parent=null}),this.handles.remove("sublayers-owner"),this._sublayerLookup.clear());a&&(a.forEach(d=>{d.parent=this;this._sublayerLookup.set(d.subtypeCode,d)}),this._sublayersCollectionChanged=!1,this.handles.add([a.on("after-add",({item:d})=>{d.parent=this;this._sublayerLookup.set(d.subtypeCode,d)}),a.on("after-remove",({item:d})=>{d.parent=null;this._sublayerLookup.delete(d.subtypeCode)}),a.on("after-changes",()=>{this._sublayersCollectionChanged=
!0})],"sublayers-owner"))};n._createClass(k,[{key:"createQueryVersion",get:function(){this.commitProperty("definitionExpression");this.commitProperty("timeExtent");this.commitProperty("timeOffset");this.commitProperty("geometryType");this.commitProperty("gdbVersion");this.commitProperty("historicMoment");this.commitProperty("returnZ");this.commitProperty("capabilities");this.commitProperty("returnM");return(this._get("createQueryVersion")??0)+1}},{key:"editingEnabled",get:function(){return this.loaded&&
null!=this.capabilities&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}},{key:"effectiveEditingEnabled",get:function(){return h.computeEffectiveEditingEnabled(this)}},{key:"parsedUrl",get:function(){const a=z.urlToObject(this.url);null!=a&&null!=this.layerId&&(a.path=z.join(a.path,this.layerId.toString()));return a}},{key:"source",set:function(a){this._get("source")!==a&&this._set("source",a)}}]);return k}(N.FeatureLayerBase(M.EditBusLayer(K.BlendLayer(S.TemporalLayer(R.ScaleRangeLayer(Q.RefreshableLayer(J.ArcGISService(O.OperationalLayer(P.PortalLayer(D.MultiOriginJSONMixin(L.CustomParametersMixin(I.APIKeyMixin(e.HandleOwnerMixin(H))))))))))))));
f.__decorate([g.property({readOnly:!0})],e.prototype,"createQueryVersion",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"editingEnabled",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"effectiveEditingEnabled",null);f.__decorate([g.property({...r.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],e.prototype,"fields",void 0);f.__decorate([g.property(r.fieldsIndex)],e.prototype,"fieldsIndex",void 0);f.__decorate([g.property(U.id)],e.prototype,"id",void 0);f.__decorate([g.property({type:["show",
"hide","hide-children"]})],e.prototype,"listMode",void 0);f.__decorate([g.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"]})],e.prototype,"operationalLayerType",void 0);f.__decorate([g.property(r.outFields)],e.prototype,"outFields",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"parsedUrl",null);f.__decorate([g.property()],e.prototype,"source",null);f.__decorate([g.property({type:[X],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],e.prototype,"subtypes",void 0);
f.__decorate([g.property({type:u.ofType(t),json:{origins:{service:{read:{source:"subtypes",reader:(c,k,q)=>{c=c.map(({code:a})=>{a=new t({subtypeCode:a});a.read(k,q);return a});return new (u.ofType(t))(c)}}}},name:"layers",write:{overridePolicy(c,k,q){k=this.originOf("sublayers");const a=v.OriginId.PORTAL_ITEM;let b=!0;v.nameToId(k)===a&&v.nameToId(q.origin)>a&&(c=c.some(d=>d.hasUserOverrides()),b=this._sublayersCollectionChanged||c);return{enabled:b,ignoreOrigin:!0}}}}})],e.prototype,"sublayers",
void 0);f.__decorate([g.property({type:Y})],e.prototype,"timeInfo",void 0);f.__decorate([g.property({json:{origins:{"portal-item":{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],e.prototype,"title",void 0);f.__decorate([F.reader("service","title",["name"])],e.prototype,"readTitleFromService",null);f.__decorate([g.property({json:{read:!1}})],e.prototype,"type",void 0);return e=f.__decorate([G.subclass("esri.layers.SubtypeGroupLayer")],e)});