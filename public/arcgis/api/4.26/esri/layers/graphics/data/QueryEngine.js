// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/arrayUtils ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/MemCache ../../../core/promiseUtils ../../../core/unitUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/normalizeUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/FieldsIndex ../../../support/arcadeOnDemand ../../../views/support/Scheduler".split(" "),
function(H,L,M,y,N,m,O,T,I,F,J,U,G,P,z,V,v,w,W,n,A,Q,r,X,Y,R){function Z(B){return null!=B&&B.every(g=>"exceedslimit"!==g.statisticType)}let aa=L._createClass(function(B,g=null,a,b,c){this.attributes=B;this.geometry=a;this.centroid=b;this.filterFlags=c;this.groupId=-1;this.displayId=g});const ba=new O.MemCacheStorage(2E6);let ca=0,ha=function(){function B(a){this._changeHandle=this._geometryQueryCache=null;this.capabilities={query:W.queryCapabilities};this.geometryType=a.geometryType;this.hasM=!!a.hasM;
this.hasZ=!!a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.featureStore=a.featureStore;this.aggregateAdapter=a.aggregateAdapter;this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache());this.timeInfo=a.timeInfo;a.cacheSpatialQueries&&(this._geometryQueryCache=new O.MemCache(ca++ +"$$",ba));this.fieldsIndex=new X(a.fields);a.scheduler&&a.priority&&(this._frameTask=a.scheduler.registerTask(a.priority))}
var g=B.prototype;g.destroy=function(){this._frameTask=m.removeMaybe(this._frameTask);this.clearCache();m.destroyMaybe(this._geometryQueryCache);this._changeHandle=m.removeMaybe(this._changeHandle);m.destroyMaybe(this.fieldsIndex)};g.clearCache=function(){this._geometryQueryCache?.clear();this._timeExtentPromise=this._allFeaturesPromise=null};g.executeQuery=async function(a,b){try{return(await this._executeQuery(a,{},b)).createQueryResponse()}catch(c){if(c!==r.QUERY_ENGINE_EMPTY_RESULT)throw c;return(new n.QueryEngineResult([],
a,this)).createQueryResponse()}};g.executeQueryForCount=async function(a={},b){try{return(await this._executeQuery(a,{returnGeometry:!1,returnCentroid:!1,outSR:null},b)).createQueryResponseForCount()}catch(c){if(c!==r.QUERY_ENGINE_EMPTY_RESULT)throw c;return 0}};g.executeQueryForExtent=async function(a,b){const c=a.outSR;try{const d=await this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},b),e=d.size;if(!e)return{count:0,extent:null};const f=await this._getBounds(d.items,d.spatialReference,
c||this.spatialReference);return{count:e,extent:f}}catch(d){if(d===r.QUERY_ENGINE_EMPTY_RESULT)return{count:0,extent:null};throw d;}};g.executeQueryForIds=async function(a,b){return this.executeQueryForIdSet(a,b).then(c=>Array.from(c))};g.executeQueryForIdSet=async function(a,b){try{const c=await this._executeQuery(a,{returnGeometry:!0,returnCentroid:!1,outSR:null},b),d=c.items,e=new Set;await this._reschedule(()=>{for(const f of d)e.add(c.featureAdapter.getObjectId(f))},b);return e}catch(c){if(c===
r.QUERY_ENGINE_EMPTY_RESULT)return new Set;throw c;}};g.executeQueryForSnapping=async function(a,b){const {point:c,distance:d,types:e}=a;if(e===n.SnappingTypes.NONE)return{candidates:[]};const f=await this._reschedule(()=>this._checkQuerySupport(a.query),b),h=!z.equals(c.spatialReference,this.spatialReference);h&&await w.checkProjectionSupport(c.spatialReference,this.spatialReference);var l="number"===typeof d?d:d.x,k="number"===typeof d?d:d.y;l={xmin:c.x-l,xmax:c.x+l,ymin:c.y-k,ymax:c.y+k,spatialReference:c.spatialReference};
l=h?w.project(l,this.spatialReference):l;if(!l)return{candidates:[]};k=(await P.normalizeCentralMeridian(G.fromJSON(c),null,{signal:b}))[0];const p=(await P.normalizeCentralMeridian(G.fromJSON(l),null,{signal:b}))[0];if(m.isNone(k)||m.isNone(p))return{candidates:[]};const q=new n.QueryEngineResult(await this._reschedule(()=>this._searchFeatures(this._getQueryBBoxes(p.toJSON())),b),f,this);await this._reschedule(()=>this._executeObjectIdsQuery(q),b);await this._reschedule(()=>this._executeTimeQuery(q),
b);await this._reschedule(()=>this._executeAttributesQuery(q),b);b=k.toJSON();b=h?w.project(b,this.spatialReference):b;return q.createSnappingResponse({...a,point:b,distance:h?Math.max(l.xmax-l.xmin,l.ymax-l.ymin)/2:d},c.spatialReference)};g.executeQueryForLatestObservations=async function(a,b){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new y("feature-store:unsupported-query","Missing timeInfo or timeInfo.trackIdField",{query:a,timeInfo:this.timeInfo});try{const c=await this._executeQuery(a,
{},b);await this._reschedule(()=>this._filterLatest(c),b);return c.createQueryResponse()}catch(c){if(c!==r.QUERY_ENGINE_EMPTY_RESULT)throw c;return(new n.QueryEngineResult([],a,this)).createQueryResponse()}};g.executeQueryForSummaryStatistics=async function(a={},b,c){const {field:d,normalizationField:e,valueExpression:f}=b;return(await this._getQueryEngineResultForStats(a,{field:d,normalizationField:e,valueExpression:f},c)).createSummaryStatisticsResponse(b)};g.executeQueryForUniqueValues=async function(a=
{},b,c){const {field:d,field2:e,field3:f,valueExpression:h}=b;return(await this._getQueryEngineResultForStats(a,{field:d,field2:e,field3:f,valueExpression:h},c)).createUniqueValuesResponse(b)};g.executeQueryForClassBreaks=async function(a={},b,c){const {field:d,normalizationField:e,valueExpression:f}=b;return(await this._getQueryEngineResultForStats(a,{field:d,normalizationField:e,valueExpression:f},c)).createClassBreaksResponse(b)};g.executeQueryForHistogram=async function(a={},b,c){const {field:d,
normalizationField:e,valueExpression:f}=b;return(await this._getQueryEngineResultForStats(a,{field:d,normalizationField:e,valueExpression:f},c)).createHistogramResponse(b)};g.fetchRecomputedExtents=async function(a){const [b,c]=await Promise.all(["getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getBounds(await this._getAllFeatures(),this.spatialReference,this.spatialReference),m.isSome(this._timeExtentPromise)?
this._timeExtentPromise:this._timeExtentPromise=Q.getTimeExtent(this.timeInfo,this.featureStore)]);T.throwIfAborted(a);return{fullExtent:b,timeExtent:c}};g._getBounds=async function(a,b,c){const d=F.set(F.create(),F.NEGATIVE_INFINITY);await this.featureStore.forEachBounds(a,e=>F.expandWithAABB(d,e));a={xmin:d[0],ymin:d[1],xmax:d[3],ymax:d[4],spatialReference:r.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(d[2])&&isFinite(d[5])&&(a.zmin=d[2],a.zmax=d[5]);b=w.project(a,b,c);b.spatialReference=
r.cleanFromGeometryEngine(c);0===b.xmax-b.xmin&&(c=I.getMetersPerUnitForSR(b.spatialReference),b.xmin-=c,b.xmax+=c);0===b.ymax-b.ymin&&(c=I.getMetersPerUnitForSR(b.spatialReference),b.ymin-=c,b.ymax+=c);this.hasZ&&null!=b.zmin&&null!=b.zmax&&0===b.zmax-b.zmin&&(c=I.getMetersPerUnitForSR(b.spatialReference),b.zmin-=c,b.zmax+=c);return b};g._schedule=async function(a,b){return m.isSome(this._frameTask)?this._frameTask.schedule(a,b):a(R.noBudget)};g._reschedule=async function(a,b){return m.isSome(this._frameTask)?
this._frameTask.reschedule(a,b):a(R.noBudget)};g._getAllFeaturesQueryEngineResult=async function(a){return new n.QueryEngineResult(await this._getAllFeatures(),a,this)};g._getAllFeatures=async function(){if(m.isNone(this._allFeaturesPromise)){const c=[];this._allFeaturesPromise=(async()=>{await this.featureStore.forEach(d=>c.push(d))})().then(()=>c)}const a=this._allFeaturesPromise,b=await a;return a===this._allFeaturesPromise?b.slice():this._getAllFeatures()};g._executeQuery=async function(a,b,c){a=
N.clone(a);a=await this._schedule(()=>r.normalizeQuery(a,this.definitionExpression,this.spatialReference),c);a=await this._reschedule(()=>this._checkQuerySupport(a),c);a={...a,...b};const d=await this._reschedule(()=>this._executeSceneFilterQuery(a,c),c),e=await this._reschedule(()=>this._executeGeometryQuery(a,d,c),c);await this._reschedule(()=>this._executeAggregateIdsQuery(e),c);await this._reschedule(()=>this._executeObjectIdsQuery(e),c);await this._reschedule(()=>this._executeTimeQuery(e),c);
await this._reschedule(()=>this._executeAttributesQuery(e),c);return e};g._executeSceneFilterQuery=async function(a,b){if(m.isNone(a.sceneFilter))return null;const {outSR:c,returnGeometry:d,returnCentroid:e}=a;var f=this.featureStore.featureSpatialReference,h=a.sceneFilter.geometry;const l=m.isNone(f)||z.equals(f,h.spatialReference)?h:w.project(h,f);if(!l)return null;f=d||e;f=z.isValid(c)&&!z.equals(this.spatialReference,c)&&f?async t=>this._project(t,c):t=>t;const k=this.featureAdapter;h=await this._reschedule(()=>
this._searchFeatures(this._getQueryBBoxes(l)),b);if("disjoint"===a.sceneFilter.spatialRelationship){if(!h.length)return null;const t=new Set;for(var p of h)t.add(k.getObjectId(p));const C=await this._reschedule(()=>this._getAllFeatures(),b);p=await this._reschedule(async()=>{const E=await A.getSpatialQueryOperator("esriSpatialRelDisjoint",l,this.geometryType,this.hasZ,this.hasM),x=await this._runSpatialFilter(C,D=>!t.has(k.getObjectId(D))||E(k.getGeometry(D)),b);return new n.QueryEngineResult(x,a,
this)},b);return f(p)}if(!h.length)return new n.QueryEngineResult([],a,this);if(this._canExecuteSinglePass(l,a))return f(new n.QueryEngineResult(h,a,this));const q=await A.getSpatialQueryOperator("esriSpatialRelContains",l,this.geometryType,this.hasZ,this.hasM);p=await this._runSpatialFilter(h,t=>q(k.getGeometry(t)),b);return f(new n.QueryEngineResult(p,a,this))};g._executeGeometryQuery=async function(a,b,c){if(m.isSome(b)&&0===b.items.length)return b;a=m.isSome(b)?b.query:a;const {geometry:d,outSR:e,
spatialRel:f,returnGeometry:h,returnCentroid:l}=a;var k=this.featureStore.featureSpatialReference;const p=!d||m.isNone(k)||z.equals(k,d.spatialReference)?d:w.project(d,k),q=h||l,t=z.isValid(e)&&!z.equals(this.spatialReference,e),C=this._geometryQueryCache&&m.isNone(b)?t&&q?JSON.stringify({originalFilterGeometry:d,spatialRelationship:f,outSpatialReference:e}):JSON.stringify({originalFilterGeometry:d,spatialRelationship:f}):null;k=C?this._geometryQueryCache.get(C):null;if(m.isSome(k))return new n.QueryEngineResult(k,
a,this);k=async u=>{t&&q&&await this._project(u,e);C&&this._geometryQueryCache.put(C,u.items,u.items.length+1);return u};if(!p)return k(m.isSome(b)?b:await this._getAllFeaturesQueryEngineResult(a));const E=this.featureAdapter;let x=await this._reschedule(()=>this._searchFeatures(this._getQueryBBoxes(d)),c);if("esriSpatialRelDisjoint"===f){if(!x.length)return k(m.isSome(b)?b:await this._getAllFeaturesQueryEngineResult(a));const u=new Set;for(var D of x)u.add(E.getObjectId(D));const K=m.isSome(b)?b.items:
await this._reschedule(()=>this._getAllFeatures(),c);D=await this._reschedule(async()=>{const da=await A.getSpatialQueryOperator(f,p,this.geometryType,this.hasZ,this.hasM),ea=await this._runSpatialFilter(K,S=>!u.has(E.getObjectId(S))||da(E.getGeometry(S)),c);return new n.QueryEngineResult(ea,a,this)},c);return k(D)}if(m.isSome(b)){const u=new M.PositionHint;x=x.filter(K=>0<=M.indexOf(b.items,K,b.items.length,u))}if(!x.length)return k=new n.QueryEngineResult([],a,this),C&&this._geometryQueryCache.put(C,
k.items,1),k;if(this._canExecuteSinglePass(p,a))return k(new n.QueryEngineResult(x,a,this));const fa=await A.getSpatialQueryOperator(f,p,this.geometryType,this.hasZ,this.hasM);D=await this._runSpatialFilter(x,u=>fa(E.getGeometry(u)),c);return k(new n.QueryEngineResult(D,a,this))};g._executeAggregateIdsQuery=function(a){if(0!==a.items.length&&a.query.aggregateIds&&a.query.aggregateIds.length&&!m.isNone(this.aggregateAdapter)){var b=new Set;for(const d of a.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(d).forEach(e=>
b.add(e));var c=this.featureAdapter.getObjectId;a.items=a.items.filter(d=>b.has(c(d)))}};g._executeObjectIdsQuery=function(a){if(0!==a.items.length&&a.query.objectIds&&a.query.objectIds.length){var b=new Set(a.query.objectIds),c=this.featureAdapter.getObjectId;a.items=a.items.filter(d=>b.has(c(d)))}};g._executeTimeQuery=function(a){if(0!==a.items.length){var b=Q.getTimeOperator(this.timeInfo,a.query.timeExtent,this.featureAdapter);m.isNone(b)||(a.items=a.items.filter(b))}};g._executeAttributesQuery=
function(a){if(0!==a.items.length){var b=v.getWhereClause(a.query.where,this.fieldsIndex);if(b){if(!b.isStandardized)throw new TypeError("Where clause is not standardized");a.items=a.items.filter(c=>b.testFeature(c,this.featureAdapter))}}};g._runSpatialFilter=async function(a,b,c){if(!b)return a;if(m.isNone(this._frameTask))return a.filter(h=>b(h));let d=0;const e=[],f=async h=>{for(;d<a.length;){const l=a[d++];b(l)&&(e.push(l),h.madeProgress());h.done&&await this._reschedule(k=>f(k),c)}};return this._reschedule(h=>
f(h),c).then(()=>e)};g._filterLatest=function(a){const {trackIdField:b,startTimeField:c,endTimeField:d}=this.timeInfo,e=d||c,f=new Map,h=this.featureAdapter.getAttribute;for(const l of a.items){const k=h(l,b),p=h(l,e),q=f.get(k);(!q||p>h(q,e))&&f.set(k,l)}a.items=Array.from(f.values())};g._canExecuteSinglePass=function(a,b){({spatialRel:b}=b);return A.canQueryWithRBush(a)&&("esriSpatialRelEnvelopeIntersects"===b||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===
b||"esriSpatialRelWithin"===b))};g._project=async function(a,b){if(!b||z.equals(this.spatialReference,b))return a;const c=this.featureAdapter;b=await w.projectMany(a.items.map(d=>r.getGeometry(this.geometryType,this.hasZ,this.hasM,c.getGeometry(d))),this.spatialReference,b);a.items=b.map((d,e)=>c.cloneWithGeometry(a.items[e],V.convertFromGeometry(d,this.hasZ,this.hasM)));return a};g._getQueryBBoxes=function(a){if(A.canQueryWithRBush(a)){if(G.isExtent(a))return[J.fromValues(a.xmin,a.ymin,a.xmax,a.ymax)];
if(G.isPolygon(a))return a.rings.map(b=>J.fromValues(Math.min(b[0][0],b[2][0]),Math.min(b[0][1],b[2][1]),Math.max(b[0][0],b[2][0]),Math.max(b[0][1],b[2][1])))}return[U.getBoundsXY(J.create(),a)]};g._searchFeatures=async function(a){const b=new Set;await Promise.all(a.map(c=>this.featureStore.forEachInBounds(c,d=>b.add(d))));a=Array.from(b.values());b.clear();return a};g._checkStatisticsSupport=async function(a,b){if(0>(a.distance??0)||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||
a.text||a.outStatistics||a.groupByFieldsForStatistics||a.having||a.orderByFields)throw new y("feature-store:unsupported-query","Unsupported query options",{query:a});this._checkAttributesQuerySupport(a);return Promise.all([this._checkStatisticsParamsSupport(b),A.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),w.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)};g._checkStatisticsParamsSupport=async function(a){var b=[];a.valueExpression&&({arcadeUtils:b}=await Y.loadArcade(),
b=b.extractFieldNames(a.valueExpression));a.field&&b.push(a.field);a.field2&&b.push(a.field2);a.field3&&b.push(a.field3);a.normalizationField&&b.push(a.normalizationField);if(!b.length)throw new y("feature-store:unsupported-query","params should have at least a field or valueExpression",{params:a});v.validateFields(this.fieldsIndex,b,"params contains missing fields")};g._checkQuerySupport=async function(a){if(0>(a.distance??0)||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||
a.text)throw new y("feature-store:unsupported-query","Unsupported query options",{query:a});this._checkAttributesQuerySupport(a);this._checkStatisticsQuerySupport(a);return Promise.all([A.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),w.checkProjectionSupport(this.spatialReference,a.outSR)]).then(()=>a)};g._checkAttributesQuerySupport=function(a){const {outFields:b,orderByFields:c,returnDistinctValues:d,outStatistics:e}=a,f=e?e.map(h=>h.outStatisticFieldName&&h.outStatisticFieldName.toLowerCase()).filter(Boolean):
[];if(c&&0<c.length){const h=c.map(l=>{const k=l.toLowerCase();return k.includes(" asc")?k.split(" asc")[0]:k.includes(" desc")?k.split(" desc")[0]:l}).filter(l=>!f.includes(l));v.validateFields(this.fieldsIndex,h,"orderByFields contains missing fields")}if(b&&0<b.length)v.validateFields(this.fieldsIndex,b,"outFields contains missing fields");else if(d)throw new y("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});v.validateWhere(this.fieldsIndex,
a.where)};g._checkStatisticsQuerySupport=function(a){const {outStatistics:b,groupByFieldsForStatistics:c,having:d}=a;var e=c&&c.length,f=b&&b.length;if(d){if(!e||!f)throw new y("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});v.validateHaving(this.fieldsIndex,d,b)}if(f&&Z(b)){f=b.map(h=>h.onStatisticField).filter(Boolean);v.validateFields(this.fieldsIndex,f,"onStatisticFields contains missing fields");e&&v.validateFields(this.fieldsIndex,
c,"groupByFieldsForStatistics contains missing fields");for(const h of b){const {onStatisticField:l,statisticType:k}=h;if(("percentile_disc"===k||"percentile_cont"===k)&&"statisticParameters"in h){if({statisticParameters:e}=h,!e)throw new y("feature-store:unsupported-query","statisticParamters should be set for percentile type",{definition:h,query:a});}else if("count"!==k&&l&&v.hasInvalidFieldType(l,this.fieldsIndex))throw new y("feature-store:unsupported-query","outStatistics contains non-numeric fields",
{definition:h,query:a});}}};g._getQueryEngineResultForStats=async function(a,b,c){a=N.clone(a);try{a=await this._schedule(()=>r.normalizeQuery(a,this.definitionExpression,this.spatialReference),c);a=await this._reschedule(()=>this._checkStatisticsSupport(a,b),c);const d=await this._reschedule(()=>this._executeSceneFilterQuery(a,c),c),e=await this._reschedule(()=>this._executeGeometryQuery(a,d,c),c);await this._reschedule(()=>this._executeAggregateIdsQuery(e),c);await this._reschedule(()=>this._executeObjectIdsQuery(e),
c);await this._reschedule(()=>this._executeTimeQuery(e),c);await this._reschedule(()=>this._executeAttributesQuery(e),c);return e}catch(d){if(d!==r.QUERY_ENGINE_EMPTY_RESULT)throw d;return new n.QueryEngineResult([],a,this)}};L._createClass(B,[{key:"featureAdapter",get:function(){return this.featureStore.featureAdapter}}]);return B}();H.Feature=aa;H.QueryEngine=ha;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});