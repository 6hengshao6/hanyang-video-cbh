// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/HandleOwner ../../../core/has ../../../core/Loadable ../../../core/maybe ../../../core/promiseUtils ../../../core/workers/workers ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/typeUtils ./support/clientSideDefaults ../../ogc/wfsUtils ../../../rest/support/FeatureSet ../../../geometry/Extent".split(" "),
function(e,n,g,K,v,w,x,y,q,r,z,h,L,M,A,B,t,l,C,D){e.WFSSource=function(d){function m(){var a=E.apply(this,arguments);a._connection=null;a.capabilities=t.createCapabilities(!1,!1);a.type="wfs";a.refresh=r.debounce(async b=>{await a.load();({extent:b}=await a._connection.invoke("refresh",b));b&&(a.sourceJSON.extent=b);return{dataChanged:!0,updates:{extent:a.sourceJSON.extent}}});return a}n._inherits(m,d);var E=n._createSuper(m);d=m.prototype;d.load=function(a){a=q.isSome(a)?a.signal:null;this.addResolvingPromise(this._startWorker({signal:a}));
return Promise.resolve(this)};d.destroy=function(){this._connection?.close();this._connection=null};d.openPorts=async function(){await this.load();return this._connection.openPorts()};d.queryFeatures=async function(a,b={}){await this.load(b);a=await this._connection.invoke("queryFeatures",a?a.toJSON():null,b);return C.fromJSON(a)};d.queryFeaturesJSON=async function(a,b={}){await this.load(b);return this._connection.invoke("queryFeatures",a?a.toJSON():null,b)};d.queryFeatureCount=async function(a,
b={}){await this.load(b);return this._connection.invoke("queryFeatureCount",a?a.toJSON():null,b)};d.queryObjectIds=async function(a,b={}){await this.load(b);return this._connection.invoke("queryObjectIds",a?a.toJSON():null,b)};d.queryExtent=async function(a,b={}){await this.load(b);a=await this._connection.invoke("queryExtent",a?a.toJSON():null,b);return{count:a.count,extent:D.fromJSON(a.extent)}};d.querySnapping=async function(a,b={}){await this.load(b);return this._connection.invoke("querySnapping",
a,b)};d._createLoadOptions=async function(a){const {url:b,customParameters:f,name:c,namespaceUri:k,spatialReference:u,fields:F,geometryType:G,swapXY:H}=this.layer;if(!b)throw new v("wfs-layer:missing-url","WFSLayer must be created with a url");this.wfsCapabilities||(this.wfsCapabilities=await l.getCapabilities(b,{customParameters:f,...a}));a="fields geometryType name namespaceUri spatialReference swapXY".split(" ").some(p=>null==this.layer[p])?await l.getWFSLayerInfo(this.wfsCapabilities,c,k,{spatialReference:u,
customParameters:f,signal:a?.signal}):{...l.prepareWFSLayerFields(F??[]),geometryType:G,name:c,namespaceUri:k,spatialReference:u,swapXY:H};const I=q.unwrap(l.findFeatureType(this.wfsCapabilities.readFeatureTypes(),a.name,a.namespaceUri)),J=B.featureGeometryTypeKebabDictionary.toJSON(a.geometryType);return{customParameters:f,featureType:I,fields:a.fields?.map(p=>p.toJSON())??[],geometryField:a.geometryField,geometryType:J,getFeatureUrl:this.wfsCapabilities.operations.GetFeature.url,getFeatureOutputFormat:this.wfsCapabilities.operations.GetFeature.outputFormat,
objectIdField:a.objectIdField,spatialReference:a.spatialReference.toJSON(),swapXY:!!a.swapXY}};d._startWorker=async function(a){const [b,f]=await r.eachAlways([this._createLoadOptions(a),z.open("WFSSourceWorker",{...a,strategy:x("feature-layers-workers")?"dedicated":"local"})]);var c=b.error||f.error||null;const k=f.value||null;if(c)throw k&&k.close(),c;c=b.value;this._connection=f.value;this.sourceJSON={extent:(await this._connection.invoke("load",c,a)).extent,fields:c.fields,geometryType:c.geometryType,
objectIdField:c.objectIdField,geometryField:c.geometryField,drawingInfo:t.createDrawingInfo(c.geometryType),name:c.featureType.title,wfsInfo:{name:c.featureType.name,featureUrl:c.getFeatureUrl,maxFeatures:3E3,swapXY:c.swapXY,supportedSpatialReferences:c.featureType.supportedSpatialReferences,version:"2.0.0",wfsNamespace:c.featureType.namespaceUri}}};return n._createClass(m)}(w.HandleOwnerMixin(y));g.__decorate([h.property()],e.WFSSource.prototype,"capabilities",void 0);g.__decorate([h.property({constructOnly:!0})],
e.WFSSource.prototype,"layer",void 0);g.__decorate([h.property()],e.WFSSource.prototype,"sourceJSON",void 0);g.__decorate([h.property()],e.WFSSource.prototype,"type",void 0);g.__decorate([h.property()],e.WFSSource.prototype,"wfsCapabilities",void 0);e.WFSSource=g.__decorate([A.subclass("esri.layers.graphics.sources.WFSSource")],e.WFSSource);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});