// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../kernel ../../../request ../../../TimeExtent ../../../core/Error ../../../core/has ../../../core/jsonMap ../../../core/Loadable ../../../core/maybe ../../../core/object ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/jsonUtils ../assetEditingSupport ./support/clientSideDefaults ./support/QueryTask ../../support/arcgisLayerUrl ../../../rest/query/operations/editsZScale ../../../geometry/SpatialReference".split(" "),
function(z,x,w,F,G,q,H,t,C,D,I,m,J,K,y,A,X,Y,L,M,N,O,P,Q,R,S,T){async function E(f){return"string"===typeof f?y.dataComponents(f)??{data:f}:new Promise((u,B)=>{const a=new FileReader;a.readAsDataURL(f);a.onload=()=>u(y.dataComponents(a.result));a.onerror=b=>B(b)})}const U=new D.JSONMap({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),V=new Set(["Feature Layer","Table"]),W=new D.JSONMap({Started:"published",Publishing:"publishing",Stopped:"unavailable"});w=function(f){function u(){var a=
B.apply(this,arguments);a.type="feature-layer";a.refresh=K.debounce(async()=>{await a.load();var b=a.sourceJSON.editingInfo?.lastEditDate;if(null==b)return{dataChanged:!0,updates:{}};try{await a._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}b=b!==a.sourceJSON.editingInfo?.lastEditDate;return{dataChanged:b,updates:b?{editingInfo:a.sourceJSON.editingInfo,extent:a.sourceJSON.extent}:null}});return a}z._inherits(u,f);var B=z._createSuper(u);f=u.prototype;f.load=function(a){a=m.isSome(a)?
a.signal:null;this.addResolvingPromise(this._fetchService(this.layer.sourceJSON,a));return Promise.resolve(this)};f.addAttachment=async function(a,b){await this.load();a=a.attributes[this.layer.objectIdField];const d=this.layer.parsedUrl.path+"/"+a+"/addAttachment",e=this._getLayerRequestOptions();b=this._getFormDataForAttachment(b,e.query);try{const c=await q(d,{body:b});return this._createFeatureEditResult(c.data.addAttachmentResult)}catch(c){throw this._createAttachmentErrorResult(a,c);}};f.updateAttachment=
async function(a,b,d){await this.load();a=a.attributes[this.layer.objectIdField];const e=this.layer.parsedUrl.path+"/"+a+"/updateAttachment";b=this._getLayerRequestOptions({query:{attachmentId:b}});d=this._getFormDataForAttachment(d,b.query);try{const c=await q(e,{body:d});return this._createFeatureEditResult(c.data.updateAttachmentResult)}catch(c){throw this._createAttachmentErrorResult(a,c);}};f.applyEdits=async function(a,b){await this.load();const d=this.layer.infoFor3D;var e=m.isSome(d),c=e||
(b?.globalIdUsed??!1),g=a.addFeatures?.map(l=>this._serializeFeature(l,d)).filter(m.isSome)??[],h=a.updateFeatures?.map(l=>this._serializeFeature(l,d)).filter(m.isSome)??[];const k=this._getFeatureIds(a.deleteFeatures,c);S.unapplyEditsZUnitScaling(g,h,this.layer.spatialReference);var p=[],v=[],r=[...(a.deleteAttachments??[])];for(const l of a.addAttachments??[])p.push(await this._serializeAttachment(l));for(const l of a.updateAttachments??[])v.push(await this._serializeAttachment(l));v=p.length||
v.length||r.length?{adds:p,updates:v,deletes:r}:null;r=void 0;p=null;if(e){p=new Map;r=[];for(const l of a.addAssets??[])r.push(this._serializeAssetMapEditAndUploadAssets(l,p));a=await Promise.all(r);r=a.length?{adds:a,updates:[],deletes:[]}:void 0}a={gdbVersion:b?.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:b?.rollbackOnFailureEnabled,useGlobalIds:c,returnEditMoment:b?.returnEditMoment,usePreviousEditMoment:b?.usePreviousEditMoment,sessionId:b?.sessionId};b?.returnServiceEditsOption?(a.edits=
JSON.stringify([{id:this.layer.layerId,adds:g,updates:h,deletes:k,attachments:v,assetMaps:m.unwrap(r)}]),a.returnServiceEditsOption=U.toJSON(b?.returnServiceEditsOption),a.returnServiceEditsInSourceSR=b?.returnServiceEditsInSourceSR):(a.adds=g.length?JSON.stringify(g):null,a.updates=h.length?JSON.stringify(h):null,a.deletes=k.length?c?JSON.stringify(k):k.join(","):null,a.attachments=v&&JSON.stringify(v),a.assetMaps=m.isSome(r)?JSON.stringify(r):void 0);g=this._getLayerRequestOptions({method:"post",
query:a});c=b?.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path;b=await q(c+"/applyEdits",g);!this.layer.capabilities.operations?.supportsEditing&&this.layer.effectiveCapabilities?.operations?.supportsEditing&&await G.id?.findCredential(this.layer.url)?.refreshToken();if(e&&null!=b.data&&null!=b.data.assetMaps){h=b.data;e=this.layer.objectIdField;g=[];for(var n of h.addResults)n.success&&g.push(n.objectId);for(const l of h.updateResults)l.success&&g.push(l.objectId);n=this._createRequestQueryOptions();
if((n=await q(c+"/query",{...n,query:{f:"json",formatOf3DObjects:"3D_glb",where:`OBJECTID IN (${g.join(",")})`,outFields:`${e}`}}))&&n.data&&n.data.assetMaps&&m.isSome(p)){n=n.data.assetMaps;for(const l of n)n=p.get(l.parentGlobalId).geometry,m.isSome(n)&&"mesh"===n.type&&n.updateExternalSource({source:[{name:l.assetName,source:l.assetName}],extent:n.extent})}}return this._createEditsResult(b)};f.deleteAttachments=async function(a,b){await this.load();a=a.attributes[this.layer.objectIdField];const d=
this.layer.parsedUrl.path+"/"+a+"/deleteAttachments";try{return(await q(d,this._getLayerRequestOptions({query:{attachmentIds:b.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(e){throw this._createAttachmentErrorResult(a,e);}};f.fetchRecomputedExtents=function(a={}){return this.load({signal:a.signal}).then(async()=>{var b=this._getLayerRequestOptions({...a,query:{returnUpdates:!0}});const {layerId:d,url:e}=this.layer;({data:b}=await q(`${e}/${d}`,
b));const {id:c,extent:g,fullExtent:h,timeExtent:k}=b;b=g||h;return{id:c,fullExtent:b&&M.fromJSON(b),timeExtent:k&&H.fromJSON({start:k[0],end:k[1]})}})};f.queryAttachments=async function(a,b={}){await this.load();b=this._getLayerRequestOptions(b);return this.queryTask.executeAttachmentQuery(a,b)};f.queryFeatures=async function(a,b){await this.load();return this.queryTask.execute(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryFeaturesJSON=async function(a,b){await this.load();return this.queryTask.executeJSON(a,
{...b,query:this._createRequestQueryOptions(b)})};f.queryObjectIds=async function(a,b){await this.load();return this.queryTask.executeForIds(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryFeatureCount=async function(a,b){await this.load();return this.queryTask.executeForCount(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryExtent=async function(a,b){await this.load();return this.queryTask.executeForExtent(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryRelatedFeatures=
async function(a,b){await this.load();return this.queryTask.executeRelationshipQuery(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryRelatedFeaturesCount=async function(a,b){await this.load();return this.queryTask.executeRelationshipQueryForCount(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryTopFeatures=async function(a,b){await this.load();return this.queryTask.executeTopFeaturesQuery(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryTopObjectIds=async function(a,
b){await this.load();return this.queryTask.executeForTopIds(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryTopExtents=async function(a,b){await this.load();return this.queryTask.executeForTopExtents(a,{...b,query:this._createRequestQueryOptions(b)})};f.queryTopCount=async function(a,b){await this.load();return this.queryTask.executeForTopCount(a,{...b,query:this._createRequestQueryOptions(b)})};f.fetchPublishingStatus=async function(){if(!R.isHostedAgolService(this.layer.url))return"unavailable";
var a=y.join(this.layer.url,"status");a=await q(a,{query:{f:"json"}});return W.fromJSON(a.data.status)};f._createRequestQueryOptions=function(a){a={...this.layer.customParameters,token:this.layer.apiKey,...a?.query};this.layer.datesInUnknownTimezone&&(a.timeReferenceUnknownClient=!0);return a};f._fetchService=async function(a,b){a||({data:a}=await q(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:C("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:b})));this.sourceJSON=
this._patchServiceJSON(a);a=a.type;if(!V.has(a))throw new t("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`);};f._patchServiceJSON=function(a){if("Table"!==a.type&&a.geometryType&&!a?.drawingInfo?.renderer&&!a.defaultSymbol){const b=P.createDrawingInfo(a.geometryType).renderer;J.setDeepValue("drawingInfo.renderer",b,a)}"esriGeometryMultiPatch"===a.geometryType&&a.infoFor3D&&(a.geometryType="mesh");return a};f._serializeFeature=function(a,b){const {geometry:d,attributes:e}=
a;if(m.isSome(b)&&m.isSome(a.geometry)&&"mesh"===a.geometry.type){const g={...e};a=a.geometry;var c=a.origin;a=a.transform;g[b.transformFieldRoles.originX]=c.x;g[b.transformFieldRoles.originY]=c.y;g[b.transformFieldRoles.originZ]=c.z;if(m.isSome(a)){c=a.translation;const h=a.scale;a=a.rotation;g[b.transformFieldRoles.translationX]=c[0];g[b.transformFieldRoles.translationY]=-c[2];g[b.transformFieldRoles.translationZ]=c[1];g[b.transformFieldRoles.scaleX]=h[0];g[b.transformFieldRoles.scaleY]=h[1];g[b.transformFieldRoles.scaleZ]=
h[2];g[b.transformFieldRoles.rotationX]=a[0];g[b.transformFieldRoles.rotationY]=a[2];g[b.transformFieldRoles.rotationZ]=a[1];g[b.transformFieldRoles.rotationDeg]=a[3]}return{geometry:null,attributes:g}}return m.isNone(d)?{attributes:e}:"mesh"===d.type||"extent"===d.type?null:{geometry:d.toJSON(),attributes:e}};f._serializeAttachment=async function(a){const {feature:b,attachment:d}=a,{globalId:e,name:c,contentType:g,data:h,uploadId:k}=d;a={globalId:e,parentGlobalId:null,contentType:null,name:null,
uploadId:null,data:null};b&&(a.parentGlobalId="attributes"in b?b.attributes&&b.attributes[this.layer.globalIdField]:b.globalId);if(k)a.uploadId=k;else if(h){const p=await E(h);p&&(a.contentType=p.mediaType,a.data=p.data);h instanceof File&&(a.name=h.name)}c&&(a.name=c);g&&(a.contentType=g);return a};f._serializeAssetMapEditAndUploadAssets=async function(a,b){var d=this.layer.url,e=null;try{const c=new Blob([a.data],{type:a.mimeType}),g=new FormData;g.append("f","json");g.append("file",c,`${a.assetName}`);
const {data:h}=await q(`${d}/uploads/upload`,{body:g,method:"post",responseType:"json"});if(!h.success)throw new t("feature-layer-source:upload-failure","Expected upload to be successfull.");e={assetType:a.assetType,assetUploadId:h.item.itemID}}catch(c){e=null}if(m.isNone(e)){d=await E(new Blob([a.data]));if(!d.isBase64)throw new t("feature-layer-source:uploadAssets-failure","Expected gltf data in base64 format after conversion.");e={assetType:a.assetType,assetData:d.data}}if(m.isNone(e))throw new t("feature-layer-source:uploadAssets-failure",
"Unable to prepare uploadAsset request options.");d={method:"post",query:{f:"json",assets:JSON.stringify([e])},responseType:"json"};d=await q(y.join(this.layer.parsedUrl.path,"uploadAssets"),d);if(1!==d.data.uploadResults.length||!d.data.uploadResults[0].success)throw new t("feature-layer-source:uploadAssets-failure","Bad response.");d=d.data.uploadResults[0].assetHash;e=[];a.flags&O.AssetMapEditFlags.PROJECT_VERTICES&&e.push("PROJECT_VERTICES");d={globalId:a.assetMapGlobalId,parentGlobalId:a.featureGlobalId,
assetName:a.assetName,assetHash:d,flags:e};b.set(a.featureGlobalId,a.feature);return d};f._getFeatureIds=function(a,b){const d=a?.[0];return d?this._canUseGlobalIds(b,a)?this._getGlobalIdsFromFeatureIdentifier(a):"objectId"in d?this._getObjectIdsFromFeatureIdentifier(a):this._getIdsFromFeatures(a):[]};f._getIdsFromFeatures=function(a){const b=this.layer.objectIdField;return a.map(d=>d.attributes&&d.attributes[b])};f._canUseGlobalIds=function(a,b){return a&&"globalId"in b[0]};f._getObjectIdsFromFeatureIdentifier=
function(a){return a.map(b=>b.objectId)};f._getGlobalIdsFromFeatureIdentifier=function(a){return a.map(b=>b.globalId)};f._createEditsResult=function(a){const b=a.data,{layerId:d}=this.layer;a=[];let e=null;if(Array.isArray(b))for(var c of b)a.push({id:c.id,editedFeatures:c.editedFeatures}),c.id===d&&(e={addResults:c.addResults??[],updateResults:c.updateResults??[],deleteResults:c.deleteResults??[],attachments:c.attachments,editMoment:c.editMoment});else e=b;c=e?.attachments;c={addFeatureResults:e?.addResults?.map(this._createFeatureEditResult,
this)??[],updateFeatureResults:e?.updateResults?.map(this._createFeatureEditResult,this)??[],deleteFeatureResults:e?.deleteResults?.map(this._createFeatureEditResult,this)??[],addAttachmentResults:c&&c.addResults?c.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:c&&c.updateResults?c.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:c&&c.deleteResults?c.deleteResults.map(this._createFeatureEditResult,this):[]};e?.editMoment&&(c.editMoment=
e.editMoment);if(0<a.length){c.editedFeatureResults=[];for(const g of a){({editedFeatures:a}=g);const h=a?.spatialReference?new T(a.spatialReference):null;c.editedFeatureResults.push({layerId:g.id,editedFeatures:{adds:a?.adds?.map(k=>this._createEditedFeature(k,h))||[],updates:a?.updates?.map(k=>({original:this._createEditedFeature(k[0],h),current:this._createEditedFeature(k[1],h)}))||[],deletes:a?.deletes?.map(k=>this._createEditedFeature(k,h))||[],spatialReference:h}})}}return c};f._createEditedFeature=
function(a,b){return new F({attributes:a.attributes,geometry:N.fromJSON({...a.geometry,spatialReference:b})})};f._createFeatureEditResult=function(a){const b=!0===a.success?null:a.error||{code:void 0,description:void 0};return{objectId:a.objectId,globalId:a.globalId,error:b?new t("feature-layer-source:edit-failure",b.description,{code:b.code}):null}};f._createAttachmentErrorResult=function(a,b){return{objectId:a,globalId:null,error:new t("feature-layer-source:attachment-failure",b.details.messages&&
b.details.messages[0]||b.message,{code:b.details.httpStatus||b.details.messageCode})}};f._getFormDataForAttachment=function(a,b){if(a=a instanceof FormData?a:a&&a.elements?new FormData(a):null)for(const d in b){const e=b[d];null!=e&&(a.set?a.set(d,e):a.append(d,e))}return a};f._getLayerRequestOptions=function(a={}){const {parsedUrl:b,gdbVersion:d,dynamicDataSource:e}=this.layer;return{...a,query:{gdbVersion:d,layer:e?JSON.stringify({source:e}):void 0,...b.query,f:"json",...this._createRequestQueryOptions(a)},
responseType:"json"}};z._createClass(u,[{key:"queryTask",get:function(){const {capabilities:a,parsedUrl:b,dynamicDataSource:d,infoFor3D:e,gdbVersion:c,spatialReference:g,fieldsIndex:h}=this.layer,k=C("featurelayer-pbf")&&a?.query.supportsFormatPBF&&m.isNone(e);return new Q({url:b.path,pbfSupported:k,fieldsIndex:h,infoFor3D:e,dynamicDataSource:d,gdbVersion:c,sourceSpatialReference:g,queryAttachmentsSupported:a?.operations?.supportsQueryAttachments??!1})}}]);return u}(I);x.__decorate([A.property()],
w.prototype,"type",void 0);x.__decorate([A.property({constructOnly:!0})],w.prototype,"layer",void 0);x.__decorate([A.property({readOnly:!0})],w.prototype,"queryTask",null);return w=x.__decorate([L.subclass("esri.layers.graphics.sources.FeatureLayerSource")],w)});