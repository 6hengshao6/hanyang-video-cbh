// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/zscale ../../../support/StreamConnection".split(" "),function(l,
q,t,h,g,m,w,z,x,E,F,G,A,B,C){var n;(function(c){c[c.CONNECTING=0]="CONNECTING";c[c.OPEN=1]="OPEN";c[c.CLOSING=2]="CLOSING";c[c.CLOSED=3]="CLOSED"})(n||(n={}));l.WebSocketConnection=function(c){function p(a){var b=D.call(this);b._outstandingMessages=[];b.errorString=null;const {geometryType:e,spatialReference:d,sourceSpatialReference:f}=a;b._config=a;b._featureZScaler=B.getGeometryZScaler(e,f,d);b._open();return b}q._inherits(p,c);var D=q._createSuper(p);c=p.prototype;c._open=async function(){await this._tryCreateWebSocket();
this.destroyed||await this._handshake()};c.destroy=function(){q._get(q._getPrototypeOf(p.prototype),"destroy",this).call(this);m.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close());this._websocket=null};c.sendMessageToSocket=function(a){m.isNone(this._websocket)?this._outstandingMessages.push(a):this._websocket.send(JSON.stringify(a))};c.sendMessageToClient=function(a){this._onMessage(a)};
c.updateCustomParameters=function(a){this._config.customParameters=a;m.isSome(this._websocket)&&this._websocket.close()};c._tryCreateWebSocket=async function(a=this._config.source.path,b=1E3,e=0){try{if(!this.destroyed){var d=z.addQueryParameters(a,this._config.customParameters??{});this._websocket=await this._createWebSocket(d);this.notifyChange("connectionStatus")}}catch(f){if(d=b/1E3,this._config.maxReconnectionAttempts&&e>=this._config.maxReconnectionAttempts)g.getLogger(this.declaredClass).error(new h("websocket-connection",
"Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),this.destroy();else return g.getLogger(this.declaredClass).error(new h("websocket-connection",`Failed to connect. Attempting to reconnect in ${d}s`,f)),await w.after(b),this._tryCreateWebSocket(a,Math.min(1.5*b,1E3*this._config.maxReconnectionInterval),e+1)}};c._setWebSocketJSONParseHandler=function(a){a.onmessage=b=>{try{const e=JSON.parse(b.data);this._onMessage(e)}catch(e){g.getLogger(this.declaredClass).error(new h("websocket-connection",
"Failed to parse message, invalid JSON",{error:e}))}}};c._createWebSocket=function(a){return new Promise((b,e)=>{const d=new WebSocket(a);d.onopen=()=>{d.onopen=null;this.destroyed?(d.onclose=null,d.close()):(d.onclose=f=>this._onClose(f),d.onerror=f=>this._onError(f),this._setWebSocketJSONParseHandler(d),b(d))};d.onclose=f=>{d.onopen=d.onclose=null;e(f)}})};c._handshake=async function(a=1E4){const b=this._websocket;if(!m.isNone(b)){var e=w.createResolver(),d=b.onmessage,{filter:f,outFields:u,spatialReference:v}=
this._config;e.timeout(a);b.onmessage=r=>{let k=null;try{k=JSON.parse(r.data)}catch(y){}k&&"object"===typeof k||(g.getLogger(this.declaredClass).error(new h("websocket-connection","Protocol violation. Handshake failed - malformed message",r.data)),e.reject(),this.destroy());k.spatialReference?.wkid!==v?.wkid&&(g.getLogger(this.declaredClass).error(new h("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${v.wkid}`,r.data)),e.reject(),this.destroy());"json"!==k.format&&
(g.getLogger(this.declaredClass).error(new h("websocket-connection","Protocol violation. Handshake failed - format is not set",r.data)),e.reject(),this.destroy());f&&k.filter!==f&&g.getLogger(this.declaredClass).error(new h("websocket-connection","Tried to set filter, but server doesn't support it"));u&&k.outFields!==u&&g.getLogger(this.declaredClass).error(new h("websocket-connection","Tried to set outFields, but server doesn't support it"));b.onmessage=d;for(const y of this._outstandingMessages)b.send(JSON.stringify(y));
this._outstandingMessages=[];e.resolve()};b.send(JSON.stringify({filter:f,outFields:u,format:"json",spatialReference:{wkid:v.wkid}}));return e.promise}};c._onMessage=function(a){this.onMessage(a);if("type"in a)switch(a.type){case "features":case "featureResult":for(const b of a.features)m.isSome(this._featureZScaler)&&this._featureZScaler(b.geometry),this.onFeature(b)}};c._onError=function(a){this._set("errorString","Encountered an error over WebSocket connection");g.getLogger(this.declaredClass).error("websocket-connection",
"Encountered an error over WebSocket connection")};c._onClose=function(a){this._websocket=null;this.notifyChange("connectionStatus");1E3!==a.code&&g.getLogger(this.declaredClass).error("websocket-connection",`WebSocket closed unexpectedly with error code ${a.code}`);this.destroyed||this._open()};q._createClass(p,[{key:"connectionStatus",get:function(){if(m.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case n.CONNECTING:case n.OPEN:return"connected";case n.CLOSING:case n.CLOSED:return"disconnected"}}}]);
return p}(C);t.__decorate([x.property()],l.WebSocketConnection.prototype,"connectionStatus",null);t.__decorate([x.property()],l.WebSocketConnection.prototype,"errorString",void 0);l.WebSocketConnection=t.__decorate([A.subclass("esri.layers.graphics.sources.connections.WebSocketConnection")],l.WebSocketConnection);Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});