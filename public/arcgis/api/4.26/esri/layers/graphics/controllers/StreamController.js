// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../core/Accessor ../../../core/HandleOwner ../../../core/maybe ../../../core/Promise ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../data/StreamFeatureManager ../sources/connections/createConnection ../../../views/3d/support/EventedSet ../../../geometry/support/typeUtils".split(" "),
function(f,h,g,M,t,u,v,p,w,x,m,N,O,P,q,y,z,A,B){f.StreamGraphic=function(b){function c(){return d.apply(this,arguments)}h._inherits(c,b);var d=h._createSuper(c);c.prototype.getObjectId=function(){return this.objectId};return h._createClass(c)}(t);g.__decorate([m.property({type:Number,json:{read:!0}})],f.StreamGraphic.prototype,"objectId",void 0);f.StreamGraphic=g.__decorate([q.subclass("esri.layers.graphics.controllers.StreamGraphic")],f.StreamGraphic);let C=function(){function b(d){this.onUpdate=
d;this._idToGraphic=new Map}var c=b.prototype;c.destroy=function(){this._idToGraphic.clear()};c.add=function(d){this._idToGraphic.set(d.objectId,d)};c.get=function(d){return this._idToGraphic.get(d)};c.forEach=function(d){this._idToGraphic.forEach(d)};c.removeById=function(d){const a=this._idToGraphic.get(d);if(!a)return null;a.sourceLayer=a.layer=null;this._idToGraphic.delete(d);return a};c.update=function(d,a){this.onUpdate(d,a)};h._createClass(b,[{key:"size",get:function(){return this._idToGraphic.size}}]);
return b}();f.StreamController=function(b){function c(){var a=d.apply(this,arguments);a.isPaused=!1;a.graphics=new A.EventedSet;a._updateInfo={websocket:0,client:0};a._updateIntervalId=null;a._outSpatialReference=null;return a}h._inherits(c,b);var d=h._createSuper(c);b=c.prototype;b.initialize=function(){this.addResolvingPromise(this.layer.when(()=>this._startup()))};b.destroy=function(){this.clear()};b._clearInterval=function(){null!==this._updateIntervalId&&(clearInterval(this._updateIntervalId),
this._updateIntervalId=null)};b.clear=function(){this._clearInterval();this.connection=p.destroyMaybe(this.connection);this.store=p.destroyMaybe(this.store);this.graphics.clear();this.handles.removeAll()};b._startup=function(){const {layer:a,layerView:e}=this,{spatialReference:n,definitionExpression:k,geometryDefinition:D,objectIdField:E,timeInfo:F,purgeOptions:G,maxReconnectionAttempts:H,maxReconnectionInterval:I,customParameters:J}=a,K=a.geometryType?B.featureGeometryTypeKebabDictionary.toJSON(a.geometryType):
null,r=e.view.spatialReference,L={geometry:D,where:k};this.clear();this._set("connection",z.createConnection(a.parsedUrl,n,r,K,L,H,I,J??void 0));this._outSpatialReference=r.toJSON();this.store=new C(this._onUpdate.bind(this));this.featuresManager=new y.StreamFeatureManager(this.store,E,F.toJSON(),G);this.handles.remove("startup-watches");this.handles.add([a.on("send-message-to-socket",l=>this.connection.sendMessageToSocket(l)),a.on("send-message-to-client",l=>this.connection.sendMessageToClient(l)),
this.connection.on("data-received",l=>this._onFeature(l)),this.connection.on("message-received",l=>this._onWebSocketMessage(l)),x.watch(()=>[a.definitionExpression,a.geometryDefinition,a.purgeOptions],()=>this._startup())],"startup-watches");this._initUpdateInterval()};b._onWebSocketMessage=function(a){this.layerView.emit("message-received",a);if("type"in a)switch(a.type){case "delete":if(a.objectIds)for(const e of a.objectIds)this.featuresManager.removeById(e);if(a.trackIds)for(const e of a.trackIds)this.featuresManager.removeByTrackId(e);
break;case "clear":this.store.forEach(e=>this.featuresManager.removeById(e.objectId))}};b._onFeature=function(a){this._updateInfo.websocket++;this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry});try{p.isSome(a.geometry)&&!a.geometry.spatialReference&&(a.geometry.spatialReference=this._outSpatialReference);const e=f.StreamGraphic.fromJSON(a);e.sourceLayer=e.layer=this.layer;this.featuresManager.add(e)}catch{}};
b._onUpdate=function(a,e){p.isSome(e)&&this.graphics.removeMany(e);p.isSome(a)&&(this._updateInfo.client+=a.length,this.graphics.addMany(a))};b._initUpdateInterval=function(){this._clearInterval();const {updateInterval:a}=this.layer;let e=performance.now();this._updateIntervalId=setInterval(()=>{var n=performance.now(),k=n-e;2500<k&&(e=n,n=Math.round(this._updateInfo.client/(k/1E3)),k=Math.round(this._updateInfo.websocket/(k/1E3)),this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",
{client:n,websocket:k}));this.featuresManager.checkForUpdates()},a)};b.pauseStream=function(){this.isPaused=!0;this._clearInterval()};b.resumeStream=function(){this.isPaused=!1;this._initUpdateInterval()};h._createClass(c,[{key:"updating",get:function(){return!this.connection||"connected"===this.connection.connectionStatus}}]);return c}(v.HandleOwnerMixin(w.EsriPromiseMixin(u)));g.__decorate([m.property()],f.StreamController.prototype,"isPaused",void 0);g.__decorate([m.property({constructOnly:!0})],
f.StreamController.prototype,"layer",void 0);g.__decorate([m.property({constructOnly:!0})],f.StreamController.prototype,"layerView",void 0);g.__decorate([m.property()],f.StreamController.prototype,"connection",void 0);g.__decorate([m.property({readOnly:!0})],f.StreamController.prototype,"updating",null);f.StreamController=g.__decorate([q.subclass("esri.layers.graphics.controllers.StreamController")],f.StreamController);Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});