// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../geometry ../../request ../../core/Error ../../core/Logger ../../core/maybe ../../geometry/support/spatialReferenceUtils ../../geometry/support/webMercatorUtils ../graphics/featureConversionUtils ../graphics/OptimizedFeatureSet ../graphics/sources/geojson/geojson ../graphics/sources/support/clientSideDefaults ../support/FieldsIndex ../support/fieldType ../../geometry/SpatialReference".split(" "),function(m,ba,t,r,J,h,K,G,A,L,B,M,N,O,u){async function H(a,b,c){const {collection:e,
layerDefinition:f,maxRecordCount:g,queryParameters:{apiKey:p,customParameters:l},spatialReference:d,supportedCrs:v}=a;({links:a}=e);var k=q(a,"items","application/geo+json")||q(a,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(h.isNone(k))throw new r("ogc-feature-layer:missing-items-page","Missing items url");const {geometry:P,num:Q,start:C,timeExtent:R,where:S}=b;if(b.objectIds)throw new r("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");
a=u.fromJSON(d);b=h.unwrapOr(b.outSpatialReference,a);a=b.isWGS84?null:I(b,v);var x=T(P,v);const V=U(R),X=W(S);({data:k}=await t(k.href,{...c,query:{...l,...x,crs:a,datetime:V,query:X,limit:Q??(null!=C&&void 0!==C?10:g),startindex:C,token:p},headers:{accept:"application/geo+json"}}));c=!1;k.links&&(c=!!k.links.find(Y=>"next"===Y.rel));!c&&Number.isInteger(k.numberMatched)&&Number.isInteger(k.numberReturned)&&(c=k.numberReturned<k.numberMatched);const {fields:Z,geometryType:y,hasZ:D,objectIdField:E}=
f;k=B.createOptimizedFeatures(k,{geometryType:y,hasZ:D,objectIdField:E});if(!a&&b.isWebMercator)for(var w of k)h.isSome(w.geometry)&&null!=y&&(x=A.convertToGeometry(w.geometry,y,D,!1),x.spatialReference=u.WGS84,w.geometry=A.convertFromGeometry(G.project(x,b)));for(var n of k)n.objectId=n.attributes[E];w=a||!a&&b.isWebMercator?b.toJSON():K.WGS84;n=new L;n.exceededTransferLimit=c;n.features=k;n.fields=Z;n.geometryType=y;n.hasZ=D;n.objectIdFieldName=E;n.spatialReference=w;return n}function I(a,b){const {isWebMercator:c,
wkid:e}=a;return e?(a=c?b[3857]??b[102100]??b[102113]??b[900913]:b[a.wkid])?`${"http://www.opengis.net/def/crs/"}${a}`:null:null}function F(a){if(h.isNone(a))return"";const {xmin:b,ymin:c,xmax:e,ymax:f}=a;return`${b},${c},${e},${f}`}function U(a){if(h.isNone(a))return null;const {start:b,end:c}=a;return`${h.isSome(b)?b.toISOString():".."}/${h.isSome(c)?c.toISOString():".."}`}function W(a){return h.isNone(a)||!a||"1\x3d1"===a?null:a}function T(a,b){if(!h.isSome(a)||"extent"!==a.type)return null;const {spatialReference:c}=
a;if(!c||c.isWGS84)return{bbox:F(a)};b=I(c,b);return h.isSome(b)?{bbox:F(a),"bbox-crs":b}:c.isWebMercator?{bbox:F(G.project(a,u.WGS84))}:null}function aa(a){a=a.extent?.spatial;if(!a)return null;var b=a.bbox[0],c=4===b.length;a=b[0];const e=b[1],f=c?void 0:b[2],g=c?b[2]:b[3],p=c?b[3]:b[4];b=c?void 0:b[5];c=u.WGS84.toJSON();return{xmin:a,ymin:e,xmax:g,ymax:p,zmin:f,zmax:b,spatialReference:c}}function q(a,b,c){return a.find(e=>e.rel===b&&e.type===c)||a.find(e=>e.rel===b&&!e.type)}const z=J.getLogger("esri.layers.graphics.sources.ogcfeature");
m.crsDefault="http://www.opengis.net/def/crs/OGC/1.3/CRS84";m.crsPrefix="http://www.opengis.net/def/crs/";m.getCollectionDefinition=async function(a,b,c={},e=5){var {links:f}=a;f=q(f,"items","application/geo+json")||q(f,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(h.isNone(f))throw new r("ogc-feature-layer:missing-items-page","Missing items url");({data:c}=await t(f.href,{signal:c.signal,query:{limit:e,...c.customParameters,token:c.apiKey},headers:{accept:"application/geo+json"}}));
await B.validateGeoJSON(c);const g=B.inferLayerProperties(c,{geometryType:b.geometryType});c=b.fields||g.fields||[];e=null!=b.hasZ?b.hasZ:g.hasZ;f=g.geometryType;const p=b.objectIdField||g.objectIdFieldName||"OBJECTID";b=b.timeInfo;var l=c.find(({name:v})=>v===p);if(l)l.editable=!1,l.nullable=!1;else{if(!g.objectIdFieldType)throw new r("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");c.unshift({name:p,alias:p,type:"number"===g.objectIdFieldType?
"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}p!==g.objectIdFieldName&&(l=c.find(({name:v})=>v===g.objectIdFieldName))&&(l.type="esriFieldTypeInteger");c===g.fields&&0<g.unknownFields.length&&z.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:g.unknownFields}});for(var d of c){null==d.name&&(d.name=d.alias);null==d.alias&&(d.alias=d.name);"esriFieldTypeOID"!==d.type&&"esriFieldTypeGlobalID"!==
d.type&&(d.editable=null==d.editable||!!d.editable,d.nullable=null==d.nullable||!!d.nullable);if(!d.name)throw new r("ogc-feature-layer:invalid-field-name","field name is missing",{field:d});if(!O.kebabDict.jsonValues.includes(d.type))throw new r("ogc-feature-layer:invalid-field-type",`invalid type for field "${d.name}"`,{field:d});}b&&(d=new N(c),b.startTimeField&&((l=d.get(b.startTimeField))?(b.startTimeField=l.name,l.type="esriFieldTypeDate"):b.startTimeField=null),b.endTimeField&&((l=d.get(b.endTimeField))?
(b.endTimeField=l.name,l.type="esriFieldTypeDate"):b.endTimeField=null),b.trackIdField&&((d=d.get(b.trackIdField))?b.trackIdField=d.name:(b.trackIdField=null,z.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:b}}))),b.startTimeField||b.endTimeField||(z.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:b}}),b=null));d=f?M.createDrawingInfo(f):null;a=aa(a);return{drawingInfo:d,
extent:a,geometryType:f,fields:c,hasZ:!!e,objectIdField:p,timeInfo:b}};m.getServerCollections=async function(a,b={}){({links:a}=a);a=q(a,"data","application/json")||q(a,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(h.isNone(a))throw new r("ogc-feature-layer:missing-collections-page","Missing collections url");const {apiKey:c,customParameters:e,signal:f}=b;({data:b}=await t(a.href,{signal:f,headers:{accept:"application/json"},query:{...e,token:c}}));return b};m.getServerConformance=
async function(a,b={}){({links:a}=a);a=q(a,"conformance","application/json")||q(a,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(h.isNone(a))throw new r("ogc-feature-layer:missing-conformance-page","Missing conformance url");const {apiKey:c,customParameters:e,signal:f}=b;({data:b}=await t(a.href,{signal:f,headers:{accept:"application/json"},query:{...e,token:c}}));return b};m.getServerLandingPage=async function(a,b={}){const {apiKey:c,customParameters:e,signal:f}=b;({data:a}=
await t(a,{signal:f,headers:{accept:"application/json"},query:{...e,token:c}}));return a};m.getServerOpenApi=async function(a,b={}){a=q(a.links,"service-desc","application/vnd.oai.openapi+json;version\x3d3.0");if(h.isNone(a))return z.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const {apiKey:c,customParameters:e,signal:f}=b;({data:b}=await t(a.href,{signal:f,headers:{accept:"application/vnd.oai.openapi+json;version\x3d3.0"},query:{...e,
token:c}}));return b};m.getSpatialReferenceWkid=function(a){a=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(a)?.groups;if(!a)return null;const {authority:b,code:c}=a;switch(b.toLowerCase()){case "ogc":switch(c.toLowerCase()){case "crs27":return u.GCS_NAD_1927.wkid;case "crs83":return 4269;case "crs84":case "crs84h":return u.WGS84.wkid;default:return null}case "esri":case "epsg":return a=Number.parseInt(c,10),Number.isNaN(a)?null:a;default:return null}};
m.queryFeatureSetJSON=async function(a,b,c){a=await H(a,b,c);return A.convertToFeatureSet(a)};m.queryOptimizedFeatureSet=H;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});