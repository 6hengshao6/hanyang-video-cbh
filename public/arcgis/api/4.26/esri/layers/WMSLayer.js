// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../config ../Graphic ../PopupTemplate ../request ../core/Collection ../core/CollectionFlattener ../core/jsonMap ../core/lang ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/accessorSupport/write ../geometry/Extent ../geometry/SpatialReference ../geometry/support/scaleUtils ../geometry/support/spatialReferenceUtils ./Layer ./mixins/BlendLayer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./ogc/crsUtils ./support/arcgisLayerUrl ./support/commonProperties ./support/ExportWMSImageParameters ./support/imageBitmapUtils ./support/WMSSublayer ./support/wmsUtils".split(" "),
function(v,f,K,L,M,z,D,N,w,O,q,e,P,t,A,h,Q,x,R,B,S,T,y,E,U,V,W,X,Y,Z,aa,ba,ca,da,F,G,ea,C,r){function H(d){return"text/html"===d}function I(d){return"text/plain"===d}function fa(d,n){return d.some(p=>{for(const b in p)if(S.willPropertyWrite(p,b,null,n))return!0;return!1})}function J(d,n,p){d=d??[];const b=new Map;d.every(a=>null==a.id)&&(d=O.clone(d),d.forEach((a,c)=>a.id=c));for(const a of d){const c=new C;c.read(a,n);p&&!p.includes(c.name)&&(c.visible=!1);b.set(c.id,c)}n=[];for(const a of d)if(d=
null!=a.id?b.get(a.id):null)if(null!=a.parentLayerId&&0<=a.parentLayerId){if(p=b.get(a.parentLayerId))p.sublayers||(p.sublayers=new D),p.sublayers.push(d)}else n.push(d);return n}w=new w.JSONMap({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});e=function(d){function n(...b){var a=p.call(this,...b);a.allSublayers=new N({getCollections:()=>[a.sublayers],getChildrenFunction(c){return c.sublayers}});a.customParameters=null;a.customLayerParameters=
null;a.copyright=null;a.description=null;a.dimensions=null;a.fullExtent=null;a.fullExtents=null;a.featureInfoFormats=null;a.featureInfoUrl=null;a.fetchFeatureInfoFunction=null;a.imageFormat=null;a.imageMaxHeight=2048;a.imageMaxWidth=2048;a.imageTransparency=!0;a.legendEnabled=!0;a.mapUrl=null;a.isReference=null;a.operationalLayerType="WMS";a.spatialReference=null;a.spatialReferences=null;a.sublayers=null;a.type="wms";a.url=null;a.version=null;a.addHandles([t.on(()=>a.sublayers,"after-add",({item:c})=>
{c.parent=c.layer=v._assertThisInitialized(a)},t.sync),t.on(()=>a.sublayers,"after-remove",({item:c})=>{c.layer=c.parent=null},t.sync),t.watch(()=>a.sublayers,(c,m)=>{if(m)for(const g of m)g.layer=g.parent=null;if(c)for(const g of c)g.parent=g.layer=v._assertThisInitialized(a)},t.sync)]);return a}v._inherits(n,d);var p=v._createSuper(n);d=n.prototype;d.normalizeCtorArgs=function(b,a){return"string"===typeof b?{url:b,...a}:b};d.destroy=function(){this.allSublayers.destroy()};d.load=function(b){const a=
q.isSome(b)?b.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},b).catch(P.throwIfAbortError).then(()=>this._fetchService(a)));return Promise.resolve(this)};d.readFullExtentFromItemOrMap=function(b,a){return(b=a.extent)?new T({xmin:b[0][0],ymin:b[0][1],xmax:b[1][0],ymax:b[1][1]}):null};d.writeFullExtent=function(b,a){a.extent=[[b.xmin,b.ymin],[b.xmax,b.ymax]]};d.readImageFormat=function(b,a){return(b=a.supportedImageFormatTypes)&&b.includes("image/png")?"image/png":
b&&b[0]};d.readSpatialReferenceFromItemOrDocument=function(b,a){return new y(a.spatialReferences[0])};d.writeSpatialReferences=function(b,a){const c=this.spatialReference?.wkid;b&&c?(a.spatialReferences=b.filter(m=>m!==c),a.spatialReferences.unshift(c)):a.spatialReferences=b};d.readSublayersFromItemOrMap=function(b,a,c){return J(a.layers,c,a.visibleLayers)};d.readSublayers=function(b,a,c){return J(a.layers,c)};d.writeSublayers=function(b,a,c,m){a.layers=[];c=new Map;b=b.flatten(({sublayers:l})=>l??
[]);for(var g of b)if("number"===typeof g.parent?.id){var k=c.get(g.parent.id);null!=k?k.push(g.id):c.set(g.parent.id,[g.id])}for(const l of b)g={sublayer:l,...m},k=l.write({parentLayerId:"number"===typeof l.parent?.id?l.parent.id:-1},g),c.has(l.id)&&(k.sublayerIds=c.get(l.id)),!l.sublayers&&l.name&&(g=l.write({},g),delete g.id,a.layers.push(g));a.visibleLayers=b.filter(({visible:l,sublayers:u})=>l&&!u).map(({name:l})=>l).toArray()};d.createExportImageParameters=function(b,a,c,m){c=m?.pixelRatio??
1;a=E.getScale({extent:b,width:a})*c;a=new G.ExportWMSImageParameters({layer:this,scale:a});const {xmin:g,ymin:k,xmax:l,ymax:u,spatialReference:ha}=b;b=r.normalizeWKID(ha,this.spatialReferences);c="1.3.0"===this.version&&ca.isAxesOrderReversedForWkid(b)?`${k},${g},${u},${l}`:`${g},${k},${l},${u}`;a=a.toJSON();return{bbox:c,["1.3.0"===this.version?"crs":"srs"]:null==b||isNaN(b)?void 0:"EPSG:"+b,...a}};d.fetchImage=async function(b,a,c,m){var g=this.mapUrl;b=this.createExportImageParameters(b,a,c,m);
if(!b.layers)return g=document.createElement("canvas"),g.width=a,g.height=c,g;var k=m?.timeExtent?.start;const l=m?.timeExtent?.end;k=q.isSome(k)&&q.isSome(l)?k.getTime()===l.getTime()?r.toISOString(k):`${r.toISOString(k)}/${r.toISOString(l)}`:void 0;a={responseType:"image",query:this._mixCustomParameters({width:a,height:c,...b,time:k,...this.refreshParameters}),signal:m?.signal};return z(g??"",a).then(u=>u.data)};d.fetchImageBitmap=async function(b,a,c,m){var g=this.mapUrl??"";b=this.createExportImageParameters(b,
a,c,m);if(!b.layers)return g=document.createElement("canvas"),g.width=a,g.height=c,g;var k=m?.timeExtent?.start;const l=m?.timeExtent?.end;k=q.isSome(k)&&q.isSome(l)?k.getTime()===l.getTime()?r.toISOString(k):`${r.toISOString(k)}/${r.toISOString(l)}`:void 0;a={responseType:"blob",query:this._mixCustomParameters({width:a,height:c,...b,time:k,...this.refreshParameters}),signal:m?.signal};({data:a}=await z(g,a));return ea.createBitmap(a,g)};d.fetchFeatureInfo=function(b,a,c,m,g){var k=E.getScale({extent:b,
width:a});k=new G.ExportWMSImageParameters({layer:this,scale:k});k=r.getPopupLayers(k.visibleSublayers);if(q.isNone(this.featureInfoUrl)||q.isNone(k)||q.isNone(this.fetchFeatureInfoFunction)&&q.isNone(this.featureInfoFormat))return Promise.resolve([]);m={query_layers:k,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:a,height:c,...("1.3.0"===this.version?{I:m,J:g}:{x:m,y:g})};b={...this.createExportImageParameters(b,a,c),...m};b=this._mixCustomParameters(b);return q.isSome(this.fetchFeatureInfoFunction)?
this.fetchFeatureInfoFunction(b):this._defaultFetchFeatureInfoFunction(A.addQueryParameters(this.featureInfoUrl,b))};d.findSublayerById=function(b){return this.allSublayers.find(a=>a.id===b)};d.findSublayerByName=function(b){return this.allSublayers.find(a=>a.name===b)};d.serviceSupportsSpatialReference=function(b){return da.isWmsServer(this.url)||null!=this.spatialReferences&&this.spatialReferences.some(a=>{a=900913===a?y.WebMercator:new y({wkid:a});return U.equals(a,b)})};d._defaultFetchFeatureInfoFunction=
function(b){const a=document.createElement("iframe");a.src=A.addProxy(b);a.style.border="none";a.style.margin="0";a.style.width="100%";a.setAttribute("sandbox","");b=new M({title:this.title,content:a});b=new L({sourceLayer:this,popupTemplate:b});return Promise.resolve([b])};d._fetchService=async function(b){if(!this.resourceInfo){const {path:a,query:c}=this.parsedUrl??{};c?.service&&(c.SERVICE=c.service,delete c.service);c?.request&&(c.REQUEST=c.request,delete c.request);({data:b}=await z(a??"",{query:{SERVICE:"WMS",
REQUEST:"GetCapabilities",...c,...this.customParameters},responseType:"xml",signal:b}));this.resourceInfo=r.parseCapabilities(b)}if(this.parsedUrl){b=new A.Url(this.parsedUrl.path);const {httpsDomains:a}=K.request;"https"!==b.scheme||b.port&&"443"!==b.port||!b.host||a.includes(b.host)||a.push(b.host)}this.read(this.resourceInfo,{origin:"service"})};d._mixCustomParameters=function(b){if(!this.customLayerParameters&&!this.customParameters)return b;const a={...this.customParameters,...this.customLayerParameters};
for(const c in a)b[c.toLowerCase()]=a[c];return b};v._createClass(n,[{key:"featureInfoFormat",get:function(){return q.isNone(this.featureInfoFormats)?null:this.featureInfoFormats.find(H)??this.featureInfoFormats.find(I)??null},set:function(b){q.isSome(b)?(H(b)||I(b))&&this._override("featureInfoFormat",b):(this.revert("featureInfoFormat","service"),this._clearOverride("featureInfoFormat"))}}]);return n}(W.BlendLayer(ba.TemporalLayer(Z.RefreshableLayer(aa.ScaleRangeLayer(X.OperationalLayer(Y.PortalLayer(e.MultiOriginJSONMixin(V))))))));
f.__decorate([h.property({readOnly:!0})],e.prototype,"allSublayers",void 0);f.__decorate([h.property({json:{type:Object,write:!0}})],e.prototype,"customParameters",void 0);f.__decorate([h.property({json:{type:Object,write:!0}})],e.prototype,"customLayerParameters",void 0);f.__decorate([h.property({type:String,json:{write:!0}})],e.prototype,"copyright",void 0);f.__decorate([h.property()],e.prototype,"description",void 0);f.__decorate([h.property({readOnly:!0})],e.prototype,"dimensions",void 0);f.__decorate([h.property({json:{type:[[Number]],
read:{source:"extent"},write:{target:"extent"},origins:{"web-document":{write:{ignoreOrigin:!0}},"portal-item":{write:{ignoreOrigin:!0}}}}})],e.prototype,"fullExtent",void 0);f.__decorate([x.reader(["web-document","portal-item"],"fullExtent",["extent"])],e.prototype,"readFullExtentFromItemOrMap",null);f.__decorate([B.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],e.prototype,"writeFullExtent",null);f.__decorate([h.property()],e.prototype,"fullExtents",void 0);f.__decorate([h.property({type:String,
json:{write:{ignoreOrigin:!0}}})],e.prototype,"featureInfoFormat",null);f.__decorate([h.property({type:[String],readOnly:!0})],e.prototype,"featureInfoFormats",void 0);f.__decorate([h.property({type:String,json:{write:{ignoreOrigin:!0}}})],e.prototype,"featureInfoUrl",void 0);f.__decorate([h.property()],e.prototype,"fetchFeatureInfoFunction",void 0);f.__decorate([h.property({type:String,json:{origins:{"web-document":{default:"image/png",type:w.jsonValues,read:{reader:w.read,source:"format"},write:{writer:w.write,
target:"format"}}}}})],e.prototype,"imageFormat",void 0);f.__decorate([x.reader("imageFormat",["supportedImageFormatTypes"])],e.prototype,"readImageFormat",null);f.__decorate([h.property({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],e.prototype,"imageMaxHeight",void 0);f.__decorate([h.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],e.prototype,"imageMaxWidth",void 0);f.__decorate([h.property()],e.prototype,"imageTransparency",void 0);
f.__decorate([h.property(F.legendEnabled)],e.prototype,"legendEnabled",void 0);f.__decorate([h.property({type:["show","hide","hide-children"]})],e.prototype,"listMode",void 0);f.__decorate([h.property({type:String,json:{write:{ignoreOrigin:!0}}})],e.prototype,"mapUrl",void 0);f.__decorate([h.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],e.prototype,"isReference",void 0);f.__decorate([h.property({type:["WMS"]})],e.prototype,"operationalLayerType",void 0);
f.__decorate([h.property()],e.prototype,"resourceInfo",void 0);f.__decorate([h.property({type:y,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],e.prototype,"spatialReference",void 0);f.__decorate([x.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],e.prototype,"readSpatialReferenceFromItemOrDocument",null);f.__decorate([h.property({type:[Q.Integer],json:{read:!1,origins:{service:{read:!0},"web-document":{read:!1,write:{ignoreOrigin:!0}},
"portal-item":{read:!1,write:{ignoreOrigin:!0}}}}})],e.prototype,"spatialReferences",void 0);f.__decorate([B.writer(["web-document","portal-item"],"spatialReferences")],e.prototype,"writeSpatialReferences",null);f.__decorate([h.property({type:D.ofType(C),json:{write:{target:"layers",overridePolicy(d,n,p){if(fa(this.allSublayers,p))return{ignoreOrigin:!0}}}}})],e.prototype,"sublayers",void 0);f.__decorate([x.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],e.prototype,
"readSublayersFromItemOrMap",null);f.__decorate([x.reader("service","sublayers",["layers"])],e.prototype,"readSublayers",null);f.__decorate([B.writer("sublayers",{layers:{type:[C]},visibleLayers:{type:[String]}})],e.prototype,"writeSublayers",null);f.__decorate([h.property({json:{read:!1},readOnly:!0,value:"wms"})],e.prototype,"type",void 0);f.__decorate([h.property(F.url)],e.prototype,"url",void 0);f.__decorate([h.property({type:String,json:{write:{ignoreOrigin:!0}}})],e.prototype,"version",void 0);
return e=f.__decorate([R.subclass("esri.layers.WMSLayer")],e)});