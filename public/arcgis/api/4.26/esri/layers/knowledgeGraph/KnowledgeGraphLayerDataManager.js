// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/Error ../../core/Logger ../../core/maybe ../../core/sql ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geohash/geohashUtils ../../geometry/Polygon ../../geometry/projection ../../geometry/support/spatialReferenceUtils ./SessionMemoryStorage ../../rest/knowledgeGraphService ../../rest/knowledgeGraph/GraphQueryStreaming ../../rest/support/Query".split(" "),
function(t,J,B,R,K,S,n,M,C,Y,Z,aa,T,N,U,O,P,L,Q,E,V){const W=S.getLogger("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager");t.KnowledgeGraphLayerDataManager=function(A){function H(b){var a=X.call(this,b);a.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map};a.entityTypeNames=new Set;a.relationshipTypeNames=new Set;a.geographicLookup=new Map;a.sublayerCaches=new Map;a._processingCacheUpdatesLookup=new Map;a._memberIdTypeLookup=new Map;const k=
new Map;b.knowledgeGraph.dataModel.entityTypes?.forEach(g=>{g.name&&(k.set(g.name,"entity"),a._processingCacheUpdatesLookup.set(g.name,[]),b.inclusionModeDefinition&&!b.inclusionModeDefinition?.generateAllSublayers||a.entityTypeNames.add(g.name),g.properties?.forEach(e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&a.geographicLookup.set(g.name,{name:e.name??"",geometryType:e.geometryType})}))});b.knowledgeGraph.dataModel.relationshipTypes?.forEach(g=>{g.name&&(k.set(g.name,"relationship"),
a._processingCacheUpdatesLookup.set(g.name,[]),b.inclusionModeDefinition&&!b.inclusionModeDefinition?.generateAllSublayers||a.relationshipTypeNames.add(g.name),g.properties?.forEach(e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&a.geographicLookup.set(g.name,{name:e.name??"",geometryType:e.geometryType})}))});b.inclusionModeDefinition?.namedTypeDefinitions.forEach((g,e)=>{if("entity"===k.get(e))a.entityTypeNames.add(e);else if("relationship"===k.get(e))a.relationshipTypeNames.add(e);else{W.warn(`A named type, ${e}, was in the inclusion list that wasn't in the data model and will be removed`);
b.inclusionModeDefinition?.namedTypeDefinitions.delete(e);return}const l=new Map;g.members?.forEach(u=>{a._memberIdTypeLookup.set(u.id,e);const d=a.getById(u.id);d&&l.set(u.id,d)});a.sublayerCaches.set(e,l)});return a}J._inherits(H,A);var X=J._createSuper(H);A=H.prototype;A.addToLayerInclusionSet=async function(b,a=!1){b.forEach((k,g)=>{if(!this.inclusionModeDefinition)throw new K("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");
if(!this.inclusionModeDefinition.namedTypeDefinitions.has(k)){var e=new Map;e.set(g,{id:g});this.inclusionModeDefinition.namedTypeDefinitions.set(k,{useAllData:!1,members:e});this._memberIdTypeLookup.set(g,k)}else if(this.inclusionModeDefinition.namedTypeDefinitions.has(k)){e=this.inclusionModeDefinition.namedTypeDefinitions.get(k);if(e.useAllData)throw new K("knowledge-graph:layer-data-manager","You cannot add members to an exclusion list for a sublayer where the sublayer is set to always retrieve its entire data set");
e.members||(e.members=new Map);e.members.set(g,{id:g});this._memberIdTypeLookup.set(g,k)}});a&&await this.refreshCacheContent(Array.from(b.keys()))};A.getById=function(b){return L.getInstance().readFromStoreById(b)};A.getData=async function(b,a,k){if(a.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&0<this.inclusionModeDefinition.namedTypeDefinitions.size&&!this.inclusionModeDefinition.namedTypeDefinitions.has(a.objectType.name))return[];b=b?b:new V({where:"1\x3d1",outFields:["*"]});
if("link-chart"===a.parentCompositeLayer.type){const g=a.parentCompositeLayer;k=this._processingCacheUpdatesLookup.get(a.objectType.name??"");const e=n.unwrap(b.outFields),l=n.unwrap(b.geometry);let u="",d="";l&&l.extent&&(u=N.encodeGeohash(l.extent.ymin,l.extent.xmin,12),d=N.encodeGeohash(l.extent.ymax,l.extent.xmax,12));e&&1===e.length&&"ESRI__ID"===e[0]&&"1\x3d1"===n.unwrap(b.where)||await Promise.all(k??[]);const c=[];(this.sublayerCaches.has(a.objectType.name??"")?Array.from(this.sublayerCaches.get(a.objectType.name)?.values()):
[]).forEach(p=>{p.geometry=g.linkChartDiagramLookup.get(p.attributes[a.objectIdField]);p.attributes.ESRI__LAYOUT_GEOMETRY=p.geometry;if(u&&d){const m=g.linkChartGeohashLookup.get(p.attributes[a.objectIdField]);m?m>=u&&m<=d&&c.push(p):c.push(p)}else c.push(p)});return c}return this.retrieveDataFromService(b,a,k)};A.refreshCacheContent=async function(b,a,k){const g=L.getInstance(),e=[],l=new Map,u=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(d=>{d.name&&u.set(d.name,d)});this.knowledgeGraph.dataModel.relationshipTypes?.forEach(d=>
{d.name&&u.set(d.name,d)});b||this.inclusionModeDefinition?b?b.forEach(d=>{if(this._memberIdTypeLookup.has(d)){const c=this._memberIdTypeLookup.get(d);l.has(c)?l.get(c)?.push(d):l.set(c,[d])}}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((d,c)=>{d.useAllData?l.set(c,null):d.members&&d.members.forEach(p=>{l.has(c)&&null!==l.get(c)?l.get(c)?.push(p.id):l.set(c,[p.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(d=>{d.name&&l.set(d.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(d=>
{d.name&&l.set(d.name,null)}));for(const [d,c]of l)b=new Promise(p=>{(async()=>{const m=new Set,q=[];let h="",r=!1;a||u.get(d)?.properties?.forEach(w=>{w.name&&m.add(w.name)});if(k&&this.geographicLookup.has(d)){var v=this.geographicLookup.get(d)?.name;v&&m.add(v)}if(this.entityTypeNames.has(d))h=`MATCH (n:${d}) ${c?"WHERE id(n) IN $ids ":""}return ID(n)`,m.forEach(w=>{h+=`, n.${w}`;q.push(w)});else if(this.relationshipTypeNames.has(d))r=!0,h=`MATCH ()-[n:${d}]->() ${c?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`;
else throw new K("knowledge-graph:layer-data-manager",`The graph type of ${d} could not be determined.  Was this type set in the KG data model?`);v=c?new E({openCypherQuery:h,bindParameters:{ids:c}}):new E({openCypherQuery:h});for(v=(await Q.executeQueryStreaming(this.knowledgeGraph,v)).resultRowsStream.getReader();;){const {done:w,value:D}=await v.read();if(w)break;var x=[];for(let y=0;y<D.length;y++){const F=D[y];let z=0,I=0;const G={properties:{}};G.id=F[z];z++;I++;r&&(G.originId=F[z],z++,I++,
G.destinationId=F[z],z++,I++);for(;z<F.length;z++)G.properties[q[z-I]]=F[z];x.push(G)}x=g.writeToStore(x,"ESRI__ID",this.geographicLookup.get(d)?.name);this.sublayerCaches.has(d)||this.sublayerCaches.set(d,new Map);const f=this.sublayerCaches.get(d);x.forEach(y=>{f?.set(y.attributes.ESRI__ID,y)})}})().then(()=>{p(null)})}),e.push(b),this._processingCacheUpdatesLookup.get(d)?.push(b);await Promise.all(e)};A.removeFromLayer=function(b){const a=new Set;b.forEach(k=>{this._memberIdTypeLookup.get(k)&&
a.add(this._memberIdTypeLookup.get(k));this._memberIdTypeLookup.delete(k);this.inclusionModeDefinition?.namedTypeDefinitions.forEach(g=>{g.members?.has(k)&&g.members.delete(k)})});a.forEach(k=>{this.sublayerCaches.get(k)?.forEach((g,e)=>{b.includes(e)&&this.sublayerCaches.get(k)?.delete(e)})})};A.retrieveDataFromService=async function(b,a,k){const g=L.getInstance(),e=new Set,l=[];let u="",d=[];var c=a.parentCompositeLayer.sublayerIdsCache.get(a.objectType.name);const p="relationship"===a.graphType;
if(!this.inclusionModeDefinition?.namedTypeDefinitions?.get(a.objectType.name)?.useAllData)if(n.isSome(b.objectIds)&&c&&0<c.length){const h=n.unwrap(b.objectIds);b.objectIds=c.filter(r=>h.includes(r))}else if(n.isSome(b.objectIds))c=n.unwrap(b.objectIds);else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(a.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(a.objectType.name)?.members||1>this.inclusionModeDefinition.namedTypeDefinitions.get(a.objectType.name)?.members?.size))return b.objectIds=
[],[];b.objectIds=c}if(n.isSome(b.outFields)){var m=n.unwrap(b.outFields);m.includes("*")?a.fields.forEach(h=>{e.add(h.name)}):m.forEach(h=>{"ESRI__ID"!==h&&h!==a.geometryFieldName&&e.add(h)})}if(n.isSome(b.geometry)){c=n.unwrap(b.geometry);c?.extent?.spatialReference&&!c.spatialReference?.isWGS84?(await O.initializeProjection(c.extent.spatialReference,P.WGS84),c=O.project(c.extent,P.WGS84)):c=c.extent;if(n.isSome(b.where)&&"1\x3d1"!==n.unwrap(b.where)){const h=await M.parseWhereClause(n.unwrap(b.where).toUpperCase(),
a.fieldsIndex);a.fields.forEach(r=>{h.fieldNames.includes(r.name)&&e.add(r.name)})}u=p?`Match ()-[n:${a.objectType.name}]-() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${a.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${a.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${a.geometryFieldName}) return ID(n)`;n.unwrap(b).returnGeometry&&a.geometryFieldName&&e.add(a.geometryFieldName);e.forEach(h=>{u+=`, n.${h}`;l.push(h)});b=new E({openCypherQuery:u,
bindParameters:{param_filter_geom:new U({rings:[[[c.xmin,c.ymin],[c.xmin,c.ymax],[c.xmax,c.ymax],[c.xmax,c.ymin],[c.xmin,c.ymin]]]})}})}else{m="";if(n.isSome(b.where)&&"1\x3d1"!==n.unwrap(b.where)){const r=await M.parseWhereClause(n.unwrap(b.where),a.fieldsIndex);a.fields.forEach(f=>{r.fieldNames.includes(f.name)&&e.add(f.name)});const v=["column-reference","string","number","binary-expression"],x="\x3d \x3c \x3c\x3d \x3c\x3e \x3e \x3e\x3d AND OR LIKE".split(" ");let w=!1;const D=f=>{if("column-reference"===
f.type)return`n.${f.column}`;if("string"===f.type)return`'${f.value}'`;if("number"===f.type)return`${f.value}`;if("binary-expression"===f.type&&v.includes(f.left.type)&&v.includes(f.right.type)&&x.includes(f.operator))return`${D(f.left)} ${f.operator} ${D(f.right)}`;if("binary-expression"===f.type&&"LIKE"===f.operator){let y="";if("function"===f.left.type&&"column-reference"===f.left.args.value[0].type)y+=`lower(n.${f.left.args.value[0].column})`;else if("column-reference"===f.left.type)y+=`lower(n.${f.left.column})`;
else return w=!0,"";y+=" CONTAINS (";if("string"===f.right.type)f=f.right.value,"%"===f.charAt(0)&&(f=f.slice(1)),"%"===f.charAt(f.length-1)&&(f=f.slice(0,-1)),y+=`'${f.toLowerCase()}')`;else return w=!0,"";return y}w=!0;return""};m=D(r.parseTree);w&&(m="")}let h="";h=p?`Match ()-[n:${a.objectType.name}]-()`:`Match (n:${a.objectType.name})`;var q=!1;c&&(q=!0,h+=" WHERE ID(n) IN $ids");m&&(h=q?h+" AND":h+" WHERE",h+=` ${m}`);h+=" return ID(n)";p&&(h+=", id(startNode(n)), id(endNode(n))");n.unwrap(b).returnGeometry&&
a.geometryFieldName&&e.add(a.geometryFieldName);e.forEach(r=>{h+=`, n.${r}`;l.push(r)});b=c?new E({openCypherQuery:h,bindParameters:{ids:c}}):new E({openCypherQuery:h})}for(k=(await Q.executeQueryStreaming(a.parentCompositeLayer.dataManager.knowledgeGraph,b,k)).resultRowsStream.getReader();;){const {done:h,value:r}=await k.read();if(h)break;b=[];for(c=0;c<r.length;c++){m=r[c];let v=q=0;const x={properties:{}};x.id=m[q];q++;v++;p&&(x.originId=m[q],q++,v++,x.destinationId=m[q],q++,v++);for(;q<m.length;q++)x.properties[l[q-
v]]=m[q];b.push(x)}d=d.concat(g.writeToStore(b,"ESRI__ID",a.parentCompositeLayer.dataManager.geographicLookup.get(a.objectType.name)?.name))}return d};return J._createClass(H)}(R);B.__decorate([C.property()],t.KnowledgeGraphLayerDataManager.prototype,"knowledgeGraph",void 0);B.__decorate([C.property()],t.KnowledgeGraphLayerDataManager.prototype,"inclusionModeDefinition",void 0);B.__decorate([C.property()],t.KnowledgeGraphLayerDataManager.prototype,"entityTypeNames",void 0);B.__decorate([C.property()],
t.KnowledgeGraphLayerDataManager.prototype,"relationshipTypeNames",void 0);B.__decorate([C.property()],t.KnowledgeGraphLayerDataManager.prototype,"geographicLookup",void 0);B.__decorate([C.property()],t.KnowledgeGraphLayerDataManager.prototype,"sublayerCaches",void 0);t.KnowledgeGraphLayerDataManager=B.__decorate([T.subclass("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],t.KnowledgeGraphLayerDataManager);t.GEOHASH_ENCODING_PRECISION=12;t.MOCK_DESTINATION_ID_FIELD_NAME=
"ESRI__DESTINATION_ID";t.MOCK_LAYOUT_GEOMETRY_FIELD_NAME="ESRI__LAYOUT_GEOMETRY";t.MOCK_OID_FIELD_NAME="ESRI__ID";t.MOCK_ORIGIN_ID_FIELD_NAME="ESRI__ORIGIN_ID";Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});