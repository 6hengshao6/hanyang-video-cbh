// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../core/asyncUtils ../../core/Error ../../core/maybe ../../core/promiseUtils ../../core/unitUtils ../../geometry/Multipoint ../../geometry/Point ../../geometry/Polyline ../../geometry/projection ../../geometry/support/aaBoundingRect ./ElevationSampler ./ElevationTile ./TileKey".split(" "),function(C,u,N,v,w,z,F,G,I,O,A,D,J,K,L){function H(g,k=0){let b=g.lods.length-1;if(0<k){const a=F.getMetersPerUnitForSR(g.spatialReference),c=k/a;g=g.lods.findIndex(d=>
d.resolution<c);0===g?b=0:0<g&&(b=g-1)}return b}let R=function(){function g(){}var k=g.prototype;k.queryAll=async function(b,a,c){b=c&&c.ignoreInvisibleLayers?b.filter(e=>e.visible):b.slice();if(!b.length)throw new v("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");var d=B.fromGeometry(a);a=!1;c&&c.returnSampleInfo||(a=!0);c={...E,...c,returnSampleInfo:!0};d=await this.query(b[b.length-1],d,c);b=await this._queryAllContinue(b,d,c);b.geometry=
b.geometry.export();a&&delete b.sampleInfo;return b};k.query=async function(b,a,c){if(!b)throw new v("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!a||!(a instanceof B)&&"point"!==a.type&&"multipoint"!==a.type&&"polyline"!==a.type)throw new v("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");var d={...E,...c};c=new P(b,a.spatialReference,d);d=d.signal;await b.load({signal:d});
await this._createGeometryDescriptor(c,a,d);await this._selectTiles(c,d);await this._populateElevationTiles(c,d);this._sampleGeometryWithElevation(c);return this._createQueryResult(c,d)};k.createSampler=async function(b,a,c){if(!b)throw new v("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!a||"extent"!==a.type)throw new v("elevation-query:invalid-extent","Invalid or undefined extent");return this._createSampler(b,a,{...E,...c})};k.createSamplerAll=
async function(b,a,c){b=c&&c.ignoreInvisibleLayers?b.filter(e=>e.visible):b.slice();if(!b.length)throw new v("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!a||"extent"!==a.type)throw new v("elevation-query:invalid-extent","Invalid or undefined extent");c={...E,...c,returnSampleInfo:!0};const d=await this._createSampler(b[b.length-1],a,c);return this._createSamplerAllContinue(b,a,d,c)};k._createSampler=async function(b,a,c,d){const e=
c.signal;await b.load({signal:e});const f=a.spatialReference,l=b.tileInfo.spatialReference;f.equals(l)||(await A.initializeProjection([{source:f,dest:l}],{signal:e}),a=A.project(a,l));b=new Q(b,a,c,d);await this._selectTiles(b,e);await this._populateElevationTiles(b,e);return new J.MultiTileElevationSampler(b.elevationTiles,b.layer.tileInfo,b.options.noDataValue)};k._createSamplerAllContinue=async function(b,a,c,d){b.pop();if(!b.length)return c;var e=c.samplers.map(f=>D.fromExtent(f.extent));e=await this._createSampler(b[b.length-
1],a,d,e);if(0===e.samplers.length)return c;c=c.samplers.concat(e.samplers);c=new J.MultiTileElevationSampler(c,d.noDataValue);return this._createSamplerAllContinue(b,a,c,d)};k._queryAllContinue=async function(b,a,c){var d=b.pop();const e=a.geometry.coordinates,f=a.sampleInfo;w.assertIsSome(f);const l=[],m=[];for(let q=0;q<e.length;q++){const h=f[q];0<=h.demResolution?h.source||(h.source=d):b.length&&(l.push(e[q]),m.push(q))}if(!b.length||0===l.length)return a;d=a.geometry.clone(l);const p=await this.query(b[b.length-
1],d,c),y=p.sampleInfo;if(!y)throw Error("no sampleInfo");m.forEach((q,h)=>{e[q].z=p.geometry.coordinates[h].z;f[q].demResolution=y[h].demResolution});return this._queryAllContinue(b,a,c)};k._createQueryResult=async function(b,a){a=await b.geometry.project(b.outSpatialReference,a);w.assertIsSome(a);a={geometry:a.export(),noDataValue:b.options.noDataValue};b.options.returnSampleInfo&&(a.sampleInfo=this._extractSampleInfo(b));b.geometry.coordinates.forEach(c=>{c.tile=null;c.elevationTile=null});return a};
k._createGeometryDescriptor=async function(b,a,c){const d=b.layer.tileInfo.spatialReference;a instanceof B?c=await a.project(d,c):(await A.initializeProjection([{source:a.spatialReference,dest:d}],{signal:c}),c=A.project(a,d));if(!c)throw new v("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${a.spatialReference.wkid}' on an elevation service in '${d.wkid}'`);b.geometry=B.fromGeometry(c)};k._selectTiles=async function(b,a){"geometry"===b.type&&this._preselectOutsideLayerExtent(b);
const c=b.options.demResolution;if("number"===typeof c)this._selectTilesClosestResolution(b,c);else if("finest-contiguous"===c)await this._selectTilesFinestContiguous(b,a);else if("auto"===c)await this._selectTilesAuto(b,a);else throw new v("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${c}', expected a number, "finest-contiguous" or "auto"`);};k._preselectOutsideLayerExtent=function(b){if(!w.isNone(b.layer.fullExtent)){var a=new K.ElevationTile(null);a.sample=()=>b.options.noDataValue;
b.outsideExtentTile=a;var c=b.layer.fullExtent;b.geometry.coordinates.forEach(d=>{const e=d.x,f=d.y;if(e<c.xmin||e>c.xmax||f<c.ymin||f>c.ymax)d.elevationTile=a})}};k._selectTilesClosestResolution=function(b,a){a=this._findNearestDemResolutionLODIndex(b.layer.tileInfo,a);b.selectTilesAtLOD(a)};k._findNearestDemResolutionLODIndex=function(b,a){var c=F.getMetersPerUnitForSR(b.spatialReference);a/=c;c=b.lods[0];let d=0;for(let e=1;e<b.lods.length;e++){const f=b.lods[e];Math.abs(f.resolution-a)<Math.abs(c.resolution-
a)&&(c=f,d=e)}return d};k._selectTilesFinestContiguous=async function(b,a){const c=H(b.layer.tileInfo,b.options.minDemResolution);await this._selectTilesFinestContiguousAt(b,c,a)};k._selectTilesFinestContiguousAt=async function(b,a,c){var d=b.layer;b.selectTilesAtLOD(a);if(!(0>a)){var e=d.tilemapCache;d=b.getTilesToFetch();try{if(e)await z.whenOrAbort(Promise.all(d.map(f=>e.fetchAvailability(f.level,f.row,f.col,{signal:c}))),c);else if(await this._populateElevationTiles(b,c),!b.allElevationTilesFetched())throw b.clearElevationTiles(),
new v("elevation-query:has-unavailable-tiles");}catch(f){z.throwIfAbortError(f),await this._selectTilesFinestContiguousAt(b,a-1,c)}}};k._populateElevationTiles=async function(b,a){var c=b.getTilesToFetch();const d={},e=b.options.cache,f=b.options.noDataValue;c=c.map(async l=>{if(null!=l.id){var m=`${b.layer.uid}:${l.id}:${f}`,p=w.isSome(e)?e.get(m):null;p=w.isSome(p)?p:await b.layer.fetchTile(l.level,l.row,l.col,{noDataValue:f,signal:a});w.isSome(e)&&e.put(m,p);d[l.id]=new K.ElevationTile(l,p)}});
await z.whenOrAbort(z.eachAlways(c),a);b.populateElevationTiles(d)};k._selectTilesAuto=async function(b,a){this._selectTilesAutoFinest(b);this._reduceTilesForMaximumRequests(b);const c=b.layer.tilemapCache;if(!c)return this._selectTilesAutoPrefetchUpsample(b,a);const d={},e=b.getTilesToFetch().map(async f=>{const l=new L.TileKey(null,0,0,0,D.create()),m=await N.result(c.fetchAvailabilityUpsample(f.level,f.row,f.col,l,{signal:a}));!1===m.ok?z.throwIfAbortError(m.error):null!=f.id&&(d[f.id]=l)});await z.whenOrAbort(Promise.all(e),
a);b.remapTiles(d)};k._reduceTilesForMaximumRequests=function(b){const a=b.layer.tileInfo;let c=0;const d={},e=m=>{null!=m.id&&(m.id in d?d[m.id]++:(d[m.id]=1,c++))},f=m=>{if(null!=m.id){var p=d[m.id];1===p?(delete d[m.id],c--):d[m.id]=p-1}};b.forEachTileToFetch(e,f);let l=!0;for(;l&&(l=!1,b.forEachTileToFetch(m=>{c<=b.options.maximumAutoTileRequests||(f(m),a.upsampleTile(m)&&(l=!0),e(m))},f),l););};k._selectTilesAutoFinest=function(b){const a=H(b.layer.tileInfo,b.options.minDemResolution);b.selectTilesAtLOD(a,
b.options.maximumAutoTileRequests)};k._selectTilesAutoPrefetchUpsample=async function(b,a){const c=b.layer.tileInfo;await this._populateElevationTiles(b,a);let d=!1;b.forEachTileToFetch((e,f)=>{c.upsampleTile(e)?d=!0:f()});d&&await this._selectTilesAutoPrefetchUpsample(b,a)};k._sampleGeometryWithElevation=function(b){b.geometry.coordinates.forEach(a=>{var c=a.elevationTile;let d=b.options.noDataValue;c&&(c=c.sample(a.x,a.y),w.isSome(c)?d=c:a.elevationTile=null);a.z=d})};k._extractSampleInfo=function(b){const a=
b.layer.tileInfo,c=F.getMetersPerUnitForSR(a.spatialReference);return b.geometry.coordinates.map(d=>{let e=-1;d.elevationTile&&d.elevationTile!==b.outsideExtentTile&&(e=a.lodAt(d.elevationTile.tile.level).resolution*c);return{demResolution:e}})};return u._createClass(g)}(),B=function(){function g(){}var k=g.prototype;k.export=function(){return this._exporter(this.coordinates,this.spatialReference)};k.clone=function(b){const a=new g;a.geometry=this.geometry;a.spatialReference=this.spatialReference;
a.coordinates=b||this.coordinates.map(c=>c.clone());a._exporter=this._exporter;return a};k.project=async function(b,a){if(this.spatialReference.equals(b))return this.clone();await A.initializeProjection([{source:this.spatialReference,dest:b}],{signal:a});a=new G({spatialReference:this.spatialReference,points:this.coordinates.map(d=>[d.x,d.y])});const c=A.project(a,b);if(!c)return null;a=this.coordinates.map((d,e)=>{d=d.clone();e=c.points[e];d.x=e[0];d.y=e[1];return d});a=this.clone(a);a.spatialReference=
b;return a};g.fromGeometry=function(b){const a=new g;a.geometry=b;a.spatialReference=b.spatialReference;if(b instanceof g)a.coordinates=b.coordinates.map(c=>c.clone()),a._exporter=(c,d)=>{c=b.clone(c);c.spatialReference=d;return c};else switch(b.type){case "point":const {hasZ:c,hasM:d}=b;a.coordinates=c&&d?[new r(b.x,b.y,b.z,b.m)]:c?[new r(b.x,b.y,b.z)]:d?[new r(b.x,b.y,null,b.m)]:[new r(b.x,b.y)];a._exporter=(h,n)=>b.hasM?new I(h[0].x,h[0].y,h[0].z,h[0].m,n):new I(h[0].x,h[0].y,h[0].z,n);break;case "multipoint":const {hasZ:e,
hasM:f}=b;a.coordinates=e&&f?b.points.map(h=>new r(h[0],h[1],h[2],h[3])):e?b.points.map(h=>new r(h[0],h[1],h[2])):f?b.points.map(h=>new r(h[0],h[1],null,h[2])):b.points.map(h=>new r(h[0],h[1]));a._exporter=(h,n)=>b.hasM?new G({points:h.map(x=>[x.x,x.y,x.z,x.m]),hasZ:!0,hasM:!0,spatiaReference:n}):new G(h.map(x=>[x.x,x.y,x.z]),n);break;case "polyline":const l=[],m=[],{hasZ:p,hasM:y}=b;let q=0;for(const h of b.paths)if(m.push([q,q+h.length]),q+=h.length,p&&y)for(const n of h)l.push(new r(n[0],n[1],
n[2],n[3]));else if(p)for(const n of h)l.push(new r(n[0],n[1],n[2]));else if(y)for(const n of h)l.push(new r(n[0],n[1],null,n[2]));else for(const n of h)l.push(new r(n[0],n[1]));a.coordinates=l;a._exporter=(h,n)=>{const x=b.hasM?h.map(t=>[t.x,t.y,t.z,t.m]):h.map(t=>[t.x,t.y,t.z]);h=m.map(t=>x.slice(t[0],t[1]));return new O({paths:h,hasM:b.hasM,hasZ:!0,spatialReference:n})}}return a};return u._createClass(g)}(),r=function(){function g(k,b,a=null,c=null,d=null,e=null){this.x=k;this.y=b;this.z=a;this.m=
c;this.tile=d;this.elevationTile=e}g.prototype.clone=function(){return new g(this.x,this.y,this.z,this.m)};return u._createClass(g)}(),M=u._createClass(function(g,k){this.layer=g;this.options=k}),P=function(g){function k(a,c,d){a=b.call(this,a,d);a.outSpatialReference=c;a.type="geometry";return a}u._inherits(k,g);var b=u._createSuper(k);g=k.prototype;g.selectTilesAtLOD=function(a){if(0>a)this.geometry.coordinates.forEach(c=>c.tile=null);else{const c=this.layer.tileInfo,d=c.lods[a].level;this.geometry.coordinates.forEach(e=>
e.tile=c.tileAt(d,e.x,e.y))}};g.allElevationTilesFetched=function(){return!this.geometry.coordinates.some(a=>!a.elevationTile)};g.clearElevationTiles=function(){for(const a of this.geometry.coordinates)a.elevationTile!==this.outsideExtentTile&&(a.elevationTile=null)};g.populateElevationTiles=function(a){for(const c of this.geometry.coordinates)!c.elevationTile&&c.tile?.id&&(c.elevationTile=a[c.tile.id])};g.remapTiles=function(a){for(const c of this.geometry.coordinates){const d=c.tile?.id;c.tile=
d?a[d]:null}};g.getTilesToFetch=function(){const a={},c=[];for(const d of this.geometry.coordinates){const e=d.tile;if(!e)continue;const f=d.tile?.id;d.elevationTile||!f||a[f]||(a[f]=e,c.push(e))}return c};g.forEachTileToFetch=function(a){for(const c of this.geometry.coordinates)c.tile&&!c.elevationTile&&a(c.tile,()=>{c.tile=null})};return u._createClass(k)}(M),Q=function(g){function k(a,c,d,e){d=b.call(this,a,d);d.type="extent";d.elevationTiles=[];d._candidateTiles=[];d._fetchedCandidates=new Set;
d.extent=c.intersection(a.fullExtent);d.maskExtents=e;return d}u._inherits(k,g);var b=u._createSuper(k);g=k.prototype;g.selectTilesAtLOD=function(a,c){c=this._maximumLodForRequests(c);a=Math.min(c,a);0>a?this._candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(a)};g._maximumLodForRequests=function(a){const c=this.layer.tileInfo;if(!a)return c.lods.length-1;const d=this.extent;if(w.isNone(d))return-1;for(let e=c.lods.length-1;0<=e;e--){const f=c.lods[e];if(Math.ceil(d.width/(f.resolution*
c.size[0]))*Math.ceil(d.height/(f.resolution*c.size[1]))<=a)return e}return-1};g.allElevationTilesFetched=function(){return this._candidateTiles.length===this.elevationTiles.length};g.clearElevationTiles=function(){this.elevationTiles.length=0;this._fetchedCandidates.clear()};g.populateElevationTiles=function(a){for(const c of this._candidateTiles){const d=c.id&&a[c.id];d&&(this._fetchedCandidates.add(c),this.elevationTiles.push(d))}};g.remapTiles=function(a){this._candidateTiles=this._uniqueNonOverlappingTiles(this._candidateTiles.map(c=>
a[c.id]))};g.getTilesToFetch=function(){return this._candidateTiles};g.forEachTileToFetch=function(a,c){const d=this._candidateTiles;this._candidateTiles=[];d.forEach(e=>{if(this._fetchedCandidates.has(e))c&&c(e);else{var f=!1;a(e,()=>f=!0);f?c&&c(e):this._candidateTiles.push(e)}});this._candidateTiles=this._uniqueNonOverlappingTiles(this._candidateTiles,c)};g._uniqueNonOverlappingTiles=function(a,c){const d={},e=[];for(const l of a)(a=l.id)&&!d[a]?(d[a]=l,e.push(l)):c&&c(l);const f=e.sort((l,m)=>
l.level-m.level);return f.filter((l,m)=>{for(let p=0;p<m;p++){const y=f[p].extent;if(y&&l.extent&&D.contains(y,l.extent))return c&&c(l),!1}return!0})};g._selectCandidateTilesCoveringExtentAt=function(a){this._candidateTiles.length=0;var c=this.extent;if(!w.isNone(c)){var d=this.layer.tileInfo,e=d.lods[a];a=d.tileAt(e.level,c.xmin,c.ymin);var f=a.extent;if(!w.isNone(f)){var l=Math.ceil((c.xmax-f[0])/(e.resolution*d.size[0]));c=Math.ceil((c.ymax-f[1])/(e.resolution*d.size[1]));for(e=0;e<c;e++)for(f=
0;f<l;f++){const m=new L.TileKey(null,a.level,a.row-e,a.col+f);d.updateTileInfo(m);this._tileIsMasked(m)||this._candidateTiles.push(m)}}}};g._tileIsMasked=function(a){return this.maskExtents?this.maskExtents.some(c=>a.extent&&D.contains(c,a.extent)):!1};return u._createClass(k)}(M);const E={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0};C.ElevationQuery=R;C.GeometryDescriptor=B;C.getFinestLodIndex=H;Object.defineProperty(C,Symbol.toStringTag,
{value:"Module"})});