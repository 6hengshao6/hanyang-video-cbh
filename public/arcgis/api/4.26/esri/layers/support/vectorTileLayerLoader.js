// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../config ../../request ../../core/promiseUtils ../../core/urlUtils ../../views/2d/engine/vectorTiles/style/VectorTileSource".split(" "),function(t,u,y,z,h,A){function m(b){b&&(b=h.getOrigin(b),r&&!r.includes(b)&&r.push(b))}function n(...b){let c=void 0;for(const a of b)null!=a&&(h.isProtocolRelative(a)?c&&(c=c.split("://")[0]+":"+a.trim()):c=h.isAbsolute(a)?a:h.join(c,a));return c?h.removeTrailingSlash(c):void 0}async function p(b,c,a,k,f){z.throwIfAborted(f);let d,g;if("string"===
typeof a){a=h.normalize(a);m(a);var e=await y(a,{...f,responseType:"json",query:{f:"json",...f?.query}});e.ssl&&(d&&(d=d.replace(/^http:/i,"https:")),g&&(g=g.replace(/^http:/i,"https:")));g=d=a}else null!=a&&(e={data:a},d=a.jsonUrl||null,g=k);e=e?.data;if(e?.sources)return b.styleUrl=d||null,B(b,e,g,f);if(!e?.sources)return b.sourceUrl?v(b,e,g,!1,c,f):(b.sourceUrl=d||null,v(b,e,g,!0,c,f));throw Error("You must specify the URL or the JSON for a service or for a style.");}async function B(b,c,a,k){a=
a?h.removeFile(a):h.getAppBaseUrl();b.styleBase=a;b.style=c;b.styleUrl&&m(b.styleUrl);c["sprite-format"]&&"webp"===c["sprite-format"].toLowerCase()&&(b.spriteFormat="webp");const f=[];if(c.sources&&c.sources.esri){const d=c.sources.esri;d.url?await p(b,"esri",n(a,d.url),void 0,k):f.push(p(b,"esri",d,a,k))}for(const d of Object.keys(c.sources))"esri"!==d&&"vector"===c.sources[d].type&&(c.sources[d].url?f.push(p(b,d,n(a,c.sources[d].url),void 0,k)):c.sources[d].tiles&&f.push(p(b,d,c.sources[d],a,k)));
await Promise.all(f)}async function v(b,c,a,k,f,d){a=a?h.removeTrailingSlash(a)+"/":h.getAppBaseUrl();if(c.hasOwnProperty("tileInfo"))var g=c;else{var e={xmin:-2.0037507067161843E7,ymin:-2.0037507067161843E7,xmax:2.0037507067161843E7,ymax:2.0037507067161843E7,spatialReference:{wkid:102100}},l=78271.51696400007,w=2.958287637957775E8,x=[],C=c.hasOwnProperty("minzoom")?+c.minzoom:0,D=c.hasOwnProperty("maxzoom")?+c.maxzoom:22;for(let q=0;q<=D;q++)q>=C&&x.push({level:q,scale:w,resolution:l}),l/=2,w/=2;
for(g of c.tiles??[])m(n(a,g));g={capabilities:"TilesOnly",initialExtent:e,fullExtent:e,minScale:0,maxScale:0,tiles:c.tiles,tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-2.0037508342787E7,y:2.0037508342787E7},lods:x,spatialReference:{wkid:102100}}}}e=new A(f,h.addQueryParameters(a,d?.query??{}),g);if(!k&&b.primarySourceName in b.sourceNameToSource){l=b.sourceNameToSource[b.primarySourceName];if(!l.isCompatibleWith(e))return;null!=e.fullExtent&&(null!=l.fullExtent?l.fullExtent.union(e.fullExtent):
l.fullExtent=e.fullExtent.clone());l.tileInfo&&e.tileInfo&&l.tileInfo.lods.length<e.tileInfo.lods.length&&(l.tileInfo=e.tileInfo)}k?(b.sourceBase=a,b.source=c,b.validatedSource=g,b.primarySourceName=f,b.sourceUrl&&m(b.sourceUrl)):m(a);b.sourceNameToSource[f]=e;if(!b.style){if(null==c.defaultStyles)throw Error();return"string"===typeof c.defaultStyles?p(b,"",n(a,c.defaultStyles,"root.json"),void 0,d):p(b,"",c.defaultStyles,n(a,"root.json"),d)}}const r=u.defaults&&u.defaults.io.corsEnabledServers;t.loadMetadata=
async function(b,c){const a={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[k,f]="string"===typeof b?[b,null]:[null,b.jsonUrl];await p(a,"esri",b,f,c);b={layerDefinition:a.validatedSource,url:k,serviceUrl:a.sourceUrl,style:a.style,styleUrl:a.styleUrl,spriteUrl:a.style.sprite&&n(a.styleBase,a.style.sprite),spriteFormat:a.spriteFormat,glyphsUrl:a.style.glyphs&&n(a.styleBase,a.style.glyphs),
sourceNameToSource:a.sourceNameToSource,primarySourceName:a.primarySourceName};m(b.spriteUrl);m(b.glyphsUrl);return b};Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});