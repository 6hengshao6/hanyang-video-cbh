// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../geometry ../../core/Collection ../../core/collectionUtils ../../core/Evented ../../core/HandleOwner ../../core/Loadable ../../core/Logger ../../core/maybe ../../core/Promise ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/Extent ../../geometry/projection ../../geometry/support/aaBoundingRect ../../geometry/support/intersectsBase ../../geometry/support/spatialReferenceUtils ../graphics/data/BoundsStore ./ImageElement ./MediaElementBase ./MediaElementView ./VideoElement ../../geometry/SpatialReference".split(" "),
function(m,n,h,t,u,v,w,x,y,g,z,A,B,p,O,P,Q,C,D,q,E,F,G,H,I,J,K,L,M){const r=t.ofType({key:"type",defaultKeyValue:"image",base:J,typeMap:{image:I,video:L}});h=function(k){function l(a){var b=N.call(this,a);b._index=new H.BoundsStore;b._elementViewsMap=new Map;b._elementsIndexes=new Map;b._elementsChangedHandler=d=>{for(var e of d.removed){const c=b._elementViewsMap.get(e);b._elementViewsMap.delete(e);b._index.delete(c);b.handles.remove(c);c.destroy();b.notifyChange("fullExtent")}({spatialReference:e}=
m._assertThisInitialized(b));for(const c of d.added){if(b._elementViewsMap.get(c))continue;const f=new K.MediaElementView({spatialReference:e,element:c});b._elementViewsMap.set(c,f);d=B.watch(()=>f.coords,()=>b._updateIndexForElement(f,!1));b._updateIndexForElement(f,!0);b.handles.add(d,f)}b._elementsIndexes.clear();b.elements.forEach((c,f)=>b._elementsIndexes.set(c,f));b.emit("refresh")};b.elements=new r;return b}m._inherits(l,k);var N=m._createSuper(l);k=l.prototype;k.load=async function(a){A.throwIfAborted(a);
this.spatialReference||(a=this.elements.find(b=>g.isSome(b.georeference)&&g.isSome(b.georeference.coords)),this._set("spatialReference",a?g.unwrap(g.unwrap(a.georeference).coords).spatialReference:M.WGS84));this._elementsChangedHandler({added:this.elements.items,removed:[]});this.handles.add(this.elements.on("change",this._elementsChangedHandler));return this};k.destroy=function(){this._index.clear();this._elementViewsMap.clear();this._elementsIndexes.clear()};k.queryElements=async function(a,b){await this.load();
await q.initializeProjection(a.spatialReference,this.spatialReference,null,b);a=G.equals(a.spatialReference,this.spatialReference)?a:q.project(a,this.spatialReference);if(!a)return[];a=a.normalize();const d=[];for(const e of a)this._index.forEachInBounds(E.fromExtent(e),({normalizedCoords:c,element:f})=>{g.isSome(c)&&F.extentIntersectsPolygon(e,c)&&d.push(f)});d.sort((e,c)=>this._elementsIndexes.get(e)-this._elementsIndexes.get(c));return d};k._updateIndexForElement=function(a,b){const d=a.normalizedBounds,
e=this._index.has(a),c=g.isSome(d);this._index.delete(a);c&&this._index.set(a,d);this.notifyChange("fullExtent");b||(e!==c?this.emit("refresh"):this.emit("change",{element:a.element}))};m._createClass(l,[{key:"elements",set:function(a){this._set("elements",u.referenceSetter(a,this._get("elements"),r))}},{key:"fullExtent",get:function(){if("not-loaded"===this.loadStatus)return null;const a=this._index.fullBounds;return g.isNone(a)?null:new D({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.spatialReference})}},
{key:"spatialReference",set:function(a){"not-loaded"!==this.loadStatus?y.getLogger(this.declaredClass).error("#spatialReference","spatialReference cannot be changed after the source is loaded."):this._set("spatialReference",a)}}]);return l}(x.LoadableMixin(z.EsriPromiseMixin(w.HandleOwnerMixin(v.EventedAccessor))));n.__decorate([p.property()],h.prototype,"elements",null);n.__decorate([p.property({readOnly:!0})],h.prototype,"fullExtent",null);n.__decorate([p.property()],h.prototype,"spatialReference",
null);return h=n.__decorate([C.subclass("esri.layers.support.LocalMediaElementSource")],h)});