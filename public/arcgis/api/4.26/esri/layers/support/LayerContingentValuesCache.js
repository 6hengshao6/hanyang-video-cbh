// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/JSONSupport ../../core/Loadable ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ./arcgisLayerUrl ./Contingency ./ContingencyConstraintViolation ./ContingentValue ./ContingentValuesResult ./FieldGroup ./Subtype".split(" "),function(E,A,B,u,L,C,D,P,Q,R,M,F,H,I,t,N,G,J){var x;
u=x=function(h){function y(a){a=O.call(this,a);a.request=B;a.fieldGroups=null;a.fieldGroupDefinitions=null;return a}E._inherits(y,h);var O=E._createSuper(y);h=y.prototype;h.initialize=function(){};y.createLoadedLayerContingentValuesCache=async function(a){await a.load();if(void 0===a.layerId)return null;var b=a.sourceJSON.hasContingentValuesDefinition;if(b)return(new x({layer:a})).load();if(void 0===b){b=F.parse(a.url);if(C.isNone(b))return null;b=b.url.path;if((await x._staticFetchEnterpriseFeatureRoot(b)).supportsQueryDataElements&&
(b=await x._staticFetchEnterpriseFieldGroup(b,a.layerId.toString())))return b=b.map(c=>({name:c.name,isEditingRestrictive:c.isEditingRestrictive,fields:c.fieldNames.names})),(new x({layer:a,fieldGroupDefinitions:b})).load()}return null};h.load=async function(a){const b=this.layer.load(a).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,a));this.addResolvingPromise(b);return this};h.validateContingencyConstraints=function(a,b){const c=Object.keys(a),e=[],d=[];for(const m of this.fieldGroups){const k=
m.isEditingRestrictive?"error":"warning";if(b&&!m.fields.some(g=>b.includes(g)))continue;if(!m.fields.every(g=>c.includes(g))){d.push(new I({fieldGroup:m,type:k}));continue}let n=!1;const q=a[this.subtypeFieldName];var f=m.contingencies.filter(g=>!g.isRetired&&g.subtype?g.subtype.code===q:!0);for(const g of f){f=!0;for(const r in g.values){const p=g.values[r];if("any"!==p.objectType)if("null"===p.objectType){if(null!=a[r]){f=!1;break}}else if("code"===p.objectType){if(a[r]!==p.codedValue.code){f=
!1;break}}else if("range"===p.objectType){const l=a[r];if(l<p.minValue||l>p.maxValue){f=!1;break}}}if(f){n=!0;break}}n||e.push(new I({fieldGroup:m,type:k}))}return{invalid:e,incomplete:d}};h.getContingentValues=function(a,b,c=!1){const e=a[this.subtypeFieldName],d=void 0!==e&&null!==e,f={};let m=[];const k=this.fieldGroups.filter(q=>q.fields.includes(b));m.push(new t({objectType:"any"}));for(const q of k){let g=[];var n=q.contingencies.filter(l=>!l.isRetired&&(l.subtype&&d?l.subtype.code===e:!0));
let r=!1;const p={};for(const l of n){let v;n=!0;for(const z in l.values){const w=l.values[z];if(b===z)v=w,r=r||"range"===w.objectType;else if(void 0!==a[z]&&"any"!==w.objectType)if("null"===w.objectType)null!==a[z]&&(n=!1);else if("code"===w.objectType)a[z]!==w.codedValue.code&&(n=!1);else if("range"===w.objectType){const K=a[z];if(K<w.minValue||K>w.maxValue)n=!1}}if(v&&n){if("any"===v.objectType){g.length=0;g.push(v);break}n=this._generateKey(v);p[n]||g.push(v);p[n]=!0}}r&&(g=this._joinRange(g));
f[q.name]=g;m=c?this._filterIntersection(m,g):[]}1===k.length&&c&&(m=[]);return new N({contingentValuesAllGroups:m,contingentValuesByFieldGroup:f})};h._generateKey=function(a){switch(a.objectType){case "any":return"@any@";case "null":return"@null@";case "code":return a.codedValue.name+a.codedValue.code.toString();case "range":return a.minValue.toString()+"-"+a.maxValue.toString()}};h._joinRange=function(a){a.sort((d,f)=>"null"===d.objectType?-1:"null"===f.objectType?1:d.minValue-f.minValue);let b,
c;const e=[];for(const d of a)"null"===d.objectType?e.push(d):null==b||null==c?(b=d.minValue,c=d.maxValue):c<d.minValue?(e.push(new t({objectType:"range",minValue:b,maxValue:c})),b=d.minValue,c=d.maxValue):c<d.maxValue&&(c=d.maxValue);e.push(new t({objectType:"range",minValue:b,maxValue:c}));return e};h._filterIntersection=function(a,b){if(0===a.length||0===b.length)return[];if("any"===a[0].objectType)return b;if("any"===b[0].objectType)return a;const c="range"===b[0].objectType||"range"===b[1]?.objectType;
return"range"===a[0].objectType||"range"===a[1]?.objectType||c?this._intersectRanges(a,b):this._intersectValues(a,b)};h._intersectRanges=function(a,b){const c=[];let e=0;for(const d of a)for(;e<b.length;e++){const f=b[e];if("null"===d.objectType&&"null"===f.objectType)c.push(new t({objectType:"null"}));else if("null"===d.objectType)break;else if("null"===f.objectType)continue;if(d.maxValue<f.minValue)break;if(d.maxValue===f.minValue){c.push(new t({objectType:"range",minValue:d.maxValue,maxValue:f.minValue}));
break}if(!(d.minValue>f.maxValue))if(d.minValue===f.maxValue)c.push(new t({objectType:"range",minValue:d.minValue,maxValue:f.maxValue}));else{a=d.minValue>f.minValue?d.minValue:f.minValue;if(d.maxValue<f.maxValue){c.push(new t({objectType:"range",minValue:a,maxValue:d.maxValue}));break}c.push(new t({objectType:"range",minValue:a,maxValue:f.maxValue}))}}return c};h._intersectValues=function(a,b){const c=[];for(const e of a)b.some(d=>{if(e.objectType===d.objectType)switch(e.objectType){case "any":case "null":return!0;
case "code":return e.codedValue.code===d.codedValue.code&&e.codedValue.name===d.codedValue.name}return!1})&&c.push(e);return c};y._staticFetchEnterpriseFeatureRoot=async function(a,b){return B(a,{responseType:"json",query:{f:"json"},...b}).then(c=>c.data)};y._staticFetchEnterpriseFieldGroup=async function(a,b,c){return B(`${a}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},...c}).then(e=>e.data.layerDataElements?.[0].dataElement.fieldGroups)};h._initializeContingentValues=
async function(a,b){a=a??await this._fetchFieldGroupDefs(b);this.fieldGroups=0===a.length?[]:await this._fetchContingentValues(a,b)};h._fetchFieldGroupDefs=async function(a){if(void 0===this.layer.layerId)return[];const b=this.layer.sourceJSON,c=this.layer.layerId.toString(),e=C.unwrap(F.parse(this.layer.url)).url.path;return b.hasContingentValuesDefinition?(await this._fetchAGOLFieldGroup(e,c,a)).map(d=>({name:d.name,isEditingRestrictive:d.restrictive,fields:d.fields.map(f=>this.layer.fieldsIndex.normalizeFieldName(f))})):
void 0!==b.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(e,a).then(async d=>d.supportsQueryDataElements?(await this._fetchEnterpriseFieldGroup(e,c,a)).map(f=>({name:f.name,isEditingRestrictive:f.isEditingRestrictive,fields:f.fieldNames.names.map(m=>this.layer.fieldsIndex.normalizeFieldName(m))})):[])};h._fetchAGOLFieldGroup=async function(a,b,c){return B(`${a}/${b}/fieldgroups`,{responseType:"json",query:{f:"json"},...c}).then(e=>e.data.fieldGroups)};h._fetchEnterpriseFieldGroup=
async function(a,b,c){return x._staticFetchEnterpriseFieldGroup(a,b,c)};h._fetchEnterpriseFeatureRoot=async function(a,b){return x._staticFetchEnterpriseFeatureRoot(a,b)};h._fetchContingentValues=async function(a,b){if(void 0===this.layer.layerId)return[];const c=this.layer.sourceJSON,e=this.layer.layerId.toString(),d=C.unwrap(F.parse(this.layer.url)).url.path;if(c.hasContingentValuesDefinition)return b=await this._fetchAGOLContingentValues(d,e,b),this._constructFieldGroupsAGOL(a,b);b=await this._fetchEnterpriseContingentValues(d,
e,b);return this._constructFieldGroupsEnterprise(a,b)};h._constructFieldGroupsAGOL=function(a,b){return a.map(c=>{const e=b.contingentValuesDefinition.fieldGroups.find(d=>d.name===c.name);if(e){let d=[];d=b.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(c,b,e.subTypes):this._parseAGOLFieldGroup(c,b,e.contingentValues);return new G({name:c.name,isEditingRestrictive:c.isEditingRestrictive,fields:c.fields,contingencies:d})}return null}).filter(C.isSome)};h._parseAGOLFieldGroupSubtype=
function(a,b,c){let e=[];c?.forEach(d=>{const f=this._getSubtypeAGOL(d.name);e=e.concat(this._parseAGOLFieldGroup(a,b,d.contingentValues,f))});return e};h._parseAGOLFieldGroup=function(a,b,c,e=null){const d=[];for(const f of c??[])c=this._parseAGOLContingency(f,a,b,e),d.push(c);return d};h._parseAGOLContingency=function(a,b,c,e){const d=a.id,f=a.retired?1===a.retired:!1,m={};for(let n=0,q=0;n<b.fields.length;n++){const g=b.fields[n];var k=c.typeCodes[a.types[n]];if("Code"===k){let r=a.values[q];q++;
const p=this._getDomain(e,g);"string"===this.layer.getField(g)?.type&&(k=c.stringDicts.find(l=>l.domain===p.name))&&(r=k.entries[r]);k=p.codedValues.find(l=>l.code===r);k=new t({codedValue:k,objectType:"code"});m[g]=k}else"Range"===k?(k=a.values[q],q++,k=new t({minValue:k.range[0],maxValue:k.range[1],objectType:"range"}),m[g]=k):"Any"===k?(k=new t({objectType:"any"}),m[g]=k):(k=new t({objectType:"null"}),m[g]=k)}return new H({id:d,isRetired:f,subtype:e,values:m})};h._constructFieldGroupsEnterprise=
function(a,b){const c=b.fieldGroups;return a.map(e=>{var d=c.find(f=>f.name===e.name);return d?(d=d.contingencies.map(f=>{const m=f.id,k=f.isRetired||!1,n=this._getSubtypeEnterprise(f.subtypeCode),q={};for(let r=0;r<e.fields.length;r++){const p=e.fields[r];let l=f.values[r];if("number"===typeof l||"string"===typeof l){var g=this._getDomain(n,p);const v=this.layer.getField(p);"string"===v?.type?l=b.stringDictionary[l]:"date"===v?.type&&(l=(new Date(`${l}+00:00`)).getTime());g=g.codedValues.find(z=>
z.code===l);g=new t({codedValue:g,objectType:"code"});q[p]=g}else"object"===typeof l?(g=new t({minValue:l.minValue,maxValue:l.maxValue,objectType:"range"}),q[p]=g):l?(g=new t({objectType:"any"}),q[p]=g):(g=new t({objectType:"null"}),q[p]=g)}return new H({id:m,isRetired:k,subtype:n,values:q})}),new G({name:e.name,isEditingRestrictive:e.isEditingRestrictive,fields:e.fields,contingencies:d})):null}).filter(C.isSome)};h._fetchEnterpriseContingentValues=async function(a,b,c){return B(`${a}/queryContingentValues`,
{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},...c}).then(e=>e.data.contingentValueSets?.[0])};h._fetchAGOLContingentValues=async function(a,b,c){return B(`${a}/${b}/contingentValues`,{responseType:"json",query:{f:"json"},...c}).then(e=>e.data)};h._getSubtypeEnterprise=function(a){var b=this.layer.sourceJSON;let c;b.subtypes&&(b=b.subtypes.find(e=>e.code===a),c=J.fromJSON(b));return c||null};h._getSubtypeAGOL=function(a){var b=this.layer.sourceJSON;let c;b.subtypes&&(b=b.subtypes.find(e=>
e.name===a),c=J.fromJSON(b));return c||null};h._getDomain=function(a,b){a=a?a.domains?.[b]:this.layer.getFieldDomain(b);return"inherited"===a?.type?this.layer.getFieldDomain(b):a};E._createClass(y,[{key:"subtypeFieldName",get:function(){const {layer:a}=this;return"subtype-group"===a.type?a.subtypeField:a.typeIdField}}]);return y}(u.JSONSupportMixin(L));A.__decorate([D.property({constructOnly:!0})],u.prototype,"layer",void 0);A.__decorate([D.property({constructOnly:!0})],u.prototype,"request",void 0);
A.__decorate([D.property({type:[G]})],u.prototype,"fieldGroups",void 0);A.__decorate([D.property({constructOnly:!0})],u.prototype,"fieldGroupDefinitions",void 0);A.__decorate([D.property()],u.prototype,"subtypeFieldName",null);return u=x=A.__decorate([M.subclass("esri.layers.support.LayerContingentValuesCache")],u)});