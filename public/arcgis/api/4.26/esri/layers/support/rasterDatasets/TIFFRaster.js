// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../RasterInfo ../RasterStorageInfo ./BaseRaster ./DBFParser ./pamParser ../rasterFormats/TiffDecoder ../rasterFormats/TiffTags ../rasterFunctions/stretchUtils ../rasterTransforms/PolynomialTransform ../../../rest/support/FeatureSet ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(J,D,z,K,A,G,aa,ba,ca,O,P,Q,R,S,M,B,H,T,U,V,W,N,E){z=function(t){function I(){var b=X.apply(this,arguments);b._files=null;b._headerInfo=null;b._bufferSize=1048576;b.datasetFormat="TIFF";return b}J._inherits(I,t);var X=J._createSuper(I);t=I.prototype;t.open=async function(b){await this.init();var a=b?A.unwrap(b.signal):null,{data:c}=await this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:a});if(!c)throw new K("tiffraster:open","failed to open url "+
this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf("."));const {littleEndian:d,firstIFDPos:e,isBigTiff:k}=B.parseSignature(c);var f=[];await this._readIFDs(f,c,d,e,0,k?8:4,a);const {imageInfo:h,rasterInfo:g}=this._parseIFDs(f);a=B.getPyramidIFDs(f);c=B.getMaskIFDs(f);this._headerInfo={littleEndian:d,isBigTiff:k,ifds:f,pyramidIFDs:a,maskIFDs:c,...h};this._set("rasterInfo",g);if(!h.isSupported)throw new K("tiffraster:open","this tiff is not supported: "+h.message);
if(!h.tileWidth)throw new K("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");({skipExtensions:f=[]}=this.ioConfig);f.includes("aux.xml")||(a=await this._fetchAuxiliaryMetaData(b),null!=a&&this._processPAMInfo(a,g));f.includes("vat.dbf")||1!==g.bandCount||"u8"!==g.pixelType||(g.attributeTable=await this._fetchAuxiliaryTable(b),A.isSome(g.attributeTable)&&(g.keyProperties.DataType="thematic"));this.updateTileInfo()};t.fetchRawTile=async function(b,a,c,d={}){if(!this._headerInfo?.isSupported||
this.isBlockOutside(b,a,c))return null;const e=await this._fetchRawTiffTile(b,a,c,!1,d);A.isSome(e)&&this._headerInfo.hasMaskBand&&(b=await this._fetchRawTiffTile(b,a,c,!0,d),A.isSome(b)&&b.pixels[0]instanceof Uint8Array&&(e.mask=b.pixels[0]));return e};t._parseIFDs=function(b){const a=B.getImageInfo(b),{width:c,height:d,tileWidth:e,tileHeight:k,planes:f,pixelType:h,compression:g,firstPyramidLevel:u,maximumPyramidLevel:x,pyramidBlockWidth:y,pyramidBlockHeight:q,tileBoundary:v,affine:m,metadata:r}=
a;let p=M.parseSpatialReference(a.extent.spatialReference?.wkt||a.extent.spatialReference?.wkid);var l=!!a.isPseudoGeographic;null==p&&(l=!0,p=new W({wkid:3857}));const n=new N({...a.extent,spatialReference:p});var w=n?new E({x:n.xmin,y:n.ymax,spatialReference:p}):new E({x:0,y:0});w=new Q({blockWidth:e,blockHeight:k,pyramidBlockWidth:y,pyramidBlockHeight:q,compression:g,origin:w,firstPyramidLevel:u,maximumPyramidLevel:x,blockBoundary:v});const Y=new E({x:(n.xmax-n.xmin)/c,y:(n.ymax-n.ymin)/d,spatialReference:p}),
Z=r?{BandProperties:r.bandProperties,DataType:r.dataType}:{};let L=null;var F=b[0].get("PHOTOMETRICINTERPRETATION")?.values?.[0];b=b[0].get("COLORMAP")?.values;if(3>=F&&3<b?.length&&0===b.length%3){L=[];F=b.length/3;for(let C=0;C<F;C++)L.push([C,b[C]>>>8,b[C+F]>>>8,b[C+2*F]>>>8])}l=new P({width:c,height:d,bandCount:f,pixelType:h,pixelSize:Y,storageInfo:w,spatialReference:p,isPseudoSpatialReference:l,keyProperties:Z,extent:n,colormap:L,statistics:r?r.statistics:null});m?.length&&(l.nativeExtent=new N({xmin:-.5,
ymin:.5-d,xmax:c-.5,ymax:.5,spatialReference:p}),l.transform=new U({polynomialOrder:1,forwardCoefficients:[m[2]+m[0]/2,m[5]-m[3]/2,m[0],m[3],-m[1],-m[4]]}),l.extent=l.transform.forwardTransform(l.nativeExtent),l.pixelSize=new E({x:(n.xmax-n.xmin)/c,y:(n.ymax-n.ymin)/d,spatialReference:p}),w.origin.x=-.5,w.origin.y=.5);return{imageInfo:a,rasterInfo:l}};t._processPAMInfo=function(b,a){a.statistics=b.statistics??a.statistics;(a.histograms=b.histograms)&&A.isNone(a.statistics)&&(a.statistics=T.estimateStatisticsFromHistograms(b.histograms));
if(b.transform&&A.isNone(a.transform)){a.transform=b.transform;a.nativeExtent=a.extent;const c=a.transform.forwardTransform(a.nativeExtent);a.pixelSize=new E({x:(c.xmax-c.xmin)/a.width,y:(c.ymax-c.ymin)/a.height,spatialReference:a.spatialReference});a.extent=c}a.isPseudoSpatialReference&&b.spatialReference&&(a.spatialReference=b.spatialReference,a.extent.spatialReference=a.nativeExtent.spatialReference=a.storageInfo.origin.spatialReference=a.spatialReference)};t._readIFDs=async function(b,a,c,d,e,
k=4,f){if(!d)return null;if(d>=a.byteLength||0>d)a=(await this.request(this.url,{range:{from:d+e,to:d+e+this._bufferSize},responseType:"array-buffer",signal:f})).data,e=d+e,d=0;d=await this._readIFD(a,c,d,e,H.TIFF_TAGS,k,f);b.push(d.ifd);if(!d.nextIFD)return null;await this._readIFDs(b,a,c,d.nextIFD-e,e,k,f)};t._readIFD=async function(b,a,c,d,e=H.TIFF_TAGS,k=4,f){if(!b)return null;c=B.parseIFD(b,a,c,d,e,k);if(c.success){const h=[];c.ifd?.forEach(g=>{g.values||h.push(g)});0<h.length&&(k=h.map(g=>g.offlineOffsetSize).filter(A.isSome),
e=Math.min.apply(null,k.map(g=>g[0])),Math.min.apply(null,k.map(g=>g[0]+g[1]))-e<=this._bufferSize&&({data:k}=await this.request(this.url,{range:{from:e,to:e+this._bufferSize},responseType:"array-buffer",signal:f}),b=k,d=e,h.forEach(g=>B.parseFieldValues(b,a,g,d))));c.ifd?.has("GEOKEYDIRECTORY")&&(e=c.ifd.get("GEOKEYDIRECTORY"),(k=e?.values)&&4<k.length&&(k=k[0]+"."+k[1]+"."+k[2],f=await this._readIFD(b,a,e.valueOffset+6-d,d,H.GEO_KEYS,2,f),e.data=f.ifd,e.data&&e.data.set("GEOTIFFVersion",{id:0,type:2,
valueCount:1,valueOffset:null,values:[k]})));return c}if(c.requiredBufferSize&&c.requiredBufferSize!==b.byteLength)return b=(await this.request(this.url,{range:{from:d,to:d+c.requiredBufferSize+4},responseType:"array-buffer",signal:f})).data,b.byteLength<c.requiredBufferSize?null:this._readIFD(b,a,0,d,H.TIFF_TAGS,4,f)};t._fetchRawTiffTile=async function(b,a,c,d,e={}){a=this._getTileLocation(b,a,c,d);if(!a)return null;const {ranges:k,actualTileWidth:f,actualTileHeight:h,ifd:g}=a;a=k.map(q=>this.request(this.url,
{range:q,responseType:"array-buffer",signal:e.signal}));a=await Promise.all(a);c=a.map(q=>q.data.byteLength).reduce((q,v)=>q+v);c=1===a.length?a[0].data:new ArrayBuffer(c);d=[0];var u=[0];if(1<a.length){const q=new Uint8Array(c);for(let v=0,m=0;v<a.length;v++){const r=a[v].data;q.set(new Uint8Array(r),m);d[v]=m;m+=r.byteLength;u[v]=r.byteLength}}const {blockWidth:x,blockHeight:y}=this.getBlockWidthHeight(b);b=await this.decodePixelBlock(c,{format:"tiff",customOptions:{headerInfo:this._headerInfo,
ifd:g,offsets:d,sizes:u},width:x,height:y,planes:null,pixelType:null});if(null==b)return null;if(f!==x||h!==y)if(u=b.mask)for(a=0;a<y;a++)for(d=a*x,c=a<h?f:0;c<x;c++)u[d+c]=0;else for(u=new Uint8Array(x*y),b.mask=u,a=0;a<h;a++)for(d=a*x,c=0;c<f;c++)u[d+c]=1;return b};t._getTileLocation=function(b,a,c,d=!1){const {firstPyramidLevel:e,blockBoundary:k}=this.rasterInfo.storageInfo;var f=0===b?0:b-(e-1);({_headerInfo:b}=this);if(!b)return null;d=d?b.maskIFDs[f]:0===f?b?.ifds[0]:b?.pyramidIFDs[f-1];if(!d)return null;
var h=B.isBSQConfig(d,b);b=d.get("TILEOFFSETS")?.values;if(void 0===b)return null;var g=d.get("TILEBYTECOUNTS")?.values;const {minRow:u,minCol:x,maxRow:y,maxCol:q}=k[f];if(a>y||c>q||a<u||c<x)return null;f=d.get("IMAGEWIDTH")?.values?.[0];const v=d.get("IMAGELENGTH")?.values?.[0],m=d.get("TILEWIDTH")?.values?.[0],r=d.get("TILELENGTH")?.values?.[0],p=h?this.rasterInfo.bandCount:1,l=p*a*(q+1)+c,n=[{from:b[l],to:b[l+p-1]+g[l+p-1]-1}];if(h){h=!0;for(let w=0;w<p;w++)if(b[l+w]+g[l+w]!==b[l+w+1]){h=!1;break}if(!h)for(h=
0;h<p;h++)n[h]={from:b[l+h],to:b[l+h]+g[l+h]-1}}g=g[l];return null==b[l]||null==g?null:{ranges:n,ifd:d,actualTileWidth:c===q?f%m||m:m,actualTileHeight:a===y?v%r||r:r}};t._fetchAuxiliaryMetaData=async function(b){try{const {data:a}=await this.request(this.url+".aux.xml",{responseType:"xml",signal:b?.signal});return M.parsePAMInfo(a)}catch{return null}};t._fetchAuxiliaryTable=async function(b){try{const {data:a}=await this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:b?.signal}),
c=S.parse(a);return c?.recordSet?V.fromJSON(c.recordSet):null}catch{return null}};return J._createClass(I)}(R);D.__decorate([G.property()],z.prototype,"_files",void 0);D.__decorate([G.property()],z.prototype,"_headerInfo",void 0);D.__decorate([G.property()],z.prototype,"_bufferSize",void 0);D.__decorate([G.property({type:String,json:{write:!0}})],z.prototype,"datasetFormat",void 0);return z=D.__decorate([O.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],z)});