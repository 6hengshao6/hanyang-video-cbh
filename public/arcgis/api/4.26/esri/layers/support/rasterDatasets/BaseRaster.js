// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../request ../../../core/Error ../../../core/JSONSupport ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../arcgisLayerUrl ../commonProperties ../DimensionalDefinition ../LOD ../RasterStorageInfo ../TileInfo ./multidimensionalUtils ./RawBlockCache ../rasterFormats/pixelRangeUtils ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../rasterFunctions/rasterProjectionHelper ../rasterFunctions/vectorFieldUtils ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(U,B,A,aa,V,ba,ca,t,da,ea,C,fa,ra,sa,ha,ia,ja,ka,la,ma,W,P,D,na,oa,J,x,X,K,H){A=function(u){function L(){var a=pa.apply(this,arguments);a.rasterJobHandler=null;a.datasetName=null;a.datasetFormat=null;a.hasUniqueSourceStorageInfo=!0;a.rasterInfo=null;a.ioConfig={sampling:"closest"};return a}U._inherits(L,u);var pa=U._createSuper(L);u=L.prototype;u.init=async function(){const a=x.load();this.addResolvingPromise(a);await this.when()};u.normalizeCtorArgs=function(a){a&&a.ioConfig&&(a={...a,ioConfig:{resolution:null,
bandIds:null,sampling:"closest",tileInfo:W.create(),...a.ioConfig}});return a};u.open=async function(a){throw new V("BaseRaster:open-not-implemented","open() is not implemented");};u.fetchTile=async function(a,b,d,c={}){const e=c.tileInfo||this.rasterInfo.storageInfo.tileInfo;a=this.getTileExtentFromTileInfo(a,b,d,e);return this.fetchPixels(a,e.size[0],e.size[1],c)};u.identify=async function(a,b={}){a=fa.ensureClass(H,a).clone().normalize();const {multidimensionalDefinition:d,timeExtent:c}=b;var {rasterInfo:e}=
this;const {hasMultidimensionalTranspose:g,multidimensionalInfo:f}=e;var {transposedVariableName:h}=b,l=t.isSome(f)&&g&&(null!=c||P.isMultiSliceOrRangeDefinition(d));l&&!h&&(h=t.isSome(d)&&0<d.length?d[0].variableName??void 0:f.variables[0].name,b={...b,transposedVariableName:h});b=this._getRequestOptionsWithSliceId(b);const {spatialReference:m,extent:p}=e;var {datumTransformation:n}=b;n=x.projectPoint(a,m,n);if(!p.intersects(n)||t.isSome(e.transform)&&(n=e.transform.inverseTransform(n),!e.nativeExtent.intersects(n)))return{location:n,
value:null};let r=0;var q=t.isSome(h)&&t.isSome(f)&&e.hasMultidimensionalTranspose;if("Function"===this.datasetFormat){l=this.primaryRasters.rasters[0];if(q)return l.identify(n,b);({pixelSize:q}=e);b=3*q.x/2;q=3*q.y/2;b=new K({xmin:n.x-b,xmax:n.x+b,ymin:n.y-q,ymax:n.y+q,spatialReference:m});q={interpolation:"nearest"};({pixelBlock:l}=await l.fetchPixels(b,3,3,q));({pixelBlock:b}=await this.fetchPixels(b,3,3,q));if(t.isNone(l))return{location:n,value:null};l=!l.mask||l.mask[4]?l.pixels.map(E=>E[4]):
null;var k;t.isSome(b)&&(k=!b.mask||b.mask[4]?b.pixels.map(E=>E[4]):void 0);return{location:n,value:l,processedValue:k,pyramidLevel:0}}if(!q)if(b.srcResolution)r=x.snapPyramid(b.srcResolution,e,this.ioConfig.sampling).pyramidLevel;else if(r=await this.computeBestPyramidLevelForLocation(a,b),null==r)return{location:n,value:null};k=this.identifyPixelLocation(n,r,null,q);if(null===k)return{location:n,value:null};const {row:v,col:w,rowOffset:y,colOffset:z,blockWidth:F}=k;k=h??t.unwrap(b.sliceId);k=D.getRasterId(this.url,
k);e=`${r}/${v}/${w}`;h=D.getBlock(k,null,e);t.isNone(h)&&(h=this.fetchRawTile(r,v,w,b),D.putBlock(k,null,e,h));k=await h;return t.isNone(k)||!k.pixels?.length?{location:n,value:null}:this._processIdentifyResult(k,{srcLocation:n,position:y*F+z,pyramidLevel:r,useTransposedTile:!!q,requestSomeSlices:l,identifyOptions:b})};u.fetchPixels=async function(a,b,d,c={}){a=x.snapExtent(a);c=this._getRequestOptionsWithSliceId(c);var {_hasNoneOrGCSShiftTransform:e}=this;if(c.requestRawData&&e)return this._fetchPixels(a,
b,d,c);var g=x.getWorldWidth(a.spatialReference),f=x.getWorldWrapCount(a);if(t.isNone(g)||0===f||1===f&&this._isGlobalWrappableSource&&e)return this._fetchPixels(a,b,d,c);if(3<=f)return{extent:a,pixelBlock:null};const h=[],{xmin:l,xmax:m}=a,p=Math.round(g/(m-l)*b),n=p-Math.round((g/2-l)/(m-l)*b);let r=0;e=[];for(let k=0;k<=f;k++){var q=new K({xmin:0===k?l:-g/2,xmax:k===f?m-g*k:g/2,ymin:a.ymin,ymax:a.ymax,spatialReference:a.spatialReference});const v=0===k?p-n:k===f?b-r:p;r+=v;e.push(v);q=c.disableWrapAround&&
0<k?null:this._fetchPixels(q,v,d,c);h.push(q)}g=(await Promise.all(h)).map(k=>k?.pixelBlock);f=null;b={width:b,height:d};f=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:g,srcMosaicSize:b,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:e},c)).pixelBlock:J.mosaic(g,b,{blockWidths:e});c=x.projectExtent(a,this.rasterInfo.spatialReference,c.datumTransformation);return{extent:a,srcExtent:c,pixelBlock:f}};u.fetchRawPixels=
async function(a,b,d,c={}){b={x:Math.floor(b.x),y:Math.floor(b.y)};const e=await this._fetchRawTiles(a,b,d,c),{nativeExtent:g,nativePixelSize:f,storageInfo:h}=this.rasterInfo;var l=2**a,m=f.x*l;l*=f.y;m=new K({xmin:g.xmin+m*b.x,xmax:g.xmin+m*(b.x+d.width-1),ymin:g.ymax-l*(b.y+d.height-1),ymax:g.ymax-l*b.y,spatialReference:g.spatialReference});if(!e)return{extent:m,srcExtent:m,pixelBlock:null};const {pixelBlocks:p,mosaicSize:n}=e;if(1===p.length&&t.isSome(p[0])&&p[0].width===d.width&&p[0].height===
d.height)return{extent:m,srcExtent:m,pixelBlock:e.pixelBlocks[0]};a={x:b.x%(0<a?h.pyramidBlockWidth:h.blockWidth),y:b.y%(0<a?h.pyramidBlockHeight:h.blockHeight)};d=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:p,srcMosaicSize:n,destDimension:d,clipOffset:a,clipSize:d,coefs:null,sampleSpacing:null,interpolation:c.interpolation,alignmentInfo:null,blockWidths:null},c)).pixelBlock:J.mosaic(p,n,{clipOffset:a,clipSize:d});return{extent:m,srcExtent:m,pixelBlock:d}};
u.fetchRawTile=function(a,b,d,c){throw new V("BaseRaster:read-not-implemented","fetchRawTile() is not implemented");};u.computeExtent=function(a){return x.projectExtent(this.rasterInfo.extent,a)};u.decodePixelBlock=function(a,b){return!this.rasterJobHandler||b.useCanvas?oa.decode(a,b):this.rasterJobHandler.decode({data:a,options:b})};u.request=async function(a,b,d=0){const {customFetchParameters:c}=this.ioConfig,{range:e,query:g,headers:f}=b;d=d??b.retryCount??this.ioConfig.retryCount;const h=e?{Range:`bytes=${e.from}-${e.to}`}:
null;try{return await aa(a,{...b,query:{...g,...c},headers:{...f,...h}})}catch(l){if(0<d)return d--,this.request(a,b,d);throw l;}};u.getSliceIndex=function(a){const {multidimensionalInfo:b}=this.rasterInfo;return t.isNone(b)||t.isNone(a)||0===a.length?null:P.getSliceIndex(a,b)};u.getTileExtentFromTileInfo=function(a,b,d,c){a=t.unwrapOrThrow(c.lodAt(a));return this.getTileExtent({x:a.resolution,y:a.resolution},b,d,c.origin,c.spatialReference,c.size)};u.updateTileInfo=function(){const {storageInfo:a,
spatialReference:b,extent:d,pixelSize:c}=this.rasterInfo;if(!a.tileInfo){const g=[];var e=a.maximumPyramidLevel||0;let f=Math.max(c.x,c.y),h=1/.0254*96*f;for(let l=0;l<=e;l++)g.push(new la({level:e-l,resolution:f,scale:h})),f*=2,h*=2;e=new H({x:d.xmin,y:d.ymax,spatialReference:b});a.tileInfo=new W({origin:e,size:[a.blockWidth,a.blockHeight],spatialReference:b,lods:g});a.isVirtualTileInfo=!0}};u.createRemoteDatasetStorageInfo=function(a,b=512,d=512,c){const {width:e,height:g,nativeExtent:f,pixelSize:h,
spatialReference:l}=a,m=new H({x:f.xmin,y:f.ymax,spatialReference:l});null==c&&(c=Math.max(0,Math.round(Math.log(Math.max(e,g))/Math.LN2-8)));const p=this.computeBlockBoundary(f,512,512,{x:f.xmin,y:f.ymax},[h],c);a.storageInfo=new ma({blockWidth:b,blockHeight:d,pyramidBlockWidth:b,pyramidBlockHeight:d,origin:m,firstPyramidLevel:1,maximumPyramidLevel:c,blockBoundary:p})};u.computeBestPyramidLevelForLocation=async function(a,b){return 0};u.computeBlockBoundary=function(a,b,d,c,e,g=0,f=2){if(1===e.length&&
0<g){e=[...e];let {x:m,y:p}=e[0];for(let n=0;n<g;n++)m*=f,p*=f,e.push({x:m,y:p})}g=[];const {x:h,y:l}=c;for(c=0;c<e.length;c++){const {x:m,y:p}=e[c];g.push({minCol:Math.floor((a.xmin-h+.1*m)/b/m),maxCol:Math.floor((a.xmax-h-.1*m)/b/m),minRow:Math.floor((l-a.ymax+.1*p)/d/p),maxRow:Math.floor((l-a.ymin-.1*p)/d/p)})}return g};u.getPyramidPixelSize=function(a){const {nativePixelSize:b}=this.rasterInfo,{pyramidResolutions:d,pyramidScalingFactor:c}=this.rasterInfo.storageInfo;if(0===a)return b;if(t.isSome(d)&&
d.length)return d[a-1];a=c**a;return{x:b.x*a,y:b.y*a}};u.identifyPixelLocation=function(a,b,d,c){const {spatialReference:e,nativeExtent:g,storageInfo:f}=this.rasterInfo,{maximumPyramidLevel:h,origin:l,transposeInfo:m}=f,p=c&&t.isSome(m)?m.tileSize[0]:f.blockWidth;c=c&&t.isSome(m)?m.tileSize[1]:f.blockHeight;a=x.projectPoint(a,e,d);if(!g.intersects(a)||0>b||b>h)return null;d=this.getPyramidPixelSize(b);const {x:n,y:r}=d;d=(l.y-a.y)/r/c;const q=(a.x-l.x)/n/p;return{pyramidLevel:b,row:Math.floor(d),
col:Math.floor(q),rowOffset:Math.min(c-1,Math.floor((d-Math.floor(d))*c)),colOffset:Math.min(p-1,Math.floor((q-Math.floor(q))*p)),blockWidth:p,srcLocation:a}};u.getTileExtent=function(a,b,d,c,e,g){const [f,h]=g;d=c.x+d*f*a.x;b=c.y-b*h*a.y;return new K({xmin:d,xmax:d+f*a.x,ymin:b-h*a.y,ymax:b,spatialReference:e})};u.getBlockWidthHeight=function(a){return{blockWidth:0<a?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:0<a?this.rasterInfo.storageInfo.pyramidBlockHeight:
this.rasterInfo.storageInfo.blockHeight}};u.isBlockOutside=function(a,b,d){a=this.rasterInfo.storageInfo.blockBoundary[a];return!a||a.maxRow<b||a.maxCol<d||a.minRow>b||a.minCol>d};u._fetchPixels=async function(a,b,d,c={}){var e=x.getWorldWrapCount(a);if(2<=e)return{extent:a,pixelBlock:null};var g=this._getSourceDataInfo(a,b,d,c);const {pyramidLevel:f,srcResolution:h,srcExtent:l,srcWidth:m,srcHeight:p,ul:n}=g;if(0===m||0===p)return{extent:a,srcExtent:l,pixelBlock:null};var {rasterInfo:r}=this,q=t.unwrap(r.transform),
k="gcs-shift"===q?.type,v=t.isSome(x.getWorldWidth(a.spatialReference));if(k||!v)e=x.getWorldWrapCount(g.srcExtent,k);g=await this._fetchRawTiles(f,n,{width:m,height:p,wrapCount:e},c);if(!g)return{extent:a,srcExtent:l,pixelBlock:null};var w=r.storageInfo;k=0<f?w.pyramidBlockWidth:w.blockWidth;var y=0<f?w.pyramidBlockHeight:w.blockHeight;let {x:z,y:F}=r.pixelSize;if(0<f){const {pyramidResolutions:I,pyramidScalingFactor:G}=w;t.isSome(I)&&I[f-1]?{x:z,y:F}=I[f-1]:(w=G**f,z*=w,F*=w)}r=new H({x:z,y:F,spatialReference:r.spatialReference});
const E=k===m&&y===p&&0===n.x%k&&0===n.y%y;w=new H({x:(a.xmax-a.xmin)/b,y:(a.ymax-a.ymin)/d,spatialReference:a.spatialReference});const Q=!a.spatialReference.equals(this.rasterInfo.spatialReference),{datumTransformation:M}=c;if(!Q&&E&&1===g.pixelBlocks.length&&k===b&&y===d&&h.x===w.x&&h.y===w.y)return{extent:a,srcExtent:l,srcTilePixelSize:r,pixelBlock:g.pixelBlocks[0]};k=v&&t.isSome(x.getWorldWidth(l.spatialReference))&&this._hasNoneOrGCSShiftTransform;(v=c.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector"))&&
!this.rasterJobHandler&&await x.load();e=this.rasterJobHandler?await this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:a,srcBufferExtent:g.extent,pixelSize:w.toJSON(),datumTransformation:M,rasterTransform:q,hasWrapAround:0<e||k,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:v},c):x.getProjectionOffsetGrid({projectedExtent:a,srcBufferExtent:g.extent,pixelSize:w,datumTransformation:M,rasterTransform:q,hasWrapAround:0<e||k,isAdaptive:!1,includeGCSGrid:v});q=!c.requestRawData;
k={rows:e.spacing[0],cols:e.spacing[1]};y=this._hasNoneOrGCSShiftTransform?t.unwrap(this._getRasterTileAlignmentInfo(f,g.extent.xmin)):void 0;const {pixelBlocks:N,mosaicSize:R,isPartiallyFilled:S}=g;g=null;this.rasterJobHandler?(b=await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:N,srcMosaicSize:R,destDimension:q?{width:b,height:d}:null,coefs:q?e.coefficients:null,sampleSpacing:q?k:null,projectDirections:v,gcsGrid:v?e.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:c.interpolation,
alignmentInfo:y,blockWidths:null},c),{pixelBlock:q,localNorthDirections:g}=b):(y=J.mosaic(N,R,{alignmentInfo:y}),q=q?J.approximateTransform(y,{width:b,height:d},e.coefficients,k,c.interpolation):y,v&&e.gcsGrid&&(g=J.getLocalArithmeticNorthRotations({width:b,height:d},e.gcsGrid),q=X.convertToLocalDirections(q,this.rasterInfo.dataType,g)));return c.requestRawData||v?{extent:a,srcExtent:l,srcTilePixelSize:r,pixelBlock:q,transformGrid:e,localNorthDirections:g,isPartiallyFilled:S}:{extent:a,srcExtent:l,
srcTilePixelSize:r,pixelBlock:q}};u._fetchRawTiles=async function(a,b,d,c){const {origin:e,blockBoundary:g}=this.rasterInfo.storageInfo,{blockWidth:f,blockHeight:h}=this.getBlockWidthHeight(a);let {x:l,y:m}=b,{width:p,height:n,wrapCount:r}=d;var q=this._getRasterTileAlignmentInfo(a,0);c.buffer&&(l-=c.buffer.cols,m-=c.buffer.rows,p+=2*c.buffer.cols,n+=2*c.buffer.rows);var k=0,v=0;let w=0;r&&t.isSome(q)&&({worldColumnCountFromOrigin:v,originColumnOffset:w,rightPadding:k}=q,v*q.blockWidth-k>=l+p&&(k=
0));b=Math.floor(l/f);d=Math.floor(m/h);const y=Math.floor((l+p+k-1)/f);k=Math.floor((m+n+k-1)/h);var z=g[a];if(!z)return null;const {minRow:F,minCol:E,maxCol:Q,maxRow:M}=z;if(0===r&&(k<F||y<E||d>M||b>Q))return null;z=[];let N=!1;const R=null==this.ioConfig.allowPartialFill?c.allowPartialFill:this.ioConfig.allowPartialFill;for(let G=d;G<=k;G++)for(let O=b;O<=y;O++){let T=O;!c.disableWrapAround&&r&&t.isSome(q)&&v<=O&&(T=O-v-w);if(G>=F&&T>=E&&M>=G&&Q>=T){const Y=this._fetchRawTile(a,G,T,c);R?z.push(new Promise(Z=>
{Y.then(qa=>Z(qa)).catch(()=>{N=!0;Z(null)})})):z.push(Y)}else z.push(Promise.resolve(null))}if(0===z.length)return null;c=await Promise.all(z);q={height:(k-d+1)*h,width:(y-b+1)*f};({spatialReference:v}=this.rasterInfo);a=this.getPyramidPixelSize(a);const {x:S,y:I}=a;return{extent:new K({xmin:e.x+b*f*S,xmax:e.x+(y+1)*f*S,ymin:e.y-(k+1)*h*I,ymax:e.y-d*h*I,spatialReference:v}),pixelBlocks:c,mosaicSize:q,isPartiallyFilled:N}};u._fetchRawTile=function(a,b,d,c){var e=this.rasterInfo.storageInfo.blockBoundary[a];
if(!e)return Promise.resolve(null);const {minRow:g,minCol:f,maxCol:h,maxRow:l}=e;if(b<g||d<f||b>l||d>h)return Promise.resolve(null);const m=D.getRasterId(this.url,c.sliceId),p=`${a}/${b}/${d}`;e=D.getBlock(m,c.registryId,p);if(t.isNone(e)){const n=new AbortController;e=this.fetchRawTile(a,b,d,{...c,signal:n.signal});D.putBlock(m,c.registryId,p,e,n);e.catch(()=>D.deleteBlock(m,c.registryId,p))}if(c.signal)ea.onAbort(c,()=>{D.decreaseRefCount(m,c.registryId,p)});return e};u._computeMagDirValues=function(a){const {bandCount:b,
dataType:d}=this.rasterInfo;if((2!==b||"vector-magdir"!==d)&&"vector-uv"!==d||2!==a?.length||!a[0]?.length)return null;var c=a[0].length;if("vector-magdir"===d)return c=a[1].map(h=>(h+360)%360),[a[0],c];const [e,g]=a;a=[];const f=[];for(let h=0;h<c;h++){const [l,m]=X.uvComponentToVector([e[h],g[h]]);a.push(l);f.push(m)}return[a,f]};u._getRasterTileAlignmentInfo=function(a,b){null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=x.getRasterDatasetAlignmentInfo(this.rasterInfo));return t.isNone(this._rasterTileAlighmentInfo.pyramidsInfo)?
null:{startX:b,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,...this._rasterTileAlighmentInfo.pyramidsInfo[a]}};u._getSourceDataInfo=function(a,b,d,c={}){const e={datumTransformation:c.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};c.srcResolution&&(e.srcResolution=c.srcResolution,this._updateSourceDataInfo(a,e));var g=this.rasterInfo.storageInfo.maximumPyramidLevel||
0;const {srcWidth:f,srcHeight:h,pyramidLevel:l}=e;var m=f/b;const p=h/d,n=l<g&&16<=m*p;var r=l===g&&this._requireTooManySrcTiles(f,h,b,d);if(n||r||0===f||0===h){r=new H({x:(a.xmax-a.xmin)/b,y:(a.ymax-a.ymin)/d,spatialReference:a.spatialReference});r=x.projectResolution(r,this.rasterInfo.spatialReference,a,e.datumTransformation);const q=!r||c.srcResolution&&r.x+r.y<c.srcResolution.x+c.srcResolution.y;n&&c.srcResolution&&q&&(m=Math.round(Math.log(Math.max(m,p))/Math.LN2)-1,g-l+3>=m&&(g=2**m,r={x:c.srcResolution.x*
g,y:c.srcResolution.y*g}));r&&(e.srcResolution=r,this._updateSourceDataInfo(a,e))}this._requireTooManySrcTiles(e.srcWidth,e.srcHeight,b,d)&&(e.srcWidth=0,e.srcHeight=0);return e};u._requireTooManySrcTiles=function(a,b,d,c){const {tileInfo:e}=this.rasterInfo.storageInfo;return 256<=Math.ceil(a/e.size[0])*Math.ceil(b/e.size[1])||8<a/d||8<b/c};u._updateSourceDataInfo=function(a,b){b.srcWidth=0;b.srcHeight=0;var {rasterInfo:d}=this,c=d.spatialReference;const {srcResolution:e,datumTransformation:g}=b,
{pyramidLevel:f,pyramidResolution:h,excessiveReading:l}=x.snapPyramid(e,d,this.ioConfig.sampling);if(!l&&(a=b.srcExtent||x.projectExtent(a,c,g),null!=a)){(c=t.unwrap(d.transform))&&(a=c.inverseTransform(a));b.srcExtent=a;var {x:m,y:p}=d.storageInfo.origin;d=Math.floor((a.xmin-m)/h.x+.1);c=Math.floor((p-a.ymax)/h.y+.1);var n=Math.floor((a.xmax-m)/h.x-.1),r=Math.floor((p-a.ymin)/h.y-.1);n=a.width<.1*h.x?0:n-d+1;a=a.height<.1*h.y?0:r-c+1;b.pyramidLevel=f;b.pyramidResolution=h;b.srcWidth=n;b.srcHeight=
a;b.ul={x:d,y:c}}};u._getRequestOptionsWithSliceId=function(a){t.isSome(this.rasterInfo.multidimensionalInfo)&&null==a.sliceId&&(a={...a,sliceId:this.getSliceIndex(a.multidimensionalDefinition)});return a};u._processIdentifyResult=function(a,b){const {srcLocation:d,position:c,pyramidLevel:e,useTransposedTile:g}=b,f=a.pixels[0].length/a.width/a.height;if(a.mask&&!a.mask[c])return{location:d,value:null};const {multidimensionalInfo:h}=this.rasterInfo;if(t.isNone(h)||!g)return b=a.pixels.map(k=>k[c]),
a={location:d,value:b,pyramidLevel:e},b=this._computeMagDirValues(b.map(k=>[k])),b?.length&&(a.magdirValue=b.map(k=>k[0])),a;let l=a.pixels.map(k=>k.slice(c*f,c*f+f)),m=this._computeMagDirValues(l);const {requestSomeSlices:p,identifyOptions:n}=b;let r=P.createSlices(h,n.transposedVariableName);if(p){const k=P.getSliceIds(r,t.unwrap(n.multidimensionalDefinition),t.unwrap(n.timeExtent));l=l.map(v=>k.map(w=>v[w]));m=m?.map(v=>k.map(w=>v[w]));r=k.map(v=>r[v])}b=a.noDataValues||this.rasterInfo.noDataValue;
a={pixels:l,pixelType:a.pixelType};let q;t.isSome(b)&&(na.convertNoDataToMask(a,b),q=a.mask);a=r.map((k,v)=>{k={value:0===q?.[v]?null:l.map(w=>w[v]),multidimensionalDefinition:k.multidimensionalDefinition.map(w=>new ka({...w,isSlice:!0}))};m?.length&&(k.magdirValue=[m[0][v],m[1][v]]);return k});return{location:d,value:null,dataSeries:a,pyramidLevel:e}};U._createClass(L,[{key:"_isGlobalWrappableSource",get:function(){const {rasterInfo:a}=this,b=x.getWorldWidth(a.spatialReference);return t.isSome(b)&&
a.extent.width>=b/2}},{key:"_hasNoneOrGCSShiftTransform",get:function(){const {transform:a}=this.rasterInfo;return t.isNone(a)||"gcs-shift"===a.type}},{key:"url",set:function(a){this._set("url",ia.sanitizeUrl(a,ca.getLogger(this.declaredClass)))}}]);return L}(da.EsriPromiseMixin(ba.JSONSupport));B.__decorate([C.property()],A.prototype,"_rasterTileAlighmentInfo",void 0);B.__decorate([C.property({readOnly:!0})],A.prototype,"_isGlobalWrappableSource",null);B.__decorate([C.property({readOnly:!0})],A.prototype,
"_hasNoneOrGCSShiftTransform",null);B.__decorate([C.property(ja.url)],A.prototype,"url",null);B.__decorate([C.property({type:String,json:{write:!0}})],A.prototype,"datasetName",void 0);B.__decorate([C.property({type:String,json:{write:!0}})],A.prototype,"datasetFormat",void 0);B.__decorate([C.property()],A.prototype,"hasUniqueSourceStorageInfo",void 0);B.__decorate([C.property()],A.prototype,"rasterInfo",void 0);B.__decorate([C.property()],A.prototype,"ioConfig",void 0);B.__decorate([C.property()],
A.prototype,"sourceJSON",void 0);return A=B.__decorate([ha.subclass("esri.layers.support.rasterDatasets.BaseRaster")],A)});