// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./BaseRaster ../rasterFunctions/pixelUtils".split(" "),function(w,r,y,t,u,n,D,E,z,A,B){n=function(q){function v(){var e=C.apply(this,arguments);e.datasetFormat="Function";e.tileType="Raster";e.rasterFunction=
null;return e}w._inherits(v,q);var C=w._createSuper(v);q=v.prototype;q.open=async function(e){await this.init();const {rasterFunction:k}=this;this.primaryRasters?.rasters?.length?k.sourceRasters=this.primaryRasters.rasters:this.primaryRasters=k.getPrimaryRasters();const {rasters:h,rasterIds:b}=this.primaryRasters;var f=h.map(a=>a.rasterInfo?void 0:a.open(e));await Promise.all(f);f=h.map(({rasterInfo:a})=>a);const p=k.bind({rasterInfos:f,rasterIds:b});if(!p.success||0===f.length)throw new y("raster-function:open",
`cannot bind the function: ${p.error??""}`);await this.syncJobHandler();const c=f[0];this.hasUniqueSourceStorageInfo=1===f.length||f.slice(1).every(a=>this._hasSameStorageInfo(a,c));this.set("sourceJSON",h[0].sourceJSON);this.set("rasterInfo",k.rasterInfo)};q.syncJobHandler=async function(){return this.rasterJobHandler?.updateRasterFunction(this.rasterFunction)};q.fetchPixels=async function(e,k,h,b={}){const {rasters:f,rasterIds:p}=this.primaryRasters;var c=!1,{interpolation:a}=b,d=this.rasterFunction.flatWebGLFunctionChain?.hasSurfaceFunction;
!b.requestRawData&&"bilinear"!==a&&d&&(c=1===f.length&&!b.skipRasterFunction,b={...b,interpolation:"bilinear",requestRawData:c});d=f.map(l=>l.fetchPixels(e,k,h,b));d=await Promise.all(d);var g=d.map(l=>l.pixelBlock),m=c||b.requestRawData?d.map(l=>l.srcTilePixelSize):null;if(b.skipRasterFunction||g.every(l=>t.isNone(l)))return d[0];const x=d.find(l=>t.isSome(l.pixelBlock))?.extent??e;g=this.rasterJobHandler?await this.rasterJobHandler.process({extent:x,primaryPixelBlocks:g,primaryPixelSizes:m,primaryRasterIds:p}):
this.rasterFunction.process({extent:x,primaryPixelBlocks:g,primaryPixelSizes:m,primaryRasterIds:p});({transformGrid:m}=d[0]);if(!c||t.isNone(g)||t.isNone(m))return{...d[0],pixelBlock:g};c={rows:m.spacing[0],cols:m.spacing[1]};a=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[g],srcMosaicSize:{width:g.width,height:g.height},destDimension:{width:k,height:h},coefs:m.coefficients,sampleSpacing:c,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:a,alignmentInfo:void 0,
blockWidths:null},b)).pixelBlock:B.approximateTransform(g,{width:k,height:h},m.coefficients,c,a);return{extent:e,srcExtent:d[0].srcExtent,pixelBlock:a}};q._hasSameStorageInfo=function(e,k){const {storageInfo:h,pixelSize:b,spatialReference:f,extent:p}=e,{storageInfo:c,pixelSize:a,spatialReference:d,extent:g}=k;return b.x===a.x&&b.y===a.y&&f.equals(d)&&p.equals(g)&&h.blockHeight===c.blockHeight&&h.blockWidth===c.blockWidth&&h.maximumPyramidLevel===c.maximumPyramidLevel};return w._createClass(v)}(A);
r.__decorate([u.property({type:String,json:{write:!0}})],n.prototype,"datasetFormat",void 0);r.__decorate([u.property()],n.prototype,"tileType",void 0);r.__decorate([u.property()],n.prototype,"rasterFunction",void 0);r.__decorate([u.property()],n.prototype,"primaryRasters",void 0);return n=r.__decorate([z.subclass("esri.layers.support.rasterDatasets.FunctionRaster")],n)});