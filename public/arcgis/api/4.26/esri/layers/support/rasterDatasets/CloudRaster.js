// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../LOD ../RasterInfo ../RasterStorageInfo ../TileInfo ./BaseRaster ./DBFParser ../rasterTransforms/utils ../../../rest/support/FeatureSet ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(A,B,t,C,D,J,aa,ba,ca,N,O,P,Q,R,S,T,K,U,V,W,L){const p=new Map;p.set("int16","esriFieldTypeSmallInteger");p.set("int32","esriFieldTypeInteger");p.set("int64","esriFieldTypeInteger");p.set("float32","esriFieldTypeSingle");p.set("float64","esriFieldTypeDouble");p.set("text","esriFieldTypeString");t=function(h){function w(){var a=X.apply(this,arguments);a.storageInfo=null;a.datasetFormat="CRF";return a}A._inherits(w,h);var X=A._createSuper(w);h=w.prototype;h.open=async function(a){await this.init();
({data:a}=await this.request(this.url+"/conf.json",{signal:a?.signal}));if(!this._validateHeader(a))throw new C("cloudraster:open","Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const {storageInfo:b,rasterInfo:c}=this._parseHeader(a);"thematic"===c.dataType&&(a=await this._fetchAuxiliaryInformation(),c.attributeTable=a);this._set("storageInfo",b);this._set("rasterInfo",c);this.ioConfig.retryCount=this.ioConfig.retryCount||0};h.fetchRawTile=async function(a,
b,c,e={}){var {transposeInfo:g}=this.rasterInfo.storageInfo,{transposedVariableName:d}=e;a=(g=!(!g||!d))?0:this.rasterInfo.storageInfo.maximumPyramidLevel-a;if(0>a)return null;d=this._buildCacheFilePath(a,b,c,e.multidimensionalDefinition,d);b=this._getIndexRecordFromBundle(b,c,g);c=await this.request(d,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:e.signal});if(!c)return null;c=new Uint8Array(c.data);b=this._getTileEndAndContentType(c,b);if(0===b.recordSize)return null;
e=await this.request(d,{range:{from:b.position,to:b.position+b.recordSize},responseType:"array-buffer",signal:e.signal});if(!e)return null;const [l,u]=this._getTileSize(g);return this.decodePixelBlock(e.data,{width:l,height:u,planes:null,pixelType:null,returnInterleaved:g})};h._validateHeader=function(a){const b="origin extent geodataXform LODInfos blockWidth blockHeight bandCount pixelType pixelSizeX pixelSizeY format packetSize".split(" ");return a&&"RasterInfo"===a.type&&!b.some(c=>!a[c])};h._parseHeader=
function(a){var b="u1 u2 u4 u8 s8 u16 s16 u32 s32 f32 f64".split(" ")[a.pixelType];const {bandCount:c,histograms:e,colormap:g,blockWidth:d,blockHeight:l,firstPyramidLevel:u,maximumPyramidLevel:E}=a,Y=a.statistics&&a.statistics.map(r=>({min:r.min,max:r.max,avg:r.mean,stddev:r.standardDeviation,median:r.median,mode:r.mode}));var n=a.extent.spatialReference,k=a.geodataXform?.spatialReference;n=new V(n?.wkid||n?.wkt?n:k);k=new W({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,
spatialReference:n});const v=new L({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:n}),x=Math.round((k.xmax-k.xmin)/v.x),y=Math.round((k.ymax-k.ymin)/v.y),z=this._parseTransform(a.geodataXform),Z=z?k:null;z&&(k=z.forwardTransform(k),v.x=(k.xmax-k.xmin)/x,v.y=(k.ymax-k.ymin)/y);const F=a.properties??{};var G=a.format.toLowerCase().replace("cache/","");const M=new L(a.origin.x,a.origin.y,n);let H;var f;if(g&&g.colors)for(H=[],f=0;f<g.colors.length;f++){var m=g.colors[f];var q=g.values?g.values[f]:f;
H.push([q,m&255,m<<16>>>24,m<<8>>>24,m>>>24])}m=a.LODInfos;q=[];for(f=0;f<m.levels.length;f++)q.push(new O({level:m.levels[f],resolution:m.resolutions[f],scale:96/.0254*m.resolutions[f]}));m=new R({dpi:96,lods:q,format:G,origin:M,size:[d,l],spatialReference:n});G={recordSize:8,packetSize:a.packetSize,headerSize:a.packetSize*a.packetSize*8+64};q=[{maxCol:Math.ceil(x/d)-1,maxRow:Math.ceil(y/l)-1,minCol:0,minRow:0}];let I=2;if(0<E)for(f=0;f<E;f++)q.push({maxCol:Math.ceil(x/I/d)-1,maxRow:Math.ceil(y/
I/l)-1,minCol:0,minRow:0}),I*=2;a=a.mdInfo;f=null;a&&F._yxs&&(f=F._yxs,f={packetSize:f.PacketSize,tileSize:[f.TileXSize,f.TileYSize]});b=new P({width:x,height:y,pixelType:b,bandCount:c,extent:k,nativeExtent:Z,transform:z,spatialReference:n,pixelSize:v,keyProperties:F,statistics:Y,histograms:e,multidimensionalInfo:a,colormap:H,storageInfo:new Q({blockWidth:d,blockHeight:l,pyramidBlockWidth:d,pyramidBlockHeight:l,origin:M,tileInfo:m,transposeInfo:f,firstPyramidLevel:u,maximumPyramidLevel:E,blockBoundary:q})});
return{storageInfo:G,rasterInfo:b}};h._parseTransform=function(a){if(!K.isTransformSupported(a))throw new C("cloudraster:open","the data contains unsupported geodata transform types");a=K.readTransform(a);if("identity"===a.type)return null;if("polynomial"!==a.type||!a.forwardCoefficients?.length||!a.inverseCoefficients?.length)throw new C("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return a};h._fetchAuxiliaryInformation=
async function(a){var b=this.request(this.url+"/conf.vat.json",{signal:a}).then(e=>e.data).catch(()=>null);a=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:a}).then(e=>e.data).catch(()=>null);b=await Promise.all([b,a]);let c;if(b[0]){a=b[0].fields;const e=b[0].values;if(a&&e){a=a.map(d=>({type:"OID"===d.name?"esriFieldTypeOID":p.get(d.type),name:d.name,alias:d.alias||d.name}));const g=e.map(d=>({attributes:d}));a&&e&&(c={fields:a,features:g})}}!c&&b[1]&&(c=T.parse(b[1]).recordSet);
return U.fromJSON(c)};h._buildCacheFilePath=function(a,b,c,e,g){var d=this._getPackageSize(!!g);c=Math.floor(c/d)*d;b="R"+this._toHexString4(Math.floor(b/d)*d)+"C"+this._toHexString4(c);d="L";d=10<=a?d+a.toString():d+("0"+a.toString());({multidimensionalInfo:a}=this.rasterInfo);const l=e?.[0];if(D.isNone(a)||!l)return`${this.url}/_alllayers/${d}/${b}.bundle`;e="_yxs";if(!g){e=a.variables.find(u=>u.name===l.variableName).dimensions[0].values.indexOf(l.values[0]).toString(16);a=4-e.length;for(c=0;c<
a;c++)e="0"+e;e="S"+e}g=this._getVariableFolderName(g||l.variableName);return`${this.url}/_alllayers/${g}/${e}/${d}/${b}.bundle`};h._getPackageSize=function(a=!1){const {transposeInfo:b}=this.rasterInfo.storageInfo;return a&&D.isSome(b)?b.packetSize??0:this.storageInfo.packetSize};h._getTileSize=function(a=!1){const {storageInfo:b}=this.rasterInfo,{transposeInfo:c}=b;return a&&D.isSome(c)?c.tileSize:b.tileInfo.size};h._getVariableFolderName=function(a){a=a.trim();return""===a?"_v":a.replace(/[\{|\}\-]/g,
"_").replace("\\*","_v")};h._getIndexRecordFromBundle=function(a,b,c=!1){c=this._getPackageSize(c);a=a%c*c+b%c;if(0>a)throw Error("Invalid level / row / col");return a*this.storageInfo.recordSize+64};h._getTileEndAndContentType=function(a,b){a=a.subarray(b,b+8);b=0;let c;for(c=0;5>c;c++)b|=(a[c]&255)<<8*c;const e=b&0xffffffffff;b=0;for(c=5;8>c;c++)b|=(a[c]&255)<<8*(c-5);return{position:e,recordSize:b&0xffffffffff}};h._toHexString4=function(a){a=a.toString(16);if(4!==a.length){let b=4-a.length;for(;0<
b--;)a="0"+a}return a};return A._createClass(w)}(S);B.__decorate([J.property({readOnly:!0})],t.prototype,"storageInfo",void 0);B.__decorate([J.property({type:String,json:{write:!0}})],t.prototype,"datasetFormat",void 0);return t=B.__decorate([N.subclass("esri.layers.support.rasterDatasets.CloudRaster")],t)});