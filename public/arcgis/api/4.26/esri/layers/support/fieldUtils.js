// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../core/Error ../../core/maybe ../../core/object ./domainUtils ../../support/arcadeOnDemand".split(" "),function(O,d,P,g,A,n,Q){function B(a,b,c){if(a)for(const e of a)(a=(a=A.getDeepValue(e,b))&&"function"!==typeof a&&c.get(a))&&A.setDeepValue(e,a.name,b)}function k(a,b){if(!a||!b)return[];u.clear();l(u,a,b);return Array.from(u).sort()}function l(a,b,c){if(c)if(b?.fields?.length)if(c.includes("*"))for(const {name:e}of b.fields)a.add(e);else for(const e of c)m(a,b,e);else if(c.includes("*"))a.clear(),
a.add("*");else for(const e of c)null!=e&&a.add(e)}function m(a,b,c){"string"===typeof c&&(b?(b=b.get(c))&&a.add(b.name):a.add(c))}async function h(a,b,c){if(c){var {arcadeUtils:e}=await Q.loadArcade();c=e.extractFieldNames(c,b?.fields?.map(f=>f.name));for(const f of c)m(a,b,f)}}async function C(a,b,c){if(c&&"1\x3d1"!==c){const e=(await new Promise((f,R)=>O(["../../core/sql/WhereClause"],f,R))).WhereClause.create(c,b);if(!e.isStandardized)throw new P("fieldUtils:collectFilterFields","Where clause is not standardized",
{where:c});l(a,b,e.fieldNames)}}function v(a,b){for(const c of a)if(c&&c.valueType&&c.valueType===b)return c.name;return null}async function D(a,b){if(b){var c=b.elevationInfo?.featureExpressionInfo;if(c)return c.collectRequiredFields(a,b.fieldsIndex)}}async function E(a,b,c){const e=[];c?.expressionInfos&&e.push(...c.expressionInfos.map(f=>h(a,b.fieldsIndex,f.expression)));c=c?.content;if(Array.isArray(c))for(const f of c)"expression"===f.type&&f.expressionInfo&&e.push(h(a,b.fieldsIndex,f.expressionInfo.expression));
await Promise.all(e)}async function S(a,b,c){b&&c&&(c.valueExpression?await h(a,b.fieldsIndex,c.valueExpression):c.field&&m(a,b.fieldsIndex,c.field))}async function F(a,b){const {labelingInfo:c,fieldsIndex:e}=b;c&&c.length&&await Promise.all(c.map(f=>T(a,e,f)))}async function T(a,b,c){if(c){var e=c.getLabelExpression();c=c.where;"arcade"===e.type?await h(a,b,e.expression):(e=e.expression.match(/{[^}]*}/g))&&e.forEach(f=>{m(a,b,f.slice(1,-1))});await C(a,b,c)}}function w(a){return"number"===typeof a&&
!isNaN(a)&&isFinite(a)}function U(a){return null===a||w(a)}function V(a){return null===a||p(a)}function G(a){return null!=a&&"string"===typeof a}function W(a){return null===a||G(a)}function X(){return!0}function x(a,b){let c;switch(a.type){case "date":case "integer":case "long":case "small-integer":case "esriFieldTypeDate":case "esriFieldTypeInteger":case "esriFieldTypeLong":case "esriFieldTypeSmallInteger":c=a.nullable?V:p;break;case "double":case "single":case "esriFieldTypeSingle":case "esriFieldTypeDouble":c=
a.nullable?U:w;break;case "string":case "esriFieldTypeString":c=a.nullable?W:G;break;default:c=X}return 1===arguments.length?c:c(b)}function y(a){return null!=a&&Y.has(a.type)}function H(a,b){return null==a||a.nullable&&null===b?null:y(a)&&!I(a.type,Number(b))?d.NumericRangeValidationError.OUT_OF_RANGE:x(a,b)?a.domain?n.validateDomainValue(a.domain,b):null:d.TypeValidationError.INVALID_TYPE}function I(a,b){a="string"===typeof a?z(a):a;if(!a)return!1;const c=a.min,e=a.max;return a.isInteger?p(b)&&
b>=c&&b<=e:b>=c&&b<=e}function z(a){switch(a){case "esriFieldTypeSmallInteger":case "small-integer":return q;case "esriFieldTypeInteger":case "integer":return r;case "esriFieldTypeSingle":case "single":return t;case "esriFieldTypeDouble":case "double":return J}}function K(a,b,c){if(!b||!b.attributes||!a){if(g.isSome(c))for(var e of a??[])c.add(e);return!0}b=b.attributes;e=!1;for(const f of a)if(!(f in b))if(e=!0,g.isSome(c))c.add(f);else break;return e}const Z=/^([0-9])/,aa=/[^a-z0-9_\u0080-\uffff]/gi,
ba=/_{2,}/g,ca=/^_/,da=/_$/,L="field field2 field3 normalizationField rotationInfo.field proportionalSymbolInfo.field proportionalSymbolInfo.normalizationField colorInfo.field colorInfo.normalizationField".split(" "),M=["field","normalizationField"],u=new Set,p=(()=>"isInteger"in Number?Number.isInteger:a=>"number"===typeof a&&isFinite(a)&&Math.floor(a)===a)(),N=["integer","small-integer","single","double"],Y=new Set([...N,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);
d.NumericRangeValidationError=void 0;(d.NumericRangeValidationError||(d.NumericRangeValidationError={})).OUT_OF_RANGE="numeric-range-validation-error::out-of-range";d.TypeValidationError=void 0;(d.TypeValidationError||(d.TypeValidationError={})).INVALID_TYPE="type-validation-error::invalid-type";const q={min:-32768,max:32767,isInteger:!0},r={min:-2147483648,max:2147483647,isInteger:!0},t={min:-3.4E38,max:1.2E38,isInteger:!1},J={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};d.collectArcadeFieldNames=
h;d.collectElevationFields=D;d.collectFeatureReductionFields=async function(a,b,c){if(b&&c&&"fields"in c){var e=[];e.push(E(a,b,c.popupTemplate));c.fields&&e.push(...c.fields.map(async f=>{f.onStatisticExpression?h(a,b.fieldsIndex,f.onStatisticExpression.expression):a.add(f.onStatisticField)}));await Promise.all(e)}};d.collectField=m;d.collectFields=l;d.collectFilterFields=async function(a,b,c){b&&(b.timeInfo&&g.isSome(c)&&c.timeExtent&&l(a,b.fieldsIndex,[b.timeInfo.startField,b.timeInfo.endField]),
b.floorInfo&&l(a,b.fieldsIndex,[b.floorInfo.floorField]),g.isSome(c)&&g.isSome(c.where)&&await C(a,b.fieldsIndex,c.where))};d.collectLabelingFields=F;d.collectOrderByInfos=async function(a,b,c){b&&c&&await Promise.all(c.map(e=>S(a,b,e)))};d.collectPopupTemplateFields=E;d.doubleRange=J;d.featureHasFields=function(a,b){return!K(a,b,null)};d.fixFields=k;d.fixRendererFields=function(a,b){if(null!=a&&null!=b)for(const c of Array.isArray(a)?a:[a])if(B(L,c,b),"visualVariables"in c&&c.visualVariables)for(const e of c.visualVariables)B(M,
e,b)};d.fixTimeInfoFields=function(a,b){if(null!=a&&b?.fields?.length)if("startField"in a){var c=b.get(a.startField);b=b.get(a.endField);a.startField=c?.name??null;a.endField=b?.name??null}else c=b.get(a.startTimeField),b=b.get(a.endTimeField),a.startTimeField=c?.name??null,a.endTimeField=b?.name??null};d.getDisplayFieldName=function({displayField:a,fields:b}){if(a)return a;if(!b||!b.length)return null;if(!(a=v(b,"name-or-title")||v(b,"unique-identifier")||v(b,"type-or-category")))a:{for(const c of b)if(c&&
c.name&&(b=c.name.toLowerCase(),b.includes("name")||b.includes("title"))){a=c.name;break a}a=null}return a};d.getElevationFields=async function(a){if(!a)return[];const b=new Set;await D(b,a);return Array.from(b).sort()};d.getExpressionFields=async function(a,b){const c=new Set;for(const e of b)await h(c,a.fieldsIndex,e);return Array.from(c).sort()};d.getFeatureEditFields=function(a){if(!a)return[];const b="editFieldsInfo"in a&&a.editFieldsInfo;return b?k(a.fieldsIndex,[b&&b.creatorField,b&&b.creationDateField,
b&&b.editorField,b&&b.editDateField]):[]};d.getFeatureGeometryFields=function(a){if(!a)return[];const b=a.geometryFieldsInfo;return b?k(a.fieldsIndex,[b.shapeAreaField,b.shapeLengthField]):[]};d.getFieldDefaultValue=function(a){const b=a.defaultValue;if(void 0!==b&&x(a,b))return b;if(a.nullable)return null};d.getFieldRange=function(a){const b=n.getDomainRange(a.domain);if(b)return b;if(y(a))return z(a.type)};d.getLabelingFields=async function(a){if(!a)return[];const b=new Set;await F(b,a);return Array.from(b).sort()};
d.getNumericTypeForValue=function(a){if(!w(a))return null;if(p(a)){if(a>=q.min&&a<=q.max)return"esriFieldTypeSmallInteger";if(a>=r.min&&a<=r.max)return"esriFieldTypeInteger"}return a>=t.min&&a<=t.max?"esriFieldTypeSingle":"esriFieldTypeDouble"};d.getTimeFields=async function(a){if(!a)return[];const b="timeInfo"in a&&a.timeInfo;return b?k(a.fieldsIndex,[a.trackIdField,b.startField,b.endField]):[]};d.integerRange=r;d.isDateField=function(a){return null!=a&&("date"===a.type||"esriFieldTypeDate"===a.type)};
d.isNumberInRange=I;d.isNumericField=y;d.isRasterPixelValueField=function(a){return a?["raster.itempixelvalue","raster.servicepixelvalue"].some(b=>a.toLowerCase().startsWith(b)):!1};d.isStringField=function(a){return null!=a&&("string"===a.type||"esriFieldTypeString"===a.type)};d.isValidFieldValue=function(a,b){return null===H(a,b)};d.isValueMatchingFieldType=x;d.normalizeFieldName=function(a){return null==a?null:a.trim().replace(aa,"_").replace(ba,"_").replace(ca,"").replace(da,"").replace(Z,"F$1")||
null};d.numericTypes=N;d.packFields=function(a,b,c=1){if(!b||!a)return[];if(b.includes("*"))return["*"];b=k(a,b);return b.length/a.fields.length>=c?["*"]:b};d.populateMissingFields=K;d.rendererFields=L;d.sanitizeNullFieldValue=function(a){return null==a||"number"===typeof a&&isNaN(a)?null:a};d.singleRange=t;d.smallIntegerRange=q;d.unpackFieldNames=function(a,b){return g.isNone(b)||g.isNone(a)?[]:b.includes("*")?(a.fields??[]).map(c=>c.name):b};d.validateFieldValue=H;d.validationErrorToString=function(a,
b,c){switch(a){case n.DomainValidationError.INVALID_CODED_VALUE:return`Value ${c} is not in the coded domain - field: ${b.name}, domain: ${JSON.stringify(b.domain)}`;case n.DomainValidationError.VALUE_OUT_OF_RANGE:return`Value ${c} is out of the range of valid values - field: ${b.name}, domain: ${JSON.stringify(b.domain)}`;case d.TypeValidationError.INVALID_TYPE:return`Value ${c} is not a valid value for the field type - field: ${b.name}, type: ${b.type}, nullable: ${b.nullable}`;case d.NumericRangeValidationError.OUT_OF_RANGE:const {min:e,
max:f}=z(b.type);return`Value ${c} is out of range for the number type - field: ${b.name}, type: ${b.type}, value range is ${e} to ${f}`}};d.visualVariableFields=M;Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});