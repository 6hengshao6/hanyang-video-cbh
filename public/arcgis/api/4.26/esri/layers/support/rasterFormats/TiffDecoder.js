// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../rasterDatasets/byteStreamUtils ../../../chunks/Jpg ./Lerc ./Lzw ./pixelRangeUtils ./TiffTags ./utils ../../../chunks/Zlib".split(" "),function(F,ha,ia,V,W,X,H,Y,ja){function M(b,a){let d="unknown";3===b?d=64===a?"f64":"f32":1===b?1===a?d="u1":2===a?d="u2":4===a?d="u4":8>=a?d="u8":16>=a?d="u16":32>=a&&(d="u32"):2===b&&(8>=a?d="s8":16>=a?d="s16":32>=a&&(d="s32"));return d}function I(b){let a=null;switch(b?b.toLowerCase():"f32"){case "u1":case "u2":case "u4":case "u8":a=Uint8Array;
break;case "u16":a=Uint16Array;break;case "u32":a=Uint32Array;break;case "s8":a=Int8Array;break;case "s16":a=Int16Array;break;case "s32":a=Int32Array;break;case "f64":a=Float64Array;break;default:a=Float32Array}return a}function ka(b,a){return{x:a[0]*b.x+a[1]*b.y+a[2],y:a[3]*b.x+a[4]*b.y+a[5]}}function u(b,a){return b.get(a)?.values?.[0]}function N(b,a,d,f=0,h=H.TIFF_TAGS,g=4){var c=8===g;const e=c?O(new DataView(b,d,8),0,a):(new DataView(b,d,2)).getUint16(0,a),k=4+2*g;var p=c?8:2;c=p+e*k;if(d+c>
b.byteLength)return{success:!1,ifd:null,nextIFD:null,requiredBufferSize:c};const r=d+c+4<=b.byteLength?J(new DataView(b,d+c,8===g?8:4),0,a,8===g):null;d+=p;p=new Map;let l,x,m,w=0,y=0;for(let q=0;q<e;q++){var t=new DataView(b,d+k*q,k);l=t.getUint16(0,a);m=t.getUint16(2,a);x=H.getTagName(l,h);const n=[];2===g?(w=t.getUint16(4,a),y=t.getUint16(6,a)):4===g?(w=t.getUint32(4,a),y=t.getUint32(8,a)):8===g&&(w=J(t,4,a,!0),y=J(t,12,a,!0),n.push(t.getUint32(12,a)),n.push(t.getUint32(16,a)));t={id:l,type:m,
valueCount:w,valueOffset:y,valueOffsets:n,values:null};Z(b,a,t,f,!1,g);p.set(x,t)}return{success:!0,ifd:p,nextIFD:r,requiredBufferSize:c}}function aa(b,a){if(1!==a&&2!==a&&4!==a)return b;const d=new Uint8Array(b),f=8/a;b=new Uint8Array(b.byteLength*f);let h=0;const g=2**a-1;for(let c=0;c<d.length;c++){const e=d[c];for(let k=0;k<f;k++)b[h++]=e<<a*k>>>8-a&g}return b.buffer}function P(b,a,d){const f=new ia.JpegImage;f.parse(b);f.colorTransform=6===d?-1:0;b=f.getData(f.width,f.height,1!==a);return new Uint8Array(b.buffer)}
function Q(b){b=(new ja.Zlib(b)).getBytes();var a=new ArrayBuffer(b.length);a=new Uint8Array(a);a.set(b);return a}async function R(b,a,d,f,h){var g=Y.isPlatformLittleEndian===a,c=u(d,"BITSPERSAMPLE"),e=u(d,"SAMPLESPERPIXEL");const k=u(d,"PHOTOMETRICINTERPRETATION");var p=u(d,"SAMPLEFORMAT")??1;const r=M(p,c);var l=u(d,"COMPRESSION")??1;p=I(r);if(34887===l)return await V.load(),V.decode(b,{inputOffset:f}).pixels[0];if(1===l)e=b.slice(f,f+h),a=new Uint8Array(e);else if(8===l||32946===l)a=new Uint8Array(b,
f,h),a=Q(a),e=a.buffer;else if(6===l)a=new Uint8Array(b,f,h),a=P(a,e,k),e=a.buffer;else if(7===l){l=d.get("JPEGTABLES").values;d=l.length-2;a=new Uint8Array(d+h-2);for(let x=0;x<d;x++)a[x]=l[x];b=new Uint8Array(b,f+2,h-2);for(f=0;f<b.length;f++)a[d+f]=b[f];a=P(a,e,k);e=a.buffer}else if(5===l)a=W.decode(b,f,h,a),e=a.buffer;else throw Error("tiff-decode: unsupport compression "+l);e=aa(e,c);if("u8"!==r&&"s8"!==r&&!g)switch(e=new ArrayBuffer(a.length),g=new Uint8Array(e),r){case "u16":case "s16":for(c=
0;c<a.length;c+=2)g[c]=a[c+1],g[c+1]=a[c];break;case "u32":case "s32":case "f32":for(c=0;c<a.length;c+=4)g[c]=a[c+3],g[c+1]=a[c+2],g[c+2]=a[c+1],g[c+3]=a[c]}return new p(e)}async function la(b,a,d){const f=d.get("TILEOFFSETS")?.values;if(void 0===f)return null;const h=d.get("TILEBYTECOUNTS")?.values,{width:g,height:c,pixelType:e,tileWidth:k,tileHeight:p}=K([d]);var r=L(d,a);const l=u(d,"SAMPLESPERPIXEL")||a.planes;var x=g*c,m=u(d,"BITSPERSAMPLE"),w=34887===(u(d,"COMPRESSION")??1),y=I(e);const t=[];
for(var q=0;q<l;q++)t.push(new y(x));let n,D,v,A,B,E,C,G;x=Math.ceil(g/k);if(0===m%8)if(w&&r&&1<l)for(r=Math.round(f.length/l),m=0;m<r;m++){var z=Math.floor(m/x)*p;v=m%x*k;y=z*g+v;for(w=0;w<l;w++)if(q=m*l+w,0!==h[q])for(q=await R(b,a.littleEndian,d,f[q],h[q]),B=0,A=y,C=Math.min(k,g-v),E=Math.min(p,c-z),G=t[w],n=0;n<E;n++)for(A=y+n*g,B=n*k,D=0;D<C;D++,A++,B++)G[A]=q[B]}else for(m=0;m<f.length;m++)if(0!==h[m])for(z=Math.floor(m/x)*p,v=m%x*k,y=z*g+v,q=await R(b,a.littleEndian,d,f[m],h[m]),B=0,A=y,C=
Math.min(k,g-v),E=Math.min(p,c-z),z=0;z<l;z++)if(G=t[z],r||w)for(n=0;n<E;n++)for(A=y+n*g,B=k*p*z+n*k,D=0;D<C;D++,A++,B++)G[A]=q[B];else for(n=0;n<E;n++)for(A=y+n*g,B=n*k*l+z,D=0;D<C;D++,A++,B+=l)G[A]=q[B];return{width:g,height:c,pixelType:e,pixels:t}}function Z(b,a,d,f=0,h=!1,g=4){if(d.values)return!0;var c=d.type,e=d.valueCount,k=d.valueOffset;let p=[];var r=ba[c],l=8*r,x=e*r,m=e*ba[c]*8,w=8===g?64:32;g=d.valueOffsets;if(m>w&&x>(h?b.byteLength:b?b.byteLength-k+f:0))return d.offlineOffsetSize=[k,
x],d.values=null,!1;if(m<=w)if(a||(32>=w?k>>>=32-m:(b=g?.length?g[0]:k>>>0,a=g?.length?g[1]:Math.round((k-b)/4294967296),32>=m?(k=b>>>32-m,g[0]=k):(k=b*2**(32-m)+(a>>>32-m),g[0]=b,g[1]=a>>>32-m))),1===e&&l===w)p=[k];else if(64===w)for(b=g?.length?g[0]:k>>>0,k=g?.length?g[1]:Math.round((k-b)/4294967296),a=b,r=32,b=1;b<=e;b++)x=32-l*b%32,r<l?(x=a<<x>>>32-r,m=k<<32-r>>>32-r,a=k,p.push(x+m*2**(l-r)),r-=32-(l-r)):(p.push(a<<x>>>32-l),r-=l),0===r&&(r=32,a=k);else for(b=1;b<=e;b++)p.push(k<<32-l*b>>>32-
l);else for(k-=f,h&&(k=0),e=k;e<k+x;e+=r){switch(c){case 1:l=(new DataView(b,e,1)).getUint8(0);break;case 2:l=(new DataView(b,e,1)).getUint8(0);break;case 3:l=(new DataView(b,e,2)).getUint16(0,a);break;case 4:case 13:l=(new DataView(b,e,4)).getUint32(0,a);break;case 5:l=(new DataView(b,e,4)).getUint32(0,a)/(new DataView(b,e+4,4)).getUint32(0,a);break;case 6:l=(new DataView(b,e,1)).getInt8(0);break;case 7:l=(new DataView(b,e,1)).getUint8(0);break;case 8:l=(new DataView(b,e,2)).getInt16(0,a);break;
case 9:l=(new DataView(b,e,4)).getInt32(0,a);break;case 10:l=(new DataView(b,e,4)).getInt32(0,a)/(new DataView(b,e+4,4)).getInt32(0,a);break;case 11:l=(new DataView(b,e,4)).getFloat32(0,a);break;case 12:l=(new DataView(b,e,8)).getFloat64(0,a);break;case 16:case 18:l=O(new DataView(b,e,8),0,a);break;case 17:g=new DataView(b,e,8);m=(l=a)?g.getInt32(0,l):g.getUint32(0,l);g=l?g.getUint32(4,l):g.getInt32(4,l);w=0<=(l?m:g)?1:-1;l?m*=w:g*=w;l=w*(l?4294967296*g+m:4294967296*m+g);break;default:l=null}p.push(l)}if(2===
c){c="";k=p;p=[];for(b=0;b<k.length;b++)0===k[b]&&""!==c?(p.push(c),c=""):c+=String.fromCharCode(k[b]);""===c&&0!==p.length||p.push(c)}d.values=p;return!0}function K(b){var a=b[0];const d=u(a,"TILEWIDTH"),f=u(a,"TILELENGTH"),h=u(a,"IMAGEWIDTH"),g=u(a,"IMAGELENGTH");var c=u(a,"BITSPERSAMPLE");const e=u(a,"SAMPLESPERPIXEL");var k=u(a,"SAMPLEFORMAT")??1;const p=M(k,c),r=L(a);var l=a.get("GDAL_NODATA")?.values;let x=null;l?.length&&(x=l.map(z=>parseFloat(z)),x.some(z=>isNaN(z))&&(x=null));var m=u(a,"COMPRESSION")??
1;switch(m){case 1:l="NONE";break;case 2:case 3:case 4:case 32771:l="CCITT";break;case 5:l="LZW";break;case 6:case 7:l="JPEG";break;case 32773:l="PACKBITS";break;case 8:case 32946:l="DEFLATE";break;case 34712:l="JPEG2000";break;case 34887:l="LERC";break;default:l=String(m)}let w=!0,y="";ma.has(m)||(w=!1,y+="unsupported tag compression "+m);3<k&&(w=!1,y+="unsupported tag sampleFormat "+k);1!==c&&2!==c&&4!==c&&0!==c%8&&(w=!1,y+="unsupported tag bitsPerSample "+c);c=a.get("GEOASCIIPARAMS")?.values?.[0];
if(c){var t=(t=c.split("|").find(z=>z.includes("ESRI PE String \x3d ")))?t.replace("ESRI PE String \x3d ",""):"";t=t.startsWith("COMPD_CS")||t.startsWith("PROJCS")||t.startsWith("GEOGCS")?{wkid:null,wkt:t}:null}k=a.get("GEOTIEPOINTS")?.values;c=a.get("GEOPIXELSCALE")?.values;m=a.get("GEOTRANSMATRIX")?.values;var q=a.has("GEOKEYDIRECTORY")?a.get("GEOKEYDIRECTORY").data:null,n=!1;a=!1;if(q){n=2===u(q,"GTRasterTypeGeoKey");var D=u(q,"GTModelTypeGeoKey");2===D?(q=u(q,"GeographicTypeGeoKey"),1024<=q&&
32766>=q&&(t={wkid:q}),t||32767!==q||(a=!0,t={wkid:4326})):1===D&&(q=u(q,"ProjectedCSTypeGeoKey"),1024<=q&&32766>=q&&(t={wkid:q}))}let v;c&&k&&6<=k.length?(v=[c[0],0,k[3]-k[0]*c[0],0,-Math.abs(c[1]),k[4]-k[1]*c[1]],n&&(v[2]-=.5*v[0]+.5*v[1],v[5]-=.5*v[3]+.5*v[4])):m&&16===m.length&&(v=n?[m[0],m[1],m[3]-.5*m[0],m[4],m[5],m[7]-.5*m[5]]:[m[0],m[1],m[3],m[4],m[5],m[7]]);if(v){k=[{x:0,y:g},{x:0,y:0},{x:h,y:g},{x:h,y:0}];q=n=Number.POSITIVE_INFINITY;let z=D=Number.NEGATIVE_INFINITY;for(let S=0;S<k.length;S++)m=
ka(k[S],v),n=m.x>n?n:m.x,D=m.x<D?D:m.x,q=m.y>q?q:m.y,z=m.y<z?z:m.y;k={xmin:n,xmax:D,ymin:q,ymax:z,spatialReference:t}}else k={xmin:-.5,ymin:.5-g,xmax:h-.5,ymax:.5,spatialReference:t};a&&(400<k.xmax-k.xmin||361<Math.max(Math.abs(k.xmin),Math.abs(k.xmax)))&&(t=null,k.spatialReference=null);t=T(b);let A;let B,E;if(0<t.length){B=Math.round(Math.log(h/u(t[0],"IMAGEWIDTH"))/Math.LN2);var C=t[t.length-1];E=Math.round(Math.log(h/u(C,"IMAGEWIDTH"))/Math.LN2);A=u(C,"TILEWIDTH");C=u(C,"TILELENGTH")}A=null!=
E&&0<E?A||d:null;C=null!=E&&0<E?C||f:null;let G;d&&(G=[{maxCol:Math.ceil(h/d)-1,maxRow:Math.ceil(g/f)-1,minRow:0,minCol:0}],t.forEach(z=>{G.push({maxCol:Math.ceil(u(z,"IMAGEWIDTH")/u(z,"TILEWIDTH"))-1,maxRow:Math.ceil(u(z,"IMAGELENGTH")/u(z,"TILELENGTH"))-1,minRow:0,minCol:0})}));m=b[0].get("GDAL_METADATA")?.values?.[0];m=na(m);y+=" "+ca({width:h,height:g,tileWidth:d,tileHeight:f,planes:e,ifds:b});b=U(b).length===t.length+1;return{width:h,height:g,tileWidth:d,tileHeight:f,planes:e,isBSQ:r,pixelType:p,
compression:l,noData:x,hasMaskBand:b,isSupported:w,message:y,extent:k,isPseudoGeographic:a,affine:c?null:v,firstPyramidLevel:B,maximumPyramidLevel:E,pyramidBlockWidth:A,pyramidBlockHeight:C,tileBoundary:G,metadata:m}}function L(b,a){return(b=b.get("PLANARCONFIGURATION")?.values)?2===b[0]:a?a.isBSQ:!1}function T(b){return b.filter(a=>1===u(a,"NEWSUBFILETYPE"))}function U(b){return b.filter(a=>{const d=4===((u(a,"NEWSUBFILETYPE")??0)&4);a=4===u(a,"PHOTOMETRICINTERPRETATION");return d&&a})}function da(b){const {littleEndian:a,
isBigTiff:d,firstIFDPos:f}=ea(b);var h=f;const g=[];do if(h=fa(b,a,h,0,H.TIFF_TAGS,d?8:4),h.success)g.push(h.ifd),h=h.nextIFD;else break;while(0<h);b=K(g);h=T(g);const c=U(g);return{...b,littleEndian:a,isBigTiff:d,ifds:g,pyramidIFDs:h,maskIFDs:c}}function O(b,a,d){const f=b.getUint32(a,d);b=b.getUint32(a+4,d);return d?4294967296*b+f:4294967296*f+b}function J(b,a,d,f){return f?O(b,a,d):b.getUint32(a,d)}function ea(b){var a=new DataView(b,0,16),d=a.getUint16(0,!1);b=null;if(18761===d)b=!0;else if(19789===
d)b=!1;else throw Error("unexpected endianess byte");var f=a.getUint16(2,b);if(42!==f&&43!==f)throw Error("unexpected tiff identifier");d=4;if(f=43===f){const h=a.getUint16(d,b);d+=2;if(8!==h)throw Error("unsupported bigtiff version");if(0!==a.getUint16(d,b))throw Error("unsupported bigtiff version");d+=2}a=J(a,d,b,f);return{littleEndian:b,isBigTiff:f,firstIFDPos:a}}function fa(b,a,d,f=0,h=H.TIFF_TAGS,g=4){d=N(b,a,d,f,h,g);let c;const e=d.ifd;e&&(H.ifdTags.forEach((k,p)=>{e.has(p)&&(c=e.get(p),c.data=
N(b,a,c.valueOffset-f,f,k).ifd)}),e.has("GEOKEYDIRECTORY")&&(c=e.get("GEOKEYDIRECTORY"),(h=c.values)&&4<h.length&&(h=h[0]+"."+h[1]+"."+h[2],c.data=N(b,a,c.valueOffset+6-f,f,H.GEO_KEYS,2).ifd,c.data&&c.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[h]}))),e.has("XMP")&&(c=e.get("XMP"),h=c.values,"number"===typeof h[0]&&7===c.type&&(c.values=[ha.bytesToUTF8(new Uint8Array(h))])));return d}function ca(b){const {width:a,height:d,tileHeight:f,tileWidth:h}=b,g=b.planes,c=h?
h*f:a*d;b=u(b.ifds[0],"BITSPERSAMPLE");let e="";c*g>2**30/(8<b?b/8:1)&&(e=h?"tiled tiff exceeding 1 gigabits per tile is not supported":"scanline tiff exceeding 1 gigabits is not supported");return e}const ba=[0,1,1,2,4,8,1,1,2,4,8,4,8,-1,-1,-1,8,8,8],ma=new Set([1,5,6,7,8,34712,34887]),oa=(b,a,d)=>{if(!(b&&0<b.length&&a&&d))return null;let f,h,g;const c=b[0].length,e=b.length,k=new Uint8Array(c);for(let r=0;r<e;r++)if(f=b[r],h=a[r],g=d[r],0===r)for(var p=0;p<c;p++)k[p]=f[p]<h||f[p]>g?0:1;else for(p=
0;p<c;p++)k[p]&&(k[p]=f[p]<h||f[p]>g?0:1);return k},na=b=>{if(!b)return null;var a=b.match(/<Item(.*?)Item>/gi);if(!a||0===a.length)return null;b=new Map;var d;for(var f=0;f<a.length;f++){var h=a[f];var g=h.slice(6,h.indexOf("\x3e"));var c=h.indexOf("sample\x3d");-1<c&&(d=h.slice(c+8,h.indexOf('"',c+8)));c=h.indexOf("name\x3d");-1<c&&(g=h.slice(c+6,h.indexOf('"',c+6)));g&&(h=h.slice(h.indexOf("\x3e")+1,h.indexOf("\x3c/Item\x3e")).trim(),null!=d?b.has(g)?b.get(g)[d]=h:b.set(g,[h]):b.set(g,h));d=null}a=
b.get("STATISTICS_MINIMUM");g=b.get("STATISTICS_MAXIMUM");f=b.get("STATISTICS_MEAN");h=b.get("STATISTICS_STDDEV");d=null;if(a&&g)for(d=[],c=0;c<a.length;c++)d.push({min:parseFloat(a[c]),max:parseFloat(g[c]),avg:f&&parseFloat(f[c]),stddev:h&&parseFloat(h[c])});g=b.get("BandName");f=b.get("WavelengthMin");h=b.get("WavelengthMax");a=null;if(g)for(a=[],c=0;c<g.length;c++)a.push({BandName:g[c],WavelengthMin:f&&parseFloat(f[c]),WavelengthMax:h&&parseFloat(h[c])});g=b.get("DataType");return{statistics:d,
bandProperties:a,dataType:g,rawMetadata:b}};F.decode=async function(b,a={}){var d=a.pyramidLevel||0,f=a.headerInfo||da(b);const {ifds:h,noData:g}=f;if(0===h.length)throw Error("no valid image file directory");var c=ca(f);if(c)throw c;c=null;var e=-1===d?h[h.length-1]:h[d];a=g??a.noDataValue;if(f.tileWidth)c=await la(b,f,e);else{{const E=Y.isPlatformLittleEndian===f.littleEndian,C=e.get("STRIPOFFSETS")?.values;if(void 0===C)b=null;else{var {width:k,height:p,pixelType:r}=K([e]);d=u(e,"SAMPLESPERPIXEL")||
f.planes;var l=u(e,"PHOTOMETRICINTERPRETATION");c=k*p;var x=u(e,"BITSPERSAMPLE"),m=I(r),w=new m(c*d),y=e.get("STRIPBYTECOUNTS")?.values,t=u(e,"ROWSPERSTRIP"),q=u(e,"COMPRESSION")??1;var n=t;if(0===x%8)for(e=0;e<C.length;e++){var D=e*t*k*d;n=(e+1)*t>p?p-e*t:t;if("u8"===r||"s8"===r||E)if(8===q||32946===q){var v=new Uint8Array(b,C[e],y[e]);v=Q(v);var A=v.buffer}else 6===q?(v=new Uint8Array(b,C[e],y[e]),v=P(v,d,l),A=v.buffer):5===q?(v=W.decode(b,C[e],y[e],f.littleEndian),A=v.buffer):(y[e]!==n*k*d*x/8&&
console.log("strip byte counts is different than expected"),A=b.slice(C[e],C[e]+y[e]));else{if(6===q||8===q||32946===q){v=new Uint8Array(b,C[e],y[e]);var B=Q(v);A=B.buffer}else y[e]!==n*k*d*x/8&&console.log("strip byte counts is different than expected"),A=new ArrayBuffer(y[e]),v=new Uint8Array(b,C[e],y[e]),B=new Uint8Array(A);switch(r){case "u16":case "s16":for(n=0;n<v.length;n+=2)B[n]=v[n+1],B[n+1]=v[n];break;case "u32":case "s32":case "f32":for(n=0;n<v.length;n+=4)B[n]=v[n+3],B[n+1]=v[n+2],B[n+
2]=v[n+1],B[n+3]=v[n]}}A=aa(A,x);n=new m(A);w.set(n,D)}l=[];if(1===d)l.push(w);else for(e=0;e<d;e++){f=new m(c);for(b=0;b<c;b++)f[b]=w[b*d+e];l.push(f)}b={width:k,height:p,pixelType:r,pixels:l}}}c=await b}if(!c)return c;null!=a&&X.convertNoDataToMask(c,a);return c};F.decodeTileOrStrip=async function(b,a){const {headerInfo:d,ifd:f,offsets:h,sizes:g}=a;var c=[];for(var e=0;e<h.length;e++){var k=await R(b,d.littleEndian,f,h[e],g[e]||b.byteLength);c.push(k)}var p=L(f,d);b=u(f,"BITSPERSAMPLE");e=u(f,"SAMPLEFORMAT")??
1;e=M(e,b);var r=u(f,"SAMPLESPERPIXEL")||d.planes;const l=I(e);k=u(f,"TILEWIDTH");const x=u(f,"TILELENGTH");var m=u(f,"COMPRESSION")??1;const w=k*x;b=[];let y=c[0];const t=34887===m;for(let n=0;n<r;n++){m=new l(w);if(p&&t){if(y=c[n],y.length)for(var q=0;q<w;q++)m[q]=y[n][q+n]}else if(y.length)if(p||t&&!p)m=y.slice(w*n,w*(n+1));else for(q=0;q<w;q++)m[q]=y[q*r+n];b.push(m)}c=d.noData?d.noData[0]:a.noDataValue;p=(r=d.metadata?d.metadata.statistics:null)?r.map(n=>n.min):null;r=r?r.map(n=>n.max):null;
e={pixelType:e,width:k,height:x,pixels:b,noDataValue:c};null!=c?X.convertNoDataToMask(e,c):p&&r&&a.applyMinMaxConstraint&&(e.mask=oa(b,p,r));return e};F.getImageInfo=K;F.getMaskIFDs=U;F.getPyramidIFDs=T;F.isBSQConfig=L;F.parseFieldValues=Z;F.parseHeader=da;F.parseIFD=fa;F.parseSignature=ea;Object.defineProperty(F,Symbol.toStringTag,{value:"Module"})});