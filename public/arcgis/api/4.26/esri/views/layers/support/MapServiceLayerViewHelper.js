// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/Collection ../../../core/Error ../../../core/has ../../../core/MapUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/unitUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/scaleUtils ../../../layers/support/floorFilterUtils ../../../renderers/support/clickToleranceUtils ../../../rest/identify ../../../rest/support/IdentifyParameters ../../../support/arcadeOnDemand ../../../symbols/SimpleMarkerSymbol ./popupUtils".split(" "),
function(G,r,y,u,H,I,J,A,K,L,v,B,M,N,w,Y,Z,O,P,Q,R,C,S,T,U,D,E){function F(k,m,p){const a=[],d=b=>{var l=0===b.minScale||m<=b.minScale;const e=0===b.maxScale||m>=b.maxScale;b.visible&&l&&e&&(b.sublayers?b.sublayers.forEach(d):b.popupEnabled&&(l=E.getFetchPopupTemplate(b,{...p,defaultPopupTemplateEnabled:!1}),v.isSome(l)&&a.unshift({sublayer:b,popupTemplate:l})))};(k?.toArray()??[]).reverse().map(d);return a}function V(k){return k.expressionInfos?.length||Array.isArray(k.content)&&k.content.some(m=>
"expression"===m.type)?U.loadArcade():Promise.resolve()}async function W(k,m){if(k.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(m.map(({sublayer:p})=>p.load().then(()=>p.capabilities.operations.supportsQuery)))}catch{return!1}}async function X(k,m){const p=k.renderer;p&&"defaultSymbol"in p&&!p.defaultSymbol&&(m=p.valueExpression?await Promise.all(m.map(a=>p.getSymbolAsync(a).then(d=>d?a:null))).then(a=>a.filter(d=>null!=d)):m.filter(a=>null!=p.getSymbol(a)));return m}
let z=null;r.MapServiceLayerViewHelper=function(k){function m(a){var d=p.call(this,a);d._featuresResolutions=new WeakMap;d.highlightGraphics=null;d.highlightGraphicUpdated=null;d.updateHighlightedFeatures=B.debounce(async b=>{d.destroyed||d.updatingHandles.addPromise(d._updateHighlightedFeaturesGeometries(b).catch(()=>{}))});return d}y._inherits(m,k);var p=y._createSuper(m);k=m.prototype;k.initialize=function(){const a=d=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(d).catch(()=>
{}));this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([M.on(()=>this.highlightGraphics,"change",d=>a(d.added),{onListenerAdd:d=>a(d)})])};k.fetchPopupFeatures=async function(a,d){const {layerView:{layer:b,view:{scale:l}}}=this;if(!a)throw new A("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:b});const e=F(b.sublayers,l,d);if(!e.length)return[];const n=await W(b,e);if(!((b.capabilities?.operations?.supportsIdentify??!0)&&10.5<=b.version||
n))throw new A("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:b});return n?this._fetchPopupFeaturesUsingQueries(a,e,d):this._fetchPopupFeaturesUsingIdentify(a,e,d)};k.clearHighlights=function(){this.highlightGraphics?.removeAll()};k.highlight=function(a){const d=this.highlightGraphics;if(!d)return{remove(){}};let b=null;a instanceof H?b=[a]:J.isCollection(a)&&0<a.length?b=a.toArray():Array.isArray(a)&&0<a.length&&(b=a);b=b?.filter(v.isSome);if(!b||!b.length)return{remove:()=>
{}};for(const l of b)a=l.sourceLayer,null!=a&&"geometryType"in a&&"point"===a.geometryType&&(l.visible=!1);d.addMany(b);return{remove:()=>{d.removeMany(b??[])}}};k._updateHighlightedFeaturesSymbols=async function(a){const {layerView:{view:d},highlightGraphics:b,highlightGraphicUpdated:l}=this;if(b&&l)for(const e of a){const n=e.sourceLayer&&"renderer"in e.sourceLayer&&e.sourceLayer.renderer;e.sourceLayer&&"geometryType"in e.sourceLayer&&"point"===e.sourceLayer.geometryType&&n&&"getSymbolAsync"in n&&
n.getSymbolAsync(e).then(async c=>{c||(c=new D);let g=null;const h="visualVariables"in n?n.visualVariables?.find(f=>"size"===f.type):void 0;h&&(z||(z=(await new Promise((f,q)=>G(["../../../renderers/visualVariables/support/visualVariableUtils"],f,q))).getSize),g=z(h,e,{view:d.type,scale:d.scale,shape:"simple-marker"===c.type?c.style:null}));g||(g="width"in c&&"height"in c&&null!=c.width&&null!=c.height?Math.max(c.width,c.height):"size"in c?c.size:16);b.includes(e)&&(e.symbol=new D({style:"square",
size:g,xoffset:"xoffset"in c?c.xoffset:0,yoffset:"yoffset"in c?c.yoffset:0}),l(e,"symbol"),e.visible=!0)})}};k._updateHighlightedFeaturesGeometries=async function(a){const {layerView:{layer:d,view:b},highlightGraphics:l,highlightGraphicUpdated:e}=this;this._highlightGeometriesResolution=a;if(e&&l?.length&&d.capabilities.operations.supportsQuery){var n=this._getTargetResolution(a);a=new Map;for(var c of l)(!this._featuresResolutions.has(c)||this._featuresResolutions.get(c)>n)&&L.getOrCreateMapValue(a,
c.sourceLayer,()=>new Map).set(c.getObjectId(),c);c=Array.from(a,([g,h])=>{const f=g.createQuery();f.objectIds=[...h.keys()];f.outFields=[g.objectIdField];f.returnGeometry=!0;f.maxAllowableOffset=n;f.outSpatialReference=b.spatialReference;return g.queryFeatures(f)});c=await Promise.all(c);if(!this.destroyed)for(const {features:g}of c)for(const h of g)(c=a.get(h.sourceLayer).get(h.getObjectId()))&&l.includes(c)&&(c.geometry=h.geometry,e(c,"geometry"),this._featuresResolutions.set(c,n))}};k._getTargetResolution=
function(a){const d=a*N.getMetersPerUnitForSR(this.layerView.view.spatialReference),b=d/16;return 10>=b?0:a/d*b};k._fetchPopupFeaturesUsingIdentify=async function(a,d,b){a=await this._createIdentifyParameters(a,d,b);if(v.isNone(a))return[];({results:a}=await S.identify(this.layerView.layer.parsedUrl,a));return a.map(l=>l.feature)};k._createIdentifyParameters=async function(a,d,b){const {floors:l,layer:e,timeExtent:n,view:{spatialReference:c,scale:g}}=this.layerView,h=v.isSome(b)?b.event:null;if(!d.length)return null;
await Promise.all(d.map(({sublayer:t})=>t.load().catch(()=>{})));d=Math.min(K("mapservice-popup-identify-max-tolerance"),e.allSublayers.reduce((t,x)=>x.renderer?C.calculateTolerance({renderer:x.renderer,event:h}):t,2));var f=this.createFetchPopupFeaturesQueryGeometry(a,d);const q=Q.getResolutionForScale(g,c);b=Math.round(f.width/q);f=new P({xmin:f.center.x-q*b,ymin:f.center.y-q*b,xmax:f.center.x+q*b,ymax:f.center.y+q*b,spatialReference:f.spatialReference});return new T({floors:l,gdbVersion:"gdbVersion"in
e?e.gdbVersion:void 0,geometry:a,height:b,layerOption:"popup",mapExtent:f,returnGeometry:!0,spatialReference:c,sublayers:e.sublayers,timeExtent:n,tolerance:d,width:b})};k._fetchPopupFeaturesUsingQueries=async function(a,d,b){const {layerView:{floors:l,timeExtent:e}}=this,n=v.isSome(b)?b.event:null;d=d.map(async({sublayer:c,popupTemplate:g})=>{await c.load().catch(()=>{});if(c.capabilities&&!c.capabilities.operations.supportsQuery)return[];var h=c.createQuery(),f=C.calculateTolerance({renderer:c.renderer,
event:n}),q=this.createFetchPopupFeaturesQueryGeometry(a,f);h.geometry=q;h.outFields=await E.getRequiredFields(c,g);h.timeExtent=e;if(l){var t=l.clone();t=R.getLayerFloorFilterClause(t,c);v.isSome(t)&&(h.where=h.where?`(${h.where}) AND (${t})`:t)}f=this._getTargetResolution(q.width/f);q=await V(g);g="point"===c.geometryType||q&&q.arcadeUtils.hasGeometryOperations(g);g||(h.maxAllowableOffset=f);({features:h}=await c.queryFeatures(h));g=g?0:f;h=await X(c,h);for(const x of h)this._featuresResolutions.set(x,
g);return h});return(await B.eachAlways(d)).reverse().reduce((c,g)=>g.value?[...c,...g.value]:c,[]).filter(c=>null!=c)};return y._createClass(m)}(I);u.__decorate([w.property({constructOnly:!0})],r.MapServiceLayerViewHelper.prototype,"createFetchPopupFeaturesQueryGeometry",void 0);u.__decorate([w.property({constructOnly:!0})],r.MapServiceLayerViewHelper.prototype,"layerView",void 0);u.__decorate([w.property({constructOnly:!0})],r.MapServiceLayerViewHelper.prototype,"highlightGraphics",void 0);u.__decorate([w.property({constructOnly:!0})],
r.MapServiceLayerViewHelper.prototype,"highlightGraphicUpdated",void 0);u.__decorate([w.property({constructOnly:!0})],r.MapServiceLayerViewHelper.prototype,"updatingHandles",void 0);r.MapServiceLayerViewHelper=u.__decorate([O.subclass("esri.views.layers.support.MapService")],r.MapServiceLayerViewHelper);r.collectPopupProviders=F;r.isMapServiceLayerView=function(k,m){return"tile"===m.type||"map-image"===m.type};Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});