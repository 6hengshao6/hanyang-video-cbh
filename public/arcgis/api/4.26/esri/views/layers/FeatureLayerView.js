// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/FeatureEffect ../../layers/support/FeatureFilter ../../layers/support/fieldUtils ../../layers/support/floorFilterUtils ../../rest/support/Query ../../support/arcadeOnDemand ./support/popupUtils".split(" "),
function(u,p,y,D,m,A,v,q,K,L,M,E,F,G,H,f,B,C,I,w){const z=D.getLogger("esri.views.layers.FeatureLayerView");return l=>{l=function(g){function t(...a){a=J.call(this,...a);a._updatingRequiredFieldsPromise=null;a.filter=null;a.timeExtent=null;a.layer=null;a.requiredFields=[];a.view=null;return a}u._inherits(t,g);var J=u._createSuper(t);g=t.prototype;g.initialize=function(){this.handles.add([v.watch(()=>{const a=this.layer;return[a?.elevationInfo?.featureExpressionInfo,a&&"displayField"in a?a.displayField:
null,a&&"timeInfo"in a&&a.timeInfo,a&&"renderer"in a&&a.renderer,a&&"labelingInfo"in a&&a.labelingInfo,a&&"floorInfo"in a&&a.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),v.syncAndInitial),v.on(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),v.on(()=>{const a=this.layer;return a&&"sublayers"in a?a.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])};g.highlight=function(a){throw Error("missing implementation");
};g.createQuery=function(){var a={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};a=m.isSome(this.filter)?this.filter.createQuery(a):new C(a);if("feature"===this.layer.type){const b=B.getFloorFilterClause(this);m.isSome(b)&&(a.where=a.where?`(${a.where}) AND (${b})`:b)}m.isSome(this.timeExtent)&&(a.timeExtent=m.isSome(a.timeExtent)?a.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return a};g.createAggregateQuery=function(){return new C({outFields:["*"],
returnGeometry:!0,outSpatialReference:this.view.spatialReference})};g.queryFeatures=function(a,b){throw Error("missing implementation");};g.queryObjectIds=function(a,b){throw Error("missing implementation");};g.queryFeatureCount=function(a,b){throw Error("missing implementation");};g.queryExtent=function(a,b){throw Error("missing implementation");};g.fetchPopupFeatures=async function(a,b){if(a=this.validateFetchPopupFeatures(b))throw a;return this.fetchClientPopupFeatures(b)};g._loadArcadeModules=
function(a){return a.get("expressionInfos.length")||Array.isArray(a.content)&&a.content.some(b=>"expression"===b.type)?I.loadArcade():Promise.resolve()};g._handleRequiredFieldsChange=function(){const a=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a);a.then(()=>{this._updatingRequiredFieldsPromise===a&&this._set("_updatingRequiredFieldsPromise",null)})};g._updateRequiredFields=async function(){if(this.layer&&this.view){var a="3d"===this.view.type,{layer:b,layer:{fieldsIndex:d,
objectIdField:e}}=this,h="renderer"in b&&b.renderer,k="orderBy"in b&&b.orderBy,n="featureReduction"in b?b.featureReduction:null,c=new Set;h=await A.eachAlways([h?h.collectRequiredFields(c,d):null,f.collectLabelingFields(c,b),a?f.collectElevationFields(c,b):null,m.isSome(this.filter)?f.collectFilterFields(c,b,this.filter):null,m.isSome(this.featureEffect)?f.collectFilterFields(c,b,this.featureEffect.filter):null,n?f.collectFeatureReductionFields(c,b,n):null,k?f.collectOrderByInfos(c,b,k):null]);"timeInfo"in
b&&b.timeInfo&&this.timeExtent&&f.collectFields(c,b.fieldsIndex,[b.timeInfo.startField,b.timeInfo.endField]);"feature"===b.type&&(b.floorInfo&&f.collectFields(c,b.fieldsIndex,[b.floorInfo.floorField]),a&&m.isSome(b.infoFor3D)&&(null==b.globalIdField&&z.error("globalIdField missing on 3DObjectFeatureLayer"),f.collectFields(c,b.fieldsIndex,[b.globalIdField])));"subtype-group"===b.type&&(f.collectField(c,d,b.subtypeField),k=b.sublayers.map(r=>Promise.all([r.renderer?.collectRequiredFields(c,d),f.collectLabelingFields(c,
r)])),await A.eachAlways(k));for(const r of h)r.error&&z.error(r.error);f.collectField(c,d,e);a&&"displayField"in b&&b.displayField&&f.collectField(c,d,b.displayField);a=Array.from(c).sort();this._set("requiredFields",a)}};g.validateFetchPopupFeatures=function(a){if(m.isNone(a))return null;for(const b of a.clientGraphics??[]){const d=b.layer;if("popupEnabled"in d&&!d.popupEnabled)return new y("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:d});if(b.isAggregate){const e="featureReduction"in
d?d.featureReduction:null;if(!(e&&"popupTemplate"in e&&e.popupEnabled&&e.popupTemplate))return new y("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:d})}else if("popupTemplate"in d&&!w.getFetchPopupTemplate(d,a))return new y("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:d})}};g.fetchClientPopupFeatures=async function(a){const b=m.isSome(a)?a.clientGraphics:null;if(!b||0===b.length)return[];const d=Array(b.length),e=new Map,h=await this.createPopupQuery(a);
for(let n=0;n<b.length;n++){const c=b[n];if(c.isAggregate){d[n]=c;continue}var k=c.layer;if(!("popupEnabled"in k))continue;const r=f.unpackFieldNames(this.layer.fieldsIndex,h.outFields);k=w.getFetchPopupTemplate(k,a);if(m.isNone(k))continue;const x=await this._loadArcadeModules(k);x&&x.arcadeUtils.hasGeometryOperations(k)||!f.featureHasFields(r,c)?e.set(c.getObjectId(),{graphic:c,index:n}):d[n]=c}if("stream"===this.layer.type||0===e.size)return d.filter(Boolean);h.objectIds=Array.from(e.keys());try{const n=
await this.layer.queryFeatures(h);for(const c of n.features){const {graphic:{geometry:r},index:x}=e.get(c.getObjectId());c.geometry||(c.geometry=r);d[x]=c}}catch{}return d.filter(Boolean)};g.createPopupQuery=async function(a){const b=this.layer.createQuery(),d=new Set;var e=!1,h=m.isSome(a)&&a.clientGraphics?a.clientGraphics.map(k=>k.layer):[this.layer];for(const k of h)if("popupEnabled"in k&&(h=w.getFetchPopupTemplate(k,a),!m.isNone(h))){e=(e=await this._loadArcadeModules(h))&&e.arcadeUtils.hasGeometryOperations(h);
e=!("point"!==this.layer.geometryType&&!e);h=await w.getRequiredFields(this.layer,h);for(const n of h)d.add(n)}b.returnGeometry=e;b.returnZ=e;b.returnM=e;b.outFields=Array.from(d);b.outSpatialReference=this.view.spatialReference;"feature"===this.layer.type&&(a=B.getFloorFilterClause(this),m.isSome(a)&&(b.where=b.where?`(${b.where}) AND (${a})`:a));return b};g.canResume=function(){return!u._get(u._getPrototypeOf(t.prototype),"canResume",this).call(this)||m.isSome(this.timeExtent)&&this.timeExtent.isEmpty?
!1:!0};u._createClass(t,[{key:"availableFields",get:function(){const {layer:a,layer:{fieldsIndex:b},requiredFields:d}=this;return"outFields"in a&&a.outFields?f.fixFields(b,[...f.unpackFieldNames(b,a.outFields),...d]):f.fixFields(b,d)}},{key:"featureEffect",get:function(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null},set:function(a){this._override("featureEffect",a)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(a){z.error("#maximumNumberOfFeatures\x3d",
"Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]);return t}(l);p.__decorate([q.property()],l.prototype,"_updatingRequiredFieldsPromise",void 0);p.__decorate([q.property({readOnly:!0})],l.prototype,"availableFields",null);p.__decorate([q.property({type:G})],l.prototype,"featureEffect",null);p.__decorate([q.property({type:H})],l.prototype,"filter",void 0);p.__decorate([q.property(F.combinedViewLayerTimeExtentProperty)],l.prototype,
"timeExtent",void 0);p.__decorate([q.property()],l.prototype,"layer",void 0);p.__decorate([q.property({type:Number})],l.prototype,"maximumNumberOfFeatures",null);p.__decorate([q.property({readOnly:!0,type:Boolean})],l.prototype,"maximumNumberOfFeaturesExceeded",null);p.__decorate([q.property({readOnly:!0})],l.prototype,"requiredFields",void 0);p.__decorate([q.property()],l.prototype,"suspended",void 0);p.__decorate([q.property()],l.prototype,"view",void 0);return l=p.__decorate([E.subclass("esri.views.layers.FeatureLayerView")],
l)}});