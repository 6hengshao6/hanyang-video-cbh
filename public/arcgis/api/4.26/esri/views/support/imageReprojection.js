// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../request ../../geometry/Point ../../geometry/projection ../../layers/support/rasterFunctions/rasterProjectionHelper ../2d/engine/Bitmap ../2d/engine/webgl/VertexStream ../2d/engine/webgl/shaders/MaterialPrograms ../webgl/enums ../webgl/FramebufferObject ../webgl/rasterUtils ../webgl/RenderingContext ../webgl/Texture".split(" "),function(n,y,z,p,A,q,r,B,C,d,D,E,F,t){let x=function(){function g(a){this._ownsRctx=!1;if(a)this._ownsRctx=!1,this._rctx=
a;else{if(g._instance)return g._instanceRefCount++,g._instance;g._instanceRefCount=1;g._instance=this;this._ownsRctx=!0;a=document.createElement("canvas").getContext("webgl");a.getExtension("OES_texture_float");this._rctx=new F.RenderingContext(a,{})}a=C.createProgramTemplate("raster/reproject","raster/reproject",new Map([["a_position",0]]),{applyProjection:!0,bilinear:!1,bicubic:!1});this._program=this._rctx.programCache.acquire(a.shaders.vertexShader,a.shaders.fragmentShader,a.attributes);this._rctx.useProgram(this._program);
this._program.setUniform1f("u_opacity",1);this._program.setUniform1i("u_image",0);this._program.setUniform1i("u_flipY",0);this._program.setUniform1i("u_transformGrid",1);this._quad=new B(this._rctx,[0,0,1,0,0,1,1,1])}var l=g.prototype;l.reprojectTexture=function(a,b,e=!1){const c=A.project(a.extent,b);var h=new p({x:(a.extent.xmax-a.extent.xmin)/a.texture.descriptor.width,y:(a.extent.ymax-a.extent.ymin)/a.texture.descriptor.height,spatialReference:a.extent.spatialReference});const {x:G,y:H}=q.projectResolution(h,
b,a.extent);var f=(G+H)/2;b=Math.round((c.xmax-c.xmin)/f);h=Math.round((c.ymax-c.ymin)/f);f=(c.width/b+c.height/h)/2;f=new p({x:f,y:f,spatialReference:c.spatialReference});const m=q.getProjectionOffsetGrid({projectedExtent:c,srcBufferExtent:a.extent,pixelSize:f,hasWrapAround:!0,spacing:[16,16]}),u=E.createTransformTexture(this._rctx,m);f=new t.Texture(this._rctx,{width:b,height:h,pixelFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,
hasMipmap:!1});const k=new D.FramebufferObject(this._rctx,{colorTarget:d.TargetType.TEXTURE,depthStencilTarget:d.DepthStencilTargetType.NONE,width:b,height:h},f);this._rctx.bindFramebuffer(k);this._rctx.setViewport(0,0,b,h);this._rctx.useProgram(this._program);this._rctx.bindTexture(a.texture,0);this._rctx.bindTexture(u,1);this._quad.bind();const {width:I=0,height:J=0}=a.texture.descriptor;this._program.setUniform2f("u_srcImageSize",I,J);this._program.setUniform2fv("u_transformSpacing",m.spacing);
this._program.setUniform2fv("u_transformGridSize",m.size);this._program.setUniform2f("u_targetImageSize",b,h);this._quad.draw();this._quad.unbind();this._rctx.useProgram(null);this._rctx.bindFramebuffer(null);u.dispose();if(e){const {width:v=0,height:w=0}=k.descriptor;a=new ImageData(v,w);k.readPixels(0,0,v,w,d.PixelFormat.RGBA,d.PixelType.UNSIGNED_BYTE,a.data);k.detachColorTexture(d.ColorAttachment.COLOR_ATTACHMENT0);k.dispose();return{texture:f,extent:c,imageData:a}}k.detachColorTexture(d.ColorAttachment.COLOR_ATTACHMENT0);
k.dispose();return{texture:f,extent:c}};l.reprojectBitmapData=function(a,b){var e=r.isImageSource(a.bitmapData)?r.rasterize(a.bitmapData):a.bitmapData;e=new t.Texture(this._rctx,{width:a.bitmapData.width,height:a.bitmapData.height,pixelFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,hasMipmap:!1},e);a=this.reprojectTexture({texture:e,extent:a.extent},b,!0);a.texture.dispose();b=document.createElement("canvas");
e=a.imageData;b.width=e.width;b.height=e.height;b.getContext("2d").putImageData(e,0,0);return{bitmapData:b,extent:a.extent}};l.loadAndReprojectBitmapData=async function(a,b,e){a=(await z(a,{responseType:"image"})).data;const c=document.createElement("canvas");c.width=a.width;c.height=a.height;const h=c.getContext("2d");h.drawImage(a,0,0);a=h.getImageData(0,0,c.width,c.height);if(b.spatialReference.equals(e))return{bitmapData:a,extent:b};b=this.reprojectBitmapData({bitmapData:a,extent:b},e);return{bitmapData:b.bitmapData,
extent:b.extent}};l.destroy=function(){this._ownsRctx?(g._instanceRefCount--,0===g._instanceRefCount&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),g._instance=null)):(this._quad.dispose(),this._program.dispose())};return y._createClass(g)}();x._instanceRefCount=0;n.ImageReprojector=x;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});