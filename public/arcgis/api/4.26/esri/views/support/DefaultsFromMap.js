// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/asyncUtils ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/support/heightModelInfoUtils ../ViewingMode ./projectionUtils".split(" "),function(e,p,f,t,u,d,v,g,z,A,B,w,q,r,x){e.DefaultsFromMap=function(m){function n(a){a=
y.call(this,a);a.required={tileInfo:!1,heightModelInfo:!1,extent:!1};a.defaultSpatialReference=null;a.userSpatialReference=null;a.sourcePreloadCount=10;a.priorityCollection=null;a.requiresExtentInSpatialReference=!0;a.suspended=!1;a._projectExtentTask={task:null,input:null,output:null,spatialReference:null};return a}p._inherits(n,m);var y=p._createSuper(n);m=n.prototype;m.destroy=function(){this._projectExtentTask.task&&(this._projectExtentTask.task=d.abortMaybe(this._projectExtentTask.task));this._set("map",
null)};m._narrowDownSpatialReferenceCandidates=function(a,c){if(d.isNone(a))return c;const b=[];for(const k of a)for(const l of c)if(k.spatialReference.equals(l.spatialReference)){a=k.viewingMode;var h=l.viewingMode;a=d.isSome(a)?d.isSome(h)?a===h?a:!1:a:h;if(!1!==a){b.push({spatialReference:k.spatialReference,viewingMode:a});break}}return 0<b.length?b:null};m._pickSpatialReferenceCandidate=function(a){const c=this.defaultSpatialReference;if(d.isNone(a)||1>a.length)return d.isSome(c)?{spatialReference:c,
viewingMode:null}:null;d.isSome(c)&&1<a.length&&a.some(({spatialReference:b})=>b.equals(c))&&(a=a.filter(({spatialReference:b})=>b.equals(c)));1<a.length&&a.some(({viewingMode:b})=>b!==r.ViewingMode.Local)&&(a=a.filter(({viewingMode:b})=>b!==r.ViewingMode.Local));return a[0]};m._getSupportedSpatialReferences=function(a){var c="supportedSpatialReferences"in a&&a.supportedSpatialReferences||(a.spatialReference?[a.spatialReference]:[]);if(0===c.length)return[];const b=[];for(const h of c)if(c=this.getSpatialReferenceSupport({spatialReference:h,
layer:a}),d.isSome(c)){c=d.isSome(c.constraints)?c.constraints:[{spatialReference:h,viewingMode:null}];for(const {spatialReference:k,viewingMode:l}of c)(!this.requiresExtentInSpatialReference||d.isNone(this.userSpatialReference)||k.equals(this.userSpatialReference))&&b.push({spatialReference:k,viewingMode:l})}return b};m._pickExtentCandidate=function(a){const c=this.spatialReference;return a.find(({extent:b})=>c.equals(b.spatialReference))||a[0]};m._collectLayers=function(a){if("loaded"!==this._loadMaybe(this.map?.()))return{layers:[],
updating:!0};const c={layers:[],preloading:-1,updating:!1};for(const b of a)if(this._collectCollection(b,c),c.preloading===this.sourcePreloadCount)break;return{layers:c.layers,updating:c.updating}};m._collectCollection=function(a,c){if(a.layers){switch(this._loadMaybe(a.parent)){case "loading":c.updating=!0;++c.preloading;return;case "failed":return}for(const b of a.layers){switch(this._loadMaybe(b)){case "failed":continue;case "loading":c.updating=!0;++c.preloading;break;case "loaded":c.updating||
c.layers.push(b),"layers"in b&&this._collectCollection({layers:b.layers},c)}if(c.preloading===this.sourcePreloadCount)break}}};m._loadMaybe=function(a){return a&&"loadStatus"in a&&null!=a.loadStatus?"not-loaded"===a.loadStatus?(a.load().catch(()=>{}),"loading"):a.loadStatus:"loaded"};p._createClass(n,[{key:"ready",get:function(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}},{key:"heightModelInfoReady",get:function(){return!this._heightModelInfoTask.updating}},
{key:"spatialReference",get:function(){return d.isSome(this.userSpatialReference)?this.userSpatialReference:d.unwrap(this._spatialReferenceTask.spatialReference)}},{key:"extent",get:function(){return d.unwrap(this._extentTask.extent)}},{key:"heightModelInfo",get:function(){return d.unwrap(this._heightModelInfoTask.heightModelInfo)}},{key:"vcsWkid",get:function(){return d.unwrap(this._heightModelInfoTask.vcsWkid)}},{key:"latestVcsWkid",get:function(){return d.unwrap(this._heightModelInfoTask.latestVcsWkid)}},
{key:"viewingMode",get:function(){return d.isNone(this.userSpatialReference)||this.userSpatialReference.equals(d.unwrap(this._spatialReferenceTask.spatialReference))?d.unwrap(this._spatialReferenceTask.viewingMode):null}},{key:"tileInfo",get:function(){return d.unwrap(this._tileInfoTask.tileInfo)}},{key:"mapCollections",get:function(){const a=this.map?.(),c=[];d.isSome(this.priorityCollection)&&c.push(this.priorityCollection);c.push({parent:a?.basemap,layers:a?.basemap?.baseLayers},{layers:a?.layers},
{parent:a?.ground,layers:a?.ground?.layers},{parent:a?.basemap,layers:a?.basemap?.referenceLayers});return c}},{key:"_allLayers",get:function(){return this._collectLayers(this.mapCollections)}},{key:"_spatialReferenceTask",get:function(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const {layers:a,updating:c}=this._allLayers;var b=null;for(const k of a){var h=this._getSupportedSpatialReferences(k);0<h.length&&(h=this._narrowDownSpatialReferenceCandidates(b,h),d.isSome(h)&&
(b=h));if(d.isSome(b)&&1===b.length)break}if(c&&(d.isNone(b)||1!==b.length))return{updating:!0};b=this._pickSpatialReferenceCandidate(b);return{spatialReference:d.isSome(b)?b.spatialReference:null,viewingMode:d.isSome(b)?b.viewingMode:null,updating:!1}}},{key:"_tileInfoTask",get:function(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const {layers:a,updating:c}=this._collectLayers([{parent:this.map?.()?.basemap,
layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(a&&0<a.length&&"tileInfo"in a[0]){const b=a[0].tileInfo;return{tileInfo:b&&b.spatialReference.equals(this.spatialReference)?b:null,updating:!1}}return{updating:c}}},{key:"_heightModelInfoTask",get:function(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const {layers:a,updating:c}=this._allLayers;for(const b of a)if(q.supportsHeightModelInfo(b)){const h=
q.deriveHeightModelInfoFromLayer(b);if(h)return{heightModelInfo:h,vcsWkid:b.spatialReference?.vcsWkid,latestVcsWkid:b.spatialReference?.latestVcsWkid,updating:!1}}return{updating:c}}},{key:"_extentCandidatesTask",get:function(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};var a=this._allLayers;const c=a.updating,b=[];for(const k of a.layers){a="fullExtents"in k&&k.fullExtents||
(d.isSome(k.fullExtent)?[k.fullExtent]:[]);var h=this.requiresExtentInSpatialReference?null:a[0];if(h=a.find(l=>l.spatialReference.equals(this.spatialReference))??h)return{candidates:[{extent:h,layer:k}],updating:!1};if(0<this._getSupportedSpatialReferences(k).length)for(const l of a)b.push({extent:l,layer:k})}return{candidates:b,updating:c}}},{key:"_extentTask",get:function(){const {candidates:a,updating:c}=this._extentCandidatesTask;if(c)return{updating:c};if(d.isNone(a)||0===a.length)return{updating:!1};
if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const b=this._pickExtentCandidate(a),h=this.spatialReference;if(b.extent.equals(this._projectExtentTask.input)&&h.equals(this._projectExtentTask.spatialReference))return{extent:this._projectExtentTask.output,updating:d.isSome(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished};d.isSome(this._projectExtentTask.task)&&(this._projectExtentTask.task=d.abortMaybe(this._projectExtentTask.task));this._projectExtentTask=
{input:b.extent.clone(),output:null,spatialReference:h.clone(),task:u.createTask(async k=>{try{const l=await x.projectWithEngineOrService(b.extent,h,b.layer.portalItem,k);this._projectExtentTask={...this._projectExtentTask,task:null,output:l}}catch(l){v.isAborted(k)||(this._projectExtentTask={...this._projectExtentTask,task:null})}})};return{updating:!0}}}]);return n}(t);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"required",void 0);f.__decorate([g.property({constructOnly:!0})],e.DefaultsFromMap.prototype,
"map",void 0);f.__decorate([g.property({constructOnly:!0})],e.DefaultsFromMap.prototype,"getSpatialReferenceSupport",void 0);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"defaultSpatialReference",void 0);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"userSpatialReference",void 0);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"sourcePreloadCount",void 0);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"priorityCollection",void 0);f.__decorate([g.property()],e.DefaultsFromMap.prototype,
"requiresExtentInSpatialReference",void 0);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"suspended",void 0);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"ready",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"heightModelInfoReady",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"spatialReference",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"extent",null);f.__decorate([g.property({readOnly:!0})],
e.DefaultsFromMap.prototype,"heightModelInfo",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"vcsWkid",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"latestVcsWkid",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"viewingMode",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"tileInfo",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"mapCollections",null);f.__decorate([g.property({readOnly:!0})],
e.DefaultsFromMap.prototype,"_allLayers",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_spatialReferenceTask",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_tileInfoTask",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_heightModelInfoTask",null);f.__decorate([g.property({readOnly:!0})],e.DefaultsFromMap.prototype,"_extentCandidatesTask",null);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"_extentTask",
null);f.__decorate([g.property()],e.DefaultsFromMap.prototype,"_projectExtentTask",void 0);e.DefaultsFromMap=f.__decorate([w.subclass("esri.views.support.DefaultsFromMap")],e.DefaultsFromMap);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});