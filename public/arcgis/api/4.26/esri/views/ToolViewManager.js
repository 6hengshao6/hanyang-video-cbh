// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Accessor ../core/Collection ../core/HandleOwner ../core/handleUtils ../core/has ../core/Logger ../core/maybe ../core/reactiveUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/accessorSupport/decorators/subclass ./3d/state/ViewStateManager ./3d/support/TextureCollection ./input/InputManager ./input/ViewEvents ./interactive/interactiveToolUtils ./interactive/interfaces ./interactive/ToolViewManagerManipulatorState".split(" "),
function(m,g,r,q,f,t,D,u,d,n,h,E,F,v,w,x,y,z,p,A,B){f=function(c){function k(a){var b=C.call(this,a);b._manipulatorState=new B.ToolViewManagerManipulatorState;b.tools=new q;b.cursor=null;b._interacting=!1;b._interactingTimeoutId=null;b._forEachTool=e=>{for(const l of b.tools.items)if(e(l))break};return b}m._inherits(k,c);var C=m._createSuper(k);c=k.prototype;c.initialize=function(){this.handles.add([this.view.on(z.eventTypes,a=>{this._handleInputEvent(a)},y.ViewEventPriorities.TOOL),...p.getToolCollectionHandles(this.tools),
this.tools.on("before-add",({item:a})=>{this._updateToolEditableFlag(a)}),this.tools.on("before-remove",({item:a})=>{this._manipulatorState.clearPointers(a,this._manipulatorStateEventArgs);this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])};c.destroy=function(){this.detach();this.handles.removeAll()};c._clearInteractingTimeout=function(){null!=this._interactingTimeoutId&&(clearTimeout(this._interactingTimeoutId),this._interactingTimeoutId=null)};c._startInteractingTimeout=
function(){this._clearInteractingTimeout();this._interactingTimeoutId=setTimeout(()=>this._interacting=!1,w.INTERACTING_TIMEOUT)};c.attach=function(){"3d"===this.view.type?(this._set("textures",new x.TextureCollection(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([n.watch(()=>{const {state:a}=this.view;return"camera"in a&&a.camera},()=>this._forEachManipulator(a=>a.onViewChange())),this.view.elevationProvider?.on("elevation-change",a=>this._forEachManipulator(b=>b.onElevationChange(a))),
t.makeHandle(()=>this._set("textures",d.destroyMaybe(this.textures)))],"attached")):this.handles.add(n.watch(()=>this.view.extent,()=>this._forEachManipulator(a=>a.onViewChange())))};c.detach=function(){d.isSome(this.activeTool)&&(this.activeTool=null);this.tools.removeAll();this.handles.remove("attached");this._clearInteractingTimeout();this._interacting=!1};c._forEachManipulator=function(a){this._forEachTool(b=>{b.manipulators&&b.manipulators.forEach(({manipulator:e})=>a(e,b))})};c._handleInputEvent=
function(a){let b=!1;const e={...a,stopPropagation:()=>{b=!0;a.stopPropagation()}};d.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(e):this._forEachTool(l=>{!b&&l.visible&&l.handleInputEvent(e)});!b&&"key-down"===a.type&&"Escape"===a.key&&this.activeTool&&(a.stopPropagation(),this.activeTool=null);this._manipulatorState.handleInputEvent(e,this._manipulatorStateEventArgs);!b&&d.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter(e);this._manipulatorState.handleHoverEvent(e,
this._forEachTool);this._updateCursor();if(this._manipulatorState.isInteracting()||b||d.isSome(this.activeTool)&&this.activeTool.interacting)this._interacting=!0,this._startInteractingTimeout()};c._refreshToolWatchers=function(){this.handles.remove("tools");this._forEachTool(a=>{if(a instanceof r){const b=n.watch(()=>[a.cursor,a.visible,a.editable],()=>{p.areToolManipulatorsEditable(a)||this._manipulatorState.clearPointers(a,this._manipulatorStateEventArgs);this._updateCursor()});this.handles.add(b,
"tools")}a.manipulators&&this.handles.add([a.manipulators.on("after-remove",b=>{this._manipulatorState.clearPointers(a,this._manipulatorStateEventArgs,!0,b.item.manipulator)}),a.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()})],"tools")});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()};c._updateToolEditableFlag=function(a){a.setEditableFlag?.(A.EditableFlag.MANAGER,
d.isNone(this.activeTool)||a===this.activeTool)};c._updateCursor=function(){let a=this._manipulatorState.cursor;d.isNone(a)&&this._forEachTool(b=>d.isSome(b.cursor)&&b.visible?(a=b.cursor,!0):!1);this._get("cursor")!==a&&this._set("cursor",a)};c._removeIncompleteTools=function(a){this.tools.filter(b=>(d.isNone(a)||b!==a)&&!b.created&&b.removeIncompleteOnCancel).forEach(b=>{this.tools.remove(b)})};m._createClass(k,[{key:"_manipulatorStateEventArgs",get:function(){return{forEachTool:this._forEachTool,
activeTool:this.activeTool,setActiveTool:a=>{this.activeTool=a},view:this.view}}},{key:"activeTool",set:function(a){if(d.isSome(a)&&!this.view.ready)u.getLogger(this.declaredClass).error("Cannot set active tool while view is not ready.");else if(a!==this.activeTool){var b=this.activeTool;this._set("activeTool",a);d.isSome(b)&&b.deactivate();d.isSome(a)&&a.activate();this._removeIncompleteTools(a);for(const e of this.tools)this._updateToolEditableFlag(e),a=p.areToolManipulatorsEditable(e),!d.isNone(this.activeTool)&&
a||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!a);this._updateCursor()}}},{key:"updating",get:function(){return this.updatingHandles.updating||this.tools.some(a=>a.updating)||(this.textures?.updating??!1)}},{key:"interacting",get:function(){return this._interacting}}]);return k}(f.HandleOwner);g.__decorate([h.property({constructOnly:!0,nonNullable:!0})],f.prototype,"view",void 0);g.__decorate([h.property({readOnly:!0,nonNullable:!0})],f.prototype,"textures",void 0);g.__decorate([h.property({value:null})],
f.prototype,"activeTool",null);g.__decorate([h.property({readOnly:!0,type:q})],f.prototype,"tools",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"cursor",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"updating",null);g.__decorate([h.property()],f.prototype,"_interacting",void 0);g.__decorate([h.property({readOnly:!0})],f.prototype,"interacting",null);return f=g.__decorate([v.subclass("esri.views.ToolViewManager")],f)});