// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/maybe ../core/promiseUtils ../core/Logger ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/Error ../core/accessorSupport/decorators/subclass".split(" "),function(q,m,r,h,t,w,x,y,z,A,u){q.PopupView=k=>{k=function(f){function l(){return v.apply(this,arguments)}m._inherits(l,f);var v=m._createSuper(l);f=l.prototype;f.fetchPopupFeatures=async function(a,c){await this.when();const {location:d,queryArea:e,
layerViewsAndGraphics:b,clientOnlyGraphics:g}=await this._prepareFetchPopupFeatures(a,c);a=Promise.resolve(g);c=this._queryLayerPopupFeatures(e,b,c);const p=c.map(n=>n.promise);a=t.eachAlwaysValues([a,...p]).then(n=>Array.from(new Set(n.flat())));return{location:d,clientOnlyGraphics:g,allGraphicsPromise:a,promisesPerLayerView:c}};f._queryLayerPopupFeatures=function(a,c,d){return c.map(({layerView:e,graphics:b})=>{b={clientGraphics:b,event:h.isSome(d)?d.event:void 0,signal:h.isSome(d)?d.signal:void 0,
defaultPopupTemplateEnabled:h.isSome(d)?!!d.defaultPopupTemplateEnabled:!1};b=e.fetchPopupFeatures(a,b);return{layerView:e,promise:b}})};f._isValidPopupGraphic=function(a,c){return a&&!!a.getEffectivePopupTemplate(h.isSome(c)&&c.defaultPopupTemplateEnabled)};f._prepareFetchPopupFeatures=async function(a,c){const {clientGraphics:d,queryArea:e,location:b}=await this._popupHitTestGraphics(a,c);a=this._getFetchPopupLayerViews();const {layerViewsAndGraphics:g,clientOnlyGraphics:p}=this._graphicsPerFetchPopupLayerView(d,
a);return{clientOnlyGraphics:p,layerViewsAndGraphics:g,queryArea:e,location:b}};f._popupHitTestGraphics=async function(a,c){var d=await this.popupHitTest(a);a=d.mapPoint;d=d.results.filter(b=>"graphic"===b.type&&this._isValidPopupGraphic(b.graphic,c));const e=d.length?d[0].mapPoint:null;return{clientGraphics:d.map(b=>b.graphic),queryArea:a,location:a||e}};f._getFetchPopupLayerViews=function(){const a=[];this.allLayerViews.forEach(c=>{this._isValidPopupLayerView(c)&&a.push(c)});h.isSome(this.graphicsView)&&
this._isValidPopupLayerView(this.graphicsView)&&a.push(this.graphicsView);return a.reverse()};f._isValidPopupLayerView=function(a){return h.isSome(a)&&(!("layer"in a)||!a.suspended)&&"fetchPopupFeatures"in a};f._graphicsPerFetchPopupLayerView=function(a,c){const d=[],e=new Map;c=c.map(b=>{const g=[];"layer"in b?e.set(b.layer,g):e.set(b.graphics,g);return{layerView:b,graphics:g}});for(const b of a)(a=e.get(b.layer)||e.get(b.sourceLayer)||null)?a.push(b):d.push(b);return{layerViewsAndGraphics:c,clientOnlyGraphics:d}};
return m._createClass(l)}(k);return k=r.__decorate([u.subclass("esri.views.PopupView")],k)};Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});