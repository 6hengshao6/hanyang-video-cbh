// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Accessor ../core/Error ../core/Logger ../core/MapUtils ../core/maybe ../core/promiseUtils ../core/reactiveUtils ../core/scheduling ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/arrayUtils ../core/has ../core/accessorSupport/decorators/subclass ../core/support/WatchUpdatingTracking ../support/collectionUtils".split(" "),function(w,n,k,v,A,B,u,m,z,C,q,H,I,J,D,E,F){let G=function(){function l(f,
b,a){this.layer=f;this.view=b;this.layerViewImporter=a;this._controller=new AbortController;this._deferred=m.createDeferred();this.done=this._started=!1;this.promise=this._deferred.promise;m.onAbort(this._controller.signal,()=>{const d=new v("cancelled:layerview-create","layerview creation cancelled",{layer:f});this._deferred.reject(d)})}var r=l.prototype;r.tryRecycle=function(f){if(!(this.done&&this.layerView&&"tryRecycleWith"in this.layerView))return null;const b=this.layer.type,a=this._controller.signal;
for(let d=0;d<f.length;d++){const c=f[d];if(c.type!==b)continue;const h=this.layerView.tryRecycleWith(c,{signal:a});if(h){f.splice(d,1);this.layer=c;const p=this.layerView,t=p.view;return this.promise=Promise.race([h.then(()=>{m.throwIfAborted(this._controller.signal);c.emit("layerview-destroy",{view:t,layerView:p});t.emit("layerview-destroy",{view:t,layerView:p});c.emit("layerview-create",{view:t,layerView:p});t.emit("layerview-create",{view:t,layerView:p});return p}),new Promise((x,y)=>m.onAbort(this._controller.signal,
()=>y(m.createAbortError())))])}}return null};r.destroy=function(){this._controller.abort();const {layerView:f}=this;if(f){const {layer:b,view:a}=this;b.emit("layerview-destroy",{view:a,layerView:f});a.emit("layerview-destroy",{layer:b,layerView:f})}this.done=!0;this.layerViewImporter=this.view=this.layerView=this.layer=null};r.start=async function(){if(!this._started){this._started=!0;var {_controller:{signal:f},layer:b,view:a}=this;this._map=a.map;try{await b.load({signal:f});"prefetchResources"in
b&&await b.prefetchResources?.({signal:f});let c;if("createLayerView"in b&&null!=b.createLayerView)c=await b.createLayerView(a,{signal:f});else{if(!this.layerViewImporter.hasLayerViewModule(b))throw new v("layer:view-not-supported","No layerview implementation was found");var d=await this.layerViewImporter.importLayerView(b);m.throwIfAborted(f);c="default"in d?new d.default({layer:b,view:a}):new d({layer:b,view:a})}let h;d=()=>{h=u.removeMaybe(h);c.destroyed||c.destroy();c.layer=null;c.parent=null;
c.view=null;this.done=!0};h=m.onAbort(f,d);m.throwIfAborted(f);try{await c.when()}catch(p){throw d(),p;}this._map?.allLayers?.includes(b)?(this.layerView=c,b.emit("layerview-create",{view:a,layerView:c}),a.emit("layerview-create",{layer:b,layerView:c}),this.done=!0,this._deferred.resolve(c)):(d(),this._deferred.reject(new v("view:no-layerview-for-layer","The layer has been removed from the map",{layer:b})))}catch(c){b.emit("layerview-create-error",{view:a,error:c}),a.emit("layerview-create-error",
{layer:b,error:c}),this.done=!0,this._deferred.reject(new v("layerview:create-error","layerview creation failed",{layer:b,error:c}))}}};return w._createClass(l)}();k=function(l){function r(b){var a=f.call(this,b);a._layerLayerViewInfoMap=new Map;a._recyclingInfoMap=new Map;a._watchUpdatingTracking=new E.WatchUpdatingTracking;a.supportsGround=!0;a._preloadLayerViewModules=()=>{const d=a.view.map?.allLayers;if(d)for(const c of d)a.layerViewImporter.hasLayerViewModule(c)&&a.layerViewImporter.importLayerView(c)};
a._reschedule=()=>{u.isNone(a._workPromise)&&(a._workPromise=m.createDeferred(),a._workPromise.promise.catch(()=>{}));a.removeHandles("reschedule");a.addHandles(C.schedule(a._doWork),"reschedule");return a._workPromise.promise};a._doWork=()=>{const d=a.view.map;a._map!==d&&(a.clear(),a._map=d);if(u.isNone(a._workPromise))a.notifyChange("updating");else{a.removeHandles("reschedule");a.removeHandles("collection-change");var c=new Set,h=[],p=a.view.ready,t=g=>{if(!u.isNone(g))for(const e of g)e&&(c.add(e),
(g=a._layerLayerViewInfoMap.get(e))&&p?g.start():g||a._recyclingInfoMap.has(e)||h.push(e),"layers"in e&&e.layers&&t(e.layers))};for(var x of a._rootCollectionNames)t(a.get(x));for(const [g,e]of a._layerLayerViewInfoMap)c.has(g)||(a._layerLayerViewInfoMap.delete(e.layer),(x=e.tryRecycle(h))?(a._recyclingInfoMap.set(e.layer,e),x.then(()=>{a._recyclingInfoMap.delete(e.layer);a._layerLayerViewInfoMap.set(e.layer,e);a._reschedule()}).catch(()=>{a._recyclingInfoMap.delete(e.layer);e.destroy();a._reschedule()})):
e.destroy());for(const [g,e]of a._recyclingInfoMap)c.has(g)||(a._recyclingInfoMap.delete(e.layer),e.destroy());for(const g of h)a._createLayerView(g);a._refreshCollections();var y=[d?.ground?.layers,d?.basemap?.baseLayers,d?.basemap?.referenceLayers,d?.layers].filter(g=>!!g);c.forEach(g=>"layers"in g&&y.push(g.layers));a.addHandles(y.map(g=>a._watchUpdatingTracking.addOnCollectionChange(()=>g,a._reschedule)),"collection-change");a._workPromise.resolve();a._workPromise=null}};return a}w._inherits(r,
l);var f=w._createSuper(r);l=r.prototype;l.initialize=function(){this.own([z.on(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),z.watch(()=>{const b=this.view,a=b?.map;return[a?.basemap,a?.ground,a?.layers,b?.ready]},()=>this._reschedule(),z.syncAndInitial)]);this._preloadLayerViewModules();this._reschedule()};l.destroy=function(){this.clear();F.destroyMap(this._recyclingInfoMap);this._watchUpdatingTracking.destroy();this._map=null;
u.isSome(this._workPromise)&&(this._workPromise.reject(m.createAbortError()),this._workPromise=null)};l.clear=function(){if(!this.destroyed){for(const b of this._layerLayerViewInfoMap.values())b.destroy();this._layerLayerViewInfoMap.clear();this._refreshCollections()}};l.whenLayerView=async function(b){await this._reschedule();if(!this._layerLayerViewInfoMap.has(b)){if(this._recyclingInfoMap.has(b))return this._recyclingInfoMap.get(b).promise;throw new v("view:no-layerview-for-layer","No layerview has been found for the layer",
{layer:b});}return this._layerLayerViewInfoMap.get(b).promise};l._refreshCollections=function(){for(const [b,a]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(b),this.get(a),this.view);this.notifyChange("updating");this.notifyChange("updatingRemaining")};l._populateLayerViewsOwners=function(b,a,d){if(b&&a){var c=0;for(const h of b)(b=this._layerLayerViewInfoMap.get(h))&&b.layerView&&(b=b.layerView,b.layer=h,b.parent=d,a.getItemAt(c)!==b&&a.splice(c,0,b),h.layers&&this._populateLayerViewsOwners(h.layers,
b.layerViews,b),c+=1);c<a.length&&a.splice(c,a.length)}else a&&a.removeAll()};l._createLayerView=function(b){b.load().catch(()=>{});this.layerViewImporter.hasLayerViewModule(b)&&this.layerViewImporter.importLayerView(b);const a=new G(b,this.view,this.layerViewImporter);a.promise.then(()=>this._refreshCollections(),d=>{d&&(m.isAbortError(d)||"cancelled:layerview-create"===d.name)||A.getLogger(this.declaredClass).error(`Failed to create layerview for layer title:'${b.title??"no title"}', id:'${b.id??
"no id"}' of type '${b.type}'.`,{layer:b,error:d});this._refreshCollections()});this._layerLayerViewInfoMap.set(b,a);this.view.ready&&a.start();this.notifyChange("updating");this.notifyChange("updatingRemaining")};w._createClass(r,[{key:"_layersToLayerViews",get:function(){const b=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];this.supportsGround&&b.push(["view.map.ground.layers",
"view.groundView.layerViews"]);return new Map(b)}},{key:"_rootCollectionNames",get:function(){return Array.from(this._layersToLayerViews.keys())}},{key:"updating",get:function(){return u.isSome(this._workPromise)||this._watchUpdatingTracking.updating||B.someMap(this._layerLayerViewInfoMap,b=>!b.done)}},{key:"updatingRemaining",get:function(){let b=0;for(const a of this._layerLayerViewInfoMap.values())a.done||++b;return b}}]);return r}(k);n.__decorate([q.property()],k.prototype,"_workPromise",void 0);
n.__decorate([q.property({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0);n.__decorate([q.property({readOnly:!0})],k.prototype,"_layersToLayerViews",null);n.__decorate([q.property({readOnly:!0})],k.prototype,"_rootCollectionNames",null);n.__decorate([q.property()],k.prototype,"layerViewImporter",void 0);n.__decorate([q.property()],k.prototype,"supportsGround",void 0);n.__decorate([q.property({readOnly:!0})],k.prototype,"updating",null);n.__decorate([q.property({readOnly:!0})],k.prototype,
"updatingRemaining",null);n.__decorate([q.property({constructOnly:!0})],k.prototype,"view",void 0);return k=n.__decorate([D.subclass("esri.views.LayerViewManager")],k)});