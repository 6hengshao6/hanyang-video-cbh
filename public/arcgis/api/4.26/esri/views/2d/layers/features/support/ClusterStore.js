// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../geometry ../../../../../core/Evented ../../../../../core/has ../../../../../core/maybe ../../../../../core/accessorSupport/diffUtils ../../../../../geohash/GeohashTree ../../../../../geohash/geohashUtils ../../../../../geometry/support/aaBoundingBox ../../../../../geometry/support/Ellipsoid ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/projectionSupport ../../../engine/webgl/definitions ../../../engine/webgl/DisplayId ../FeatureStore2D ../Store2D ./FeatureSetReaderJSON ../../../../../geometry/SpatialReference ../../../../../geometry/Polygon ../../../../../geometry/Extent".split(" "),
function(D,w,I,R,J,t,K,S,z,T,x,U,B,L,M,E,r,N,V,W,O,F,X,Y){const Z=T.create();let P=function(f){function p(a,b,c,d,e){b=new M([],[b,c]);a=G.call(this,b,d,null,a);a.geohashBoundsInfo=e;return a}w._inherits(p,f);var G=w._createSuper(p);p.create=function(a,b,c,d,e,g,h,k){b=new p(b,c,d,g,h);b.displayId=a.createDisplayId(!0);b.referenceId=k;b.tileLevel=e;return b};f=p.prototype;f.update=function(a,b,c,d,e,g){this.geometry.coords[0]=a;this.geometry.coords[1]=b;this.tileLevel=c;this.attributes=d;this.geohashBoundsInfo=
e;this.referenceId=null;this.referenceId=g;return this};f.toJSON=function(){return{attributes:{...this.attributes,aggregateId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}};w._createClass(p,[{key:"count",get:function(){return this.attributes.cluster_count}}]);return p}(L.OptimizedFeatureWithGeometry);I=function(f){function p(a,b,c,d){var e=G.call(this,a,c);e.type="cluster";e.events=new R;e.objectIdField=
"aggregateId";e.featureAdapter=V.featureAdapter;e._geohashLevel=0;e._tileLevel=0;e._aggregateValueRanges={};e._aggregateValueRangesChanged=!1;e._geohashBuf=[];e._clusters=new Map;e._tiles=new Map;e._serviceInfo=d;e.geometryInfo=a.geometryInfo;e._spatialReference=b;e._projectionSupportCheck=E.checkProjectionSupport(b,F.WGS84);e._bitsets.geohash=c.getBitset(c.createBitset());e._bitsets.inserted=c.getBitset(c.createBitset());return e}w._inherits(p,f);var G=w._createSuper(p);f=p.prototype;f.destroy=function(){this._tree.destroy()};
f.updateSchema=async function(a,b){const c=this._schema;try{await w._get(w._getPrototypeOf(p.prototype),"updateSchema",this).call(this,a,b),await this._projectionSupportCheck}catch(e){}this._fields=this._schema.params.fields;const d=K.diff(c,b);if(!b||t.isNone(d)&&!a.source&&!a.storage.filters)c&&(a.mesh=!0);else{if(K.hasDiff(d,"params.fields")||!this._tree||a.source)this._tree&&this._tree.destroy(),this._tree=new S.GeohashTree(this._statisticFields,this._serviceInfo),this._rebuildTree(),J("esri-2d-update-debug")&&
console.debug("Aggregate mesh needs update due to tree changing");J("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",d);a.targets[b.name]=!0;a.mesh=!1;this._aggregateValueRanges={}}};f.clear=function(){this._rebuildTree()};f.sweepFeatures=function(a,b){this._bitsets.inserted.forEachSet(c=>{a.has(c)||(c=b.lookupByDisplayIdUnsafe(c),this._remove(c))})};f.sweepAggregates=function(a,b,c){this._clusters.forEach((d,e)=>{d&&d.tileLevel!==c&&(a.releaseDisplayId(d.displayId),b.unsetAttributeData(d.displayId),
this._clusters.delete(e))})};f.onTileData=function(a,b,c,d,e=!0){if(!this._schema||t.isNone(b.addOrUpdate))return b;this.events.emit("changed");var g=this._getTransforms(a,this._spatialReference);const h=b.addOrUpdate.getCursor();for(;h.next();)this._update(h,d);if(b.status.mesh||!e)return b;d=[];this._getClustersForTile(d,a,this._schema.params.clusterRadius,c,g);b.addOrUpdate=O.FeatureSetReaderJSON.fromOptimizedFeatures(d,this._serviceInfo);b.addOrUpdate.attachStorage(c);b.clear=!0;b.end=!0;for(g=
b.addOrUpdate.getCursor();g.next();)d=g.getDisplayId(),this._bitsets.computed.unset(d),this.setComputedAttributes(c,g,d,a.scale);this._aggregateValueRangesChanged&&b.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1);return b};f.onTileUpdate=function({added:a,removed:b}){a.length&&(this._tileLevel=a=a[0].level,this._setGeohashLevel(a));if(this._schema){var c=this._schema.params.clusterRadius;b.forEach(d=>{this._tiles.delete(d.key.id);
this._markTileClustersForDeletion(d,c)})}};f.getAggregate=function(a){for(const b of this._clusters.values())if((b?.displayId&N.DISPLAY_ID_TEXEL_MASK)===(a&N.DISPLAY_ID_TEXEL_MASK))return b.toJSON();return null};f.getAggregates=function(){const a=[];for(const b of this._clusters.values())b?.tileLevel===this._tileLevel&&a.push(b.toJSON());return a};f.getDisplayId=function(a){return(a=this._clusters.get(a))?a.displayId:null};f.getFeatureDisplayIdsForAggregate=function(a){return(a=this._clusters.get(a))?
this._tree.getRegionDisplayIds(a.geohashBoundsInfo):[]};f.getDisplayIdForReferenceId=function(a){for(const b of this._clusters.values())if(b?.referenceId===a)return b.displayId;return null};f.getAggregateValueRanges=function(){return this._aggregateValueRanges};f.forEach=function(a){this._clusters.forEach(b=>{b&&(b=b.toJSON(),b=O.FeatureSetReaderJSON.fromFeatures([b],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor(),b.next(),
a(b))})};f.forEachInBounds=function(a,b){};f.forEachBounds=function(a,b){const {hasM:c,hasZ:d}=this.geometryInfo;for(const e of a)a=B.getBoundsOptimizedGeometry(Z,e.readGeometry(),d,c),t.isNone(a)||b(a)};f.size=function(){let a=0;this.forEach(b=>a++);return a};f._rebuildTree=function(){this._bitsets.computed.clear();this._bitsets.inserted.clear();this._tree&&this._tree.clear()};f._remove=function(a){const b=a.getDisplayId(),c=a.getXHydrated(),d=a.getYHydrated(),e=this._geohashBuf[2*b],g=this._geohashBuf[2*
b+1];this._bitsets.inserted.has(b)&&(this._bitsets.inserted.unset(b),this._tree.removeCursor(a,c,d,e,g,this._geohashLevel))};f._update=function(a,b){const c=a.getDisplayId(),d=this._bitsets.inserted;b=b.isVisible(c);var e=d.has(c);b!==e&&(b?(b=a.getXHydrated(),e=a.getYHydrated(),this._setGeohash(c,b,e)&&(this._tree.insertCursor(a,c,b,e,this._geohashBuf[2*c],this._geohashBuf[2*c+1],this._geohashLevel),d.set(c))):this._remove(a))};f._setGeohash=function(a,b,c){if(this._bitsets.geohash.has(a))return!0;
const d=this._geohashBuf;if(this._spatialReference.isWebMercator)b=b/x.earth.radius*57.29577951308232,z.setGeohashBuf(d,a,57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-c/x.earth.radius))),b-360*Math.floor((b+180)/360),12);else{c=E.project({x:b,y:c},this._spatialReference,F.WGS84);if(!c)return!1;z.setGeohashBuf(d,a,c.y,c.x,12)}this._bitsets.geohash.set(a);return!0};f._getClustersForTile=function(a,b,c,d,e,g=!0){var h=2*c;c=Math.ceil(2**b.key.level*r.TILE_SIZE/h)+1;var k=Math.ceil(this._schema.params.clusterPixelBuffer/
h)+0,l=Math.ceil(r.TILE_SIZE/h);const {row:m,col:y}=b.key;var n=Math.floor(y*r.TILE_SIZE/h)-k;h=Math.floor(m*r.TILE_SIZE/h)-k;const C=n+l+2*k;k=h+l+2*k;for(l=b.tileInfoView.getLODInfoAt(b.key.level);n<=C;n++)for(let A=h;A<=k;A++){var q=n;l.wrap&&(q=0>n?n+c:n%c);const H=l.wrap&&0>n,aa=l.wrap&&n%c!==n;q=this._lookupCluster(d,l,b.key.level,q,A,b);if(t.isSome(q)){var v=t.applySome(e,u=>H?u.left:aa?u.right:u.tile);if((!g||!t.isNone(v))&&q.count&&t.isSome(v)&&g){const u=q.geometry.clone();let Q=q.attributes;
u.coords[0]=B.quantizeX(v,u.coords[0]);u.coords[1]=B.quantizeY(v,u.coords[1]);1===q.count&&t.isSome(q.referenceId)&&(Q={...q.attributes,referenceId:q.referenceId});v=new L.OptimizedFeature(u,Q);v.displayId=q.displayId;a.push(v)}}}};f._getGeohashLevel=function(a){return Math.min(Math.ceil(a/2+2),12)};f._setGeohashLevel=function(a){a=this._getGeohashLevel(a);a=1*(Math.floor(a/1)+1)-1;this._geohashLevel!==a&&(this._geohashLevel=a,this._rebuildTree(),this._bitsets.geohash.clear())};f._getTransforms=function(a,
b){const c={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};b=U.getInfo(b);if(!b)return{tile:c,left:null,right:null};const [d,e]=b.valid;return{tile:c,left:{...c,translate:[e,a.bounds[3]]},right:{...c,translate:[d-e+a.bounds[0],a.bounds[3]]}}};f._getClusterId=function(a,b,c){return(a&15)<<28|(b&16383)<<14|c&16383};f._markForDeletion=function(a,b,c){a=this._getClusterId(a,b,c);this._clusters.delete(a)};f._getClusterBounds=function(a,b,c){var d=this._schema.params.clusterRadius,
e=2*d;b=c%2?b*e:b*e-d;const g=c*e;d=b+e;c=2**a.level*r.TILE_SIZE;a.wrap&&0>b&&(b=0);a.wrap&&d>c&&(d=c);c=g/r.TILE_SIZE;d/=r.TILE_SIZE;e=(g-e)/r.TILE_SIZE;b=a.getXForColumn(b/r.TILE_SIZE);c=a.getYForRow(c);d=a.getXForColumn(d);a=a.getYForRow(e);return[b,c,d,a]};f._getGeohash=function(a,b,c){const d={geohashX:0,geohashY:0};z.setGeohashXY(d,b,a,c);return d};f._getGeohashBounds=function(a,b){const c=this._getGeohashLevel(a.key.level);if(this._spatialReference.isWebMercator){const [l,m,y,n]=b;var d=m,
e=y,g=n,h=a=b=0,k=0;b=l/x.earth.radius*57.29577951308232;b-=360*Math.floor((b+180)/360);a=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-d/x.earth.radius)));h=e/x.earth.radius*57.29577951308232;h-=360*Math.floor((h+180)/360);k=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-g/x.earth.radius)));g={geohashX:0,geohashY:0};d={geohashX:0,geohashY:0};z.setGeohashXY(g,a,b,c);z.setGeohashXY(d,k,h,c);return{bounds:[l,m,y,n],geohashBounds:{xLL:g.geohashX,yLL:g.geohashY,xTR:d.geohashX,yTR:d.geohashY},
level:c}}g=X.fromExtent(Y.fromBounds(b,this._spatialReference));a=E.project(g,this._spatialReference,F.WGS84,{densificationStep:64*a.resolution});if(!a)return null;a=B.convertFromPolygon(new M,a,!1,!1);h=a.coords.filter((l,m)=>!(m%2));k=a.coords.filter((l,m)=>m%2);a=Math.min(...h);g=Math.min(...k);h=Math.max(...h);k=Math.max(...k);a=this._getGeohash(a,g,c);g=this._getGeohash(h,k,c);return{bounds:b,geohashBounds:{xLL:a.geohashX,yLL:a.geohashY,xTR:g.geohashX,yTR:g.geohashY},level:c}};f._lookupCluster=
function(a,b,c,d,e,g){const h=this._getClusterId(c,d,e),k=this._clusters.get(h);b=this._getClusterBounds(b,d,e);g=this._getGeohashBounds(g,b);if(t.isNone(g))return null;var l=this._tree.getRegionStatistics(g);const {count:m,xTotal:y,yTotal:n,referenceId:C}=l;d=m?y/m:0;e=m?n/m:0;if(0===m)return this._clusters.set(h,null),null;l={cluster_count:m,...l.attributes};a=t.isSome(k)?k.update(d,e,c,l,g,C):P.create(a,h,d,e,c,l,g,C);if(0===m){const [q,v,A,H]=b;a.geometry.coords[0]=(q+A)/2;a.geometry.coords[1]=
(v+H)/2}this._clusters.set(h,a);this._updateAggregateValueRangeForCluster(a,a.tileLevel);return a};f._updateAggregateValueRangeForCluster=function(a,b){const c=this._aggregateValueRanges[b]||{minValue:Infinity,maxValue:0},d=c.minValue,e=c.maxValue;c.minValue=Math.min(d,a.count);c.maxValue=Math.max(e,a.count);this._aggregateValueRanges[b]=c;if(d!==c.minValue||e!==c.maxValue)this._aggregateValueRangesChanged=!0};f._markTileClustersForDeletion=function(a,b){var c=2*b;b=Math.ceil(r.TILE_SIZE/c);const {row:d,
col:e}=a.key,g=Math.floor(e*r.TILE_SIZE/c);c=Math.floor(d*r.TILE_SIZE/c);for(let h=g;h<g+b;h++)for(let k=c;k<c+b;k++)this._markForDeletion(a.key.level,h,k)};w._createClass(p,[{key:"featureSpatialReference",get:function(){return this._spatialReference}},{key:"fields",get:function(){return this._fields}}]);return p}(W.Store2D);D.ClusterInfo=P;D.ClusterStore=I;Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});