// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Graphic ../../../../request ../../../../core/HandleOwner ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Extent ../../../../layers/support/rasterFunctions/rasterProjectionHelper ../../../../layers/support/rasterFunctions/vectorFieldUtils ../../engine/imagery/RasterVFContainer ./ImageryVFStrategy".split(" "),
function(n,g,v,w,c,m,r,k,F,G,H,x,y,z,t,A,B){c=function(d){function l(){var a=C.apply(this,arguments);a.attached=!1;a.container=new A.RasterVFContainer;a.type="imageryVF";a._dataParameters={exportParametersVersion:0,bbox:"",symbolTileSize:0,time:""};a._fetchpixels=async(e,b,p,f)=>{const q=await a._projectFullExtentPromise,{symbolTileSize:u}=a.layer.renderer,{extent:h,width:D,height:E}=t.snapImageToSymbolTile(e,b,p,u,q);if(m.isSome(q)&&!q.intersects(e))return{extent:h,pixelBlock:null};e={bbox:`${h.xmin}, ${h.ymin}, ${h.xmax}, ${h.ymax}`,
exportParametersVersion:a.layer.exportImageServiceParameters.version,symbolTileSize:u,time:JSON.stringify(a.timeExtent||"")};if(a._canReuseVectorFieldData(e)&&(b=a.getPixelData(),m.isSome(b)&&`${b.extent.xmin}, ${b.extent.ymin}, ${b.extent.xmax}, ${b.extent.ymax}`===e.bbox))return b;({pixelData:f}=await a.layer.fetchImage(h,D,E,{timeExtent:a.timeExtent,requestAsImageElement:!1,signal:f}));a._dataParameters=e;f=f?.pixelBlock;if(m.isNone(f))return{extent:h,pixelBlock:null};f="vector-uv"===a.layer.rasterInfo.dataType?
m.unwrap(t.convertVectorFieldData(f,"vector-uv")):f;return{extent:h,pixelBlock:f}};return a}n._inherits(l,d);var C=n._createSuper(l);d=l.prototype;d.attach=function(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference);this._strategy=new B({container:this.container,fetchPixels:this._fetchpixels});this.handles.add(r.watch(()=>this.layer.renderer,a=>this._updateSymbolizerParams(a),r.syncAndInitial),"attach")};d.detach=function(){this._strategy.destroy();this.container.children.forEach(a=>
a.destroy());this.container.removeAllChildren();this.handles.remove("attach");this._strategy=this.container=this._projectFullExtentPromise=null};d.getPixelData=function(){const a=this.container.children[0]?.rawPixelData;if(this.updating||!a)return null;const {extent:e,pixelBlock:b}=a;return{extent:e,pixelBlock:b}};d.hitTest=function(a){return new v({attributes:{},geometry:a.clone(),layer:this.layer})};d.update=function(a){this._strategy.update(a,this._symbolizerParams)};d.redraw=function(){const {renderer:a}=
this.layer;a&&(this._updateSymbolizerParams(a),this._strategy.redraw(this._symbolizerParams))};d._canReuseVectorFieldData=function(a){const e=this._dataParameters.time===a.time,b=this._dataParameters.symbolTileSize===a.symbolTileSize,p=this._dataParameters.bbox===a.bbox;return this._dataParameters.exportParametersVersion===a.exportParametersVersion&&e&&b&&p};d._getProjectedFullExtent=async function(a){try{return await z.projectExtent(this.layer.fullExtent,a)}catch(e){try{const b=(await w(this.layer.url,
{query:{option:"footprints",outSR:a.wkid||JSON.stringify(a.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return b?y.fromJSON(b):null}catch{return null}}};d._updateSymbolizerParams=function(a){"vector-field"===a.type&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))};n._createClass(l,[{key:"updating",get:function(){return!this.attached||this._strategy.updating}}]);return l}(c.HandleOwner);g.__decorate([k.property()],c.prototype,
"attached",void 0);g.__decorate([k.property()],c.prototype,"container",void 0);g.__decorate([k.property()],c.prototype,"layer",void 0);g.__decorate([k.property()],c.prototype,"timeExtent",void 0);g.__decorate([k.property()],c.prototype,"type",void 0);g.__decorate([k.property()],c.prototype,"view",void 0);g.__decorate([k.property()],c.prototype,"updating",null);return c=g.__decorate([x.subclass("esri.views.2d.layers.imagery.VectorFieldView2D")],c)});