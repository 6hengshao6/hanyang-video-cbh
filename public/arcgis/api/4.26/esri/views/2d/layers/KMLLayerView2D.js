// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../kernel ../../../core/Collection ../../../core/maybe ../../../core/reactiveUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/projection ../../../geometry/SpatialReference ../../../layers/support/kmlUtils ../../../rest/utils ../../../support/GraphicsCollection ../engine/Bitmap ../engine/BitmapContainer ./LayerView2D ./graphics/GraphicContainer ./graphics/GraphicsView2D ../../layers/LayerView ../../support/imageReprojection".split(" "),
function(q,n,F,G,l,H,v,r,m,Q,R,I,A,w,B,p,J,x,K,L,M,y,z,N,O){let C=q._createClass(function(){this.allSublayers=new Map;this.allPoints=[];this.allPolylines=[];this.allPolygons=[];this.allMapImages=[]});m=function(d){function t(){var a=P.apply(this,arguments);a._bitmapIndex=new Map;a._mapImageContainer=new L.BitmapContainer;a._kmlVisualData=new C;a._fetchController=null;a.allVisiblePoints=new x.GraphicsCollection;a.allVisiblePolylines=new x.GraphicsCollection;a.allVisiblePolygons=new x.GraphicsCollection;
a.allVisibleMapImages=new G;return a}q._inherits(t,d);var P=q._createSuper(t);d=t.prototype;d.hitTest=async function(a,b){const e=this.layer;return[this._pointsView?.hitTest(a),this._polylinesView?.hitTest(a),this._polygonsView?.hitTest(a)].flat().filter(Boolean).map(g=>{g.layer=e;g.sourceLayer=e;return{type:"graphic",graphic:g,layer:e,mapPoint:a}})};d.update=function(a){this._polygonsView&&this._polygonsView.processUpdate(a);this._polylinesView&&this._polylinesView.processUpdate(a);this._pointsView&&
this._pointsView.processUpdate(a)};d.attach=function(){this._fetchController=new AbortController;this.container.addChild(this._mapImageContainer);this._polygonsView=new z({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new y(this.view.featuresTilingScheme)});this.container.addChild(this._polygonsView.container);this._polylinesView=new z({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new y(this.view.featuresTilingScheme)});
this.container.addChild(this._polylinesView.container);this._pointsView=new z({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new y(this.view.featuresTilingScheme)});this.container.addChild(this._pointsView.container);this.addAttachHandles([this.allVisibleMapImages.on("change",a=>{a.added.forEach(b=>this._addMapImage(b));a.removed.forEach(b=>this._removeMapImage(b))}),H.watch(()=>this.layer.visibleSublayers,a=>{for(const [,b]of this._kmlVisualData.allSublayers)b.visibility=
0;for(const b of a)if(a=this._kmlVisualData.allSublayers.get(b.id))a.visibility=1;this._refreshCollections()})]);this.updatingHandles.addPromise(this._fetchService(this._fetchController.signal));this._imageReprojector=new O.ImageReprojector};d.detach=function(){this._fetchController=l.abortMaybe(this._fetchController);this._mapImageContainer.removeAllChildren();this.container.removeAllChildren();this._bitmapIndex.clear();this._polygonsView=l.destroyMaybe(this._polygonsView);this._polylinesView=l.destroyMaybe(this._polylinesView);
this._pointsView=l.destroyMaybe(this._pointsView);this._imageReprojector=l.destroyMaybe(this._imageReprojector)};d.moveStart=function(){};d.viewChange=function(){this._polygonsView.viewChange();this._polylinesView.viewChange();this._pointsView.viewChange()};d.moveEnd=function(){};d.isUpdating=function(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating};d._addMapImage=function(a){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&
this._imageReprojector.loadAndReprojectBitmapData(a.href,A.fromJSON(a.extent),this.view.spatialReference).then(b=>{const e=new K.Bitmap(b.bitmapData,{immutable:!1,requestRenderOnSourceChangedEnabled:!0});e.x=b.extent.xmin;e.y=b.extent.ymax;e.resolution=b.extent.width/b.bitmapData.width;e.rotation=a.rotation;this._mapImageContainer.addChild(e);this._bitmapIndex.set(a,e)})};d._getViewDependentUrl=async function(a,b){const {viewFormat:e,viewBoundScale:g,httpQuery:f}=a;if(l.isSome(e)){if(l.isNone(b))throw Error("Loading this network link requires a view state.");
await w.load();if(l.isSome(g)&&1!==g){var c=new A(b.extent);c.expand(g)}else c=b.extent;c=w.project(c,B.WGS84);var k=w.project(c,B.WebMercator);k=Math.max(k.width,k.height);const u={"[bboxWest]":c.xmin.toString(),"[bboxEast]":c.xmax.toString(),"[bboxSouth]":c.ymin.toString(),"[bboxNorth]":c.ymax.toString(),"[lookatLon]":c.center.x.toString(),"[lookatLat]":c.center.y.toString(),"[lookatRange]":k.toString(),"[lookatTilt]":"0","[lookatHeading]":b.rotation.toString(),"[lookatTerrainLon]":c.center.x.toString(),
"[lookatTerrainLat]":c.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":c.center.x.toString(),"[cameraLat]":c.center.y.toString(),"[cameraAlt]":k.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":(b.size[0]*b.pixelRatio).toString(),"[vertPixels]":(b.size[1]*b.pixelRatio).toString(),"[terrainEnabled]":"0","[clientVersion]":F.version,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"};k=h=>{for(const D in h)for(const E in u)h[D]=h[D].replace(E,
u[E])};b=v.queryToObject(e);k(b);c={};l.isSome(f)&&(c=v.queryToObject(f),k(c));a=J.parseUrl(a.href);a.query={...a.query,...b,...c};return`${a.path}?${v.objectToQuery(b)}`}return a.href};d._fetchService=async function(a){const b=new C;await this._loadVisualData(this.layer.url,b,a);this._kmlVisualData=b;this._refreshCollections()};d._refreshCollections=function(){this.allVisiblePoints.removeAll();this.allVisiblePolylines.removeAll();this.allVisiblePolygons.removeAll();this.allVisibleMapImages.removeAll();
this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>a));this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(a=>this._isSublayerVisible(a.sublayerId)).map(({item:a})=>
a))};d._isSublayerVisible=function(a){a=this._kmlVisualData.allSublayers.get(a);return a?.visibility?-1===a.parentFolderId?!0:this._isSublayerVisible(a.parentFolderId):!1};d._loadVisualData=function(a,b,e){return this._fetchParsedKML(a,e).then(async g=>{for(const f of g.sublayers){b.allSublayers.set(f.id,f);g=f.points?await p.getGraphics(f.points):[];const c=f.polylines?await p.getGraphics(f.polylines):[],k=f.polygons?await p.getGraphics(f.polygons):[],u=f.mapImages||[];b.allPoints.push(...g.map(h=>
({item:h,sublayerId:f.id})));b.allPolylines.push(...c.map(h=>({item:h,sublayerId:f.id})));b.allPolygons.push(...k.map(h=>({item:h,sublayerId:f.id})));b.allMapImages.push(...u.map(h=>({item:h,sublayerId:f.id})));f.networkLink&&(g=await this._getViewDependentUrl(f.networkLink,this.view.state),await this._loadVisualData(g,b,e))}})};d._fetchParsedKML=function(a,b){return p.fetchService(a,this.layer.spatialReference,this.layer.refreshInterval,b).then(e=>p.parseKML(e.data))};d._removeMapImage=function(a){const b=
this._bitmapIndex.get(a);b&&(this._mapImageContainer.removeChild(b),this._bitmapIndex.delete(a))};return q._createClass(t)}(M.LayerView2DMixin(N));n.__decorate([r.property()],m.prototype,"_pointsView",void 0);n.__decorate([r.property()],m.prototype,"_polylinesView",void 0);n.__decorate([r.property()],m.prototype,"_polygonsView",void 0);n.__decorate([r.property()],m.prototype,"updating",void 0);return m=n.__decorate([I.subclass("esri.views.2d.layers.KMLLayerView2D")],m)});