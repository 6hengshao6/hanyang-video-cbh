// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../request ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../controllers/support/sourceAdapters ./DataTileSource ../../../../support/QueueProcessor".split(" "),function(q,g,u,v,l,w,k,m,x,p,r){p=function(e){function h(a){var b=y.call(this,a);b.type="feature";b.mode="on-demand";b._adapter=x.createSourceAdapter(a.serviceInfo);b._queue=new r.QueueProcessor({concurrency:8,
process:async c=>{m.throwIfAborted(c);if(k.isSome(c.tile)){var d=c.tile.key.id,{signal:f}=c;d=l("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:c.depth}:void 0;f=await b._adapter.executeQuery(c.query,{signal:f,query:{...d,...b._schema?.customParameters}});f.level=c.tile.key.level;return f}return b._adapter.executeQuery(c.query,{...c,query:b._schema?.customParameters})}});b._patchQueue=new r.QueueProcessor({concurrency:8,process:async c=>{m.throwIfAborted(c);if(k.isSome(c.tile)){var d=c.tile.key.id,
{signal:f}=c;d=l("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:c.depth}:void 0;f=await b._adapter.executeQuery(c.query,{signal:f,query:{...d,...b._schema?.customParameters}});f.level=c.tile.key.level;return f}return b._adapter.executeQuery(c.query,{...c,query:b._schema?.customParameters})}});return b}g._inherits(h,e);var y=g._createSuper(h);e=h.prototype;e.destroy=function(){g._get(g._getPrototypeOf(h.prototype),"destroy",this).call(this);this._adapter.destroy();this._queue.destroy();this._patchQueue.destroy()};
e.enqueueQuery=function(a,b){return this.updatingHandles.addPromise(this._queue.push(a,b))};e.enqueuePatchQuery=function(a,b){return this.updatingHandles.addPromise(this._patchQueue.push(a,b))};e.enableEvent=function(a,b){};e.subscribe=function(a,b){g._get(g._getPrototypeOf(h.prototype),"subscribe",this).call(this,a,b);this._fetchDataTile(a).catch(c=>{m.isAbortError(c)||w.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new v("mapview-query-error","Encountered error when fetching tile",
{tile:a,error:c}))})};e.unsubscribe=function(a){g._get(g._getPrototypeOf(h.prototype),"unsubscribe",this).call(this,a)};e.readers=function(a){return this._subscriptions.get(a).readers()};e.query=async function(a,b={}){return this._adapter.executeQuery(a,{...b,query:{...(b.query??{}),...this._schema?.customParameters}})};e.queryLastEditDate=async function(){const a=this._serviceInfo.source;return(await u(a.path,{query:{...a.query,f:"json"},responseType:"json"})).data.editingInfo.lastEditDate};e.createTileQuery=
function(a,b={}){const c=this._serviceInfo.geometryType,d=this.createQuery(b);d.quantizationParameters=b.quantizationParameters??a.getQuantizationParameters();d.resultType="tile";d.geometry=a.extent;if(this._serviceInfo.capabilities.query.supportsQuantization)"esriGeometryPolyline"===c&&(d.maxAllowableOffset=a.resolution*l("feature-polyline-generalization-factor"));else if("esriGeometryPolyline"===c||"esriGeometryPolygon"===c)d.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===c&&(d.maxAllowableOffset*=
l("feature-polyline-generalization-factor"));a=this._serviceInfo.capabilities.query;d.defaultSpatialReferenceEnabled=a.supportsDefaultSpatialReference;d.compactGeometryEnabled=a.supportsCompactGeometry;return d};e._executePatchQuery=async function(a,b,c,d){b=b.clone();b.outFields=[this._serviceInfo.objectIdField,...c];b.returnCentroid=!1;b.returnGeometry=!1;c=k.isSome(b.start)?b.start/8E3:0;return await this.enqueuePatchQuery({tile:a,query:b,signal:d.signal,depth:c})};e._resend=async function(a,b){const {query:c,
message:d}=a,f=k.isSome(c.outFields)?c.outFields:[];a=this._queryInfo.outFields;const t=a.filter(n=>!f.includes(n));if(k.isNone(d.addOrUpdate))this._onMessage({...d,type:"append"});else if(t.length)try{const n=this._subscriptions.get(d.id).tile,z=await this._executePatchQuery(n,c,t,b);m.throwIfAborted(b);c.outFields=a;d.addOrUpdate.joinAttributes(z);this._onMessage({...d,end:d.end,type:"append"})}catch(n){}else this._onMessage({...d,type:"append"})};e._resendSubscription=async function(a){l("esri-2d-update-debug")&&
console.debug(a.tile.id,"Resend Subscription");if(a.empty)return this._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const b=a.signal;for(const c of a.requests.done)await this._resend(c,{signal:b});if(k.isSome(a.edits))return this._onMessage(a.edits)};e.resend=async function(){const a=Array.from(this._subscriptions.values());await Promise.all(a.map(b=>this._resendSubscription(b)))};g._createClass(h,[{key:"maxRecordCountFactor",get:function(){const {query:a}=this._serviceInfo.capabilities;
return a.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){var {query:a}=this._serviceInfo.capabilities;a=a.maxRecordCount??8E3;const b=k.unwrapOr(this.maxRecordCountFactor,1);return a*b}},{key:"pageSize",get:function(){return Math.min(8E3,this.maxPageSize)}}]);return h}(p.DataTileSource);q.BaseFeatureSource=p;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});