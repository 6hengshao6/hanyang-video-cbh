// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/has ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../viewStateUtils ../../engine/Bitmap ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),
function(A,k,h,L,n,l,M,N,E,B,F,G,D,H,I,J){const q=B.create(),p=[0,0],y=new J(0,0,0,0);h=function(r){function u(g){var a=K.call(this,g);a._imagePromise=null;a.bitmaps=[];a.hidpi=!1;a.imageMaxWidth=2048;a.imageMaxHeight=2048;a.imageRotationSupported=!1;a.imageNormalizationSupported=!1;a.update=n.debounce(async(d,e)=>{n.throwIfAborted(e);if(d.stationary&&!a.destroyed){var b=d.state,f=F.getInfo(b.spatialReference);d=a.hidpi?d.pixelRatio:1;var c=a.imageNormalizationSupported&&b.worldScreenWidth&&b.worldScreenWidth<
b.size[0],v=a.imageMaxWidth??0,w=a.imageMaxHeight??0;c?(p[0]=b.worldScreenWidth,p[1]=b.size[1]):a.imageRotationSupported?(p[0]=b.size[0],p[1]=b.size[1]):D.getOuterSize(p,b);f=f&&(b.extent.xmin<f.valid[0]||b.extent.xmax>f.valid[1]);var x=!a.imageNormalizationSupported&&f,z=!(Math.floor(p[0]*d)>v||Math.floor(p[1]*d)>w)&&!x,C=a.imageRotationSupported?b.rotation:0;f=a.container.children.slice();z?(c=c?b.paddedViewState.center:b.center,a._imagePromise&&console.error("Image promise was not defined!"),a._imagePromise=
a._singleExport(b,p,c,b.resolution,C,d,e)):(c=Math.min(v,w),x&&(c=Math.min(b.worldScreenWidth,c)),a._imagePromise=a._tiledExport(b,c,d,e));try{const m=await a._imagePromise??[];n.throwIfAborted(e);e=[];a._imagePromise=null;if(!a.destroyed){a.bitmaps=m;for(const t of f)m.includes(t)||e.push(t.fadeOut().then(()=>{t.remove();t.destroy()}));for(const t of m)e.push(t.fadeIn());await Promise.all(e)}}catch(m){a._imagePromise=null,n.throwIfAbortError(m)}}},5E3);a.updateExports=n.debounce(async d=>{const e=
[];for(const b of a.container.children){if(!b.visible||!b.stage)return;e.push(d(b).then(()=>{b.invalidateTexture();b.requestRender()}))}a._imagePromise=n.eachAlways(e).then(()=>a._imagePromise=null);await a._imagePromise});return a}A._inherits(u,r);var K=A._createSuper(u);r=u.prototype;r.destroy=function(){this.bitmaps.forEach(g=>g.destroy());this.bitmaps=[]};r._export=async function(g,a,d,e,b,f){d=await this.fetchSource(g,Math.floor(a*b),Math.floor(d*b),{rotation:e,pixelRatio:b,signal:f});n.throwIfAborted(f);
const c=new H.Bitmap(null,{immutable:!0,requestRenderOnSourceChangedEnabled:!0});c.x=g.xmin;c.y=g.ymax;c.resolution=g.width/a;c.rotation=e;c.pixelRatio=b;c.opacity=0;this.container.addChild(c);await c.setSourceAsync(d,f);n.throwIfAborted(f);return c};r._singleExport=async function(g,a,d,e,b,f,c){D.getBBox(q,d,e,a);g=B.toExtent(q,g.spatialReference);return[await this._export(g,a[0],a[1],b,f,c)]};r._tiledExport=function(g,a,d,e){var b=G.create({size:a,spatialReference:g.spatialReference,scales:[g.scale]});
const f=new I(b);b=f.getTileCoverage(g);if(!b)return null;const c=[];b.forEach((v,w,x,z)=>{y.set(v,w,x,0);f.getTileBounds(q,y);const C=B.toExtent(q,g.spatialReference);c.push(this._export(C,a,a,0,d,e).then(m=>{0!==z&&(y.set(v,w,x,z),f.getTileBounds(q,y),m.x=q[0],m.y=q[3]);return m}))});return Promise.all(c)};A._createClass(u,[{key:"updating",get:function(){return!this.destroyed&&null!==this._imagePromise}}]);return u}(h);k.__decorate([l.property()],h.prototype,"_imagePromise",void 0);k.__decorate([l.property()],
h.prototype,"bitmaps",void 0);k.__decorate([l.property()],h.prototype,"container",void 0);k.__decorate([l.property()],h.prototype,"fetchSource",void 0);k.__decorate([l.property()],h.prototype,"hidpi",void 0);k.__decorate([l.property()],h.prototype,"imageMaxWidth",void 0);k.__decorate([l.property()],h.prototype,"imageMaxHeight",void 0);k.__decorate([l.property()],h.prototype,"imageRotationSupported",void 0);k.__decorate([l.property()],h.prototype,"imageNormalizationSupported",void 0);k.__decorate([l.property()],
h.prototype,"requestUpdate",void 0);k.__decorate([l.property()],h.prototype,"updating",null);return h=k.__decorate([E.subclass("esri.views.2d.layers.support.ExportStrategy")],h)});