// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/pbf ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ./FeatureSetReader ./FeatureSetReaderPBFHeader".split(" "),function(H,x,N,O,y,P,I,Q,z,J,R){function K(b){if(b<=u.small.delta.length)return u.small;if(b<=u.large.delta.length)return u.large;
u.large.delta=new Int32Array(Math.round(1.25*b));u.large.decoded=new Int32Array(Math.round(1.25*b));return u.large}function S(b){var k=b.getLength();for(k=b.pos()+k;b.pos()<k&&b.next();)switch(b.tag()){case 1:return b.getString();case 2:return b.getFloat();case 3:return b.getDouble();case 4:return b.getSInt32();case 5:return b.getUInt32();case 6:return b.getInt64();case 7:return b.getUInt64();case 8:return b.getSInt64();case 9:return b.getBool();default:return b.skip(),null}return null}function G(b,
k,D,a){return 0===b*a-D*k&&0<b*D+k*a}const u={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128E3),decoded:new Int32Array(128E3)}};let U=function(b){function k(a,c,f,h){a=D.call(this,a,h);a._hasNext=!1;a._isPoints=!1;a._featureIndex=-1;a._featureOffset=0;a._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0};a._geometryType=h.geometryType;a._reader=c;a._header=f;a._hasNext=f.hasFeatures;a._isPoints=
"esriGeometryPoint"===h.geometryType;return a}x._inherits(k,b);var D=x._createSuper(k);k.fromBuffer=function(a,c,f=!1){var h=c.geometryType;a:{try{const d=new P(new Uint8Array(a),new DataView(a));for(;d.next();)switch(d.tag()){case 2:b:{for(var g=d.getMessage();g.next();)switch(g.tag()){case 1:var e=g.getMessage();break b;default:g.skip()}e=null}break a;default:d.skip()}}catch(d){a=new N("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:d}),O.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(a)}e=
null}a=e;f=R.parseHeader(a,"esriGeometryPoint"===h,f);h=J.FeatureSetReader.createInstance();return new k(h,a,f,c)};b=k.prototype;b.hasField=function(a){return this._header.hasField(a)||this._header.hasField(a.toLowerCase().trim())};b.getFieldNames=function(){return this._header.fields.map(a=>a.fieldName)};b.getSize=function(){return this._size};b.getQuantizationTransform=function(){return this._header.transform};b.getCursor=function(){return this.copy()};b.getIndex=function(){return this._featureIndex};
b.setIndex=function(a){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;this._featureIndex=a};b.getAttributeHash=function(){let a="";this._header.fields.forEach(({index:c})=>{a+=this._readAttributeAtIndex(c)+"."});return a};b.getObjectId=function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)};b.getDisplayId=function(){return this._header.displayIds[this._featureIndex]};
b.setDisplayId=function(a){this._header.displayIds[this._featureIndex]=a};b.getGroupId=function(){return this._header.groupIds[this._featureIndex]};b.setGroupId=function(a){this._header.groupIds[this._featureIndex]=a};b.readLegacyFeature=function(){if(void 0===this._cache.legacyFeature){var a=this.readCentroid();a={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:(a&&{x:a.coords[0],y:a.coords[1]})??null};return this._cache.legacyFeature=
a}return this._cache.legacyFeature};b.readOptimizedFeature=function(){if(void 0===this._cache.optFeature){const a=new Q.OptimizedFeature(this.readGeometry(),this.readAttributes(),this.readCentroid());a.objectId=this.getObjectId();a.displayId=this.getDisplayId();return this._cache.optFeature=a}return this._cache.optFeature};b.getXHydrated=function(){const a=this._header.centroid[2*this._featureIndex],c=this.getQuantizationTransform();return y.isNone(c)?a:a*c.scale[0]+c.translate[0]};b.getYHydrated=
function(){const a=this._header.centroid[2*this._featureIndex+1],c=this.getQuantizationTransform();return y.isNone(c)?a:c.translate[1]-a*c.scale[1]};b.getX=function(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx};b.getY=function(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty};b.readLegacyPointGeometry=function(){const a=this.getX(),c=this.getY();return{x:a,y:c}};b.readLegacyGeometry=function(a){a=this.readGeometry(a);return I.convertToGeometry(a,this.geometryType,
!1,!1)};b.readLegacyCentroid=function(){const a=this.readCentroid();if(!a)return null;const [c,f]=a.coords;return{x:c,y:f}};b.readGeometryArea=function(){this._cache.area||this.readGeometry(!0);return this._cache.area};b.readUnquantizedGeometry=function(a=!1){if(void 0===this._cache.unquantGeometry){a=this.readGeometry(a);if(!a)return this._cache.unquantGeometry=void 0,null;var c=K(a.coords.length).decoded;a=a.clone(c);c=a.coords;let f=0;for(const h of a.lengths){for(let g=1;g<h;g++){const e=2*(f+
g),d=2*(f+g-1);c[e]+=c[d];c[e+1]+=c[d+1]}f+=h}return this._cache.unquantGeometry=a}return this._cache.unquantGeometry};b.readHydratedGeometry=function(){if(this._isPoints){if(268435455===this._header.centroid[2*this._featureIndex])return null;var a=this.getXHydrated(),c=this.getYHydrated();return new z([],[a,c])}a=this.readGeometry();if(!a)return null;a=a.clone();c=this.getQuantizationTransform();y.isSome(c)&&I.unquantizeOptimizedGeometry(a,a,this.hasZ,this.hasM,c);return a};b.readGeometry=function(a=
!1){if(void 0===this._cache.geometry){var c=null;if(this._isPoints){if(268435455===this._header.centroid[2*this._featureIndex])return null;a=this.getX();c=this.getY();c=new z([],[a,c])}else{const f=this._header.offsets.geometry[this._featureIndex],h=this._reader;if(0===f){a=this._readServerCentroid();if(!a)return null;const [g,e]=a.coords;return this.createQuantizedExtrudedQuad(g,e)}h.move(f);try{if(c=a?this._parseGeometryForDisplay(h):this._parseGeometry(h),null===c){const g=this._readServerCentroid();
if(!g)return null;const [e,d]=g.coords;return this.createQuantizedExtrudedQuad(e,d)}}catch(g){return console.error("Failed to parse geometry!",g),null}}return this._cache.geometry=c}return this._cache.geometry};b.readCentroid=function(){if(void 0===this._cache.centroid){let a=void 0;(a=this._computeCentroid())||(a=this._readServerCentroid());this._cache.centroid=a??void 0;return a??null}return this._cache.centroid};b.copy=function(){var a=this._reader.clone();a=new k(this.instance,a,this._header,
this.fullSchema());this.copyInto(a);return a};b.next=function(){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;for(this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size};b._readAttribute=function(a,c){a=this._header.hasField(a)?a:a.toLowerCase().trim();var f=this._header.getFieldIndex(a);if(null!=f)return f=this._readAttributeAtIndex(f),
c&&null!=f?this._header.isDateField(a)?new Date(f):f:f};b._readAttributes=function(){const a={};this._header.fields.forEach(({fieldName:c,index:f})=>{a[c]=this._readAttributeAtIndex(f)});return a};b.copyInto=function(a){x._get(x._getPrototypeOf(k.prototype),"copyInto",this).call(this,a);a._featureIndex=this._featureIndex;a._featureOffset=this._featureOffset;a._hasNext=this._hasNext};b._readAttributeAtIndex=function(a){const c=this._reader;c.move(this._header.offsets.attributes[this._featureIndex*
this._header.fieldCount+a]);return S(c)};b._readServerCentroid=function(){const a=this._header.centroid[2*this._featureIndex]+this._tx;return 268435455===a?null:new z([],[a,this._header.centroid[2*this._featureIndex+1]+this._ty])};b._parseGeometry=function(a){a=a.asUnsafe();var c=a.getLength();c=a.pos()+c;const f=[],h=[];for(;a.pos()<c&&a.next();)switch(a.tag()){case 2:var g=a.getUInt32();for(g=a.pos()+g;a.pos()<g;)h.push(a.getUInt32());break;case 3:g=a.getUInt32();g=a.pos()+g;f.push(a.getSInt32()+
this._tx);f.push(a.getSInt32()+this._ty);this.hasZ&&a.getSInt32();for(this.hasM&&a.getSInt32();a.pos()<g;)f.push(a.getSInt32()),f.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break;default:a.skip()}return new z(h,f)};b._parseGeometryForDisplay=function(a){a=a.asUnsafe();var c=a.getLength();const f=a.pos()+c,h=[];c=[];let g=0,e=0;var d=null;let E=0;const T="esriGeometryPolygon"===this.geometryType;for(;a.pos()<f&&a.next();)switch(a.tag()){case 2:d=a.getUInt32();for(d=a.pos()+
d;a.pos()<d;){var F=a.getUInt32();h.push(F);g+=F}d=K(2*g).delta;break;case 3:a.getUInt32();F=2+(this.hasZ?1:0)+(this.hasM?1:0);y.assertIsSome(d);for(var q of h)if(e+F*q>d.length)for(var t=0;t<q;t++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(T){t=this.getAreaSimplificationThreshold(q,this._header.vertexCount);var v=2,r=1,p=a.getSInt32(),m=a.getSInt32();d[e++]=p;d[e++]=m;this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();var l=a.getSInt32(),n=a.getSInt32();
this.hasZ&&a.getSInt32();for(this.hasM&&a.getSInt32();v<q;){var w=a.getSInt32();let A=a.getSInt32();this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();const B=p+l,C=m+n,L=B+w,M=C+A;.5*Math.abs(p*C+B*M+L*m-p*M-B*m-L*C)>=t?(E+=-.5*(B-p)*(C+m),1<r&&G(d[e-2],d[e-1],l,n)?(d[e-2]+=l,d[e-1]+=n):(d[e++]=l,d[e++]=n,r++),p=B,m=C):(w+=l,A+=n);l=w;n=A;v++}3>r?e-=2*r:(E+=-.5*(p+l-p)*(m+n+m),G(d[e-2],d[e-1],l,n)?(d[e-2]+=l,d[e-1]+=n,c.push(r)):(d[e++]=l,d[e++]=n,c.push(++r)))}else{t=0;v=a.getSInt32();r=a.getSInt32();
this.hasZ&&a.getSInt32();this.hasM&&a.getSInt32();d[e++]=v;d[e++]=r;t+=1;for(p=1;p<q;p++)m=a.getSInt32(),l=a.getSInt32(),n=v+m,w=r+l,E+=-.5*(n-v)*(w+r),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),2<p&&G(d[e-2],d[e-1],m,l)?(d[e-2]+=m,d[e-1]+=l):(d[e++]=m,d[e++]=l,t+=1),v=n,r=w;c.push(t)}break;default:a.skip()}this._cache.area=E;if(!c.length)return null;if(this._tx||this._ty){q=0;y.assertIsSome(d);for(const A of c)d[2*q]+=this._tx,d[2*q+1]+=this._ty,q+=A}return new z(c,d)};x._createClass(k,[{key:"geometryType",
get:function(){return this._geometryType}},{key:"_size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}}]);return k}(J.FeatureSetReader);H.FeatureSetReaderPBF=
U;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});