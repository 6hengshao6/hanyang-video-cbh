// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/CircularArray ../../../../core/Evented ../../../../core/has ../../../../core/maybe ../../../../chunks/rbush ../../../../geometry/support/aaBoundingBox ./Store2D ./support/FeatureSetReaderPBFIndirect".split(" "),function(l,m,u,v,p,k,w,q,x,y){const r=q.create(),t={getObjectId(e){return e.getObjectId()},getAttributes(e){return e.readAttributes()},getAttribute(e,h){return e.readAttribute(h)},cloneWithGeometry(e,h){return e},
getGeometry(e){return e.readHydratedGeometry()},getCentroid(e,h){return e.readCentroid()}};p=function(e){function h(a,b,c){var d=z.call(this,a,b);d.featureAdapter=t;d.events=new v;d._featureSetsByInstance=new Map;d._objectIdToDisplayId=new Map;d._spatialIndexInvalid=!0;d._indexSearchCache=new u(50);d._index=w.rbush(9,f=>({minX:d._storage.getXMin(f),minY:d._storage.getYMin(f),maxX:d._storage.getXMax(f),maxY:d._storage.getYMax(f)}));d.mode=c;return d}m._inherits(h,e);var z=m._createSuper(h);e=h.prototype;
e.hasInstance=function(a){return this._featureSetsByInstance.has(a)};e.onTileData=function(a,b){if(k.isNone(b.addOrUpdate))return b;b.addOrUpdate.attachStorage(this._storage);if("snapshot"===this.mode){for(var c=b.addOrUpdate.getCursor();c.next();){const d=c.getDisplayId();this.setComputedAttributes(this._storage,c,d,a.scale)}return b}this._featureSetsByInstance.set(b.addOrUpdate.instance,b.addOrUpdate);for(c=b.addOrUpdate.getCursor();c.next();)this._insertFeature(c,a.scale);this._spatialIndexInvalid=
!0;this.events.emit("changed");return b};e.search=function(a){this._rebuildIndex();const b=a.id;var c=this._indexSearchCache.find(g=>g.tileId===b);if(k.isSome(c))return c.readers;c=new Map;a=this._searchIndex(a.bounds);const d=[];for(const g of a){var f=this._storage.getInstanceId(g);a=(4294901760&f)>>>16;f&=65535;c.has(a)||c.set(a,[]);c.get(a).push(f)}c.forEach((g,n)=>{n=this._featureSetsByInstance.get(n);d.push(y.FeatureSetReaderIndirect.from(n,g))});this._indexSearchCache.enqueue({tileId:b,readers:d});
return d};e.insert=function(a){const b=a.getCursor(),c=this._storage;for(;b.next();){var d=b.getIndex();d|=b.instance<<16;const f=b.getObjectId(),g=this._objectIdToDisplayId.get(f)??this._storage.createDisplayId();b.setDisplayId(g);c.setInstanceId(g,d);this._objectIdToDisplayId.set(f,g)}this._featureSetsByInstance.set(a.instance,a);this._spatialIndexInvalid=!0};e.remove=function(a){const b=this._objectIdToDisplayId.get(a);if(b){var c=this._storage.getInstanceId(b),d=65535&c;c=(4294901760&c)>>>16;
var f=this._featureSetsByInstance.get(c);this._objectIdToDisplayId.delete(a);this._storage.releaseDisplayId(b);f.removeAtIndex(d);f.isEmpty&&this._featureSetsByInstance.delete(c);this._spatialIndexInvalid=!0}};e.forEach=function(a){this._objectIdToDisplayId.forEach(b=>{b=this._storage.getInstanceId(b);b=this._lookupFeature(b);a(b)})};e.forEachUnsafe=function(a){this._objectIdToDisplayId.forEach(b=>{var c=this._storage.getInstanceId(b);b=65535&c;c=this._getFeatureSet((4294901760&c)>>>16);c.setIndex(b);
a(c)})};e.forEachInBounds=function(a,b){a=this._searchIndex(a);for(const c of a)a=this.lookupFeatureByDisplayId(c,this._storage),b(k.unwrap(a))};e.forEachBounds=function(a,b){this._rebuildIndex();for(const c of a)c.readGeometry()&&(a=c.getDisplayId(),q.fromRectValues(r,this._storage.getXMin(a),this._storage.getYMin(a),this._storage.getXMax(a),this._storage.getYMax(a)),b(r))};e.sweepFeatures=function(a,b,c){this._spatialIndexInvalid=!0;this._objectIdToDisplayId.forEach((d,f)=>{a.has(d)||(b.releaseDisplayId(d),
c&&c.unsetAttributeData(d),this._objectIdToDisplayId.delete(f))});this.events.emit("changed")};e.sweepFeatureSets=function(a){this._spatialIndexInvalid=!0;this._featureSetsByInstance.forEach((b,c)=>{a.has(c)||this._featureSetsByInstance.delete(c)})};e.lookupObjectId=function(a,b){a=this.lookupFeatureByDisplayId(a,b);return k.isNone(a)?null:a.getObjectId()};e.lookupDisplayId=function(a){return this._objectIdToDisplayId.get(a)};e.lookupFeatureByDisplayId=function(a,b){a=b.getInstanceId(a);return this._lookupFeature(a)};
e.lookupByDisplayIdUnsafe=function(a){var b=this._storage.getInstanceId(a);a=65535&b;b=this._getFeatureSet((4294901760&b)>>>16);if(!b)return null;b.setIndex(a);return b};e._insertFeature=function(a,b){const c=this._storage,d=a.getObjectId();var f=a.getIndex();f|=a.instance<<16;c.getInstanceId(a.getDisplayId());let g=this._objectIdToDisplayId.get(d);g||(g=c.createDisplayId(),this._objectIdToDisplayId.set(d,g),this._spatialIndexInvalid=!0);a.setDisplayId(g);c.setInstanceId(g,f);this.setComputedAttributes(c,
a,g,b)};e._searchIndex=function(a){this._rebuildIndex();return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})};e._rebuildIndex=function(){if(this._spatialIndexInvalid){var a=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(b=>{for(b=b.getCursor();b.next();){const c=b.getDisplayId();this._storage.setBounds(c,b)&&a.push(c)}}):this._objectIdToDisplayId.forEach(b=>{const c=this._storage.getInstanceId(b);this._storage.setBounds(b,this._lookupFeature(c))&&a.push(b)});this._index.clear();
this._index.load(a);this._indexSearchCache.clear();this._spatialIndexInvalid=!1}};e._lookupFeature=function(a){var b=this._getFeatureSet((4294901760&a)>>>16);if(b)return b=b.getCursor(),b.setIndex(65535&a),b};e._getFeatureSet=function(a){return this._featureSetsByInstance.get(a)};m._createClass(h,[{key:"storeStatistics",get:function(){let a=0,b=0,c=0;this.forEach(d=>{if(d=d.readGeometry())b+=d.isPoint?1:d.lengths.reduce((f,g)=>f+g,0),c+=d.isPoint?1:d.lengths.length,a+=1});return{featureCount:a,vertexCount:b,
ringCount:c}}}]);return h}(x.Store2D);l.FeatureStore2D=p;l.featureAdapter=t;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});