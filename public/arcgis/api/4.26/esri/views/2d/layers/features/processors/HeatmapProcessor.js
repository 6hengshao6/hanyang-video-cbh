// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/maybe ../../../../../core/Logger ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/Error ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/diffUtils ../../../../../renderers/support/heatmapUtils ../../../engine/webgl/definitions ./BaseProcessor ../support/tileUtils".split(" "),function(k,
x,l,m,F,G,H,I,y,z,A,B,C,f){function D(b){const d=b.key,e=new Map,a=B.TILE_SIZE;b=b.tileInfoView.tileInfo.isWrappable;e.set(f.getPow2NeighborKey(d,-1,-1,b).id,new g([-a,-a],[a-256,a-256,a,a]));e.set(f.getPow2NeighborKey(d,0,-1,b).id,new g([0,-a],[0,a-256,a,a]));e.set(f.getPow2NeighborKey(d,1,-1,b).id,new g([a,-a],[0,a-256,256,a]));e.set(f.getPow2NeighborKey(d,-1,0,b).id,new g([-a,0],[a-256,0,a,a]));e.set(f.getPow2NeighborKey(d,1,0,b).id,new g([a,0],[0,0,256,a]));e.set(f.getPow2NeighborKey(d,-1,1,b).id,
new g([-a,a],[a-256,0,a,256]));e.set(f.getPow2NeighborKey(d,0,1,b).id,new g([0,a],[0,0,a,256]));e.set(f.getPow2NeighborKey(d,1,1,b).id,new g([a,a],[0,0,256,256]));return e}let g=k._createClass(function(b,d){this.offset=b;this.extent=d});l=function(b){function d(){var a=e.apply(this,arguments);a.type="heatmap";a._tileKeyToFeatureSets=new Map;return a}k._inherits(d,b);var e=k._createSuper(d);b=d.prototype;b.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])};
b.update=async function(a,c){c=c.schema.processors[0];"heatmap"===c.type&&z.diff(this._schema,c)&&(a.mesh=!0,this._schema=c)};b.onTileUpdate=function(a){for(const c of a.removed)this._tileKeyToFeatureSets.delete(c.key.id)};b.onTileClear=function(a){this._tileKeyToFeatureSets.delete(a.key.id);return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:a.id,data:{clear:!0}})};b.onTileMessage=async function(a,c,n){this._tileKeyToFeatureSets.has(a.key.id)||this._tileKeyToFeatureSets.set(a.key.id,
new Map);const u=this._tileKeyToFeatureSets.get(a.key.id);u&&m.isSome(c.addOrUpdate)&&c.addOrUpdate.hasFeatures&&u.set(c.addOrUpdate.instance,c);if(c.end){const p=[],v=D(a);this._tileKeyToFeatureSets.forEach((w,h)=>{if(h===a.key.id)w.forEach(q=>m.applySome(q.addOrUpdate,r=>p.push(r)));else if(v.has(h)){h=v.get(h);const [q,r]=h.offset;w.forEach(E=>m.applySome(E.addOrUpdate,t=>{t=t.transform(q,r,1,1);p.push(t)}))}});c=A.calculateHeatmapIntensityInfoReaders(p,this._schema.mesh,512,512);return this.remoteClient.invoke("tileRenderer.onTileData",
{tileKey:a.key.id,intensityInfo:c},{...n,transferList:[c.matrix]})}};b.onTileError=function(a,c,n){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:a.id,error:c},n)};return k._createClass(d)}(C);return l=x.__decorate([y.subclass("esri.views.2d.layers.features.processors.HeatmapProcessor")],l)});