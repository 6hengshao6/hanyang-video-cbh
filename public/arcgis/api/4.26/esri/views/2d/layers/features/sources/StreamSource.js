// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/handleUtils ../../../../../core/has ../../../../../core/maybe ../../../../../chunks/rbush ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/createConnection ./DataTileSource ./StreamConnectionState ../support/FeatureSetReaderJSON ../support/UpdateToken".split(" "),
function(t,k,x,u,n,y,p,v,z,A,B,C,D,E){function F(c,d){const e=c.weakClone();if(n.isSome(c.geometry)){const a=p.quantizeX(d,c.geometry.coords[0]);c=p.quantizeY(d,c.geometry.coords[1]);e.geometry=new v([],[a,c])}return e}function G(c){switch(c){case "esriGeometryPoint":return F;default:return(d,e)=>{const a=d.weakClone(),b=new v;d=p.quantizeOptimizedGeometry(b,d.geometry,!1,!1,c,e,!1,!1);a.geometry=d;return a}}}function H(c){switch(c){case "esriGeometryPoint":return d=>n.isSome(d.geometry)?{minX:d.geometry.coords[0],
minY:d.geometry.coords[1],maxX:d.geometry.coords[0],maxY:d.geometry.coords[1]}:{minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};default:return d=>{let e=Infinity,a=Infinity,b=-Infinity,g=-Infinity;n.isSome(d.geometry)&&d.geometry.forEachVertex((f,h)=>{e=Math.min(e,f);a=Math.min(a,h);b=Math.max(b,f);g=Math.max(g,h)});return{minX:e,minY:a,maxX:b,maxY:g}}}}let I=function(){function c(e,a){this.onUpdate=e;this._geometryType=a;this._objectIdToFeature=new Map;this._index=null}var d=c.prototype;
d.add=function(e){this._objectIdToFeature.set(e.objectId,e);this._index=null};d.get=function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null};d.forEach=function(e){this._objectIdToFeature.forEach(e)};d.search=function(e){if(!this._index){var a=this._features;const b=y.rbush(9,H(this._geometryType));b.load(a);this._index=b}return this._index.search({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]})};d.clear=function(){this._index=null;this._objectIdToFeature.clear()};
d.removeById=function(e){const a=this._objectIdToFeature.get(e);return a?(this._objectIdToFeature.delete(e),this._index=null,a):null};d.update=function(e,a){this.onUpdate(e,a)};k._createClass(c,[{key:"_features",get:function(){const e=[];this._objectIdToFeature.forEach(a=>e.push(a));return e}},{key:"size",get:function(){return this._objectIdToFeature.size}}]);return c}();u=function(c){function d(a){var b=e.call(this,a);b.type="stream";b._updateIntervalId=0;b._level=0;b._updateInfo={websocket:0,client:0};
b._inUpdate=!1;var {outSR:g}=a;const {geometryType:f,objectIdField:h,timeInfo:r,purgeOptions:J,source:K,spatialReference:L,serviceFilter:M,maxReconnectionAttempts:N,maxReconnectionInterval:O,updateInterval:P,customParameters:Q,enabledEventTypes:R}=a.serviceInfo,w=new I(b._onUpdate.bind(k._assertThisInitialized(b)),f),S=new z.StreamFeatureManager(w,h,r,J);g=A.createConnection(K,L,g,f,M,N,O,Q??{});b._connectionState=new C.StreamConnectionState({connection:g});b._store=w;b._manager=S;b._connection=g;
b._quantize=G(f);b._enabledEventTypes=new Set(R);b._handlesGroup=x.handlesGroup([b._connection.on("data-received",l=>b._onFeature(l)),b._connection.on("message-received",l=>b._onWebSocketMessage(l))]);b._initUpdateInterval=()=>{let l=performance.now();b._updateIntervalId=setInterval(()=>{var q=performance.now(),m=q-l;2500<m&&(l=q,q=Math.round(b._updateInfo.client/(m/1E3)),m=Math.round(b._updateInfo.websocket/(m/1E3)),b._updateInfo.client=0,b._updateInfo.websocket=0,b.events.emit("updateRate",{client:q,
websocket:m}));a.canAcceptRequest()&&!b._inUpdate&&b._manager.checkForUpdates()},P)};b._initUpdateInterval();return b}k._inherits(d,c);var e=k._createSuper(d);c=d.prototype;c.destroy=function(){k._get(k._getPrototypeOf(d.prototype),"destroy",this).call(this);this._clearUpdateInterval();this._connection.destroy();this._handlesGroup?.remove()};c._fetchDataTile=function(){};c.updateCustomParameters=function(a){this._connection.updateCustomParameters(a)};c.pauseStream=function(){"paused"!==this._connectionState.connectionStatus&&
(this._connectionState.pause(),this._clearUpdateInterval())};c.resumeStream=function(){"paused"===this._connectionState.connectionStatus&&(this._connectionState.resume(),this._initUpdateInterval())};c.sendMessageToSocket=function(a){this._connection.sendMessageToSocket(a)};c.sendMessageToClient=function(a){this._connection.sendMessageToClient(a)};c.enableEvent=function(a,b){b?this._enabledEventTypes.add(a):this._enabledEventTypes.delete(a)};c.subscribe=function(a,b){k._get(k._getPrototypeOf(d.prototype),
"subscribe",this).call(this,a,b);b=this._subscriptions.get(a.id);b.resolve();this._level=a.level;const g=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:g,end:!0});b.didSend=!0};c.unsubscribe=function(a){k._get(k._getPrototypeOf(d.prototype),"unsubscribe",this).call(this,a)};c.readers=function*(a){a=this._subscriptions.get(a);({tile:a}=a);yield this._getTileFeatures(a)};c.createTileQuery=function(a){throw Error("Service does not support tile  queries");};c.resend=async function(){this._subscriptions.forEach(a=>
{({tile:a}=a);a={type:"append",id:a.id,addOrUpdate:this._getTileFeatures(a),end:!0};this._onMessage(a)})};c._getTileFeatures=function(a){const b=this._store.search(a).map(g=>this._quantize(g,a.transform));return D.FeatureSetReaderJSON.fromOptimizedFeatures(b,this._serviceInfo,a.transform)};c._onWebSocketMessage=function(a){this._enabledEventTypes.has("message-received")&&this.events.emit("message-received",a);if("type"in a)switch(a.type){case "delete":if(a.objectIds)for(const b of a.objectIds)this._manager.removeById(b);
if(a.trackIds)for(const b of a.trackIds)this._manager.removeByTrackId(b);break;case "clear":this._store.forEach(b=>this._manager.removeById(b.objectId))}};c._onFeature=function(a){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",a);const b=p.convertFromFeature(a,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(b)}catch(b){}};c._clearUpdateInterval=function(){clearInterval(this._updateIntervalId);
this._updateIntervalId=0};c._onUpdate=async function(a,b){this._inUpdate=!0;try{n.isSome(a)&&(this._updateInfo.client+=a.length);this._subscriptions.forEach((f,h)=>{f.didSend&&f.tile.level===this._level&&this._onMessage({type:"append",id:h,addOrUpdate:null,clear:!0,end:!1})});const g=[];this._subscriptions.forEach((f,h)=>{if(f.didSend&&f.tile.level===this._level){var r=this._getTileFeatures(f.tile);h={type:"append",id:h,addOrUpdate:r,remove:[],end:!1,status:E.UpdateToken.empty()};f.requests.stream.enqueue(h);
g.push(this._onMessage(h))}});await Promise.all(g);this._subscriptions.forEach((f,h)=>{f.didSend&&f.tile.level===this._level&&this._onMessage({type:"append",id:h,addOrUpdate:null,end:!0})})}catch{}this._inUpdate=!1};k._createClass(d,[{key:"connectionStatus",get:function(){return this._connectionState.connectionStatus}},{key:"errorString",get:function(){return this._connectionState.errorString}}]);return d}(B.DataTileSource);t.StreamSource=u;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});