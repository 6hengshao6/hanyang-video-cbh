// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/BidiText ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/accessorSupport/decorators/subclass ../../../../../core/accessorSupport/diffUtils ../../../../../geometry/SpatialReference ../../../engine/webgl/DisplayId ../../../engine/webgl/enums ../../../engine/webgl/mesh/MeshData ../../../engine/webgl/mesh/factories/WGLMeshFactory ../../../engine/webgl/mesh/templates/WGLTemplateStore ../../../engine/webgl/util/Matcher ../textUtils ./BaseProcessor ../support/ResourceManagerProxy".split(" "),
function(y,G,H,z,T,U,n,u,V,W,I,A,J,K,L,M,N,O,C,P,Q,R){function D(e,p){return(!e.minScale||e.minScale>=p)&&(!e.maxScale||e.maxScale<=p)}function E(e){e=e.message;const p={message:{data:{},tileKey:e.tileKey,tileKeyOrigin:e.tileKeyOrigin,version:e.version},transferList:[]};for(const a in e.data){var t=e.data[a];p.message.data[a]=null;if(n.isSome(t)){var b=t.stride;const d=t.indices.slice(0),c=t.vertices.slice(0),h=t.records.slice(0);t=n.applySome(t.metrics,g=>g.slice(0));b={stride:b,indices:d,vertices:c,
records:h,metrics:t};p.transferList.push(d,c,h);p.message.data[a]=b}}return p}z=function(e){function p(){var b=t.apply(this,arguments);b.type="symbol";b._matchers={feature:null,aggregate:null};b._bufferData=new Map;b._bufferIds=new Map;return b}y._inherits(p,e);var t=y._createSuper(p);e=p.prototype;e.initialize=function(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]);this._resourceManagerProxy=new R(this.remoteClient)};e.destroy=function(){this._resourceManagerProxy.destroy()};
e.forEachBufferId=function(b){this._bufferIds.forEach(a=>{a.forEach(b)})};e.update=async function(b,a){a=a.schema.processors[0];if("symbol"===a.type){var d=A.diff(this._schema,a);if(A.hasDiff(d,"mesh")||A.hasDiff(d,"target"))b.mesh=!0,b.why?.mesh.push("Symbology changed"),this._schema=a,this._factory=this._createFactory(a),this._factory.update(a,this.tileStore.tileScheme.tileInfo)}};e.onTileMessage=function(b,a,d,c){u.throwIfAborted(c);return this._onTileData(b,a,d,c)};e.onTileClear=function(b){this._bufferData.delete(b.key.id);
this._bufferIds.delete(b.key.id);return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.id,data:{clear:!0}})};e.onTileError=function(b,a,d){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:b.id,error:a},{signal:d.signal})};e.onTileUpdate=function(b){for(const a of b.removed)this._bufferData.has(a.key.id)&&this._bufferData.delete(a.key.id),this._bufferIds.has(a.key.id)&&this._bufferIds.delete(a.key.id);for(const a of b.added)this._bufferData.forEach(d=>{for(const c of d)c.message.tileKey===
a.id&&this._updateTileMesh("append",a,E(c),[],!1,!1,null)})};e._addBufferData=function(b,a){this._bufferData.has(b)||this._bufferData.set(b,[]);this._bufferData.get(b)?.push(E(a))};e._createFactory=function(b){const {geometryType:a,objectIdField:d,fields:c}=this.service,h=J.fromJSON(this.spatialReference),g={geometryType:a,fields:c,spatialReference:h},f=new O.WGLTemplateStore((k,q)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",k,q),this.tileStore.tileScheme.tileInfo),{matcher:m,aggregateMatcher:l}=
b.mesh;this._store=f;this._matchers.feature=C.createMatcher(m,f,g,this._resourceManagerProxy);this._matchers.aggregate=n.applySome(l,k=>C.createMatcher(k,f,g,this._resourceManagerProxy));return new N.WGLMeshFactory(a,d,f)};e._onTileData=async function(b,a,d,c){u.throwIfAborted(c);const {type:h,addOrUpdate:g,remove:f,clear:m,end:l}=a;var k=!!this._schema.mesh.sortKey;if(!g)return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.id,data:{type:h,addOrUpdate:null,remove:f,clear:m,end:l,sort:k}},
c);d=this._processFeatures(b,g,d,c,a.status?.version);try{var q=await d;if(n.isNone(q))return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:b.id,data:{type:h,addOrUpdate:null,remove:f,clear:m,end:l,sort:k}},c);k=[];for(const r of q){q=!1;const v=r.message.bufferIds,B=b.key.id,x=r.message.tileKey;if(B!==x&&n.isSome(v)){if(!this.tileStore.get(x)){this._addBufferData(B,r);k.push(r);continue}let w=this._bufferIds.get(x);w||(w=new Set,this._bufferIds.set(x,w));const S=Array.from(v);for(const F of S)if(w.has(F)){q=
!0;break}else w.add(F)}q||(this._addBufferData(B,r),k.push(r))}await Promise.all(k.map(r=>{const v=b.key.id===r.message.tileKey;return this._updateTileMesh(h,b,r,v?a.remove:[],v&&a.end,!!a.clear,c.signal)}))}catch(r){this._handleError(b,r,c)}};e._updateTileMesh=async function(b,a,d,c,h,g,f){const m=d.message.tileKey,l=!!this._schema.mesh.sortKey;m!==a.key.id&&(h=!1);a=n.applySome(d,k=>k.message);d=n.applySome(d,k=>k.transferList)||[];b={type:b,addOrUpdate:a,remove:c,clear:g,end:h,sort:l};f={transferList:n.unwrap(d)||
[],signal:f};u.throwIfAborted(f);return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:m,data:b},f)};e._processFeatures=async function(b,a,d,c,h){if(n.isNone(a)||!a.hasFeatures)return null;const g={transform:b.transform,hasZ:!1,hasM:!1},f=this._factory,m={viewingMode:"",scale:b.scale},l=await this._matchers.feature,k=await this._matchers.aggregate;u.throwIfAborted(c);const q=this._getLabelInfos(b,a);await f.analyze(a.getCursor(),this._resourceManagerProxy,l,k,g,m);u.throwIfAborted(c);
return this._writeFeatureSet(b,a,g,q,f,d,h)};e._writeFeatureSet=function(b,a,d,c,h,g,f){const m=a.getSize(),l=this._schema.mesh.matcher.symbologyType;g=new M.MeshData(b.key.id,{features:m,records:m,metrics:0},l,g,l!==L.WGLSymbologyType.HEATMAP,f);f={viewingMode:"",scale:b.scale};for(a=a.getCursor();a.next();)try{const k=a.getDisplayId(),q=n.isSome(c)?c.get(k):null;h.writeCursor(g,a,d,f,b.level,q,this._resourceManagerProxy)}catch(k){}return g.serialize(b.tileInfoView.tileInfo.isWrappable)};e._handleError=
function(b,a,d){return u.isAbortError(a)?Promise.resolve():this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:b.id,error:a.message},{signal:d.signal})};e._getLabelingSchemaForScale=function(b){var a=this._schema.mesh.labels;if(n.isNone(a))return null;if("subtype"===a.type){const d={type:"subtype",classes:{}};let c=!1;for(const h in a.classes){const g=a.classes[h].filter(f=>D(f,b.scale));c=c||!!g.length;d.classes[h]=g}return c?d:null}a=a.classes.filter(d=>D(d,b.scale));return a.length?{type:"simple",
classes:a}:null};e._getLabels=function(b,a){if("subtype"===a.type){const d=n.unwrapOrThrow(this.service.subtypeField,"Expected to find subtype Field");b=b.readAttribute(d);return null==b?[]:a.classes[b]??[]}return a.classes};e._getLabelInfos=function(b,a){b=this._getLabelingSchemaForScale(b);if(n.isNone(b))return null;const d=new Map;for(a=a.getCursor();a.next();){const h=a.getDisplayId(),g=[],f=K.isAggregateId(h),m=f&&1!==a.readAttribute("cluster_count")?"aggregate":"feature";var c=this._getLabels(a,
b);for(const l of c){if(l.target!==m)continue;c=a.getStorage();c=f&&"feature"===m?c.getComputedStringAtIndex(a.readAttribute("referenceId"),l.fieldIndex):c.getComputedStringAtIndex(h,l.fieldIndex);if(!c)continue;c=H.bidiText(c.toString());const k=c[1];this._store.getMosaicItem(l.symbol,P.codepoints(c[0])).then(q=>{g[l.index]={glyphs:q.glyphMosaicItems??[],rtl:k,index:l.index}})}d.set(h,g)}return d};y._createClass(p,[{key:"supportsTileUpdates",get:function(){return!0}}]);return p}(Q);return z=G.__decorate([I.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],
z)});