// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/RandomLCG ../../../../../core/accessorSupport/decorators/subclass ./BaseFeatureSource ../support/FeatureSetReaderPBFIndirect ../support/UpdateToken".split(" "),function(v,p,z,G,A,n,x,B,C,D,E,w){function F(d,g,q){var a=d.getXHydrated();d=d.getYHydrated();a=g.getColumnForX(a);
a=Math.floor(g.normalizeCol(a));g=Math.floor(g.getRowForY(d));return`${q}/${g}/${a}`}function y(d,g){if(n.isNone(d))return null;g=g.transform;const q=d.getQuantizationTransform();if(n.isNone(q)){const [m,r]=g.scale,[t,u]=g.translate;return d.transform(-t/m,u/r,1/m,1/-r)}const [a,b]=q.scale,[c,e]=q.translate,[f,h]=g.scale,[l,k]=g.translate;return d.transform((c-l)/f,(-e+k)/h,a/f,b/h)}v.SnapshotFeatureSource=function(d){function g(a){var b=q.call(this,a);b.mode="snapshot";b._loading=!0;b._controller=
new AbortController;b._downloadPromise=null;b._didSendEnd=!1;b._queries=[];b._invalidated=!1;b._hasAggregates=!1;b._random=new B(1E3);b._store=a.store;b._markedIdsBufId=b._store.storage.createBitset();return b}p._inherits(g,d);var q=p._createSuper(g);d=g.prototype;d.destroy=function(){p._get(p._getPrototypeOf(g.prototype),"destroy",this).call(this);this._controller.abort()};d.update=function(a,b){p._get(p._getPrototypeOf(g.prototype),"update",this).call(this,a,b);null==this._featureCount&&(this._featureCount=
b.initialFeatureCount);n.isSome(b.changedFeatureCount)&&(this._featureCount=b.changedFeatureCount);this._hasAggregates=!!a.targets?.aggregate};d.resend=async function(a=!1){await this._downloadPromise;this._invalidated||a?(a=n.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined"),this._invalidated=!1,this._subscriptions.forEach(b=>b.clear()),this._downloadPromise=this._download(a),await this._downloadPromise):(a=this._queries.map(({query:b,reader:c})=>this._sendPatchQuery(b,c)),
await Promise.all(a),this._subscriptions.forEach(b=>{b.requests.done.forEach(c=>this._onMessage(c.message))}))};d.refresh=async function(a,b){b&&(this._featureCount=b.featureCount);await this.resend(!0)};d._sendPatchQuery=async function(a,b){const c=n.isSome(a.outFields)?a.outFields:[],e=this._queryInfo.outFields,f=e.filter(k=>!c.includes(k));if(f.length){var h=a.clone(),l=this._signal;h.returnGeometry=!1;h.returnCentroid=!1;h.outFields=f;a.outFields=e;a=await this.enqueueQuery({query:h,depth:0,signal:l});
x.throwIfAborted({signal:l});b.joinAttributes(a)}};d._fetchDataTile=async function(a){if(!this._downloadPromise){var b=n.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined");this._downloadPromise=this._download(b)}var c=this._store.search(a);b=this._subscriptions.get(a.key.id);const e=c.length-1;for(let h=0;h<e;h++){var f=y(c[h],a);f={type:"append",id:a.id,addOrUpdate:f,end:!1,status:w.UpdateToken.empty()};b.add({query:null,message:f});this._hasAggregates||await x.after(1);this._onMessage(f)}c=
y(0<=e?c[e]:null,a);a={type:"append",id:a.id,addOrUpdate:c,end:this._didSendEnd,status:w.UpdateToken.empty()};b.add({query:null,message:a});this._onMessage(a)};d._download=async function(a){try{await this.whenInitialized();const b=this._store.storage.getBitset(this._markedIdsBufId),c=new Set;b.clear();const e=Array.from({length:Math.ceil(a/this.pageSize)},(f,h)=>h).sort((f,h)=>this._random.getInt()-this._random.getInt()).map(f=>this._downloadPage(f,b,c));await Promise.all(e);this._store.sweepFeatures(b,
this._store.storage);this._store.sweepFeatureSets(c)}catch(b){A.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",b)}this._sendEnd();this._loading=!1};d._downloadPage=async function(a,b,c){var e=this.pageSize;e={start:a*e,num:e,cacheHint:!0};n.isSome(this.maxRecordCountFactor)&&(e.maxRecordCountFactor=this.maxRecordCountFactor);e=this.createQuery(e);const f=this._signal;a=await this.enqueueQuery({query:e,
depth:a,signal:f});x.throwIfAborted({signal:f});this._queries.push({query:e,reader:a});this._store.insert(a);c.add(a.instance);for(c=a.getCursor();c.next();)b.set(c.getDisplayId());this._send(a)};d._send=function(a){if(this._subscriptions.size){var b=null,c=new Map,e=new Set,f=new Map;this._subscriptions.forEach(l=>{var k=l.tile;c.set(k.key.id,null);b=k.tileInfoView;e.add(k.level);const {row:m,col:r}=k.key;k=`${k.level}/${m}/${r}`;const t=f.get(k)??[];t.push(l);f.set(k,t)});for(const l of e){const k=
b.getLODInfoAt(l),m=a.getCursor();for(;m.next();){var h=F(m,k,l);const r=m.getIndex();if(f.has(h))for(const t of f.get(h)){h=t.tile.id;let u=c.get(h);n.isNone(u)&&(u=[],c.set(h,u));u.push(r)}}}c.forEach((l,k)=>{if(n.isSome(l)){const m=this._subscriptions.get(k);l=y(E.FeatureSetReaderIndirect.from(a,l),m.tile);k={type:"append",id:k,addOrUpdate:l,end:!1,status:w.UpdateToken.empty()};m.add({query:null,message:k});this._onMessage(k)}})}};d._sendEnd=function(){this._subscriptions.forEach(a=>{const b={type:"append",
id:a.tile.id,addOrUpdate:null,end:!0,status:w.UpdateToken.empty()};a.add({query:null,message:b});this._onMessage(b)});this._didSendEnd=!0};p._createClass(g,[{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]);return g}(D.BaseFeatureSource);v.SnapshotFeatureSource=z.__decorate([C.subclass("esri.view.2d.layers.features.sources.SnapshotFeatureSource")],v.SnapshotFeatureSource);Object.defineProperty(v,Symbol.toStringTag,{value:"Module"})});