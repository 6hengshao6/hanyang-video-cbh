// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Logger ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../support/GraphicsCollection ../engine/BitmapContainer ./LayerView2D ./graphics/GraphicsView2D ./graphics/HighlightGraphicContainer ./support/ExportStrategy ../../layers/LayerView ../../layers/MapImageLayerView ../../layers/RefreshableLayerView ../../layers/support/MapServiceLayerViewHelper ../../support/drapedUtils".split(" "),
function(h,k,p,q,r,n,e,H,I,t,u,v,w,x,y,z,A,B,C,D,E){e=function(b){function g(){var a=F.apply(this,arguments);a._highlightGraphics=new u.GraphicsCollection;a._updateHash="";return a}h._inherits(g,b);var F=h._createSuper(g);b=g.prototype;b.fetchPopupFeatures=function(a,c){return this._popupHighlightHelper.fetchPopupFeatures(a,c)};b.update=function(a){const c=`${this.exportImageVersion}/${a.state.id}/${a.pixelRatio}/${a.stationary}`;this._updateHash!==c&&(this._updateHash=c,this.strategy.update(a).catch(d=>
{q.isAbortError(d)||p.getLogger(this.declaredClass).error(d)}),a.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(a.state.resolution));this._highlightView.processUpdate(a)};b.attach=function(){const {imageMaxWidth:a,imageMaxHeight:c,version:d}=this.layer,f=10.3<=d,G=10<=d;this._bitmapContainer=new v.BitmapContainer;this.container.addChild(this._bitmapContainer);this._highlightView=new x({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),
container:new y(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1});this.container.addChild(this._highlightView.container);this._popupHighlightHelper=new D.MapServiceLayerViewHelper({createFetchPopupFeaturesQueryGeometry:(l,m)=>E.createQueryGeometry(l,m,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:(l,m)=>{this._highlightView.graphicUpdateHandler({graphic:l,property:m})},layerView:this,updatingHandles:this.updatingHandles});this.strategy=new z({container:this._bitmapContainer,
fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:a,imageMaxHeight:c,imageRotationSupported:f,imageNormalizationSupported:G,hidpi:!0});this.addAttachHandles(r.watch(()=>this.exportImageVersion,()=>this.requestUpdate()));this.requestUpdate()};b.detach=function(){this.strategy.destroy();this.container.removeAllChildren();this._bitmapContainer.removeAllChildren();this._highlightView.destroy();this._popupHighlightHelper.destroy()};b.moveStart=function(){};
b.viewChange=function(){};b.moveEnd=function(){this.requestUpdate()};b.supportsSpatialReference=function(a){return this.layer.serviceSupportsSpatialReference(a)};b.doRefresh=async function(){this._updateHash="";this.requestUpdate()};b.isUpdating=function(){return this.strategy.updating||this.updateRequested};b.fetchImage=function(a,c,d,f){return this.layer.fetchImage(a,c,d,{timeExtent:this.timeExtent,floors:this.floors,...f})};b.fetchImageBitmap=function(a,c,d,f){return this.layer.fetchImageBitmap(a,
c,d,{timeExtent:this.timeExtent,floors:this.floors,...f})};b.highlight=function(a){return this._popupHighlightHelper.highlight(a)};return h._createClass(g)}(B(C(w.LayerView2DMixin(A))));k.__decorate([n.property()],e.prototype,"strategy",void 0);k.__decorate([n.property()],e.prototype,"updating",void 0);return e=k.__decorate([t.subclass("esri.views.2d.layers.MapImageLayerView2D")],e)});