// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec2 ../../support/QueueProcessor".split(" "),function(v,m,h,B,q,G,H,I,C,D,E){function F(b,n){b.length=0;n.forEach(w=>b.push(w));return b}const x=new Set,t=[],r=new Map,y=[0,0];h=function(b){function n(a){a=
w.call(this,a);a._keyToItem=new Map;a.concurrency=6;a.strategy="scale-first";a.tileInfoView=null;return a}v._inherits(n,b);var w=v._createSuper(n);b=n.prototype;b.initialize=function(){const {concurrency:a,process:g,strategy:k}=this;this._queue=new E.QueueProcessor({concurrency:a,process:(c,e)=>{c=this._keyToItem.get(c);return g(c,{signal:e})},peeker:"scale-first"===k?c=>this._peekByScaleFirst(c):c=>this._peekByCenterFirst(c)})};b.destroy=function(){this.clear();this._queue=B.destroyMaybe(this._queue)};
b.abort=function(a){this._queue.abort("string"===typeof a?a:a.id)};b.clear=function(){this._queue.clear();this._keyToItem.clear();this.notifyChange("updating")};b.has=function(a){return"string"===typeof a?this._keyToItem.has(a):this._keyToItem.has(a.id)};b.isOngoing=function(a){a="string"===typeof a?a:a.id;return this.has(a)&&this._queue.isOngoing(a)};b.pause=function(){this._queue.pause()};b.push=function(a){const g=a.key.id;if(this._queue.has(g))return this._queue.get(g);const k=this._queue.push(g),
c=()=>{this._keyToItem.delete(g);this.notifyChange("updating")};this._keyToItem.set(g,a);k.then(c,c);this.notifyChange("updating");return k};b.reset=function(){this._queue.reset()};b.resume=function(){this._queue.resume()};b._peekByScaleFirst=function(a){if(!this.state)return a.values().next().value;const g=this.tileInfoView;let k=Number.NEGATIVE_INFINITY,c=Number.POSITIVE_INFINITY;a.forEach(f=>{f=this._keyToItem.get(f);const d=this.tileInfoView.getTileScale(f.key);r.has(d)||(r.set(d,[]),k=Math.max(d,
k),c=Math.min(d,c));r.get(d).push(f.key);x.add(d)});let e=this.state.scale;r.has(e)||(F(t,x),t.sort((f,d)=>f-d),e=t.reduce((f,d)=>Math.abs(d-e)<Math.abs(f-e)?d:f,t[0]));e=Math.min(e,k);e=Math.max(e,c);a=r.get(e);const l=g.getClosestInfoForScale(e),p=l.getColumnForX(this.state.center[0]),u=l.getRowForY(this.state.center[1]);a.sort((f,d)=>{const z=l.denormalizeCol(f.col,f.world),A=l.denormalizeCol(d.col,d.world);return Math.sqrt((p-z)*(p-z)+(u-f.row)*(u-f.row))-Math.sqrt((p-A)*(p-A)+(u-d.row)*(u-d.row))});
x.clear();r.clear();return a[0].id};b._peekByCenterFirst=function(a){if(!this.state)return a.values().next().value;const g=this.tileInfoView,k=this.state.center;let c=Number.POSITIVE_INFINITY,e;a.forEach(l=>{l=this._keyToItem.get(l);g.getTileCoords(y,l.key);const p=D.distance(y,k);p<c&&(c=p,e=l.key)});return e.id};v._createClass(n,[{key:"length",get:function(){return this._queue?this._queue.length:0}},{key:"onGoingCount",get:function(){return this._keyToItem.size}},{key:"updating",get:function(){return 0<
this.length||0<this.onGoingCount}}]);return n}(h);m.__decorate([q.property({constructOnly:!0})],h.prototype,"concurrency",void 0);m.__decorate([q.property({constructOnly:!0})],h.prototype,"process",void 0);m.__decorate([q.property()],h.prototype,"state",void 0);m.__decorate([q.property({constructOnly:!0})],h.prototype,"strategy",void 0);m.__decorate([q.property({constructOnly:!0})],h.prototype,"tileInfoView",void 0);m.__decorate([q.property({readOnly:!0})],h.prototype,"updating",null);return h=m.__decorate([C.subclass("esri.views.2d.tiling.TileQueue")],
h)});