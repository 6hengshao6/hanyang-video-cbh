// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["../../../../../chunks/_rollupPluginBabelHelpers","../enums","./BaseBucket","../../webgl/TurboLine"],function(A,I,J,K){const L=k=>(r,u,a,b,d,e,c,g,h,m,q)=>{k._lineVertexBuffer.add(r,u,c,g,a,b,d,e,h,m,q,k._ddValues);return k._lineVertexBuffer.index-1},M=k=>(r,u,a)=>{k._lineIndexBuffer.add(r,u,a)};return function(k){function r(a,b,d,e,c){b=u.call(this,a,b,d);b.type=I.BucketType.LINE;b._tessellationOptions={pixelCoordRatio:8,halfWidth:0,offset:0};b._patternMap=new Map;b.tessellationProperties=
{_lineVertexBuffer:null,_lineIndexBuffer:null,_ddValues:null};b.tessellationProperties._lineVertexBuffer=e;b.tessellationProperties._lineIndexBuffer=c;b._lineTessellator=new K.LineTessellation(L(b.tessellationProperties),M(b.tessellationProperties),a.canUseThinTessellation);return b}A._inherits(r,k);var u=A._createSuper(r);k=r.prototype;k.getResources=function(a,b,d){a=this.layer;const e=this.zoom,c=a.getPaintProperty("line-pattern"),g=a.getPaintProperty("line-dasharray"),h=a.getLayoutProperty("line-cap");
if(c||g){d=h?.getValue(e)||0;var m=h?.isDataDriven,q=c?.isDataDriven;if(q||g?.isDataDriven)for(var n of this._features)q?b(c.getValue(e,n)):b(this._getDashArrayKey(n,e,a,g,m,h,d));else c?b(c.getValue(e)):g&&(n=g.getValue(e),b(a.getDashKey(n,d)))}};k.processFeatures=function(a){this._lineIndexStart=3*this.tessellationProperties._lineIndexBuffer.index;this._lineIndexCount=0;const b=this.layer,d=this.zoom;var e=this._features;const c=this._tessellationOptions,{hasDataDrivenLine:g,lineMaterial:h}=b;a&&
a.setExtent(this.layerExtent);var m=b.getPaintProperty("line-pattern"),q=b.getPaintProperty("line-dasharray"),n=m?.isDataDriven,B=q?.isDataDriven;var f=b.getLayoutProperty("line-cap");const t=f?.isDataDriven?f:null,C=t?null:b.getLayoutValue("line-cap",d),N=C||0,O=!!t;f=b.getLayoutProperty("line-join");const v=f?.isDataDriven?f:null,D=v?null:b.getLayoutValue("line-join",d);f=b.getLayoutProperty("line-miter-limit");const w=f?.isDataDriven?f:null,E=w?null:b.getLayoutValue("line-miter-limit",d);f=b.getLayoutProperty("line-round-limit");
const x=f?.isDataDriven?f:null,F=x?null:b.getLayoutValue("line-round-limit",d);f=b.getPaintProperty("line-width");const y=f?.isDataDriven?f:null,G=y?null:b.getPaintValue("line-width",d);f=b.getPaintProperty("line-offset");const H=(f=f?.isDataDriven?f:null)?null:b.getPaintValue("line-offset",d);if(n||B){var p=[];for(const l of e){e=n?m.getValue(d,l):this._getDashArrayKey(l,d,b,q,O,t,N);e=this._spriteInfo[e];if(!e||!e.rect)continue;B=h.encodeAttributes(l,d,b,e);const z=l.getGeometry(a);p.push({ddAttributes:B,
page:e.page,cap:t?t.getValue(d,l):C,join:v?v.getValue(d,l):D,miterLimit:w?w.getValue(d,l):E,roundLimit:x?x.getValue(d,l):F,halfWidth:.5*(y?y.getValue(d,l):G),offset:f?f.getValue(d,l):H,geometry:z})}p.sort((l,z)=>l.page-z.page);c.textured=!0;for(const {ddAttributes:l,page:z,cap:P,join:Q,miterLimit:R,roundLimit:S,halfWidth:T,offset:U,geometry:V}of p)c.capType=P,c.joinType=Q,c.miterLimit=R,c.roundLimit=S,c.halfWidth=T,c.offset=U,this._processFeature(V,l,z)}else{if(m&&(n=m.getValue(d),n=this._spriteInfo[n],
!n||!n.rect))return;c.textured=!(!m&&!q);c.capType=C;c.joinType=D;c.miterLimit=E;c.roundLimit=F;c.halfWidth=.5*G;c.offset=H;for(p of e)m=g?h.encodeAttributes(p,d,b):null,t&&(c.capType=t.getValue(d,p)),v&&(c.joinType=v.getValue(d,p)),w&&(c.miterLimit=w.getValue(d,p)),x&&(c.roundLimit=x.getValue(d,p)),y&&(c.halfWidth=.5*y.getValue(d,p)),f&&(c.offset=f.getValue(d,p)),q=p.getGeometry(a),this._processFeature(q,m)}};k.serialize=function(){var a=6+this.layerUIDs.length;a+=this.tessellationProperties._lineVertexBuffer.array.length;
a+=this.tessellationProperties._lineIndexBuffer.array.length;a+=3*this._patternMap.size+1;a=new Uint32Array(a);var b=new Int32Array(a.buffer);let d=0;a[d++]=this.type;a[d++]=this.layerUIDs.length;for(var e=0;e<this.layerUIDs.length;e++)a[d++]=this.layerUIDs[e];a[d++]=this._lineIndexStart;a[d++]=this._lineIndexCount;e=this._patternMap;const c=e.size;a[d++]=c;if(0<c)for(const [g,[h,m]]of e)a[d++]=g,a[d++]=h,a[d++]=m;a[d++]=this.tessellationProperties._lineVertexBuffer.array.length;for(e=0;e<this.tessellationProperties._lineVertexBuffer.array.length;e++)b[d++]=
this.tessellationProperties._lineVertexBuffer.array[e];a[d++]=this.tessellationProperties._lineIndexBuffer.array.length;for(b=0;b<this.tessellationProperties._lineIndexBuffer.array.length;b++)a[d++]=this.tessellationProperties._lineIndexBuffer.array[b];return a.buffer};k._processFeature=function(a,b,d){if(a){var e=a.length;for(let c=0;c<e;c++)this._processGeometry(a[c],b,d)}};k._processGeometry=function(a,b,d){if(!(2>a.length)){for(var e=a[0],c=1,g,h;c<a.length;)g=a[c].x-e.x,h=a[c].y-e.y,1E-6>g*g+
h*h?a.splice(c,1):(e=a[c],++c);2>a.length||(c=this.tessellationProperties._lineIndexBuffer,e=3*c.index,this._tessellationOptions.initialDistance=0,this._tessellationOptions.wrapDistance=65535,this.tessellationProperties._ddValues=b,this._lineTessellator.tessellate(a,this._tessellationOptions),a=3*c.index-e,void 0!==d&&(b=this._patternMap,(c=b.get(d))?c[1]+=a:b.set(d,[e+this._lineIndexCount,a])),this._lineIndexCount+=a)}};k._getDashArrayKey=function(a,b,d,e,c,g,h){c=c?g.getValue(b,a):h;a=e.getValue(b,
a);return d.getDashKey(a,c)};A._createClass(r,[{key:"lineIndexStart",get:function(){return this._lineIndexStart}},{key:"lineIndexCount",get:function(){return this._lineIndexCount}}]);return r}(J)});