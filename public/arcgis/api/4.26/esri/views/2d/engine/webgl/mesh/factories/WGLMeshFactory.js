// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/has ../../../../../../core/maybe ../../../../../../core/promiseUtils ../../../../../../geometry/libtess ../../DisplayId ../templates/WGLLabelTemplate ../templates/WGLMarkerTemplate ../templates/WGLTemplateStore".split(" "),function(u,y,v,n,w,z,A,x,B,p){v=function(){function r(a,b,c){this._loadPromise=z.loadLibtess();this._geometryType=a;this._idField=b;this._templateStore=c}var m=r.prototype;m.update=function(a,
b){n.isSome(a.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(a.mesh.labels,b));this._schema=a};m._createLabelTemplates=function(a,b){const c=new Map;if("simple"===a.type){for(var d of a.classes)a=x.fromLabelClass(d,b),c.set(d.index,a);return c}for(const f in a.classes){d=a.classes[f];for(const e of d)d=x.fromLabelClass(e,b),c.set(e.index,d)}return c};m.analyze=async function(a,b,c,d,f,e,h){if(!w.isAborted(h)){var g;"dictionary"===c?.type&&(g=await c.analyze(this._idField,a.copy(),
b,f,e,h));for(b=0;a.next();){var k=null;k=g?g[b++]:n.isSome(d)&&A.isAggregateId(a.getDisplayId())&&1!==a.readAttribute("cluster_count")?d.match(this._idField,a,this._geometryType,f,e):c.match(this._idField,a,this._geometryType,f,e);a.setGroupId(k);if(p.isDynamicId(k)){k=this._templateStore.getDynamicTemplateGroup(k).templates;for(const l of k)l&&l.analyze&&l.analyze(this._templateStore,a,f,e)}}await this._loadPromise;return this._templateStore.finalize(h)}};m.analyzeGraphics=async function(a,b,c,
d,f,e){if(!w.isAborted(e)){a=a.getCursor();for(c&&await c.analyze(this._idField,a.copy(),b,d,f,e);a.next();){b=a.getGroupId();if(null==b||-1===b)b=c?.match(this._idField,a,a.geometryType,d,f),a.setGroupId(b);if(p.isDynamicId(b)){const h=this._templateStore.getDynamicTemplateGroup(b).templates;for(const g of h)g&&g.analyze&&g.analyze(this._templateStore,a,d,f)}a.setGroupId(b)}await this._loadPromise;return this._templateStore.finalize(e)}};m.writeGraphic=function(a,b,c,d){const f=b.getGroupId(),e=
b.getDisplayId(),h=this._templateStore.getTemplateGroup(f);a.featureStart(b.insertAfter,0);if(null!=e){if(p.isDynamicId(f))for(const g of h.templates)g&&g.bindFeature(b,null,null);if(h){for(const g of h.templates)g&&g.write(a,b,c,d);a.featureEnd()}}};m.writeCursor=function(a,b,c,d,f,e,h){const g=b.getGroupId(),k=b.getDisplayId();var l=this._templateStore.getTemplateGroup(g);const q=l.templates;l=this._getSortKeyValue(b,l);a.featureStart(0,l);if(null!=k&&q){if(p.isDynamicId(g))for(const t of q)t.bindFeature(b,
c,d);for(const t of q)t.write(a,b,f,h);n.isSome(e)&&a.hasRecords&&(c=e&&this._findLabelRef(q),this._writeLabels(a,b,e,c,f,h));a.featureEnd()}};m._getSortKeyValue=function(a,b){const c=this._schema.mesh.sortKey;if(n.isNone(c))return 0;let d=0;d=!0===c.byRenderer&&null!=b.sortKey?b.sortKey:null!=c.fieldIndex?a.getComputedNumericAtIndex(c.fieldIndex):null!=c.field?a.readAttribute(c.field):a.readAttribute(this._idField);d*="asc"===c.order?1:-1;return null==d||isNaN(d)?0:d};m._findLabelRef=function(a){for(const b of a)if(b instanceof
B)return b;return null};m._writeLabels=function(a,b,c,d,f,e){for(const h of c)if(n.isSome(h)&&h){const {glyphs:g,rtl:k,index:l}=h;if(c=this._labelTemplates.get(l))c.setZoomLevel(f),c.bindReferenceTemplate(d),c.bindTextInfo(g,k),c.write(a,b,null,e)}};y._createClass(r,[{key:"templates",get:function(){return this._templateStore}}]);return r}();u.WGLMeshFactory=v;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});