// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../../../chunks/mat2d ../../../../../../chunks/mat2df32 ../../../../../../chunks/vec2 ../../../../../../chunks/vec2f32 ../../../../../../geometry/GeometryCursor ../../../../../../layers/graphics/featureConversionUtils ../../../../../../symbols/cim/CIMCursor ../../../../../../symbols/cim/placements/CIMMarkerPlacementHelper ../../definitions ../../enums ../../number ../../materialKey/MaterialKey".split(" "),
function(t,u,E,y,F,n,z,A,B,G,H,q,C,m,I){const D=3.14159265359/180;return J=>function(k){function r(...a){a=K.call(this,...a);a.angle=0;a.xOffset=0;a.yOffset=0;a.width=0;a.height=0;a.boundsType="square";a._anchorX=0;a._anchorY=0;a._computedWidth=0;a._computedHeight=0;a._allowBorrowing=!0;a._vertexBoundsScaleX=1;a._vertexBoundsScaleY=1;a.geometryType=C.WGLGeometryType.MARKER;return a}t._inherits(r,k);var K=t._createSuper(r);k=r.prototype;k._write=function(a,b,c,d){const h=b.getDisplayId();a.recordStart(h,
this._materialKey,this.geometryType,!0);this._writeGeometry(a,b,h,c,d);a.recordEnd()};k._writeGeometry=function(a,b,c,d,h){if(u.isSome(this._markerPlacement))return this._writePlacedMarkers(a,b,d,h);this._allowBorrowing=!0;if(!h&&"esriGeometryPoint"===b.geometryType)return d=b.getX(),b=b.getY(),!a.hasAggregates&&a.hasPixelBufferEnabled&&(0>d||513<=d||0>b||513<=b)?void 0:this._writeVertices(a,c,this._getPos(d,b),d,b);b=h?B.deltaDecodeGeometry(B.convertFromGeometry(h),2):"esriGeometryPolygon"===b.geometryType?
b.readCentroid():b.readGeometryForDisplay();if(!u.isNone(b)){if(b.isPoint){const [e,f]=b.coords;return!a.hasAggregates&&a.hasPixelBufferEnabled&&(0>e||512<=e||0>f||512<=f)?void 0:this._writeVertices(a,c,this._getPos(e,f),e,f)}b.forEachVertex((e,f)=>{const g=2*q.TILE_SIZE;e<-g||e>=g||f<-g||f>=g||this._writeVertices(a,c,this._getPos(e,f),e,f)})}};k._writePlacedMarkers=function(a,b,c,d){d&&G.deltaDecodeGeometry(d);d=d?A.getJSONCursor(d):A.getOptimizedCursor(b.readGeometryForDisplay(),b.geometryType??
null,!0);if(c=H.CIMMarkerPlacementHelper.getPlacement(d,u.unwrap(this._markerPlacement),E.pt2px(1),a.tileKey,c.geometryEngine)){this._allowBorrowing="esriGeometryPolygon"!==b.geometryType;b=b.getDisplayId();d=z.create();for(var h=F.create(),e=c.next();null!=e;){const f=e.tx,g=-e.ty;-128<=f&&640>=f&&-128<=g&&640>=g&&(this._applyTransformation(h,d,-e.getAngle()/D),this._writeVertices(a,b,this._getPos(f,g),f,g));e=c.next()}}};k._writeVertices=function(a,b,c,d,h){const e=I.MarkerMaterialKey.load(this._materialKey);
switch(e.symbologyType){case C.WGLSymbologyType.HEATMAP:return this._writeHeatmapVertices(a,b,c);default:return this._writeMarkerVertices(a,b,e,c,d,h)}};k._writeMarkerVertices=function(a,b,c,d,h,e){var f=c.vvRotation;c=a.vertexCount();let g=this._computedWidth*this._vertexBoundsScaleX;var l=this._computedHeight*this._vertexBoundsScaleY;this.angle&&(g=l=Math.max(g,l));f&&(f=Math.max(this.xOffset,this.yOffset),g+=f,l+=f);this._allowBorrowing&&a.vertexBounds(h+this.xOffset,e-this.yOffset,g,l);a.vertexWrite(d);
a.vertexWrite(this._offsetUpperLeft);a.vertexWrite(this._texUpperLeft);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetUpperRight);a.vertexWrite(this._texUpperRight);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);
a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetBottomLeft);a.vertexWrite(this._texBottomLeft);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();a.vertexWrite(d);a.vertexWrite(this._offsetBottomRight);a.vertexWrite(this._texBottomRight);a.vertexWrite(this._bitestAndDistRatio);a.vertexWrite(b);a.vertexWrite(this._fillColor);
a.vertexWrite(this._outlineColor);a.vertexWrite(this._sizeOutlineWidth);a.vertexWrite(this._minMaxZoom);a.vertexEnd();this._writeIndices(a,c)};k._writeHeatmapVertices=function(a,b,c){const d=a.vertexCount();a.vertexWrite(c);a.vertexWrite(this._offsetUpperLeft);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetUpperRight);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetBottomLeft);a.vertexWrite(b);a.vertexEnd();a.vertexWrite(c);a.vertexWrite(this._offsetBottomRight);
a.vertexWrite(b);a.vertexEnd();this._writeIndices(a,d)};k._writeIndices=function(a,b){a.indexWrite(b+0);a.indexWrite(b+1);a.indexWrite(b+2);a.indexWrite(b+1);a.indexWrite(b+3);a.indexWrite(b+2)};k._applyTransformation=function(a,b,c=0){y.fromTranslation(a,z.fromValues(this.xOffset,-this.yOffset));null!=this.angle&&0!==this.angle+c&&y.rotate(a,a,D*(this.angle+c));c=this._computedWidth;const d=this._computedHeight,h=-(.5+this._anchorX)*c,e=-(.5-this._anchorY)*d;n.set(b,h,e);n.transformMat2d(b,b,a);
this._offsetUpperLeft=m.i1616to32(16*b[0],16*b[1]);n.set(b,h+c,e);n.transformMat2d(b,b,a);this._offsetUpperRight=m.i1616to32(16*b[0],16*b[1]);n.set(b,h,e+d);n.transformMat2d(b,b,a);this._offsetBottomLeft=m.i1616to32(16*b[0],16*b[1]);n.set(b,h+c,e+d);n.transformMat2d(b,b,a);this._offsetBottomRight=m.i1616to32(16*b[0],16*b[1])};k._computeSize=function(a,b,c,d,h,e,f,g){const l=a*c;c*=b;e.sdf&&!f?(d+=2,a=Math.min((g&&a>b?l:a)+d,l),b=Math.min(b+d,c)):(a=l,b=c);g=q.SDF_TEXTURE_SIZE/Math.max(l,c);f=.5*(l-
a)*g;var p=.5*(c-b)*g;g=e.rect.x+q.SPRITE_PADDING+f;d=e.rect.y+q.SPRITE_PADDING+p;f=g+e.width-2*f;e=d+e.height-2*p;p=Math.floor(g);const v=Math.floor(d),w=Math.ceil(f),x=Math.ceil(e);a*=(w-p)/(f-g);b*=(x-v)/(e-d);this._texUpperLeft=m.i1616to32(p,v);this._texUpperRight=m.i1616to32(w,v);this._texBottomLeft=m.i1616to32(p,x);this._texBottomRight=m.i1616to32(w,x);this._anchorX*=l/a;this._anchorY*=c/b;this._computedWidth=a*h;this._computedHeight=b*h};k._getPos=function(a,b){return m.i1616to32(Math.round(8*
a),Math.round(8*b))};return t._createClass(r)}(J)});