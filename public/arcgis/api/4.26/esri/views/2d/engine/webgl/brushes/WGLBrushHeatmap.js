// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/maybe ../enums ../VertexStream ./WGLGeometryBrushMarker ../effects/Effect ../techniques/utils ../../../../webgl/context-util ../../../../webgl/enums ../../../../webgl/FramebufferObject ../../../../webgl/heatmapTextureUtils ../../../../webgl/Renderbuffer ../../../../webgl/Texture".split(" "),function(l,v,m,B,C,D,E,y,F,c,G,H,I,z){const A=v.getLogger("esri.views.2d.engine.webgl.brushes.WGLBrushHeatmap");
v=function(d){function k(){var a=w.apply(this,arguments);a.brushEffect=new J;return a}l._inherits(k,d);var w=l._createSuper(k);d=k.prototype;d.supportsSymbology=function(a){return a===B.WGLSymbologyType.HEATMAP};d.dispose=function(){l._get(l._getPrototypeOf(k.prototype),"dispose",this).call(this);this.brushEffect.dispose();this.brushEffect=null};d.prepareState=function(){};d.drawGeometry=function(a,b,h,f){const {defines:e}=this.brushEffect.loadQualityProfile(a.context);l._get(l._getPrototypeOf(k.prototype),
"drawGeometry",this).call(this,a,b,h,f?[...f,...e]:e)};d._drawMarkers=function(a,b,h,f,e,g,n){const {context:p,rendererInfo:q,state:u}=a;({rendererSchema:a}=q);y.assertRendererSchema(a,"heatmap");const {referenceScale:r,radius:t,isFieldActive:x}=a;h.setUniform1f("u_radius",t*(0!==r?r/u.scale:1));n||(h.setUniform1f("u_isFieldActive",x),p.setStencilFunction(c.CompareFunction.GEQUAL,b.stencilRef,255));p.drawElements(f,e,c.DataType.UNSIGNED_INT,g)};return l._createClass(k)}(D);const K={vsPath:"heatmap/heatmapResolve",
fsPath:"heatmap/heatmapResolve",attributes:new Map([["a_position",0]])};let J=function(d){function k(){var a=w.apply(this,arguments);a.name=a.constructor.name;return a}l._inherits(k,d);var w=l._createSuper(k);d=k.prototype;d.createOptions=function({passOptions:a}){return a};d.dispose=function(){this._prevFBO=null;this._accumulateOutputTexture=m.disposeMaybe(this._accumulateOutputTexture);m.isSome(this._accumulateFramebuffer)&&this._accumulateFramebuffer.detachDepthStencilBuffer();this._accumulateOutputStencilBuffer=
m.disposeMaybe(this._accumulateOutputStencilBuffer);this._accumulateFramebuffer=m.disposeMaybe(this._accumulateFramebuffer);this._resolveGradientTexture=m.disposeMaybe(this._resolveGradientTexture);this._tileQuad=m.disposeMaybe(this._tileQuad)};d.bind=function(a){const {context:b,rendererInfo:h,passOptions:f}=a,{rendererSchema:e}=h;m.isSome(f)&&"hittest"===f.type||"heatmap"!==e.type||(this._prevFBO=b.getBoundFramebufferObject(),this._prevViewport=b.getViewport(),y.assertRendererSchema(e,"heatmap"),
this._loadResources(a),this._updateResources(b,e),b.bindFramebuffer(this._accumulateFramebuffer),b.setViewport(0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height),b.setStencilTestEnabled(!0),b.setBlendingEnabled(!0),b.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE),b.setClearColor(0,0,0,0),b.clear(c.ClearBufferBit.COLOR_BUFFER_BIT))};d.unbind=function(){this._prevViewport=this._prevFBO=null};d.draw=function(a){const {context:b,painter:h,rendererInfo:f,passOptions:e}=a;
({rendererSchema:a}=f);if(!(m.isSome(e)&&"hittest"===e.type||"heatmap"!==a.type)){var {defines:g}=this.loadQualityProfile(b);g=h.materialManager.getProgram(K,g);b.useProgram(g);b.bindFramebuffer(this._prevFBO);b.setViewport(0,0,this._prevViewport.width,this._prevViewport.height);b.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setStencilTestEnabled(!1);var {radius:n,minDensity:p,densityRange:q}=a;b.bindTexture(this._accumulateOutputTexture,8);b.bindTexture(this._resolveGradientTexture,
9);g.setUniform1i("u_texture",8);g.setUniform1i("u_gradient",9);g.setUniform2f("u_densityMinAndInvRange",p,1/q);g.setUniform1f("u_densityNormalization",3/(n*n*Math.PI));this._tileQuad.draw()}};d._loadResources=function({context:a,painter:b}){const {dataType:h,samplingMode:f,pixelFormat:e,internalFormat:g,shadingRate:n,requiresSharedStencilBuffer:p}=this.loadQualityProfile(a),{width:q,height:u}=this._prevViewport,r=q*n,t=u*n;this._accumulateOutputTexture??(this._accumulateOutputTexture=new z.Texture(a,
{target:c.TextureType.TEXTURE_2D,pixelFormat:e,internalFormat:g,dataType:h,samplingMode:f,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,width:r,height:t}));p||(this._accumulateOutputStencilBuffer??(this._accumulateOutputStencilBuffer=new I.Renderbuffer(a,{width:r,height:t,internalFormat:c.RenderbufferFormat.DEPTH_STENCIL})));this._accumulateFramebuffer??(this._accumulateFramebuffer=new G.FramebufferObject(a,{},this._accumulateOutputTexture,p?b.getSharedStencilBuffer():this._accumulateOutputStencilBuffer));
this._resolveGradientTexture??(this._resolveGradientTexture=new z.Texture(a,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,samplingMode:c.TextureSamplingMode.LINEAR,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE}));this._tileQuad??(this._tileQuad=new C(a,[0,0,1,0,0,1,1,1]))};d._updateResources=function(a,b){const {gradientHash:h,gradient:f}=b;this._prevGradientHash!==h&&(this._resolveGradientTexture.resize(f.length/4,1),this._resolveGradientTexture.setData(f),
this._prevGradientHash=h);const {shadingRate:e,requiresSharedStencilBuffer:g}=this.loadQualityProfile(a),{width:n,height:p}=this._prevViewport;b=n*e;const q=p*e,{width:u,height:r}=this._accumulateFramebuffer;if(u!==b||r!==q){const t=this._accumulateFramebuffer.depthStencilAttachment;if(g&&m.isSome(t)){const {width:x,height:L}=t.descriptor;if(x!==b||L!==q)A.errorOnce("Attempted to resize shared stencil buffer! Detaching instead."),this._accumulateFramebuffer.detachDepthStencilBuffer()}this._accumulateFramebuffer.resize(b,
q)}g||a.blitFramebuffer(this._prevFBO,this._accumulateFramebuffer,0,0,this._prevFBO.width,this._prevFBO.height,0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height,c.ClearBufferBit.STENCIL_BUFFER_BIT,c.TextureSamplingMode.NEAREST)};d.loadQualityProfile=function(a){if(m.isNone(this._qualityProfile)){const b=H.loadHeatmapTextureConfiguration(a,A);a=a.type===F.ContextType.WEBGL1;this._qualityProfile={...b,requiresSharedStencilBuffer:a,shadingRate:a?1:.25,defines:b.dataType!==c.PixelType.FLOAT?
["heatmapPrecisionHalfFloat"]:[]}}return this._qualityProfile};return l._createClass(k)}(E.Effect);return v});