// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../config ../../../../request ../../../../core/BidiText ../../../../core/Error ../../../../core/fontUtils ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./Utils ./animatedFormats/AnimatableTextureResource ./animatedFormats/utils ./util/Result ./util/symbolUtils ../../../support/QueueProcessor ../../../webgl/enums".split(" "),
function(x,D,E,F,n,G,H,y,v,w,r,z,I,J,k,t,K,L,M,N,g,O,P,Q,R,S,A){function B(l,f){f=Math.round(r.pt2px(f)*window.devicePixelRatio);return Math.min(l,f*(128<=f?2:4))}const C=I.create(),u=H.getLogger("esri.views.2d.engine.webgl.TextureManager");let T=function(){function l(f,a,c){this.mosaicType=f;this.page=a;this.sdf=c}l.fromMosaic=function(f,a){return new l(f,a.page,a.sdf)};return x._createClass(l)}();return function(){function l(a,c,b){this._requestRender=a;this.resourceManager=c;this._allowNonPowerOfTwo=
b;this._invalidFontsMap=new Map;this._sdfConverter=new M(k.SDF_TEXTURE_SIZE);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._ongoingRasterizations=new Map;this._imageRequestQueue=new S.QueueProcessor({concurrency:10,process:async(e,d)=>{w.throwIfAborted(d);try{return await E(e,{responseType:"image",signal:d})}catch(h){if(!w.isAbortError(h))throw new n("mapview-invalid-resource",`Could not fetch requested resource at ${e}`,h);throw h;}}});this._spriteMosaic=new N(2048,2048,500);this._glyphSource=
new L(`${D.fontsUrl}/{fontstack}/{range}.pbf`);this._glyphMosaic=new K(1024,1024,this._glyphSource);this._rasterizer=new J(c)}var f=l.prototype;f.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._sdfConverter.dispose();this._sdfConverter=this._glyphMosaic=this._spriteMosaic=null;this._hashToBindingIndex.clear();this._bindingInfos=this._hashToBindingIndex=null;this._ongoingRasterizations.clear();this._ongoingRasterizations=null;this._imageRequestQueue.clear();
this._imageRequestQueue=null};f.rasterizeItem=async function(a,c,b,e){if(v.isNone(a))return u.error(new n("mapview-null-resource","Unable to rasterize null resource",void 0)),null;switch(a.type){case "text":case "esriTS":return a=await this._rasterizeText(a,b,e),a.forEach(d=>this._setTextureBinding(t.MosaicType.GLYPH,d)),{glyphMosaicItems:a};default:if(g.is3D(a))return u.error(new n("mapview-invalid-type",`MapView does not support symbol type: ${a.type}`,a)),null;a=await this._rasterizeSpriteSymbol(a,
c,e);Q.ok(a)&&a&&this._setTextureBinding(t.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}};f.bindTextures=function(a,c,b,e=!1){if(0!==b.textureBinding){var d=this._bindingInfos[b.textureBinding-1];b=d.page;e=e?A.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:A.TextureSamplingMode.LINEAR;switch(d.mosaicType){case t.MosaicType.SPRITE:d=this.sprites.getWidth(b);const h=this.sprites.getHeight(b);d=z.set(C,d,h);this._spriteMosaic.bind(a,e,b,k.TEXTURE_BINDING_SPRITE_ATLAS);c.setUniform1i("u_texture",k.TEXTURE_BINDING_SPRITE_ATLAS);
c.setUniform2fv("u_mosaicSize",d);break;case t.MosaicType.GLYPH:d=z.set(C,this.glyphs.width,this.glyphs.height);this._glyphMosaic.bind(a,e,b,k.TEXTURE_BINDING_GLYPH_ATLAS);c.setUniform1i("u_texture",k.TEXTURE_BINDING_GLYPH_ATLAS);c.setUniform2fv("u_mosaicSize",d);break;default:u.error("mapview-texture-manager",`Cannot handle unknown type ${d.mosaicType}`)}}};f._hashMosaic=function(a,c){return 1|a<<1|(c.sdf?1:0)<<2|c.page<<3};f._setTextureBinding=function(a,c){const b=this._hashMosaic(a,c);this._hashToBindingIndex.has(b)||
(a=T.fromMosaic(a,c),this._hashToBindingIndex.set(b,this._bindingInfos.length+1),this._bindingInfos.push(a));c.textureBinding=this._hashToBindingIndex.get(b)};f._rasterizeText=async function(a,c,b){let e,d;e="cim"in a?a.fontName:G.getFullyQualifiedFontName(a.font);d=a.text;a=this._invalidFontsMap.has(e);c=c||g.charCodes(F.bidiText(d)[0]);try{return await this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":e,c,b)}catch(h){return u.error(new n("mapview-invalid-resource",`Couldn't find font ${e}. Falling back to Arial Unicode MS Regular`,
void 0)),this._invalidFontsMap.set(e,!0),this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",c,b)}};f._rasterizeSpriteSymbol=async function(a,c,b){if(!g.isSimple(a)){c=R.keyFromSymbol(a);if(this._spriteMosaic.has(c))return this._spriteMosaic.getSpriteItem(c);if(g.isSVGResource(a)||g.isImageResource(a)&&!g.isMarkerPlacementInsidePolygon(a))return this._handleAsyncResource(c,a,b);if(b=this._rasterizer.rasterizeJSONResource(a,k.PATTERN_FILL_RASTERIZATION_SCALE)){const {size:e,image:d,sdf:h,simplePattern:m,
rasterizationScale:p}=b;return this._addItemToMosaic(c,e,{type:"static",data:d},g.shouldRepeat(a),h,m,p)}return new n("TextureManager","unrecognized or null rasterized image")}};f._handleAsyncResource=async function(a,c,b){if(this._ongoingRasterizations.has(a))return this._ongoingRasterizations.get(a);c=g.isSVGResource(c)?this._handleSVG(c,a,b):this._handleImage(c,a,b);this._ongoingRasterizations.set(a,c);try{await c,this._ongoingRasterizations.delete(a)}catch{this._ongoingRasterizations.delete(a)}return c};
f._handleSVG=async function(a,c,b){const e=[k.SDF_TEXTURE_SIZE,k.SDF_TEXTURE_SIZE];a=await this._sdfConverter.draw(a.path,b);return this._addItemToMosaic(c,e,{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)};f._handleGIFOrPNG=async function(a,c,b){var e=g.getUrl(a);await this.resourceManager.fetchResource(e,b);b=this.resourceManager.getResource(e);if(v.isNone(b))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${e}.`);e=b.width;let d=b.height;if(b instanceof HTMLImageElement){"esriPMS"===
a.type&&(e=Math.round(B(b.width,g.getPMSResourceSize(a))),d=Math.round(e/b.width*b.height));const {size:h,sdf:m,image:p}=this._rasterizer.rasterizeImageResource(e,d,b,"cim"in a?a.cim.colorSubstitutions:void 0);return this._addItemToMosaic(c,h,{type:"static",data:p},g.shouldRepeat(a),m,!1)}this._allowNonPowerOfTwo||(e=y.nextPowerOfTwo(b.width+2*k.SPRITE_PADDING)-2*k.SPRITE_PADDING,d=y.nextPowerOfTwo(b.height+2*k.SPRITE_PADDING)-2*k.SPRITE_PADDING);if(e!==b.width||d!==b.height)b=P.resize(b,e,d);b=new O.AnimatableTextureResource(b,
this._requestRender,a.animatedSymbolProperties||{},a.objectId);return this._addItemToMosaic(c,[b.width,b.height],{type:"animated",data:b},g.shouldRepeat(a),!1,!1)};f._handleImage=async function(a,c,b){if(g.isGIF(a)||g.isPNG(a))return this._handleGIFOrPNG(a,c,b);const e=g.getUrl(a);try{let d;const h=this.resourceManager.getResource(e);if(v.isSome(h)&&h instanceof HTMLImageElement)d=h;else{const {data:q}=await this._imageRequestQueue.push(e,{...b});d=q}if(g.isSVGImage(e))if("width"in a&&"height"in a)d.width=
r.pt2px(a.width),d.height=r.pt2px(a.height);else if("cim"in a){const q=a.cim;d.width=r.pt2px(q.width??q.scaleX*q.size);d.height=r.pt2px(q.size)}if(!d.width||!d.height)return null;let m=d.width,p=d.height;"esriPMS"===a.type&&(m=Math.round(B(d.width,g.getPMSResourceSize(a))),p=Math.round(m/d.width*d.height));const {size:U,sdf:V,image:W}=this._rasterizer.rasterizeImageResource(m,p,d,"cim"in a?a.cim.colorSubstitutions:void 0);return this._addItemToMosaic(c,U,{type:"static",data:W},g.shouldRepeat(a),V,
!1)}catch(d){if(!w.isAbortError(d))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${e}. ${d.message}`)}};f._addItemToMosaic=function(a,c,b,e,d,h,m){return this._spriteMosaic.addSpriteItem(a,c,b,e,d,h,m)};x._createClass(l,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]);return l}()});