// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/mat3 ../../../../chunks/mat3f32 ../../../../chunks/vec2f32 ../../../../layers/support/rasterFunctions/pixelUtils ../DisplayObject ../../../webgl/enums ../../../webgl/rasterUtils".split(" "),function(m,k,l,h,v,n,w,p,u,q){const x={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,
stretchType:"none",type:"stretch"};p=function(d){function g(a=null,c=null,e=null){var b=r.call(this);b._textureInvalidated=!0;b._colormapTextureInvalidated=!0;b._rasterTexture=null;b._rasterTextureBandIds=null;b._transformGridTexture=null;b._colormapTexture=null;b._colormap=null;b._supportsBilinearTexture=!0;b._processedTexture=null;b.functionTextures=[];b.projected=!1;b.stencilRef=0;b.coordScale=[1,1];b._processed=!1;b._symbolizerParameters=null;b.height=null;b.isRendereredSource=!1;b.pixelRatio=
1;b.resolution=0;b.rotation=0;b._source=null;b.rawPixelData=null;b._suspended=!1;b._bandIds=null;b._interpolation=null;b._transformGrid=null;b.width=null;b.x=0;b.y=0;b.source=a;b.transformGrid=c;b.interpolation=e;return b}k._inherits(g,d);var r=k._createSuper(g);d=g.prototype;d.destroy=function(){this._disposeTextures()};d.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())};d._createTransforms=function(){return{dvs:v.create()}};d.setTransform=
function(a){const c=h.identity(this.transforms.dvs),[e,b]=a.toScreenNoRotation([0,0],[this.x,this.y]);var f=this.resolution/this.pixelRatio/a.resolution;const t=f*this.width;f*=this.height;const y=Math.PI*this.rotation/180;h.translate(c,c,n.fromValues(e,b));h.translate(c,c,n.fromValues(t/2,f/2));h.rotate(c,c,-y);h.translate(c,c,n.fromValues(-t/2,-f/2));h.scaleByVec2(c,c,n.fromValues(t,f));h.multiply(this.transforms.dvs,a.displayViewMat3,c)};d.getTextures=function({forProcessing:a=!1,useProcessedTexture:c=
!1}={}){const e=c?this._processedTexture??this._rasterTexture:this._rasterTexture,b=[],f=[];if(!e)return{names:b,textures:f};if(c)return f.push(e),b.push("u_image"),this._colormapTexture&&(f.push(this._colormapTexture),b.push("u_colormap")),{names:b,textures:f};this._transformGridTexture&&(f.push(this._transformGridTexture),b.push("u_transformGrid"));f.push(e);b.push("u_image");this._colormapTexture&&!a&&(f.push(this._colormapTexture),b.push("u_colormap"));return{names:b,textures:f}};d.onAttach=function(){this.invalidateTexture()};
d.onDetach=function(){this.invalidateTexture()};d.updateTexture=function({context:a}){if(this.stage){var c=this._isValidSource(this.source);c&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(a));this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(a),this._rasterTexture&&(c?this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=q.createTransformTexture(a,this.transformGrid)):this._rasterTexture.setData(null)),
this.suspended||(this.ready(),this.requestRender()))}else this._disposeTextures()};d.updateProcessedTexture=function(){const {functionTextures:a}=this;0!==a.length&&(this.processedTexture=a.shift(),a.forEach(c=>c?.dispose()),a.length=0)};d._createOrDestroyRasterTexture=function(a){const c=l.isSome(this.source)?w.extractBands(this.source,this.bandIds):null;if(this._isValidSource(c)){var e=!this._isBandIdschanged(this.bandIds);if(this._rasterTexture){if(e)return;this._rasterTexture.dispose();this._rasterTexture=
this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!a.capabilities.textureFloat?.textureFloatLinear;e=this._getTextureSamplingMethod(this.interpolation);this._rasterTexture=q.createRasterTexture(a,c,e,this.isRendereredSource||!a.capabilities.textureFloat?.textureFloat);this._processed=this.projected=!1;this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}else this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTexture=this._rasterTextureBandIds=null)};d._isBandIdschanged=
function(a){const c=this._rasterTextureBandIds;return!(null==c&&null==a||c&&a&&c.join("")===a.join(""))};d._isValidSource=function(a){return l.isSome(a)&&0<a.pixels?.length};d._getTextureSamplingMethod=function(a){const {type:c,colormap:e}=this.symbolizerParameters,b="lut"===c||"stretch"===c&&l.isSome(e);return!this._supportsBilinearTexture||b||"bilinear"!==a&&"cubic"!==a?"nearest":"bilinear"};d._updateColormapTexture=function(a){const c=this._colormap,e=this.symbolizerParameters.colormap;if(!e)this._colormapTexture&&
(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormap=null;else if(!c)this._colormapTexture=q.createColormapTexture(a,e),this._colormap=e;else if(e.length!==c.length||e.some((b,f)=>b!==c[f]))this._colormapTexture&&(this._colormapTexture.dispose(),this._colormapTexture=null),this._colormapTexture=q.createColormapTexture(a,e),this._colormap=e};d._disposeTextures=function(a=!1){this._transformGridTexture&&(this._transformGridTexture.dispose(),this._transformGridTexture=null);!a&&
this._colormapTexture&&(this._colormapTexture.dispose(),this._colormap=this._colormapTexture=null,this._colormapTextureInvalidated=!0);!a&&this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=this._rasterTexture=null);this._processedTexture&&(this._processedTexture.dispose(),this._processedTexture=null)};k._createClass(g,[{key:"processedTexture",get:function(){return this._processedTexture},set:function(a){this._processedTexture!==a&&(this._disposeTextures(!0),this._processedTexture=
a)}},{key:"rasterTexture",get:function(){return this._rasterTexture},set:function(a){this._rasterTexture!==a&&(this._rasterTexture?.dispose(),this._rasterTexture=a)}},{key:"processed",get:function(){return this._processed},set:function(a){this._processed=a;a||(l.disposeMaybe(this.processedTexture),this.invalidateTexture())}},{key:"symbolizerParameters",get:function(){return this._symbolizerParameters||x},set:function(a){this._symbolizerParameters!==a&&(this._symbolizerParameters=a,this._colormapTextureInvalidated=
!0,this.commonUniforms=null)}},{key:"source",get:function(){return this._source},set:function(a){this._source!==a&&(this._source=a,this._rasterTexture&&(this._rasterTexture.dispose(),this._rasterTextureBandIds=this._rasterTexture=null),this.projected=!1,this.invalidateTexture())}},{key:"suspended",get:function(){return this._suspended},set:function(a){this._suspended&&!a&&this.stage&&(this.ready(),this.requestRender());this._suspended=a}},{key:"bandIds",get:function(){return this._bandIds},set:function(a){this._bandIds=
a;this._isBandIdschanged(a)&&(this.projected=!1,this.invalidateTexture())}},{key:"interpolation",get:function(){return this._interpolation||"nearest"},set:function(a){this._interpolation=a;this._rasterTexture&&this._rasterTexture.setSamplingMode("bilinear"===this._getTextureSamplingMethod(a||"nearest")?u.TextureSamplingMode.LINEAR:u.TextureSamplingMode.NEAREST)}},{key:"transformGrid",get:function(){return this._transformGrid},set:function(a){this._transformGrid=a;this._transformGridTexture=l.disposeMaybe(this._transformGridTexture)}}]);
return g}(p.DisplayObject);let z=function(d){function g(){return r.apply(this,arguments)}k._inherits(g,d);var r=k._createSuper(g);k._createClass(g,[{key:"source",get:function(){return this._source}}]);return g}(p);m.RasterBitmap=p;m.RasterBitmapWithSource=z;m.hasSource=function(d){return l.isSome(d.source)};Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});