// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Error ../../../../../core/Logger ../../../../../core/LRUCache ../../../../../core/maybe ../../../../../support/arcadeOnDemand ../../../arcade/callExpressionWithFeature ../../../layers/support/cimSymbolUtils".split(" "),function(A,t,m,F,G,H,I,J,K,q){async function B(f,e,h,a){switch(f.type){case "simple":case "heatmap":return u.fromBasicRenderer(f,e,h,a);case "map":return C.fromUVRenderer(f,e,h,a);case "interval":return D.fromCBRenderer(f,
e,h,a);case "dictionary":return E.fromDictionaryRenderer(f,e,h,a);case "pie-chart":return w.fromPieChartRenderer(f,e,h,a);case "subtype":return w.fromSubtypes(f,e,h,a)}}async function L(f,e){const h=f||1;if("number"===typeof h)return(b,d,c)=>h;const a=await J.createRendererExpression(h,e.spatialReference,e.fields);return(b,d,c)=>K(a,b,{$view:c},e.geometryType,d)||1}async function M(){x||(x=new Promise((f,e)=>A(["../../../layers/features/createSymbolSchema"],f,e)));return x}const y=G.getLogger("esri/views/2d/engine/webgl/util/Matcher");
let u=function(){function f(){this.type="feature";this._defaultResult=null}f.fromBasicRenderer=async function(h,a,b,d){const c=new f;h.symbol&&(h=await q.expandSymbol(h.symbol,b,d),a=a.createTemplateGroup(h,null),c.setDefault(a));return c};f.fromPieChartRenderer=async function(h,a,b,d){const c=new f;if(h.markerSymbol){const g=await q.expandSymbol(h.markerSymbol,b,d);let k;h.fillSymbol&&(k=await q.expandSymbol(h.fillSymbol,b,d));h=a.createTemplateGroup(g,k);c.setDefault(h)}return c};var e=f.prototype;
e.size=function(){return 1};e.getDefault=function(){return this._defaultResult};e.setDefault=function(h){this._defaultResult=h};e.match=function(h,a,b,d,c){return this.getDefault()};e.analyze=async function(h,a,b,d,c,g){return null};return m._createClass(f)}(),w=function(f){function e(a,b){var d=h.call(this);d._subMatchers=a;d._subtypeField=b;return d}m._inherits(e,f);var h=m._createSuper(e);e.fromSubtypes=async function(a,b,d,c){const g=new Map,k=[];for(const l in a.renderers){const n=parseInt(l,
10),p=B(a.renderers[l],b,d,c).then(r=>g.set(n,r));k.push(p)}await Promise.all(k);return new e(g,a.subtypeField)};e.prototype.match=function(a,b,d,c,g){var k=b.readAttribute(this._subtypeField);return(k=this._subMatchers.get(k))?k.match(a,b,d,c,g):null};return m._createClass(e)}(u),D=function(f){function e(a,b,d,c){var g=h.call(this);g.type="interval";g._intervals=[];g._isMaxInclusive=b;g._fieldIndex=c;g._field=a;g._normalizationInfo=d;return g}m._inherits(e,f);var h=m._createSuper(e);e.fromCBRenderer=
async function(a,b,d,c){const {isMaxInclusive:g,normalizationField:k,normalizationTotal:l,normalizationType:n}=a,p=new e(a.field,g,{normalizationField:k,normalizationTotal:l,normalizationType:n},a.fieldIndex),r=await q.expandSymbol(a.backgroundFillSymbol,d,c);await Promise.all(a.intervals.map(async v=>{var z=await q.expandSymbol(v.symbol,d,c);z=await b.createTemplateGroup(z,r);p.add({min:v.min,max:v.max},z)}));if(a=await q.expandSymbol(a.defaultSymbol,d,c))a=await b.createTemplateGroup(a,r),p.setDefault(a);
return p};f=e.prototype;f.add=function(a,b){this._intervals.push({interval:a,result:b});this._intervals.sort((d,c)=>d.interval.min-c.interval.min)};f.size=function(){return m._get(m._getPrototypeOf(e.prototype),"size",this).call(this)+this._intervals.length};f.match=function(a,b,d,c,g){if(null==this._fieldIndex&&!this._field)return this.getDefault();a=null!=this._fieldIndex?b.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(b);if(null===a||void 0===a||isNaN(a)||Infinity===a||-Infinity===
a)return this.getDefault();for(b=0;b<this._intervals.length;b++){const {interval:k,result:l}=this._intervals[b];d=this._isMaxInclusive?a<=k.max:a<k.max;if(a>=k.min&&d)return l}return this.getDefault()};f._needsNormalization=function(){const a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};f._getValueFromField=function(a){const b=a.readAttribute(this._field);if(!this._needsNormalization()||null==b)return b;const {normalizationField:d,normalizationTotal:c,
normalizationType:g}=this._normalizationInfo;a=a.readAttribute(d)??1;if(g)switch(g){case "esriNormalizeByField":return(a||void 0)&&b/a;case "esriNormalizeByLog":return Math.log(b)*Math.LOG10E;case "esriNormalizeByPercentOfTotal":return b/c*100;default:y.error(`Found unknown normalization type: ${g}`)}else y.error("Normalization is required, but no type was set!")};return m._createClass(e)}(u),C=function(f){function e(a,b,d){var c=h.call(this);c.type="map";c._nullResult=null;c._resultsMap=new Map;
c._fields=[];c._fieldsIndex=d;c._fields=a;c._seperator=b||"";return c}m._inherits(e,f);var h=m._createSuper(e);e.fromUVRenderer=async function(a,b,d,c){const g=a.fieldDelimiter,k=[a.field];a.field2&&k.push(a.field2);a.field3&&k.push(a.field3);const l=await q.expandSymbol(a.backgroundFillSymbol,d,c),n=new e(k,g,a.fieldIndex);await Promise.all(a.map.map(async(p,r)=>{const v=await q.expandSymbol(p.symbol,d,c);r=await b.createTemplateGroup(v,l,r+1);"\x3cNull\x3e"===p.value?n.setNullResult(r):n.add(p.value,
r)}));if(a=await q.expandSymbol(a.defaultSymbol,d,c))a=await b.createTemplateGroup(a,l,Number.MAX_SAFE_INTEGER),n.setDefault(a);return n};f=e.prototype;f.setNullResult=function(a){this._nullResult=a};f.add=function(a,b){this._resultsMap.set(a.toString(),b)};f.size=function(){return m._get(m._getPrototypeOf(e.prototype),"size",this).call(this)+this._resultsMap.size};f.match=function(a,b,d,c,g){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();a=null!=this._fieldsIndex?b.getComputedStringAtIndex(this._fieldsIndex):
this._getValueFromFields(b);if(null!==this._nullResult&&(null==a||""===a||"\x3cNull\x3e"===a))return this._nullResult;if(null==a)return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()};f._getValueFromFields=function(a){const b=[];for(const d of this._fields){const c=a.readAttribute(d);null==c||""===c?b.push("\x3cNull\x3e"):b.push(c)}return b.join(this._seperator)};return m._createClass(e)}(u),x,E=function(f){function e(a,b,d,c,g,k){var l=h.call(this);
l.type="dictionary";l._groupIdCache=new H(100);l._loader=a;l._fieldMap=a.fieldMap;l._symbolFields=a.getSymbolFields();l._templates=b;l._info=d;l._scaleFn=c;l._schemaUtilsModule=g;l._symbolOptions=k;return l}m._inherits(e,f);var h=m._createSuper(e);e.fromDictionaryRenderer=async function(a,b,d,c){const [{DictionaryLoader:g},k]=await Promise.all([new Promise((n,p)=>A(["../../../../../renderers/support/DictionaryLoader"],n,p)),M()]);c=new g(a.url,a.config,a.fieldMap);await c.fetchResources({spatialReference:d.spatialReference,
fields:d.fields});const l=await L(a.scaleExpression,d);return new e(c,b,d,l,k,a.symbolOptions)};f=e.prototype;f._analyzeFeature=async function(a,b,d,c,g){a=a.readLegacyFeature();const k=this._scaleFn(a,d,c);d=this._attributeHash(a)+"-"+k;const l=this._groupIdCache.get(d);if(l)return l;c=await this._loader.getSymbolAsync(a,{...c,spatialReference:this._info.spatialReference,abortOptions:g,fields:this._info.fields});c=this._schemaUtilsModule.createSymbolSchema(c,this._symbolOptions);b=q.expandSymbol(c,
this._info,b,g).then(n=>{if("expanded-cim"!==n?.type)return y.error(new F("mapview-bad-type",`Found unexpected type ${n?.type} in dictionary response`)),null;n.hash+="-"+k;for(const p of n.layers)p.scaleFactor=k,p.templateHash+="-"+k;return this._templates.createTemplateGroup(n,null)});this._groupIdCache.put(d,b,1);return b};f.analyze=async function(a,b,d,c,g,k){a=b.getCursor();for(b=[];a.next();)b.push(this._analyzeFeature(a,d,c,g,k));return Promise.all(b).then(l=>l.filter(I.isSome))};f.match=function(a,
b,d,c,g){return null};f._attributeHash=function(a){let b="";for(const d of this._symbolFields){const c=this._fieldMap?.[d];c&&(b+=a.attributes[c]+"-")}return b};return m._createClass(e)}(u);t.DictionaryMatcher=E;t.FeatureMatcher=u;t.IntervalMatcher=D;t.MapMatcher=C;t.SubtypeMatcher=w;t.createMatcher=B;Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});