// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Error ../../../core/events ../../../core/has ../../../core/maybe ../../../core/scheduling ../../../chunks/mat3f32 ../../../symbols/cim/CIMResourceManager ./Container ./webgl/BufferPool ./webgl/enums ./webgl/Painter ./webgl/Profiler ../support/Timeline ../../support/screenshotUtils ../../webgl/context-util ../../webgl/enums ../../webgl/FramebufferObject ../../webgl/RenderingContext ../../../core/imageUtils".split(" "),function(q,
k,w,x,u,r,y,z,A,v,B,n,C,D,E,F,G,p,H,I,J){let L=function(f){function m(a,c){var b=K.call(this);b._trash=new Set;b._renderRemainingTime=0;b._lastFrameRenderTime=0;b.renderRequested=!1;b.stage=k._assertThisInitialized(b);b._stationary=!0;const {canvas:d=document.createElement("canvas"),alpha:e=!0,stencil:g=!0,contextOptions:h={}}=c;b._canvas=d;const l=G.createContextOrErrorHTML("2d",d,{alpha:e,antialias:!1,depth:!0,stencil:g});b.context=new I.RenderingContext(r.unwrap(l)??null,h);b.resourceManager=new A;
b.painter=new C(b.context,k._assertThisInitialized(b),b.resourceManager);u("esri-2d-profiler")&&(b._debugOutput=document.createElement("div"),b._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),a.appendChild(b._debugOutput));b._renderParameters={drawPhase:0,state:b.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:b.context,painter:b.painter,timeline:c.timeline||new E.Timeline,
renderingOptions:c.renderingOptions,requestRender:()=>b.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new D.Profiler(b.context,b._debugOutput),dataUploadCounter:0,get highlightGradient(){return b._highlightGradient}};b._taskHandle=y.addFrameTask({render:t=>b.renderFrame(t)});b._taskHandle.pause();b._lostWebGLContextHandle=x.on(d,"webglcontextlost",t=>{b.emit("webgl-error",{error:new w("webgl-context-lost",t.statusMessage)})});b._bufferPool=new B.BufferPool;d.setAttribute("style","width: 100%; height:100%; display:block;");
a.appendChild(d);return b}k._inherits(m,f);var K=k._createSuper(m);f=m.prototype;f.destroy=function(){this.removeAllChildren();this._emptyTrash();this._taskHandle=r.removeMaybe(this._taskHandle);this._lostWebGLContextHandle=r.removeMaybe(this._lostWebGLContextHandle);this._canvas.parentNode?.removeChild(this._canvas);this._debugOutput?.parentNode?.removeChild(this._debugOutput);this._bufferPool.destroy();this.resourceManager.destroy();this.painter.dispose();this.context.dispose();this._canvas=null};
f.trashDisplayObject=function(a){this._trash.add(a);this.requestRender()};f.untrashDisplayObject=function(a){return this._trash.delete(a)};f.requestRender=function(){this._renderRemainingTime=2E3;this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())};f.renderFrame=function(a){this._renderRemainingTime-=this._lastFrameRenderTime?a.time-this._lastFrameRenderTime:0;0>=this._renderRemainingTime&&this._taskHandle.pause();this._lastFrameRenderTime=a.time;this.renderRequested=
!1;this._renderParameters.state=this._state;this._renderParameters.stationary=this.stationary;this._renderParameters.pixelRatio=window.devicePixelRatio;this._renderParameters.globalOpacity=1;this._renderParameters.time=a.time;this._renderParameters.deltaTime=a.deltaTime;this._renderParameters.effects=null;this.processRender(this._renderParameters);this._emptyTrash();this.emit("post-render")};f._createTransforms=function(){return{dvs:z.create()}};f.renderChildren=function(a){for(const c of this.children)c.beforeRender(a);
this._renderChildren(this.children,a);for(const c of this.children)c.afterRender(a)};f._renderChildren=function(a,c){const b=this.context;this.painter.textureUploadManager.upload();b.resetInfo();c.profiler.recordStart("drawLayers");c.dataUploadCounter=0;c.drawPhase=n.WGLDrawPhase.MAP;this.painter.beforeRenderLayers(b,this.background);for(const d of a)d.processRender(c);this.painter.prepareDisplay(c,this.background,this.state.padding);this.painter.renderLayers(b);c.drawPhase=n.WGLDrawPhase.HIGHLIGHT;
this.painter.beforeRenderLayers(b);for(const d of a)d.processRender(c);this.painter.renderLayers(b);if(this._isLabelDrawPhaseRequired(a)){c.drawPhase=n.WGLDrawPhase.LABEL;this.painter.beforeRenderLayers(b);for(const d of a)d.processRender(c);this.painter.renderLayers(b)}if(u("esri-tiles-debug")){c.drawPhase=n.WGLDrawPhase.DEBUG;this.painter.beforeRenderLayers(b);for(const d of a)d.processRender(c);this.painter.renderLayers(b)}c.profiler.recordEnd("drawLayers");b.logInfo()};f.doRender=function(a){const c=
this.context,{state:b,pixelRatio:d}=a;this._resizeCanvas(a);c.setViewport(0,0,d*b.size[0],d*b.size[1]);c.setDepthWriteEnabled(!0);c.setStencilWriteMask(255);k._get(k._getPrototypeOf(m.prototype),"doRender",this).call(this,a)};f.takeScreenshot=async function(a){const {framebufferWidth:c,framebufferHeight:b}={framebufferWidth:Math.round(this.state.size[0]*a.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*a.resolutionScale)};var d=a.resolutionScale,e=this.context,g=this._state.clone();
if(null!=a.rotation){var h=g.viewpoint;g.viewpoint.rotation=a.rotation;g.viewpoint=h}h={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:g,pixelRatio:d,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};const l=new H.FramebufferObject(e,{colorTarget:p.TargetType.TEXTURE,depthStencilTarget:p.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER,width:c,height:b});d=e.getBoundFramebufferObject();g=e.getViewport();e.bindFramebuffer(l);e.setViewport(0,
0,c,b);this._renderChildren(a.children,h);h=this._readbackScreenshot(l,{...a.cropArea,y:b-(a.cropArea.y+a.cropArea.height)});e.bindFramebuffer(d);e.setViewport(g.x,g.y,g.width,g.height);this.requestRender();e=await h;1===a.outputScale?a=e:(a=new ImageData(Math.round(e.width*a.outputScale),Math.round(e.height*a.outputScale)),F.resampleHermite(e,a,!0));return a};f._readbackScreenshot=async function(a,c){const b=J.createEmptyImageData(c.width,c.height,document.createElement("canvas"));await a.readPixelsAsync(c.x,
c.y,c.width,c.height,p.PixelFormat.RGBA,p.PixelType.UNSIGNED_BYTE,new Uint8Array(b.data.buffer));return b};f._resizeCanvas=function(a){const c=this._canvas,b=c.style,{state:{size:d},pixelRatio:e}=a;a=d[0];const g=d[1],h=Math.round(a*e),l=Math.round(g*e);if(c.width!==h||c.height!==l)c.width=h,c.height=l;b.width=a+"px";b.height=g+"px"};f._emptyTrash=function(){for(;0<this._trash.size;){const a=Array.from(this._trash);this._trash.clear();for(const c of a)c.processDetach()}};f._isLabelDrawPhaseRequired=
function(a){let c=!1;for(const b of a){if(!(b instanceof v.Container)){c=c||!1;break}if(b.hasLabels)return!0;c=c||this._isLabelDrawPhaseRequired(b.children)}return c};k._createClass(m,[{key:"background",get:function(){return this._background},set:function(a){this._background=a;this.requestRender()}},{key:"bufferPool",get:function(){return this._bufferPool}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(a){this._renderingOptions=a;this.requestRender()}},{key:"state",
get:function(){return this._state},set:function(a){this._state=a;this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(a){this._stationary!==a&&(this._stationary=a,this.requestRender())}}]);return m}(v.Container);q.EXTRA_RENDER_TIME=2E3;q.Stage=L;Object.defineProperty(q,Symbol.toStringTag,{value:"Module"})});