// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../chunks/vec2f32 ../../vectorTiles/decluttering/config ../../vectorTiles/style/StyleDefinition ../definitions ../enums ../GeometryUtils ../number ./WGLBrush ../../../../webgl/enums".split(" "),function(O,J,E,P,Q,m,F,K,R,S,L,n){const T=1/65536;L=function(t){function G(){var d=U.apply(this,arguments);d._iconProgramOptions={id:!1,sdf:!1};d._sdfProgramOptions={id:!1};d._spritesTextureSize=P.create();
return d}J._inherits(G,t);var U=J._createSuper(G);t=G.prototype;t.dispose=function(){};t.drawMany=function(d,a){const {drawPhase:g,styleLayerUID:k}=d,f=d.styleLayer;let b;g===K.WGLDrawPhase.HITTEST&&(b=S.u32to4Xu8(k+1));this._drawIcons(d,f,a,b);this._drawText(d,f,a,b)};t._drawIcons=function(d,a,g,k){const {context:f,displayLevel:b,drawPhase:r,painter:p,spriteMosaic:M,state:w,styleLayerUID:x,requestRender:u,allowDelayedRender:y}=d,C=a.iconMaterial;var h=p.vectorTilesMaterialManager,z=!1;for(var q of g)if(q.layerData.has(x)){var e=
q.layerData.get(x);if(0<e.iconPerPageElementsMap.size){z=!0;break}}if(z){z=a.getPaintValue("icon-translate",b);q=a.getPaintValue("icon-translate-anchor",b);var c=a.getLayoutValue("icon-rotation-alignment",b);c===m.RotationAlignment.AUTO&&(c=a.getLayoutValue("symbol-placement",b)===m.SymbolPlacement.POINT?m.RotationAlignment.VIEWPORT:m.RotationAlignment.MAP);var A=c===m.RotationAlignment.MAP;A=a.getLayoutValue("icon-keep-upright",b)&&A;var H=e.isIconSDF;e=r===K.WGLDrawPhase.HITTEST;var D=this._iconProgramOptions;
D.id=e;D.sdf=H;h=h.getMaterialProgram(f,C,D);if(y&&E.isSome(u)&&!h.compiled)u();else{f.useProgram(h);h.setUniformMatrix3fv("u_displayViewMat3",c===m.RotationAlignment.MAP?w.displayViewMat3:w.displayMat3);h.setUniformMatrix3fv("u_displayMat3",q===m.TranslateAnchor.VIEWPORT?w.displayMat3:w.displayViewMat3);h.setUniform2fv("u_iconTranslation",z);h.setUniform1f("u_depth",a.z);h.setUniform1f("u_mapRotation",R.degToByte(w.rotation));h.setUniform1f("u_keepUpright",A?1:0);h.setUniform1f("u_level",10*b);h.setUniform1i("u_texture",
F.VTL_TEXTURE_BINDING_UNIT_SPRITES);h.setUniform1f("u_fadeDuration",Q.FADE_DURATION/1E3);e&&h.setUniform4fv("u_id",k);k=-1;for(const v of g)if(v.layerData.has(x)&&(v.key.level!==k&&(k=v.key.level,C.setDataUniforms(h,b,a,k,M)),e=v.layerData.get(x),0!==e.iconPerPageElementsMap.size&&(e.prepareForRendering(f),e.updateOpacityInfo(),g=e.iconVertexArrayObject,!E.isNone(g)))){f.bindVAO(g);h.setUniformMatrix3fv("u_dvsMat3",v.transforms.dvs);h.setUniform1f("u_time",(performance.now()-e.lastOpacityUpdate)/
1E3);for(const [N,I]of e.iconPerPageElementsMap)this._renderIconRange(d,h,I,N,v)}}}};t._renderIconRange=function(d,a,g,k,f){const {context:b,spriteMosaic:r}=d;this._spritesTextureSize[0]=r.getWidth(k)/4;this._spritesTextureSize[1]=r.getHeight(k)/4;a.setUniform2fv("u_mosaicSize",this._spritesTextureSize);r.bind(b,n.TextureSamplingMode.LINEAR,k,F.VTL_TEXTURE_BINDING_UNIT_SPRITES);b.setStencilTestEnabled(!0);b.setStencilFunction(n.CompareFunction.GREATER,255,255);b.setStencilWriteMask(0);b.drawElements(n.PrimitiveType.TRIANGLES,
g[1],n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*g[0]);f.triangleCount+=g[1]/3};t._drawText=function(d,a,g,k){const {context:f,displayLevel:b,drawPhase:r,glyphMosaic:p,painter:M,pixelRatio:w,spriteMosaic:x,state:u,styleLayerUID:y,requestRender:C,allowDelayedRender:h}=d;d=a.textMaterial;const z=M.vectorTilesMaterialManager;var q=!1;for(var e of g)if(e.layerData.has(y)){var c=e.layerData.get(y);if(0<c.glyphPerPageElementsMap.size){q=!0;break}}if(q&&(c=a.getPaintProperty("text-opacity"),!c||
c.isDataDriven||0!==c.getValue(b))){c=a.getPaintProperty("text-color");var A=!c||c.isDataDriven||0<c.getValue(b)[3];c=a.getPaintProperty("text-halo-width");e=a.getPaintProperty("text-halo-color");var H=(!c||c.isDataDriven||0<c.getValue(b))&&(!e||e.isDataDriven||0<e.getValue(b)[3]);if(A||H){c=a.getLayoutValue("text-rotation-alignment",b);c===m.RotationAlignment.AUTO&&(c=a.getLayoutValue("symbol-placement",b)===m.SymbolPlacement.POINT?m.RotationAlignment.VIEWPORT:m.RotationAlignment.MAP);e=c===m.RotationAlignment.MAP;
e=a.getLayoutValue("text-keep-upright",b)&&e;q=r===K.WGLDrawPhase.HITTEST;var D=.8*3/w;this._glyphTextureSize||(this._glyphTextureSize=P.fromValues(p.width/4,p.height/4));var v=a.getPaintValue("text-translate",b),N=a.getPaintValue("text-translate-anchor",b),I=this._sdfProgramOptions;I.id=q;var l=z.getMaterialProgram(f,d,I);if(h&&E.isSome(C)&&!l.compiled)C();else{f.useProgram(l);l.setUniformMatrix3fv("u_displayViewMat3",c===m.RotationAlignment.MAP?u.displayViewMat3:u.displayMat3);l.setUniformMatrix3fv("u_displayMat3",
N===m.TranslateAnchor.VIEWPORT?u.displayMat3:u.displayViewMat3);l.setUniform2fv("u_textTranslation",v);l.setUniform1f("u_depth",a.z+T);l.setUniform2fv("u_mosaicSize",this._glyphTextureSize);l.setUniform1f("u_mapRotation",R.degToByte(u.rotation));l.setUniform1f("u_keepUpright",e?1:0);l.setUniform1f("u_level",10*b);l.setUniform1i("u_texture",F.VTL_TEXTURE_BINDING_UNIT_GLYPHS);l.setUniform1f("u_antialiasingWidth",D);l.setUniform1f("u_fadeDuration",Q.FADE_DURATION/1E3);q&&l.setUniform4fv("u_id",k);k=
-1;for(const B of g)B.layerData.has(y)&&(B.key.level!==k&&(k=B.key.level,d.setDataUniforms(l,b,a,k,x)),c=B.layerData.get(y),0!==c.glyphPerPageElementsMap.size&&(c.prepareForRendering(f),c.updateOpacityInfo(),g=c.textVertexArrayObject,E.isNone(g)||(f.bindVAO(g),l.setUniformMatrix3fv("u_dvsMat3",B.transforms.dvs),f.setStencilTestEnabled(!0),f.setStencilFunction(n.CompareFunction.GREATER,255,255),f.setStencilWriteMask(0),g=(performance.now()-c.lastOpacityUpdate)/1E3,l.setUniform1f("u_time",g),c.glyphPerPageElementsMap.forEach((V,
W)=>{this._renderGlyphRange(f,V,W,p,l,H,A,B)}))))}}}};t._renderGlyphRange=function(d,a,g,k,f,b,r,p){k.bind(d,n.TextureSamplingMode.LINEAR,g,F.VTL_TEXTURE_BINDING_UNIT_GLYPHS);b&&(f.setUniform1f("u_halo",1),d.drawElements(n.PrimitiveType.TRIANGLES,a[1],n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),p.triangleCount+=a[1]/3);r&&(f.setUniform1f("u_halo",0),d.drawElements(n.PrimitiveType.TRIANGLES,a[1],n.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),p.triangleCount+=a[1]/3)};return J._createClass(G)}(L);
O.WGLBrushVTLSymbol=L;Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})});