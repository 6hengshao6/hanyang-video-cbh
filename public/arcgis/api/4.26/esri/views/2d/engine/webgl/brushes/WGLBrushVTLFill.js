// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../vectorTiles/style/StyleDefinition ../definitions ../enums ../number ./WGLBrush ../../../../webgl/enums".split(" "),function(J,G,x,K,C,H,P,I,p){const L=1/65536;I=function(A){function D(){var d=Q.apply(this,arguments);d._fillProgramOptions={id:!1,pattern:!1};d._outlineProgramOptions={id:!1};return d}G._inherits(D,A);var Q=G._createSuper(D);A=D.prototype;A.dispose=function(){};A.drawMany=function(d,u){const {displayLevel:k,
drawPhase:c,renderPass:h,spriteMosaic:f,styleLayerUID:m}=d;var a=!1;for(var l of u)if(l.layerData.has(m)){var q=l.layerData.get(m);if(0<q.fillIndexCount||0<q.outlineIndexCount){a=!0;break}}if(a){a=d.styleLayer;var g=a.getPaintProperty("fill-pattern");q=(l=void 0!==g)&&g.isDataDriven;if(l&&!q){var r=g.getValue(k);r=f.getMosaicItemPosition(r,!0)}g=!l&&a.getPaintValue("fill-antialias",k);var y=!0,v=1;if(!l){var w=a.getPaintProperty("fill-color"),z=a.getPaintProperty("fill-opacity");w?.isDataDriven||
z?.isDataDriven||(v=a.getPaintValue("fill-color",k),v=a.getPaintValue("fill-opacity",k)*v[3],1<=v&&(y=!1))}if(!y||"opaque"!==h){var b;c===H.WGLDrawPhase.HITTEST&&(b=P.u32to4Xu8(m+1));w=a.getPaintValue("fill-translate",k);z=a.getPaintValue("fill-translate-anchor",k);(y||"translucent"!==h)&&this._drawFill(d,m,a,u,w,z,l,r,q,b);r=!a.hasDataDrivenOutlineColor&&a.outlineUsesFillColor&&1>v;g&&"opaque"!==h&&!r&&this._drawOutline(d,m,a,u,w,z,b)}}};A._drawFill=function(d,u,k,c,h,f,m,a,l,q){if(!m||l||!x.isNone(a)){var {context:g,
displayLevel:r,state:y,drawPhase:v,painter:w,pixelRatio:z,spriteMosaic:b,requestRender:E,allowDelayedRender:F}=d;d=k.fillMaterial;var e=w.vectorTilesMaterialManager,t=z>C.VTL_HIGH_RES_CUTOFF?2:1,M=v===H.WGLDrawPhase.HITTEST,B=this._fillProgramOptions;B.id=M;B.pattern=m;e=e.getMaterialProgram(g,d,B);if(F&&x.isSome(E)&&!e.compiled)E();else{g.useProgram(e);x.isSome(a)&&({page:a}=a,B=b.getPageSize(a),x.isSome(B)&&(b.bind(g,p.TextureSamplingMode.LINEAR,a,C.VTL_TEXTURE_BINDING_UNIT_SPRITES),e.setUniform2fv("u_mosaicSize",
B),e.setUniform1i("u_texture",C.VTL_TEXTURE_BINDING_UNIT_SPRITES)));e.setUniformMatrix3fv("u_displayMat3",f===K.TranslateAnchor.VIEWPORT?y.displayMat3:y.displayViewMat3);e.setUniform2fv("u_fillTranslation",h);e.setUniform1f("u_depth",k.z+L);M&&e.setUniform4fv("u_id",q);h=-1;for(const n of c)if(n.layerData.has(u)&&(n.key.level!==h&&(h=n.key.level,d.setDataUniforms(e,r,k,h,b)),c=n.layerData.get(u),c.fillIndexCount&&(c.prepareForRendering(g),f=c.fillVertexArrayObject,!x.isNone(f)))){g.bindVAO(f);e.setUniformMatrix3fv("u_dvsMat3",
n.transforms.dvs);g.setStencilFunction(p.CompareFunction.EQUAL,n.stencilRef,255);m&&e.setUniform1f("u_patternFactor",n.rangeX/(t*n.width*Math.max(2**(Math.round(r)-n.key.level),1)));if(l){f=c.patternMap;if(!f)continue;for(const [N,O]of f)f=b.getPageSize(N),x.isSome(f)&&(b.bind(g,p.TextureSamplingMode.LINEAR,N,C.VTL_TEXTURE_BINDING_UNIT_SPRITES),e.setUniform2fv("u_mosaicSize",f),e.setUniform1i("u_texture",C.VTL_TEXTURE_BINDING_UNIT_SPRITES),g.drawElements(p.PrimitiveType.TRIANGLES,O[1],p.DataType.UNSIGNED_INT,
Uint32Array.BYTES_PER_ELEMENT*O[0]))}else g.drawElements(p.PrimitiveType.TRIANGLES,c.fillIndexCount,p.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*c.fillIndexStart);n.triangleCount+=c.fillIndexCount/3}}}};A._drawOutline=function(d,u,k,c,h,f,m){const {context:a,displayLevel:l,state:q,drawPhase:g,painter:r,pixelRatio:y,spriteMosaic:v,requestRender:w,allowDelayedRender:z}=d;d=k.outlineMaterial;var b=r.vectorTilesMaterialManager;const E=.75/y,F=g===H.WGLDrawPhase.HITTEST,e=this._outlineProgramOptions;
e.id=F;b=b.getMaterialProgram(a,d,e);if(z&&x.isSome(w)&&!b.compiled)w();else{a.useProgram(b);b.setUniformMatrix3fv("u_displayMat3",f===K.TranslateAnchor.VIEWPORT?q.displayMat3:q.displayViewMat3);b.setUniform2fv("u_fillTranslation",h);b.setUniform1f("u_depth",k.z+L);b.setUniform1f("u_outline_width",E);F&&b.setUniform4fv("u_id",m);h=-1;for(const t of c)t.layerData.has(u)&&(t.key.level!==h&&(h=t.key.level,d.setDataUniforms(b,l,k,h,v)),c=t.layerData.get(u),c.prepareForRendering(a),c.outlineIndexCount&&
(f=c.outlineVertexArrayObject,x.isNone(f)||(a.bindVAO(f),b.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),a.setStencilFunction(p.CompareFunction.EQUAL,t.stencilRef,255),a.drawElements(p.PrimitiveType.TRIANGLES,c.outlineIndexCount,p.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*c.outlineIndexStart),t.triangleCount+=c.outlineIndexCount/3)))}};return G._createClass(D)}(I);J.WGLBrushVTLFill=I;Object.defineProperty(J,Symbol.toStringTag,{value:"Module"})});