// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/promiseUtils ../../../chunks/mat3 ../../../chunks/mat3f32 ../../../chunks/vec2f32 ./DisplayObject ./ImageryBitmapSource ../../webgl/context-util ../../webgl/enums ../../webgl/Texture".split(" "),function(n,g,p,q,h,x,r,t,y,z,l,A){function v(c){return c&&"render"in c}function w(c){const e=document.createElement("canvas");e.width=c.width;e.height=c.height;c.render(e.getContext("2d"));return e}function B(c){return v(c)?
c instanceof y?p.applySome(c.getRenderedRasterPixels(),e=>e.renderedRasterPixels):w(c):c}t=function(c){function e(a=null,d){var b=C.call(this);b.blendFunction="standard";b._sourceWidth=0;b._sourceHeight=0;b._textureInvalidated=!1;b._texture=null;b.stencilRef=0;b.coordScale=[1,1];b._height=void 0;b.pixelRatio=1;b.resolution=0;b.rotation=0;b._source=null;b._width=void 0;b.x=0;b.y=0;b.immutable=d.immutable??!1;b.requestRenderOnSourceChangedEnabled=d.requestRenderOnSourceChangedEnabled??!0;b.source=a;
b.requestRender=b.requestRender.bind(g._assertThisInitialized(b));return b}g._inherits(e,c);var C=g._createSuper(e);c=e.prototype;c.destroy=function(){this._texture&&(this._texture.dispose(),this._texture=null);p.isSome(this._uploadStatus)&&(this._uploadStatus.controller.abort(),this._uploadStatus=null)};c.beforeRender=function(a){g._get(g._getPrototypeOf(e.prototype),"beforeRender",this).call(this,a);this.updateTexture(a)};c.setSourceAsync=async function(a,d){p.isSome(this._uploadStatus)&&this._uploadStatus.controller.abort();
const b=new AbortController,k=q.createResolver();q.onAbortOrThrow(d,()=>b.abort());q.onAbortOrThrow(b,f=>k.reject(f));this._uploadStatus={controller:b,resolver:k};this.source=a;return k.promise};c.invalidateTexture=function(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRenderOnSourceChangedEnabled&&this.requestRender())};c.updateTransitionProperties=function(a,d){64<=a&&(this.inFadeTransition=this.fadeTransitionEnabled=!1);g._get(g._getPrototypeOf(e.prototype),"updateTransitionProperties",
this).call(this,a,d)};c.setTransform=function(a){const d=h.identity(this.transforms.dvs),[b,k]=a.toScreenNoRotation([0,0],[this.x,this.y]);var f=this.resolution/this.pixelRatio/a.resolution;const m=f*this.width;f*=this.height;const u=Math.PI*this.rotation/180;h.translate(d,d,r.fromValues(b,k));h.translate(d,d,r.fromValues(m/2,f/2));h.rotate(d,d,-u);h.translate(d,d,r.fromValues(-m/2,-f/2));h.scaleByVec2(d,d,r.fromValues(m,f));h.multiply(this.transforms.dvs,a.displayViewMat3,d)};c.setSamplingProfile=
function(a){this._texture&&(a.mips&&!this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._texture.setSamplingMode(a.samplingMode))};c.bind=function(a,d){this._texture&&a.bindTexture(this._texture,d)};c.updateTexture=async function({context:a,painter:d}){if(this._textureInvalidated)if(this._textureInvalidated=!1,this._texture||(this._texture=this._createTexture(a)),this.source){this._texture.resize(this._sourceWidth,this._sourceHeight);a=B(this.source);try{if(p.isSome(this._uploadStatus)){const {controller:b,
resolver:k}=this._uploadStatus,f={signal:b.signal},{width:m,height:u}=this;await d.textureUploadManager.enqueueTextureUpdate({data:a,texture:this._texture,width:m,height:u},f);k.resolve();this._uploadStatus=null}else this._texture.setData(a);this.ready()}catch(b){q.throwIfNotAbortError(b)}}else this._texture.setData(null)};c.onDetach=function(){this.destroy()};c._createTransforms=function(){return{dvs:x.create()}};c._createTexture=function(a){const d=this.immutable&&a.type===z.ContextType.WEBGL2;
return new A.Texture(a,{target:l.TextureType.TEXTURE_2D,pixelFormat:l.PixelFormat.RGBA,internalFormat:d?l.SizedPixelFormat.RGBA8:l.PixelFormat.RGBA,dataType:l.PixelType.UNSIGNED_BYTE,wrapMode:l.TextureWrapMode.CLAMP_TO_EDGE,isImmutable:d,width:this._sourceWidth,height:this._sourceHeight})};g._createClass(e,[{key:"isSourceScaled",get:function(){return this.width!==this._sourceWidth||this.height!==this._sourceHeight}},{key:"height",get:function(){return void 0!==this._height?this._height:this._sourceHeight},
set:function(a){this._height=a}},{key:"source",get:function(){return this._source},set:function(a){if(null!=a||null!=this._source)this._source=a,this._source instanceof HTMLImageElement?(this._sourceHeight=this._source.naturalHeight,this._sourceWidth=this._source.naturalWidth):this._source&&(this._sourceHeight=this._source.height,this._sourceWidth=this._source.width),this.invalidateTexture()}},{key:"width",get:function(){return void 0!==this._width?this._width:this._sourceWidth},set:function(a){this._width=
a}}]);return e}(t.DisplayObject);n.Bitmap=t;n.isImageSource=v;n.rasterize=w;Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});