// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/support/ray ../../../ViewingMode ./IntersectorInterfaces ./IntersectorTarget ./intersectorUtils ./verticalOffsetUtils".split(" "),function(y,r,e,H,C,h,t,L,M,k,I,p,N,O,D){let S=function(){function d(a){this.options=new p.IntersectorOptions;this._results=
new P;this.transform=new D.IntersectorTransform;this.tolerance=1E-5;this.verticalOffset=null;this._ray=k.create();this._rayEnd=t.create();this._rayBeginTransformed=t.create();this._rayEndTransformed=t.create();this.viewingMode=null==a?I.ViewingMode.Global:a}var c=d.prototype;c.reset=function(a,b,f){this.resetWithRay(k.fromPoints(a,b,this._ray),f)};c.resetWithRay=function(a,b){this.camera=b;a!==this._ray&&k.copy(a,this._ray);0!==this.options.verticalOffset?this.viewingMode===I.ViewingMode.Local?this._ray.origin[2]-=
this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null;h.add(this._rayEnd,this._ray.origin,this._ray.direction);this._results.init(this._ray)};c.intersect=function(a=null,b,f,u,m){this.point=b;this.filterPredicate=u;this.tolerance=null==f?1E-5:f;b=D.getVerticalOffsetObject3D(this.verticalOffset);if(e.isSome(a)&&0<a.length){const q=m?g=>{m(g)&&this.intersectObject(g)}:g=>{this.intersectObject(g)};for(const g of a)a=g.getSpatialQueryAccelerator&&g.getSpatialQueryAccelerator(),
e.isSome(a)?(e.isSome(b)?a.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,q,b):a.forEachAlongRay(this._ray.origin,this._ray.direction,q),this.options.selectionMode&&this.options.hud&&a.forEachDegenerateObject(q)):g.objects.forAll(E=>q(E))}this.sortResults()};c.intersectObject=function(a){const b=a.geometries;if(b){var f=a.transformation,u=D.getVerticalOffsetObject3D(this.verticalOffset);for(const m of b){if(!m.visible)continue;const {material:q,id:g}=m;this.transform.setAndInvalidateLazyTransforms(f,
m.shaderTransformation);h.transformMat4(this._rayBeginTransformed,this.rayBegin,this.transform.inverse);h.transformMat4(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const E=this.transform.transform;e.isSome(u)&&(u.objectTransform=this.transform);q.intersect(m,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(v,J,K,n,z,Q)=>{if(0<=v&&(!e.isSome(this.filterPredicate)||this.filterPredicate(this._ray.origin,this._rayEnd,v))){var l=n?this._results.hud:this._results,
A=n?F=>{const R=new N.HudTarget(a,g,K,Q);F.set(p.IntersectorType.HUD,R,v,J,C.IDENTITY,z)}:F=>F.set(p.IntersectorType.OBJECT,{object:a,geometryId:g,triangleNr:K},v,J,E,z);(null==l.min.drapedLayerOrder||z>=l.min.drapedLayerOrder)&&(null==l.min.dist||v<l.min.dist)&&A(l.min);this.options.store!==p.StoreResults.MIN&&(null==l.max.drapedLayerOrder||z<l.max.drapedLayerOrder)&&(null==l.max.dist||v>l.max.dist)&&A(l.max);this.options.store===p.StoreResults.ALL&&(n?(n=new G(this._ray),A(n),this._results.hud.all.push(n)):
(n=new w(this._ray),A(n),this._results.all.push(n)))}})}}};c.sortResults=function(a=this._results.all){a.sort((b,f)=>b.dist!==f.dist?e.unwrapOr(b.dist,0)-e.unwrapOr(f.dist,0):b.drapedLayerOrder!==f.drapedLayerOrder?e.unwrapOr(b.drapedLayerOrder,Number.MAX_VALUE)-e.unwrapOr(f.drapedLayerOrder,Number.MAX_VALUE):e.unwrapOr(f.drapedLayerGraphicOrder,Number.MIN_VALUE)-e.unwrapOr(b.drapedLayerGraphicOrder,Number.MIN_VALUE))};r._createClass(d,[{key:"results",get:function(){return this._results}},{key:"ray",
get:function(){return this._ray}},{key:"rayBegin",get:function(){return this._ray.origin}},{key:"rayEnd",get:function(){return this._rayEnd}}]);return d}(),P=function(){function d(){this.min=new w(k.create());this.max=new w(k.create());this.hud={min:new G(k.create()),max:new G(k.create()),all:[]};this.ground=new w(k.create());this.all=[]}d.prototype.init=function(c){this.min.init(c);this.max.init(c);this.ground.init(c);this.all.length=0;this.hud.min.init(c);this.hud.max.init(c);this.hud.all.length=
0};return r._createClass(d)}(),w=function(){function d(a){this.intersector=p.IntersectorType.OBJECT;this.normal=t.create();this.transformation=C.create();this._ray=k.create();this.init(a)}var c=d.prototype;c.getIntersectionPoint=function(a){if(!O.isValidIntersectorResult(this))return!1;h.scale(B,this.ray.direction,this.dist);h.add(a,this.ray.origin,B);return!0};c.getTransformedNormal=function(a){h.copy(x,this.normal);x[3]=0;L.transformMat4(x,x,this.transformation);h.copy(a,x);return h.normalize(a,
a)};c.init=function(a){this.drapedLayerGraphicOrder=this.drapedLayerOrder=this.target=this.dist=null;this.intersector=p.IntersectorType.OBJECT;k.copy(a,this._ray)};c.set=function(a,b,f,u,m,q,g){this.intersector=a;this.dist=f;h.copy(this.normal,e.unwrapOr(u,t.UNIT_Z));H.copy(this.transformation,e.unwrapOr(m,C.IDENTITY));this.target=b;this.drapedLayerOrder=q;this.drapedLayerGraphicOrder=g};c.copy=function(a){k.copy(a.ray,this._ray);this.intersector=a.intersector;this.dist=a.dist;this.target=a.target;
this.drapedLayerOrder=a.drapedLayerOrder;this.drapedLayerGraphicOrder=a.drapedLayerGraphicOrder;h.copy(this.normal,a.normal);H.copy(this.transformation,a.transformation)};r._createClass(d,[{key:"ray",get:function(){return this._ray}},{key:"distanceInRenderSpace",get:function(){return e.isSome(this.dist)?(h.scale(B,this.ray.direction,this.dist),h.length(B)):null}}]);return d}(),G=function(d){function c(){var b=a.apply(this,arguments);b.intersector=p.IntersectorType.HUD;return b}r._inherits(c,d);var a=
r._createSuper(c);return r._createClass(c)}(w);const B=t.create(),x=M.create();y.DEFAULT_TOLERANCE=1E-5;y.newIntersector=function(d){return new S(d)};y.newIntersectorResult=function(d){return new w(d)};Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});