// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../../../geometry/support/buffer/BufferView ../core/shaderLibrary/ShaderOutput ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./DefaultBufferWriter ./DefaultLayouts ./internal/bufferWriterUtils ../shaders/NativeLineTechnique ../shaders/NativeLineTechniqueConfiguration".split(" "),
function(N,y,da,ea,O,I,fa,h,z,ha,K,E,p,U,L,ia,V,P,ja,w,ka,W,la,ma,na){var M;(function(l){l[l.START=0]="START";l[l.END=1]="END"})(M||(M={}));let sa=function(l){function q(a){a=c.call(this,a,new X);a._configuration=new na.NativeLineTechniqueConfiguration;return a}y._inherits(q,l);var c=y._createSuper(q);l=q.prototype;l.getConfiguration=function(a,b){this._configuration.output=a;this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;this._configuration.hasVertexColors=this.parameters.hasVertexColors;
this._configuration.transparent=1>this.parameters.color[3]||1>this.parameters.width;this._configuration.draped=b.slot===P.RenderSlot.DRAPED_MATERIAL;a=O.isSome(this.parameters.stipplePattern);this._configuration.stippleEnabled=a;this._configuration.stippleOffColorEnabled=a&&O.isSome(this.parameters.stippleOffColor);this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous;return this._configuration};l.intersect=
function(a,b,f,d,n,u){if(f.options.selectionMode&&a.visible)if(ja.isTranslationMatrix(b)){n=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;var g=f.camera,k=oa;fa.copy(k,f.point);h.set(J[0],k[0]-2,k[1]+2,0);h.set(J[1],k[0]+2,k[1]+2,0);h.set(J[2],k[0]+2,k[1]-2,0);h.set(J[3],k[0]-2,k[1]-2,0);for(a=0;4>a;a++)if(!g.unprojectFromRenderScreen(J[a],C[a]))return;p.fromPoints(g.eye,C[0],C[1],Q);p.fromPoints(g.eye,C[1],C[2],R);p.fromPoints(g.eye,C[2],C[3],S);p.fromPoints(g.eye,C[3],C[0],T);d=Number.MAX_VALUE;
a=0;for(let m=0;m<n.length-5;m+=3)if(r[0]=n[m]+b[12],r[1]=n[m+1]+b[13],r[2]=n[m+2]+b[14],t[0]=n[m+3]+b[12],t[1]=n[m+4]+b[13],t[2]=n[m+5]+b[14],!(0>p.signedDistance(Q,r)&&0>p.signedDistance(Q,t)||0>p.signedDistance(R,r)&&0>p.signedDistance(R,t)||0>p.signedDistance(S,r)&&0>p.signedDistance(S,t)||0>p.signedDistance(T,r)&&0>p.signedDistance(T,t))){g.projectToRenderScreen(r,F);g.projectToRenderScreen(t,G);if(0>F[2]&&0<G[2]){h.subtract(A,r,t);var e=g.frustum;e=-p.signedDistance(e[K.PlaneIndex.NEAR],r)/
h.dot(A,p.normal(e[K.PlaneIndex.NEAR]));h.scale(A,A,e);h.add(r,r,A);g.projectToRenderScreen(r,F)}else if(0<F[2]&&0>G[2])h.subtract(A,t,r),e=g.frustum,e=-p.signedDistance(e[K.PlaneIndex.NEAR],t)/h.dot(A,p.normal(e[K.PlaneIndex.NEAR])),h.scale(A,A,e),h.add(t,t,A),g.projectToRenderScreen(t,G);else if(0>F[2]&&0>G[2])continue;F[2]=0;G[2]=0;e=E.distance2(E.fromPoints(F,G,Y),k);e<d&&(d=e,h.copy(Z,r),h.copy(aa,t),a=m/3)}b=f.rayBegin;f=f.rayEnd;4>d&&(d=Number.MAX_VALUE,E.closestLineSegmentPoint(E.fromPoints(Z,
aa,Y),E.fromPoints(b,f,pa),H)&&(h.subtract(H,H,b),d=h.length(H),h.scale(H,H,1/d),d/=h.distance(b,f)),u(d,H,a,!1))}else da.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix")};l.intersectDraped=function(a,b,f,d,n,u){if(f.options.selectionMode){b=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;var g=a.vertexAttributes.get(w.VertexAttribute.SIZE);f=d[0];d=d[1];a=(((g?g.data[0]:0)+1)/2+4)*a.screenToWorldRatio;g=Number.MAX_VALUE;
var k=0;for(let v=0;v<b.length-5;v+=3){var e=b[v],m=b[v+1],B=f-e,x=d-m;e=b[v+3]-e;m=b[v+4]-m;const D=ea.clamp((e*B+m*x)/(e*e+m*m),0,1);B=e*D-B;x=m*D-x;x=B*B+x*x;x<g&&(g=x,k=v/3)}g<a*a&&n(u.dist,u.normal,k,!1)}};l.requiresSlot=function(a,b){return(b===L.ShaderOutput.Color||b===L.ShaderOutput.Highlight||b===L.ShaderOutput.ObjectAndLayerIdColor)&&(a===P.RenderSlot.OPAQUE_MATERIAL||a===P.RenderSlot.DRAPED_MATERIAL)};l.createGLMaterial=function(a){return new qa(a)};l.createBufferWriter=function(){const a=
this.parameters.hasVertexColors?W.PositionColorLayout:W.PositionLayout;return O.isNone(this.parameters.stipplePattern)?new ka.DefaultBufferWriter(a):new ra(a.clone().vec3f(w.VertexAttribute.AUXPOS1).vec2f(w.VertexAttribute.UV0))};return y._createClass(q)}(V.Material),qa=function(l){function q(){var a=c.apply(this,arguments);a._stipplePattern=null;return a}y._inherits(q,l);var c=y._createSuper(q);l=q.prototype;l.dispose=function(){y._get(y._getPrototypeOf(q.prototype),"dispose",this).call(this);this._stippleTextureRepository.release(this._stipplePattern);
this._stipplePattern=null};l._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})};l.beginSlot=function(a){this._output===L.ShaderOutput.Color&&this._updateOccludeeState(a);const b=this._material.parameters.stipplePattern;this._stipplePattern!==b&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,b)),this._stipplePattern=b);return this.ensureTechnique(ma.NativeLineTechnique,
a)};return y._createClass(q)}(ia),ra=function(){function l(c){this.vertexBufferLayout=c}var q=l.prototype;q.allocate=function(c){return this.vertexBufferLayout.createBuffer(c)};q.elementCount=function(c){return c.indices.get(w.VertexAttribute.POSITION).length};q.write=function(c,a,b,f,d){la.writeDefaultAttributes(b,this.vertexBufferLayout,c,a,f,d);this._writeAuxpos1(c,b,f,d);this._writeUV0(c,b,f,d)};q._writeAuxpos1=function(c,a,b,f){var d=b.getField(w.VertexAttribute.AUXPOS1,U.BufferViewVec3f);b=
a.indices.get(w.VertexAttribute.POSITION);a=a.vertexAttributes.get(w.VertexAttribute.POSITION).data;const n=d.typedBufferStride;d=d.typedBuffer;f*=n;for(let g=0;g<b.length-1;g+=2)for(const k of[1,0]){var u=3*b[g+k];const e=a[u],m=a[u+1];u=a[u+2];const B=c[1]*e+c[5]*m+c[9]*u+c[13],x=c[2]*e+c[6]*m+c[10]*u+c[14];d[f]=c[0]*e+c[4]*m+c[8]*u+c[12];d[f+1]=B;d[f+2]=x;f+=n}};q._writeUV0=function(c,a,b,f){var d=b.getField(w.VertexAttribute.UV0,U.BufferViewVec2f),n=a.indices.get(w.VertexAttribute.POSITION);b=
a.vertexAttributes.get(w.VertexAttribute.POSITION).data;const u=a.vertexAttributes.get(w.VertexAttribute.DISTANCETOSTART)?.data;a=d.typedBufferStride;d=d.typedBuffer;f*=a;let g=0;d[f]=M.START;d[f+1]=g;f+=a;var k=3*n[0];k=h.set(r,b[k],b[k+1],b[k+2]);c&&h.transformMat4(k,k,c);const e=t,m=n.length-1;let B=1;const x=u?(D,ba,ca)=>g=u[ca]:(D,ba,ca)=>g+=h.distance(D,ba);for(let D=1;D<m;D+=2){var v=3*n[D];h.set(e,b[v],b[v+1],b[v+2]);c&&h.transformMat4(e,e,c);x(k,e,B++);for(v=0;2>v;++v)d[f]=1-v,d[f+1]=g,f+=
a;h.copy(k,e)}n=3*n[m];h.set(e,b[n],b[n+1],b[n+2]);c&&h.transformMat4(e,e,c);x(k,e,B);d[f]=M.END;d[f+1]=g};return y._createClass(l)}(),X=function(l){function q(){var a=c.apply(this,arguments);a.color=ha.ONES;a.hasVertexColors=!1;a.hasSlicePlane=!1;a.width=1;a.stipplePreferContinuous=!0;a.hasOccludees=!1;a.stippleTexture=null;return a}y._inherits(q,l);var c=y._createSuper(q);return y._createClass(q)}(V.MaterialParameters);const r=z.create(),t=z.create(),A=z.create(),H=z.create(),F=I.createRenderScreenPointArray3(),
G=I.createRenderScreenPointArray3(),Z=z.create(),aa=z.create(),Y=E.create(),pa=E.create(),oa=z.create(),J=[I.createRenderScreenPointArray3(),I.createRenderScreenPointArray3(),I.createRenderScreenPointArray3(),I.createRenderScreenPointArray3()],C=[z.create(),z.create(),z.create(),z.create()],Q=p.create(),R=p.create(),S=p.create(),T=p.create();N.NativeLineMaterial=sa;N.Parameters=X;Object.defineProperty(N,Symbol.toStringTag,{value:"Module"})});