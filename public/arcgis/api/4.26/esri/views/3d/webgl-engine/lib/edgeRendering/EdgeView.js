// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../core/support/WatchUpdatingTracking ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../../../ViewingMode ../../collections/Component/Material/shader/ComponentData.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexArrayObject ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./edgePreprocessing ./EdgeRenderer ./EdgeShaderParameters ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../shaders/sources/edgeRenderer/EdgeUtil.glsl ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(u,v,w,J,M,ba,N,p,y,wa,xa,ca,K,da,O,B,L,ea,P,fa,ha,ia,ja,ka,la,ma,na,oa,C,D,Q,R,A,pa,qa,S,ra,z,sa,E,T,U){function V(h){p.isSome(h)&&(h.vao.vertexBuffers.instances.dispose(),h.vao.dispose(!1),h.vao=null)}function ta(h){let m=null,q=null;for(let a=0;a<h.geometries.length;a++){const b=h.geometries[a];if(b.material.supportsEdges){if(!m)m=b.transformation;else if(!M.equals(m,b.transformation))return!1;if(!q&&p.isSome(b.localOrigin))q=b;else if(q&&p.isSome(q.localOrigin)&&p.isSome(b.localOrigin)&&
q.localOrigin.id!==b.localOrigin.id)return!1}}return!0}function G(h,m,q){m*=q;q=M.binaryIndexOf(h,m,!0);return-1===q?m<h[0]?h.length:0:h.length-q}u.EdgeView=function(h){function m(a){var b=q.call(this,a);b._updatingHandles=new ea.WatchUpdatingTracking;b._perObjectData=new Map;b._perObjectDataEvictionCache=new Set;b._renderers=new Map;b._gpuMemoryUsage=0;b._workerAbort=new AbortController;b._tmpModelPosition=L.create();b._localOrigins=new ma.LocalOriginManager(new ka.GridLocalOriginFactory(a.renderSR));
return b}v._inherits(m,h);var q=v._createSuper(m);h=m.prototype;h.initialize=function(){this._worker=new qa.EdgeWorkerHandle(this.schedule);this._componentColorManager=new sa.BufferManager(this.rctx,3);const a=D.VertexLayout.createBuffer(4);for(let b=0;4>b;b++)a.sideness.set(b,0,0===b||3===b?0:1),a.sideness.set(b,1,0===b||1===b?0:1);this._verticesBufferObject=T.BufferObject.createVertex(this.rctx,U.Usage.STATIC_DRAW,a.buffer)};h.destroy=function(){this.destroyed||(this._perObjectData.forEach(a=>this._discardObjectEntry(a)),
this._perObjectData.clear(),this._strokesTexture=p.disposeMaybe(this._strokesTexture),this._componentColorManager=p.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=p.disposeMaybe(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())};h.shouldRender=function(){return 0<this._renderers.size};h.addComponentObject=async function(a,b,c,f,g,d,e,l){if(this.hasObject(a))return this.getObjectMemoryUsage(a);
let k;c=new W(new Promise(n=>k=n),c.center,c.radius);this._perObjectData.set(a,c);a=await this._updatingHandles.addPromise(this._addComponentGeometry(b,c,f,g,d,e,l));this.setNeedsRender();k();return a};h.addOrUpdateObject3D=async function(a,b,c,f){if(this.destroyed)ba.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");else{var g=this._perObjectData.get(a);0<g?.renderables.length&&this._perObjectDataEvictionCache.add(g);var d,e=a.boundingVolumeWorldSpace.bounds;
e=new W(new Promise(k=>d=k),P.getCenter(e),P.getRadius(e));this._perObjectData.set(a,e);var l=[];if(c.mergeGeometries&&1<a.geometries.length&&ta(a))l.push(this._addObjectMergedGeometries(a,e,b,c,f));else for(let k=0;k<a.geometries.length;k++){const n=a.geometries[k];n.material.supportsEdges&&l.push(this._addGeometry(a,e,n,b[0],c,f))}await this._updatingHandles.addPromise(Promise.all(l));this._perObjectDataEvictionCache.delete(e);this._discardObjectEntry(g);this.setNeedsRender();d()}};h._discardObjectEntry=
function(a){a&&(a.renderables.length&&(a.renderables.forEach(b=>this._removeRenderable(b)),this.setNeedsRender()),a.loaded=null)};h.hasObject=function(a){return this._perObjectData.has(a)};h.updateAllComponentOpacities=async function(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));if(!p.isNone(a)){var c=b instanceof Array?f=>b[f]:()=>b;a.renderables.forEach(f=>{const g=f.components.meta.length;for(let d=0;d<g;d++){const e=c(d),l=f.components.meta[d],k=l.index;l.material.opacity=
e;f.components.buffer.textureBuffer.setDataElement(k,1,3,255*e)}this._updateTransparency(f)});this.setNeedsRender()}};h.getObjectMemoryUsage=async function(a){a=await this._getObjectEntry(a);return p.isSome(a)?a.renderables.reduce((b,c)=>b+c.statistics.gpuMemoryUsage,0):0};h.updateAllComponentMaterials=async function(a,b,c,f){const g=a instanceof na.Object3D,d=!!c.hasSlicePlane,e=z.determineRendererType(b),l=A.EdgeRenderer.getKey(e,d,g);a=await this._updatingHandles.addPromise(this._getObjectEntry(a));
p.isNone(a)||(a.renderables.forEach(k=>{if(l!==k.rendererKey){var n=this._renderers.get(k.rendererKey);const r=this._acquireRenderer(e,d,g);n.removeRenderable(k);--n.refCount;k.rendererKey=l;r.addRenderable(k)}for(n=0;n<b.length;n++)k.components.meta[n].material=b[n];f&&this._updateComponentBuffer(k.components);this._updateTransparency(k)}),this.setNeedsRender())};h.updateAllVerticalOffsets=async function(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));p.isNone(a)||(a.renderables.forEach(c=>
{const f=c.components.meta;for(let g=0;g<f.length;g++)c.components.meta[g].verticalOffset=b?.[g]??0;this._updateComponentBuffer(c.components)}),this.setNeedsRender())};h.updateObjectVisibility=async function(a,b){a=await this._updatingHandles.addPromise(this._getObjectEntry(a));p.isSome(a)&&(a.renderables.forEach(c=>c.visible=b),this.setNeedsRender())};h.removeObject=function(a){const b=this._perObjectData.get(a);b&&(this._perObjectData.delete(a),this._discardObjectEntry(b))};h._getObjectEntry=async function(a){a=
this._perObjectData.get(a);if(!a)throw Error("no object");await a.loaded;return null==a.loaded?null:a};h.render=function(a,b){if(!p.isNone(this._componentColorManager)){this._localOrigins.updateViewMatrices(a.camera.viewMatrix);var c=a.camera.viewInverseTransposeMatrix,f=L.create(),g=new ja.TwoVectorPosition,d=0,e=0;this._renderers.forEach(k=>{if(0===k.refCount)this._renderers.delete(k.key),k.dispose();else{let n=!0,r=!0;k.forEachRenderable(t=>{t.visible&&(d+=t.statistics.averageEdgeLength,e++,n&&
t.regular&&(k.updateTechnique(a,!1),n=!1),r&&t.silhouette&&(k.updateTechnique(a,!0),r=!1))},b)}});this._componentColorManager.garbageCollect();this._componentColorManager.updateTextures();if(0!==e){var l=new pa.EdgePassParameters(40*d/e,b);B.set(f,c[3],c[7],c[11]);g.set(f);B.copy(l.transformWorldFromViewTH,g.high);B.copy(l.transformWorldFromViewTL,g.low);K.fromMat4(l.transformViewFromCameraRelativeRS,a.camera.viewMatrix);K.transpose(X,l.transformViewFromCameraRelativeRS);K.invert(l.transformNormalViewFromGlobal,
X);l.transformProjFromView=a.camera.projectionMatrix;this._updateObjectCameraDistances(a);this._renderers.forEach(k=>{this._renderRegularEdges(k,a,l);this._renderSilhouetteEdges(k,a,l)})}}};h._updateTransparency=function(a){const b=z.determineEdgeTransparency(a.components.meta),c=z.determineObjectTransparency(a.components.meta);if(b!==a.edgeTransparency||c!==a.objectTransparency)a.edgeTransparency=b,a.objectTransparency=c,this._renderers.get(a.rendererKey).setRenderablesDirty()};h._computeModelTransformWithLocalOrigin=
function(a,b,c){a.getCombinedStaticTransformation(b,c);a=p.isSome(b.localOrigin)?this._localOrigins.register(b.localOrigin):this._localOrigins.acquire(B.set(this._tmpModelPosition,c[12],c[13],c[14]));b.localOrigin=a.origin;la.applyToModelMatrix(a.origin.vec3,c);return a};h._updateComponentBuffer=function(a){const {meta:b,buffer:c}=a;a=new Uint8Array(4);for(let g=0;g<b.length;g++){var f=b[g].material;const d=b[g].index,e=N.clamp(Math.round(f.size*A.LINE_WIDTH_FRACTION_FACTOR),0,255),l=N.clamp(f.extensionLength,
-A.EXTENSION_LENGTH_OFFSET,255-A.EXTENSION_LENGTH_OFFSET)+A.EXTENSION_LENGTH_OFFSET,k="solid"===f.type?R.EdgeType.SOLID:R.EdgeType.SKETCH,n=255*f.opacity;f=f.color;c.textureBuffer.setData(d,0,255*f[0],255*f[1],255*f[2],255*f[3]);c.textureBuffer.setData(d,1,e,l,k,n);ia.encodeElevationOffset(b[g].verticalOffset,a);c.textureBuffer.setData(d,2,a[0],a[1],a[2],a[3])}};h._createComponentBuffers=function(a){if(p.isNone(this._componentColorManager))return null;const b=[],c=this._componentColorManager.getBuffer(a.length);
for(let f=0;f<a.length;f++){const g=a[f],d=c.acquireIndex();b.push({index:d,verticalOffset:0,material:g})}a=new ua(c,b);this._updateComponentBuffer(a);return a};h._extractEdges=function(a,b,c,f,g,d=g.length){return this._worker.process({data:b,indices:g,indicesLength:d,writerSettings:a,skipDeduplicate:c},this._workerAbort.signal,f)};h._createRenderable=function(a,b,c,f,g){var d=k=>p.isSome(this._verticesBufferObject)?new va(new oa.VertexArrayObject(this.rctx,D.EdgeShaderAttributeLocations,{vertices:D.glVertexLayout,
instances:k===E.EdgeSilhouette.REGULAR?Q.RegularEdgeBufferWriter.glLayout:Q.SilhouetteEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:T.BufferObject.createVertex(this.rctx,U.Usage.STATIC_DRAW,k===E.EdgeSilhouette.REGULAR?a.regular.instancesData.buffer:a.silhouette.instancesData.buffer)}),k===E.EdgeSilhouette.REGULAR?a.regular.lodInfo:a.silhouette.lodInfo):null;const e=0<a.regular.lodInfo.lengths.length?d(E.EdgeSilhouette.REGULAR):null;d=0<a.silhouette.lodInfo.lengths.length?
d(E.EdgeSilhouette.SILHOUETTE):null;const l=(p.isSome(e)?e.vao.size:0)+(p.isSome(d)?d.vao.size:0);return new H(e,d,{gpuMemoryUsage:l,externalMemoryUsage:g,averageEdgeLength:a.averageEdgeLength},c,z.determineEdgeTransparency(b.meta),z.determineObjectTransparency(b.meta),b,f)};h._addGeometry=async function(a,b,c,f,g,d){var e=c.vertexAttributes.get(C.VertexAttribute.POSITION);const l=c.indices.get(C.VertexAttribute.POSITION),k=O.create();a=this._computeModelTransformWithLocalOrigin(a,c,k);e=new Y(e,
l,k,a);return this._addPositionData(b,e,c.edgeIndicesLength,f,g,d)};h._addPositionData=async function(a,b,c,f,g,d=!1){if(null!=a.loaded){var e=this._createComponentBuffers([f]);if(!(p.isNone(e)||0>=c)){f=this._acquireRenderer(f.type,!!g.hasSlicePlane,!0);var {modelTransform:l,origin:k}=b;g=b.indices;b=b.position;var n=b.data.length/b.size,r=D.EdgeInputBufferLayout.createBuffer(n);for(let t=0;t<n;t++)r.position.set(t,0,b.data[t*b.size]),r.position.set(t,1,b.data[t*b.size+1]),r.position.set(t,2,b.data[t*
b.size+2]);z.fillComponenBufferIndices(e.meta,[0,r.componentIndex.count],r.componentIndex);c=await this._updatingHandles.addPromise(this._extractEdges(f.writerSettings,r,!1,d,g,c));null!=a.loaded&&(e=this._createRenderable(c,e,new Z(l,k),f.key,!1),a.renderables.push(e),f.addRenderable(e),this._gpuMemoryUsage+=e.statistics.gpuMemoryUsage)}}};h._addComponentGeometry=async function(a,b,c,f,g,d,e){if(null==b.loaded)return 0;const l=this._createComponentBuffers(d);if(p.isNone(l))return 0;d=z.determineRendererType(d);
e=this._acquireRenderer(d,e.hasSlicePlane||!1,!1);d=D.EdgeInputBufferLayout.createBuffer(c.length/3);fa.copy(d.position.typedBuffer,c,d.position.typedBufferStride,3);z.fillComponenBufferIndices(l.meta,g,d.componentIndex,f);c=await this._updatingHandles.addPromise(this._extractEdges(e.writerSettings,d,!0,!1,f));if(null==b.loaded)return 0;a=this._createRenderable(c,l,a,e.key,!0);b.renderables.push(a);e.addRenderable(a);return a.statistics.gpuMemoryUsage};h._addObjectMergedGeometries=async function(a,
b,c,f,g){var d=new Map,e=0,l=null,k=0;for(var n=0;n<a.geometries.length;n++){var r=a.geometries[n];if(r.material.supportsEdges){!l&&r.localOrigin&&(l=r);var t=r.vertexAttributes.get(C.VertexAttribute.POSITION);k+=t.data.length/t.size;e+=r.edgeIndicesLength}}k=65536<=k?Uint32Array:Uint16Array;e=e?new k(e):null;k=[];n=0;for(r=0;r<a.geometries.length;r++){t=a.geometries[r];if(!t.material.supportsEdges)continue;var x=t.vertexAttributes.get(C.VertexAttribute.POSITION);const aa=t.indices.get(C.VertexAttribute.POSITION);
let I=d.get(x.data);if(null==I){I=k.length/3;for(let F=0;F<x.data.length;F+=x.size)k.push(x.data[F]),k.push(x.data[F+1]),k.push(x.data[F+2]);d.set(x.data,I)}if(aa)for(x=0;x<t.edgeIndicesLength;x++)e[n++]=I+aa[x]}l=l||a.geometries[0];d=O.create();l=this._computeModelTransformWithLocalOrigin(a,l,d);for(n=0;n<a.geometries.length;n++)a.geometries[n].localOrigin=l.origin;a=new Y({data:k,size:3},e,d,l);await this._updatingHandles.addPromise(this._addPositionData(b,a,e.length,c[0],f,g))};h._acquireRenderer=
function(a,b,c){const f=A.EdgeRenderer.getKey(a,b,c);let g=this._renderers.get(f);p.isNone(this._strokesTexture)&&(this._strokesTexture=ra.generateStrokesTexture(this.rctx));g||(g=new A.EdgeRenderer(this.rctx,this.techniqueRepository,{type:a,hasSlicePlane:b,strokesTexture:this._strokesTexture,legacy:c,spherical:this.viewingMode===ha.ViewingMode.Global}),this._renderers.set(f,g));++g.refCount;return g};h._removeRenderable=function(a){V(a.regular);V(a.silhouette);const b=this._renderers.get(a.rendererKey);
if(b){b.removeRenderable(a);--b.refCount;"origin"in a.transform&&this._localOrigins.release(a.transform.origin);this._gpuMemoryUsage-=a.statistics.externalMemoryUsage?0:a.statistics.gpuMemoryUsage;for(const c of a.components.meta)a.components.buffer.releaseIndex(c.index)}};h._updateObjectCameraDistances=function(a){const b=a.camera.eye,c=a.camera.viewForward,f=L.create();a=g=>{B.sub(f,g.center,b);const d=B.dot(f,c),e=g.radius,l=d<-e?Infinity:d<e?0:d-e;g.renderables.forEach(k=>k.distanceToCamera=l)};
this._perObjectData.forEach(a);this._perObjectDataEvictionCache.forEach(a)};h._renderRegularEdges=function(a,b,c){const f=a.bindRegularEdges(c,b),g=b.camera.perScreenPixelRatio;a.forEachRenderable(d=>{if(p.isSome(d.regular)&&d.visible){var e=G(d.regular.lod.lengths,d.distanceToCamera,g);a.renderRegularEdges(f,d,c,b,e)}},c.transparency)};h._renderSilhouetteEdges=function(a,b,c){const f=a.bindSilhouetteEdges(c,b),g=b.camera.perScreenPixelRatio;a.forEachRenderable(d=>{if(p.isSome(d.silhouette)&&d.visible){var e=
G(d.silhouette.lod.lengths,d.distanceToCamera,g);a.renderSilhouetteEdges(f,d,c,b,e)}},c.transparency)};v._createClass(m,[{key:"updating",get:function(){return this._updatingHandles.updating}},{key:"usedMemory",get:function(){return this._gpuMemoryUsage}},{key:"test",get:function(){return{hasRenderedPrimitives:a=>{let b=!1;const c=a.perScreenPixelRatio,f=(g,d)=>g.forEachRenderable(e=>{e.visible&&!b&&(p.isSome(e.regular)&&(b=0<G(e.regular.lod.lengths,e.distanceToCamera,c)),!b&&p.isSome(e.silhouette)&&
(b=0<G(e.silhouette.lod.lengths,e.distanceToCamera,c)))},d);this._renderers.forEach(g=>{b||(f(g,S.Transparency.OPAQUE),f(g,S.Transparency.TRANSPARENT))});return b}}}}]);return m}(J);w.__decorate([y.property({constructOnly:!0})],u.EdgeView.prototype,"rctx",void 0);w.__decorate([y.property({constructOnly:!0})],u.EdgeView.prototype,"renderSR",void 0);w.__decorate([y.property({constructOnly:!0})],u.EdgeView.prototype,"viewingMode",void 0);w.__decorate([y.property({constructOnly:!0})],u.EdgeView.prototype,
"techniqueRepository",void 0);w.__decorate([y.property({constructOnly:!0})],u.EdgeView.prototype,"setNeedsRender",void 0);w.__decorate([y.property({constructOnly:!0})],u.EdgeView.prototype,"schedule",void 0);w.__decorate([y.property({readOnly:!0})],u.EdgeView.prototype,"_updatingHandles",void 0);w.__decorate([y.property({readOnly:!0})],u.EdgeView.prototype,"updating",null);u.EdgeView=w.__decorate([ca.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],u.EdgeView);let W=v._createClass(function(h,
m,q){this.center=m;this.radius=q;this.renderables=[];this.loaded=h;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0)})}),ua=v._createClass(function(h,m){this.buffer=h;this.meta=m}),va=v._createClass(function(h,m){this.vao=h;this.lod=m}),Z=v._createClass(function(h,m){this.modelMatrix=h;this.origin=m}),H=v._createClass(function(h,m,q,a,b,c,f,g){this.regular=h;this.silhouette=m;this.statistics=q;this.transform=a;this.edgeTransparency=b;this.objectTransparency=c;this.components=f;this.rendererKey=
g;this.distanceToCamera=0;this.visible=!0});w=function(h){function m(){return q.apply(this,arguments)}v._inherits(m,h);var q=v._createSuper(m);return v._createClass(m)}(H);J=function(h){function m(){return q.apply(this,arguments)}v._inherits(m,h);var q=v._createSuper(m);return v._createClass(m)}(H);let Y=v._createClass(function(h,m,q,a){this.position=h;this.indices=m;this.modelTransform=q;this.origin=a});const X=da.create();u.LegacyTransform=Z;u.RegularRenderable=w;u.Renderable=H;u.SilhouetteRenderable=
J;Object.defineProperty(u,Symbol.toStringTag,{value:"Module"})});