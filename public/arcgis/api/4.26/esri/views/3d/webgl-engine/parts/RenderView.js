// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/time ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/ShaderTechniqueRepository ../lib/basicInterfaces ../lib/CompositingHelper ../lib/depthRangeUtils ../lib/GLMaterialRepository ../lib/MagnifierHelper ../lib/Material ../lib/ObjectAndLayerIdRenderHelper ../lib/Renderer ../lib/RenderingContext ../lib/TextureRepository ../materials/StippleTextureRepository ../materials/internal/WaterTextureRepository ./contextCache ./requireUtils ./ScreenshotManager ./testUtils ../../../support/RenderState ../../../webgl/context-util".split(" "),
function(f,t,g,D,E,u,w,n,x,F,y,l,Y,Z,G,H,I,p,J,K,L,M,N,O,P,z,Q,R,S,T,U,A,V,B,W){f.RenderView=function(h){function q(b){var a=X.call(this,{});a.events=new E;a.waterTextureRepository=new S.WaterTextureRepository;a._magnifierHelper=new M.MagnifierHelper;a.objectAndLayerIdRenderHelper=u("enable-feature:objectAndLayerId-rendering")?new O.ObjectAndLayerIdRenderHelper:null;a._needsUpdate=!0;a._needsRender=!0;a._idleSuspend=!0;a._needsWaterReflectionUpdate=!1;a._lastAnimationUpdate=0;a._container=b.container;
a._viewingMode=b.viewingMode;a._initializeContext(b);a.addHandles([x.watch(()=>a.waterTextureRepository?.updating,()=>a.requestRender(),x.initial),a._magnifierHelper.events.on("request-render",()=>a.requestRender())]);a._stippleTextureRepository=new R.StippleTextureRepository(a._rctx);a._shaderTechniqueRepository=new I.ShaderTechniqueRepository({rctx:a._rctx,viewingMode:b.viewingMode,stippleTextureRepository:a._stippleTextureRepository,waterTextureRepository:a.waterTextureRepository});a._textureRepository=
new Q.TextureRepository(b,a._shaderTechniqueRepository,a._rctx);a.addHandles(a._textureRepository.events.on("changed",d=>a.requestRender(d)));a._materialRepository=new L.GLMaterialRepository(a._textureRepository,a._shaderTechniqueRepository,()=>a.requestRender(),()=>a.requestRender());a._compositingHelper=new J(a._rctx,a._shaderTechniqueRepository);a.renderer=new P.Renderer(b,a._materialRepository,a._textureRepository,a._shaderTechniqueRepository,a._rctx,a._compositingHelper,a._magnifierHelper,d=>
a.requestRender(d));a._screenshotManager=new A.ScreenshotManager(a._rctx,{renderScene:(d,e,c,k,m)=>a.renderer.render(d,e,{camera:c,contentCamera:c,mode:B.RenderState.IDLE},k,m),requestRenderScene:d=>a.requestRender(d),prepareOverlay:()=>b.options.screenshot.prepareOverlay(),renderOverlay:(d,e)=>b.options.screenshot.renderOverlay(d,e)},d=>a.events.emit("force-camera-for-screenshot",d),()=>a.renderer.disposeOffscreenBuffers());a._registerFrameTask(b);return a}t._inherits(q,h);var X=t._createSuper(q);
h=q.prototype;h.normalizeCtorArgs=function(){return{}};h.destroy=function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask=n.removeMaybe(this._frameTask);this._shaderTechniqueRepository=n.destroyMaybe(this._shaderTechniqueRepository)};h.requestRender=function(b=p.RenderRequestType.UPDATE){this._needsRender=!0;b===p.RenderRequestType.UPDATE&&(this._needsUpdate=!0)};h.setIdleSuspend=function(b){this._idleSuspend!==b&&(this._idleSuspend=b,this.requestRender())};
h.takeScreenshot=function(b){return this._screenshotManager.takeScreenshot(b).then(a=>a[0])};h.takeScreenshotWithOID=function(b){b.objectAndLayerIdColor=!0;return this._screenshotManager.takeScreenshot(b)};h.getAlpha=function(){return!!this._rctx.contextAttributes.alpha};h.getMinimalDepthForArea=function(b,a,d,e,c,k=c){k=e.constrainWindowSize(a,d,c*e.pixelRatio,k*e.pixelRatio);const m=this._ensureDepthBuffer(k);this.renderer.readDepthPixels(e,k,m);c=Number.MAX_VALUE;for(let v=0;v<k[2]*k[3];v++){const r=
K.textureToDepth(4*v,m,e.nearFar);c>r&&r!==e.nearFar[0]&&r!==e.nearFar[1]&&(c=r)}n.isSome(b)&&(b=b.pickDepth(a*e.pixelRatio,d*e.pixelRatio,e),n.isSome(b)&&c>b&&b!==e.nearFar[0]&&b!==e.nearFar[1]&&(c=b));return c===Number.MAX_VALUE?void 0:c};h._ensureDepthBuffer=function(b){b=4*b[2]*b[3];if(n.isNone(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<b)this._tmpDepthBuffer=new Uint8Array(b);return this._tmpDepthBuffer};h.reloadShaders=async function(){U.removeLoadedShaderModules();await this._shaderTechniqueRepository.reloadAll();
this.requestRender()};h._registerFrameTask=function(b){const a=b.view.state;let d=!1,e=p.RenderRequestType.BACKGROUND,c=!1;this._frameTask=F.addFrameTask({preRender:({time:k})=>{d=this.updating;e=this._needsUpdate?p.RenderRequestType.UPDATE:p.RenderRequestType.BACKGROUND;b.commitSyncLayers();var m=y.Milliseconds(k-this._lastAnimationUpdate);if(m>this.renderer.animationTimestep||n.isSome(a.forcedAnimationTime)||d||this._needsRender)m=y.Milliseconds(m/this.renderer.animationTimeDilation),m=new N.UpdateParameters(a.camera,
m,a.forcedAnimationTime),this.renderer.updateAnimation(m)&&this.requestRender(p.RenderRequestType.BACKGROUND),this._lastAnimationUpdate=k},render:({time:k})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&0<a.camera.fullWidth&&0<a.camera.fullHeight){const m=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsWaterReflectionUpdate=this._needsUpdate=this._needsRender=!1;this.renderer.render(null,null,a,p.Decorations.ON,
k);c=!0;m&&this.renderer.hasWaterReflection&&(this.requestRender(p.RenderRequestType.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:k})=>{const m=new A.ScreenshotContext(a.camera,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update();this._screenshotManager.update(m,k)},finish:()=>{c&&(this.renderer.finish(a.mode===B.RenderState.IDLE?e:p.RenderRequestType.UPDATE),c=!1)}})};h._initializeContext=function(b){const a=b.options;this._canvas=a.canvas;
this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const d=W.createContextOrErrorHTML("3d",this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:a.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:a.preserveDrawingBuffer??!1});n.isNone(d)?(b=u("esri-force-webgl"),w.getLogger(this.declaredClass).error("A WebGL context with the requested version ("+b?b:"automatic) could not be created.")):
(this._rctx=this._newRenderingContext(d,b),this._loadShaderOnlyExtensions(),!a.alpha&&this._rctx.contextAttributes.alpha&&w.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&11<=u("safari")&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas))};h._newRenderingContext=function(b,a){const d={disabledExtensions:a.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.options.debugWebGLExtensions||
{},maxAnisotropy:8},e=(c,k)=>a.view.resourceController.memoryController.newCache(c,k);if(V.contextCache.enabled){let c=C.get(b);if(c)return c.configure(d),c.newCache=e,c.ref(),c;c=new z.RenderingContext(b,d,e);C.set(b,c);c.ref();return c}return new z.RenderingContext(b,d,e)};h._loadShaderOnlyExtensions=function(){this._rctx.capabilities.enable("textureFloat")};h.getObjectAndLayerIdColor=function(b){return n.isSome(this.objectAndLayerIdRenderHelper)?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(b):
null};t._createClass(q,[{key:"performanceInfo",get:function(){const b=this._rctx.gl;return{renderer:this.renderer.performanceInfo,textureMemory:void 0!==b.getUsedTextureMemory?b.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==b.getUsedRenderbufferMemory?b.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==b.getUsedVBOMemory?b.getUsedVBOMemory():void 0}}},{key:"updating",get:function(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||
this.waterTextureRepository.updating||this._magnifierHelper.updating}},{key:"textureRepository",get:function(){return this._textureRepository}},{key:"compositingHelper",get:function(){return this._compositingHelper}},{key:"magnifier",set:function(b){this._magnifierHelper.magnifier=b}},{key:"renderingContext",get:function(){return this._rctx}},{key:"capabilities",get:function(){return this._rctx.capabilities}},{key:"canvas",get:function(){return this._canvas}},{key:"componentObjectCollection",get:function(){n.isNone(this._componentObjectCollection)&&
(this._componentObjectCollection=new H.ComponentObjectCollection(this.renderer.renderPassManager,this._viewingMode));return this._componentObjectCollection},set:function(b){this._componentObjectCollection=b}}]);return q}(D);g.__decorate([l.property({type:Boolean,readOnly:!0})],f.RenderView.prototype,"updating",null);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"_rctx",void 0);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"_container",void 0);g.__decorate([l.property({autoDestroy:!0})],
f.RenderView.prototype,"_canvas",void 0);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"_stippleTextureRepository",void 0);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"waterTextureRepository",void 0);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"_magnifierHelper",void 0);g.__decorate([l.property({readOnly:!0})],f.RenderView.prototype,"objectAndLayerIdRenderHelper",void 0);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,
"_textureRepository",void 0);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"_compositingHelper",void 0);g.__decorate([l.property({autoDestroy:!0,readOnly:!0})],f.RenderView.prototype,"renderer",void 0);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"_screenshotManager",void 0);g.__decorate([l.property()],f.RenderView.prototype,"componentObjectCollection",null);g.__decorate([l.property({autoDestroy:!0})],f.RenderView.prototype,"_componentObjectCollection",void 0);
g.__decorate([l.property()],f.RenderView.prototype,"_needsUpdate",void 0);g.__decorate([l.property()],f.RenderView.prototype,"_needsWaterReflectionUpdate",void 0);f.RenderView=g.__decorate([G.subclass("esri.views.3d.webgl-engine.parts.RenderView")],f.RenderView);const C=T.getContextCache();Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});