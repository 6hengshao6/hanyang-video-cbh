// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ./BindParameters ./depthRange ./glUtil3D ./ShadowCastRenderer ./ShadowMap ../../../../chunks/ShadowCastAccumulate.glsl ../shaders/ShadowCastAccumulateTechnique ../../../support/Scheduler ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Util".split(" "),
function(d,n,f,z,A,B,C,m,q,g,O,P,D,t,E,F,u,G,r,H,v,I,J,h,K,L){d.ShadowAccumulator=function(c){function p(a,e,l,k,M,w){var b=N.call(this,{});b._rctx=a;b._stage=l;b._prepareForShadowMapPass=k;b._renderToShadowMap=M;b._requestRender=w;b._progress=0;b._sampleCount=0;b._passParameters=new v.ShadowCastAccumulatePassParameters;b._enabledInternal=!1;b._cachedLightDirections=[];b._depthRange=u.ZERO;b._previewing=!1;b._handles=new B;b._cameraForcedForScreenshot=!1;b._bindParameters=new F.BindParameters(new H.ShadowMap(a,
l.viewingMode),null,null);b._bindParameters.shadowMap.enabled=!0;b._vao=G.createQuadVAO(a);b._fbo=new K.FramebufferObject(a,{colorTarget:h.TargetType.TEXTURE,depthStencilTarget:h.DepthStencilTargetType.NONE,width:0,height:0},{target:h.TextureType.TEXTURE_2D,pixelFormat:h.PixelFormat.RGBA,dataType:h.PixelType.UNSIGNED_BYTE,samplingMode:h.TextureSamplingMode.LINEAR,wrapMode:h.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0});b._accumulationRenderer=new r.ShadowCastRenderer(e,a,n._assertThisInitialized(b),
w);b._handles.add([b._stage.view.resourceController.scheduler.registerTask(J.TaskPriority.SHADOW_ACCUMULATOR,n._assertThisInitialized(b)),q.watch(()=>l.renderView,x=>{b._handles.remove("renderView");m.isSome(x)&&b._handles.add(x.events.on("force-camera-for-screenshot",()=>b._cameraForcedForScreenshot=!0),"renderView")},q.syncAndInitial),q.watch(()=>b._previewing,()=>b._requestRenderIfEnabled(),q.sync)]);return b}n._inherits(p,c);var N=n._createSuper(p);c=p.prototype;c.normalizeCtorArgs=function(){return{}};
c.runTask=function(a){for(this._prepareForShadowMapPass(this._bindParameters);!a.done&&!this._isDoneAccumulating;)this._accumulateShadow(),a.madeProgress();this._requestRender()};c.renderAccumulation=function(a,e,l,k){this._depthRange=e;this._updateCamera(l);this._bindParameters.contentCamera=k;this._passParameters.linearDepthTexture=a;this._passParameters.origin=this._bindParameters.camera.center;this.notifyChange("canAccumulate");if(this.isAccumulating&&this.canAccumulate){(this._previewing||0===
this._progress||this._cameraForcedForScreenshot)&&this._clear();a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(6,this._sampleCount-this._progress);for(e=0;e<a;++e)this._accumulateShadow();this._cameraForcedForScreenshot=!1;this._requestRender()}};c.render=function(a){this._accumulationRenderer.render(a)};c.dispose=function(){this._stop();this._handles.destroy();this._accumulationRenderer=m.disposeMaybe(this._accumulationRenderer);this._bindParameters.shadowMap.dispose();this._fbo=m.disposeMaybe(this._fbo);
this._vao=m.disposeMaybe(this._vao);this._accumulationTechniqueCached=m.releaseMaybe(this._accumulationTechniqueCached);this._sampleCount=this._cachedLightDirections.length=0};c.setOptions=function(a){void 0!==a.enabled&&(this._enabled=a.enabled);void 0!==a.previewing&&(this._previewing=a.previewing);void 0!==a.lightDirections&&(this._lightDirections=a.lightDirections);this._accumulationRenderer.setOptions(a)};c.readAccumulatedShadow=function(a,e){if(!this._isActive||1>this._progress||0>a||a>this._fbo.width||
0>e||e>this._fbo.height)return 0;this._fbo.readPixels(a,e,1,1,h.PixelFormat.RGBA,h.PixelType.UNSIGNED_BYTE,y);return y[0]/this._progress};c._start=function(){this._progress=0;this._enabledInternal=!0};c._stop=function(){this._enabledInternal=!1};c._invalidate=function(){this._progress=0;this._requestRenderIfEnabled()};c._clear=function(){this._rctx.bindFramebuffer(this._fbo);this._rctx.setClearColor(0,0,0,0);this._rctx.clearSafe(h.ClearBufferBit.COLOR_BUFFER_BIT);this._progress=0};c._accumulateShadow=
function(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const a=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo);this._rctx.bindTechnique(a,this._passParameters,this._bindParameters);this._rctx.bindVAO(this._vao);this._rctx.drawArrays(a.primitiveType,0,L.vertexCount(this._vao,"geometry"))};c._sampleLightDirection=function(){this._progress++;return this._lightDirections[104729*this._progress%this._lightDirections.length]};c._updateCamera=
function(a){a.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(a),this._fbo.resize(a.fullWidth,a.fullHeight),this._opacityFromElevation=1-C.smoothstep(r.shadowCastDisableElevationMin,r.shadowCastDisableElevationMax,a.relativeElevation))};c._requestRenderIfEnabled=function(){this._enabledInternal&&this._requestRender()};n._createClass(p,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",
get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){m.isNone(this._accumulationTechniqueCached)&&(this._accumulationTechniqueCached=new I.ShadowCastAccumulateTechnique({rctx:this._rctx,viewingMode:this._stage.viewingMode}));return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewing}},
{key:"_isActive",get:function(){return this._enabledInternal&&0<this._sampleCount}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&this._depthRange!==u.ZERO&&this._opacityFromElevation>r.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirections",get:function(){return this._cachedLightDirections},set:function(a){const e=this._cachedLightDirections;if(!A.equals(e,a,t.equals)){var l=
Math.min(v.ShadowCastMaxSamples,a.length);this._sampleCount=e.length=l;for(let k=0;k<l;++k)e[k]=t.copy(e[k]??E.create(),a[k]);this._invalidate()}}},{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(a){this._accumulationRenderer.opacityFromElevation=a}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&0<this._progress}},{key:"_enabled",set:function(a){a!==this._enabledInternal&&(a?this._start():this._stop())}},
{key:"test",get:function(){const a=this;return{lightDirections:this._lightDirections,get isDone(){return a._isDoneAccumulating},get isActive(){return a._isActive}}}}]);return p}(z);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_progress",void 0);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_sampleCount",void 0);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_enabledInternal",void 0);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_depthRange",void 0);
f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_previewing",void 0);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_accumulationRenderer",void 0);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_isRefining",null);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_isActive",null);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"canAccumulate",null);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"_isDoneAccumulating",null);f.__decorate([g.property()],
d.ShadowAccumulator.prototype,"_opacityFromElevation",null);f.__decorate([g.property()],d.ShadowAccumulator.prototype,"running",null);d.ShadowAccumulator=f.__decorate([D.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],d.ShadowAccumulator);const y=new Uint8Array(4);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});