// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../geometry/support/lineSegment ../../../../geometry/support/plane ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutput ../lib/GLMaterial ../lib/Material ../lib/RenderSlot ../lib/Util ../lib/VertexAttribute ./VisualVariablePassParameters ../shaders/LineMarkerTechniqueConfiguration ../../../../chunks/RibbonLine.glsl ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechniqueConfiguration".split(" "),
function(da,D,aa,ua,ea,V,W,va,h,A,wa,ba,P,x,xa,G,ya,fa,M,za,l,Aa,Ba,Ca,ma,na){function N(f,p,c,a,b){for(let d=0;d<b;d++)c[a++]=f[p++];return a}function oa(f,p,c){p=p.get(l.VertexAttribute.POSITION).data;c=c?c.get(l.VertexAttribute.POSITION):null;return f.isClosed?c?2<c.length:6<p.length:!1}var B;(function(f){f[f.LEFT_JOIN_START=-2]="LEFT_JOIN_START";f[f.LEFT_JOIN_END=-1]="LEFT_JOIN_END";f[f.LEFT_CAP_START=-4]="LEFT_CAP_START";f[f.LEFT_CAP_END=-5]="LEFT_CAP_END";f[f.RIGHT_JOIN_START=2]="RIGHT_JOIN_START";
f[f.RIGHT_JOIN_END=1]="RIGHT_JOIN_END";f[f.RIGHT_CAP_START=4]="RIGHT_CAP_START";f[f.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(B||(B={}));let Ha=function(f){function p(a){a=c.call(this,a,new pa);a._configuration=new na.RibbonLineTechniqueConfiguration;a._vertexAttributeLocations=ma.vertexAttributeLocations;a._layout=a.createLayout();return a}D._inherits(p,f);var c=D._createSuper(p);f=p.prototype;f.isClosed=function(a,b){return this.parameters.isClosed?b?2<b.length:6<a.length:!1};f.getConfiguration=function(a,
b){this._configuration.output=a;this._configuration.draped=b.slot===M.RenderSlot.DRAPED_MATERIAL;a=V.isSome(this.parameters.stipplePattern)&&a!==G.ShaderOutput.Highlight;this._configuration.stippleEnabled=a;this._configuration.stippleOffColorEnabled=a&&V.isSome(this.parameters.stippleOffColor);this._configuration.stippleScaleWithLineWidth=a&&this.parameters.stippleScaleWithLineWidth;this._configuration.stipplePreferContinuous=a&&this.parameters.stipplePreferContinuous;this._configuration.hasSlicePlane=
this.parameters.hasSlicePlane;this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.roundJoins="round"===this.parameters.join;this._configuration.capType=this.parameters.cap;a=this._configuration;if(V.isSome(this.parameters.markerParameters)){var d=this.parameters.markerParameters;d=d.anchor===Ba.LineMarkerAnchor.Tip&&d.hideOnShortSegments&&"begin-end"===d.placement&&d.worldSpace}else d=!1;a.applyMarkerOffset=d;this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset;
this._configuration.writeDepth=this.parameters.writeDepth;this._configuration.vvSize=!!this.parameters.vvSize;this._configuration.vvColor=!!this.parameters.vvColor;this._configuration.vvOpacity=!!this.parameters.vvOpacity;this._configuration.innerColorEnabled=0<this.parameters.innerWidth&&V.isSome(this.parameters.innerColor);this._configuration.falloffEnabled=0<this.parameters.falloff;this._configuration.occluder=this.parameters.renderOccluded===fa.RenderOccludedFlag.OccludeAndTransparentStencil;
this._configuration.transparencyPassType=b.transparencyPassType;this._configuration.hasMultipassTerrain=b.multipassTerrain.enabled;this._configuration.cullAboveGround=b.multipassTerrain.cullAboveGround;this._configuration.wireframe=this.parameters.wireframe;return this._configuration};f.intersectDraped=function(a,b,d,m,e,q){if(d.options.selectionMode){b=a.vertexAttributes.get(l.VertexAttribute.POSITION).data;d=a.vertexAttributes.get(l.VertexAttribute.SIZE);var g=this.parameters.width;this.parameters.vvSize?
(d=a.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0],g*=ea.clamp(this.parameters.vvSize.offset[0]+d*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])):d&&(g*=d.data[0]);d=m[0];m=m[1];a=(g/2+4)*a.screenToWorldRatio;g=Number.MAX_VALUE;var u=0;for(let H=0;H<b.length-5;H+=3){var r=b[H],w=b[H+1],E=d-r,k=m-w;r=b[H+3]-r;w=b[H+4]-w;const O=ea.clamp((r*E+w*k)/(r*r+w*w),0,1);E=r*O-E;k=w*O-k;k=E*E+k*k;k<g&&(g=k,u=H/3)}g<a*a&&e(q.dist,q.normal,
u,!1)}};f.intersect=function(a,b,d,m,e,q){if(d.options.selectionMode&&a.visible)if(za.isTranslationMatrix(b)){var g=a.vertexAttributes;e=g.get(l.VertexAttribute.POSITION).data;m=this.parameters.width;if(this.parameters.vvSize){var u=g.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0];m*=ea.clamp(this.parameters.vvSize.offset[0]+u*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else g.has(l.VertexAttribute.SIZE)&&(m*=g.get(l.VertexAttribute.SIZE).data[0]);
var r=d.camera,w=Da;va.copy(w,d.point);u=m*r.pixelRatio/2+4*r.pixelRatio;h.set(Y[0],w[0]-u,w[1]+u,0);h.set(Y[1],w[0]+u,w[1]+u,0);h.set(Y[2],w[0]+u,w[1]-u,0);h.set(Y[3],w[0]-u,w[1]-u,0);for(m=0;4>m;m++)if(!r.unprojectFromRenderScreen(Y[m],K[m]))return;x.fromPoints(r.eye,K[0],K[1],ha);x.fromPoints(r.eye,K[1],K[2],ia);x.fromPoints(r.eye,K[2],K[3],ja);x.fromPoints(r.eye,K[3],K[0],ka);var E=Number.MAX_VALUE;m=0;a=oa(this.parameters,g,a.indices)?e.length-2:e.length-5;for(g=0;g<a;g+=3){y[0]=e[g]+b[12];y[1]=
e[g+1]+b[13];y[2]=e[g+2]+b[14];var k=(g+3)%e.length;z[0]=e[k]+b[12];z[1]=e[k+1]+b[13];z[2]=e[k+2]+b[14];if(!(0>x.signedDistance(ha,y)&&0>x.signedDistance(ha,z)||0>x.signedDistance(ia,y)&&0>x.signedDistance(ia,z)||0>x.signedDistance(ja,y)&&0>x.signedDistance(ja,z)||0>x.signedDistance(ka,y)&&0>x.signedDistance(ka,z))){r.projectToRenderScreen(y,Q);r.projectToRenderScreen(z,R);if(0>Q[2]&&0<R[2])h.subtract(I,y,z),k=r.frustum,k=-x.signedDistance(k[ba.PlaneIndex.NEAR],y)/h.dot(I,x.normal(k[ba.PlaneIndex.NEAR])),
h.scale(I,I,k),h.add(y,y,I),r.projectToRenderScreen(y,Q);else if(0<Q[2]&&0>R[2])h.subtract(I,z,y),k=r.frustum,k=-x.signedDistance(k[ba.PlaneIndex.NEAR],z)/h.dot(I,x.normal(k[ba.PlaneIndex.NEAR])),h.scale(I,I,k),h.add(z,z,I),r.projectToRenderScreen(z,R);else if(0>Q[2]&&0>R[2])continue;Q[2]=0;R[2]=0;k=P.distance2(P.fromPoints(Q,R,qa),w);k<E&&(E=k,h.copy(ra,y),h.copy(sa,z),m=g/3)}}b=d.rayBegin;d=d.rayEnd;E<u*u&&(e=Number.MAX_VALUE,P.closestLineSegmentPoint(P.fromPoints(ra,sa,qa),P.fromPoints(b,d,Ea),
S)&&(h.subtract(S,S,b),e=h.length(S),h.scale(S,S,1/e),e/=h.distance(b,d)),q(e,S,m,!1))}else ua.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix")};f.createLayout=function(){const a=xa.newLayout().vec3f(l.VertexAttribute.POSITION).f32(l.VertexAttribute.SUBDIVISIONFACTOR).vec2f(l.VertexAttribute.UV0).vec3f(l.VertexAttribute.AUXPOS1).vec3f(l.VertexAttribute.AUXPOS2);this.parameters.vvSize?a.f32(l.VertexAttribute.SIZEFEATUREATTRIBUTE):
a.f32(l.VertexAttribute.SIZE);this.parameters.vvColor?a.f32(l.VertexAttribute.COLORFEATUREATTRIBUTE):a.vec4f(l.VertexAttribute.COLOR);this.parameters.vvOpacity&&a.f32(l.VertexAttribute.OPACITYFEATUREATTRIBUTE);aa("enable-feature:objectAndLayerId-rendering")&&a.vec4u8(l.VertexAttribute.OBJECTANDLAYERIDCOLOR);return a};f.createBufferWriter=function(){return new Fa(this._layout,this.parameters)};f.requiresSlot=function(a,b){return b===G.ShaderOutput.Color||b===G.ShaderOutput.Alpha||b===G.ShaderOutput.Highlight||
b===G.ShaderOutput.Depth||b===G.ShaderOutput.ObjectAndLayerIdColor?a===M.RenderSlot.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===fa.RenderOccludedFlag.OccludeAndTransparentStencil?a===M.RenderSlot.OPAQUE_MATERIAL||a===M.RenderSlot.OCCLUDER_MATERIAL||a===M.RenderSlot.TRANSPARENT_OCCLUDER_MATERIAL:b===G.ShaderOutput.Color||b===G.ShaderOutput.Alpha?a===(this.parameters.writeDepth?M.RenderSlot.TRANSPARENT_MATERIAL:M.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):a===M.RenderSlot.OPAQUE_MATERIAL:
!1};f.createGLMaterial=function(a){return new Ga(a)};f.validateParameters=function(a){"miter"!==a.join&&(a.miterLimit=0);V.isSome(a.markerParameters)&&(a.markerScale=a.markerParameters.width/a.width)};return D._createClass(p)}(fa.Material),Ga=function(f){function p(){var a=c.apply(this,arguments);a._stipplePattern=null;return a}D._inherits(p,f);var c=D._createSuper(p);f=p.prototype;f.dispose=function(){D._get(D._getPrototypeOf(p.prototype),"dispose",this).call(this);this._stippleTextureRepository.release(this._stipplePattern);
this._stipplePattern=null};f._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})};f.beginSlot=function(a){this._output!==G.ShaderOutput.Color&&this._output!==G.ShaderOutput.Alpha||this._updateOccludeeState(a);const b=this._material.parameters.stipplePattern;this._stipplePattern!==b&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,b)),this._stipplePattern=b);return this.ensureTechnique(ma.RibbonLineTechnique,
a)};return D._createClass(p)}(ya),pa=function(f){function p(){var a=c.apply(this,arguments);a.width=0;a.color=wa.ONES;a.join="miter";a.cap=na.CapType.BUTT;a.miterLimit=5;a.writeDepth=!0;a.hasPolygonOffset=!1;a.stippleTexture=null;a.stippleScaleWithLineWidth=!1;a.stipplePreferContinuous=!0;a.markerParameters=null;a.markerScale=1;a.hasSlicePlane=!1;a.vvFastUpdate=!1;a.isClosed=!1;a.falloff=0;a.innerWidth=0;a.hasOccludees=!1;a.wireframe=!1;return a}D._inherits(p,f);var c=D._createSuper(p);return D._createClass(p)}(Aa.VisualVariablePassParameters),
Fa=function(){function f(c,a){this._parameters=a;this.numJoinSubdivisions=0;this.vertexBufferLayout=c;c=a.stipplePattern?1:0;switch(this._parameters.join){case "miter":case "bevel":this.numJoinSubdivisions=c;break;case "round":this.numJoinSubdivisions=Ca.RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS+c}}var p=f.prototype;p._isClosed=function(c){return oa(this._parameters,c.vertexAttributes,c.indices)};p.allocate=function(c){return this.vertexBufferLayout.createBuffer(c)};p.elementCount=function(c){var a=
c.indices.get(l.VertexAttribute.POSITION).length/2+1;c=this._isClosed(c);a=(c?2:4)+((c?a:a-1)-(c?0:1))*(2*this.numJoinSubdivisions+4);a+=2;this._parameters.wireframe&&(a=2+4*(a-2));return a};p.write=function(c,a,b,d,m){a=Ia;const e=Ja,q=Ka,g=b.vertexAttributes.get(l.VertexAttribute.POSITION).data;var u=b.indices&&b.indices.get(l.VertexAttribute.POSITION);const r=b.vertexAttributes.get(l.VertexAttribute.DISTANCETOSTART)?.data;u&&u.length!==2*(g.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");
let w=1,E=0;this._parameters.vvSize?E=b.vertexAttributes.get(l.VertexAttribute.SIZEFEATUREATTRIBUTE).data[0]:b.vertexAttributes.has(l.VertexAttribute.SIZE)&&(w=b.vertexAttributes.get(l.VertexAttribute.SIZE).data[0]);let k=[1,1,1,1],H=0;this._parameters.vvColor?H=b.vertexAttributes.get(l.VertexAttribute.COLORFEATUREATTRIBUTE).data[0]:b.vertexAttributes.has(l.VertexAttribute.COLOR)&&(k=b.vertexAttributes.get(l.VertexAttribute.COLOR).data);const O=aa("enable-feature:objectAndLayerId-rendering")?b.objectAndLayerIdColor:
null;let ta=0;this._parameters.vvOpacity&&(ta=b.vertexAttributes.get(l.VertexAttribute.OPACITYFEATUREATTRIBUTE).data[0]);u=g.length/3;const t=new Float32Array(d.buffer),ca=aa("enable-feature:objectAndLayerId-rendering")?new Uint8Array(d.buffer):null,T=this.vertexBufferLayout.stride/4;let n=m*T;m=n;let C=0;const la=r?(v,J,L)=>C=r[L]:(v,J,L)=>C+=h.distance(v,J),La=aa("enable-feature:objectAndLayerId-rendering"),F=(v,J,L,Ma,Na,Oa,Pa)=>{t[n++]=J[0];t[n++]=J[1];t[n++]=J[2];t[n++]=Ma;t[n++]=Pa;t[n++]=Na;
t[n++]=v[0];t[n++]=v[1];t[n++]=v[2];t[n++]=L[0];t[n++]=L[1];t[n++]=L[2];t[n++]=this._parameters.vvSize?E:w;this._parameters.vvColor?t[n++]=H:(v=Math.min(4*Oa,k.length-4),t[n++]=k[v],t[n++]=k[v+1],t[n++]=k[v+2],t[n++]=k[v+3]);this._parameters.vvOpacity&&(t[n++]=ta);La&&(V.isSome(O)&&(ca[4*n]=O[0],ca[4*n+1]=O[1],ca[4*n+2]=O[2],ca[4*n+3]=O[3]),n++)};n+=T;h.set(e,g[0],g[1],g[2]);c&&h.transformMat4(e,e,c);if(b=this._isClosed(b)){var U=g.length-3;h.set(a,g[U],g[U+1],g[U+2]);c&&h.transformMat4(a,a,c)}else h.set(q,
g[3],g[4],g[5]),c&&h.transformMat4(q,q,c),F(e,e,q,1,B.LEFT_CAP_START,0,0),F(e,e,q,1,B.RIGHT_CAP_START,0,0),h.copy(a,e),h.copy(e,q);U=b?0:1;const Z=b?u:u-1;for(let v=U;v<Z;v++){var X=(v+1)%u*3;h.set(q,g[X],g[X+1],g[X+2]);c&&h.transformMat4(q,q,c);la(a,e,v);F(a,e,q,0,B.LEFT_JOIN_END,v,C);F(a,e,q,0,B.RIGHT_JOIN_END,v,C);X=this.numJoinSubdivisions;for(let J=0;J<X;++J){const L=(J+1)/(X+1);F(a,e,q,L,B.LEFT_JOIN_END,v,C);F(a,e,q,L,B.RIGHT_JOIN_END,v,C)}F(a,e,q,1,B.LEFT_JOIN_START,v,C);F(a,e,q,1,B.RIGHT_JOIN_START,
v,C);h.copy(a,e);h.copy(e,q)}b?(h.set(q,g[3],g[4],g[5]),c&&h.transformMat4(q,q,c),C=la(a,e,Z),F(a,e,q,0,B.LEFT_JOIN_END,U,C),F(a,e,q,0,B.RIGHT_JOIN_END,U,C)):(C=la(a,e,Z),F(a,e,e,0,B.LEFT_CAP_END,Z,C),F(a,e,e,0,B.RIGHT_CAP_END,Z,C));N(t,m+T,t,m,T);n=N(t,n-T,t,n,T);this._parameters.wireframe&&this._addWireframeVertices(d,m,n,T)};p._addWireframeVertices=function(c,a,b,d){const m=new Float32Array(c.buffer,b*Float32Array.BYTES_PER_ELEMENT);c=new Float32Array(c.buffer,a*Float32Array.BYTES_PER_ELEMENT,
b-a);a=0;for(b=0;b<c.length-1;b+=2*d)a=N(c,b,m,a,d),a=N(c,b+2*d,m,a,d),a=N(c,b+1*d,m,a,d),a=N(c,b+2*d,m,a,d),a=N(c,b+1*d,m,a,d),a=N(c,b+3*d,m,a,d)};return D._createClass(f)}();const y=A.create(),z=A.create(),I=A.create(),S=A.create(),Da=A.create(),Q=W.createRenderScreenPointArray3(),R=W.createRenderScreenPointArray3(),ra=A.create(),sa=A.create(),qa=P.create(),Ea=P.create(),Ia=A.create(),Ja=A.create(),Ka=A.create(),Y=[W.createRenderScreenPointArray3(),W.createRenderScreenPointArray3(),W.createRenderScreenPointArray3(),
W.createRenderScreenPointArray3()],K=[A.create(),A.create(),A.create(),A.create()],ha=x.create(),ia=x.create(),ja=x.create(),ka=x.create();da.Parameters=pa;da.RibbonLineMaterial=Ha;Object.defineProperty(da,Symbol.toStringTag,{value:"Module"})});