// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/promiseUtils ../../../../chunks/vec4f64 ../lib/basicInterfaces ../../../support/screenshotUtils ../../../webgl/enums ../../../webgl/FramebufferObject ../../../../core/imageUtils".split(" "),function(r,v,w,y,z,t,A,m,x,u){let B=v._createClass(function(q,h){this.viewCamera=q;this.frameHasDecorations=h}),C=function(){function q(b,a,e,c){this._rctx=b;this._renderFunctions=a;this._forceCameraHook=e;this._disposeOffscreenBuffers=
c;this.supersample=!0;this._screenshotQueue=[]}var h=q.prototype;h.destroy=function(){this._rctx=null};h.takeScreenshot=async function(b){await this._renderFunctions.prepareOverlay();this._renderFunctions.requestRenderScene(t.RenderRequestType.BACKGROUND);const a=y.createResolver();this._screenshotQueue.push({settings:b,resolver:a});return a.promise};h.update=function(b,a){for(const e of this._screenshotQueue){if(null==this._rctx){e.resolver.reject();continue}const c=this._renderScreenshot(b,{...e.settings,
pixelRatio:e.settings.pixelRatio*b.viewCamera.pixelRatio},a);e.resolver(c)}this._screenshotQueue.length=0};h._renderScreenshotOverlay=function(b,a,e){b.width=a.width;b.height=a.height;const c=b.getContext("2d"),g=e.pixelRatio;c.save();c.translate(0,a.height);c.scale(1,-1);e.region&&c.translate(-e.region.x,-e.region.y);c.scale(g,g);a=this._renderFunctions.renderOverlay(b,a);c.restore();return a};h._readbackScreenshot=function(b,a){return b.resample?this._readbackScreenshotResampled({...b,resample:b.resample},
a):this._readbackScreenshotImmediate(b,a)};h._readbackScreenshotResampled=function(b,a){const {framebufferWidth:e,framebufferHeight:c,region:g,resample:f}=b,p=this._ensureScreenshotEncodeCanvas();let n=u.createEmptyImageData(e,c,p);this._rctx.gl.readPixels(0,0,e,c,m.PixelFormat.RGBA,m.DataType.UNSIGNED_BYTE,new Uint8Array(n.data.buffer));a();n=this._renderScreenshotOverlay(p,n,{...b,region:void 0});b=u.createEmptyImageData(g.width,g.height,p);return A.resampleHermite(n,b,!0,f.region.x,c-(f.region.y+
f.region.height),f.region.width,f.region.height)};h._readbackScreenshotImmediate=function(b,a){const {framebufferHeight:e,region:c}=b,g=this._ensureScreenshotEncodeCanvas(),f=u.createEmptyImageData(c.width,c.height,g);this._rctx.gl.readPixels(c.x,e-(c.y+c.height),c.width,c.height,m.PixelFormat.RGBA,m.DataType.UNSIGNED_BYTE,new Uint8Array(f.data.buffer));a();return this._renderScreenshotOverlay(g,f,b)};h._renderScreenshot=function(b,a,e){let c=null,g=null;const f=b.viewCamera,{framebufferWidth:p,framebufferHeight:n}=
a;var l=!1;b=a.disableDecorations&&b.frameHasDecorations;var d=a.ignorePadding&&f.pixelRatio!==a.pixelRatio;b=p!==f.fullWidth||n!==f.fullHeight||b||d||a.objectAndLayerIdColor;a.objectAndLayerIdColor&&(g=new x.FramebufferObject(this._rctx,{width:p,height:n,colorTarget:m.TargetType.TEXTURE,depthStencilTarget:m.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER}));if(b){d=f.clone();if(a.ignorePadding){l=z.clone(d.padding);for(var k=0;4>k;k++)l[k]=Math.round(l[k]/d.pixelRatio*a.pixelRatio);d.padding=
l}d.fullWidth=p;d.fullHeight=n;d.pixelRatio=a.pixelRatio;l=f.fovX-d.fovX;k=f.fovY-d.fovY;0>l&&l<k?d.fovX=f.fovX:0>k&&k<l&&(d.fovY=f.fovY);this._forceCameraHook(d);l=!0;c=new x.FramebufferObject(this._rctx,{width:d.fullWidth,height:d.fullHeight,colorTarget:m.TargetType.TEXTURE,depthStencilTarget:m.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER});this._renderFunctions.renderScene(c,g,d,a.disableDecorations?t.Decorations.OFF:t.Decorations.ON,e);this._disposeOffscreenBuffers()}d=()=>{this._rctx.bindFramebuffer(null);
w.disposeMaybe(c)};e=this._readbackScreenshot(a,d);d();d=null;a.objectAndLayerIdColor&&(k=()=>{this._rctx.bindFramebuffer(null);w.disposeMaybe(g)},this._rctx.bindFramebuffer(g),d=this._readbackScreenshot(a,k),this._rctx.bindFramebuffer(null),k());if(b&&!this._rctx.contextAttributes.alpha)for(a=3;a<e.data.length;a+=4)e.data[a]=255;if(d&&!this._rctx.contextAttributes.alpha)for(a=3;a<d.data.length;a+=4)d.data[a]=255;l&&this._forceCameraHook(f);return[e,d]};h._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||
(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};return v._createClass(q)}();r.ScreenshotContext=B;r.ScreenshotManager=C;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});