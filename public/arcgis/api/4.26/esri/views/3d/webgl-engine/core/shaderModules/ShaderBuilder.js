// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/Error","../../../../../core/Logger","../../../../../core/maybe"],function(m,g,z,p,q){const v=p.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");p=function(){function b(){this._includedModules=new Map}b.prototype.include=function(e,a){if(this._includedModules.has(e)){const c=this._includedModules.get(e);if(c!==a){v.error("Trying to include shader module multiple times with different sets of options.");
a=new Set;for(const d of Object.keys(c))c[d]!==e[d]&&a.add(d);for(const d of Object.keys(e))c[d]!==e[d]&&a.add(d);a.forEach(d=>console.error(`  ${d}: current ${c[d]} new ${e[d]}`))}}else this._includedModules.set(e,a),e(this.builder,a)};return g._createClass(b)}();let D=function(b){function e(){var c=a.apply(this,arguments);c.vertex=new r;c.fragment=new r;c.attributes=new A;c.varyings=new B;c.extensions=new t;c.constants=new w;return c}g._inherits(e,b);var a=g._createSuper(e);b=e.prototype;b.generate=
function(c){const d=this.extensions.generateSource(c),f=this.attributes.generateSource(c),n=this.varyings.generateSource(c);var l="vertex"===c?this.vertex:this.fragment;const h=l.uniforms.generateSource(),k=l.code.generateSource();c="vertex"===c?"precision highp float;\nprecision highp sampler2D;":"#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif\n\nout vec4 fragColor;";l=this.constants.generateSource().concat(l.constants.generateSource());
return`#version 300 es\n${d.join("\n")}\n\n${c}\n\n${l.join("\n")}\n\n${h.join("\n")}\n\n${f.join("\n")}\n\n${n.join("\n")}\n\n${k.join("\n")}`};b.generateBind=function(c,d){const f=new Map;this.vertex.uniforms.entries.forEach(h=>{const k=h.bind[c];q.isSome(k)&&f.set(h.name,k)});this.fragment.uniforms.entries.forEach(h=>{const k=h.bind[c];q.isSome(k)&&f.set(h.name,k)});const n=Array.from(f.values()),l=n.length;return(h,k,C)=>{for(let u=0;u<l;++u)n[u](d,h,k,C)}};g._createClass(e,[{key:"fragmentUniforms",
get:function(){return this.fragment.uniforms.entries}},{key:"builder",get:function(){return this}}]);return e}(p),x=function(){function b(){this._entries=new Map}var e=b.prototype;e.add=function(a){if(!Array.isArray(a))return this._add(a);for(const c of a)this._add(c)};e.get=function(a){return this._entries.get(a)};e._add=function(a){if(q.isNone(a))v.error(`Trying to add null Uniform from ${Error().stack}.`);else{if(this._entries.has(a.name)&&!this._entries.get(a.name).equals(a))throw new z(`Duplicate uniform name ${a.name} for different uniform type`);
this._entries.set(a.name,a)}};e.generateSource=function(){return Array.from(this._entries.values()).map(a=>q.isSome(a.arraySize)?`uniform ${a.type} ${a.name}[${a.arraySize}];`:`uniform ${a.type} ${a.name};`)};g._createClass(b,[{key:"entries",get:function(){return Array.from(this._entries.values())}}]);return b}(),y=function(){function b(){this._entries=[]}var e=b.prototype;e.add=function(a){this._entries.push(a)};e.generateSource=function(){return this._entries};return g._createClass(b)}(),r=function(b){function e(){var c=
a.apply(this,arguments);c.uniforms=new x;c.code=new y;c.constants=new w;return c}g._inherits(e,b);var a=g._createSuper(e);g._createClass(e,[{key:"builder",get:function(){return this}}]);return e}(p),A=function(){function b(){this._entries=[]}var e=b.prototype;e.add=function(a,c){this._entries.push([a,c])};e.generateSource=function(a){return"fragment"===a?[]:this._entries.map(c=>`in ${c[1]} ${c[0]};`)};return g._createClass(b)}(),B=function(){function b(){this._entries=[]}var e=b.prototype;e.add=function(a,
c){this._entries.push([a,c])};e.generateSource=function(a){return this._entries.map(c=>"vertex"===a?`out ${c[1]} ${c[0]};`:`in ${c[1]} ${c[0]};`)};return g._createClass(b)}(),t=function(){function b(){this._entries=new Set}var e=b.prototype;e.add=function(a){this._entries.add(a)};e.generateSource=function(a){const c="vertex"===a?b.ALLOWLIST_VERTEX:b.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(d=>c.includes(d)).map(d=>`#extension ${d} : enable`)};return g._createClass(b)}();t.ALLOWLIST_FRAGMENT=
["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"];t.ALLOWLIST_VERTEX=[];let w=function(){function b(){this._entries=new Set}var e=b.prototype;e.add=function(a,c,d){let f="ERROR_CONSTRUCTOR_STRING";switch(c){case "float":f=b._numberToFloatStr(d);break;case "int":f=b._numberToIntStr(d);break;case "bool":f=d.toString();break;case "vec2":f=`vec2(${b._numberToFloatStr(d[0])},                            ${b._numberToFloatStr(d[1])})`;break;case "vec3":f=`vec3(${b._numberToFloatStr(d[0])},                            ${b._numberToFloatStr(d[1])},                            ${b._numberToFloatStr(d[2])})`;
break;case "vec4":f=`vec4(${b._numberToFloatStr(d[0])},                            ${b._numberToFloatStr(d[1])},                            ${b._numberToFloatStr(d[2])},                            ${b._numberToFloatStr(d[3])})`;break;case "ivec2":f=`ivec2(${b._numberToIntStr(d[0])},                             ${b._numberToIntStr(d[1])})`;break;case "ivec3":f=`ivec3(${b._numberToIntStr(d[0])},                             ${b._numberToIntStr(d[1])},                             ${b._numberToIntStr(d[2])})`;
break;case "ivec4":f=`ivec4(${b._numberToIntStr(d[0])},                             ${b._numberToIntStr(d[1])},                             ${b._numberToIntStr(d[2])},                             ${b._numberToIntStr(d[3])})`;break;case "mat2":case "mat3":case "mat4":f=`${c}(${Array.prototype.map.call(d,n=>b._numberToFloatStr(n)).join(", ")})`}this._entries.add(`const ${c} ${a} = ${f};`);return this};b._numberToIntStr=function(a){return a.toFixed(0)};b._numberToFloatStr=function(a){return Number.isInteger(a)?
a.toFixed(1):a.toString()};e.generateSource=function(){return Array.from(this._entries)};return g._createClass(b)}();m.Code=y;m.Includes=p;m.ShaderBuilder=D;m.Stage=r;m.Uniforms=x;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});