// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/Evented ../../../../../core/maybe ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/arrayUtils ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../geometry/support/buffer/BufferView ../../../support/mathUtils ../../../support/buffer/InterleavedLayout ../Util ../VertexAttribute".split(" "),
function(f,q,r,A,B,m,t,K,L,M,C,u,D,E,w,F,G,h,H,I,x,e){f.StateFlags=void 0;(function(c){c[c.ALLOCATED=1]="ALLOCATED";c[c.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE";c[c.VISIBLE=4]="VISIBLE";c[c.HIGHLIGHT=8]="HIGHLIGHT";c[c.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE";c[c.REMOVE=32]="REMOVE";c[c.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED";c[c.ACTIVE=18]="ACTIVE"})(f.StateFlags||(f.StateFlags={}));let y=q._createClass(function(c){this.localTransform=c.getField(e.VertexAttribute.LOCALTRANSFORM,h.BufferViewMat4f64);this.globalTransform=
c.getField(e.VertexAttribute.GLOBALTRANSFORM,h.BufferViewMat4f64);this.modelOrigin=c.getField(e.VertexAttribute.MODELORIGIN,h.BufferViewVec3f64);this.model=c.getField(e.VertexAttribute.MODEL,h.BufferViewMat3f);this.modelNormal=c.getField(e.VertexAttribute.MODELNORMAL,h.BufferViewMat3f);this.modelScaleFactors=c.getField(e.VertexAttribute.MODELSCALEFACTORS,h.BufferViewVec2f);this.boundingSphere=c.getField(e.VertexAttribute.BOUNDINGSPHERE,h.BufferViewVec4f64);this.color=c.getField(e.VertexAttribute.COLOR,
h.BufferViewVec4f);this.featureAttribute=c.getField(e.VertexAttribute.FEATUREATTRIBUTE,h.BufferViewVec4f);this.state=c.getField(e.VertexAttribute.STATE,h.BufferViewUint8);this.lodLevel=c.getField(e.VertexAttribute.LODLEVEL,h.BufferViewUint8);this.objectAndLayerIdColor=c.getField(e.VertexAttribute.OBJECTANDLAYERIDCOLOR,h.BufferViewVec4u8)});f.InstanceData=function(c){function n(a,b){a=J.call(this,a);a.events=new B;a._capacity=0;a._size=0;a._next=0;a._buffer=null;a._view=null;let d=I.newLayout().mat4f64(e.VertexAttribute.LOCALTRANSFORM).mat4f64(e.VertexAttribute.GLOBALTRANSFORM).vec4f64(e.VertexAttribute.BOUNDINGSPHERE).vec3f64(e.VertexAttribute.MODELORIGIN).mat3f(e.VertexAttribute.MODEL).mat3f(e.VertexAttribute.MODELNORMAL).vec2f(e.VertexAttribute.MODELSCALEFACTORS);
b.includes("color")&&(d=d.vec4f(e.VertexAttribute.COLOR));b.includes("featureAttribute")&&(d=d.vec4f(e.VertexAttribute.FEATUREATTRIBUTE));d=d.u8(e.VertexAttribute.STATE).u8(e.VertexAttribute.LODLEVEL);b.includes(e.VertexAttribute.OBJECTANDLAYERIDCOLOR)&&(d=d.vec4u8(e.VertexAttribute.OBJECTANDLAYERIDCOLOR));d.alignTo(8);a._layout=d;return a}q._inherits(n,c);var J=q._createSuper(n);c=n.prototype;c.addInstance=function(){this._size+1>this._capacity&&this._grow();const a=this._findSlot();this._view.state.set(a,
f.StateFlags.ALLOCATED);this._size++;this.events.emit("instances-changed");return a};c.removeInstance=function(a){const b=this._view.state;x.assert(0<=a&&a<this._capacity&&0!==(b.get(a)&f.StateFlags.ALLOCATED),"invalid instance handle");this._getStateFlag(a,f.StateFlags.ACTIVE)?this._setStateFlags(a,f.StateFlags.REMOVE):this.freeInstance(a);this.events.emit("instances-changed")};c.freeInstance=function(a){const b=this._view.state;x.assert(0<=a&&a<this._capacity&&0!==(b.get(a)&f.StateFlags.ALLOCATED),
"invalid instance handle");b.set(a,0);this._size--};c.setLocalTransform=function(a,b,d=!0){this._view.localTransform.setMat(a,b);d&&this.updateModelTransform(a)};c.getLocalTransform=function(a,b){this._view.localTransform.getMat(a,b)};c.setGlobalTransform=function(a,b,d=!0){this._view.globalTransform.setMat(a,b);d&&this.updateModelTransform(a)};c.getGlobalTransform=function(a,b){this._view.globalTransform.getMat(a,b)};c.updateModelTransform=function(a){const b=this._view;var d=g;const l=k;b.localTransform.getMat(a,
z);b.globalTransform.getMat(a,v);const p=E.multiply(v,v,z);F.set(d,p[12],p[13],p[14]);b.modelOrigin.setVec(a,d);u.fromMat4(l,p);b.model.setMat(a,l);d=H.scaleFromMatrix(g,p);d.sort();b.modelScaleFactors.set(a,0,d[1]);b.modelScaleFactors.set(a,1,d[2]);u.invert(l,l);u.transpose(l,l);b.modelNormal.setMat(a,l);this._setStateFlags(a,f.StateFlags.TRANSFORM_CHANGED);this.events.emit("instance-transform-changed",{index:a})};c.getModelTransform=function(a,b){const d=this._view;d.model.getMat(a,k);d.modelOrigin.getVec(a,
g);b[0]=k[0];b[1]=k[1];b[2]=k[2];b[3]=0;b[4]=k[3];b[5]=k[4];b[6]=k[5];b[7]=0;b[8]=k[6];b[9]=k[7];b[10]=k[8];b[11]=0;b[12]=g[0];b[13]=g[1];b[14]=g[2];b[15]=1};c.applyShaderTransformation=function(a,b){m.isSome(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,a,b)};c.getCombinedModelTransform=function(a,b){this.getModelTransform(a,b);m.isSome(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,a,b);return b};c.getCombinedLocalTransform=function(a,b){this._view.localTransform.getMat(a,
b);m.isSome(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,a,b);return b};c.getCombinedMaxScaleFactor=function(a){let b=this._view.modelScaleFactors.get(a,1);m.isSome(this.shaderTransformation)&&(this.shaderTransformation.scaleFactor(g,this,a),b*=Math.max(g[0],g[1],g[2]));return b};c.getCombinedMedianScaleFactor=function(a){let b=this._view.modelScaleFactors.get(a,0);if(m.isSome(this.shaderTransformation)){this.shaderTransformation.scaleFactor(g,this,a);a=g[0];var d=g[1];
b*=Math.max(Math.min(a,d),Math.min(Math.max(a,d),g[2]))}return b};c.getModel=function(a,b){this._view.model.getMat(a,b)};c.setFeatureAttribute=function(a,b){this._view.featureAttribute.setVec(a,b)};c.getFeatureAttribute=function(a,b){this._view.featureAttribute.getVec(a,b)};c.setColor=function(a,b){this._view.color.setVec(a,b)};c.setObjectAndLayerIdColor=function(a,b){this._view.objectAndLayerIdColor.setVec(a,b)};c.getColor=function(a,b){this._view.color.getVec(a,b)};c.setVisible=function(a,b){b!==
this.getVisible(a)&&(this._setStateFlag(a,f.StateFlags.VISIBLE,b),this.events.emit("instance-visibility-changed",{index:a}))};c.getVisible=function(a){return this._getStateFlag(a,f.StateFlags.VISIBLE)};c.setHighlight=function(a,b){b!==this.getHighlight(a)&&(this._setStateFlag(a,f.StateFlags.HIGHLIGHT,b),this.events.emit("instance-highlight-changed"))};c.getHighlight=function(a){return this._getStateFlag(a,f.StateFlags.HIGHLIGHT)};c.getState=function(a){return this._view.state.get(a)};c.getLodLevel=
function(a){return this._view.lodLevel.get(a)};c.countFlags=function(a){let b=0;for(let d=0;d<this._capacity;++d)this.getState(d)&a&&++b;return b};c._setStateFlags=function(a,b){const d=this._view.state;b|=d.get(a);d.set(a,b)};c._clearStateFlags=function(a,b){const d=this._view.state;b=d.get(a)&~b;d.set(a,b)};c._setStateFlag=function(a,b,d){d?this._setStateFlags(a,b):this._clearStateFlags(a,b)};c._getStateFlag=function(a,b){return!!(this._view.state.get(a)&b)};c._grow=function(){const a=Math.max(1024,
Math.floor(2*this._capacity)),b=this._layout.createBuffer(a);if(this._buffer){const d=new Uint8Array(this._buffer.buffer);(new Uint8Array(b.buffer)).set(d)}this._capacity=a;this._buffer=b;this._view=new y(this._buffer)};c._findSlot=function(){const a=this._view.state;let b=this._next;for(;a.get(b)&f.StateFlags.ALLOCATED;)b=b+1===this._capacity?0:b+1;this._next=b+1===this._capacity?0:b+1;return b};q._createClass(n,[{key:"capacity",get:function(){return this._capacity}},{key:"size",get:function(){return this._size}},
{key:"buffer",get:function(){return this._buffer.buffer}},{key:"view",get:function(){return this._view}}]);return n}(A);r.__decorate([t.property({constructOnly:!0})],f.InstanceData.prototype,"shaderTransformation",void 0);r.__decorate([t.property()],f.InstanceData.prototype,"_size",void 0);r.__decorate([t.property({readOnly:!0})],f.InstanceData.prototype,"size",null);f.InstanceData=r.__decorate([C.subclass("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],f.InstanceData);const g=G.create(),
k=D.create(),z=w.create(),v=w.create();f.InstanceDataView=y;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});