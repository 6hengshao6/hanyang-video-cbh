// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/MapUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec2f64 ../../terrain/Intersector ./ChangeSet ./Intersector ./IntersectorInterfaces ./ModelDirtyTypes ./rendererUtils ../materials/renderers/MergedRenderer".split(" "),
function(k,t,l,y,u,q,z,n,K,L,M,A,B,C,D,E,v,r,F,G){function H(f,h,p,a,b,c,d){const e=new C.OverlayTarget(c,d,h);h=g=>{g.set(v.IntersectorType.OVERLAY,e,f.dist,f.normal,f.transformation,p,a)};(null==b.results.min.drapedLayerOrder||p>=b.results.min.drapedLayerOrder)&&(null==b.results.min.dist||b.results.ground.dist<=b.results.min.dist)&&h(b.results.min);b.options.store!==v.StoreResults.MIN&&(null==b.results.max.drapedLayerOrder||p<b.results.max.drapedLayerOrder)&&(null==b.results.max.dist||b.results.ground.dist>
b.results.max.dist)&&h(b.results.max);b.options.store===v.StoreResults.ALL&&(c=E.newIntersectorResult(b.ray),h(c),b.results.all.push(c))}k.SortedRenderGeometryRenderer=function(f){function h(a){a=p.call(this,a);a._pending=new I;a._changes=new D.ChangeSet;a._materialRenderers=new Map;a._sortedMaterialRenderers=new z;a._geometries=new Map;a._hasHighlights=!1;a._hasWater=!1;return a}t._inherits(h,f);var p=t._createSuper(h);f=h.prototype;f.destroy=function(){this._changes.prune();this._materialRenderers.forEach(a=>
a.dispose());this._materialRenderers.clear();this._sortedMaterialRenderers.clear();this._geometries.clear();this._pending.clear()};f.commitChanges=function(){if(!this.updating)return!1;this._processAddsRemoves();let a=!1,b=!1,c=!1;F.splitRenderGeometryChangeSetByMaterial(this._changes).forEach((d,e)=>{let g=this._materialRenderers.get(e);!g&&0<d.adds.length&&(g=new G.MergedRenderer(this.rctx,this._materialRepository,e),this._materialRenderers.set(e,g),c=b=a=!0);if(g){var m=b||g.hasHighlights,x=c||
g.hasWater;g.modify(d);b=b||m!==g.hasHighlights;c=c||x!==g.hasWater;g.isEmpty&&(this._materialRenderers.delete(e),g.dispose(),a=!0)}});this._changes.clear();a&&this._updateSortedMaterialRenderers();b&&(this._hasHighlights=u.someMap(this._materialRenderers,d=>d.hasHighlights));c&&(this._hasWater=u.someMap(this._materialRenderers,d=>d.hasWater));this.notifyChange("updating");return!0};f.addGeometries=function(a,b){if(0!==a.length){var c=this._validateRenderGeometries(a);for(var d of c)this._geometries.set(d.id,
d);d=this._pending.empty;for(const e of c)this._pending.adds.add(e);d&&this.notifyChange("updating");b===r.DirtyOperation.UPDATE&&this._notifyGraphicGeometryChanged(a)}};f.removeGeometries=function(a,b){const c=this._pending.empty,d=this._pending.adds;for(const e of a)d.has(e)?(this._pending.removed.add(e),d.delete(e)):this._pending.removed.has(e)||this._pending.removes.add(e),this._geometries.delete(q.unwrap(e.id));c&&!this._pending.empty&&this.notifyChange("updating");b===r.DirtyOperation.UPDATE&&
this._notifyGraphicGeometryChanged(a)};f.modifyGeometries=function(a,b){const c=0===this._changes.updates.length;for(const d of a){const e=this._changes.updates.pushNew();e.renderGeometry=this._validateRenderGeometry(d);e.updateType=b}c&&0<this._changes.updates.length&&this.notifyChange("updating");switch(b){case r.DirtyState.TRANSFORMATION:case r.DirtyState.GEOMETRY:return this._notifyGraphicGeometryChanged(a);case r.DirtyState.VISIBILITY:return this._notifyGraphicVisibilityChanged(a)}};f.updateAnimation=
function(a){let b=!1;this._sortedMaterialRenderers.forAll(c=>b=c.updateAnimation(a)||b);return b};f.render=function(a){this._sortedMaterialRenderers.forAll(b=>{if(b.material.shouldRender(a)){const c=b.prepareTechnique(a);q.isSome(c)&&b.render(a,c)}})};f.intersect=function(a,b,c,d,e){this._geometries.forEach(g=>{if(!d||d(g)){this._intersectRenderGeometry(g,c,b,0,a,e);var m=this.rendererContext.longitudeCyclical;m&&(g.boundingSphere[0]-g.boundingSphere[3]<m.min&&this._intersectRenderGeometry(g,c,b,
m.range,a,e),g.boundingSphere[0]+g.boundingSphere[3]>m.max&&this._intersectRenderGeometry(g,c,b,-m.range,a,e));e++}});return e};f._updateSortedMaterialRenderers=function(){this._sortedMaterialRenderers.clear();let a=0;this._materialRenderers.forEach((b,c)=>{c.insertOrder=a++;this._sortedMaterialRenderers.push(b)});this._sortedMaterialRenderers.sort((b,c)=>{const d=c.material.renderPriority-b.material.renderPriority;return 0!==d?d:b.material.insertOrder-c.material.insertOrder})};f._processAddsRemoves=
function(){this._changes.adds.clear();this._changes.removes.clear();this._changes.adds.pushArray(Array.from(this._pending.adds));this._changes.removes.pushArray(Array.from(this._pending.removes));for(let a=0;a<this._changes.updates.length;)this._pending.has(this._changes.updates.data[a].renderGeometry)?this._changes.updates.removeUnorderedIndex(a):a++;this._pending.clear()};f._intersectRenderGeometry=function(a,b,c,d,e,g){if(a.visible){var m=0;d+=a.transformation[12];m=a.transformation[13];w[0]=c[0]-
d;w[1]=c[1]-m;a.screenToWorldRatio=this.rendererContext.screenToWorldRatio;a.material.intersectDraped(a,null,e,w,(x,N,J)=>{H(b,J,a.material.renderPriority,g,e,a.layerUid,a.graphicUid)},b)}};f._notifyGraphicGeometryChanged=function(a){if(!q.isNone(this.drapeSource.notifyGraphicGeometryChanged))for(const c of a)if(a=c.graphicUid,q.isSome(a)&&a!==b){this.drapeSource.notifyGraphicGeometryChanged(a);var b=a}};f._notifyGraphicVisibilityChanged=function(a){if(!q.isNone(this.drapeSource.notifyGraphicVisibilityChanged))for(const c of a)if(a=
c.graphicUid,q.isSome(a)&&a!==b){this.drapeSource.notifyGraphicVisibilityChanged(a);var b=a}};f._validateRenderGeometries=function(a){for(const b of a)this._validateRenderGeometry(b);return a};f._validateRenderGeometry=function(a){q.isNone(a.localOrigin)&&(a.localOrigin=this._localOriginFactory.getOrigin(a.boundingSphere));return a};t._createClass(h,[{key:"updating",get:function(){return!this._pending.empty||0<this._changes.updates.length}},{key:"rctx",get:function(){return this.rendererContext.rctx}},
{key:"_materialRepository",get:function(){return this.rendererContext.materialRepository}},{key:"_localOriginFactory",get:function(){return this.rendererContext.localOriginFactory}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return u.someMap(this._materialRenderers,a=>a.rendersOccluded)}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size&&0===this._geometries.size}},
{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]);return h}(y);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,"drapeSource",void 0);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,"updating",null);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,"rctx",null);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,"rendererContext",void 0);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,
"_materialRepository",null);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,"_localOriginFactory",null);l.__decorate([n.property({readOnly:!0})],k.SortedRenderGeometryRenderer.prototype,"isEmpty",null);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,"_materialRenderers",void 0);l.__decorate([n.property()],k.SortedRenderGeometryRenderer.prototype,"_geometries",void 0);k.SortedRenderGeometryRenderer=l.__decorate([A.subclass("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],
k.SortedRenderGeometryRenderer);let I=function(){function f(){this.adds=new Set;this.removes=new Set;this.removed=new Set}var h=f.prototype;h.has=function(p){return this.adds.has(p)||this.removes.has(p)||this.removed.has(p)};h.clear=function(){this.adds.clear();this.removes.clear();this.removed.clear()};t._createClass(f,[{key:"empty",get:function(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}}]);return f}();const w=B.create();Object.defineProperty(k,Symbol.toStringTag,
{value:"Module"})});