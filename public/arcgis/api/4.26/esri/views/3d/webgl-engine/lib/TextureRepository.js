// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Evented ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ./basicInterfaces ./ContentObjectType ./TextureTechnique ./TextureTechniqueConfiguration ./Util ../../../support/Scheduler".split(" "),
function(f,h,k,w,x,r,l,t,n,G,H,I,y,u,z,A,B,C,D){f.TextureRepository=function(d){function e(b,a,g){var c=p.call(this,{});c._stage=b;c._techniqueRepository=a;c._rctx=g;c._textures=new Map;c._loadingCount=0;c._frameUpdates=new Map;c.events=new x;c._frameTask=b.view.resourceController.scheduler.registerTask(D.TaskPriority.TEXTURE_UNLOAD);return c}h._inherits(e,d);var p=h._createSuper(e);d=e.prototype;d.normalizeCtorArgs=function(){return{}};d.destroy=function(){this._frameTask.remove();this._stage.forEachOfType(z.ContentObjectType.Texture,
b=>b.unload())};d.acquire=function(b){const a=this._textures.get(b);return a?(a.ref(),l.unwrapOr(a.loadingPromise,a)):this._createNewRef(b)};d.update=function(){let b=!1;this._frameUpdates.forEach(a=>{const g=a.texture.frameUpdate(this._rctx,this.textureTechnique,a.previousToken);0<=g&&g!==a.previousToken&&(a.previousToken=g,b=!0)});b&&this.events.emit("changed",u.RenderRequestType.BACKGROUND)};d._createNewRef=function(b){const a=this._stage.getObject(b);if(l.isNone(a))return C.assert(void 0!==a),
null;const g=a.events.on("unloaded",()=>{g.remove();this._onTextureUnloaded(b)}),c=new E(b,()=>{this._frameTask.schedule(()=>{c.isUnreferenced&&a.unload()})});this._textures.set(b,c);c.ref();if(l.isSome(a.glTexture))return this._updateGLTexture(c,a.glTexture),a.requiresFrameUpdates&&this._frameUpdates.set(b,{texture:a,previousToken:-1}),c;this._loadingCount++;c.loadingPromise=this._stage.schedule(()=>{const q=a.load(this._rctx,()=>this.textureTechnique),v=m=>{this._loadingCount--;c.loadingPromise=
null;this._updateGLTexture(c,m);a.requiresFrameUpdates&&this._frameUpdates.set(b,{texture:a,previousToken:-1});return c},F=m=>{this._loadingCount--;c.loadingPromise=null;t.isAbortError(m)||r.getLogger(this.declaredClass).error(m);return null};return t.isPromiseLike(q)?q.then(v,F):v(q)});return c.loadingPromise};d._updateGLTexture=function(b,a){b.glTexture=a;this.events.emit("changed",u.RenderRequestType.UPDATE)};d._onTextureUnloaded=function(b){this._textures.delete(b);this._frameUpdates.delete(b)};
h._createClass(e,[{key:"updating",get:function(){return 0<this._loadingCount||this._frameTask.updating}},{key:"textureTechnique",get:function(){l.isNone(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(A.TextureTechnique,new B.TextureTechniqueConfiguration));return this._textureTechnique}}]);return e}(w);k.__decorate([n.property()],f.TextureRepository.prototype,"_loadingCount",void 0);k.__decorate([n.property()],f.TextureRepository.prototype,"_frameTask",void 0);
k.__decorate([n.property()],f.TextureRepository.prototype,"updating",null);f.TextureRepository=k.__decorate([y.subclass("esri.views.3d.webgl-engine.lib.TextureRepository")],f.TextureRepository);let E=function(){function d(p,b){this.id=p;this._release=b;this._refCount=0}var e=d.prototype;e.ref=function(){++this._refCount};e.release=function(){--this._refCount;0<this._refCount||(0===this._refCount?this._release():(r.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),
this._refCount=0))};h._createClass(d,[{key:"isUnreferenced",get:function(){return 0===this._refCount}}]);return d}();Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});