// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/compilerUtils ../../../../core/Error ../../../../core/Evented ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/urlUtils ../../../../support/requestImageUtils ../../../../support/requestUtils ../../../../chunks/TextureOnly.glsl ./basicInterfaces ./BasisUtil ./ContentObject ./ContentObjectType ./DDSUtil ./glUtil3D ./Util ../../../webgl/context-util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),
function(B,y,C,D,E,v,k,w,m,z,F,G,H,q,x,A,I,J,K,L,M,g,N,r,O){A=function(d){function n(b,c){var a=P.call(this);a._data=b;a.type=I.ContentObjectType.Texture;a._glTexture=null;a._powerOfTwoStretchInfo=null;a._loadingPromise=null;a._loadingController=null;a.events=new E;a._passParameters=new H.TextureOnlyPassParameters;a.params=c||{};a.params.mipmap=!1!==a.params.mipmap;a.params.noUnpackFlip=a.params.noUnpackFlip||!1;a.params.preMultiplyAlpha=a.params.preMultiplyAlpha||!1;a.params.wrap=a.params.wrap||
{s:g.TextureWrapMode.REPEAT,t:g.TextureWrapMode.REPEAT};a.params.powerOfTwoResizeMode=a.params.powerOfTwoResizeMode||q.PowerOfTwoResizeMode.STRETCH;a.estimatedTexMemRequired=n._estimateTexMemRequired(a._data,a.params);a._startPreload();return a}y._inherits(n,d);var P=y._createSuper(n);d=n.prototype;d._startPreload=function(){const b=this._data;k.isNone(b)||(b instanceof HTMLVideoElement?this._startPreloadVideoElement(b):b instanceof HTMLImageElement&&this._startPreloadImageElement(b))};d._startPreloadVideoElement=
function(b){if(!(z.isBlobProtocol(b.src)||"auto"===b.preload&&b.crossOrigin)){b.preload="auto";b.crossOrigin="anonymous";const c=!b.paused;b.src=b.src;if(c&&b.autoplay){const a=()=>{b.removeEventListener("canplay",a);b.play()};b.addEventListener("canplay",a)}}};d._startPreloadImageElement=function(b){z.isDataProtocol(b.src)||z.isBlobProtocol(b.src)||b.crossOrigin||(b.crossOrigin="anonymous",b.src=b.src)};n._getDataDimensions=function(b){return b instanceof HTMLVideoElement?{width:b.videoWidth,height:b.videoHeight}:
b};n._estimateTexMemRequired=function(b,c){if(k.isNone(b))return 0;if(m.isArrayBuffer(b)||m.isUint8Array(b))return c.encoding===q.TextureEncodingMimeType.KTX2_ENCODING?x.estimateMemoryKTX2(b,!!c.mipmap):c.encoding===q.TextureEncodingMimeType.BASIS_ENCODING?x.estimateMemoryBasis(b,!!c.mipmap):b.byteLength;const {width:a,height:e}=b instanceof Image||b instanceof ImageData||b instanceof HTMLCanvasElement||b instanceof HTMLVideoElement?n._getDataDimensions(b):c;return(c.mipmap?4/3:1)*a*e*(c.components||
4)||0};d.dispose=function(){this._data=void 0};d._createDescriptor=function(b){return{target:g.TextureType.TEXTURE_2D,pixelFormat:g.PixelFormat.RGBA,dataType:g.PixelType.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?g.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:g.TextureSamplingMode.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?b.parameters.maxMaxAnisotropy:
1)}};d.load=function(b,c){if(k.isSome(this._glTexture))return this._glTexture;if(k.isSome(this._loadingPromise))return this._loadingPromise;const a=this._data;return k.isNone(a)?this._glTexture=new r.Texture(b,this._createDescriptor(b),null):"string"===typeof a?this._loadFromURL(b,c,a):a instanceof Image?this._loadFromImageElement(b,c,a):a instanceof HTMLVideoElement?this._loadFromVideoElement(b,c,a):a instanceof ImageData||a instanceof HTMLCanvasElement?this._loadFromImage(b,a,c):(m.isArrayBuffer(a)||
m.isUint8Array(a))&&this.params.encoding===q.TextureEncodingMimeType.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(b,a)):(m.isArrayBuffer(a)||m.isUint8Array(a))&&this.params.encoding===q.TextureEncodingMimeType.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(b,a)):(m.isArrayBuffer(a)||m.isUint8Array(a))&&this.params.encoding===q.TextureEncodingMimeType.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(b,a)):m.isUint8Array(a)?this._loadFromPixelData(b,a):m.isArrayBuffer(a)?this._loadFromPixelData(b,
new Uint8Array(a)):null};d.frameUpdate=function(b,c,a){if(!(this._data instanceof HTMLVideoElement)||k.isNone(this._glTexture)||this._data.readyState<t.HAVE_CURRENT_DATA||a===this._data.currentTime)return a;if(k.isSome(this._powerOfTwoStretchInfo)){const {framebuffer:e,vao:f,sourceTexture:h}=this._powerOfTwoStretchInfo;h.setData(this._data);this._drawStretchedTexture(b,c,e,f,h,this._glTexture)}else{const {videoWidth:e,videoHeight:f}=this._data,{width:h,height:l}=this._glTexture.descriptor;e!==h||
f!==l?this._glTexture.updateData(0,0,0,Math.min(e,h),Math.min(f,l),this._data):this._glTexture.setData(this._data)}this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap();this.params.updateCallback&&this.params.updateCallback();return this._data.currentTime};d._loadFromDDSData=function(b,c){return this._glTexture=J.createDDSTexture(b,this._createDescriptor(b),c)};d._loadFromKTX2=function(b,c){return this._loadAsync(()=>x.createTextureKTX2(b,this._createDescriptor(b),c).then(a=>this._glTexture=
a))};d._loadFromBasis=function(b,c){return this._loadAsync(()=>x.createTextureBasis(b,this._createDescriptor(b),c).then(a=>this._glTexture=a))};d._loadFromPixelData=function(b,c){L.assert(0<this.params.width&&0<this.params.height);const a=this._createDescriptor(b);a.pixelFormat=1===this.params.components?g.PixelFormat.LUMINANCE:3===this.params.components?g.PixelFormat.RGB:g.PixelFormat.RGBA;a.width=this.params.width;a.height=this.params.height;return this._glTexture=new r.Texture(b,a,c)};d._loadFromURL=
function(b,c,a){return this._loadAsync(async e=>{const f=await F.requestImage(a,{signal:e});w.throwIfAborted(e);return this._loadFromImage(b,f,c)})};d._loadFromImageElement=function(b,c,a){return a.complete?this._loadFromImage(b,a,c):this._loadAsync(async e=>{const f=await G.loadImageAsync(a,a.src,!1,e);w.throwIfAborted(e);return this._loadFromImage(b,f,c)})};d._loadFromVideoElement=function(b,c,a){return a.readyState>=t.HAVE_CURRENT_DATA?this._loadFromImage(b,a,c):this._loadFromVideoElementAsync(b,
c,a)};d._loadFromVideoElementAsync=function(b,c,a){return this._loadAsync(e=>new Promise((f,h)=>{const l=()=>{a.removeEventListener("loadeddata",u);a.removeEventListener("error",p);k.removeMaybe(Q)},u=()=>{a.readyState>=t.HAVE_CURRENT_DATA&&(l(),f(this._loadFromImage(b,a,c)))},p=R=>{l();h(R||new D("Failed to load video"))};a.addEventListener("loadeddata",u);a.addEventListener("error",p);const Q=w.onAbort(e,()=>p(w.createAbortError()))}))};d._loadFromImage=function(b,c,a){const e=n._getDataDimensions(c);
this.params.width=e.width;this.params.height=e.height;const f=this._createDescriptor(b);f.pixelFormat=3===this.params.components?g.PixelFormat.RGB:g.PixelFormat.RGBA;if(this._requiresPowerOfTwo(b,f)&&(!v.isPowerOfTwo(e.width)||!v.isPowerOfTwo(e.height)))return this._glTexture=this._makePowerOfTwoTexture(b,c,e,f,a);f.width=e.width;f.height=e.height;return this._glTexture=new r.Texture(b,f,c)};d._loadAsync=function(b){const c=new AbortController;this._loadingController=c;const a=b(c.signal);this._loadingPromise=
a;b=()=>{this._loadingController===c&&(this._loadingController=null);this._loadingPromise===a&&(this._loadingPromise=null)};a.then(b,b);return a};d._requiresPowerOfTwo=function(b,c){var a=g.TextureWrapMode.CLAMP_TO_EDGE;a="number"===typeof c.wrapMode?c.wrapMode===a:c.wrapMode.s===a&&c.wrapMode.t===a;return b.type===M.ContextType.WEBGL1&&(c.hasMipmap||!a)};d._makePowerOfTwoTexture=function(b,c,a,e,f){const {width:h,height:l}=a;a=v.nextHighestPowerOfTwo(h);const u=v.nextHighestPowerOfTwo(l);e.width=
a;e.height=u;let p;switch(this.params.powerOfTwoResizeMode){case q.PowerOfTwoResizeMode.PAD:e.textureCoordinateScaleFactor=[h/a,l/u];p=new r.Texture(b,e);p.updateData(0,0,0,h,l,c);break;case q.PowerOfTwoResizeMode.STRETCH:case null:case void 0:p=this._stretchToPowerOfTwo(b,c,e,f());break;default:C.neverReached(this.params.powerOfTwoResizeMode)}e.hasMipmap&&p.generateMipmap();return p};d._stretchToPowerOfTwo=function(b,c,a,e){const f=new r.Texture(b,a),h=new N.FramebufferObject(b,{colorTarget:g.TargetType.TEXTURE,
depthStencilTarget:g.DepthStencilTargetType.NONE},f);c=new r.Texture(b,{target:g.TextureType.TEXTURE_2D,pixelFormat:a.pixelFormat,dataType:g.PixelType.UNSIGNED_BYTE,wrapMode:g.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:g.TextureSamplingMode.LINEAR,flipped:!!a.flipped,maxAnisotropy:8,preMultiplyAlpha:a.preMultiplyAlpha},c);a=K.createQuadVAO(b);const l=b.getBoundFramebufferObject();this._drawStretchedTexture(b,e,h,a,c,f);this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:a,sourceTexture:c,framebuffer:h}:
(a.dispose(!0),c.dispose(),h.detachColorTexture(),h.dispose());b.bindFramebuffer(l);return f};d._drawStretchedTexture=function(b,c,a,e,f,h){this._passParameters.texture=f;b.bindFramebuffer(a);a=b.getViewport();b.setViewport(0,0,h.descriptor.width,h.descriptor.height);b.bindTechnique(c,this._passParameters,null);b.bindVAO(e);b.drawArrays(g.PrimitiveType.TRIANGLE_STRIP,0,O.vertexCount(e,"geometry"));b.bindFramebuffer(null);b.setViewport(a.x,a.y,a.width,a.height);this._passParameters.texture=null};d.unload=
function(){if(k.isSome(this._powerOfTwoStretchInfo)){const {framebuffer:b,vao:c,sourceTexture:a}=this._powerOfTwoStretchInfo;c.dispose(!0);a.dispose();b.dispose();this._powerOfTwoStretchInfo=this._glTexture=null}k.isSome(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null);if(k.isSome(this._loadingController)){const b=this._loadingController;this._loadingPromise=this._loadingController=null;b.abort()}this.events.emit("unloaded")};y._createClass(n,[{key:"width",get:function(){return this.params.width}},
{key:"height",get:function(){return this.params.height}},{key:"glTexture",get:function(){return this._glTexture}},{key:"requiresFrameUpdates",get:function(){return this._data instanceof HTMLVideoElement}}]);return n}(A.ContentObject);var t;(function(d){d[d.HAVE_NOTHING=0]="HAVE_NOTHING";d[d.HAVE_METADATA=1]="HAVE_METADATA";d[d.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA";d[d.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA";d[d.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(t||(t={}));B.Texture=A;Object.defineProperty(B,
Symbol.toStringTag,{value:"Module"})});