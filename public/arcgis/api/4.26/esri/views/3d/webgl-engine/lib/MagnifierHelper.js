// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Evented ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../support/requestImageUtils ./DefaultVertexBufferLayouts ./glUtil3D ./Program ./VertexAttribute ../shaders/Magnifier.glsl ../../../magnifier/resources ../../../webgl/enums ../../../webgl/renderState ../../../webgl/Texture".split(" "),
function(k,r,q,B,C,D,E,y,c,F,t,G,u,O,P,Q,H,z,I,J,K,L,A,M,d,v,w){k.MagnifierHelper=function(g){function p(){var a=N.apply(this,arguments);a._handles=new E;a._magnifier=null;a._imageSources=null;a._imageLoadTask=null;a._resources=null;a._passParameters=new A.MagnifierPassParameters;a.events=new D;a.attributeLocations=new Map([[L.VertexAttribute.POSITION,0]]);a._tmpScreenPoint=t.createScreenPointArray();a._tmpRenderPoint=t.createRenderScreenPointArray();return a}r._inherits(p,g);var N=r._createSuper(p);
g=p.prototype;g.destroy=function(){this._magnifier=null;this._handles.destroy();c.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null);this._disposeResources()};g.render=function(a,b){const f=this._validMagnifier;if(!c.isNone(f)){var e=Math.ceil(b.camera.pixelRatio*f.size);this._updateResources(a,e);if(!c.isNone(this._resources)){var l=this._passParameters.textures;e=Math.ceil(1/this._factor*e);l.input.resize(e,e);t.screenPointObjectToArray(f.position,this._tmpScreenPoint);
var h=b.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),m=b.camera.fullHeight,x=.5*e,n=.5*e;h[0]=y.clamp(h[0],x,b.camera.fullWidth-x-1);h[1]=y.clamp(h[1],n,m-n-1);m=Math.floor(h[0]-x);h=Math.floor(h[1]-n);n=this._resources.program;n.bindTexture("textureInput",l.input);a.gl.copyTexImage2D(l.input.descriptor.target,0,l.input.descriptor.pixelFormat,m,h,e,e,0);this._passParameters.magnifier=f;a.useProgram(n);n.bindPass(this._passParameters,b);a.bindVAO(this._resources.vao);a.setPipelineState(this._resources.pipelineState);
a.drawArrays(d.PrimitiveType.TRIANGLE_STRIP,0,4)}}};g._updateResourceLoading=function(){const a=this._validMagnifier;if(!c.isNone(a)){var b=a.maskUrl,f=a.overlayUrl;!c.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===b&&this._imageLoadTask.overlayUrl===f||(this._imageLoadTask.task.abort(),this._imageSources=this._imageLoadTask=null);c.isSome(this._imageSources)||c.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:b,overlayUrl:f,task:C.createTask(async e=>{const l=c.isNone(b)||c.isNone(f)?
M.loadMagnifierResources(e):null,h=c.isSome(b)?z.requestImage(b,{signal:e}):l.then(m=>m.mask);e=c.isSome(f)?z.requestImage(f,{signal:e}):l.then(m=>m.overlay);this._imageSources={mask:await h,overlay:await e};this._disposeResources();this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}};g._updateResources=function(a,b){this.enabled?c.isSome(this._resources)?this._passParameters.textures.size!==b&&(a=this._createTextureResources(a,
b),c.isNone(a)?this._disposeResources():(this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=a)):(b=this._createTextureResources(a,b),c.isNone(b)||(this._resources={program:this._createProgram(a),vao:J.createQuadVAO(a,I.Pos2,this.attributeLocations,0,1),pipelineState:v.makePipelineState({blending:v.simpleBlendingParams(d.BlendFactor.ONE,d.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:v.defaultColorWriteParams})},this._passParameters.textures=
b)):this._disposeResources()};g._disposeResources=function(){c.isNone(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)};g._disposeTextureResources=function(a){a.mask.dispose();a.overlay.dispose();a.input.dispose()};g._createTextureResources=function(a,b){if(c.isNone(this._imageSources))return null;this._imageSources.overlay.width=b;this._imageSources.overlay.height=b;this._imageSources.mask.width=
b;this._imageSources.mask.height=b;const f=new w.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.RGBA,internalFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!0,preMultiplyAlpha:!G.isSVG(this._imageSources.overlay.src)||!a.driverTest.svgPremultipliesAlpha.result},this._imageSources.overlay),e=new w.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.ALPHA,internalFormat:d.PixelFormat.ALPHA,
dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!0},this._imageSources.mask);return{input:new w.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.RGBA,internalFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!1}),mask:e,overlay:f,size:b}};g._createProgram=function(a){return new K.Program(a,A.build(),
this.attributeLocations)};r._createClass(p,[{key:"updating",get:function(){return c.isNone(this._imageSources)&&c.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(a){a!==this._magnifier&&(this._handles.removeAll(),this._magnifier=a,a=()=>{this._updateResourceLoading();this.events.emit("request-render")},c.isSome(this._magnifier)&&this._handles.add(F.watch(()=>c.applySome(this._magnifier,b=>b.version),a)),a())}},
{key:"enabled",get:function(){return c.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return c.isSome(this._magnifier)&&this._magnifier.visible&&c.isSome(this._magnifier.position)&&0<this._magnifier.size?this._magnifier:null}},{key:"_factor",get:function(){return c.isSome(this._magnifier)?this._magnifier.factor||1:1}}]);return p}(B);q.__decorate([u.property()],k.MagnifierHelper.prototype,"_imageSources",void 0);q.__decorate([u.property()],k.MagnifierHelper.prototype,"_imageLoadTask",
void 0);q.__decorate([u.property({readOnly:!0})],k.MagnifierHelper.prototype,"updating",null);k.MagnifierHelper=q.__decorate([H.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],k.MagnifierHelper);Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});