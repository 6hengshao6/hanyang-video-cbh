// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ./interfaces ./TerrainConst ./terrainUtils ./tileUtils".split(" "),function(r,l,g,u,B,C,D){let z=function(){function k(){}var b=k.prototype;b.init=function(a,h,e,c){this.tile=a;this._layerIdx=h;this._layerClass=e;this._suspended=c;this._tileLayerInfo=a.getLayerInfo(h,e);this._tileRequested=null;a=this._findAncestorWithData();this._setUpsampleTile(a)};b.startLoading=function(){return this._requestNext()};b.dispose=function(){this._tileRequested&&
(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null);this._tileLayerInfo=this.tile=null};b.setSuspension=function(a){a!==this._suspended&&((this._suspended=a)?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())};b.update=function(){const a=this._findAncestorWithData();this._setUpsampleTile(a);return this._requestNext()};b.dataArrived=
function(a){this._setUpsampleTile(a);this._tileRequested=null;a===this.tile?this.tile.updateRenderData(this._layerClass,u.TextureUpdate.FADING):this._requestNext()};b.dataMissing=function(){this._tileRequested=null;this._tileLayerInfo.data=null;this._requestNext()};b._agentDone=function(){this.tile.agentDone(this._layerIdx,this._layerClass);this.dispose()};b._requestNext=function(){if(this._suspended)return!0;const a=this._findNextDownload();if(this._tileRequested){if(a===this._tileRequested)return!0;
this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this);this._tileRequested=null}g.isSome(a)?a.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=a):this._agentDone();return!!this._tileRequested};b._findNextDownload=function(){const a=this._layerIdx,h=this._layerClass;var e=this.tile.surface.layerViewByIndex(a,h),c=C.getLayerWithExtentRange(e);const {minLevel:v,maxLevel:E}=e.dataLevelRange;e=this._desiredMinLevelDelta;const F=this._progressiveLevelModulo+
e,G=this._scaleRangeEnabled?D.fallsWithinLayer:()=>!0;let d=this.tile;const m=d.level;let f;const n=this._tileLayerInfo.upsampleInfo,w=g.isSome(n)?n.tile.level:-1,H=g.isSome(n)?w-m>=e:!1,x=g.get(c,"tilemapCache");for(;d&&G(d,c,!1)&&d.level>=v;){const p=d.level,y=m-p,q=d.layerInfo[h][a];if(q.data&&y>=e){(!H||p>w)&&this._setUpsampleTile(d);q.dataInvalidated&&(f=d);break}if((g.isNone(x)||"unavailable"!==x.getAvailability(d.lij[0],d.lij[1],d.lij[2]))&&p<=E&&!q.data&&!q.dataMissing){if(g.isNone(f)||d.level===
v||0===p%B.PROGRESSIVE_LOADING_MODULO||m-f.level<e)f=d;if(y>=F)break}d=d.parent}g.isSome(f)&&m-f.level<e&&(n?f=null:(c=this._findAncestorWithData(),g.isSome(c)&&(this._setUpsampleTile(c),f=c.layerInfo[h][a].dataInvalidated?c:null)));return f};b._findAncestorWithData=function(){const a=this.tile.elevationLevel,h=this._desiredMinLevelDelta;let e;for(let c=this.tile;c;c=c.parent)if(c.hasLayerData(this._layerIdx,this._layerClass)){if(a-c.level>=h)return c;e=c}return e};b._setUpsampleTile=function(a){this._tileLayerInfo.setUpsampleInfo(this.tile,
a);this.tile.updateRenderData(this._layerClass,u.TextureUpdate.FADING)};l._createClass(k,[{key:"updating",get:function(){return!!this._tileRequested}},{key:"test",get:function(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}]);return k}();var t=function(k){function b(){return a.apply(this,arguments)}l._inherits(b,k);var a=l._createSuper(b);b.prototype.dispose=function(){};l._createClass(b,[{key:"_desiredMinLevelDelta",get:function(){throw A;}},{key:"_progressiveLevelModulo",
get:function(){throw A;}}]);return b}(z);const A=Error("Abstract method called on TileAgent");t=new t;r.TILE_AGENT_DONE=t;r.TileAgent=z;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});