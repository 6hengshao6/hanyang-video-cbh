// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/mathUtils ../../../core/maybe ../../../core/time ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../core/support/WatchUpdatingTracking ../../../geometry/ellipsoidUtils ./PrecipitationTechnique ./PrecipitationTechniqueConfiguration ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/AnimationTimer ../webgl-engine/lib/VertexArrayObject ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums ../../webgl/Util".split(" "),
function(d,p,k,A,t,c,B,m,J,K,L,C,D,E,f,n,u,v,F,G,w,x,q,y){d.Precipitation=function(e){function l(a){var b=H.call(this,a);b._numParticles=25E4;b._rainSpeed=.1;b._snowSpeed=.01;b._passParameters=new f.PrecipitationPassParameters;b._animation=new F.AnimationTimer;b._updatingTracking=new D.WatchUpdatingTracking;b._passParameters.time=0;b._passParameters.radius=E.getReferenceEllipsoid(a.view.spatialReference).radius;b._techniqueRepository=a.context.techniqueRepository;return b}p._inherits(l,e);var H=p._createSuper(l);
e=l.prototype;e.destroy=function(){this._updatingTracking.destroy();this._numParticles=0;this._snowTechniqueCached=c.releaseMaybe(this._snowTechniqueCached);this._rainTechniqueCached=c.releaseMaybe(this._rainTechniqueCached);this._vao=c.disposeMaybe(this._vao);this._instanceIdBuffer=c.disposeMaybe(this._instanceIdBuffer)};e.update=function(a){return this._animation.advance(a)};e.render=function(a,b,g){const r="rainy"===g?this._rainTechnique:this._snowTechnique;if(r.compiled){var h=a.rctx;this._ensureResources(h);
c.isNone(r)||c.isNone(this._vao)||c.isNone(this._instanceIdBuffer)||(c.isSome(a.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-a.bindParameters.cloudsFade.fadeInOutHeight.factor),0>=this._passParameters.opacity||(b=.5>b?t.lerp(0,.35,2*b):t.lerp(.35,1,2*(b-.5)),this._passParameters.time=("rainy"===g?this._rainSpeed:this._snowSpeed)*B.secondsFromMilliseconds(this._animation.time)%1E5,a=h.bindTechnique(r,this._passParameters,a.bindParameters),h.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),
y.bindVertexBufferLayout(h,f.attributeLocations,this._instanceIdBuffer,z,0),h.capabilities.instancing?.drawArraysInstanced(q.PrimitiveType.TRIANGLES,0,3,this._numParticles*b),y.unbindVertexBufferLayout(h,f.attributeLocations,this._instanceIdBuffer,z)))}else this.context.requestRender()};e._ensureResources=function(a){c.isNone(this._vao)&&(this._vao=this._createVertexArrayObject(a));c.isNone(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(a))};e._createInstanceIndices=
function(a){const b=[];for(let g=0;g<this._numParticles;g++)b.push(g);return x.BufferObject.createVertex(a,q.Usage.STATIC_DRAW,new Float32Array(b))};e._createVertexArrayObject=function(a){const b=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new G.VertexArrayObject(a,f.attributeLocations,{geometry:u.glLayout(I)},{geometry:x.BufferObject.createVertex(a,q.Usage.STATIC_DRAW,b)})};p._createClass(l,[{key:"updating",get:function(){return this._updatingTracking.updating}},{key:"_rainTechnique",get:function(){if(c.isNone(this._rainTechniqueCached)){const a=
new n.PrecipitationTechniqueConfiguration;a.type=n.PrecipitationType.Rain;this._rainTechniqueCached=this._techniqueRepository.acquire(f.PrecipitationTechnique,a)}return this._rainTechniqueCached}},{key:"_snowTechnique",get:function(){if(c.isNone(this._snowTechniqueCached)){const a=new n.PrecipitationTechniqueConfiguration;a.type=n.PrecipitationType.Snow;this._snowTechniqueCached=this._techniqueRepository.acquire(f.PrecipitationTechnique,a)}return this._snowTechniqueCached}}]);return l}(A);k.__decorate([m.property({constructOnly:!0})],
d.Precipitation.prototype,"context",void 0);k.__decorate([m.property({constructOnly:!0})],d.Precipitation.prototype,"view",void 0);k.__decorate([m.property({readOnly:!0})],d.Precipitation.prototype,"updating",null);k.__decorate([m.property()],d.Precipitation.prototype,"_updatingTracking",void 0);d.Precipitation=k.__decorate([C.subclass("esri.views.3d.environment.Precipitation")],d.Precipitation);const I=v.newLayout().vec3f(w.VertexAttribute.POSITION),z=u.glLayout(v.newLayout().f32(w.VertexAttribute.INSTANCEFEATUREATTRIBUTE),
1);Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});