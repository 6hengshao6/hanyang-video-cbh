// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../assets ../../../core/Accessor ../../../core/asyncUtils ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../core/support/WatchUpdatingTracking ./StarsTechnique ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/DefaultVertexAttributeLocations ../webgl-engine/lib/VertexArrayObject ../webgl-engine/lib/VertexAttribute ../../webgl/BufferObject ../../webgl/enums".split(" "),
function(f,v,k,D,E,F,y,G,g,H,I,n,V,W,X,J,r,z,K,A,L,M,N,O,w,P,B){f.Stars=function(d){function p(a){a=Q.call(this,a);a._loadDataTask=null;a._numPoints=0;a._renderParameter=new A.StarPassParameters;a._updatingTracking=new K.WatchUpdatingTracking;return a}v._inherits(p,d);var Q=v._createSuper(p);d=p.prototype;d.initialize=function(){this._loadDataTask=this._createLoadDataTask()};d.destroy=function(){this._loadDataTask=g.abortMaybe(this._loadDataTask);this._updatingTracking.destroy();this._numPoints=0;
this._technique=g.releaseMaybe(this._technique);this._vao=g.disposeMaybe(this._vao)};d.render=function(a){const {rctx:b}=a;this._ensureResources(b);g.isNone(this._technique)||g.isNone(this._vao)||(this._technique.compiled?(a=b.bindTechnique(this._technique,this._renderParameter,a.bindParameters),b.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),b.drawArrays(B.PrimitiveType.POINTS,0,this._numPoints)):this.requestRender())};d._ensureResources=function(a){if(!g.isSome(this._technique)&&
!g.isNone(l)){this._technique=new A.StarsTechnique({rctx:a,viewingMode:this.view.state.viewingMode});this._numPoints=l.byteLength/9;var b=new Float32Array(l,0,2*this._numPoints),c=new Uint8Array(l,8*this._numPoints,this._numPoints);this._vao=this._createVertexArrayObject(a,b,c,this._numPoints);this._updatingTracking.add(()=>"virtual"!==this.view.environment.lighting.type?this.view.environment.lighting.date:null,m=>this._update(m),I.initial)}};d._computeDayDuration=function(a){const b=new Date(a.getFullYear(),
0,1,11,58,56),c=new Date(a.getFullYear()+1,0,1,11,58,55);return(+a-+b)/(+c-+b)};d._update=function(a){if(a){var b=a.getHours()/12,c=a.getMinutes()/60*(2/24),m=a.getSeconds()/60*(2/1440);b=(b+c+m-.9972222)%2;a=2*this._computeDayDuration(a);c=r.copy(this._renderParameter.modelMatrix,R);r.rotateZ(c,c,-a*Math.PI);r.multiply(c,S,c);r.rotateZ(c,c,-b*Math.PI);this.requestRender()}};d._hexToRGB=function(a){return[parseInt(a.substring(0,2),16),parseInt(a.substring(2,4),16),parseInt(a.substring(4,6),16)]};
d._unpackUint8Attributes=function(a){return 192<=a?[2.9,a-192]:160<=a?[2.5,a-160]:128<=a?[2,a-128]:96<=a?[1.5,a-96]:64<=a?[1,a-64]:32<=a?[.7,a-32]:[.4,a]};d._createVertexArrayObject=function(a,b,c,m){const t=C.createBuffer(m),x=t.position,u=t.color,T=t.size;for(let e=0;e<m;e++){var q=b[2*e],h=b[2*e+1];x.set(e,0,-Math.cos(q)*Math.sin(h));x.set(e,1,-Math.sin(q)*Math.sin(h));x.set(e,2,-Math.cos(h));q=this._unpackUint8Attributes(c[e]);h=this._hexToRGB(U[q[1]]);u.set(e,0,255*h[0]);u.set(e,1,255*h[1]);
u.set(e,2,255*h[2]);u.set(e,3,255);T.set(e,q[0])}return new O.VertexArrayObject(a,N.Default3D,{geometry:L.glLayout(C)},{geometry:P.BufferObject.createVertex(a,B.Usage.STATIC_DRAW,t.buffer)})};d._createLoadDataTask=function(){if(g.isSome(l))return null;const a=F.createTask(async b=>{({data:b}=await D.fetchAsset("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:b}));this._verifyStarData(b);l=b});a.promise.catch(b=>{H.isAbortError(b)||G.getLogger(this.declaredClass).error(b)}).then(()=>
{this.destroyed||(this.requestRender(),this.notifyChange("updating"))});return a};d._verifyStarData=function(a){if(!a)throw new y("stars:no-data-received","Failed to create stars because star catalogue is missing");a=a.byteLength/9;if(0!==a%1||5E4<a||5E3>a)throw new y("stars:invalid-data","Failed to create stars because star catalogue data is invalid");};v._createClass(p,[{key:"updating",get:function(){return this._updatingTracking.updating||this.loading}},{key:"loading",get:function(){return g.isSome(this._loadDataTask)&&
!this._loadDataTask.finished}}]);return p}(E);k.__decorate([n.property({constructOnly:!0})],f.Stars.prototype,"view",void 0);k.__decorate([n.property({constructOnly:!0})],f.Stars.prototype,"requestRender",void 0);k.__decorate([n.property({readOnly:!0})],f.Stars.prototype,"updating",null);k.__decorate([n.property()],f.Stars.prototype,"_loadDataTask",void 0);k.__decorate([n.property()],f.Stars.prototype,"_updatingTracking",void 0);f.Stars=k.__decorate([J.subclass("esri.views.3d.environment.Stars")],
f.Stars);const U="9bb2ff;9eb5ff;aabfff;bbccff;ccd8ff ;dae2ff;e4e9ff;eeefff;f8f6ff;fff9fb;fff5ef;fff1e5;ffeddb;ffe9d2;ffe6ca;ffe3c3;ffe0bb;ffddb4;ffdaad;ffd6a5;ffd29c;ffcc8f;ffc178;ffa94b;ff7b00".split(";"),S=z.fromValues(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),R=z.fromValues(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),C=M.newLayout().vec3f(w.VertexAttribute.POSITION).vec4u8(w.VertexAttribute.COLOR).f32(w.VertexAttribute.SIZE);
let l=null;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});