// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3f32 ../../../geometry/ellipsoidUtils ../../../chunks/Clouds.glsl ./CloudsData ./CloudsPresets ./CloudsTechnique ./CloudsTechniqueConfiguration ./NoiseTextureAtlas ../webgl-engine/lib/BindParameters ../webgl-engine/lib/glUtil3D ../../support/Scheduler ../../webgl/enums ../../webgl/FramebufferObject".split(" "),
function(c,w,f,B,C,n,l,z,h,S,T,U,D,E,F,G,x,H,m,I,A,v,d,J,r,K,L,M,y,q,N){c.CloudsGenerator=function(k){function t(a){a=O.call(this,a);a._handles=new C;a._techniques=[];a._techniqueConfiguration=new r.CloudsTechniqueConfiguration;a._bindParameters=new L.BindParameters(null,null,null);a._passParameters=new A.CloudsPassParameters;a._drawParameters=new A.CloudsDrawParameters;a._weatherTile=H.create();a._weatherTileCount=128;a._faceIndex=0;a._tileIndex=0;a.coverage=n.lerp(d.cloudPresets.default.coverage[0],
d.cloudPresets.default.coverage[1],.5);a.density=n.lerp(d.cloudPresets.default.density[0],d.cloudPresets.default.density[1],.5);a.absorption=n.lerp(d.cloudPresets.default.absorption[0],d.cloudPresets.default.absorption[1],.5);a.cloudSize=n.lerp(d.cloudPresets.default.cloudSize[0],d.cloudPresets.default.cloudSize[1],.5);a.detailSize=n.lerp(d.cloudPresets.default.detailSize[0],d.cloudPresets.default.detailSize[1],.5);a.smoothness=n.lerp(d.cloudPresets.default.smoothness[0],d.cloudPresets.default.smoothness[1],
.5);a.cloudHeight=n.lerp(d.cloudPresets.default.cloudHeight[0],d.cloudPresets.default.cloudHeight[1],.5);a.raymarchingSteps=d.cloudPresets.default.raymarchingSteps;a._viewMatrix=G.create();a._dirty=!1;a.running=!1;return a}w._inherits(t,k);var O=w._createSuper(t);k=t.prototype;k._getTechnique=function(a){const b=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,e=b===v.CloudsTextureChannels.RG?2*a:2*a+1,g=this._techniques[e];if(g)return g;this._techniqueConfiguration.writeTextureChannels=
b;this._techniqueConfiguration.steps=a;this._techniques[e]=new J.CloudsTechnique({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration);return this._techniques[e]};k.updateWeatherTile=function(){var a=this.view.camera.position.latitude,b=this.view.camera.position.longitude;null!=a&&null!=b&&(x.set(this._weatherTile,(a+90)/180,(b+180)/360),a=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1)),this._weatherTile[0]=Math.floor(2*
this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-a)*this._weatherTile[1]),b=a=0,l.isSome(this.view.environment)&&"virtual"!==this.view.environment.lighting.type&&l.isSome(this.view.environment.lighting.date)&&(b=new Date(this.view.environment.lighting.date),b.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),a=31*b.getUTCMonth()+b.getUTCDate(),b=b.getUTCFullYear()),this._weatherTile[0]=
(this._weatherTile[0]+a)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+b%100)%(4*this._weatherTileCount),x.equals(this._passParameters.weatherTile,this._weatherTile)||this.setDirty())};k.initialize=function(){this._vao=M.createQuadVAO(this.context.renderContext.rctx);const a=I.getReferenceEllipsoid(this.view.spatialReference);this._passParameters.cloudRadius=.5*a.radius;this.setDirty();this.updateWeatherTile();this._handles.add([this.view.resourceController.scheduler.registerTask(y.TaskPriority.CLOUDS_GENERATOR,
this),z.watch(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),z.initial)])};k.destroy=function(){this._handles.destroy();this._techniques.forEach(a=>l.releaseMaybe(a));this._frameBufferCube=l.disposeMaybe(this._frameBufferCube);this._techniques.length=0;this._vao=l.disposeMaybe(this._vao);this._passParameters.noiseTexture=l.destroyMaybe(this._passParameters.noiseTexture)};k._ensureNoiseTexture=
function(){l.isSome(this._passParameters.noiseTexture)||(this._passParameters.noiseTexture=new K.NoiseTextureAtlas({context:this.context}));this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);return l.isSome(this._passParameters.noiseTexture.textureAtlas)};k._ensureFrameBufferCube=function(a){l.isNone(this._frameBufferCube)&&(this._frameBufferCube=new N.FramebufferObject(this.context.renderContext.rctx,{colorTarget:q.TargetType.CUBEMAP,width:a,height:a},{target:q.TextureType.TEXTURE_CUBE_MAP,
pixelFormat:q.PixelFormat.RGBA,dataType:q.PixelType.UNSIGNED_BYTE,wrapMode:q.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:q.TextureSamplingMode.LINEAR,hasMipmap:!1,width:a,height:a}));return this._frameBufferCube};k.destroyFrameBufferCube=function(){this._frameBufferCube=l.disposeMaybe(this._frameBufferCube)};k.applyPreset=function(a,b){const e=a.median,g=p=>{const u=n.lerp(p[0],p[1],e);return.5>b?n.lerp(p[0],u,2*b):n.lerp(u,p[1],2*(b-.5))};this.coverage=g(a.coverage);this.density=g(a.density);this.absorption=
g(a.absorption);this.cloudSize=g(a.cloudSize);this.detailSize=g(a.detailSize);this.smoothness=g(a.smoothness);this.cloudHeight=g(a.cloudHeight);this.raymarchingSteps=a.raymarchingSteps};k.setDirty=function(){this._dirty=this.running=!0};k.runTask=function(a){if(l.isNone(this._vao))this._dirty=this.running=!1,this.context.renderContext.bindParameters.cloudsFade.renderingStage=v.CloudsRenderingStages.FINISHED_RENDERING,a.madeProgress();else{0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=
this.raymarchingSteps,this.updateWeatherTile(),x.copy(this._passParameters.weatherTile,this._weatherTile));var b=this._getTechnique(this._passParameters.raymarchingSteps);if(!b.compiled||!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return y.Task.YIELD;0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=v.CloudsRenderingStages.RENDERING,
this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);var e=this.context.renderContext.rctx,g=e.bindTechnique(b,this._passParameters,this._bindParameters);e.bindVAO(this._vao);g.assertCompatibleVertexAttributeLocations(this._vao);
var p=e.getViewport();b=b.configuration.cubeMapSize;var u=b/this._tilesPerFace;e.setViewport(0,this._tileIndex*u,b,u);b=this._ensureFrameBufferCube(b);e.bindFramebuffer(b);F.targetTo(this._viewMatrix,P,Q[this._faceIndex],R[this._faceIndex]);E.fromMat4(this._drawParameters.viewMatrix,this._viewMatrix);b.setColorTextureTarget(q.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex);g.bindDraw(this._drawParameters,this._bindParameters,this._passParameters);e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4);
e.gl.flush();e.setViewport(p.x,p.y,p.width,p.height);this.requestRender();++this._tileIndex;4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._tileIndex=this._faceIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=v.CloudsRenderingStages.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0);a.madeProgress();return y.Task.YIELD}};w._createClass(t,[{key:"_tilesPerFace",get:function(){switch(this._techniqueConfiguration.steps){case r.RayMarchingSteps.SIXTEEN:return 1;
case r.RayMarchingSteps.HUNDRED:return 4;case r.RayMarchingSteps.COUNT:case r.RayMarchingSteps.TWOHUNDRED:return 8}}},{key:"cubeMap",get:function(){return this._frameBufferCube}}]);return t}(B);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"context",void 0);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"view",void 0);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"requestRender",void 0);f.__decorate([h.property()],
c.CloudsGenerator.prototype,"coverage",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"density",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"absorption",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudSize",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"detailSize",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"smoothness",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudHeight",void 0);
f.__decorate([h.property()],c.CloudsGenerator.prototype,"raymarchingSteps",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"running",void 0);c.CloudsGenerator=f.__decorate([D.subclass("esri.views.3d.environment.CloudsGenerator")],c.CloudsGenerator);const Q=[m.fromValues(1,0,0),m.fromValues(-1,0,0),m.fromValues(0,1,0),m.fromValues(0,-1,0),m.fromValues(0,0,1)],R=[m.fromValues(0,1,0),m.fromValues(0,1,0),m.fromValues(0,0,-1),m.fromValues(0,0,1),m.fromValues(0,1,0)],P=m.zeros();Object.defineProperty(c,
Symbol.toStringTag,{value:"Module"})});