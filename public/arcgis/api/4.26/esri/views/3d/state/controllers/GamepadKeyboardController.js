// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/compilerUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/support/ray ../../../../chunks/sphere ../../../../geometry/support/vector ../../../../geometry/support/vectorStacks ../../camera/constraintUtils ../../camera/constraintUtils/ConstraintTypes ../../camera/constraintUtils/InteractionType ../../camera/constraintUtils/TiltMode ../Constraints ./InteractiveController ../utils/navigationUtils ../utils/viewUtils ../../support/cameraUtils ../../support/cameraUtilsInternal ../../webgl-engine/lib/Camera ../../../navigation/gamepadAndKeyboardUtils".split(" "),
function(y,r,F,P,t,Q,I,ea,fa,R,p,J,e,K,L,M,G,S,m,z,u,A,T,C,U,B,N,V,W,O,v){y.GamepadKeyboardController=function(f){function w(a){a=X.call(this,a);a._filteredSurfaceElevation=0;a._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0};a._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0];a._tmpCamera=new O.Camera;a._headingStart=0;a._constraintOptions={selection:u.ConstraintTypes.ALL,interactionType:A.InteractionType.NONE,interactionStartCamera:new O.Camera,interactionFactor:0,interactionDirection:null,
tiltMode:T.TiltMode.LOOK_AROUND};return a}r._inherits(w,f);var X=r._createSuper(w);f=w.prototype;f.handleEventGamepad=function(a){const b=v.extractTransformation(a,this.view.navigation.gamepad,this._transformation);("end"===a.action||v.isZeroTransformation(b))&&this.finishController()};f.activateDirection=function(a){this._keysButtonState[a]=1;v.extractTransformationKeyboard(this._keysButtonState,this._transformation)};f.deactivateDirection=function(a){this._keysButtonState[a]=0;a=v.extractTransformationKeyboard(this._keysButtonState,
this._transformation);v.isZeroTransformation(a)&&this.finishController()};f.onControllerStart=function(a){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z;this._headingStart=this.view.camera.heading;r._get(r._getPrototypeOf(w.prototype),"onControllerStart",this).call(this,a)};f._updateFilteredSurfaceElevation=function(a){this._filteredSurfaceElevation+=(this.view.pointsOfInterest.cameraOnSurface.location.z-this._filteredSurfaceElevation)*a};f.stepController=function(a,
b){this._updateStartHeading();this._updateFilteredSurfaceElevation(a);this.currentCamera.copyViewFrom(b);this._updateCameraCenter();this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera);this._calculateControlTransformation(a,this.currentCamera,x);this._applyDisabledMovementTypes(x);this._applyPan(x.pan);this._applyRotate(x.rotate);this._applyZoom(x.zoom);this._applyAscend(x.ascend);this._constraintOptions.interactionType=A.InteractionType.NONE;this._constraintOptions.selection=
u.ConstraintTypes.COLLISION;z.applyAll(this.view,this.currentCamera,this._constraintOptions);r._get(r._getPrototypeOf(w.prototype),"stepController",this).call(this,a,b)};f._updateStartHeading=function(){0!==this._transformation.heading&&(this._headingStart=this.view.camera.heading)};f._applyRotate=function(a){if(a.enabled){var b=this.currentCamera;e.subtract(n,b.center,b.eye);e.transformMat4(n,n,a.matrix);b.center=e.add(n,n,b.eye);b.up=e.transformMat4(n,b.up,a.matrix);this._constraintOptions.interactionType=
A.InteractionType.LOOK_AROUND;this._constraintOptions.selection=u.ConstraintTypes.ALL_EXCEPT_COLLISION;z.applyAll(this.view,b,this._constraintOptions)}};f._applyPan=function(a,b=this.currentCamera){a.enabled&&(b.eye=e.transformMat4(n,b.eye,a.matrix),b.center=e.transformMat4(n,b.center,a.matrix),this.view.state.isGlobal&&(b.up=e.transformMat4(n,b.up,a.matrix)),this._constraintOptions.interactionType=A.InteractionType.PAN,this._constraintOptions.selection=u.ConstraintTypes.ALL,z.applyAll(this.view,
b,this._constraintOptions))};f._applyZoom=function(a){if(a){var b=this.currentCamera.viewForward;this.currentCamera.eye=e.add(n,this.currentCamera.eye,e.scale(m.sv3d.get(),b,a));e.copy(D,b);e.negate(D,D);this._constraintOptions.interactionDirection=D;this._constraintOptions.interactionType=A.InteractionType.ZOOM;this._constraintOptions.selection=u.ConstraintTypes.ALL_EXCEPT_COLLISION;z.applyAll(this.view,this.currentCamera,this._constraintOptions);this._constraintOptions.interactionDirection=null}};
f._applyAscend=function(a){if(a){var b=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,m.sv3d.get());this._constraintOptions.interactionDirection=e.copy(D,b);this.view.state.isGlobal?(b=e.length(this.currentCamera.eye),a=(b+a)/b,this.currentCamera.eye=e.scale(n,this.currentCamera.eye,a),this.currentCamera.center=e.scale(n,this.currentCamera.center,a)):(a=e.scale(m.sv3d.get(),b,a),this.currentCamera.eye=e.add(n,this.currentCamera.eye,a),this.currentCamera.center=e.add(n,this.currentCamera.center,
a));this._updateCameraCenter();this._constraintOptions.interactionType=A.InteractionType.ASCEND;this._constraintOptions.selection=u.ConstraintTypes.COLLISION;z.applyAll(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter();this._constraintOptions.selection=u.ConstraintTypes.ALL_EXCEPT_COLLISION;z.applyAll(this.view,this.currentCamera,this._constraintOptions);this._constraintOptions.interactionDirection=null}};f._calculateControlTransformation=function(a,b,c){c.zoom=0;c.ascend=
0;c.pan.enabled=!1;p.identity(c.pan.matrix);c.rotate.enabled=!1;p.identity(c.rotate.matrix);a=this._computeVelocities(a);this.view.state.isLocal?this._calculateControlTransformationLocal(a,b,c):this._calculateControlTransformationGlobal(a,b,c)};f._updateCameraCenter=function(){this.currentCamera.center=this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(this.currentCamera.ray,this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n)};f._calculateControlTransformationLocal=
function(a,b,c){const {viewRight:g,viewForward:l}=b,d=this._transformation;var k=this.view.navigation.gamepad,h=e.set(m.sv3d.get(),l[0],l[1],0);e.normalize(h,h);var q=d.translation[0]*a.pan;0!==q&&(q=e.scale(m.sv3d.get(),g,q),p.translate(c.pan.matrix,c.pan.matrix,q),c.pan.enabled=!0);switch(k.mode){case "pan":k=-d.translation[1]*a.pan;0!==k&&(h=e.scale(m.sv3d.get(),h,k),p.translate(c.pan.matrix,c.pan.matrix,h),c.pan.enabled=!0);c.zoom=d.zoom*a.zoom;break;case "zoom":c.zoom=(-d.translation[1]+d.zoom)*
a.zoom;break;default:P.neverReached(k.mode)}c.ascend=d.translation[2]*a.ascend;h=-d.heading*a.rotate;0!==h&&(p.rotate(c.rotate.matrix,c.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(b.eye,m.sv3d.get())),c.rotate.enabled=!0);a=d.tilt*a.rotate;b=N.viewAngle(this.view.renderCoordsHelper,b.center,b.eye);if(b=t.clamp(b+a,C.TiltDefault.min,C.TiltDefault.max)-b)p.rotate(c.rotate.matrix,c.rotate.matrix,b,g),c.rotate.enabled=!0};f._calculateControlTransformationGlobal=function(a,b,c){const {eye:g,
viewRight:l}=b,d=this._transformation;var k=this.view.navigation.gamepad,h=e.cross(m.sv3d.get(),l,g);e.normalize(h,h);e.negate(h,h);B.panMotionToRotationMatrix(this.startCamera,b,d,a,this.view.camera.heading,this._headingStart,this.view.camera.tilt,c,k);this._tmpCamera.copyFrom(this.currentCamera);this._applyPan(x.pan,this._tmpCamera);k=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;c.ascend=d.translation[2]*a.ascend;h=-d.heading*a.rotate;0!==h&&(p.rotate(c.rotate.matrix,
c.rotate.matrix,h,this._tmpCamera.eye),c.rotate.enabled=!0);b=this._clampTiltDeltaGlobalToValidRange(d.tilt*a.rotate,b.ray,k);0!==b&&(p.rotate(c.rotate.matrix,c.rotate.matrix,b,this._tmpCamera.viewRight),c.rotate.enabled=!0);c.zoom+=d.zoom*a.zoom};f._clampTiltDeltaGlobalToValidRange=function(a,b,c){const g=L.getReferenceEllipsoid(this.view.spatialReference),l=B.onSurfaceTiltToEyeTiltGlobal(C.TiltDefault.min,b.origin,c,g);var d=0;let k=0;d=m.sv3d.get();this.view.renderCoordsHelper.intersectManifold(b,
c,d)?(d=N.viewAngle(this.view.renderCoordsHelper,d,b.origin),d=B.onSurfaceTiltToEyeTiltGlobal(d,b.origin,c,g),k=B.onSurfaceTiltToEyeTiltGlobal(C.TiltDefault.max,b.origin,c,g)):(G.closestPointOnSilhouette(G.fromRadius(G.tmpSphere,c+g.radius),b,d),d=-S.angle(b.direction,d),d=B.offSurfaceTiltToEyeTiltGlobal(d,b.origin,c,g),k=B.offSurfaceTiltToEyeTiltGlobal(C.TiltDefault.max,b.origin,c,g));return t.clamp(d+a,l,k)-d};f._getPointAbsoluteSurfaceElevation=function(a,b,c){const {renderCoordsHelper:g}=this.view,
l=g.getAltitude(a);b+=Math.abs(l-b);g.setAltitude(c,b,a);return b};f._clampedDistanceToSurface=function(a,b){const {renderCoordsHelper:c}=this.view,{camera:g}=this.view.state;var {direction:l}=V.headingTiltToDirectionUp(this.view,b,0,80,Y);l=c.intersectManifoldClosestSilhouette(M.wrap(b,l),a,m.sv3d.get());l=e.distance(b,l);a=c.intersectManifoldClosestSilhouette(M.wrap(b,e.direction(m.sv3d.get(),b,g.center)),a,m.sv3d.get());b=e.distance(b,a);return Math.min(l,b)};f._computeHeadingRotateRadius=function(a){const {renderCoordsHelper:b,
state:c}=this.view,{camera:g,isGlobal:l}=c;var d=b.intersectManifoldClosestSilhouette(g.ray,this._filteredSurfaceElevation,m.sv3d.get());if(l){const k=e.subtract(m.sv3d.get(),a,d);d=e.length(k);e.scale(k,k,1/d);a=e.normalize(m.sv3d.get(),a);a=t.acosClamped(e.dot(a,k));return d*Math.sin(Math.min(Z,a))}a=e.copy(m.sv3d.get(),a);b.setAltitude(a,this._filteredSurfaceElevation);return e.distance(d,a)};f._minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:5};f._computeVelocities=
function(a){var b=this._filteredSurfaceElevation,c=b+L.getReferenceEllipsoid(this.view.spatialReference).radius;const {camera:g,isGlobal:l}=this.view.state;var d=m.sv3d.get();const k=this._getPointAbsoluteSurfaceElevation(g.eye,b,d);var h=this._clampedDistanceToSurface(b,d);const q=g.width/2,H=.75*g.width,aa=.75*g.width;var E=h*Math.tan(.5*g.fovX)/q;c=E/c;d=E/this._computeHeadingRotateRadius(d);E=(l?c:E)*H*a;b=k-b;b=Math.max(this._minimumAscendVelocity()*a,2**(H*a/q)*b-b);h=2**(H*a/q)*h-h;a*=t.clamp(d*
aa,ba,ca);return{pan:E,ascend:b,zoom:h,rotate:a}};f._applyDisabledMovementTypes=function(a){!Q.isSome(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.viewingMode!==this.disableMovements.mode||(a.zoom=this.disableMovements.zoom?0:a.zoom,a.ascend=this.disableMovements.ascend?0:a.ascend,a.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&p.identity(a.pan.matrix),a.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&p.identity(a.rotate.matrix))};
w.activatesFor=function(a,b){a=v.extractTransformation(b,a.navigation.gamepad,da);return!("end"===b.action||v.isZeroTransformation(a))};return r._createClass(w)}(U.InteractiveController);F.__decorate([I.property({constructOnly:!0})],y.GamepadKeyboardController.prototype,"gamepadDevice",void 0);F.__decorate([I.property({constructOnly:!0})],y.GamepadKeyboardController.prototype,"disableMovements",void 0);y.GamepadKeyboardController=F.__decorate([R.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],
y.GamepadKeyboardController);const da={translation:[0,0,0],heading:0,tilt:0,zoom:0},Z=t.deg2rad(80),ba=t.deg2rad(30),ca=t.deg2rad(80),x={zoom:0,ascend:0,pan:{enabled:!1,matrix:J.create()},rotate:{enabled:!1,matrix:J.create()}},n=K.create(),D=K.create(),Y=W.createDirectionUp();Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});