// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Logger ../../../core/maybe ../../../core/MemCache ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./MemoryManagedView".split(" "),function(p,m,c,t,u,q,r,d,y,z,A,v,w){let b=function(e){function h(a){a=x.call(this,a);a._quality=1;a._usedMemory=0;
a._updating=!1;a.minQuality=.1;a._stableQuality=0;a._downscaleMemoryUsed=0;a._canFastRecover=!1;a._memoryPredicted=0;a._cacheStorage=new r.MemCacheStorage;a._warnMemoryUsage=null;a._numQualityChanges=0;a._maxMemory=500;a._additionalCacheMemory=100;return a}m._inherits(h,e);var x=m._createSuper(h);e=h.prototype;e.destroy=function(){this._cacheStorage.destroy()};e.newCache=function(a,f){return new r.MemCache(a,this._cacheStorage,f)};e.resetStableQuality=function(){this._stableQuality=0};e.disableMemCache=
function(){this.additionalCacheMemory=-4096};e.update=function(){this._updateMemory();if(!(0>=this._memoryPredicted)||this._updating){var a=this._layersUpdating();if(.6>this._memoryPredicted&&this._canFastRecover)this._stableQuality=this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._updateQuality(1);else if(a){if(1.1<this._memoryPredicted||1<this._usedMemory)0<this._stableQuality?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<
this._usedMemory&&(this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1)}else this._downscaleMemoryUsed=0,1<this._usedMemory?(this._stableQuality=0,this._canFastRecover=!1,a=this._updateQuality(this._quality/1.3),this._downscaleMemoryUsed=this._memoryPredicted):this._stableQuality!==this._quality&&(.75>this._usedMemory&&1>this._quality?(this._stableQuality=this._quality,a=this._updateQuality(this._quality+.05)):1>this._quality&&(this._canFastRecover=
!0));this._updating=a}};e._updateQuality=function(a){a=Math.min(Math.max(a,this.minQuality),1);if(a===this._quality)return!1;this._quality=a;++this._numQualityChanges;return!0};e._layersUpdating=function(){return this.view.allLayerViews.some(a=>!!a.updating)};e._updateMemory=function(){let a=0;this.view.basemapTerrain&&(a+=this.view.basemapTerrain.usedMemory);var f=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderer.edgeView;q.isSome(f)&&(a+=f.usedMemory);let n=0;this.view.allLayerViews&&
this.view.allLayerViews.forEach(g=>{if(w.isMemoryManagedView(g)){const l=g.ignoresMemoryFactor?this._quality:1;a+=g.usedMemory*l;n+=g.unloadedMemory*l}});var k=q.isNone(this._warnMemoryUsage)||Math.round(10*a)!==Math.round(10*this._warnMemoryUsage);f=1048576*this.maxMemory;if(a>f&&k){this._warnMemoryUsage=a;k=l=>(l/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB";const g=Math.round(100*this._quality);u.getLogger(this.declaredClass).warn(`Memory Limit exceeded! Limit: ${k(f)} Current: ${k(a)} Projected: ${k(a+
n)} Quality: ${g}%`)}this._usedMemory=a/f;this._memoryPredicted=(a+n)/f;this._cacheStorage.maxSize=Math.max(0,f-a+1048576*this.additionalCacheMemory)};m._createClass(h,[{key:"maxMemory",get:function(){return this._maxMemory},set:function(a){null==a||0>=a||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<a&&this._updateQuality(1),this._maxMemory=a)}},{key:"additionalCacheMemory",get:function(){return this._additionalCacheMemory},set:function(a){null!=a&&0<=a&&(this._additionalCacheMemory=
a)}},{key:"memoryFactor",get:function(){return this._quality}},{key:"updating",get:function(){return this._updating}},{key:"usedMemory",get:function(){return this._usedMemory}},{key:"test",get:function(){const a=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const f=a._numQualityChanges;a._numQualityChanges=0;return f}}}}]);return h}(t);c.__decorate([d.property({constructOnly:!0})],b.prototype,"view",void 0);c.__decorate([d.property()],b.prototype,"maxMemory",null);c.__decorate([d.property()],
b.prototype,"additionalCacheMemory",null);c.__decorate([d.property()],b.prototype,"memoryFactor",null);c.__decorate([d.property()],b.prototype,"updating",null);c.__decorate([d.property()],b.prototype,"usedMemory",null);c.__decorate([d.property()],b.prototype,"_quality",void 0);c.__decorate([d.property()],b.prototype,"_usedMemory",void 0);c.__decorate([d.property()],b.prototype,"_updating",void 0);c.__decorate([d.property()],b.prototype,"_stableQuality",void 0);c.__decorate([d.property()],b.prototype,
"_maxMemory",void 0);c.__decorate([d.property()],b.prototype,"_additionalCacheMemory",void 0);b=c.__decorate([v.subclass("esri.views.3d.support.MemoryController")],b);p.newMemoryController=function(e){return new b({view:e})};Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});