// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../debugFlags ../debugUtils ../PropertiesPool ../geometryUtils/ray ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/verticalOffsetUtils ../../../support/Scheduler".split(" "),
function(b,r,d,D,E,t,e,f,V,W,X,F,u,y,z,G,n,H,I,J,w,K,L,M,N,A,O,P,v){b.PointsOfInterest=function(g){function p(a){a=Q.call(this,a);a._handles=new E;a._tmpRay=z.create();a._centerRayDirty=!0;a._surfaceAltitudeAtCenter=0;a._surfaceAltitudeAtCenterDirty=!0;a._contentAltitudeAtCenter=0;a._contentAltitudeAtCenterDirty=!0;a._propertiesPool=new H.PropertiesPool({renderPointOfView:R},r._assertThisInitialized(a));a.renderPointOfView=y.create();a._pois=[];a._debugCenters=new Map;return a}r._inherits(p,g);var Q=
r._createSuper(p);g=p.prototype;g.initialize=function(){const {state:a,basemapTerrain:c,renderCoordsHelper:h,map:x}=this.view;this._surfaceIntersector=A.newIntersector(a.viewingMode);this._surfaceIntersector.options.backfacesTerrain=a.isGlobal?!1:!0;this._surfaceIntersector.options.invisibleTerrain=!1;this._surfaceIntersector.options.store=O.StoreResults.MIN;this._contentIntersector=A.newIntersector(a.viewingMode);var k=()=>this._estimateSurfaceAltitudeAtCenter();const B=this.view.resourceController.scheduler,
C=t.unwrap(this.view.basemapTerrain?.elevationQueryCache),q={state:a,scheduler:B,surface:c,renderCoordsHelper:h};this._set("centerOnSurfaceInfrequent",new w.CenterOnSurface({...q,task:v.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:k}));this._set("centerOnSurfaceFrequent",new w.CenterOnSurface({...q,task:v.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:k}));this._set("centerOnContent",new w.CenterOnSurface({...q,task:v.TaskPriority.POINT_OF_INTEREST_FREQUENT,
estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));this._set("cameraOnSurface",new J.CameraOnSurface({...q,cache:C,task:v.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:x}));this._set("surfaceGeometryUpdates",new N.SurfaceGeometryUpdates({...q,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}));this._set("contentGeometryUpdates",new K.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:h}));
this._set("surfaceOrigin",new M.StableSurfaceCenter({cache:C,view:this.view}));this._set("focus",new L.Focus({state:a,scheduler:B,surface:c,renderCoordsHelper:h,centerOnSurface:this.centerOnSurfaceInfrequent,estimateSurfaceIntersectionAtRenderPoint:(l,S)=>this._estimateSurfaceIntersectionAtRenderPoint(l,this.view.state.contentCamera,S)}));this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);k=this.view.graphics;this._debugCenters.set(this.centerOnContent,
new n.PointGraphics(k,"red","CenterOnContent"));this._debugCenters.set(this.centerOnSurfaceFrequent,new n.PointGraphics(k,"red","CenterOnSurface"));this._debugCenters.set(this.centerOnSurfaceInfrequent,new n.PointGraphics(k,"red","CenterOnSurface"));this._debugCenters.set(this.cameraOnSurface,new n.PointGraphics(k,"blue","CameraOnSurface"));this._debugCenters.set(this.focus,new n.PointGraphics(k,"green","Focus"));this._handles.add([e.watch(()=>a.contentCamera,l=>this._cameraChanged(l),e.sync),e.watch(()=>
c.extent,()=>this._updateCenterPointsOfInterest()),e.when(()=>!c.updating,()=>this._updateCenterPointsOfInterest(),e.sync),e.on(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),e.on(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),e.when(()=>G.SHOW_POI,l=>this._setDebug(l),e.initial)]);this._cameraChanged(this.view.state.contentCamera);for(const l of this._pois)l.runTask()};g.destroy=function(){this._setDebug(!1);
this._handles.destroy();this._propertiesPool.destroy();for(const a of this._pois)a.destroy();this.surfaceOrigin.destroy()};g._estimateContentAltitudeAtCenter=function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const a=this._centerRay;if(t.isNone(a))return this._contentAltitudeAtCenter;this.view.sceneIntersectionHelper.intersectRay(a,this._contentIntersector,m,T)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(m):
this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter();return this._contentAltitudeAtCenter};g._estimateSurfaceAltitudeAtCenter=function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const a=this._centerRay;if(t.isNone(a))return this._surfaceAltitudeAtCenter;const c=a.origin,h=u.add(m,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,this.view.state.contentCamera);
this.view.basemapTerrain.intersect(this._surfaceIntersector,null,c,h);this._surfaceIntersector.results.min.getIntersectionPoint(m)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(m));return this._surfaceAltitudeAtCenter};g._estimateSurfaceIntersectionAtRenderPoint=function(a,c,h){a=I.fromRenderAtEye(c,a,U);if(t.isNone(a))return null;const x=a.origin,k=u.add(m,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,c);this.view.basemapTerrain.intersect(this._surfaceIntersector,
null,x,k);return this._surfaceIntersector.results.min.getIntersectionPoint(h)?h:null};g._cameraChanged=function(a){this._updateCenterPointsOfInterest();a=a.eye;u.exactEquals(this.renderPointOfView,a)||this._set("renderPointOfView",u.copy(this._propertiesPool.get("renderPointOfView"),a))};g._updateCenterPointsOfInterest=function(){this._contentAltitudeAtCenterDirty=this._surfaceAltitudeAtCenterDirty=this._centerRayDirty=!0;for(const a of this._pois)a.updateRenderLocation()};g._updateCenterOnContent=
function(){this._contentAltitudeAtCenterDirty=!0;this.centerOnContent.updateRenderLocation()};g._setDebug=function(a){if(a)for(const c of this._pois)this._handles.add(e.watch(()=>c.renderLocation,h=>this._debugCenters.get(c)?.show(h,c.renderCoordsHelper.spatialReference),e.initial),"debug");else this._debugCenters.forEach(c=>c.hide()),this._handles.remove("debug")};r._createClass(p,[{key:"updating",get:function(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(a=>a.updating))}},{key:"_centerRay",
get:function(){this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1);return this._centerRayCached}},{key:"test",get:function(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const a of this._pois)a.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]);return p}(D);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnContent",
void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"cameraOnSurface",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"focus",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"renderPointOfView",void 0);d.__decorate([f.property({readOnly:!0})],
b.PointsOfInterest.prototype,"surfaceOrigin",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"contentGeometryUpdates",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"surfaceGeometryUpdates",void 0);d.__decorate([f.property({constructOnly:!0})],b.PointsOfInterest.prototype,"view",void 0);d.__decorate([f.property({readOnly:!0})],b.PointsOfInterest.prototype,"updating",null);b.PointsOfInterest=d.__decorate([F.subclass("esri.views.3d.support.PointsOfInterest")],
b.PointsOfInterest);const R=Array,m=y.create(),U=z.create(),T={exclude:new Set([P.TERRAIN_ID])};Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});