// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../request ../../../core/Accessor ../../../core/arrayUtils ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ./AsyncWorkerQueue ../webgl-engine/lib/Util ../../support/Scheduler".split(" "),function(f,m,x,u,C,D,E,F,q,n,G,M,H,y,I,J){function K(c){if(2>
c.byteLength)return"unknown";c=new Uint8Array(c,0,c.byteLength);return 137===c[0]&&80===c[1]?"image/png":71===c[0]&&73===c[1]?"image/gif":66===c[0]&&77===c[1]?"image/bmp":255===c[0]&&216===c[1]?"image/jpeg":"unknown"}f.StreamDataLoader=function(c){function k(){var a=r.apply(this,arguments);a._tasks=new Map;a._onLoadQueue=[];a._doneQueue=[];a.updating=!1;return a}m._inherits(k,c);var r=m._createSuper(k);c=k.prototype;c.setup=function(a,d,g){this._loadQueue=new y.AsyncWorkerQueue((b,e)=>this._startLoading(b,
e),(b,e)=>this._doneLoadingCB(b,e),a,d);g&&(this._frameTask=g.registerTask(J.TaskPriority.STREAM_DATA_LOADER,this))};c.destroy=function(){this._frameTask=q.removeMaybe(this._frameTask);this._tasks.forEach(a=>q.abortMaybe(a.abortController));this._loadQueue=q.destroyMaybe(this._loadQueue);this._tasks=this._doneQueue=this._onLoadQueue=null};c.hasDownloadSlots=function(a){return this._loadQueue.hasQuota(a)};c.request=function(a,d,g,b={}){const e=n.createResolver();e.__signal=q.isSome(b)?b.signal:null;
const l=this._createOrUpdateTask(a,d,g,b,e);n.onAbort(b,()=>this._cancelRequest(l,e));return e.promise};c._createTask=function(a,d,g,b,e,l){a=new L(a,d,g,b,e);this._updateTask(a,l);this._tasks.set(e,a);1===this._tasks.size&&this._set("updating",!0);this._loadQueue.push(a);return a};c._cancelRequest=function(a,d){D.removeUnordered(a.resolvers,d);d.reject(n.createAbortError());0===a.resolvers.length&&(a.status===f.TaskStatus.DOWNLOADING&&(a.status=f.TaskStatus.CANCELLED,this._loadQueue.cancel(a),a.abortController?.abort(),
a.request=null,a.abortController=null),a.status=f.TaskStatus.CANCELLED,this._tasks.delete(a.key),0===this._tasks.size&&this._set("updating",!1))};c._updateTask=function(a,d){a.resolvers.push(d)};c._createOrUpdateTask=function(a,d,g,b,e){const l=`${q.isSome(b)&&b.uid||a}:${d}:${g}`,p=this._tasks.get(l);return p?(this._updateTask(p,e),p):this._createTask(a,b,d,g,l,e)};c._doneLoadingCB=function(a,d){this._loadQueue&&(I.assert(a.status===f.TaskStatus.DOWNLOADING),a.status=f.TaskStatus.DOWNLOADED,this._frameTask?
this._doneQueue.push({task:a,err:d}):this._doneLoading(a,d))};c.runTask=function(a){for(;!a.done&&0<this._onLoadQueue.length;){var d=this._onLoadQueue.shift();n.throwIfAborted(d.task.abortController);d.task.abortController=null;d.callback(d.task);a.madeProgress()}for(;!a.done&&0<this._doneQueue.length;)d=this._doneQueue.shift(),d.task.status!==f.TaskStatus.DOWNLOADED&&(d.err=d.err||n.createAbortError()),this._doneLoading(d.task,d.err),a.madeProgress()};c._doneLoading=function(a,d){if(d&&!n.isAbortError(d)&&
0<a.numRetries)--a.numRetries,this._loadQueue.push(a);else{var g=a.result instanceof HTMLImageElement?0:a.resolvers.length;for(const b of a.resolvers)if(d)n.isAbortError(d)?b.reject(d):b.reject(new E("stream-data-loader:request-error",`Failed to request resource at '${a.url}'. ${d}`,{url:a.url,error:d}));else{--g;const e=0>=g?a.result:F.clone(a.result);b.resolve(e)}this._tasks.delete(a.key);0===this._tasks.size&&this._set("updating",!1)}};c._startLoading=function(a,d){if(a.status===f.TaskStatus.CANCELLED)return!1;
a.startTime=performance.now();a.status=f.TaskStatus.DOWNLOADING;let g,b;switch(a.docType){case "binary":b="array-buffer";g=0;break;case "image":b="image";break;case "image+type":b="array-buffer";break;default:b="json"}a.abortController=new AbortController;const e=a.abortController.signal;a.request=u(a.url,{...a.options,responseType:b,timeout:g,signal:e});let l=()=>{};const p=h=>{a.duration=performance.now()-a.startTime;a.size=h instanceof ArrayBuffer?h.byteLength:a.size||0;a.result=h;this._frameTask?
this._onLoadQueue.push({callback:d,task:a}):(a.abortController=null,d(a))},t=h=>{a.status===f.TaskStatus.DOWNLOADING&&d(a,h);l()};if("image+type"!==a.docType)return a.request.then(h=>p(h.data),t),!0;a.request.then(h=>{h=h.data;const v=K(h);b="image";a.size=h.byteLength;if("unknown"===v)a.request=u(a.url,{responseType:b,timeout:g,signal:e}),a.request.then(w=>p(w.data),t);else{h=new Blob([h],{type:v});var z=window.URL.createObjectURL(h);l=()=>window.URL.revokeObjectURL(z);a.request=u(z,{responseType:b,
timeout:g,signal:e});a.request.then(w=>p(new A(w.data,v,l)),t)}},t);return!0};m._createClass(k,[{key:"running",get:function(){return 0<this._doneQueue.length||0<this._onLoadQueue.length}},{key:"test",get:function(){return{loadQueue:this._loadQueue}}}]);return k}(C);x.__decorate([G.property({readOnly:!0})],f.StreamDataLoader.prototype,"updating",void 0);f.StreamDataLoader=x.__decorate([H.subclass("esri.views.3d.support.StreamDataLoader")],f.StreamDataLoader);const B={numRetries:0};let A=function(){function c(k,
r,a){this.image=k;this.type=r;this.release=a}m._createClass(c,[{key:"isOpaque",get:function(){return"image/jpeg"===this.type}}]);return c}(),L=function(c){function k(a,d,g,b,e){b=r.call(this,b);b.url=a;b.options=d;b.docType=g;b.key=e;b.result=null;b.status=f.TaskStatus.QUEUED;b.request=null;b.abortController=null;b.resolvers=[];b.startTime=0;b.numRetries=B.numRetries;return b}m._inherits(k,c);var r=m._createSuper(k);return m._createClass(k)}(y.BaseTask);f.TaskStatus=void 0;(function(c){c[c.QUEUED=
1]="QUEUED";c[c.DOWNLOADING=2]="DOWNLOADING";c[c.DOWNLOADED=3]="DOWNLOADED";c[c.CANCELLED=4]="CANCELLED"})(f.TaskStatus||(f.TaskStatus={}));f.ImageWithType=A;f.test=B;Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});