// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../Camera ../../../geometry ../../../Graphic ../../../Viewpoint ../../../core/asyncUtils ../../../core/has ../../../core/Cyclical ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../chunks/mat3 ../../../chunks/mat3f64 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../geometry/support/scaleUtils ../../../geometry/support/webMercatorUtils ../camera/intersectionUtils ./cameraUtils ./ElevationProvider ../../../geometry/Point ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Geometry".split(" "),
function(w,V,va,fa,K,W,wa,X,D,n,ha,Y,ia,ja,m,E,u,q,Z,ka,la,y,z,h,aa,F,L,ma,na){function M(a){return 360-X.cyclicalDegrees.normalize(a)}function A(a){return X.cyclicalDegrees.normalize(360-a)}function B(a){n.isSome(a)&&a.resolver&&a.resolver.reject();return null}function ba(a,b,c,d=null){if(!b)return B(d);var e=a.spatialReference||L.WGS84;if(n.isSome(b.camera)){a=y.project(b.camera.position,e);if(n.isNone(a))return B(d);b=b.camera.clone();b.position=a;a=b;n.isSome(d)&&d.resolver&&d.resolver.resolve(a);
return a}if(n.isNone(b.targetGeometry))return B(d);var f=b.get("targetGeometry.spatialReference");if(f&&!y.canProject(f,e))return B(d);e=h.internalToExternal(a,a.state.camera);f=h.OrientationMode.ADJUST;null!=b.rotation&&(e.heading=M(b.rotation),f=h.OrientationMode.LOCKED);null!=c&&(e.tilt=c);if("point"===b.targetGeometry.type){const g=b.targetGeometry;c=b.targetGeometry.clone();b=null!=b.scale?h.scaleToDistance(a,b.scale,g.latitude):a.state.camera.distance;return h.fromCenterDistance(a,c,b,e,f,d)}return(b=
b.targetGeometry.extent)?h.fromExtent(a,b,e.heading,e.tilt,f,d):B(d)}function N(a,b){return null==b.scale&&null!=b.zoom?h.zoomToScale(a,b.zoom):b.scale}function O(a,b){let c=!1;null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=M(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&(a.fov=b.fov);return c}function P(a,b,c,d){const e=a.spatialReference||L.WGS84;b=n.isSome(b)?b:h.externalToInternal(a,c);if(n.isNone(b))return d;d.targetGeometry=u.projectVectorToPoint(b.center,
a.renderSpatialReference,e);d.scale=h.computeScale(a,b);d.rotation=A(c.heading);d.camera=c;return d}function G(a,b,c){var d=()=>new D("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!b)throw d();if(!y.canProject(b.spatialReference,a.spatialReference))throw new D("viewpointutils:incompatible-spatialreference",`Spatial reference (${b.spatialReference?b.spatialReference.wkid:"unknown"}) is incompatible with the view (${a.spatialReference?.wkid})`,{geometry:b});const e=
[];if(!b.hasZ&&a.basemapTerrain){switch(b.type){case "point":var f=b;break;case "multipoint":case "polyline":f=b.extent?.center;break;case "mesh":f=b.origin;break;case "extent":f=b.center;break;case "polygon":f=b.centroid}f&&n.isSome(a.basemapTerrain.spatialReference)&&y.canProject(f,a.basemapTerrain.spatialReference)&&a.elevationProvider?l[2]=n.unwrapOr(aa.getElevationAtPoint(a.elevationProvider,f),0):l[2]=0}(0,oa[b.type])(b,g=>{e.push(g[0],g[1],g[2])},l);f=e.length/3;if(0===f)throw d();d=Array(e.length);
if(u.projectBuffer(e,b.spatialReference,0,d,a.spatialReference,0,f))for(b.hasZ&&(c.hasZ=!0),a=0;a<d.length;a+=3)b.hasZ?(l[0]=d[a],l[1]=d[a+1],l[2]=d[a+2]):(l[0]=d[a],l[1]=d[a+1]),q.expandWithVec3(c.boundingBox,l)}async function pa(a,b,c,d){const e=await W.result(a.whenViewForGraphic(b));if(!1!==e.ok&&!n.isNone(e.value)&&"whenGraphicBounds"in e.value)if(c=await W.result(e.value.whenGraphicBounds(b,{minDemResolution:c})),!1===c.ok)G(a,b.geometry,d);else{var {screenSpaceObjects:f,boundingBox:g}=c.value;
q.expandWithAABB(d.boundingBox,g);f&&f.forEach(k=>{d.screenSpaceObjects.push(k)});isFinite(g[2])&&(d.hasZ=!0)}else G(a,b.geometry,d)}async function ca(a,b,c,d){if(Array.isArray(b)&&2===b.length){const e=b[0],f=b[1];if("number"===typeof e&&"number"===typeof f){p.x=e;p.y=f;p.z=void 0;p.spatialReference=a.spatialReference?.isGeographic?a.spatialReference:L.WGS84;G(a,p,d);return}}b&&"function"===typeof b.map?await ha.eachAlways(b.map(e=>ca(a,e,c,d))):b instanceof na?G(a,b,d):b instanceof fa&&await pa(a,
b,c,d)}async function qa(a,b,c,d,e){if(n.isSome(b.camera))return da(a,b.camera,e);e.scale=b.scale;e.rotation=b.rotation;e.targetGeometry=n.isSome(b.targetGeometry)?b.targetGeometry.clone():null;e.camera=null;null!=c.heading?e.rotation=A(c.heading):null!=c.rotation&&(e.rotation=c.rotation);b=N(a,c);null!=b&&(e.scale=b);d=new h.AsyncContext(d);ba(a,e,c.tilt,d);e.camera=await d.resolver.promise;return e}function da(a,b,c){const d=y.project(b.position,a.spatialReference);if(n.isNone(d))return null;b=
b.clone();b.fov=a.camera.fov;b.position=d;return P(a,null,b,c)}async function Q(a,b,c,d,e,f){if(n.isNone(c))throw new D("createfromcenter","invalid point");f.targetGeometry=c.clone();var g=z.cameraOnContentAlongViewDirection(a);if(b.position)return c=f.targetGeometry,b=b.position,e=a.renderSpatialReference,u.projectPointToVector(b,H,e),u.projectPointToVector(c,R,e),f.targetGeometry=new F(c),d.position=new F(b),m.subtract(I,R,H),h.directionToHeadingTilt(a,H,I,g.up,d),f.scale=h.distanceToScale(a,m.distance(H,
R),f.targetGeometry.latitude),f.rotation=A(d.heading),f.camera=d,f;if(b.zoomFactor){var k=g.distance/b.zoomFactor;const t=m.scale(l,g.viewForward,-k);g.eye=m.add(l,g.center,t);f.scale=h.distanceToScale(a,k,c.latitude)}h.internalToExternal(a,g,d);k=O(d,b)?h.OrientationMode.LOCKED:h.OrientationMode.ADJUST;b.zoomFactor||(b=N(a,b),null==b?(u.projectPointToVector(c,l,a.renderSpatialReference),ka.intersectsPoint(g.frustum,l)?f.scale=h.distanceToScale(a,m.distance(g.eye,l),c.latitude):f.scale=h.computeScale(a,
g)):f.scale=b,g=new h.AsyncContext(e),h.fromCenterScale(a,f.targetGeometry,f.scale,d,k,g),f.camera=await g.resolver.promise);return f}async function ra(a,b,c,d,e){var f=z.cameraOnContentAlongViewDirection(a);f=u.projectVectorToPoint(f.center,a.renderSpatialReference,a.spatialReference);return Q(a,b,f,c,d,e)}async function sa(a,b,c,d,e,f){f.targetGeometry=c.clone();const g=z.cameraOnContentAlongViewDirection(a);h.internalToExternal(a,g,d);b=O(d,b)?h.OrientationMode.LOCKED:h.OrientationMode.ADJUST;
e=new h.AsyncContext(e);h.fromExtent(a,c,d.heading,d.tilt,b,e);f.camera=await e.resolver.promise;return f}async function ta(a,b,c,d,e,f,g,k){k.targetGeometry=c.clone();const t=z.cameraOnContentAlongViewDirection(a);var r=0;null!=c.z?r=c.z:a.basemapTerrain&&a.elevationProvider&&(r=n.unwrap(aa.getElevationAtPoint(a.elevationProvider,c)));m.set(l,c.x,c.y,r);u.computeTranslationToOriginAndRotation(a.spatialReference,l,ea,a.renderSpatialReference);Y.fromMat4(J,ea);Y.transpose(J,J);q.empty(C);c=[[0,1,2],
[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(var x=0;x<c.length;x++){const S=c[x];let T=d[S[2]];isFinite(T)||(T=r);m.set(l,d[S[0]],d[S[1]],T);u.projectVectorToVector(l,a.spatialReference,l,a.renderSpatialReference);q.expandWithVec3(C,m.transformMat3(l,l,J))}d=q.width(C);r=q.height(C);c=q.depth(C);x=1/Math.tan(t.fovY/2);e=Math.max(.5*Math.sqrt(d*d+c*c)*Math.max(x,1/Math.tan(t.fovX/2))+.5*r,.5*r*x+.5*Math.max(d,c))/e;h.internalToExternal(a,t,f);b=O(f,b)?h.OrientationMode.LOCKED:h.OrientationMode.ADJUST;
k.scale=h.distanceToScale(a,e,k.targetGeometry.latitude);g=new h.AsyncContext(g);h.fromCenterScale(a,k.targetGeometry,k.scale,f,b,g);k.camera=await g.resolver.promise;return k}function v(a){a&&n.isSome(a.camera)&&(a.rotation=A(a.camera.heading));return a}const l=E.create(),ea=ja.create(),J=ia.create(),C=q.create(),ua=Z.create(),I=E.create(),H=E.create(),R=E.create(),U={heading:0,tilt:0},p=new F,oa={point(a,b,c){c[0]=a.x;c[1]=a.y;null!=a.z&&(c[2]=a.z);b(c)},polygon(a,b,c){const d=a.hasZ;for(let e=
0;e<a.rings.length;e++){const f=a.rings[e];for(let g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],d&&(c[2]=f[g][2]),b(c)}},polyline(a,b,c){const d=a.hasZ;for(let e=0;e<a.paths.length;e++){const f=a.paths[e];for(let g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],d&&(c[2]=f[g][2]),b(c)}},multipoint(a,b,c){const d=a.points;a=a.hasZ;for(let e=0;e<d.length;e++)c[0]=d[e][0],c[1]=d[e][1],a&&(c[2]=d[e][2]),b(c)},extent(a,b,c){null!=a.zmin&&null!=a.zmax?(b(m.set(c,a.xmin,a.ymin,a.zmin)),b(m.set(c,a.xmax,a.ymin,
a.zmin)),b(m.set(c,a.xmin,a.ymax,a.zmin)),b(m.set(c,a.xmax,a.ymax,a.zmin)),b(m.set(c,a.xmin,a.ymin,a.zmax)),b(m.set(c,a.xmax,a.ymin,a.zmax)),b(m.set(c,a.xmin,a.ymax,a.zmax)),b(m.set(c,a.xmax,a.ymax,a.zmax))):(b(m.set(c,a.xmin,a.ymin,c[2])),b(m.set(c,a.xmax,a.ymin,c[2])),b(m.set(c,a.xmin,a.ymax,c[2])),b(m.set(c,a.xmax,a.ymax,c[2])))},mesh(a,b,c){if(a=a.vertexAttributes&&a.vertexAttributes.position)for(let d=0;d<a.length;d+=3)b(m.set(c,a[d],a[d+1],a[d+2]))}};w.create=async function(a,b,c){if(b&&a.spatialReference){var d=
{target:void 0};if("declaredClass"in b||Array.isArray(b))d.target=b;else{for(var e in b)d[e]=b[e];b.center&&!d.target&&(d.target=b.center)}b=d}else b=null;if(!b)throw new D("viewpointutils-create:no-target","Missing target for creating viewpoint");d=new V({fov:a.camera.fov});e=new K({camera:d});if(b.target instanceof K)return a=await qa(a,b.target,b,c,e),v(a);if(b.target instanceof V)return v(da(a,b.target,e));var f=null!=b.scale||null!=b.zoom;if(b.target instanceof ma){var g=b.target.xmin===b.target.xmax||
b.target.ymin===b.target.ymax;return f||g?v(await Q(a,b,b.target.center,d,c,e)):v(await sa(a,b,b.target,d,c,e))}g={boundingBox:q.empty(),hasZ:!1,screenSpaceObjects:[]};var k=f?(k=N(a,b))?la.getResolutionInMetersForScale(k):void 0:void 0;await ca(a,b.target,k,g);if(isFinite(g.boundingBox[0])){q.center(g.boundingBox,l);p.x=l[0];p.y=l[1];p.z=l[2];p.spatialReference=a.spatialReference;isFinite(p.z)&&g.hasZ?k=q.isPoint(g.boundingBox):(p.z=void 0,k=Z.isPoint(q.toRect(g.boundingBox,ua)));if(f||k)return v(await Q(a,
b,p,d,c,e));f=g.screenSpaceObjects;if(f.length){k=Number.NEGATIVE_INFINITY;for(let t=0;t<f.length;t++){const r=f[t].screenSpaceBoundingRect;k=Math.max(k,Math.abs(r[0]),Math.abs(r[1]),Math.abs(r[2]),Math.abs(r[3]))}f=.66-k/Math.min(a.width,a.height)*2}else f=.66;return v(await ta(a,b,p,g.boundingBox,f,d,c,e))}return b.position?(c=z.cameraOnContentAlongViewDirection(a),m.copy(I,c.viewForward),h.directionToHeadingTilt(a,c.eye,I,c.up,U),d.position=new F(b.position),d.heading=null!=b.heading?b.heading:
U.heading,d.tilt=null!=b.tilt?b.tilt:U.tilt,a=P(a,null,d,e),v(a)):v(await ra(a,b,d,c,e))};w.fromCamera=function(a,b,c=null){n.isNone(c)&&(c=new K);return P(a,null,b.clone(),c)};w.headingToRotation=A;w.rotationToHeading=M;w.toCamera=ba;Object.defineProperty(w,Symbol.toStringTag,{value:"Module"})});