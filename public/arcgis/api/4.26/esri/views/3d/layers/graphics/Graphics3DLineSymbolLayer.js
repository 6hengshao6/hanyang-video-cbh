// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../geometry ../../../../core/Error ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../renderers/support/renderingInfoUtils ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./interfaces ./lineUtils ../support/FastSymbolUpdates ../../support/debugFlags ../../support/engineContent/line ../../support/engineContent/marker ../../support/renderInfoUtils/line ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/LineMarkerMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../../geometry/Extent ../../../../geometry/Polygon".split(" "),
function(H,u,B,K,e,v,C,k,L,M,q,N,O,P,z,D,E,F,G,Q,R,I,S,T,U,V,A,W,X){const Y=["polyline","polygon","extent"];B=function(f){function r(a,b,c,d){a=Z.call(this,a,b,c,d);a._vvConvertOptions=new F.ConvertOptions;return a}u._inherits(r,f);var Z=u._createSuper(r);f=r.prototype;f.doLoad=async function(){this._vvConvertOptions.supportsOpacity=!0;this._vvConvertOptions.supportsRotation=!1;this._fastUpdates=F.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions);if(!this._drivenProperties.size&&
0>(null!=this.symbolLayer.size?this.symbolLayer.size:v.px2pt(1)))throw new K("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._markerTexture=e.isSome(this.symbolLayer.marker)&&e.isSome(this._context.sharedResources.textures)?R.prepareMarkerResources(this._context.sharedResources.textures,E.parseLineMarkerStyle(this.symbolLayer.marker.style)):null};f._getMaterialParameters=function(a,b=!1){const c=this._getCombinedOpacityAndColor(b&&this._markerColor||this._materialColor);
this._patternHidesLine&&!b&&(c[3]=0);a={width:this._computeMaterialWidth(this.symbolLayer?.size),color:c,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:E.parseCapType(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:a,stipplePattern:V.getStipplePatternForLinePattern(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates?.visualVariables?{...a,...this._fastUpdates.materialParameters}:a};f.destroy=function(){u._get(u._getPrototypeOf(r.prototype),
"destroy",this).call(this);this._forEachMaterial(a=>this._context.stage.remove(a));this._markerMaterialCached=this._wireframeRingMaterialCached=this._wireframeLineMaterialCached=this._ringMaterialCached=this._lineMaterialCached=null;this._markerTexture=e.releaseMaybe(this._markerTexture)};f._getDrivenSize=function(a){return this._drivenProperties.size&&a.size?v.pt2px(L.getDriverAxisSizeValueAny(a.size)):1};f._getSizeFeatureAttributeData=function(a){return this._fastUpdates&&this._fastUpdates.visualVariables.size?
z.getAttributeValue(this._fastUpdates.visualVariables.size.field,a):null};f._getDrivenColor=function(a){const b=C.fromValues(1,1,1,1);this._drivenProperties.color&&a.color&&(b[0]=a.color[0],b[1]=a.color[1],b[2]=a.color[2],0<a.color.length&&(b[3]=a.color[3]));this._drivenProperties.opacity&&a.opacity&&(b[3]=a.opacity);return b};f._getColorFeatureAttributeData=function(a){return this._fastUpdates?.visualVariables.color?z.getAttributeValue(this._fastUpdates.visualVariables.color.field,a):null};f._getOpacityFeatureAttributeData=
function(a){return this._fastUpdates?.visualVariables.opacity?z.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,a):null};f.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,Y,this.symbolLayer.type))return null;const c=this.setGraphicElevationContext(b,new N.ElevationContext);this.ensureDrapedStatus("on-the-ground"===c.mode);return this.draped?this._createAsOverlay(a,this._context.layer.uid):this._createAs3DShape(a,c,b.uid)};f.applyRendererDiff=
function(a,b){for(const c in a.diff)switch(c){case "visualVariables":const d=this._fastUpdates;if(F.updateFastSymbolUpdatesState(d,b,this._vvConvertOptions))this._forEachMaterial(g=>g.setParameters(d.materialParameters));else return D.ApplyRendererDiffResult.Recreate_Symbol;break;default:return D.ApplyRendererDiffResult.Recreate_Symbol}return D.ApplyRendererDiffResult.Fast_Update};f.prepareSymbolLayerPatch=function(a){if("partial"===a.diff.type){var b=a.diff.diff,c={};"complete"===b.size?.type&&(c.width=
this._computeMaterialWidth(b.size.newValue),delete b.size);"complete"===b.cap?.type&&(c.cap=E.parseCapType(e.unwrapOr(b.cap.newValue,"butt")),delete b.cap);var d=this._prepareMarkerPatch(a,b);this._prepareMaterialPatch(a,b,d);a.symbolLayerStatePatches.push(()=>this._forEachMaterial(g=>g.setParameters(c)))}};f.layerOpacityChanged=function(){this._forEachMaterial((a,b)=>this._updateMaterialLayerOpacity(a,b))};f._forEachMaterial=function(a){e.isSome(this._lineMaterialCached)&&a(this._lineMaterialCached);
e.isSome(this._ringMaterialCached)&&a(this._ringMaterialCached);e.isSome(this._wireframeLineMaterialCached)&&a(this._wireframeLineMaterialCached);e.isSome(this._wireframeRingMaterialCached)&&a(this._wireframeRingMaterialCached);e.isSome(this._markerMaterialCached)&&a(this._markerMaterialCached,!0)};f._updateMaterialLayerOpacity=function(a,b=!1){var c=a.parameters.color;const d=e.get(this.symbolLayer,"material","color");b=this._patternHidesLine&&!b?0:this._getCombinedOpacity(d);c=C.fromValues(c[0],
c[1],c[2],b);a.setParameters({color:c})};f.layerElevationInfoChanged=function(a,b,c){const d=this._elevationContext.mode;c=q.elevationModeChangeUpdateType(r.elevationModeChangeTypes,c,d);if(c!==q.SymbolUpdateType.UPDATE)return c;const g=q.needsElevationUpdates2D(d);return this.updateGraphics3DGraphicElevationInfo(a,b,()=>g)};f.slicePlaneEnabledChanged=function(){const a={hasSlicePlane:this._context.slicePlaneEnabled};this._forEachMaterial(b=>b.setParameters(a));return!0};f.physicalBasedRenderingChanged=
function(){return!0};f._getGeometryAsPolygonOrPolyline=function(a){switch(a.type){case "extent":if(a instanceof W)return X.fromExtent(a);break;case "polygon":case "polyline":return a}return null};f._createAs3DShape=function(a,b,c){const d=this._getGeometryAsPolygonOrPolyline(a.graphic.geometry);var g="polygon"===d.type?d.rings:d.paths,h=[];const m=k.create(),n=I.geometryToRenderInfo(d,this._context.elevationProvider,this._context.renderCoordsHelper,b);this._logGeometryCreationWarnings(n,g,"polygon"===
d.type?"rings":"paths","LineSymbol3DLayer");for(g=0;g<n.lines.length;g++){var p=n.lines[g],l=p.position;p=p.mapPositions;if(e.isSome(this._context.clippingExtent)&&(k.empty(m),k.expandWithBuffer(m,p),!k.intersectsClippingArea(m,this._context.clippingExtent)))continue;l=this._createGeometry("polygon"===d.type?this._ringMaterial:this._lineMaterial,a,l,p,d.type,w.ELEVATED,c);h.push(l);G.LINE_WIREFRAMES&&h.push(l.instantiate({material:"polygon"===d.type?this._wireframeRingMaterial:this._wireframeLineMaterial}));
e.isSome(this._markerMaterial)&&h.push(l.instantiate({material:this._markerMaterial}))}if(0===h.length)return null;a=new S.Object3D({geometries:h,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:c}});h=new P.Graphics3DObject3DGraphicLayer(this,a,h,null,null,M.sharedGeometryElevationAligner,b);h.alignedSampledElevation=n.sampledElevation;h.needsElevationUpdates=q.needsElevationUpdates2D(b.mode);return h};f._createGeometry=function(a,b,c,d,g,h,m){g="polygon"===g;const n=this._fastUpdates?.visualVariables.color,
p=this._fastUpdates?.visualVariables.size;m=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:m,layerUid:this._context.layer.uid});return Q.createGeometry(a,{overlayInfo:h===w.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:g,mapPositions:d,attributeData:{position:c,size:p?null:this._getDrivenSize(b.renderingInfo),color:n?null:this._getDrivenColor(b.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(b.graphic),
colorFeature:this._getColorFeatureAttributeData(b.graphic),opacityFeature:this._getOpacityFeatureAttributeData(b.graphic)}},m)};f._createAsOverlay=function(a,b){const c=a.graphic,d=this._getGeometryAsPolygonOrPolyline(c.geometry);var g="polygon"===d.type?d.rings:d.paths;const h="polygon"===d.type?this._ringMaterial:this._lineMaterial;h.renderPriority=this._renderPriority;const m=G.LINE_WIREFRAMES?"polygon"===d.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,n=this._markerMaterial;
e.isSome(m)&&(m.renderPriority=this._renderPriority-.001);e.isSome(n)&&(n.renderPriority=this._renderPriority-.002);const p=[],l=k.create(),J=k.empty();var t=I.geometryToRenderInfoDraped(d,this._context.overlaySR);this._logGeometryCreationWarnings(t,g,"polygon"===d.type?"rings":"paths","LineSymbol3DLayer");for(const x of t.lines)k.empty(l),k.expandWithBuffer(l,x.position),k.intersectsClippingArea(l,this._context.clippingExtent)&&(k.expandWithAABB(J,l),g=y=>{y=this._createGeometry(y,a,x.position,void 0,
d.type,w.DRAPED,c.uid);y=new T.RenderGeometry(y,{layerUid:b,graphicUid:c.uid});p.push(y)},e.isSome(n)&&(g(n),t=e.unwrap(this.symbolLayer.marker).placement,"begin"!==t&&"begin-end"!==t||k.expandWithBuffer(l,x.position,0,1),"end"!==t&&"begin-end"!==t||k.expandWithBuffer(l,x.position,x.position.length-3,1)),g(h),G.LINE_WIREFRAMES&&g(m));return new O(this,p,J,this._context.drapeSourceRenderer)};f._computeMaterialWidth=function(a){a=e.unwrapOr(a,v.px2pt(1));return this._drivenProperties.size?this._fastUpdates?.visualVariables.size?
v.pt2px(1):1:v.pt2px(a)};f._prepareMaterialPatch=function(a,b,c){var d=b.material;e.isNone(d)?c.changed&&c.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,a):"collection"!==d.type&&(d="complete"===d.type?e.applySome(d.newValue,g=>g.color):"complete"===d.diff.color?.type?d.diff.color.newValue:null,d=this._getCombinedOpacityAndColor(d),c.useMaterialColor&&this._patchMaterialColor(C.clone(d),this._markerMaterialCached,a),this._patternHidesLine&&
(d[3]=0),this._patchMaterialColor(d,this._lineMaterialCached,a),delete b.material)};f._prepareMarkerPatch=function(a,b){var c=b.marker;if(e.isNone(c)||"partial"!==c.type||e.isSome(c.diff.style)||e.isSome(c.diff.placement)||e.isSome(c.diff.color)&&"complete"!==c.diff.color.type)return{changed:!1,useMaterialColor:e.isNone(this._markerColor)};c=c.diff.color;if(e.isNone(c))return delete b.marker,{changed:!1,useMaterialColor:e.isNone(this._markerColor)};c=e.unwrap(c.newValue);if(e.isNone(c))return delete b.marker,
{changed:!0,useMaterialColor:!0};this._patchMaterialColor(this._getCombinedOpacityAndColor(c),this._markerMaterialCached,a);delete b.marker;return{changed:!0,useMaterialColor:!1}};f._patchMaterialColor=function(a,b,c){e.isNone(b)||c.symbolLayerStatePatches.push(()=>b.setParameters({color:a}))};u._createClass(r,[{key:"_materialColor",get:function(){return e.applySome(this.symbolLayer.material,a=>a.color)}},{key:"_markerColor",get:function(){return e.applySome(this.symbolLayer.marker,a=>a.color)}},
{key:"_lineMaterial",get:function(){e.isNone(this._lineMaterialCached)&&(this._lineMaterialCached=new A.RibbonLineMaterial(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached));return this._lineMaterialCached}},{key:"_ringMaterial",get:function(){e.isNone(this._ringMaterialCached)&&(this._ringMaterialCached=new A.RibbonLineMaterial(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached));return this._ringMaterialCached}},{key:"_wireframeLineMaterial",
get:function(){e.isNone(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new A.RibbonLineMaterial({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached));return this._wireframeLineMaterialCached}},{key:"_wireframeRingMaterial",get:function(){e.isNone(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new A.RibbonLineMaterial({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached));
return this._wireframeRingMaterialCached}},{key:"_markerMaterial",get:function(){e.isNone(this._markerMaterialCached)&&e.isSome(this.symbolLayer.marker)&&e.isSome(this._markerTexture)&&(this._markerMaterialCached=new U.LineMarkerMaterial({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached));return this._markerMaterialCached}},{key:"_patternHidesLine",get:function(){const a=
this.symbolLayer.pattern;return e.isSome(a)&&"style"===a.type&&"none"===a.style}}]);return r}(z.Graphics3DSymbolLayer);B.elevationModeChangeTypes={definedChanged:q.SymbolUpdateType.RECREATE,staysOnTheGround:q.SymbolUpdateType.NONE,onTheGroundChanged:q.SymbolUpdateType.RECREATE};var w;(function(f){f[f.DRAPED=0]="DRAPED";f[f.ELEVATED=1]="ELEVATED"})(w||(w={}));H.Graphics3DLineSymbolLayer=B;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});