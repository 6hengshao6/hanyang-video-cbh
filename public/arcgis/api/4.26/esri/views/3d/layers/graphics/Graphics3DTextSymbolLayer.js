// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../chunks/vec2f64 ../../../../symbols/callouts/calloutUtils ./CreateLabelParameters ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DObjectMetadata ./Graphics3DSymbolLayer ./graphicUtils ./placementUtils ./pointUtils ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureFactory ../../webgl-engine/materials/HUDMaterial".split(" "),
function(C,q,D,I,e,J,K,u,E,L,M,x,N,O,P,y,Q,r,v,R,S,T,F){function G(b,h,z){b&&b.forEach(a=>{const c=h(a);e.isSome(c)&&z(c,a.graphic)})}function U(b,h){if("baseline"===h.verticalPlacement)return h=r.horizontalPlacementToAnchorX[h.horizontalPlacement],b=e.isSome(b)?b.baselineAnchorY:0,u.fromValues(h,b);b=r.anchorFromPlacements(h.horizontalPlacement,h.verticalPlacement);return r.namedAnchorToHUDMaterialAnchorPos[b]}const V=[0,0,1];y=function(b){function h(a,c,f,d){a=z.call(this,a,c,f,d);a._elevationOptions=
{supportsOffsetAdjustment:!0,supportsOnTheGround:!1};A.set(q._assertThisInitialized(a),!1);a.ensureDrapedStatus(!1);return a}q._inherits(h,b);var z=q._createSuper(h);b=h.prototype;b.doLoad=async function(){if(!this._drivenProperties.size){const a=Q.validateSymbolLayerSize(this.symbolLayer.size);if(a)throw new I("graphics3dtextsymbollayer:invalid-size",a);}await this._createTextRenderParameters()};b._createTextRenderParameters=async function(){this._textRenderParameters=await S.TextRenderParameters.fromSymbol(this.symbolLayer,
this._context.graphicsCoreOwner.view.state.rasterPixelRatio)};b.destroy=function(){q._get(q._getPrototypeOf(h.prototype),"destroy",this).call(this)};b.createGraphics3DGraphic=function(a){a=a.graphic;const c=v.placePointOnGeometry(a.geometry);if(e.isNone(c))return this.logger.warn(`unsupported geometry type for text symbol: ${a.geometry.type}`),null;const f=this.symbolLayer.text;if(e.isNone(f)||""===f)return null;var d=E.hasCalloutSupport(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:
null;if(e.isSome(d)&&!E.textSymbolLayerSupportsVerticalOffset(this.symbolLayer))return this.logger.errorOncePerTick("Callouts and vertical offset on text symbols are currently only supported with 'center' "+`horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;d=new L.CreateLabelParameters(d,this.symbolLayer.horizontalAlignment,r.verticalPlacementFromAlignment(this.symbolLayer.verticalAlignment));return this._createAs3DShape(a,c,f,d)};b.createLabel=function(a,
c,f,d){a=a.graphic;const k=v.placePointOnGeometry(a.geometry);if(e.isNone(k))return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;const l=c.text;return!l||/^\s+$/.test(l)?null:this._createAs3DShape(a,k,l,c,f,d)};b.setGraphicElevationContext=function(a,c,f=0){a=q._get(q._getPrototypeOf(h.prototype),"setGraphicElevationContext",this).call(this,a,c);a.addOffsetRenderUnits(f);return a};b.layerOpacityChanged=function(){this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer");
return!1};b.layerElevationInfoChanged=function(a,c){G(a,c,(f,d)=>{this.updateGraphicElevationContext(d,f)});return x.SymbolUpdateType.UPDATE};b.slicePlaneEnabledChanged=function(a,c){G(a,c,f=>{for(const d of f.stageObject.geometries)d.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})});return!0};b.physicalBasedRenderingChanged=function(){return!0};b.updateGraphicElevationContext=function(a,c){const f=c.elevationContext;this.setGraphicElevationContext(a,f,e.isSome(c.metadata)?
c.metadata.elevationOffset:0);c.needsElevationUpdates=x.needsElevationUpdates2D(f.mode)||"absolute-height"===f.mode};b._defaultElevationInfoNoZ=function(){return W};b._createAs3DShape=function(a,c,f,d,k,l){const w=this.setGraphicElevationContext(a,new N.ElevationContext,d.elevationOffset);var n="polyline"===e.get(a.geometry,"type"),t=a.uid;let p=null;a=null;if(e.isNone(l)){var g=r.textRenderAlignmentFromHorizontalPlacement(d.horizontalPlacement);p=new T(f,g,this._textRenderParameters);let m=null;
if(e.isSome(this._context.sharedResources.textures)){a=this._context.sharedResources.textures.fromData(p.key,()=>e.unwrap(p).create(),()=>{e.isSome(m)&&m.release()});g=this._context.stage.renderView.textureRepository.acquire(a.texture.id);if(e.isNone(g)||J.isPromiseLike(g))return a.release(),null;m=g}}g=U(p,d);g={occlusionTest:!0,screenOffset:d.screenOffset,anchorPosition:g,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:d.centerOffsetUnits,drawInSecondSlot:!0};e.isSome(l)?g.textureId=l.id:e.isSome(a)&&
(g.textureId=a.texture.id);if(e.isSome(d.verticalOffset)){const {screenLength:m,minWorldLength:B,maxWorldLength:H}=d.verticalOffset;g.verticalOffset={screenLength:K.pt2px(m),minWorldLength:B||0,maxWorldLength:e.isSome(H)?H:Infinity}}if(this._context.screenSizePerspectiveEnabled){const {screenSizePerspectiveSettings:m,screenSizePerspectiveSettingsLabels:B}=this._context.sharedResources;g.screenSizePerspective=B.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]);
g.screenSizePerspectiveAlignment=m}n&&(g.shaderPolygonOffset=1E-4);g.hasSlicePlane=this._context.slicePlaneEnabled;e.isSome(k)?(n=JSON.stringify(g),l=k.get(n),e.isNone(l)&&(l=new F.HUDMaterial(g),k.add(n,l))):l=new F.HUDMaterial(g);n=d.translation;g=e.isSome(p)?u.fromValues(p.displayWidth,p.displayHeight):u.ZEROS;n=R.createPointGeometry(l,V,n,null,g,d.centerOffset,[0,0],null);t=v.createStageObject(this._context,c,n,w,t);if(e.isNone(t))return null;k=new O.Graphics3DObject3DGraphicLayer(this,t.object,
[n],e.isNone(k)?[l]:null,a,M.perObjectElevationAligner,w);k.alignedSampledElevation=t.sampledElevation;k.needsElevationUpdates=x.needsElevationUpdates2D(w.mode)||"absolute-height"===w.mode;const {displayWidth:X,displayHeight:Y}=e.isSome(p)?p:d;k.getScreenSize=(m=u.create())=>{m[0]=X;m[1]=Y;return m};f=new P.Graphics3DObjectMetadata(d.elevationOffset,f);k.metadata=f;v.extendPointGraphicElevationContext(k,c,this._context.elevationProvider);return k};q._createClass(h,[{key:"pixelRatioChanged",get:function(){return D.__classPrivateFieldGet(this,
A,"f")},set:function(a){D.__classPrivateFieldSet(this,A,a,"f")}}]);return h}(y.Graphics3DSymbolLayer);var A=new WeakMap;const W={mode:"relative-to-ground",offset:0};C.Graphics3DTextSymbolLayer=y;Object.defineProperty(C,Symbol.toStringTag,{value:"Module"})});