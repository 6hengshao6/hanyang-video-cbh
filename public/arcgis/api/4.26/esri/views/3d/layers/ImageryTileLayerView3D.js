// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Error ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ./LayerView3D ./TiledLayerView3D ../terrain/RasterTile ../../layers/ImageryTileLayerView ../../layers/LayerView ../../layers/RefreshableLayerView ../../support/drapedUtils ../../webgl/capabilities".split(" "),
function(n,g,r,h,t,l,f,E,F,u,v,w,x,y,z,A,B,C){f=function(d){function k(){var a=D.apply(this,arguments);a.type="imagery-tile-3d";a.isAlignedMapTile=!0;return a}n._inherits(k,d);var D=n._createSuper(k);d=k.prototype;d.initialize=function(){this.layer.increaseRasterJobHandlerUsage();null==this.fullExtent&&this.addResolvingPromise(Promise.reject(new r("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const a=t.whenOnce(()=>
this.view?.basemapTerrain?.tilingSchemeLocked).then(()=>{const b=this.view.basemapTerrain.tilingScheme,e=this.layer.tileInfo,c=["png","png24","png32","jpg","mixed"].includes(e.format)&&b.compatibleWith(e);this.tileInfo=(this.isAlignedMapTile=c)?e:b.toTileInfo();this.updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(a)};
d.destroy=function(){this.layer.decreaseRasterJobHandlerUsage();this.view=null};d._getfullExtent=function(){return this.projectFullExtent(this.view.basemapTerrain&&h.isSome(this.view.basemapTerrain.spatialReference)?this.view.basemapTerrain.spatialReference:this.view.spatialReference)};d.fetchTile=async function(a,b,e,c){const p=this.tileInfo,q=this._canSymbolizeInWebGL();c={tileInfo:p,requestRawData:q,signal:h.unwrap(c.signal),timeExtent:this.timeExtent,requestAsImageElement:this.isAlignedMapTile};
c=await this.layer.fetchTile(a,b,e,c);if(c instanceof HTMLImageElement)return c;let m=c&&c.pixelBlock;if(h.isNone(m)||!q&&(m=await this.layer.applyRenderer(c),h.isNone(m)))return this._blankTile;b=new x.RasterTile([a,b,e],m,p.size[0],p.size[1]);q?(b.symbolizerRenderer=this.layer.symbolizer.rendererJSON,b.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(a)),b.transformGrid=c.transformGrid):b.isRendereredSource=!0;b.interpolation=this.layer.interpolation;
b.bandIds=this.layer.bandIds;return b};d._getSymbolizerOptions=function(a){a=this.tileInfo.lodAt(a).resolution;return{pixelBlock:null,isGCS:this.view.basemapTerrain&&h.isSome(this.view.basemapTerrain.spatialReference)?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:a,y:a},bandIds:this.layer.bandIds}};d.ensureSymbolizerParameters=function(a){this._canSymbolizeInWebGL()&&JSON.stringify(a.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&
(a.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(a.lij[0])))};d.createFetchPopupFeaturesQueryGeometry=function(a,b){return B.createQueryGeometry(a,b,this.view)};d.refresh=function(){this.emit("data-changed")};d.doRefresh=async function(){this.suspended||this.emit("data-changed")};d._canSymbolizeInWebGL=function(){return C.getWebGLCapabilities("3d").supportsTextureFloat&&this.layer.symbolizer.canRenderInWebGL};n._createClass(k,[{key:"_blankTile",get:function(){const a=
document.createElement("canvas"),b=a.getContext("2d"),[e,c]=this.tileInfo.size;a.width=e;a.height=c;b.clearRect(0,0,e,c);return b.getImageData(0,0,e,c)}},{key:"imageFormatIsOpaque",get:function(){return"jpg"===this.layer.tileInfo.format}},{key:"hasMixedImageFormats",get:function(){return"mixed"===this.layer.tileInfo.format}},{key:"dataLevelRange",get:function(){const a=this.layer.tileInfo.lods;return this.levelRangeFromScaleRange(this.tileInfo.lods[0].scale,a[a.length-1].scale)}}]);return k}(y(A(w.TiledLayerView3D(v.LayerView3D(z)))));
g.__decorate([l.property({readOnly:!0})],f.prototype,"_blankTile",null);g.__decorate([l.property({readOnly:!0})],f.prototype,"imageFormatIsOpaque",null);g.__decorate([l.property({readOnly:!0})],f.prototype,"hasMixedImageFormats",null);g.__decorate([l.property({readOnly:!0})],f.prototype,"dataLevelRange",null);return f=g.__decorate([u.subclass("esri.views.3d.layers.ImageryTileLayerView3D")],f)});