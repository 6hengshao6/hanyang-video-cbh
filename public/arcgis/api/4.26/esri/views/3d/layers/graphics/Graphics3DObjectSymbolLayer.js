// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../core/has ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/typedArrayUtil ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../symbols/support/symbolLayerUtils3D ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./Loadable ./lodResourceUtils ./objectResourceUtils ./pointUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(V,x,W,Q,X,h,ha,Y,Z,I,aa,u,m,C,ba,w,ia,J,ja,K,ka,la,R,F,L,ma,na,oa,M,ca,pa,B,N,qa,ra,y,sa){let da=x._createClass(function(k,z,S,a,b,c,d,f,e,l,g,q){this.lodResources=k;this.lodRenderer=z;this.stageResources=S;this.originalMaterialParameters=a;this.resourceSize=b;this.isEsriSymbolResource=c;this.isWosr=d;this.resourceBoundingBox=f;this.symbolSize=e;this.extentPadding=l;this.physicalBasedRenderingEnabled=g;this.pivotOffset=q});R=function(k){function z(a,b,c,d){a=S.call(this,a,b,c,d);a._resources=
null;a._optionalFields=[];a._instanceIndexToGraphicUid=new Map;a._hasLoadedPBRTextures=!1;a._disposeResourceHandles=[];T.set(x._assertThisInitialized(a),!1);a.ensureDrapedStatus(!1);a._hasLoadedPBRTextures=c.physicalBasedRenderingEnabled;return a}x._inherits(z,k);var S=x._createSuper(z);k=z.prototype;k.getCachedSize=function(){const [a,b,c]=h.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:a,depth:b,height:c}};k.doLoad=async function(a){if(!this._drivenProperties.size&&F.validateSymbolLayerSize(this.symbolLayer))throw Error();
var b=this.symbolLayer.resource;this._isPrimitive?(b=b&&ca.isValidPrimitive(b.primitive)?b.primitive:ia.defaultPrimitive,this._resources=await this._createResourcesForPrimitive(b,a)):this._resources=await this._createResourcesForUrl(b.href,a);this.layerOpacityChanged();this.slicePlaneEnabledChanged();this.physicalBasedRenderingChanged();this.complexity=this.computeComplexity()};k._setMaterialTransparencyParams=function(a,b=h.get(this.symbolLayer,"material","color")){b=this._getCombinedOpacity(b);
const c=1>b||this.needsDrivenTransparentPass;a.transparent=c;a.opacity=b;a.cullFace=c?N.CullFaceOptions.None:N.CullFaceOptions.Back;return a};k._createResourcesForPrimitive=async function(a,b){var c=this.symbolLayer;const d=w.create(J.objectSymbolLayerPrimitiveBoundingBox(a)),f=m.fromArray(w.size(d)),e=m.fromArray(J.objectSymbolLayerSizeWithResourceSize(f,c)),l=u.length(e);var g={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:m.ONES,diffuse:m.ONES,hasSlicePlane:this._context.slicePlaneEnabled,
hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive};const q=!!g.usePBR;this._setMaterialTransparencyParams(g);const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const {screenLength:p,minWorldLength:v,maxWorldLength:t}=n.verticalOffset;g.verticalOffset={screenLength:Y.pt2px(p),minWorldLength:v||0,maxWorldLength:h.isSome(t)?t:Infinity};g.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(g.screenSizePerspective=
this._context.sharedResources.screenSizePerspectiveSettings);this._drivenProperties.color?g.externalColor=C.ONES:(c=h.isSome(c.material)?c.material.color:null,c=h.isSome(c)?Q.toUnitRGBA(c):C.ONES,g.externalColor=c);this._fastUpdates=B.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(d,e,f,h.none));g.isInstanced=!0;this._fastUpdates?(Object.assign(g,this._fastUpdates.materialParameters),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&
(g.hasInstancedColor=!0,this._optionalFields.push("color"));X("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push("objectAndLayerIdColor");g=new sa.DefaultMaterial(g);g=ca.primitiveLodResources(a,g);if(!g)throw Error(`Unknown object symbol primitive: ${a}`);a=y.materialsFromLodResources(g).map(p=>({opacity:1,transparent:p.parameters.transparent}));c=await this._createStageResources(g,q,b);b=await this._createLodRenderer(g,b);return new da(g,b,c,a,f,!1,!1,d,e,l,q,h.none)};k._createResourcesForUrl=
async function(a,b){var c={materialParamsMixin:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};(this._fastUpdates=B.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(h.none,h.none,h.none,h.none)))?(Object.assign(c.materialParamsMixin,this._fastUpdates.materialParameters),this._optionalFields.push("featureAttribute")):
this._hasPerInstanceColor()&&(c.materialParamsMixin.hasInstancedColor=!0,this._optionalFields.push("color"));X("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push("objectAndLayerIdColor");var d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const {screenLength:r,minWorldLength:D,maxWorldLength:G}=d.verticalOffset;c.materialParamsMixin.verticalOffset={screenLength:Y.pt2px(r),minWorldLength:D||0,maxWorldLength:h.isSome(G)?G:Infinity};c.materialParamsMixin.castShadows=!1}c.signal=
b;c.usePBR=this._context.physicalBasedRenderingEnabled;c.skipHighLods=this._context.skipHighSymbolLods;d=c.usePBR;var f=await oa.fetch(a,c);a=f.isEsriSymbolResource;c=f.isWosr;const e=na.makeLodResources(f.lods);e.levels.sort((r,D)=>r.minScreenSpaceRadius-D.minScreenSpaceRadius);const l=this._context,g=this._getExternalColorParameters(this.symbolLayer.material);var q=h.get(this.symbolLayer,"material","color");const n=this._getCombinedOpacity(q,{hasIntrinsicColor:!0}),p=this.needsDrivenTransparentPass;
var v=y.materialsFromLodResources(e);q=y.materialsFromLodResources(e).map(r=>({opacity:r.parameters.opacity||1,transparent:r.parameters.transparent}));v.forEach(r=>{const D=r.parameters;r.setParameters(g);const G=D.opacity*n;r.setParameters({opacity:G,transparent:1>G||p||D.transparent});l.screenSizePerspectiveEnabled&&r.setParameters({screenSizePerspective:l.sharedResources.screenSizePerspectiveSettings})});f=f.referenceBoundingBox;const t=m.fromArray(w.size(f)),A=m.fromArray(e.levels[0].pivotOffset),
H=m.fromArray(J.objectSymbolLayerSizeWithResourceSize(t,this.symbolLayer)),ta=u.length(H),ea=this._fastUpdates;B.updateFastSymbolUpdatesState(ea,this._context.renderer,this._fastVisualVariableConvertOptions(f,H,t,A))&&v.forEach(r=>r.setParameters(ea.materialParameters));v=await this._createStageResources(e,d,b);b=await this._createLodRenderer(e,b);return new da(e,b,v,q,t,a,c,f,H,ta,d,A)};k._addDisposeResource=function(a){this._disposeResourceHandles.push(a)};k._createStageResources=async function(a,
b,c){const d=this._context.stage,f=y.materialsFromLodResources(a);b!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();d.addMany(f);this._addDisposeResource(()=>d.removeMany(f));const e=y.texturesFromLodResources(a);d.addMany(e);this._addDisposeResource(()=>d.removeMany(e));await d.load(e,c);ha.throwIfAborted(c);const l=y.geometriesFromLodResources(a);d.addMany(l);this._addDisposeResource(()=>d.removeMany(l));return{materials:f,textures:e,geometries:l}};k._createLodRenderer=
async function(a,b){const c=this._context.stage,d=this._fastUpdates,f=new ra.LodRenderer({symbol:a,optionalFields:this._optionalFields,metadata:{layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},shaderTransformation:d?{applyTransform:(e,
l,g)=>{e.getFeatureAttribute(l,O);I.copy(g,B.evaluateModelTransform(d.materialParameters,O,g))},scaleFactor:(e,l,g)=>{l.getFeatureAttribute(g,O);B.evaluateModelTransformScale(e,d.materialParameters,O)}}:null},this._context.scheduler);f.slicePlaneEnabled=this._context.slicePlaneEnabled;this._addDisposeResource(()=>{c.removeRenderPlugin(f);f.destroy()});await c.addRenderPlugin(f.slots,f,b);return f};k._getExternalColorParameters=function(a){const b={};this._drivenProperties.color?b.externalColor=C.ONES:
h.isSome(a)&&h.isSome(a.color)?b.externalColor=Q.toUnitRGBA(a.color):(b.externalColor=C.ONES,b.colorMixMode="ignore");return b};k.destroy=function(){x._get(x._getPrototypeOf(z.prototype),"destroy",this).call(this);this._cleanupResources()};k._cleanupResources=function(){this._disposeResourceHandles.forEach(a=>a());this._disposeResourceHandles.length=0;this._resources=null};k.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry))return null;const c=M.placePointOnGeometry(b.geometry);
if(h.isNone(c))return this.logger.warn(`unsupported geometry type for icon symbol: ${b.geometry.type}`),null;const d=this.setGraphicElevationContext(b,new ka.ElevationContext);return this._createAs3DShape(b,c,a.renderingInfo,d,b.uid,a.layer.uid)};k.notifyDestroyGraphicLayer=function(a){this._instanceIndexToGraphicUid.delete(a.instanceIndex)};k.graphicLayerToGraphicId=function(){return 0};k.layerOpacityChanged=function(){if(!h.isNone(this._resources)){var a=this._drivenProperties.opacity,b=!this._isPrimitive,
c=this._resources.stageResources.materials,d=this._resources.originalMaterialParameters;for(let l=0;l<c.length;l++){const g=c[l];var f=h.get(this.symbolLayer,"material","color"),e=d[l];f=this._getCombinedOpacity(f,{hasIntrinsicColor:b})*e.opacity;e=1>f||a||e.transparent;g.setParameters({opacity:f,transparent:e});this._isPrimitive&&g.setParameters({cullFace:e?N.CullFaceOptions.None:N.CullFaceOptions.Back})}}};k.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,
b,K.needsElevationUpdates3D)};k.slicePlaneEnabledChanged=function(){if(h.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const a of this._resources.stageResources.materials)a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};k.physicalBasedRenderingChanged=function(){if(h.isNone(this._resources))return!0;const {stageResources:a,isWosr:b}=this._resources;for(const c of a.materials)this._isPrimitive?c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,
isSchematic:!0}):b||c.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1===this._hasLoadedPBRTextures&&!0===this._context.physicalBasedRenderingEnabled?(this._hasLoadedPBRTextures=!0,!1):!0};k.applyRendererDiff=function(a,b){if(h.isNone(this._resources))return L.ApplyRendererDiffResult.Recreate_Symbol;const {stageResources:{materials:c},lodRenderer:d,resourceBoundingBox:f,symbolSize:e,resourceSize:l,pivotOffset:g}=this._resources;for(const q in a.diff)switch(q){case "visualVariables":if(B.updateFastSymbolUpdatesState(this._fastUpdates,
b,this._fastVisualVariableConvertOptions(f,e,l,g))){for(const n of c)n.setParameters(this._fastUpdates.materialParameters);d.notifyShaderTransformationChanged()}else return L.ApplyRendererDiffResult.Recreate_Symbol;break;default:return L.ApplyRendererDiffResult.Recreate_Symbol}return L.ApplyRendererDiffResult.Fast_Update};k.computeComplexity=function(){if(h.isNone(this._resources))return x._get(x._getPrototypeOf(z.prototype),"computeComplexity",this).call(this);var a=this._resources.lodResources;
const b=y.geometriesFromLodLevelResources(a.levels[0]).reduce((f,e)=>f+e.indices.get(qa.VertexAttribute.POSITION).length,0)/3,c=f=>Array.from(f.vertexAttributes.values()).reduce((e,l)=>e+Z.estimateSize(l.data),0)+Array.from(f.indices.values()).reduce((e,l)=>e+Z.estimateSize(l),0);var d=y.texturesFromLodResources(a).reduce((f,e)=>f+(e.params.encoding&&"image/ktx2"===e.params.encoding?e.estimatedTexMemRequired:e.estimatedTexMemRequired/4),0);a=y.geometriesFromLodResources(a).reduce((f,e)=>f+c(e),0);
d+=a;d={...pa.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer),resourceBytes:d};return{primitivesPerFeature:b,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:d}};k._hasLodRenderer=function(){return h.isSome(this._resources)};k._createAs3DShape=function(a,b,c,d,f,e){if(!this._hasLodRenderer()||h.isNone(this._resources))return null;a=this.getFastUpdateAttrValues(a);const l=null==this._fastUpdates&&this._hasPerInstanceColor()?F.mixinColorAndOpacity(c.color,c.opacity):
null;var g=this._context.clippingExtent;ba.projectPointToVector(b,E,this._context.elevationProvider.spatialReference);if(h.isSome(g)&&!w.containsPoint(g,E))return null;g=this._requiresTerrainElevation(d);const q=this._computeGlobalTransform(b,d,U,P);c=this._computeLocalTransform(this._resources,this.symbolLayer,c,fa);const n=this._resources.lodRenderer.instanceData,p=n.addInstance();this._instanceIndexToGraphicUid.set(p,f);n.setLocalTransform(p,c,!1);n.setGlobalTransform(p,q);a&&n.setFeatureAttribute(p,
a);l&&n.setColor(p,l);h.isSome(this._context.stage.renderView.objectAndLayerIdRenderHelper)&&n.setObjectAndLayerIdColor(p,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:f,layerUid:e}));f=new la(this,p,ja.perLodInstanceElevationAligner,d);g&&(f.alignedSampledElevation=P.sampledElevation);f.needsElevationUpdates=K.needsElevationUpdates3D(d.mode);M.extendPointGraphicElevationContext(f,b,this._context.elevationProvider);return f};k._computeGlobalTransform=
function(a,b,c,d){K.evaluateElevationInfoAtPoint(a,this._context.elevationProvider,b,this._context.renderCoordsHelper,d);E[0]=a.x;E[1]=a.y;E[2]=d.z;ba.computeTranslationToOriginAndRotation(a.spatialReference,E,c,this._context.renderCoordsHelper.spatialReference);return c};k._computeLocalTransform=function(a,b,c,d){I.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(b,!0,d);this._applyObjectScale(a,c,d);this._applyAnchor(a,b,d);return d};k._applyObjectScale=function(a,b,c){this._fastUpdates?.requiresShaderTransformation||
(a=F.computeObjectScale(this._drivenProperties.size&&b.size?b.size:a.symbolSize,a.symbolSize,a.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===a[0]&&1===a[1]&&1===a[2]||I.scale(c,c,a))};k.prepareSymbolLayerPatch=function(a){if("partial"===a.diff.type){var b=a.diff.diff;this._preparePatchTransform(a,b);this._preparePatchColor(a,b)}};k.updateGeometry=function(a,b){if(h.isNone(this._resources))return!0;const c=b&&M.placePointOnGeometry(b);if(h.isNone(c))return!1;b=this.getGeometryElevationMode(b);
if(a.elevationContext.mode!==b)return!1;this._computeGlobalTransform(c,a.elevationContext,U,P);this._requiresTerrainElevation(a.elevationContext)&&(a.alignedSampledElevation=P.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(a.instanceIndex,U,!0);M.extendPointGraphicElevationContext(a,c,this._context.elevationProvider);return!0};k._preparePatchTransform=function(a,b){if((b.heading||b.tilt||b.roll||b.width||b.height||b.depth||b.anchor||b.anchorPosition)&&!h.isNone(this._resources)){var c=
(t,A,H)=>h.unwrapOr(null!=t&&"complete"===t.type?t.newValue:A,H),d=c(b.heading,this.symbolLayer.heading,0),f=c(b.tilt,this.symbolLayer.tilt,0),e=c(b.roll,this.symbolLayer.roll,0),l=c(b.width,this.symbolLayer.width,void 0),g=c(b.height,this.symbolLayer.height,void 0),q=c(b.depth,this.symbolLayer.depth,void 0),n=c(b.anchor,this.symbolLayer.anchor,void 0);c=c(b.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete b.heading;delete b.tilt;delete b.roll;delete b.width;delete b.height;delete b.depth;
delete b.anchor;delete b.anchorPosition;var p={heading:d,tilt:f,roll:e,anchor:n,anchorPosition:c},v=this._resources;this.loadStatus===ma.LoadStatus.LOADED&&a.symbolLayerStatePatches.push(()=>{v.symbolSize=m.fromArray(J.objectSymbolLayerSizeWithResourceSize(v.resourceSize,{width:l,height:g,depth:q,isPrimitive:this.symbolLayer.isPrimitive}))});a.graphics3DGraphicPatches.push((t,A)=>{A=this._computeLocalTransform(v,p,A,fa);v.lodRenderer.instanceData.setLocalTransform(t.instanceIndex,A,!0)})}};k._preparePatchColor=
function(a,b){if(b.material&&"partial"===b.material.type&&(b=b.material.diff,b.color&&"complete"===b.color.type&&null!=b.color.newValue&&null!=b.color.oldValue)){var c=b.color.newValue,d=h.isSome(c)?Q.toUnitRGBA(c):C.ONES;delete b.color;var f=this._resources;h.isNone(f)||a.graphics3DGraphicPatches.push(e=>{this._hasPerInstanceColor()?(f.lodRenderer.instanceData.setColor(e.instanceIndex,d),e=this._setMaterialTransparencyParams({},c)):e=this._setMaterialTransparencyParams({externalColor:d},c);for(const l of f.stageResources.materials)l.setParameters(e)})}};
k._requiresTerrainElevation=function(a){return"absolute-height"!==a.mode};k._applyObjectRotation=function(a,b,c){if(!this._fastUpdates?.requiresShaderTransformation||!b)return F.computeObjectRotation(a.heading,a.tilt,a.roll,c)};k._computeAnchor=function(a,b,c){const d=m.create();switch(c.anchor){case "center":u.copy(d,w.center(a));u.negate(d,d);break;case "top":b=w.center(a);u.set(d,-b[0],-b[1],-a[5]);break;case "bottom":b=w.center(a);u.set(d,-b[0],-b[1],-a[2]);break;case "relative":b=w.center(a);
a=w.size(a);c=(c=c.anchorPosition)?m.fromValues(c.x,c.y,c.z):m.ZEROS;u.multiply(d,a,c);u.add(d,d,b);u.negate(d,d);break;default:h.isSome(b)?u.negate(d,b):u.copy(d,m.ZEROS)}return d};k._applyAnchor=function(a,b,c){this._fastUpdates?.requiresShaderTransformation||(a=this._computeAnchor(a.resourceBoundingBox,a.pivotOffset,b))&&I.translate(c,c,a)};k._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity};k._fastVisualVariableConvertOptions=function(a,b,c,d){const f=
h.isSome(a)?m.fromArray(w.size(a)):m.ONES;a=h.isSome(a)?this._computeAnchor(a,d,this.symbolLayer):m.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;c=F.computeObjectScale(h.isSome(b)?b:void 0,b,c,d);const e=m.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new B.ConvertOptions(f,h.unwrapOr(b,m.ONES),d,a,c,e)};x._createClass(z,[{key:"extentPadding",get:function(){return h.isSome(this._resources)?this._resources.extentPadding:0}},{key:"_isPrimitive",
get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}},{key:"lodRenderer",get:function(){return h.isSome(this._resources)?this._resources.lodRenderer:null}},{key:"skipHighSymbolLodsChanged",get:function(){return W.__classPrivateFieldGet(this,T,"f")},set:function(a){W.__classPrivateFieldSet(this,T,a,"f")}}]);return z}(R.Graphics3DSymbolLayer);var T=new WeakMap;const E=m.create(),fa=aa.create(),U=aa.create(),O=C.create(),P=new K.SampleElevationInfo;V.Graphics3DObjectSymbolLayer=
R;Object.defineProperty(V,Symbol.toStringTag,{value:"Module"})});