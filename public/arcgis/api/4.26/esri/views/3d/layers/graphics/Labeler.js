// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../layers/graphics/hydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../symbols/callouts/calloutUtils ./CreateLabelParameters ./enums ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DLineCalloutSymbolLayer ./graphicSymbolUtils ./labelPlacement ./placementUtils ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler".split(" "),
function(r,v,x,M,E,N,F,O,k,u,G,A,ea,fa,ha,P,Q,R,S,T,q,U,H,V,W,B,I,X,Y,Z,aa,J){function y(d){return!0===d.labelsVisible&&!!d.labelingInfo?.some(n=>!!n.symbol)}let K=v._createClass(function(d,n){this.labelingContext=d;this.graphics3DGraphic=n;this.textInitialized=this.rendered=this.visible=this.hasGraphics3DResources=!1;this.textRenderers=[];this.textLabelPlacements=[]}),ba=v._createClass(function(d,n,z,a,b){this.labelClass=d;this.graphics3DSymbol=n;this.graphics3DCalloutSymbolLayer=z;this.textRenderParameters=
a;this.labelFunction=b;this.calloutSymbolLayerIndex=0}),ca=v._createClass(function(d,n,z,a,b,c,e){this.layer=d;this.graphics3DCore=n;this.scaleVisibility=z;this.emptySymbolLabelSupported=a;this.elevationInfoOverride=b;this.disablePlacement=c;this.active=e;this.labelClassAbortController=new AbortController;this.labelClassContexts=[];this.graphics=new Map;this.labelsToInitialize=new Map;this.stageLayer=new aa.WebGLLayer({pickable:!0,disableOctree:!0},d.uid)});r.Labeler=function(d){function n(a){a=z.call(this,
a);a._dirty=!1;a._labels=new Map;a._labelsToAdd=new Map;a._labelsToRemove=new Map;a._labelingContexts=[];return a}v._inherits(n,d);var z=v._createSuper(n);d=n.prototype;d.setup=function(){this.dispose();this._handles=new N;this._handles.add([G.watch(()=>this.view.state?.camera,()=>this.setDirty()),G.watch(()=>this.view.state?.rasterPixelRatio,()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(J.TaskPriority.LABELER,this)]);this._textTextureAtlas=new Z.TextTextureAtlas({view:this.view});
this._hudMaterialCollection=new I.MaterialCollection(this.view._stage);this._calloutMaterialCollection=new I.MaterialCollection(this.view._stage)};d.dispose=function(){this._handles=k.destroyMaybe(this._handles);this._textTextureAtlas=k.disposeMaybe(this._textTextureAtlas);this._hudMaterialCollection=k.disposeMaybe(this._hudMaterialCollection);this._calloutMaterialCollection=k.disposeMaybe(this._calloutMaterialCollection);this._labelingContexts.length=0;this._labels.clear();this._labelsToAdd.clear();
this._labelsToRemove.clear()};d._activateLabelingContext=function(a){a.graphics.forEach((b,c)=>{const e=new K(a,b);this._labels.set(c,e);a.labelsToInitialize.set(c,e);b.setVisibilityFlag(q.VisibilityFlag.USER_SETTING,!0,q.VisibilityGroup.LABEL)});a.active=!0};d._deactivateLabelingContext=function(a){a.graphics.forEach((b,c)=>{b.setVisibilityFlag(q.VisibilityFlag.USER_SETTING,!1,q.VisibilityGroup.LABEL);this.setLabelGraphicVisibility(b,!1);this._labels.delete(c)});a.active=!1};d._addLabelTextureToAtlas=
function(a){for(const b of a.graphics3DGraphic.labelLayers){if(!b._labelClass)continue;const c=a.textRenderers[b._labelIndex];k.isSome(c)&&this._textTextureAtlas.addTextTexture(c,b.stageObject)}a.rendered=!0};d._removeLabelTextureFromAtlas=function(a){for(const b of a.graphics3DGraphic.labelLayers){if(!b._labelClass)continue;const c=a.textRenderers[b._labelIndex];k.isSome(c)&&this._textTextureAtlas.removeTextTexture(c,b.stageObject)}a.rendered=!1};d.runTask=function(a){this._updateLabels(a);!this._dirty&&
this.deconflictor.running&&this.deconflictor.runTask(a);return J.Task.YIELD};d._updateLabels=function(a){if(this._dirty){this._dirty=!1;for(const b of this._labelingContexts)if(b.active){if(!b.labelClassContexts||!b.labelClassContexts.length){if(null===b.labelClassContexts){this._deactivateLabelingContext(b);continue}this._createLabelClassContext(b);if(b.labelClassPromise&&b.labelClassAbortController){this._dirty=!0;continue}if(!b.labelClassContexts||!b.labelClassContexts.length)continue}O.someMap(b.labelsToInitialize,
(c,e)=>{this._ensureGraphics3DResources(c)&&(this._labels.set(e,c),this.deconflictor.setDirty(),a.madeProgress());if(c.visible&&c.textInitialized||!c.visible&&c.hasGraphics3DResources)b.labelsToInitialize.delete(e),a.madeProgress();return a.done})&&(this._dirty=!0)}this._labelsToRemove.forEach(b=>this._removeLabelTextureFromAtlas(b));this._labelsToAdd.forEach(b=>this._addLabelTextureToAtlas(b));this._labelsToRemove.clear();this._labelsToAdd.clear();this._dirty||this.notifyChange("updating")}};d._createLabelClassContextAsync=
async function(a){const b=a.labelClassAbortController?.signal;await a.layer.when?.();u.throwIfAborted(b);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();const c=a.graphics3DCore;var e=c.layer;(e=e.labelingInfo&&e.labelingInfo.filter(f=>!!f.symbol))&&0!==e.length&&(await E.forEach(e,async(f,l)=>{var g=f.symbol;const h=V.getGraphics3DSymbol(c.getOrCreateGraphics3DSymbol(g));if(k.isNone(h))F.getLogger(this.declaredClass).error("Failed to create Graphics3DSymbol for label");else{await h.load();
u.throwIfAborted(b);var m=null;S.hasCalloutSupport(g)&&g.hasVisibleCallout()&&(m=U.make(g,c.symbolCreationContext),await m.load(),u.throwIfAborted(b));g=await E.result(R.createLabelFunction(f,a.layer.fieldsIndex,this.view.spatialReference));u.throwIfAborted(b);if(!0===g.ok){const p=await this._createTextRenderParameters(h.symbol);u.throwIfAborted(b);a.labelClassContexts[l]=new ba(f,h,m,p,g.value)}else F.getLogger(this.declaredClass).error(`Label expression failed to evaluate: ${g.error}`)}}),u.throwIfAborted(b))};
d._createLabelClassContext=async function(a){k.isNone(a.labelClassPromise)&&(a.labelClassPromise=this._createLabelClassContextAsync(a).catch(b=>{if(u.isAbortError(b))throw b;a.labelClassContexts.length=0}).then(()=>{a.labelClassAbortController=null;this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating"));return a.labelClassPromise};d._createTextRenderParameters=async function(a){return(a=a.symbolLayers.getItemAt(0))&&"text"===a.type?Y.TextRenderParameters.fromSymbol(a,this.view.state.rasterPixelRatio):
null};d._destroyLabelClassContext=function(a){for(var b of a.labelClassContexts)--b.graphics3DSymbol.referenced;b=a.labelClassAbortController;a.labelClassAbortController=new AbortController;k.abortMaybe(b);a.labelClassContexts.length=0;a.labelClassPromise=null;this.notifyChange("updating")};d._createTextSymbolGraphic=function(a,b,c,e,f){a=new T.CreateLabelParameters(c.verticalOffset,B.horizontalPlacementFromAnchor(c.anchor),B.verticalPlacementFromAnchor(c.anchor),a.text,c.translation,c.elevationOffset,
c.centerOffset,c.screenOffset,c.centerOffsetUnits,a.displayWidth,a.displayHeight);t.graphic=b;t.renderingInfo=null;t.layer=e;return f.createLabel(t,a,this._hudMaterialCollection,this._textTextureAtlas)};d._createLineCalloutGraphic=function(a,b,c,e,f){t.graphic=a;t.layer=f;t.renderingInfo=new H.LineCalloutSymbolLayerRenderingInfo(null,b,e.translation,e.centerOffset,e.screenOffset,e.centerOffsetUnits,e.elevationOffset,this._calloutMaterialCollection);return c.createGraphics3DGraphic(t)};d._ensureGraphics3DResources=
function(a){if(a.hasGraphics3DResources)return!1;const b=a.graphics3DGraphic;if(b.destroyed)return!1;this._ensureTextTextureResources(a);const c=a.labelingContext,e=c.labelClassContexts;if(!e||0===e.length||!c.emptySymbolLabelSupported&&0===b.layers.length)return!1;var f=!1,l=b.graphic;const g=c.layer;var h=y(c.layer);const m=this.view._stage;for(let w=0;w<e.length;w++){const L=a.textRenderers[w],C=a.textLabelPlacements[w];if(k.isNone(L)||k.isNone(C))continue;const D=e[w];var p=D.graphics3DSymbol;
const da=p.symbol&&"label-3d"===p.symbol.type?p.symbol:null;if(p=p.symbolLayers[0]){p.setElevationInfoOverride(c.elevationInfoOverride);f=this._createTextSymbolGraphic(L,l,C,g,p);if(k.isNone(f))return!1;f._labelClass=D.labelClass;f._labelIndex=w;b.addLabelGraphic(f,m,c.stageLayer);b.setVisibilityFlag(q.VisibilityFlag.USER_SETTING,h,q.VisibilityGroup.LABEL);b.clearVisibilityFlag(q.VisibilityFlag.SCALE_RANGE,q.VisibilityGroup.LABEL);b.setVisibilityFlag(q.VisibilityFlag.DECONFLICTION,!1,q.VisibilityGroup.LABEL);
f=!0;(h=D.graphics3DCalloutSymbolLayer)&&C.hasLabelVerticalOffset&&(h.setElevationInfoOverride(c.elevationInfoOverride),l=this._createLineCalloutGraphic(l,da,h,C,g),k.isSome(l)&&(D.calloutSymbolLayerIndex=b.labelLayers.length,b.addLabelGraphic(l,m,c.stageLayer)));break}}c.scaleVisibility&&f&&c.scaleVisibility.updateGraphicLabelScaleVisibility(b);return a.hasGraphics3DResources=!0};d._destroyGraphics3DResources=function(a){const b=a.labelingContext.labelClassContexts;for(const c of a.graphics3DGraphic.labelLayers){if(null==
c._labelClass)continue;const e=b[c._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=e)e.onRemoveGraphic(c)}a.graphics3DGraphic.clearLabelGraphics();a.hasGraphics3DResources=!1};d._ensureTextTextureResources=function(a){if(!a.textInitialized){var b=a.labelingContext,c=b.labelClassContexts;if(c&&0!==c.length){var e=a.graphics3DGraphic.graphic;for(let g=0;g<c.length;g++){const h=c[g];a.textRenderers[g]=null;a.textLabelPlacements[g]=null;if(!h.textRenderParameters)continue;var f=h.labelFunction;
let m;if("arcade"===f.type)try{const p=f.needsHydrationToEvaluate()?Q.hydrateGraphic(e,b.layer):e;m=f.evaluate(p)}catch(p){m=null}else m=f.evaluate(e);if(!k.isNone(m)&&""!==m&&!/^\s+$/.test(m)&&(f=h.graphics3DSymbol,f.symbolLayers[0]&&(f=W.get({graphics3DGraphic:a.graphics3DGraphic,labelSymbol:"label-3d"===f.symbol?.type?f.symbol:null,labelClass:h.labelClass,disablePlacement:b.disablePlacement}),!k.isNone(f)))){var l=B.horizontalPlacementFromAnchor(f.anchor);l=B.textRenderAlignmentFromHorizontalPlacement(l);
a.textRenderers[g]=new X.TextRenderer(m,l,h.textRenderParameters);a.textLabelPlacements[g]=f}}a.textInitialized=!0}}};d._destroyTextTextureResources=function(a){a.textInitialized=!1;a.textRenderers.length=0;a.textLabelPlacements.length=0};d._addGraphic=function(a,b){const c=b.graphic.uid;a.graphics.set(c,b);a.active&&(b=new K(a,b),this._labels.set(c,b),a.labelsToInitialize.set(c,b));this.setDirty();this.deconflictor.setDirty()};d._removeGraphic=function(a,b){b=b.graphic.uid;const c=this._labels.get(b);
a.graphics.delete(b);c&&(this._destroyGraphic(c,b),a.labelsToInitialize.delete(b),this.setDirty(),this.deconflictor.setDirty())};d._destroyGraphic=function(a,b){this._labels.has(b)&&(this._labels.delete(b),this._labelsToAdd.delete(b),this._labelsToRemove.delete(b));a.textInitialized&&(this._removeLabelTextureFromAtlas(a),this._destroyTextTextureResources(a));a.hasGraphics3DResources&&this._destroyGraphics3DResources(a)};d._labelingInfoChange=async function(a,b){if(b)for(const c of b){if(b=a.graphics.get(c))this._removeGraphic(a,
b),this._addGraphic(a,b)}else return this._visibilityInfoChange(a),this._resetLabels(a),this._createLabelClassContext(a)};d._globalPropertyChanged=function(a,b){for(const c of b.labelClassContexts){const e=new Map;b.graphics.forEach(f=>e.set(f.graphic.uid,f));k.unwrap(c.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(a,e,f=>f.labelLayers[0]);c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(a,e,f=>f.labelLayers[c.calloutSymbolLayerIndex])}};d._visibilityInfoChange=
function(a){const b=y(a.layer);b&&!a.active&&this._activateLabelingContext(a);!b&&a.active&&this._deactivateLabelingContext(a);this.setDirty()};d._resetAllLabels=function(){for(const a of this._labelingContexts)this._resetLabels(a)};d._resetLabels=function(a){a.graphics.forEach((b,c)=>{if(b=this._labels.get(c))this._destroyGraphic(b,c),b.visible=!1,b.rendered=!1,a.labelsToInitialize.set(c,b)});this._destroyLabelClassContext(a);this.setDirty();this.deconflictor.setDirty()};d._findLabelingContext=function(a){for(const b of this._labelingContexts)if(b.graphics3DCore===
a)return b;return null};d.addGraphicsOwner=function(a,b,c){const e=c&&c.emptySymbolLabelSupported||!1,f=c&&c.elevationInfoOverride||null;c=c&&c.disablePlacement||null;if(!this._findLabelingContext(a)){var l=a.layer,g=new ca(l,a,b,e,f,c,y(l));this.view._stage.add(g.stageLayer);this._labelingContexts.push(g);this.setDirty();return{addGraphic:h=>this._addGraphic(g,h),removeGraphic:h=>this._removeGraphic(g,h),featureReductionChange:()=>{},layerLabelsEnabled:()=>y(g.layer),labelingInfoChange:h=>this._labelingInfoChange(g,
h),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",g),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",g),visibilityInfoChange:()=>this._visibilityInfoChange(g),reset:()=>this._resetLabels(g),clear:()=>{}}}};d.removeGraphicsOwner=function(a){const b=this._findLabelingContext(a);b&&(a=this._labelingContexts.indexOf(b),this._labelingContexts.splice(a,1),b.graphics.forEach(c=>this._removeGraphic(b,c)),this.view._stage.remove(b.stageLayer),this.setDirty())};
d.setLabelGraphicVisibility=function(a,b){a=a.graphic.uid;const c=this._labels.get(a);c&&c.visible!==b&&(b&&!c.rendered?(this._labelsToAdd.set(a,c),this._labelsToRemove.delete(a),c.textInitialized||c.labelingContext.labelsToInitialize.set(a,c)):!b&&c.rendered&&(this._labelsToRemove.set(a,c),this._labelsToAdd.delete(a)),c.visible=b,this.setDirty())};d.setDirty=function(){!this._dirty&&0<this._labelingContexts.length&&(this._dirty=!0,this.notifyChange("updating"))};v._createClass(n,[{key:"running",
get:function(){return this.view.ready&&(this._dirty||this.deconflictor.running)}},{key:"updating",get:function(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(a=>!!a.labelClassPromise&&!!a.labelClassAbortController)}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const a=0<this._labelingContexts.length?this._labelingContexts.reduce((b,c)=>b+(c.labelClassPromise&&c.labelClassAbortController?
0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*a+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}}]);return n}(M);x.__decorate([A.property({constructOnly:!0})],r.Labeler.prototype,"view",void 0);x.__decorate([A.property({constructOnly:!0})],r.Labeler.prototype,"deconflictor",void 0);x.__decorate([A.property()],r.Labeler.prototype,
"_textTextureAtlas",void 0);x.__decorate([A.property({type:Boolean,readOnly:!0})],r.Labeler.prototype,"updating",null);r.Labeler=x.__decorate([P.subclass("esri.views.3d.layers.graphics.Labeler")],r.Labeler);const t=new H.LineCalloutCreationContext(null,null,null);r.areLabelsVisible=y;Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});