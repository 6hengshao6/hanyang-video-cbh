// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../symbols ../../../../core/asyncUtils ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec3f64 ../../../../chunks/vec4f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../support/arcadeOnDemand ../../../../symbols/support/IconSymbol3DLayerResource ../../../../symbols/support/utils ../../../2d/arcade/callExpressionWithFeature ./constants ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./placementUtils ./pointUtils ../support/FastSymbolUpdates ../../support/engineContent/sdfPrimitives ../../terrain/OverlayRenderer ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial ../../../../symbols/CIMSymbol".split(" "),
function(N,H,r,O,v,P,I,k,A,w,Q,R,z,B,J,S,T,U,V,W,X,Y,Z,t,aa,ba,ca,x,da,C,D,E,y,F,ea,fa,K,ha,ia,L,ja){function G(e){return k.isNone(e)?!1:"cross"===e||"x"===e}const ka=R.create(),M=B.fromValues(0,0,1);v=F.DEFAULT_TEX_SIZE;const u=F.DEFAULT_SYMBOL_SIZE_RATIO,la=[u/2,u/2,1-u/2,1-u/2];v=[v*u,v*u];x=function(e){function q(a,c,b,d){a=ma.call(this,a,c,b,d);a._cimLayers=null;a._cimSymbolMaterials=new Map;a._cimSymbolTextures=new Map;a._cimMaterialParametersInfo=null;a._cimRequiredFields=null;a._cimScaleFactorOrFunction=
null;a._size=null;a._symbolTextureRatio=1;a._outlineSize=0;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0};return a}r._inherits(q,e);var ma=r._createSuper(q);e=q.prototype;e.getCachedSize=function(){return{size:this._getIconSize()}};e.doLoad=async function(a){this._validateOrThrow();const c=this._prepareMaterialParameters();var b=this._getPrimitive();if(k.isSome(b))this._prepareResourcesPrimitive(c,b);else{b=W.getIconHref(this.symbolLayer);const d=Q.dataComponents(b);d&&"application/json"===
d.mediaType?await this._prepareResourcesCIM(c,JSON.parse(d.data),a):await this._prepareResourcesHref(c,b,a)}};e._validateOrThrow=function(){if(!this._drivenProperties.size){var a=da.validateSymbolLayerSize(this._getIconSize());if(a)throw new I("graphics3diconsymbollayer:invalid-size",a);}};e._getIconSize=function(){var a=this.symbolLayer;a=Math.round(null!=a.size?w.pt2px(a.size):16);return this._drivenProperties.size?Math.max(a,64):a};e._generateTextureCIM=function(a){const c=this._getGraphicHash(a);
let b=""===c?null:this._cimSymbolTextures.get(c);b||(a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,a,"esriGeometryPoint",{scaleFactor:this._cimScaleFactorOrFunction},void 0,void 0),this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",a.anchorPosition),b=new ia.Texture(a.imageData,{width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:fa.PowerOfTwoResizeMode.PAD}),this._cimSymbolTextures.set(c,b),this._context.stage.add(b));
return b};e._computeSize=function(a,c){a=a.width/a.height;return 1<a?[c,Math.round(c/a)]:[Math.round(c*a),c]};e._prepareMaterialParameters=function(){const a={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},c=this.symbol;if(c&&"point-3d"===c.type&&c.hasVisibleVerticalOffset()){const {screenLength:b,minWorldLength:d,maxWorldLength:f}=c.verticalOffset;a.verticalOffset={screenLength:w.pt2px(b),minWorldLength:d||0,maxWorldLength:k.isSome(f)?f:Infinity}}this._context.screenSizePerspectiveEnabled&&
(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);a.occlusionTest=!0;a.hasSlicePlane=this._context.slicePlaneEnabled;return a};e._prepareResourcesPrimitive=function(a,c){var b=this._getOutlineSize();if(G(c)&&0===b)throw Error("Nothing to render");this._outlineSize=b;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;k.isSome(this._context.sharedResources.textures)&&(b=this._context.sharedResources.textures.fromData(`${c}-icon`,
()=>F.createTexture(c)),this._texture=b.texture,this._releaseTexture=b,a.textureId=this._texture.id);a.textureIsSignedDistanceField=!0;a.distanceFieldBoundingBox=la;b=this._getIconSize();this._size=[b,b];this._symbolTextureRatio=1/u;this._createMaterialAndAddToStage(a,this._context.stage)};e._prepareResourcesHref=async function(a,c,b){this._outlineSize=this._getOutlineSize();a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;a.textureIsSignedDistanceField=
!1;const d=this._getIconSize(),f=d*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(k.isSome(this._context.sharedResources.textures)){b=await P.result(this._context.sharedResources.textures.fromUrl(c,f,{signal:b}));if(!1===b.ok)throw A.throwIfAbortError(b.error),new I("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${c})`);this._releaseTexture=b.value;c=b.value.texture;this._size=this._computeSize(c.params,d);a.textureId=c.id}this._createMaterialAndAddToStage(a,
this._context.stage)};e._prepareResourcesCIM=async function(a,c,b){c=new ja({data:c});if(!this._context.sharedResources.cimSymbolRasterizer){var d=(await new Promise((g,n)=>N(["../../../../symbols/cim/CIMSymbolRasterizer"],g,n))).CIMSymbolRasterizer;A.throwIfAborted(b);this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new d(this._context.renderCoordsHelper.spatialReference,!0))}d=this._context.layer.fields?this._context.layer.fields.map(g=>g.toJSON()):
null;this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(c,d,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:b});let f;if(this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression)if(c=this._context.renderer,isNaN(c.scaleExpression)){const g=await U.createRendererExpression(c.scaleExpression,this._context.layer.spatialReference,d);
f=(n,m,p)=>{n=X(g,n,{$view:p},"esriGeometryPoint",m);return null!==n?n:1}}else var h=Number(c.scaleExpression);this._cimScaleFactorOrFunction=h||f||1;h=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];A.throwIfAborted(b);const l=this._context.layer.fieldsIndex;this._cimRequiredFields=h.map(g=>l.get(g).name);this._cimMaterialParametersInfo=a;this._cimMaterialParametersInfo.color=this._getFillColor();this._cimMaterialParametersInfo.outlineColor=
[0,0,0,0];this._cimMaterialParametersInfo.outlineSize=0;this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1};e._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||V.defaultPrimitive};e._getOutlineSize=function(){var a=0;a=this.symbolLayer;if(k.isSome(a.outline)&&null!=a.outline.size)return Math.max(w.pt2px(a.outline.size),0);a=this._getPrimitive();a=G(a)?1.5:0;return Math.max(a,0)};
e._getOutlineColor=function(){const a=this._getLayerOpacity(),c=k.get(this.symbolLayer,"outline","color");if(k.isSome(c)){const b=O.toUnitRGB(c);return[b[0],b[1],b[2],c.a*a]}return[0,0,0,0]};e._getFillColor=function(){if(G(this._getPrimitive()))return Y.TRANSPARENT_UNIT;const a=k.isNone(this._getPrimitive()),c=k.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(c,{hasIntrinsicColor:a})};e._getAnchorPos=function(a,c){return"relative"===a?z.fromValues((c.x||0)+.5,-(c.y||
0)+.5):a in D.namedAnchorToHUDMaterialAnchorPos?D.namedAnchorToHUDMaterialAnchorPos[a]:D.namedAnchorToHUDMaterialAnchorPos.center};e._createMaterialAndAddToStage=function(a,c){(this._fastUpdates=this._cimLayers?null:y.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions()))&&Object.assign(a,this._fastUpdates.materialParameters);if(this._cimLayers){let b=k.isSome(a.textureId)?this._cimSymbolMaterials.get(a.textureId):null;b||(b=new L.HUDMaterial(a),this._cimSymbolMaterials.set(k.unwrapOr(a.textureId,
0),b),c.add(b));return b}this._material=new L.HUDMaterial(a);c.add(this._material);return this._material};e._setDrapingDependentMaterialParameters=function(){this.draped&&(this._forEachMaterial(a=>{a.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())};e.destroy=function(){r._get(r._getPrototypeOf(q.prototype),"destroy",this).call(this);this._forEachMaterial(a=>this._context.stage.remove(a));
this._material=null;this._cimSymbolMaterials.clear();this._cimSymbolTextures.forEach(a=>this._context.stage.remove(a));this._cimSymbolTextures.clear();this._releaseTexture=k.releaseMaybe(this._releaseTexture)};e._getScaleFactor=function(a,c){if(this._drivenProperties.size&&a.size){for(let b=0;3>b;b++){const d=a.size[b];d&&"symbol-value"!==d&&"proportional"!==d&&(a.size[b]=w.pt2px(d))}if("symbol-value"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/c;if(isFinite(+a.size[2]))return+a.size[2]/
c}return 1};e.createGraphics3DGraphic=function(a){const c=a.graphic;if(!this._validateGeometry(c.geometry))return null;var b=[0,0];let d;if(this._cimLayers){if(!this._cimLayers.length)return null;var f=this._generateTextureCIM(c);d=this._createMaterialAndAddToStage({textureId:f.id,...this._cimMaterialParametersInfo},this._context.stage);b=[f.params.width,f.params.height]}else b=this._size,d=k.unwrap(this._material);f=E.placePointOnGeometry(c.geometry);if(k.isNone(f))return this.logger.warn(`unsupported geometry type for icon symbol: ${c.geometry.type}`),
null;var h=a.renderingInfo;const l=this._getVertexOpacityAndColor(h);let g=1;this._fastUpdates?.visualVariables.size||(g=this._getScaleFactor(h,b[0]>b[1]?b[0]:b[1]));g*=this._symbolTextureRatio;b=z.fromValues(b[0]*g,b[1]*g);h=this.setGraphicElevationContext(c,new aa.ElevationContext);this.ensureDrapedStatus("on-the-ground"===h.mode)&&this._setDrapingDependentMaterialParameters();return this.draped?this._createAsOverlay(c,f,d,l,b,a.layer.uid):this._createAs3DShape(c,f,d,l,b,h,c.uid)};e.layerOpacityChanged=
function(){const a=this._getFillColor(),c=this._getOutlineColor();this._forEachMaterial(b=>{b.setParameters({color:a});b.setParameters({outlineColor:c})})};e.layerElevationInfoChanged=function(a,c,b){const d=this._elevationContext.mode;b=t.elevationModeChangeUpdateType(q.elevationModeChangeTypes,b,d);if(b!==t.SymbolUpdateType.UPDATE)return b;const f=t.needsElevationUpdates2D(d)||"absolute-height"===d;return this.updateGraphics3DGraphicElevationInfo(a,c,()=>f)};e.slicePlaneEnabledChanged=function(){this.draped||
this._forEachMaterial(a=>{a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})});return!0};e.physicalBasedRenderingChanged=function(){return!0};e.applyRendererDiff=function(a,c){for(const b in a.diff)switch(b){case "visualVariables":if(y.updateFastSymbolUpdatesState(this._fastUpdates,c,this._fastVisualVariableConvertOptions()))k.isSome(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters);else return C.ApplyRendererDiffResult.Recreate_Symbol;break;default:return C.ApplyRendererDiffResult.Recreate_Symbol}return C.ApplyRendererDiffResult.Fast_Update};
e._defaultElevationInfoNoZ=function(){return na};e._createAs3DShape=function(a,c,b,d,f,h,l){const g=this.getFastUpdateAttrValues(a);a=g&&this._fastUpdates?p=>y.evaluateModelTransform(this._fastUpdates.materialParameters,g,p):void 0;const n=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerUid:this._context.layer.uid});d=K.createPointGeometry(b,M,null,d,f,oa,null,g,n);l=E.createStageObject(this._context,c,d,h,l,a);if(k.isNone(l))return null;const m=new ca.Graphics3DObject3DGraphicLayer(this,
l.object,[d],null,null,Z.perObjectElevationAligner,h);m.alignedSampledElevation=l.sampledElevation;m.needsElevationUpdates=t.needsElevationUpdates2D(h.mode)||"absolute-height"===h.mode;m.getScreenSize=this._createScreenSizeGetter(f,a);m.calculateRelativeScreenBounds=p=>b.calculateRelativeScreenBounds(m.getScreenSize(),1,p);E.extendPointGraphicElevationContext(m,c,this._context.elevationProvider);return m};e._createAsOverlay=function(a,c,b,d,f,h){b.renderPriority=this._renderPriority;const l=J.create();
S.projectPointToVector(c,l,this._context.overlaySR);l[2]=ea.DRAPED_Z;c=this._context.clippingExtent;if(k.isSome(c)&&!T.containsPoint(c,l))return null;const g=this.getFastUpdateAttrValues(a);c=g&&this._fastUpdates?p=>y.evaluateModelTransform(this._fastUpdates.materialParameters,g,p):void 0;const n=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a.uid,layerUid:this._context.layer.uid});d=K.createPointGeometry(b,M,l,d,f,null,null,g,n);a=new ha.RenderGeometry(d,{layerUid:h,graphicUid:a.uid,
shaderTransformer:c});const m=new ba(this,[a],null,this._context.drapeSourceRenderer);m.getScreenSize=this._createScreenSizeGetter(f,c);m.calculateRelativeScreenBounds=p=>b.calculateRelativeScreenBounds(m.getScreenSize(),1,p);return m};e._createScreenSizeGetter=function(a,c){const b=this._outlineSize+2;if(this._fastUpdates&&c){const h=a[0]/this._symbolTextureRatio,l=a[1]/this._symbolTextureRatio;return(g=z.create())=>{const n=c(ka);g[0]=n[0]*h+b;g[1]=n[5]*l+b;return g}}const d=a[0]/this._symbolTextureRatio+
b,f=a[1]/this._symbolTextureRatio+b;return(h=z.create())=>{h[0]=d;h[1]=f;return h}};e._fastVisualVariableConvertOptions=function(){var a=Math.max(this._size[0],this._size[1]);const c=B.fromValues(a,a,a),b=w.px2pt(1);a*=b;a=B.fromValues(a,a,a);return new y.ConvertOptions(c,a,b)};e._getGraphicHash=function(a){let c="";for(const b of this._cimRequiredFields)c+=b+a.attributes[b];return c};e._forEachMaterial=function(a){k.isSome(this._material)&&a(this._material);this._cimSymbolMaterials.forEach(a)};e.test=
function(){return{...r._get(r._getPrototypeOf(q.prototype),"test",this).call(this),material:this._material}};r._createClass(q,[{key:"pixelRatioChanged",get:function(){return k.isSome(this._getPrimitive())}}]);return q}(x.Graphics3DSymbolLayer);x.PRIMITIVE_SIZE=v;x.elevationModeChangeTypes={definedChanged:t.SymbolUpdateType.UPDATE,staysOnTheGround:t.SymbolUpdateType.NONE,onTheGroundChanged:t.SymbolUpdateType.RECREATE};const na={mode:"relative-to-ground",offset:0},oa=J.fromValues(0,0,0,1);H.Graphics3DIconSymbolLayer=
x;Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});