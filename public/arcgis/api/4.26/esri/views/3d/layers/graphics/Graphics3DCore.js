// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../renderers/ClassBreaksRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/PieChartRenderer ../../../../renderers/Renderer ../../../../renderers/SimpleRenderer ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/jsonUtils ../../../../symbols ../../../../core/Accessor ../../../../core/has ../../../../core/Error ../../../../core/Handles ../../../../core/handleUtils ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./ElevationQuery ./enums ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphicCreationContext ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicStateTracking ./graphicUtils ./interfaces ./Loadable ./SpatialIndex2D ./symbolComplexity ../support/StageLayerElevationProvider ../../support/extentUtils ../../support/PropertiesPool ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/UpdatePolicy ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler ../../../../geometry/Extent ../../../../geometry/Point ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol".split(" "),
function(k,E,l,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,R,Pa,Qa,Z,Ra,F,aa,ba,ca,S,e,T,A,w,da,m,Sa,Ta,ea,N,G,K,B,H,fa,ha,ia,L,O,U,ja,ka,V,la,x,M,ma,na,oa,pa,qa,ra,sa,W,ta,ua,X,va,wa,xa,ya,u,za,I,Aa,Ba,Y,Ca,Da){var P;const Q=K.create(),p=H.create(),t=ca.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");k.Graphics3DCore=P=function(f){function J(a){var b=Ea.call(this,a);b._propertiesPool=new xa.PropertiesPool({computedExtent:Aa},E._assertThisInitialized(b));b.computedExtent=null;b.currentRenderer=null;b.rendererHasGeometryOperations=
!1;b._graphicStateTracking=null;b.graphics3DGraphics=new Map;b.stageLayer=null;b.stage=null;b._graphicsDrapedUids=new Set;b._graphicsBySymbol=new Map;b._symbolConversionCache=new Map;b._symbols=new Map;b._graphicsWithoutSymbol=new Map;b._graphicsWaitingForSymbol=new Map;b._graphicsUpdateId=0;b._handles=new aa;b._frameTask=I.ImmediateTask;b._suspendSymbolCleanup=!1;b._arcadeOnDemand=null;b._rendererChangeAbortController=null;b._elevationInfoChangeAbortController=null;b._initializeAbortController=null;
b._scaleVisibility=null;b._filterVisibility=null;b._spatialIndex=null;b.extentPadding=0;b._updatingPendingLoadedGraphicsChange=null;b._featureStore=null;b._deconflictor=null;b._labeler=null;b._objectStates=null;b._viewElevationProvider=null;b._stageLayerElevationProvider=null;b._sharedSymbolResourcesOwnerHandle=null;b._whenGraphics3DGraphicRequests={};b._pendingUpdates=new Map;b._numberOfGraphics=0;b._numberOfGraphicsProvidingElevation=0;b._pendingAdds=0;b._pendingRemoves=0;b._applyPendingRemovesFirst=
!1;b._loadingSymbols=0;b._pendingUpdatesPool=new T({allocator:c=>c||new Fa,deallocator:c=>{c.clear();return c}});b._symbolWarningLogged=!1;b._geometryWarningLogged=!1;b._objectIdInvisibleSet=new Set;b._whenSymbolRemoved=new T;b.preferredUpdatePolicy=u.UpdatePolicy.SYNC;b._forcedUpdatePolicy=null;b.elevationFeatureExpressionEnabled=!0;b.owner=null;b.layer=null;b.graphicSymbolSupported=!0;b.getRenderingInfoWithoutRenderer=!1;b.setUidToIdOnAdd=!0;b.hasZ=null;b.hasM=null;b._usedMemory=0;b._visible=!1;
b._startCreateGraphics=!1;b.symbolCreationContext=new oa.Graphics3DSymbolCreationContext(a.owner.view.resourceController.scheduler,(c,d)=>b._frameTask.schedule(c,d));return b}E._inherits(J,f);var Ea=E._createSuper(J);f=J.prototype;f._getConvertedSymbol=function(a){if("web-style"===a.type)return a.clone();var b=this._symbolConversionCache.get(a.id);if(e.isSome(b))return b;b=V.to3D(a,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(a)});const c=
b.symbol||null;e.isNone(c)&&b.error&&t.error(b.error.message);this._symbolConversionCache.set(a.id,c);return c};f._getSymbolComplexitiesUsedOrRenderer=function(a){if(e.isNone(a))return[];var b=a.getSymbols(),c="backgroundFillSymbol"in a?a.backgroundFillSymbol:null;if(!(c||b&&b.length))return[];a=[];c=this._getSymbolComplexityUsedOrRenderer(c);e.isSome(c)&&a.push(c);for(const d of b)b=this._getSymbolComplexityUsedOrRenderer(d),e.isSome(b)&&a.push(b);return a};f._getSymbolComplexityUsedOrRenderer=function(a){if(e.isNone(a))return null;
const b=this._symbols.get(a.id);if(e.isSome(b))return b.complexity;a=this._getConvertedSymbol(a);return e.isSome(a)?X.defaultSymbolComplexity(a):null};f._getSymbolComplexitiesUsed=function(){const a=[];this._symbols.forEach(b=>{e.isSome(b)&&a.push(b.complexity)});return a};f.initialize=function(){this._featureStore=new ma.Graphics3DFeatureStore({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,
getSpatialIndex:()=>this.spatialIndex,forEach:c=>this.graphics3DGraphics.forEach(c)});const a=(c,d,g)=>this.spatialIndex.queryGraphicUIDsInExtent(c,d,g),{componentFactories:b}=this;e.isSome(b.elevationAlignment)&&(this._elevationAlignment=b.elevationAlignment(this,a));e.isSome(b.scaleVisibility)&&(this._scaleVisibility=b.scaleVisibility(this,a));e.isSome(b.filterVisibility)&&(this._filterVisibility=b.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,
updateFeatureVisibilities:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(x.VisibilityFlag.FILTER,c(L.getObjectId(d.graphic,this._objectIdField)),x.VisibilityGroup.GRAPHIC)),setAllFeaturesVisibility:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(x.VisibilityFlag.FILTER,c,x.VisibilityGroup.GRAPHIC)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(c=>c.clearVisibilityFlag(x.VisibilityFlag.FILTER))}));e.isSome(b.deconflictor)&&(this._deconflictor=
b.deconflictor(this));e.isSome(b.labeler)&&e.isSome(this._scaleVisibility)&&(this._labeler=b.labeler(this,this._scaleVisibility));e.isSome(b.objectStates)&&(this._objectStates=b.objectStates(this));this._initializeAbortController=new AbortController;this._initializePromise=this._initializeAsync()};f._initializeAsync=async function(){const a=this._initializeAbortController?.signal,b=this.owner.view;this._viewElevationProvider=new la.ViewElevationProvider(this._viewSpatialReference,b);this._initializeStage(b,
this.layer.uid);var c=b.sharedSymbolResources;this.symbolCreationContext.sharedResources=c;this._sharedSymbolResourcesOwnerHandle=c.addGraphicsOwner(this.owner);e.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=c.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=b.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.graphicsCoreOwner=
this.owner;this.symbolCreationContext.localOriginFactory=new ya.GridLocalOriginFactory(b.renderSpatialReference);this.symbolCreationContext.elevationProvider=b.elevationProvider;this.symbolCreationContext.notifyGraphicGeometryChanged=d=>this.notifyGraphicGeometryChanged(d);this.symbolCreationContext.notifyGraphicVisibilityChanged=d=>this.notifyGraphicVisibilityChanged(d);c=M.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=
await M.createContext(c,this._viewSpatialReference,a,t);A.throwIfAborted(a);this.symbolCreationContext.screenSizePerspectiveEnabled=b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled;this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods;
if("drapeSourceType"in this.owner){const {owner:d}=this;this.symbolCreationContext.drapeSourceRenderer=b.basemapTerrain.overlayManager.registerGeometryDrapeSource(d);this._handles.add(ba.makeHandle(()=>b.basemapTerrain.overlayManager.unregisterDrapeSource(d)))}this._handles.add([w.watch(()=>this.suspendedOrOutsideOfView,()=>this._frameTask.reschedule(()=>this._updateLayerVisibility())),w.watch(()=>[this.layer?.screenSizePerspectiveEnabled,this.owner.view.screenSizePerspectiveEnabled],()=>{const d=
b.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;d!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=d,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())}),w.watch(()=>this.owner.slicePlaneEnabled,d=>this._slicePlaneEnabledChange(!!d)),w.watch(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),w.watch(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,d=>
this._physicalBasedRenderingChange(d)),w.watch(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,d=>this._skipHighSymbolLoDsChange(d)),w.when(()=>b.basemapTerrain?.tilingScheme,d=>{!d.spatialReference.equals(this.symbolCreationContext.overlaySR)&&e.isSome(b.basemapTerrain.spatialReference)&&(this.symbolCreationContext.overlaySR=b.basemapTerrain.spatialReference);this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([w.on(()=>this.owner?.loadedGraphics,
"change",g=>{this._graphicsCollectionChanged(g);this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics();this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")},{initial:!0}),w.watch(()=>this.effectiveUpdatePolicy,d=>{e.isSome(this.stageLayer)&&(this.stageLayer.updatePolicy=d);this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC;d===u.UpdatePolicy.SYNC&&this.runTask(I.noBudget)},w.syncAndInitial)]);
this._frameTask=b.resourceController.scheduler.registerTask(I.TaskPriority.GRAPHICS_CORE,this);this.layer&&"featureReduction"in this.layer&&this._handles.add(w.watch(()=>this.layer.featureReduction,()=>this._deconflictor.featureReductionChange()));this.notifyChange("averageSymbolComplexity");this.rendererChange(this.owner.renderer).catch(()=>{});this._initializeAbortController=null};f._abortInitialize=function(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=
null)};f.destroy=function(){this._abortInitialize();this._abortRendererChange();this._abortElevationInfoChange();this._frameTask.remove();this._frameTask=I.ImmediateTask;this.owner.view.deconflictor.removeGraphicsOwner(this);this.owner.view.labeler.removeGraphicsOwner(this);this._elevationAlignment=e.destroyMaybe(this._elevationAlignment);this._scaleVisibility=e.destroyMaybe(this._scaleVisibility);this._filterVisibility=e.destroyMaybe(this._filterVisibility);this._labeler=this._deconflictor=null;
this._objectStates=e.destroyMaybe(this._objectStates);this.clear();this._featureStore=e.destroyMaybe(this._featureStore);this._updatingPendingLoadedGraphicsChange=e.removeMaybe(this._updatingPendingLoadedGraphicsChange);this._graphicStateTracking=e.destroyMaybe(this._graphicStateTracking);this.stage&&(this.stage.remove(this.stageLayer),this.stage=this.stageLayer=null);this._handles=e.destroyMaybe(this._handles);this._set("owner",null);for(const a in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[a].reject(new F("graphic:layer-destroyed",
"Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null;this._sharedSymbolResourcesOwnerHandle=e.removeMaybe(this._sharedSymbolResourcesOwnerHandle);this._propertiesPool=e.destroyMaybe(this._propertiesPool);this._pendingUpdatesPool=null;this._symbolConversionCache.clear();this._objectIdInvisibleSet.clear();this._spatialIndex=e.destroyMaybe(this._spatialIndex)};f.clear=function(){this._objectStates?.allGraphicsDeleted();e.isSome(this._graphicStateTracking)&&this._graphicStateTracking.allGraphicsDeleted();
this.graphics3DGraphics.forEach(a=>a.destroy());this._spatialIndex?.clear();this.graphics3DGraphics.clear();this._usedMemory=this._numberOfGraphics=0;this._updateLayerVisibility();this._symbols.forEach(e.destroyMaybe);this._symbols.clear();this._graphicsBySymbol.clear();this._graphicsWithoutSymbol.clear();this._graphicsWaitingForSymbol.clear();this._pendingUpdates.clear();this._pendingUpdatesPool.clear();this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=!1;this.notifyChange("updating");
this.notifyChange("running");this.notifyChange("updatingRemaining");this._featureStore.events.emit("changed")};f._initializeStage=function(a,b){this.stage=a._stage;this.stageLayer=new za.WebGLLayer({pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},b);this.stage.add(this.stageLayer);a=this.stageLayer.events;a.on("objectTransformation",c=>this.notifyGraphicGeometryChanged(c.metadata.graphicUid));a.on("visibilityChanged",c=>this.notifyGraphicVisibilityChanged(c.metadata.graphicUid));
a.on("objectGeometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));a.on("objectGeometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));a.on("objectGeometryUpdated",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid))};f.notifyGraphicGeometryChanged=function(a){e.isNone(this._graphicStateTracking)||e.isNone(a)||(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicGeometry(a)};f.notifyGraphicVisibilityChanged=
function(a){e.isNone(this._graphicStateTracking)||e.isNone(a)||(a=this.graphics3DGraphics.get(a))&&this._graphicStateTracking.updateGraphicVisibility(a)};f._updateLayerVisibility=function(){var a=this._numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;a=!this.suspendedOrOutsideOfView&&!a;a!==this._visible&&((this._visible=a)?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())};
f._updateStageLayerVisibility=function(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||0<this.layer.opacity)};f.getGraphics3DGraphicById=function(a){return null!=a?this.graphics3DGraphics.get(a):void 0};f.getGraphics3DGraphicByObjectId=function(a){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(a):null};f._getGraphicObjectID=function(a,b=this.owner.layer&&this.owner.layer.objectIdField){return L.getObjectId(a,b)};f.updateLabelingInfo=async function(a){const b=
this._deconflictor&&this._deconflictor.labelingInfoChange(a);a=this._labeler&&this._labeler.labelingInfoChange(a);await A.eachAlways([b,a])};f.updateVisibilityInfo=function(){this._deconflictor&&this._deconflictor.labelingInfoChange();this._labeler&&this._labeler.visibilityInfoChange()};f.runTask=function(a){this._frameTask.processQueue(a);this._applyPendingUpdates(a);this.notifyChange("running");this.running||this.notifyChange("updating");this.notifyChange("updatingRemaining");if(!a.hasProgressed)return I.Task.YIELD};
f.setObjectIdVisibility=function(a,b){b?this._objectIdInvisibleSet.delete(a):this._objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);e.isSome(a)&&this._updateUserVisibility(a)};f._findGraphics3DGraphicByObjectId=function(a){return S.findInMap(this.graphics3DGraphics,b=>this._getGraphicObjectID(b.graphic)===a)};f._updateUserVisibility=function(a){if(e.isNone(a))return!1;var b=a.graphic;const c=this._getGraphicObjectID(b);b=b.visible&&!this.owner.suspended&&(e.isNone(c)||!this._objectIdInvisibleSet.has(c));
return a.setVisibilityFlag(x.VisibilityFlag.USER_SETTING,b,x.VisibilityGroup.GRAPHIC)};f._whenGraphics3DGraphic=function(a){var b=this.graphics3DGraphics.get(a.uid);if(b)return Promise.resolve(b);if(b=this._whenGraphics3DGraphicRequests[a.uid])return b.promise;b=A.createDeferred();this._whenGraphics3DGraphicRequests[a.uid]=b;return b.promise};f._boundsForGraphics3DGraphic=async function(a,b){const c=this._viewSpatialReference,d=this.owner.view.renderSpatialReference,g=this.owner.view.basemapTerrain.spatialReference;
var h=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:e.isSome(b)?!!b.useViewElevation:!1,minDemResolution:e.isSome(b)?b.minDemResolution:null,minDemResolutionForPoints:this.owner.view.resolution}:null;a=await a.getProjectedBoundingBox((q,n,v)=>B.projectBuffer(q,d,n,q,c,n,v),(q,n,v)=>B.projectBuffer(q,g,n,q,c,n,v),h,e.get(b,"signal"));if(!a)return null;b=a.boundingBox;a.requiresDrapedElevation&&(h=this.symbolCreationContext.elevationProvider)&&(H.center(b,Q),h=e.unwrapOr(h.getElevation(Q[0],
Q[1],0,c,"ground"),0),b[2]=Math.min(b[2],h),b[5]=Math.max(b[5],h));return{boundingBox:b,screenSpaceObjects:a.screenSpaceObjects}};f.whenGraphicBounds=async function(a,b){await w.whenOnce(()=>this.owner?.loadedGraphics);const c=this.owner.layer&&this.owner.layer.objectIdField;var d=this.owner.loadedGraphics.find(g=>g===a?!0:null!=c&&null!=g.attributes&&a.attributes&&g.attributes[c]===a.attributes[c]);if(!d)throw new F("internal:graphic-not-part-of-view","Graphic is not part of this view");d=await this._whenGraphics3DGraphic(d);
return this._boundsForGraphics3DGraphic(d,b)};f.computeAttachmentOrigin=function(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var c=a.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;G.set(y,0,0,0);a=0;if(0<c.render.num){if(!B.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,C,b))return null;G.add(y,y,C);a++}if(0<c.draped.num){const [d,g]=c.draped.origin;c=e.unwrapOr(this._viewElevationProvider.getElevation(d,
g,"ground"),0);G.set(C,d,g,c);if(!B.projectVectorToVector(C,this._viewElevationProvider.spatialReference,C,b))return null;G.add(y,y,C);a++}1<a&&G.scale(y,y,1/a);return new Ba({x:y[0],y:y[1],z:y[2],spatialReference:b})};f.getSymbolLayerSize=function(a,b){var c=this._symbols.get(a.id);if(e.isNone(c))throw new F("internal:symbol-not-part-of-view","Symbol is not part of this view");a=a.symbolLayers.indexOf(b);if(-1===a)throw new F("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(a);
if(e.isNone(c))throw new F("internal:missing-size","Symbol layer has no valid size");return c};f._graphicsCollectionChanged=function(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))};f.graphicUpdateHandler=function(a){const b=a.graphic.uid,c=this.graphics3DGraphics.get(b);if(!e.isNone(c)||!e.isNone(this._graphicsWithoutSymbol.get(b)))switch(a.property){case "visible":this._graphicUpdateVisibleHandler(c);break;case "geometry":this._graphicUpdateGeometryHandler(c,a);break;case "symbol":this._graphicUpdateSymbolHandler(c,
a);break;case "transform":this._graphicUpdateTransformHandler(c,a)}};f._graphicUpdateGeometryHandler=function(a,b){const c=b.graphic.geometry;if(e.isNone(c))this._recreateGraphic(b.graphic);else if(e.isNone(a)){if(a=b.graphic.symbol&&b.graphic.symbol.id)if(a=this._symbols.get(a),e.isSome(a)&&a.loadStatus===ta.LoadStatus.LOADING)return;this._recreateGraphic(b.graphic)}else{var d=a.graphics3DSymbol;!e.isNone(b.newValue)&&d.updateGeometry(a,b.newValue)||this._recreateGraphic(a.graphic);this._expandComputedExtent(c)}};
f._graphicUpdateSymbolHandler=function(a,b){var c=b.graphic;const d=e.isSome(a)?a.graphics3DSymbol:e.isSome(b.oldValue)?this._symbols.get(b.oldValue.id):null;if(e.isNone(d)||e.isNone(b.newValue))this._recreateGraphic(c);else{var g=d.symbol;b=this._getConvertedSymbol(b.newValue);if(e.isSome(b)&&(b.type!==g.type||"web-style"===b.type)||"web-style"===g.type)this._recreateGraphic(c);else{var h=this._graphicsBySymbol.get(g.id);if(h&&1!==h.size)this._recreateGraphic(c);else if(h=N.diff(g,b),e.isNone(h))this._updateSymbolMapping(g.id,
b);else if(h={diff:h,graphics3DGraphicPatches:[],symbolStatePatches:[]},d.prepareSymbolPatch(h),N.isEmpty(h.diff)){var q=this._getRenderingInfo(c);if(e.isNone(q))this._recreateGraphic(c);else{c=d.extentPadding;for(const n of h.symbolStatePatches)n();c!==d.extentPadding&&this._recomputeExtentPadding();if(e.isSome(a))for(const n of h.graphics3DGraphicPatches)n(a,q);this._updateSymbolMapping(g.id,b)}}else this._recreateGraphic(c)}}};f._graphicUpdateVisibleHandler=function(a){this._updateUserVisibility(a)&&
(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};f._graphicUpdateTransformHandler=function(a,b){};f.recreateGraphics=function(a){this._suspendSymbolCleanup=!0;this.remove(a);this.add(a);this._suspendSymbolCleanup=!1;this.effectiveUpdatePolicy===u.UpdatePolicy.SYNC&&this._cleanupSymbols()};f._recreateGraphic=function(a){this.recreateGraphics([a])};f._beginGraphicUpdate=function(a){const b=this._graphicsUpdateId;this._graphicsUpdateId++;this._graphicsWaitingForSymbol.set(a.uid,
b);1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating");return b};f._endGraphicUpdate=function(a){a&&(this._graphicsWaitingForSymbol.delete(a.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))};f._recomputeExtentPadding=function(){let a=0;this._symbols.forEach(b=>{e.isSome(b)&&(a=Math.max(a,b.extentPadding))});this._set("extentPadding",a)};f._expandComputedExtent=function(a){var b=a.spatialReference;L.computeAABB(a,p);a=this._viewSpatialReference;
var c=P.tmpVec;!ha.equals(b,a)&&B.projectXYZToVector(p[0],p[1],0,b,c,a)&&(p[0]=c[0],p[1]=c[1],B.projectXYZToVector(p[3],p[4],0,b,c,a),p[3]=c[0],p[4]=c[1]);if(isFinite(p[0])&&isFinite(p[3])&&isFinite(p[1])&&isFinite(p[4])){b=this.computedExtent;c=null;var d=isFinite(p[2])&&isFinite(p[5]),g=d&&(!b||null==b.zmin||p[2]<b.zmin);d=d&&(!b||null==b.zmax||p[5]>b.zmax);if(b){if(p[0]<b.xmin||p[1]<b.ymin||p[3]>b.xmax||p[4]>b.ymax||g||d)c=this._propertiesPool.get("computedExtent"),c.xmin=Math.min(p[0],b.xmin),
c.ymin=Math.min(p[1],b.ymin),c.xmax=Math.max(p[3],b.xmax),c.ymax=Math.max(p[4],b.ymax),c.spatialReference=a}else c=this._propertiesPool.get("computedExtent"),c.xmin=p[0],c.ymin=p[1],c.xmax=p[3],c.ymax=p[4],c.spatialReference=a;c&&(g&&(c.zmin=p[2]),d&&(c.zmax=p[5]),this._set("computedExtent",c))}};f._abortElevationInfoChange=function(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)};f.elevationInfoChange=async function(){this._abortElevationInfoChange();
const a=new AbortController;this._elevationInfoChangeAbortController=a;const b=M.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await M.createContext(b,this._viewSpatialReference,a.signal,t);A.throwIfAborted(a.signal);this._elevationInfoChangeAbortController=null;this._labeler?.elevationInfoChange();this.forEachGraphics3DSymbol((c,d,g)=>{c.globalPropertyChanged("elevationInfo",d)?d.forEach(h=>{const q=
h.graphic;h=h.labelLayers;for(const n of h)n.graphics3DSymbolLayer.updateGraphicElevationContext(q,n)}):this._recreateSymbol(g)});this.updateStageLayerElevationProvider();this._elevationAlignment?.elevationInfoChange()};f.updateStageLayerElevationProvider=function(){if(this._stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),
this._stageLayerElevationProvider=e.disposeMaybe(this._stageLayerElevationProvider)}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this._numberOfGraphicsProvidingElevation&&(this._stageLayerElevationProvider=new va.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))};f._clearSymbolsAndGraphics=function(){this.clear();
e.isSome(this._filterVisibility)&&this._filterVisibility.clear();this._labeler?.reset();this._deconflictor?.clear();this._elevationAlignment?.clear();this.stageLayer?.invalidateSpatialQueryAccelerator();this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=e.disposeMaybe(this._stageLayerElevationProvider))};f.startCreateGraphics=function(){this._startCreateGraphics=!0;this.recreateAllGraphics()};f.recreateAllGraphics=
function(){this._recreateAllGraphics(!1)};f.recreateAllGraphicsAndSymbols=function(){this._recreateAllGraphics(!0)};f._recreateAllGraphics=function(a=!1){if(this._startCreateGraphics){var {loadedGraphics:b,view:c}=this.owner,d=c.basemapTerrain.tilingScheme&&b&&b.length?b.toArray():null;!a&&d||this._clearSymbolsAndGraphics();this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=
!!this.owner.slicePlaneEnabled;this._set("computedExtent",null);d&&(a?this.add(d):this.recreateGraphics(d))}};f._recreateSymbol=function(a){var b=this._graphicsBySymbol.get(a);const c=[];b&&(b.forEach((d,g)=>{const h=d.usedMemory;this._conditionalRemove(d,g);this._spatialIndex?.remove(d);c.push(d.graphic);d.destroy();this._removeGraphics3DGraphic(g,h);this._updateLayerVisibility();this._featureStore.events.emit("changed")}),this._graphicsBySymbol.set(a,new Map));b=this._symbols.get(a);e.destroyMaybe(b);
this._symbols.delete(a);this.add(c)};f._recreateGraphicsForSymbol=function(a){if(a=this._graphicsBySymbol.get(a)){const b=[];a.forEach(c=>b.push(c.graphic));this.recreateGraphics(b)}};f._conditionalRemove=function(a,b){this._graphicsDrapedUids.delete(b);this._objectStates?.removeGraphic(a);this._labeler?.removeGraphic(a);this._deconflictor?.removeGraphic(a);e.isSome(this._graphicStateTracking)&&this._graphicStateTracking.removeGraphic(a)};f.add=function(a){a&&0!==a.length&&(this.owner.view.basemapTerrain&&
this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(a)===u.UpdatePolicy.ASYNC?this._addDelayed(a):this._addImmediate(a),this.notifyChange("updating")):t.error("#add()","Cannot add graphics before terrain surface has been initialized"))};f._updatePolicyForGraphics=function(a){if(this.effectiveUpdatePolicy===u.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const b of a)if(e.isSome(b.geometry)&&"mesh"===b.geometry.type&&!b.geometry.loaded)return u.UpdatePolicy.ASYNC;
return this.effectiveUpdatePolicy};f._addImmediate=function(a){this._symbolWarningLogged=this._geometryWarningLogged=!1;for(const b of a)this._addGraphic(b,this._getRenderingInfo(b,t),u.UpdatePolicy.SYNC);this._cleanupSymbols();this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()};f._addDelayed=function(a){for(const b of a){a=b.uid;let c=this._pendingUpdates.get(a);c?c.add?c.state!==r.NEW&&c.abortController?.abort():this._pendingAdds++:
(c=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(a,c));c.add=b}this.notifyChange("running");this.notifyChange("updatingRemaining")};f.remove=function(a){this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?this._removeDelayed(a):this._removeImmediate(a);this.notifyChange("updating")};f._removeImmediate=function(a){for(const b of a)this._removeGraphic(b);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};
f._removeDelayed=function(a){for(const c of a){a=c.uid;var b=this._pendingUpdates.get(a);b?b.add&&(b.remove?b.add=null:this._pendingUpdates.delete(a),b.state===r.LOADING&&b.abortController?.abort(),this._pendingAdds--):(b=this._pendingUpdatesPool.pushNew(),b.remove=c,this._pendingUpdates.set(a,b),this._pendingRemoves++,this._applyPendingRemovesFirst=!0)}0===this._pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("running");this.notifyChange("updatingRemaining")};f._finishPendingUpdates=
function(){this._pendingUpdatesPool.clear();this._cleanupSymbols();(this._pendingAdds||this._pendingRemoves)&&t.warn("pendingAdds/Removes in inconsistent state!");this._pendingRemoves=this._pendingAdds=0;this._applyPendingRemovesFirst=!1};f._applyPendingUpdates=function(a){this._symbolWarningLogged=this._geometryWarningLogged=!1;if(0===this._pendingUpdates.size&&this._spatialIndex?.updating)this._spatialIndex.update(),a.madeProgress();else{if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=
!1;for(const [b,c]of this._pendingUpdates){if(a.done){this._applyPendingRemovesFirst=!0;break}if(c.remove&&!c.add&&(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),c.remove=null,this._pendingUpdates.delete(b),0===this._pendingRemoves))break}}for(const [b,c]of this._pendingUpdates){if(a.done)break;c.add&&c.state===r.NEW&&this._processPendingUpdateNew(c);let d=this.effectiveUpdatePolicy;!c.remove||c.add&&c.state!==r.READY||(this._pendingRemoves--,a.madeProgress(),this._removeGraphic(c.remove),
c.remove=null,d=u.UpdatePolicy.SYNC);if(c.add)switch(c.state){case r.READY:this._addGraphic(c.add,c.renderingInfo,d);c.add=null;this._pendingAdds--;a.madeProgress();break;case r.REJECTED:c.add=null,this._pendingAdds--}null==c.remove&&null==c.add&&this._pendingUpdates.delete(b)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}};f._processPendingUpdateNew=function(a){if(a.add){var b=a.add.geometry;e.isSome(b)&&"mesh"===b.type&&!b.loaded?this._processPendingUpdateNewMesh(a,
b):this._processPendingUpdateNewRenderingInfo(a)}else a.state=r.READY};f._processPendingUpdateNewMesh=async function(a,b){a.state=r.LOADING;a.abortController=new AbortController;const c=a.abortController.signal;try{await b.load({signal:c})}catch(d){return this._processPendingUpdateNewError(a,d)}a.abortController=null;this._processPendingUpdateNewRenderingInfo(a)};f._processPendingUpdateNewError=function(a,b){a.abortController=null;A.isAbortError(b)?a.state=r.NEW:a.state=r.REJECTED};f._processPendingUpdateNewRenderingInfo=
async function(a){if(e.isNone(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)a.renderingInfo=this._getRenderingInfo(a.add,t);else{a.state=r.LOADING;a.abortController=new AbortController;var b=null;try{b=await this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal})}catch(c){a.abortController=null;A.isAbortError(c)?a.state=r.NEW:a.state=r.REJECTED;return}e.isNone(b)||e.isNone(b.symbol)?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),
a.renderingInfo=null):a.renderingInfo=b}a.state=r.READY};f._addGraphic=function(a,b,c){this._graphicsWithoutSymbol.set(a.uid,a);if(!e.isNone(b)&&!e.isNone(b.symbol)&&L.hasGeometry(a)){e.isSome(this.stage.renderView.objectAndLayerIdRenderHelper)&&this.setUidToIdOnAdd&&this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(a.objectId,a.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled);var d=this.getOrCreateGraphics3DSymbol(b.symbol,b.renderer);if(!e.isNone(d)){this._expandComputedExtent(a.geometry);
var g=this._beginGraphicUpdate(a),h=new na(a,b,this.layer),q=!1,n=z=>{z===d.symbol.id&&(q=!0)};this._whenSymbolRemoved.push(n);var v=()=>{--this._loadingSymbols;if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(n);if(this._graphicsWaitingForSymbol.get(a.uid)!==g||q||d.destroyed||this.graphicSymbolSupported&&a.symbol&&a.symbol.id!==d.symbol.id)--d.referenced,this._cleanupSymbols();else{const z=this._createGraphics3DGraphic(d,h);this._spatialIndex&&e.isSome(z)&&this._spatialIndex.add(z);--d.referenced;
this._endGraphicUpdate(a)}this._featureStore.events.emit("changed");this._labeler&&this.owner.view.labeler.setDirty()}},D=z=>{--this._loadingSymbols;this.destroyed||(this._whenSymbolRemoved.removeUnordered(n),q||(A.isAbortError(z)?this.add([a]):d.destroyed||this._endGraphicUpdate(a)))};++this._loadingSymbols;c===u.UpdatePolicy.ASYNC?d.load(()=>this._frameTask.schedule(v),z=>this._frameTask.schedule(()=>D(z))):d.load(v,D)}}};f._removeGraphic=function(a){a=a.uid;const b=this.graphics3DGraphics.get(a);
if(b){b.graphics3DSymbol.onRemoveGraphic(b);const c=b.usedMemory,d=b.isElevationSource;this._conditionalRemove(b,a);this._spatialIndex?.remove(b);this._graphicsBySymbol.get(b.graphics3DSymbol.symbol.id)?.delete(a);this._graphicsWithoutSymbol.delete(a);this._removeGraphics3DGraphic(a,c,d);b.destroy();this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(a),this._graphicsWaitingForSymbol.delete(a),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))};
f._hasLabelingContext=function(a){if(a instanceof Y||a instanceof Ca){const b=this.symbolCreationContext.layer;return b.labelingInfo?b.labelingInfo.some(c=>c.symbol===a):!1}return!1};f._hasValidSymbolCreationContext=function(a){return a instanceof Y&&!this._hasLabelingContext(a)?(t.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};f._getRenderingInfo=function(a,b){const c=a.geometry;if(e.isNone(c))return b&&!this._geometryWarningLogged&&
(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!B.canProjectWithoutEngine(c.spatialReference,this._viewSpatialReference))return b&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&e.isSome(a.symbol))return b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),
null;a=this.rendererHasGeometryOperations?O.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||e.isSome(this.currentRenderer))?this.owner.getRenderingInfo(a,this.currentRenderer,this._arcadeOnDemand):{symbol:a.symbol||ka.getDefaultSymbol3D(a.geometry)};return e.isNone(a)||e.isNone(a.symbol)?(b&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,b.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a};f._getRenderingInfoAsync=
function(a,b){if(e.isNone(a.geometry))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&e.isSome(a.symbol))return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;a=this.rendererHasGeometryOperations?O.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,
this.currentRenderer,this._arcadeOnDemand,b)};f._createGraphics3DSymbol=function(a,b){if(!this._hasValidSymbolCreationContext(a))return null;a=this._getConvertedSymbol(a);if(!a)return null;let c;e.isSome(b)&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=V.to3D(b.backgroundFillSymbol,{ignoreDrivers:!0}),e.isSome(b.symbol)&&"web-style"!==b.symbol.type&&"cim"!==b.symbol.type&&(c=b.symbol.symbolLayers));const d=pa.make(a,this.symbolCreationContext,c);d.load(()=>{const g=d.extentPadding;g>this.extentPadding&&
this._set("extentPadding",g);this.notifyChange("averageSymbolComplexity")},()=>{});return d};f.getOrCreateGraphics3DSymbol=function(a,b){let c=this._symbols.get(a.id);void 0===c&&(c=a instanceof Da?new qa(a,d=>this._frameTask.schedule(d),d=>this._createGraphics3DSymbol(d,b)):this._createGraphics3DSymbol(a,b),this._symbols.set(a.id,c));e.isSome(c)&&++c.referenced;return c};f.trackGraphicState=function(a){e.isNone(this._graphicStateTracking)&&(this._graphicStateTracking=new ra.GraphicStateTracking(this));
return this._graphicStateTracking.add(a)};f._addGraphics3DGraphic=function(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,a);this._numberOfGraphics++;a.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this._updateLayerVisibility()};f._removeGraphics3DGraphic=function(a,b,c=!1){this._usedMemory-=b;this.graphics3DGraphics.delete(a);this._numberOfGraphics--;c&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());
this._updateLayerVisibility()};f._createGraphics3DGraphic=function(a,b){const c=b.graphic;this._graphicsWithoutSymbol.delete(c.uid);if(!this._symbols.has(a.symbol.id))return this.add([c]),null;if(this.graphics3DGraphics.has(c.uid))return null;b=a.createGraphics3DGraphic(b);if(e.isNone(b))return null;this._addGraphics3DGraphic(b);a=a.symbol.id;this._graphicsBySymbol.has(a)||this._graphicsBySymbol.set(a,new Map);this._graphicsBySymbol.get(a).set(c.uid,b);b.isDraped&&this._graphicsDrapedUids.add(c.uid);
b.centroid=null;e.isSome(c.geometry)&&"point"!==c.geometry.type&&(b.centroid=sa.computeCentroid(c.geometry,this._viewSpatialReference));this._updateUserVisibility(b);e.isSome(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(b);e.isSome(this._filterVisibility)&&({defaultVisibility:a}=this._filterVisibility,b.setVisibilityFlag(x.VisibilityFlag.FILTER,a,x.VisibilityGroup.GRAPHIC),a||this._filterVisibility.reapply());this._deconflictor?.addGraphic(b);this._labeler?.addGraphic(b);this._objectStates?.addGraphic(b);
this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,b);b.initialize(this.stage,this.stageLayer,this.owner);e.isSome(this._graphicStateTracking)&&this._graphicStateTracking.addGraphic(b);if(a=this._whenGraphics3DGraphicRequests[c.uid])delete this._whenGraphics3DGraphicRequests[c.uid],a.resolve(b);return b};f._abortRendererChange=function(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)};f.rendererChange=
async function(a){this._abortRendererChange();if(a!==this.currentRenderer)if(this._validateRenderer(a),e.isNone(a)&&this._currentRendererChange(null,!1),U.isSupportedRenderer3D(a))if(e.isSome(a)&&a.arcadeRequired){var b=new AbortController;this._rendererChangeAbortController=b;const {arcadeUtils:c}=await this._ensureArcade();A.throwIfAborted(b);const d=c.hasGeometryOperations(a);d&&(await c.enableGeometryOperations(),A.throwIfAborted(b));this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?await this._frameTask.schedule(()=>
this._currentRendererChange(a,d),b.signal):this._currentRendererChange(a,d);this._rendererChangeAbortController=null}else this.effectiveUpdatePolicy===u.UpdatePolicy.ASYNC?(this._rendererChangeAbortController=b=new AbortController,await this._frameTask.schedule(()=>this._currentRendererChange(a,!1),b.signal),this._rendererChangeAbortController=null):this._currentRendererChange(a,!1);else this._currentRendererChange(a,!1)};f._ensureArcade=async function(){e.isNone(this._arcadeOnDemand)&&(this._arcadeOnDemand=
await ja.loadArcade());return this._arcadeOnDemand};f._currentRendererChange=function(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=b;this.symbolCreationContext.arcade=e.unwrap(this._arcadeOnDemand);b=this.symbolCreationContext.renderer;if(a!==b)if(this._symbolConversionCache.clear(),e.isNone(a))this.symbolCreationContext.renderer=null,this.recreateAllGraphicsAndSymbols();else{var c=N.diff(b,a);this._updateUnchangedSymbolMappings(c,a,b);this.symbolCreationContext.renderer=a;e.isNone(c)||
("complete"===c.type?this.recreateAllGraphicsAndSymbols():"partial"===c.type&&(this._applyRendererDiff(c,a,b)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}};f._diffHasSymbolChange=function(a){for(const b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "uniqueValueGroups":case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1};f._applySymbolSetDiff=
function(a,b,c){a=a||[];b=b||[];const d=[];for(const g of b){const h=this._graphicsBySymbol.get(g.id);h&&h.forEach((q,n)=>{var v=q.graphic,D=this.layer instanceof ia?this.layer:null;const z=e.unwrap(this._arcadeOnDemand);if(g!==c.defaultSymbol||c.getSymbol(O.hydrateGraphic(v,D),{arcade:z})!==c.defaultSymbol)D=q.usedMemory,a.length||c.defaultSymbol?d.push(v):this._graphicsWithoutSymbol.set(n,v),v=this.graphics3DGraphics.get(n),this._conditionalRemove(v,n),q.destroy(),h.delete(n),this._removeGraphics3DGraphic(n,
D),this._updateLayerVisibility()});this._whenSymbolRemoved.forAll(q=>q(g.id))}if(a.length||d.length)this._graphicsWithoutSymbol.forEach(g=>d.push(g)),this._graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};f._applyUniqueValueRendererDiff=function(a,b,c){const d=a.diff.defaultSymbol,g=a.diff.uniqueValueInfos;if(d||g){const h=g?g.added.map(n=>n.symbol).filter(e.isSome):[],q=g?g.removed.map(n=>n.symbol).filter(e.isSome):
[];if(g)for(let n=0;n<g.changed.length;n++)h.push(g.changed[n].newValue.symbol),q.push(g.changed[n].oldValue.symbol);d?(c.defaultSymbol&&q.push(c.defaultSymbol),b.defaultSymbol&&h.push(b.defaultSymbol)):c.defaultSymbol&&h.length&&q.push(b.defaultSymbol);this._applySymbolSetDiff(h,q,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1};f._calculateUnchangedSymbolMapping=function(a,b,c){if("unique-value"!==b?.type||"unique-value"!==c?.type||e.isSome(a)&&"partial"!==a.type)return[];
const d=h=>e.isSome(h)?h.id:null;var g=a&&a.diff;a=g&&g.defaultSymbol;if(g=g&&g.uniqueValueInfos)g=g.unchanged.map(h=>({oldId:d(h.oldValue.symbol),newId:d(h.newValue.symbol)}));else{g=[];for(const h of c.uniqueValueInfos??[]){const q=d(h.symbol),n=b.uniqueValueInfos?.find(v=>v.value===h.value);n&&q!==d(n.symbol)&&g.push({oldId:q,newId:d(n.symbol)})}}!a&&c.defaultSymbol&&g.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return g};f._updateSymbolMapping=function(a,b){const c=e.isSome(b)&&
b?"string"===typeof b?b:b.id:null;if(!e.isNone(a)&&a!==c){var d=this._graphicsBySymbol.get(a);this._graphicsBySymbol.delete(a);void 0!==d&&this._graphicsBySymbol.set(c,d);d=this._symbols.get(a);void 0!==d&&(this._symbols.delete(a),this._symbols.set(c,d),e.isSome(d)&&(a="string"===typeof b?null:b,e.isSome(a)?d.symbol=a:d.symbol.id=c))}};f._updateUnchangedSymbolMappings=function(a,b,c){a=this._calculateUnchangedSymbolMapping(a,b,c);for(const {oldId:d,newId:g}of a)this._updateSymbolMapping(d,g)};f._applyRendererDiff=
function(a,b,c){if(this._diffHasSymbolChange(a))return!1;if(b instanceof R&&c instanceof R&&this._applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length)return!0;for(const [d]of this._graphicsBySymbol)if(c=this._symbols.get(d),e.isSome(c))switch(c.applyRendererDiff(a,b)){case W.ApplyRendererDiffResult.Recreate_Symbol:this._recreateSymbol(d);break;case W.ApplyRendererDiffResult.Recreate_Graphics:this._recreateGraphicsForSymbol(d)}return!0};f.opacityChange=function(){this.forEachGraphics3DSymbol((a,
b)=>a.globalPropertyChanged("opacity",b));this._updateStageLayerVisibility()};f._slicePlaneEnabledChange=function(a){a!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=a,this.stageLayer.sliceable=a,this.forEachGraphics3DSymbol((b,c)=>b.globalPropertyChanged("slicePlaneEnabled",c)),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())};f._physicalBasedRenderingChange=function(a){this.symbolCreationContext.physicalBasedRenderingEnabled=
a;this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("physicalBasedRenderingEnabled",c)||this._recreateSymbol(d)})};f._skipHighSymbolLoDsChange=function(a){this.symbolCreationContext.skipHighSymbolLods=a;this.forEachGraphics3DSymbol((b,c,d)=>{b.globalPropertyChanged("skipHighSymbolLods",c)||this._recreateSymbol(d)})};f._pixelRatioChange=function(){this.forEachGraphics3DSymbol((a,b,c)=>{a.globalPropertyChanged("pixelRatio",b)||this._recreateSymbol(c)})};f._signalUpdatingDuringAsyncLoadedGraphicsChange=
function(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=da.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})};f.setClippingExtent=function(a,b){const c=this.symbolCreationContext.clippingExtent,d=fa.create();wa.toBoundingRect(a,d,b)?this.symbolCreationContext.clippingExtent=H.fromRect(H.create(),d):this.symbolCreationContext.clippingExtent=null;return!H.equals(this.symbolCreationContext.clippingExtent,
c)};f.modifyGraphics3DGraphicVisibilities=function(a){let b=!1;this.graphics3DGraphics.forEach(c=>{a(c)&&(b=!0)});b&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor.setDirty())};f.forEachGraphics3DSymbol=function(a){for(const [b,c]of this._symbols){if(e.isNone(c))break;const d=this._graphicsBySymbol.get(b);a(c,d||Ga,b)}};f.updateAllGraphicsVisibility=function(){e.isSome(this._filterVisibility)&&this._filterVisibility.reapply();this.modifyGraphics3DGraphicVisibilities(a=>{const b=
this._updateUserVisibility(a);a=e.isSome(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(a);return b||a})};f._hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(a=>a.setVisibilityFlag(x.VisibilityFlag.USER_SETTING,!1,x.VisibilityGroup.GRAPHIC))};f._validateRenderer=function(a){(a=U.validateTo3D(a,{geometryType:this.layer?.geometryType}))&&t.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`,
a.message)};f._volatileGraphicsUpdated=function(){this._labeler?.reset();this.stageLayer.shaderTransformationChanged();this.notifyChange("updating")};f._cleanupSymbols=function(){if(!(0<this._graphicsWaitingForSymbol.size||this._suspendSymbolCleanup)){var a=!1;this._symbols.forEach((b,c)=>{if(!(e.isNone(b)||0<b.referenced)){var d=this._graphicsBySymbol.get(c);d&&0!==d.size||(this._graphicsBySymbol.delete(c),this._symbols.delete(c),e.destroyMaybe(b),a=!0)}});a&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}};
E._createClass(J,[{key:"_viewSpatialReference",get:function(){return this.owner.view.spatialReference}},{key:"spatialIndex",get:function(){this._spatialIndex||(this._spatialIndex=new ua.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values())));this._spatialIndex.update();return this._spatialIndex}},{key:"numberOfGraphics",get:function(){return this._numberOfGraphics}},
{key:"effectiveUpdatePolicy",get:function(){return e.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?u.UpdatePolicy.ASYNC:e.unwrapOr(this._forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"featureStore",get:function(){return this._featureStore}},{key:"initializePromise",get:function(){return this._initializePromise}},{key:"scaleVisibility",get:function(){return this._scaleVisibility}},{key:"elevationAlignment",get:function(){return this._elevationAlignment}},{key:"objectStates",
get:function(){return this._objectStates}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"updating",get:function(){return!!(0<this._graphicsWaitingForSymbol.size||this.running||this._elevationAlignment?.updating||e.isSome(this._scaleVisibility)&&this._scaleVisibility.updating||e.isSome(this._filterVisibility)&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||
0<this._loadingSymbols)}},{key:"running",get:function(){return 0<this._pendingUpdates.size||!!this._spatialIndex?.updating}},{key:"suspendedOrOutsideOfView",get:function(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}},{key:"updatingRemaining",get:function(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}},{key:"displayFeatureLimit",get:function(){var a=this.owner&&this.owner.view&&
this.owner.view.qualitySettings;const b=a?a.graphics3D.minTotalNumberOfFeatures:0,c=a?a.graphics3D.maxTotalNumberOfFeatures:0;a=a?a.graphics3D.maxTotalNumberOfPrimitives:0;const d=this.averageSymbolComplexity;var g=Math.max(1,e.isSome(d)?d.primitivesPerFeature:1),h=e.isSome(d)&&0<d.drawCallsPerFeature?c/d.drawCallsPerFeature*.3:c;g=Math.max(b,Math.min(c,Math.ceil(a/g),h));return(h=this._get("displayFeatureLimit"))&&h.minimumTotalNumberOfFeatures===b&&h.maximumTotalNumberOfFeatures===c&&h.maximumTotalNumberOfPrimitives===
a&&h.averageSymbolComplexity===d&&h.maximumNumberOfFeatures===g?h:{minimumTotalNumberOfFeatures:b,maximumTotalNumberOfFeatures:c,maximumTotalNumberOfPrimitives:a,averageSymbolComplexity:d,maximumNumberOfFeatures:g}}},{key:"averageSymbolComplexity",get:function(){const a=X.averageSymbolComplexities(this._symbolComplexities),b=this._get("averageSymbolComplexity");return 0===a.numComplexities||e.isSome(b)&&(a.estimated&&(b.primitivesPerFeature>=a.primitivesPerFeature||b.primitivesPerCoordinate>=a.primitivesPerCoordinate||
b.drawCallsPerFeature>=a.drawCallsPerFeature)||b.primitivesPerFeature===a.primitivesPerFeature&&b.primitivesPerCoordinate===a.primitivesPerCoordinate&&b.drawCallsPerFeature===a.drawCallsPerFeature)?b:a}},{key:"usedMemory",get:function(){const a=e.isSome(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,b=this._getSymbolComplexitiesUsed().reduce((c,d)=>c+d.memory.resourceBytes,0);return this._usedMemory+a+b}},{key:"usedMemoryPerGraphic",
get:function(){return this._usedMemory&&this._numberOfGraphics?this._usedMemory/this._numberOfGraphics*(this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves))):e.isSome(this.averageSymbolComplexity)?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}},{key:"unprocessedMemoryEstimate",get:function(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}},{key:"_symbolComplexities",
get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}},{key:"visible",get:function(){return this._visible}},{key:"_objectIdField",get:function(){return this.layer.objectIdField}},{key:"graphics3DGraphicsByObjectID",get:function(){const a=this.owner.layer&&this.owner.layer.objectIdField;if(a){var b=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,a);e.isSome(d)&&b.set(d,
c)}});return b}}},{key:"labelsEnabled",get:function(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}},{key:"symbolUpdateType",get:function(){if(0<this._pendingUpdates.size)return"unknown";let a=0,b=0;return S.someMap(this._symbols,(c,d)=>{if(e.isSome(c)){c=c.getFastUpdateStatus();if(0<c.loading)return!0;this._graphicsBySymbol.has(d)&&(b+=c.fast,a+=c.slow)}return!1})?"unknown":0<=b&&0===a?"fast":0<=a&&0===b?"slow":"mixed"}},{key:"test",get:function(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),
symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map(a=>({symbolId:a,graphics:[...this._graphicsBySymbol.get(a).keys()].sort()})),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:a=>{this._forcedUpdatePolicy=a}}}},{key:"performanceInfo",
get:function(){return{visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,pending:this._pendingUpdates.size}}}]);return J}(Z);k.Graphics3DCore.tmpVec=K.create();l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"computedExtent",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"currentRenderer",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,
"_frameTask",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"_viewSpatialReference",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_initializeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_elevationAlignment",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"_scaleVisibility",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_filterVisibility",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_initializePromise",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_spatialIndex",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"extentPadding",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"_featureStore",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_deconflictor",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_labeler",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_objectStates",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_loadingSymbols",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,
"_forcedUpdatePolicy",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"effectiveUpdatePolicy",null);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"owner",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"layer",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"graphicSymbolSupported",
void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"componentFactories",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"featureStore",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"initializePromise",null);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"scaleVisibility",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"elevationAlignment",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"objectStates",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"filterVisibility",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"running",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,
"suspendedOrOutsideOfView",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"updatingRemaining",null);l.__decorate([m.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],k.Graphics3DCore.prototype,"displayFeatureLimit",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"averageSymbolComplexity",
null);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasZ",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasM",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_objectIdField",null);k.Graphics3DCore=P=l.__decorate([ea.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],k.Graphics3DCore);var r;(function(f){f[f.NEW=0]="NEW";f[f.LOADING=1]="LOADING";f[f.READY=2]="READY";f[f.REJECTED=3]="REJECTED"})(r||(r={}));let Fa=
function(){function f(){this.renderingInfo=this.add=null;this.state=r.NEW;this.remove=this.abortController=null}f.prototype.clear=function(){this.renderingInfo=this.add=null;this.state=r.NEW;this.remove=this.abortController=null};return E._createClass(f)}();const y=K.create(),C=K.create(),Ga=new Map;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});