// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/handleUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../geometry/support/aaBoundingRect ../../../layers/support/MediaElementView ./interfaces ./LayerView3D ../terrain/OverlayRenderer ../webgl-engine/lib/Attribute ../webgl-engine/lib/basicInterfaces ../webgl-engine/lib/Geometry ../webgl-engine/lib/ModelDirtyTypes ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/lib/UpdatePolicy ../webgl-engine/lib/VertexAttribute ../webgl-engine/materials/ImageMaterial ../../layers/LayerView ../../webgl/enums".split(" "),
function(q,r,t,g,u,v,w,k,N,O,A,B,C,D,E,n,x,F,G,p,H,I,J,l,K,L,y){k=function(e){function m(){var a=M.apply(this,arguments);a.type="media-3d";a.drapeSourceType=D.DrapeSourceType.RasterImage;a.updatePolicy=J.UpdatePolicy.ASYNC;a._uidToElement=new Map;a._renderedElements=new Map;a._lastDrapingExtent=null;a._update=u.debounce(async(b,c,d)=>{b=await a._collectMediaElements(b,c,d);a._synchronizeRenderElements(b)},0);return a}q._inherits(m,e);var M=q._createSuper(m);e=m.prototype;e.initialize=function(){this._renderer=
this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);const a=()=>this._updateWithLastDrapingExtent();this.handles.add([t.makeHandle(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)),v.on(()=>this.layer.effectiveSource,"change",a),v.on(()=>this.layer.effectiveSource,"refresh",a)]);this.updatingHandles.add(()=>this.suspended,a)};e.setDrapingExtent=function(a,b){this._lastDrapingExtent={overlays:a,spatialReference:b};this._updateWithLastDrapingExtent()};e.getHit=
function(a){return(a=this._uidToElement.get(a))?{type:"media",element:a,layer:this.layer}:null};e._updateWithLastDrapingExtent=function(){if(g.isNone(this._lastDrapingExtent)||this.suspended)this._renderer&&this._synchronizeRenderElements(new Set);else{var {overlays:a,spatialReference:b}=this._lastDrapingExtent;this.updatingHandles.addPromise(this._update(a,b).catch(()=>{}))}};e._collectMediaElements=async function(a,b,c){const d=this.layer.effectiveSource;return g.isNone(d)?new Set:new Set((await Promise.all(a.map(f=>
d.queryElements(B.toExtent(f.extent,b),{signal:c})))).flat())};e._synchronizeRenderElements=function(a){this._synchronizeRenderElementsRemove(a);this._synchronizeRenderElementsAdd(a)};e._synchronizeRenderElementsRemove=function(a){const b=new Set,c=[];this._renderedElements.forEach((d,f)=>{a.has(f)||(b.add(f),g.isSome(d.renderData)&&c.push(d.renderData.renderGeometry),this._removeElement(f,d))});this._renderer.removeGeometries(c,p.DirtyOperation.REMOVE)};e._synchronizeRenderElementsAdd=function(a){for(const b of a)this._renderedElements.has(b)||
this._createRenderElement(b)};e._removeElement=function(a,{renderData:b,handle:c}){this._destroyRenderData(b);this._renderedElements.delete(a);this._uidToElement.delete(a.uid);c.remove()};e._createRenderElement=async function(a){const b=new C.MediaElementView({spatialReference:this.view.spatialReference,element:a}),c={renderData:null,handle:t.handlesGroup([this.updatingHandles.add(()=>a.opacity,d=>{g.isSome(c.renderData)&&c.renderData.material.setParameters({opacity:d})}),this.updatingHandles.add(()=>
b.coords,d=>{g.isSome(c.renderData)?this._updateGeometry(c,c.renderData,d):this._initializeRenderData(b,c)}),this.updatingHandles.add(()=>a.content,()=>this._initializeRenderData(b,c)),t.destroyHandle(b)])};this._renderedElements.set(a,c);this._uidToElement.set(a.uid,a);this.updatingHandles.addPromise(a.load().catch(()=>{}));this._initializeRenderData(b,c)};e._initializeRenderData=function(a,b){const {coords:c,element:d}=a;if(g.isNone(c)||g.isNone(d.content))b.renderData=this._destroyRenderData(b.renderData);
else if(!g.isSome(b.renderData)){a=this._createTexture(d.content);this.view._stage.add(a);var f=this.view._stage.loadImmediate(a);u.isPromiseLike(f)&&this.updatingHandles.addPromise(f);f=new K.ImageMaterial({initTextureTransparent:!0,textureId:a.id,opacity:d.opacity,transparent:!0});var h=this._positionVertexBufferFromCoordinates(c),z=[0,1,2,0,2,3];h=new G.Geometry(f,[[l.VertexAttribute.POSITION,new x.Attribute(h,3,!0)],[l.VertexAttribute.UV0,new x.Attribute([0,0,1,0,1,1,0,1],2,!0)]],[[l.VertexAttribute.POSITION,
z],[l.VertexAttribute.UV0,z]]);h=new H.RenderGeometry(h,{layerUid:this.layer.uid,graphicUid:d.uid});this._renderer.addGeometries([h],p.DirtyOperation.ADD);b.renderData={renderGeometry:h,texture:a,material:f}}};e._updateGeometry=function(a,b,c){g.isNone(c)?a.renderData=this._destroyRenderData(a.renderData):(a=this._positionVertexBufferFromCoordinates(c),b.renderGeometry.geometry.setAttributeData(l.VertexAttribute.POSITION,a),this._renderer.modifyGeometries([b.renderGeometry],p.DirtyState.GEOMETRY))};
e._positionVertexBufferFromCoordinates=function(a){const [b,c,d,f]=a.rings[0];return[b[0],b[1],n.DRAPED_Z,f[0],f[1],n.DRAPED_Z,d[0],d[1],n.DRAPED_Z,c[0],c[1],n.DRAPED_Z]};e._destroyRenderData=function(a){if(g.isNone(a))return null;this.view._stage.remove(a.texture);this._renderer.removeGeometries([a.renderGeometry],p.DirtyOperation.REMOVE);a.material.dispose();return null};e._createTexture=function(a){return new I.Texture(a,{wrap:{s:y.TextureWrapMode.CLAMP_TO_EDGE,t:y.TextureWrapMode.CLAMP_TO_EDGE},
preMultiplyAlpha:!0,width:a instanceof HTMLImageElement?a.naturalWidth:a.width,height:a instanceof HTMLImageElement?a.naturalHeight:a.height,mipmap:!0,powerOfTwoResizeMode:F.PowerOfTwoResizeMode.STRETCH,updateCallback:()=>this.view.basemapTerrain.overlayManager.setDrawTexturesDirty()})};q._createClass(m,[{key:"test",get:function(){const a=this;return{get numberOfElements(){return a._renderedElements.size}}}}]);return m}(E.LayerView3D(L));r.__decorate([w.property({readOnly:!0})],k.prototype,"type",
void 0);r.__decorate([w.property()],k.prototype,"layer",void 0);return k=r.__decorate([A.subclass("esri.views.3d.layers.MediaLayerView3D")],k)});