// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/plane ../../../../geometry/support/ray ./Intersector ./PointHighlights ../../support/orientedBoundingBox ../../webgl-engine/core/shaderLibrary/ShaderOutput ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/VertexArrayObject ../../webgl-engine/lib/VertexAttribute ../../../../chunks/PointRenderer.glsl ../../webgl-engine/shaders/PointRendererTechnique ../../webgl-engine/shaders/PointRendererTechniqueConfiguration ../../../webgl/BufferObject ../../../webgl/enums ../../../webgl/VertexElementDescriptor".split(" "),
function(L,H,m,fa,v,I,ha,q,ia,ja,ka,la,M,r,ma,na,J,oa,N,U,pa,qa,ba,z,O){function V(f,g,a,c,b){if(a.drawScreenSpace)return a.fixedSize*g*c;b=U.getMaxPointSizeScreenspace(b)*g*c;return a.useFixedSizes?Math.min(a.fixedSize/2,b):0<a.screenMinSize?Math.min(Math.max(a.screenMinSize*g*c,f/2),b):Math.min(f/2,b)}function W(f,g,a,c,b){return a.drawScreenSpace?0:V(f,g,a,c,b)}function ca(f){return m.isSome(f.component)?f.component:-1}function ra(f,g){if(m.isNone(f))return f;f=f.filter(a=>a.id!==g);return 0===
f.length?null:f}function da(f){return m.isSome(f.dist)&&m.isSome(f.point)&&m.isSome(f.pointId)&&m.isSome(f.node)}const sa={positions:[new O.VertexElementDescriptor(N.VertexAttribute.POSITION,3,z.DataType.FLOAT,0,12)],colors:[new O.VertexElementDescriptor(N.VertexAttribute.COLOR,3,z.DataType.UNSIGNED_BYTE,0,3,!0)]};N=function(){function f(a){this._params=a;this.type=J.IntersectorType.PCL;this.isGround=!1;this._passParameters=new U.PointRendererPassParameters;this._highlights=new la.PointHighlights({forEachNode:c=>
this.forEachNode(c),addHighlight:(c,b,e)=>this._addHighlight(c,b,e),removeHighlight:(c,b)=>this._removeHighlight(c,b)});this.canRender=!0;this.layerUid="";this._slicePlaneEnabled=!1;this._techniqueConfig=new qa.PointRendererTechniqueConfiguration;this._nodes=new fa}var g=f.prototype;g.initializeRenderContext=function(a){this._context=a;this._techniqueRepository=this._context.techniqueRepository;a.requestRender()};g.uninitializeRenderContext=function(){};g.intersect=function(a,c,b,e){const k=I.create(),
h=I.create(),P=I.create(),C=I.create(),K=ia.create(),A=a.camera.perScreenPixelRatio/2,D=a.camera.near;v.subtract(h,e,b);const Q=1/v.length(h);v.scale(h,h,Q);v.negate(P,h);ha.set(K,h[0],h[1],h[2],-v.dot(h,b));const w=new X,x=new X,ea=[],R=q.create(),S=q.create(this._passParameters.clipBox);q.offset(S,-b[0],-b[1],-b[2],S);this._nodes.forAll(d=>{const l=d.splatSize*this._passParameters.scaleFactor;var p=M.minimumDistancePlane(d.obb,K),n=M.maximumDistancePlane(d.obb,K);p-=W(l,p+D,this._passParameters,
A,d.isLeaf);n-=W(l,n+D,this._passParameters,A,d.isLeaf);p=null!=w.dist&&null!=x.dist&&w.dist<p*Q&&x.dist>n*Q;if(!(0>n||p)&&(n=V(l,n+D,this._passParameters,A,d.isLeaf),M.intersectLine(d.obb,b,h,n))){n*=n;M.toAaBoundingBox(d.obb,R);q.offset(R,-b[0],-b[1],-b[2],R);p=!q.contains(S,R);v.subtract(C,d.origin,b);var ta=d.coordinates.length/3;for(let B=0;B<ta;B++){k[0]=C[0]+d.coordinates[3*B];k[1]=C[1]+d.coordinates[3*B+1];k[2]=C[2]+d.coordinates[3*B+2];if(p&&!q.containsPoint(S,k))continue;var t=v.dot(k,h),
T=v.squaredLength(k)-t*t;if(T>n)continue;var E=t+D;const Y=W(l,E,this._passParameters,A,d.isLeaf);if(0>t-Y)continue;E-=Y;E=V(l,E,this._passParameters,A,d.isLeaf);if(T>E*E)continue;const F=(t-Y)*Q;t=y=>{var Z=B,G=y.point;m.isNone(G)&&(G=I.create());G[0]=d.origin[0]+d.coordinates[3*Z];G[1]=d.origin[1]+d.coordinates[3*Z+1];G[2]=d.origin[2]+d.coordinates[3*Z+2];y.point=G;y.dist=F;y.normal=P;y.node=d;y.pointId=B;y.layerUid=this.layerUid;return y};(null==w.dist||F<w.dist)&&(null==c||c(b,e,F))&&t(w);a.options.store!==
J.StoreResults.MIN&&(null==x.dist||F>x.dist)&&(null==c||c(b,e,F))&&t(x);a.options.store!==J.StoreResults.ALL||null!=c&&!c(b,e,F)||(T=new X,ea.push(t(T)))}}});const ua=d=>{const {layerUid:l,node:p,pointId:n}=d;return new ka.PclTarget(d.point,l,n,()=>this._params.createGraphic(p,n,d.point))},aa=(d,l)=>{const p=ua(l);d.set(this.type,p,l.dist,l.normal)};if(da(w)){var u=a.results.min;(null==u.dist||w.dist<u.dist)&&aa(u,w)}da(x)&&a.options.store!==J.StoreResults.MIN&&(u=a.results.max,(null==u.dist||x.dist>
u.dist)&&aa(u,x));if(a.options.store===J.StoreResults.ALL){u=ja.fromPoints(b,e);for(const d of ea){const l=na.newIntersectorResult(u);aa(l,d);a.results.all.push(l)}}};g.prepareTechnique=function(a){if(0===this._nodes.length||a.output!==r.ShaderOutput.Color&&a.output!==r.ShaderOutput.Depth&&a.output!==r.ShaderOutput.Highlight)return null;this._nodes.forAll(c=>{null==c.vao&&this._initNode(a,c)});this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace;this._techniqueConfig.useFixedSizes=
this._passParameters.useFixedSizes;this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled;this._techniqueConfig.hasOccludees=a.bindParameters.hasOccludees;this._techniqueConfig.clippingEnabled=this._clippingEnabled;this._techniqueConfig.output=a.output===r.ShaderOutput.Depth?r.ShaderOutput.Depth:a.output===r.ShaderOutput.Highlight?r.ShaderOutput.Highlight:r.ShaderOutput.Color;return this._techniqueRepository.releaseAndAcquire(pa.PointRendererTechnique,this._techniqueConfig,this._technique)};
g.render=function(a,c){const b=a.rctx,e=b.bindTechnique(c,this._passParameters,a.bindParameters),k=a.output===r.ShaderOutput.Highlight;this._nodes.forAll(h=>{0===h.coordinates.length||k&&!h.highlights||(e.bindDraw(h,a.bindParameters,this._passParameters),b.bindVAO(h.vao),k?this._renderHighlightFragments(b,h):b.drawArrays(z.PrimitiveType.POINTS,0,h.coordinates.length/3))})};g._renderHighlightFragments=function(a,c){var b=c.highlights;if(!m.isNone(b)){c=m.unwrap(b[0].component);var e=c+1;for(let k=
1;k<b.length;k++){const h=m.unwrap(b[k].component);h!==e&&(e-=c,0<e&&a.drawArrays(z.PrimitiveType.POINTS,c,e),c=h);e=h+1}b=e-c;0<b&&a.drawArrays(z.PrimitiveType.POINTS,c,b)}};g.addNode=function(a){this._nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()};g.removeNode=function(a){let c=null;this._nodes.filterInPlace(b=>b.id===a?(c=b,b.vao=m.disposeMaybe(b.vao),this._highlights.nodeRemoved(b),!1):!0);this._requestRender();return c};g.forEachNode=function(a){this._nodes.forAll(a)};g.removeAll=
function(){this._nodes.forAll(a=>a.vao=m.disposeMaybe(a.vao));this._highlights.removeAll();this._nodes.clear();this._requestRender()};g.highlight=function(a){return this._highlights.add(a)};g._addHighlight=function(a,c,b){var e=a.highlights;m.isNone(e)&&(e=[]);c={component:c,id:b};e.push(c);c=ca(c);for(b=e.length-1;0<b&&c<ca(e[b-1]);)[e[b-1],e[b]]=[e[b],e[b-1]],--b;a.highlights=e;this._requestRender()};g._removeHighlight=function(a,c){a.highlights=ra(a.highlights,c);this._requestRender()};g._initNode=
function(a,c){a=a.rctx;c.vao=new oa.VertexArrayObject(a,ma.Default3D,sa,{positions:ba.BufferObject.createVertex(a,z.Usage.STATIC_DRAW,c.coordinates),colors:ba.BufferObject.createVertex(a,z.Usage.STATIC_DRAW,c.rgb)})};g._requestRender=function(){this._context&&this._context.requestRender()};H._createClass(f,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"useFixedSizes",get:function(){return this._passParameters.useFixedSizes},set:function(a){this._passParameters.useFixedSizes!==
a&&(this._passParameters.useFixedSizes=a,this._requestRender())}},{key:"scaleFactor",get:function(){return this._passParameters.scaleFactor},set:function(a){this._passParameters.scaleFactor!==a&&(this._passParameters.scaleFactor=a,this._requestRender())}},{key:"minSizePx",get:function(){return this._passParameters.minSizePx},set:function(a){this._passParameters.minSizePx!==a&&(this._passParameters.minSizePx=a,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._passParameters.useRealWorldSymbolSizes},
set:function(a){this._passParameters.useRealWorldSymbolSizes!==a&&(this._passParameters.useRealWorldSymbolSizes=a,this._requestRender())}},{key:"size",get:function(){return this._passParameters.size},set:function(a){this._passParameters.size!==a&&(this._passParameters.size=a,this._requestRender())}},{key:"sizePx",get:function(){return this._passParameters.sizePx},set:function(a){this._passParameters.sizePx!==a&&(this._passParameters.sizePx=a,this._requestRender())}},{key:"clippingBox",set:function(a){q.set(this._passParameters.clipBox,
a||q.POSITIVE_INFINITY)}},{key:"_clippingEnabled",get:function(){return!q.equals(this._passParameters.clipBox,q.POSITIVE_INFINITY,(a,c)=>a===c)}},{key:"slicePlaneEnabled",get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==a&&(this._slicePlaneEnabled=a,this._requestRender())}}]);return f}();O=function(f){function g(c,b,e,k,h,P,C,K,A=null,D=null){b=a.call(this,e,h,b);b.id=c;b.obb=k;b.coordinates=P;b.rgb=C;b.attributes=K;b.pointIdFilterMap=A;b.highlights=D;return b}
H._inherits(g,f);var a=H._createSuper(g);return H._createClass(g)}(U.PointRendererDrawParameters);let X=H._createClass(function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""});L.PointRenderer=N;L.PointRendererNode=O;L.isInstanceOfNode=function(f){return f.hasOwnProperty("splatSize")};Object.defineProperty(L,Symbol.toStringTag,{value:"Module"})});