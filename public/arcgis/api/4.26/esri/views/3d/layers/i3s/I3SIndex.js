// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../chunks/vec3 ../../../../chunks/sphere ../../../../support/featureFlags ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),function(E,B,e,z,H,M,N,O,r,t,I){function J(p){e.isSome(p.node)&&(t.invalidateMbs(p.node.renderMbs),t.invalidateObb(p.node.serviceObbInRenderSR));e.isSome(p.ref)&&(t.invalidateMbs(p.ref.renderMbs),t.invalidateObb(p.ref.serviceObbInRenderSR))}
function C(p,g){return 0>p?-1:0===g?0:p/g|0}function D(p=[],g=[],a=[]){return{nodes:p,children:g,parents:a}}function A(p,g){return 0>p?-p-1:0===g?p:p%g}function K(p){if(p)for(let g=0;g<p.length;g++)for(const a of P)if(a[0]===p[g].metricType)return{lodMetric:a[1],maxError:p[g].maxError};return{lodMetric:r.LodMetric.None,maxError:0}}function Q(p){return Math.sqrt(4/Math.PI*p)}let F=B._createClass(function(p,g,a,b,c){this.childOffset=p;this.childCount=g;this.visibilityCache=a;this.ref=b;this.node=c;
this.useAsHole=0;this.filterImpact=r.NodeFilterImpact.NotChecked}),S=function(){function p(a,b,c,f,d,h,k,q,u,l,m,x,n,w){this._layer=a;this._streamDataController=c;this._viewportQueries=f;this._logger=d;this.holeFilling=h;this._isLoaded=k;this._isReloading=q;this._isSelected=u;this._enable=l;this._needsUpdate=m;this._canRequest=x;this._computeVisibilityObb=n;this._computeNodeFiltering=w;this._dirty=!0;this._nodePages=[];this._clientNodePage=null;this._rootIndex=this._nodesPerPage=this._nodeCount=0;
this._lodMetric=r.LodMetric.None;this._lodConversion=y=>y;this._isEditable=!1;this._urlPrefix="";this._loading=new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState=new Map;this._version=t.addWraparound(0,2);this._visibilityCacheVersion=t.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leavesReached:!1};this._unloadedMemoryEstimate=
0;this._missing=new z({deallocator:null});this._prefetch=new z({deallocator:null});this._updates=new R(this._missing);this._imModificationUncategorized=new z({deallocator:null});this.ignoreServiceObb=!1;this.progressiveLoadPenalty=0;this._pageQueue=[];this._layerHasFilter=this.layerHasModifications=this.needNodeElevationRange=!1;this._isEditable=O.i3sPatchingEnabled()&&e.isSome(a.associatedLayer)&&e.isSome(a.associatedLayer.infoFor3D);a.serviceUpdateTimeStamp&&a.serviceUpdateTimeStamp.lastUpdate&&
(this._lastUpdate=`${a.serviceUpdateTimeStamp.lastUpdate}`);this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1;this._init(b)}var g=p.prototype;g._init=function(a){if("page"===a.type){var b=a.rootPage;this._urlPrefix=a.urlPrefix;this._nodesPerPage=a.pageSize;switch(a.lodMetric){case "maxScreenThreshold":this._lodMetric=r.LodMetric.MaxScreenThreshold;break;case "maxScreenThresholdSQ":this._lodMetric=r.LodMetric.MaxScreenThreshold,this._lodConversion=Q}if(this._isEditable){this._rootIndex=
-1;var c=A(a.rootIndex,a.pageSize);c=b.nodes[c];c={nodes:[{index:this._rootIndex,children:[a.rootIndex],mesh:void 0,obb:c.obb,lodThreshold:c.lodThreshold}]};this._addPage(C(this._rootIndex,this._nodesPerPage),c)}else this._rootIndex=a.rootIndex;this._addPage(C(a.rootIndex,this._nodesPerPage),b);this._updateParentsAndLevel()}else"node"===a.type&&(this._urlPrefix=a.urlPrefix,this._nodePages.push(D()),this._isEditable?(this._clientNodePage=D(),b={id:"-1",version:null,mbs:a.rootNode.mbs,obb:a.rootNode.obb,
sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:a.rootNode.mbs,obb:a.rootNode.obb}]},this._rootIndex=this._makeClientRefNode(new r.NodeBase(b.id,null),null),(b=this._validateNode(b.id,b))&&this._addNode(b,-1)):this._rootIndex=this._makeRefNode(new r.NodeBase(a.rootNode.id,null),-1),(a=this._validateNode(a.rootNode.id,a.rootNode))&&this._addNode(a,0))};g._loadPage=function(a){this._loading.add(a);this._streamDataController.request(this._urlPrefix+
a,"json").then(b=>{this._pageQueue.push({pageIndex:a,page:b})}).catch(b=>{this._loading.delete(a);H.isAbortError(b)||(this._failedPages.add(a),this._logger.error("#loadPage()",this._layer,`Error when loading page ${a}`,b))})};g._addQueuedPages=function(a){for(;0<this._pageQueue.length&&!a.done;){const {pageIndex:b,page:c}=this._pageQueue.shift();this._addPage(b,c);this._loading.delete(b);a.madeProgress()}this._updateParentsAndLevel()};g._addPage=function(a,b){const c=[],f=[];b=b.nodes.map((d,h)=>
{const k=c.length,q=d.children?d.children.length:0;f.push(this._rootIndex);for(var u=0;u<q;u++)c.push(d.children[u]);const l=`${d.index}`;u=I.clone(d.obb);const m=N.fromValues(u.center[0],u.center[1],u.center[2],M.length(u.halfSize));var x=d.mesh&&d.mesh.attribute;const n=d.mesh&&d.mesh.geometry;var w=d.mesh&&d.mesh.material;x={hasSharedResource:!1,hasFeatureData:!!n,attributes:x&&null!=x.resource?`${x.resource}`:void 0,geometry:n&&null!=n.resource?`${n.resource}`:void 0,texture:w&&null!=w.resource?
`${w.resource}`:void 0,geometryDefinition:n?n.definition:-1,materialDefinition:w?w.definition:-1};w=r.Node;var y=this._nodesPerPage;h=-1===a?-(h+1):0===y?h:a*y+h;d=new w(l,h,m,q,0,x,this._lastUpdate,this._lodMetric,this._lodConversion(d.lodThreshold),n?n.featureCount:null);d.serviceObb=u;d.visibilityObb=this._computeVisibilityObb(d);d.vertexCount=n?n.vertexCount:0;return new F(k,q,t.addWraparound(this._visibilityCacheVersion,-2),null,d)});if(-1===a)this._clientNodePage=D(b,c,f);else{for(let d=this._nodePages.length;d<
a;d++)this._nodePages[d]=null;this._nodePages[a]=D(b,c,f)}this._nodeCount+=b.length};g._updateParentsAndLevel=function(){const a=[],b=(c,f,d)=>{const h=this._getPage(c);if(e.isSome(h)){const k=A(c,this._nodesPerPage);h.parents[k]=e.isSome(f)?f:-1;f=h.nodes[k].node;e.isSome(f)&&(f.level=d,a.push(c))}};for(b(this._rootIndex,null,0);a.length;){const c=a.pop(),f=this.getNode(c);if(e.isSome(f))for(let d=0;d<f.childCount;d++){const h=this.getChildIndex(f.index,d);b(h,c,f.level+1);this._maxLevel=Math.max(this._maxLevel,
f.level+1)}}};g._getPage=function(a){a=C(a,this._nodesPerPage);return 0>a?this._clientNodePage:this._nodePages[a]};g._getNodeInternal=function(a){const b=this._getPage(a);return e.isNone(b)?null:b.nodes[A(a,this._nodesPerPage)]};g._addNode=function(a,b){null!=a.children&&this.populateChildren(b,a.children);var c=this.getParent(b);c=e.isSome(c)?c.level+1:0;this._maxLevel=Math.max(this._maxLevel,a.children?c+1:c);const {lodMetric:f,maxError:d}=K(a.lodSelection),h=e.unwrap(this._getNodeInternal(b));
h.node=new r.Node(a.id,b,a.mbs,h.childCount,c,a.resources,a.version,f,d,a.numFeatures);a.obb&&(h.node.serviceObb=I.clone(a.obb));h.node.visibilityObb=this._computeVisibilityObb(h.node);e.isSome(h.ref)&&(null==h.ref.mbs&&(h.ref.mbs=a.mbs),h.node.renderMbs=h.ref.renderMbs,h.node.serviceObbInRenderSR=h.ref.serviceObbInRenderSR,h.ref.visibilityObb=h.node.visibilityObb);return h.node};g._makeRefNode=function(a,b){const c=this._nodePages[0];if(null==c)return-1;const f=c.nodes.length;c.nodes.push(new F(0,
0,t.addWraparound(this._visibilityCacheVersion,-2),a,null));this._nodeCount++;c.parents.push(b);t.invalidateMbs(a.renderMbs);t.invalidateObb(a.serviceObbInRenderSR);return f};g._makeClientRefNode=function(a,b){const c=this._clientNodePage;if(null==c)return-1;const f=-(c.nodes.length+1);c.nodes.push(new F(0,0,t.addWraparound(this._visibilityCacheVersion,-2),a,null));this._nodeCount++;c.parents.push(e.isSome(b)?b:-1);t.invalidateMbs(a.renderMbs);t.invalidateObb(a.serviceObbInRenderSR);return f};g.populateChildren=
function(a,b){var c=e.unwrap(this._getNodeInternal(a));const f=e.unwrap(this._getPage(a));c.childOffset=f.children.length;c.childCount=b.length;for(c=0;c<b.length;c++){const d=this._makeRefNode(b[c],a);f.children.push(d)}};g.getNode=function(a){a=this._getNodeInternal(a);return e.isSome(a)?a.node:null};g.getIndexById=function(a){let b;this._forAllNodes((c,f)=>{e.isSome(c.node)&&c.node.id===a?b=f:e.isSome(c.ref)&&c.ref.id===a&&(b=f)});return b};g.getNodeById=function(a){a=this.getIndexById(a);return null!=
a&&0<=a?this.getNode(a):null};g.getChildIndex=function(a,b){const c=this._getPage(a);if(e.isNone(c))return-1;a=c.nodes[A(a,this._nodesPerPage)];return c.children[a.childOffset+b]};g.getParentIndex=function(a){const b=this._getPage(a);return e.isSome(b)&&a!==this._rootIndex?b.parents[A(a,this._nodesPerPage)]:null};g.getParent=function(a){a=this.getParentIndex(a);return e.isSome(a)?this.getNode(a):null};g.isLeaf=function(a){a=this._getNodeInternal(a);return e.isSome(a)&&0===a.childCount};g.removeAllGeometryObbs=
function(){this._forAllNodes(a=>{e.isSome(a.node)&&(a.node.geometryObb=null)})};g.invalidateVisibilityCache=function(){this._visibilityCacheVersion=t.addWraparound(this._visibilityCacheVersion,2)};g.invalidateNodeVisibilityCache=function(a){a=this._getNodeInternal(a);e.isSome(a)&&this.invalidateNodeVisibilityCacheInternal(a)};g.invalidateNodeVisibilityCacheInternal=function(a){a.visibilityCache=t.addWraparound(this._visibilityCacheVersion,-2)};g.invalidateBoundingVolumeCache=function(a){a=this._getNodeInternal(a);
e.isSome(a)&&(J(a),this.invalidateNodeVisibilityCacheInternal(a))};g.updateElevationChanged=function(a){const b=this._getNodeInternal(a);e.isNone(b)||(this.needNodeElevationRange?(a=e.isSome(b.node)?b.node:b.ref,e.isNone(a)||(a=a.elevationRange,e.isNone(a)||(a.valid=!1))):this.invalidateBoundingVolumeCache(a))};g.invalidateGeometryVisibility=function(a){a=this._getNodeInternal(a);e.isSome(a)&&e.isSome(a.node)&&(a.node.geometryObb=null,t.invalidateMbs(a.node.renderMbs),t.invalidateObb(a.node.serviceObbInRenderSR))};
g.invalidateVisibilityObbs=function(){e.isNone(this.rootNode)||this.traverse(this.rootNode,a=>{a.visibilityObb=this._computeVisibilityObb(a);a.geometryObb=null;return!0})};g._updateElevationRange=function(a){var b=this._getNodeInternal(a);if(e.isNone(b))return null;const c=e.isSome(b.node)?b.node:b.ref;if(e.isNone(c))return null;const f=c.elevationRange;if(e.isSome(f)&&f.valid)return f;const d=new r.ElevationRange;let h=!1;for(let k=0;k<b.childCount;k++){const q=this._updateElevationRange(this.getChildIndex(a,
k));e.isNone(q)?h=!0:(d.min=Math.min(d.min,q.min),d.max=Math.max(d.max,q.max))}if(0===b.childCount||h&&e.isSome(b.node)&&b.node.resources.geometry)b=this._viewportQueries.getElevationRange(c),e.isSome(b)&&(d.min=Math.min(d.min,b.min),d.max=Math.max(d.max,b.max));if(e.isSome(f)&&f.min===d.min&&f.max===d.max)return f.valid=!0,f;d.valid=!0;c.elevationRange=d;this.invalidateBoundingVolumeCache(a);return d};g.isNodeVisible=function(a){const b=this._getNodeInternal(a);if(e.isNone(b)||e.isSome(b.ref)&&!b.ref.mbs)return!0;
this.needNodeElevationRange&&this._updateElevationRange(a);if((b.visibilityCache&-2)!==this._visibilityCacheVersion){a=b.node;const f=e.isSome(a)&&(e.isNone(b.ref)||e.isSome(a.visibilityObb))?a:e.isSome(b.ref)?b.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(e.isSome(a)||e.isSome(b.ref))&&b.filterImpact===r.NodeFilterImpact.NotChecked){var c=e.isSome(a)?a.mbs:e.isSome(b.ref)?b.ref.mbs:null;b.filterImpact=null!=c?this._computeNodeFiltering(c):r.NodeFilterImpact.Unmodified}c=e.isSome(a)&&
b.filterImpact===r.NodeFilterImpact.Culled;a=!(e.isSome(a)&&a.imModificationImpact===r.NodeIMModificationImpact.Culled)&&(!f||this._viewportQueries.isNodeVisible(f))&&!c;b.visibilityCache=this._visibilityCacheVersion+(a?1:0);return a}return 1===(b.visibilityCache&1)};g.isGeometryVisible=function(a){if(!this.isNodeVisible(a))return!1;a=this._getNodeInternal(a);return e.isSome(a)&&e.isSome(a.node)&&e.isSome(a.node.geometryObb)&&(!this.layerHasModifications||a.node.imModificationImpact!==r.NodeIMModificationImpact.NotChecked)?
this._viewportQueries.isGeometryVisible(a.node):!0};g._traverseCoverage=function(a,b,c,f,d){a=this._getPage(a);if(!e.isNone(a)&&0!==b.childCount){var h=b.childOffset+b.childCount,k=[];for(b=b.childOffset;b<h;++b){const q=a.children[b],u=this._getNodeInternal(q);e.isSome(u)&&e.isSome(u.node)&&this.isGeometryVisible(q)&&k.push(u)}f/=k.length;for(const q of k)a=e.unwrap(q.node).index,this._isLoaded(a)||this._isReloading(a)?(d.delta=Math.max(d.delta,c),d.coverage+=f):this._traverseCoverage(a,q,c+1,f,
d)}};g.useNodeAsHole=function(a){if("off"===this.holeFilling)return!1;const b=this._getNodeInternal(a);if(e.isNone(b))return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);const c={delta:0,coverage:0};this._traverseCoverage(a,b,0,1,c);a=.5>=c.delta*c.coverage;b.useAsHole=this._version+(a?1:0);return a};g.destroy=function(){this._updates.add.prune();this._updates.update.prune()};g.requestUpdate=function(){this._dirty=!0;this._indexMissing=1;
this._version=t.addWraparound(this._version,2)};g.imModificationsChanged=function(a){this.layerHasModifications=a;this._forAllNodes(({node:b})=>{e.isSome(b)&&(b.imModificationImpact=r.NodeIMModificationImpact.NotChecked,b.visibilityObb=this._computeVisibilityObb(b),b.hasModifications&&this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()};g.layerFilterChanged=function(a){this._layerHasFilter=a;this._forAllNodes(b=>{e.isSome(b)&&(b.filterImpact=r.NodeFilterImpact.NotChecked,
b=b.node,e.isSome(b)&&this.invalidateNodeVisibilityCache(b.index))});this.invalidateVisibilityCache()};g.update=function(a,b,c){if(this._dirty){0<this._pageQueue.length&&this._addQueuedPages(b);this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();this._updates.reset(a);v.clear();var f=!0,d=new G,h=new G,k=this._imModificationUncategorized;k.clear();var q=new Set;this.traverseVisible((l,m,x)=>{if(e.isNone(m))m=this._entryPriority(l),Infinity===
m&&(m=this._entryPriority(x)),l=C(l,this._nodesPerPage),v.set(l,Math.max(m,v.get(l)||0)),this._loading.has(l)||this._failedPages.has(l)||this._missing.push(l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m);else{var n=m.node;this._updateNodeFeatureEstimate(n,h);if(e.isNone(n))m=this._entryPriority(l),this._loading.has(l)||this._failedNodes.has(l)||(this._missing.push(l),v.set(l,m)),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m);else{x=e.unwrap(this._getPage(l));if(0===this._missing.length&&
0===this._nodesPerPage)for(let w=0;w<m.childCount;w++){const y=x.children[m.childOffset+w],L=this._getNodeInternal(y);!e.isSome(L)||L.node||this._loading.has(y)||this._failedNodes.has(y)||(v.set(y,this._entryPriority(y)),this._prefetch.push(y))}n.failed||!n.resources.hasFeatureData?f&&0<m.childCount&&this._isSelected(n)&&(f=!1):(q.add(n.id),this._isLoaded(l)?(d.known+=n.memory,++d.knownNodes,this._isSelected(n)?0<m.childCount&&(f=!1):(d.unremoved+=n.memory,f=!1),this._needsUpdate(n)&&(m=this._entryPriority(l),
v.set(l,m),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m),this._updates.update.push(l))):(n.memory&&(d.known+=n.memory,++d.knownNodes),this._isSelected(n)?(0<m.childCount&&(f=!1),n.memory?(d.missing+=n.memory,d.known+=n.memory,++d.knownNodes):++d.missingNodes,a.includes(n.index)?(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(l)),this._updates.cancel=this._updates.cancel.filter(w=>w!==n.index)):!b.done&&this._enable(n)?b.madeProgress():(m=this._entryPriority(l),
v.set(l,m),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,m),this._updates.add.push(l),this.layerHasModifications&&c&&e.isSome(n)&&n.imModificationImpact===r.NodeIMModificationImpact.NotChecked&&k.push(l))):this._isReloading(l)&&this._updates.remove.push(l)))}}});var u=this._updates.add;0<u.length&&this.layerHasModifications&&(0<k.length&&c?.(k),u.filterInPlace(l=>{var m=this._getNodeInternal(l);(m=e.isNone(m)||e.isNone(m.node)||m.node.imModificationImpact!==r.NodeIMModificationImpact.Culled)||
this.invalidateNodeVisibilityCache(l);return m}));this._unloadedMemoryEstimate=d.missing-d.unremoved;3<d.knownNodes&&0<d.missingNodes&&(this._unloadedMemoryEstimate+=d.known/d.knownNodes*d.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(h);this._featureEstimate.leavesReached=f;this._missing.sort((l,m)=>l-m);this._missing.filterInPlace((l,m)=>1>m||this._missing.data[m-1]!==l);this._missing.sort((l,m)=>
v.get(l)-v.get(m));0<this._missing.length&&(this._maxUnloadedPrio=v.get(this._missing.back()),this._prefetch.clear());this._updates.add.filterInPlace(l=>v.get(l)>=this._maxUnloadedPrio).sort((l,m)=>v.get(l)-v.get(m));this._updates.update.sort((l,m)=>v.get(l)-v.get(m));this._indexMissing=this._loading.size+this._missing.length;this._dirty=0<this._indexMissing;v.clear()}};g.checkFeatureTarget=function(a,b){const c=this._viewportQueries.updateScreenSpaceErrorBias(b);let f=b,d=b,h=c,k=10;for(;k--;){const q=
new G;this._updateFeatureEstimate(f,q);if(this._computeFeatureEstimate(q)<=a){if(f>=b||0<q.missingNodes||0===k)break;h=f;f=.5*(f+d)}else d=f,f=.5*(f+h)}this._version=t.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,f)};g._updateFeatureEstimate=function(a,b){this._version=t.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible((c,f)=>this._updateNodeFeatureEstimate(e.isSome(f)?f.node:void 0,b))};
g._updateNodeFeatureEstimate=function(a,b){e.isNone(a)||a.failed||e.isNone(a.numFeatures)||(this._isLoaded(a.index)?(b.known+=a.numFeatures,++b.knownNodes,this._isSelected(a)||(b.unremoved+=a.numFeatures)):this._isSelected(a)&&(e.isSome(a.numFeatures)?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};g._computeFeatureEstimate=function(a){let b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)};g.load=
function(){return this._load(this._missing)};g.prefetch=function(){this._prefetch.sort((a,b)=>v.get(a)-v.get(b));return this._load(this._prefetch)};g._load=function(a){if(0===a.length||!this._canRequest())return!1;for(;0<a.length&&this._canRequest();)0===this._nodesPerPage?this._loadNode(a.pop()):this._loadPage(a.pop());return!0};g.nodeTraversalState=function(a){if(e.isNone(a))return null;let b=this._nodeTraversalState.get(a.index);if(b&&(b.version&-2)===this._version)return b;const c=this._viewportQueries.getLodLevel(a),
f=this._viewportQueries.hasLOD(a);var d=!0;f?(d=this.getParentIndex(a.index),e.isSome(d)?(d=this._nodeTraversalState.get(d),d=!!d&&c>d.lodLevel):d=0<c):d=0===a.childCount;if(b)return b.lodLevel=c,b.isChosen=d,b.version=this._version+1,b;b=new r.NodeTraversalState(f,d,c,this._version+1);this._nodeTraversalState.set(a.index,b);return b};g._loadNode=function(a){this._loading.add(a);const b=e.unwrap(this._getNodeInternal(a)).ref;if(e.isNone(b))this._failedNodes.add(a);else{var c=b.id,f=this._urlPrefix+
c,d=()=>{this._loading.delete(a);0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this._streamDataController.request(f,"json").then(h=>{d();h=this._validateNode(c,h);null!=h&&(h.obb&&this.invalidateNodeVisibilityCache(a),h=this._addNode(h,a),this.nodeTraversalState(h))},h=>{d();H.isAbortError(h)||(this._logger.error("#loadNode()",this._layer,"Error loading node: "+f),this._failedNodes.add(a))})}};g._validateNode=function(a,b){if(null==b||"object"!==typeof b||b.id!==a)return this._logger.error("#validateNode()",
this._layer,`Invalid node. Wrong type or wrong id "${a}"`),null;if(!Array.isArray(b.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${a}.`),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${a}"`);var c=b.geometryData;null==c||Array.isArray(c)&&0===c.length||Array.isArray(c)&&1===c.length&&"./geometries/0"===c[0].href||
this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${a}"`);c=b.attributeData;const f=this._layer.attributeStorageInfo;null==c||Array.isArray(c)&&!c.some((k,q)=>k.href!==`./attributes/${f?.[q]?.key??`f_${q}`}/0`)||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${a}"`);b.featureData&&1<b.featureData.length&&this._logger.warn("#validateNode()",this._layer,`Node ${a} has ${b.featureData.length} bundles. Only the first bundle will be loaded.`);
c=b.hasOwnProperty("obb")&&!this.ignoreServiceObb?b.obb:null;const d=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+1:void 0;var h=k=>{if(null==k)return null;var q=u=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${a}: ${u}`);if("number"===typeof k.id)q(`id ${k.id} is a number instead of a string.`);else if("string"!==typeof k.id||!Array.isArray(k.mbs))return q("Missing or invalid id."),
null;if(!Array.isArray(k.mbs))return q(`Invalid bounding volume on reference ${k.id}.`),null;k.href&&k.href!=="../"+k.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${a}"`);q=k.hasOwnProperty("obb")&&!this.ignoreServiceObb?k.obb:null;k=new r.NodeBase(`${k.id}`,k.mbs);k.serviceObb=q;k.visibilityObb=this._computeVisibilityObb(k);return k};h=Array.isArray(b.children)?b.children.map(h).filter(k=>null!=k):null;return{id:a,mbs:b.mbs,obb:c,children:h,resources:{hasFeatureData:b.featureData&&
0<b.featureData.length,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:void 0,texture:b.textureData&&0<b.textureData.length?a:void 0,geometry:null!=b.geometryData?a:void 0},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:d}};g.resetFailedNodes=function(){this._failedNodes.clear();this._failedPages.clear();this._forAllNodes(a=>{e.isSome(a.node)&&(a.node.failed=!1)})};g._entryPriority=function(a){var b=
this._getNodeInternal(a),c=this.getParentIndex(a);if(e.isNone(b)||e.isNone(c)&&null==b.node)return e.isNone(c)?Infinity:this._entryPriority(c);let f=0;b.node&&e.isSome(c)&&(c=this._nodeTraversalState.get(c),null!=c&&(f=c.lodLevel));for(c=this.progressiveLoadPenalty;e.isSome(a);a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=e.isSome(b.ref)?this._viewportQueries.distToPOI(b.ref):e.isSome(b.node)?this._viewportQueries.distToPOI(b.node):0;return-b-f*(b+this.progressiveLoadPenalty)+c};g.traverseVisible=
function(a){const b=this._getNodeInternal(this._rootIndex);e.isNone(b)?a(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,null,b,a)};g._traverseVisible=function(a,b,c,f){if(c.node&&0===c.childCount)this.isGeometryVisible(a)&&f(a,c,b);else if(this.isNodeVisible(a)&&(f(a,c,b),null!=c.node&&(b=this.nodeTraversalState(c.node),!b?.nodeHasLOD||b.lodLevel!==this._maxLodLevel))){b=e.unwrap(this._getPage(a));for(let d=0;d<c.childCount;d++){const h=b.children[c.childOffset+d],k=this._getNodeInternal(h);
e.isSome(k)?this._traverseVisible(h,a,k,f):f(h,null,a)}}};g.traverse=function(a,b){b(a)&&this.traverseChildren(a,b)};g.traverseChildren=function(a,b){a=a.index;const c=this._getNodeInternal(a);e.isSome(c)&&this._traverseChildren(a,c,b)};g._traverseChildren=function(a,b,c){a=this._getPage(a);if(!e.isNone(a)){var f=b.childOffset+b.childCount;for(b=b.childOffset;b<f;++b){const d=a.children[b],h=this._getNodeInternal(d);e.isSome(h)&&e.isSome(h.node)&&c(h.node)&&this._traverseChildren(d,h,c)}}};g.updateChildrenLoaded=
function(a,b){for(a=this.getNode(a);e.isSome(a);)a.childrenLoaded+=b,a=this.getParent(a.index)};g.checkChildrenLoadedInvariant=function(){if(e.isNone(this.rootNode))return!0;const a=[],b=c=>{let f=this._isLoaded(c.index)||this._isReloading(c.index)?1:0;this.traverseChildren(c,d=>{f+=b(d);return!1});c.childrenLoaded!==f&&a.push(c.index);return f};b(this.rootNode);a.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+a.join(","));return 0<a.length};g.updateStats=function(a){0<
this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);if(this._indexMissing||0<this._prefetch.length)a.index+=" + "+this._indexMissing||this._prefetch.length;a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){const b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};g.updateElevationInfo=function(a,b){this.needNodeElevationRange=b&&!!a&&("relative-to-ground"===a.mode||"on-the-ground"===a.mode);this._viewportQueries.updateElevationInfo(a);
this.invalidateAllElevationRanges()};g.invalidateAllElevationRanges=function(){this._forAllNodes(a=>{J(a);e.isSome(a.node)&&(a.node.elevationRange=null);e.isSome(a.ref)&&(a.ref.elevationRange=null)})};g._forAllNodes=function(a){if(null!=this._clientNodePage){var b=this._clientNodePage;for(var c=0;c<b.nodes.length;c++)a(b.nodes[c],-(c+1))}for(b=0;b<this._nodePages.length;b++)if(c=this._nodePages[b]){const f=b*this._nodesPerPage;for(let d=0;d<c.nodes.length;d++)a(c.nodes[d],f+d)}};B._createClass(p,
[{key:"rootNode",get:function(){return this.getNode(this._rootIndex)}},{key:"size",get:function(){return this._nodeCount}},{key:"isEditable",get:function(){return this._isEditable}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"isLoading",get:function(){return 0<this._indexMissing}},{key:"isPrefetching",get:function(){return 0<this._prefetch.length}},{key:"indexLoading",get:function(){return this._loading.size}},{key:"indexMissing",get:function(){return this._indexMissing}},
{key:"unloadedMemoryEstimate",get:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"maxPriority",get:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"test",get:function(){return{addNode:(a,b)=>this._addNode(a,b)}}}]);return p}();const v=new Map;let R=function(){function p(g){this.missing=g;this.update=new z({deallocator:null});this.add=new z({deallocator:null});
this.remove=new z({deallocator:null});this.cancel=[]}p.prototype.reset=function(g){this.add.clear();this.update.clear();this.cancel=g};return B._createClass(p)}();const P=[["maxScreenThreshold",r.LodMetric.MaxScreenThreshold],["screenSpaceRelative",r.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",r.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",r.LodMetric.DistanceRangeFromDefaultCamera]];let G=B._createClass(function(){this.unremoved=this.missingNodes=this.missing=
this.knownNodes=this.known=0});E.I3SIndex=S;E.selectErrorMetric=K;Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});