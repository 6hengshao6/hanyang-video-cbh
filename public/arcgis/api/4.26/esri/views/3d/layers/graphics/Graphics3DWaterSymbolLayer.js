// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../core/maybe ../../../../core/unitUtils ../../../../chunks/earcut ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec4 ../../../../chunks/common ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/DoubleArray ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./polygonUtils ../../support/renderInfoUtils/polygon ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/WaterMaterial ../../webgl-engine/materials/internal/waterMaterialUtils".split(" "),
function(B,h,G,k,H,C,I,w,J,K,l,z,x,L,n,M,N,O,t,q,D,P,Q,E,R){const S=["polyline","polygon","extent"];t=function(g){function f(a,b,c,d){return u.call(this,a,b,c,d)}h._inherits(f,g);var u=h._createSuper(f);g=f.prototype;g.doLoad=async function(){};g.destroy=function(){h._get(h._getPrototypeOf(f.prototype),"destroy",this).call(this);this._context.stage.remove(this._material);this._material=null};g.createGraphics3DGraphic=function(a){a=a.graphic;if(!this._validateGeometry(a.geometry,S,this.symbolLayer.type))return null;
const b=this.setGraphicElevationContext(a,new M.ElevationContext);this.ensureDrapedStatus("on-the-ground"===b.mode);this.ensureMaterial();return this.draped?this._createAsOverlay(a):this._createAs3DShape(a,b,a.uid)};g.ensureMaterial=function(){if(!k.isSome(this._material)){var a=new E.WaterMaterialParameters,b=this.symbolLayer.color;k.isSome(b)&&(a.color=G.toUnitRGBA(b));b=this._getCombinedOpacity(b,{hasIntrinsicColor:!0});a.color=[a.color[0],a.color[1],a.color[2],b];a.transparent=1>b||this.needsDrivenTransparentPass;
a.waveDirection=k.isSome(this.symbolLayer.waveDirection)?f.headingVectorFromAngle(this.symbolLayer.waveDirection):w.fromValues(0,0);b=R.wavePresets[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];a.waveStrength=b.waveStrength;a.waveTextureRepeat=b.textureRepeat;a.waveVelocity=b.waveVelocity;a.flowStrength=b.perturbationStrength;a.hasSlicePlane=this._context.slicePlaneEnabled;a.isDraped=this.draped;this._material=new E.WaterMaterial(a);this._context.stage.add(this._material)}};g.layerOpacityChanged=
function(){if(!k.isNone(this._material)){var a=this._material.parameters.color,b=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});this._material.setParameters({color:[a[0],a[1],a[2],b],transparent:1>b||this.needsDrivenTransparentPass})}};g.layerElevationInfoChanged=function(a,b,c){const d=this._elevationContext.mode;c=n.elevationModeChangeUpdateType(f.elevationModeChangeTypes,c,d);if(c!==n.SymbolUpdateType.UPDATE)return c;const e=n.needsElevationUpdates2D(d);return this.updateGraphics3DGraphicElevationInfo(a,
b,()=>e)};g.slicePlaneEnabledChanged=function(){k.isSome(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};g.physicalBasedRenderingChanged=function(){return!0};g._createAs3DShape=function(a,b,c){a=q.geometryAsPolygon(a.geometry);if(k.isNone(a))return null;var d=D.geometryToRenderInfo(a,this._context.elevationProvider,this._context.renderCoordsHelper,b);const e=d.position.length/3,r=x.newDoubleArray(2*e);this._createUVCoordsFromVertices(r,d.mapPositions,
e,this._context.elevationProvider.spatialReference);d=new T(d,r);this._create3DShapeGeometries(d);this._logGeometryCreationWarnings(d.renderData,a.rings,"rings","WaterSymbol3DLayer");if(0===d.outGeometries.length)return null;c=new P.Object3D({geometries:d.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:c}});c=new O.Graphics3DObject3DGraphicLayer(this,c,d.outGeometries,null,null,L.perVertexElevationAligner,b);c.alignedSampledElevation=d.renderData.sampledElevation;
c.needsElevationUpdates=n.needsElevationUpdates2D(b.mode);return c};g._createUVCoordsFromVertices=function(a,b,c,d){d=H.getMetersPerUnitForSR(d);z.empty(m);for(var e=0;e<c;e++)I.set(F,b[3*e],b[3*e+1]),z.expandPointInPlace(m,F);J.scale(m,m,d);e=m[1]%f.unitSizeOfTexture;y[0]=m[0]-m[0]%f.unitSizeOfTexture;y[1]=m[1]-e;for(e=0;e<c;e++)a[2*e]=(b[3*e]*d-y[0])/f.unitSizeOfTexture,a[2*e+1]=(b[3*e+1]*d-y[1])/f.unitSizeOfTexture};g._create3DShapeGeometries=function(a){var b=a.renderData.polygons;const c=a.uvCoords;
for(const {count:d,index:e,position:r,mapPositions:v,holeIndices:A}of b){if(k.isSome(this._context.clippingExtent)&&(l.empty(p),l.expandWithBuffer(p,v),!l.intersectsClippingArea(p,this._context.clippingExtent)))continue;b=C.earcut(v,A,3);if(0===b.length)continue;const U=x.doubleSubArray(c,2*e,2*d);b=q.createWaterGeometry({material:k.unwrap(this._material),indices:b,mapPositions:v,attributeData:{position:r,uv0:U}});a.outGeometries.push(b)}};g._createAsOverlay=function(a){const b=q.geometryAsPolygon(a.geometry);
if(k.isNone(b))return null;k.unwrap(this._material).renderPriority=this._renderPriority;const c=D.geometryToRenderInfoDraped(b,this._context.overlaySR),d=c.position.length/3,e=x.newDoubleArray(2*d);this._createUVCoordsFromVertices(e,c.position,d,this._context.overlaySR);a=new V(c,e,this._context.layer.uid,a.uid);a.outBoundingBox=l.empty();this._createAsOverlayWater(a);this._logGeometryCreationWarnings(a.renderData,b.rings,"rings","WaterSymbol3DLayer");return 0===a.outGeometries.length?null:new N(this,
a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)};g._createAsOverlayWater=function(a){const b=a.uvCoords;var c=a.renderData.polygons;for(const {position:d,holeIndices:e,index:r,count:v}of c){l.empty(p);l.expandWithBuffer(p,d);if(!l.intersectsClippingArea(p,this._context.clippingExtent))continue;l.expandWithAABB(a.outBoundingBox,p);c=C.earcut(d,e,3);if(0===c.length)continue;const A=x.doubleSubArray(b,2*r,2*v);c=q.createWaterGeometry({material:k.unwrap(this._material),indices:c,attributeData:{position:d,
uv0:A}});a.outGeometries.push(new Q.RenderGeometry(c,a))}};f.headingVectorFromAngle=function(a){const b=w.create();a=K.toRadian(a);b[0]=Math.sin(a);b[1]=Math.cos(a);return b};g.test=function(){return{...h._get(h._getPrototypeOf(f.prototype),"test",this).call(this),create3DShape:a=>this._createAs3DShape(a.graphic,a.elevationContext,a.graphicUid),ensureMaterial:()=>this.ensureMaterial()}};return h._createClass(f)}(t.Graphics3DSymbolLayer);t.unitSizeOfTexture=100;t.elevationModeChangeTypes={definedChanged:n.SymbolUpdateType.RECREATE,
staysOnTheGround:n.SymbolUpdateType.NONE,onTheGroundChanged:n.SymbolUpdateType.RECREATE};const y=w.create(),m=z.create(),F=w.create(),p=l.create();let T=function(g){function f(a,b){a=u.call(this,a,null,null);a.uvCoords=b;return a}h._inherits(f,g);var u=h._createSuper(f);return h._createClass(f)}(q.PolygonCreationDataBase),V=function(g){function f(a,b,c,d){a=u.call(this,a,c,d);a.uvCoords=b;return a}h._inherits(f,g);var u=h._createSuper(f);return h._createClass(f)}(q.PolygonCreationDataBase);B.Graphics3DWaterSymbolLayer=
t;Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});