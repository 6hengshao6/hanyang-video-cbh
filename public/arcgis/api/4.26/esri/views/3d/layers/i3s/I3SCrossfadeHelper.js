// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define(["exports","../../../../chunks/_rollupPluginBabelHelpers","../../../../core/maybe","../../../../core/scheduling","../support/I3SLayerView"],function(m,p,g,q,l){let r=p._createClass(function(){this.lodCrossfadeSignedDuration=0}),u=function(){function n(a){this._view=a;this._currentFrameStartTime=this._preRenderFrameTaskHandle=null;this._numFadingNodes=0}var f=n.prototype;f.destroy=function(){this._preRenderFrameTaskHandle?.remove();this._view=this._preRenderFrameTaskHandle=null};f.stopNodeFading=
function(a){null!=a.lodCrossfadeProgress&&(this._numFadingNodes--,a.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=g.removeMaybe(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))};f._startNodeFading=function(a,b,e){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=q.addFrameTask({preRender:d=>this._updateAllNodeFading(d)}),this._view.notifyLODUpdate());null==a.lodCrossfadeProgress&&
(this._numFadingNodes++,this._view.notifyUpdate());a.lodCrossfadeSignedDuration=e;a.lodCrossfadeProgress=b};f._updateAllNodeFading=function(a){const b=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode((e,d)=>{if(g.isSome(d)&&g.isSome(d.lodCrossfadeProgress)){const c=d.lodCrossfadeSignedDuration,h=d.lodCrossfadeProgress+Math.abs(a.deltaTime/c),k=!b||1<=h||0===c,t=(0<c?this._view.fullOpacity:0)-(k?0:0<c?1:-1)*(1-h);k?(this.stopNodeFading(d),0>c&&this._view.markNodeToRemove(e)):d.lodCrossfadeProgress=
h;this._view.setNodeOpacityByIndex(e,t)}});this._view.removeMarkedNodes()};f.stopAllNodeFading=function(){this._view.foreachCrossfadeNode((a,b)=>{g.isSome(b)&&g.isSome(b.lodCrossfadeProgress)&&(this.stopNodeFading(b),b=b.lodCrossfadeSignedDuration,0>b&&this._view.markNodeToRemove(a),this._view.setNodeOpacityByIndex(a,0<b?this._view.fullOpacity:0))});this._view.removeMarkedNodes()};f.fadeNode=function(a,b,e,d){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());var c=this._view;
const h=c.nodeCrossfadingEnabled,k=e===l.FadeDirection.FadeIn?c.fullOpacity:0;d=h?d?e===l.FadeDirection.FadeIn?c.lodCrossfadeinDuration:c.lodCrossfadeoutDuration:c.lodCrossfadeUncoveredDuration:0;c=this._view.getNodeOpacityByIndex(a);h&&c!==k&&0<d?this._startNodeFading(b,1-Math.abs(k-c),(e===l.FadeDirection.FadeIn?1:-1)*d):(this.stopNodeFading(b),this._view.setNodeOpacityByIndex(a,k),e===l.FadeDirection.FadeOut&&this._view.removeNode(a))};f.isNodeFullyFadedIn=function(a){const b=this._view.getNodeCrossfadeMetaData(a);
return g.isNone(b)||null==b.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(a)===this._view.fullOpacity};p._createClass(n,[{key:"updating",get:function(){return 0<this._numFadingNodes}}]);return n}();m.I3SCrossfadeHelper=u;m.NodeCrossfadeMetaData=r;Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});