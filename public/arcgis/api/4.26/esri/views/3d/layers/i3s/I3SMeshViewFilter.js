// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/maybeUpdating ../../../../core/reactiveUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../core/sql/WhereClause ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/DoubleArray ../../../../geometry/support/Ellipsoid ../../../../geometry/support/spatialReferenceUtils ../../../../chunks/sphere ../../../../geometry/support/webMercatorUtils ../../../../layers/support/FeatureFilter ./I3SUtil ../../../../geometry/SpatialReference".split(" "),
function(aa,t,G,u,ta,ba,O,ca,da,h,x,ea,fa,v,ua,va,ha,w,ia,y,ja,H,ka,la,P,ma,Q,na,R,S){function F(e,c,f){if(h.isNone(c))return null;if("disjoint"===f&&"polygon"===c.type){f=c.rings.length;const a=c.spatialReference,b=Array(f);for(let d=0;d<f;++d){const g=H.fromValues(Infinity,Infinity,-Infinity,-Infinity);H.expandWithNestedArray(g,c.rings[d]);b[d]={type:"polygon",rings:[c.rings[d]],spatialReference:a,cache:{},aabr:g}}b.sort((d,g)=>d.aabr[0]-g.aabr[0]);const p=new Set,k=new O.PositionHint;for(c=0;c<
b.length;++c){const d=b[c],g=d.aabr[0];p.forEach(l=>{g>=l.aabr[2]?p.delete(l):d.aabr[1]>l.aabr[3]||d.aabr[3]<l.aabr[1]||!e.intersects(d,l)||(d.rings=d.rings.concat(l.rings),H.expand(d.aabr,l.aabr,d.aabr),d.cache={},p.delete(l),l=O.indexOf(b,l,b.length,k),b.splice(l,1))});p.add(d)}for(const d of b)d.aabr=void 0;return b}return[c]}function T(e,c,f,a,b){const p=U(e,c,a);return f.every(k=>V(e,k,p,b)!==q.DISCARD)}function W(e,c,f,a,b,p,k,d){const g=k[0].spatialReference||b.spatialReference;if(y.projectBoundingSphere(f.node.mbs,
p,D,g)){p=U(e,D,g);var l=oa(d,b,g,a,f.objectHandle);for(const m of k){if(0===c.length)break;switch(V(e,m,p,d)){case q.DISCARD:c.length=0;return;case q.KEEP:continue}R.filterInPlace(c,f.featureIds,n=>pa(e,m,n,l))}}else C.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")}function oa(e,c,f,a,b){c=c.renderSpatialReference;const p=new Map,k={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:f};k.rings[0][3]=k.rings[0][0];
let d,g;switch(e){case "intersects":d=(l,m,n)=>l.intersects(m,n)?q.KEEP:q.TEST;g=I;break;case "contains":d=(l,m,n)=>l.contains(m,n)?q.TEST:q.DISCARD;g=I;break;default:d=(l,m,n)=>l.disjoint(m,n)?q.TEST:q.DISCARD,g=X}return{collection:a,object:b,type:e,maskSR:f,renderSR:c,aabbCache:p,triangle:k,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:d,geometryTest:g}}function U(e,c,f){const a={type:"point",x:c[0],y:c[1],hasZ:!1,hasM:!1,spatialReference:f};f=!P.isWGS84(f)&&!P.isWebMercator(f);
c=Number.isNaN(c[3])?0:da.clamp(c[3],0,2*la.earth.radius);e=f?e.buffer(a,c,1):e.geodesicBuffer(a,c,1);e.type="polygon";return e}function V(e,c,f,a){switch(a){case "intersects":case "contains":return I(e,c,f);case "disjoint":return X(e,c,f)}}function I(e,c,f){return e.intersects(c,f)?e.contains(c,f)?q.KEEP:q.TEST:q.DISCARD}function X(e,c,f){return e.intersects(c,f)?e.contains(c,f)?q.DISCARD:q.TEST:q.KEEP}function pa(e,c,f,a){const {collection:b,object:p,renderSR:k,maskSR:d,geometryTest:g,aabbCache:l}=
a;var m=l.get(f);if(!m){m=b.getObjectTransform(p);b.getComponentAabb(p,f,z);var n=[[z[0],z[1],0],[z[0],z[4],0],[z[3],z[4],0],[z[3],z[1],0]];for(var r=0;4>r;++r)w.transformMat3(n[r],n[r],m.rotationScale),w.add(n[r],n[r],m.position),y.projectVectorToVector(n[r],k,n[r],d);m={type:"polygon",rings:[n],spatialReference:d,cache:{}};m.rings[0][4]=m.rings[0][0];l.set(f,m)}switch(g(e,c,m)){case q.DISCARD:return!1;case q.KEEP:return!0}const {triangle:B,triangleTest:qa,positions:Y}=a;m=B.rings[0][0];n=B.rings[0][1];
r=B.rings[0][2];const E=b.getObjectTransform(p);b.getComponentPositions(p,f,Y);const {indices:J,data:A,stride:K,startIndex:ra,endIndex:sa}=Y;for(f=ra;f<sa;f+=3){const L=K*J[f],M=K*J[f+1],N=K*J[f+2];w.set(m,A[L],A[L+1],A[L+2]);w.set(n,A[M],A[M+1],A[M+2]);w.set(r,A[N],A[N+1],A[N+2]);w.transformMat3(m,m,E.rotationScale);w.transformMat3(n,n,E.rotationScale);w.transformMat3(r,r,E.rotationScale);w.add(m,m,E.position);w.add(n,n,E.position);w.add(r,r,E.position);y.projectVectorToVector(m,k,m,d);y.projectVectorToVector(n,
k,n,d);y.projectVectorToVector(r,k,r,d);switch(qa(e,c,B)){case q.DISCARD:return!1;case q.KEEP:return!0}}switch(a.type){case "intersects":return!1;default:return!0}}const C=ca.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");t.I3SMeshViewFilter=function(e){function c(a){a=f.call(this,a);a._projectionEngineLoaded=!1;return a}G._inherits(c,e);var f=G._createSuper(c);e=c.prototype;e.initialize=function(){ea.whenOnce(()=>h.unwrap(this.viewFilter)?.geometry||h.isSome(this.layerFilter)).then(()=>
this.loadAsyncModule((new Promise((a,b)=>aa(["../../../../geometry/geometryEngine"],a,b))).then(a=>{this.destroyed||(this._geometryEngine=a)})))};e.addFilters=function(a,b,p,k){const d=this.sortedObjectIds;h.isSome(d)&&a.push(n=>R.objectIdFilter(d,!0,n));this.addSqlFilter(a,this.parsedWhereClause);const g=x.unwrapUpdating(this._layerMaskGeometries),l=this._geometryEngine;if(h.isSome(g)&&h.isSome(this.layerFilter)&&h.isSome(l)){const n=this.layerFilter.spatialRelationship;a.push((r,B)=>W(l,r,B,k,b,
p,g,n))}const m=x.unwrapUpdating(this._viewMaskGeometries);if(h.isSome(m)&&h.isSome(this.viewFilter)&&h.isSome(l)){const n=this.viewFilter.spatialRelationship;a.push((r,B)=>W(l,r,B,k,b,p,m,n))}};e.isMBSGeometryVisible=function(a,b,p){var k=x.unwrapUpdating(this._layerMaskGeometries);const d=this._geometryEngine;if(h.isSome(k)&&h.isSome(this.layerFilter)&&h.isSome(d)){var g=this.layerFilter.spatialRelationship;b=k[0].spatialReference||b;return y.projectBoundingSphere(a,p,D,b)?T(d,D,k,b,g):(C.warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),
!0)}k=x.unwrapUpdating(this._viewMaskGeometries);return h.isSome(k)&&h.isSome(this.viewFilter)&&h.isSome(d)?(g=this.viewFilter.spatialRelationship,b=k[0].spatialReference||b,y.projectBoundingSphere(a,p,D,b)?T(d,D,k,b,g):(C.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)):!0};c.checkSupport=function(a){if(h.isNone(a))return!1;if(a.timeExtent)return C.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1;a=
a.spatialRelationship;return null!=a&&Z.includes(a)?!0:(C.warn(`Filters with spatialRelationship other than ${Z.join(", ")} are not supported for mesh scene layers`),!1)};G._createClass(c,[{key:"sortedObjectIds",get:function(){if(h.isNone(this.viewFilter)||h.isNone(this.viewFilter.objectIds))return null;const a=ka.doubleArrayFrom(this.viewFilter.objectIds);a.sort();return a}},{key:"parsedWhereClause",get:function(){const a=h.isSome(this.viewFilter)?this.viewFilter.where:null;if(h.isNone(a)||!a)return null;
try{return ia.WhereClause.create(a,this.layerFieldsIndex)}catch(b){C.error(`Failed to parse filter where clause: ${b}`)}return null}},{key:"parsedGeometry",get:function(){const a=x.unwrapUpdating(this._viewMaskGeometries),b=x.unwrapUpdating(this._layerMaskGeometries);return h.isNone(a)||h.isNone(b)?a||b:b.concat(a)}},{key:"_layerMaskGeometries",get:function(){const a=this.layerFilter;return h.isNone(a)?null:h.isNone(this._geometryEngine)?x.updating:"disjoint"===a.spatialRelationship?a.geometries.map(b=>
({type:"polygon",rings:b.rings,spatialReference:b.spatialReference,cache:{}})):[a.geometries.reduce((b,p)=>{b.rings=[...b.rings,...p.rings];return b},{type:"polygon",rings:[],spatialReference:a.geometries[0].spatialReference,cache:{}})]}},{key:"_viewMaskGeometries",get:function(){if(h.isNone(this.viewFilter))return null;var {geometry:a}=this.viewFilter;if(h.isNone(a))return null;if(h.isNone(this.viewFilter)||h.isNone(this._geometryEngine))return x.updating;const {distance:b,units:p}=this.viewFilter,
k=this.viewFilter.spatialRelationship;a="mesh"===a.type?a.extent:a;if(h.isNone(b)||0===b)return F(this._geometryEngine,a,k);const d=p||fa.getUnitString(a.spatialReference);if(a.spatialReference.isWGS84)return a=this._geometryEngine.geodesicBuffer(a,b,d),F(this._geometryEngine,a,k);var g=Q.project(a,S.WGS84);if(h.isSome(g))return a=Q.project(this._geometryEngine.geodesicBuffer(g,b,d),a.spatialReference),F(this._geometryEngine,a,k);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(y.load().then(()=>
this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;g=null;try{g=y.project(a,S.WGS84)}catch(l){}if(g)try{g=y.project(this._geometryEngine.geodesicBuffer(g,b,d),a.spatialReference)}catch(l){g=null}g||C.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${a.spatialReference.wkid}) to WGS84.`);return F(this._geometryEngine,g,k)}},{key:"updating",get:function(){return x.isUpdating(this._layerMaskGeometries)||x.isUpdating(this._viewMaskGeometries)}}]);
return c}(ba);u.__decorate([v.property()],t.I3SMeshViewFilter.prototype,"layerFilter",void 0);u.__decorate([v.property({type:na})],t.I3SMeshViewFilter.prototype,"viewFilter",void 0);u.__decorate([v.property()],t.I3SMeshViewFilter.prototype,"layerFieldsIndex",void 0);u.__decorate([v.property()],t.I3SMeshViewFilter.prototype,"loadAsyncModule",void 0);u.__decorate([v.property()],t.I3SMeshViewFilter.prototype,"addSqlFilter",void 0);u.__decorate([v.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,
"sortedObjectIds",null);u.__decorate([v.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedWhereClause",null);u.__decorate([v.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"parsedGeometry",null);u.__decorate([v.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_layerMaskGeometries",null);u.__decorate([v.property({readOnly:!0})],t.I3SMeshViewFilter.prototype,"_viewMaskGeometries",null);u.__decorate([v.property()],t.I3SMeshViewFilter.prototype,"updating",null);u.__decorate([v.property()],
t.I3SMeshViewFilter.prototype,"_projectionEngineLoaded",void 0);u.__decorate([v.property()],t.I3SMeshViewFilter.prototype,"_geometryEngine",void 0);t.I3SMeshViewFilter=u.__decorate([ha.subclass("esri.views.3d.layers.i3s.I3SMeshViewFilter")],t.I3SMeshViewFilter);const Z=["contains","intersects","disjoint"];var q;(function(e){e[e.KEEP=0]="KEEP";e[e.DISCARD=1]="DISCARD";e[e.TEST=2]="TEST"})(q||(q={}));const D=ma.fromValues(0,0,0,0),z=ja.create();Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});