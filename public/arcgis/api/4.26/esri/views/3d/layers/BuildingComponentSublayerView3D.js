// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../core/sql/WhereClause ../../../layers/buildingSublayers/BuildingComponentSublayer ../../../layers/support/FeatureFilter ../../../layers/support/fieldUtils ../../../rest/support/Query ./BuildingSublayerView3D ./I3SMeshView3D ./II3SMeshView3D ./i3s/BuildingFilterUtil ./i3s/I3SGeometryUtil ./i3s/I3SMeshViewFilter ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ../../layers/BuildingComponentSublayerView ../../layers/support/popupUtils ../../support/Scheduler".split(" "),
function(l,k,A,u,r,e,v,m,g,P,Q,B,C,R,D,q,w,E,F,G,x,H,y,I,J,K,z,L,M,t,N){g=function(d){function n(){var a=O.apply(this,arguments);a.type="building-component-sublayer-3d";a.layerView=null;a._elevationContext="scene";a._isIntegratedMesh=!1;a._supportsLabeling=!1;a.requiredFields=[];a.progressiveLoadFactor=1;a._queryEngine=null;return a}l._inherits(n,d);var O=l._createSuper(n);d=n.prototype;d.initialize=function(){this.updatingHandles.add(()=>[this.sublayer.renderer,this.definitionExpressionFields,this.filterExpressionFields],
()=>this._updateRequiredFields());this.updatingHandles.add(()=>this.sublayer.renderer,b=>this._rendererChange(b),v.initial);const a=()=>this._filterChange();this.updatingHandles.add(()=>this.parsedDefinitionExpression,a);this.updatingHandles.add(()=>e.isSome(this._filter)?this._filter.sortedObjectIds:null,a);this.updatingHandles.add(()=>e.isSome(this._filter)?this._filter.parsedWhereClause:null,a);this.updatingHandles.add(()=>[e.isSome(this._filter)?this._filter.parsedGeometry:null,e.isSome(this.filter)?
this.filter.spatialRelationship:null],()=>this._geometryFilterChange());this.updatingHandles.add(()=>this.parsedFilterExpressions,()=>this._updateSymbologyOverride(),v.initial);this.addResolvingPromise(this._updateRequiredFields())};d.isUpdating=function(){return l._get(l._getPrototypeOf(n.prototype),"isUpdating",this).call(this)||e.isSome(this._filter)&&this._filter.updating};d._updateSymbologyOverride=function(){const a=this.parsedFilterExpressions;0<a.length?this._setSymbologyOverride((b,c)=>{for(const [f,
p]of a)try{if(f.testFeature(b))return x.applyFilterMode(c,p)}catch(h){this.logError(h)}return x.applyFilterMode(c,null)},this.filterExpressionFields):this._setSymbologyOverride(null,null)};d._createLayerGraphic=function(a){a=new A(null,null,a);a.layer=this.sublayer.layer;a.sourceLayer=this.sublayer;return a};d.canResume=function(){return l._get(l._getPrototypeOf(n.prototype),"canResume",this).call(this)&&(!this._controller||this._controller.rootNodeVisible)};d.fetchPopupFeatures=async function(a,
b){if(a=this._validateFetchPopupFeatures(b))throw a;if(e.isNone(b)||!b.clientGraphics||0===b.clientGraphics.length)return[];const c=[],f=[];a=e.isSome(this.sublayer.associatedLayer)?await this.sublayer.associatedLayer.load():this.sublayer;a=q.unpackFieldNames(this.sublayer.fieldsIndex,await t.getRequiredFields(a,t.getFetchPopupTemplate(this.sublayer,b)));const p=new Set;for(const h of b.clientGraphics)q.populateMissingFields(a,h,p)?f.push(h):c.push(h);if(0===f.length)return c;e.isSome(this.sublayer.associatedLayer)&&
await this.sublayer.associatedLayer.load().catch(()=>r.getLogger(this.declaredClass).warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes."));return this.whenGraphicAttributes(f,Array.from(p)).catch(()=>f).then(h=>c.concat(h))};d._updateRequiredFields=async function(){const a=q.fixFields(this.sublayer.fieldsIndex,[...(this.sublayer.renderer?await this.sublayer.renderer.getRequiredFields(this.sublayer.fieldsIndex):[]),...(this.definitionExpressionFields||
[]),...(this.filterExpressionFields||[])]);this._set("requiredFields",a)};d._validateFetchPopupFeatures=function(a){const {sublayer:b}=this,{popupEnabled:c}=b;if(!c)return new u("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:b});if(!t.getFetchPopupTemplate(b,a))return new u("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:b})};d.getFilters=function(){const a=l._get(l._getPrototypeOf(n.prototype),"getFilters",this).call(this);
this.addSqlFilter(a,this.parsedDefinitionExpression,this.logError);e.isSome(this._filter)&&this._filter.addFilters(a,this.view,this._controller.crsIndex,this._collection);return a};d.createQuery=function(){const a={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return e.isSome(this.filter)?this.filter.createQuery(a):new w(a)};d.queryExtent=function(a,b){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(a),b?.signal)};d.queryFeatureCount=function(a,
b){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(a),b?.signal)};d.queryFeatures=function(a,b){return this._ensureQueryEngine().executeQuery(this._ensureQuery(a),b?.signal).then(c=>{if(!c?.features)return c;const f=this.sublayer,p=f.layer;for(const h of c.features)h.layer=p,h.sourceLayer=f;return c})};d.queryObjectIds=function(a,b){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(a),b?.signal)};d._ensureQueryEngine=function(){e.isNone(this._queryEngine)&&
(this._queryEngine=this._createQueryEngine());return this._queryEngine};d._createQueryEngine=function(){const a=H.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new I.I3SQueryEngine({layerView:this,priority:N.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new K.I3SQueryFeatureStore({featureAdapter:new J.I3SQueryFeatureAdapter({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:a}),
forAllFeatures:(b,c)=>this._forAllFeatures((f,p,h)=>b({id:f,index:p,meta:h}),c,G.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA),getFeatureExtent:a,sourceSpatialReference:z.getIndexCrs(this.sublayer),viewSpatialReference:this.view.spatialReference})})};d._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(e.isNone(a)?this.createQuery():w.from(a))};l._createClass(n,[{key:"i3slayer",get:function(){return this.sublayer}},{key:"layerUid",get:function(){return this.sublayer.layer.uid}},
{key:"sublayerUid",get:function(){return this.sublayer.uid}},{key:"layerId",get:function(){return this.sublayer.layer.id}},{key:"sublayerId",get:function(){return this.sublayer.id}},{key:"layerPopupEnabled",get:function(){return this.sublayer.popupEnabled}},{key:"lodFactor",get:function(){return this.view.qualitySettings.sceneService.object.lodFactor}},{key:"parsedFilterExpressions",get:function(){return"Overview"!==this.sublayer.modelName&&this.layerView?this.layerView.filterExpressions.map(([a,
b])=>{let c;try{c=C.WhereClause.create(a,this.sublayer.fieldsIndex)}catch(f){return r.getLogger(this.declaredClass).error("Failed to parse filterExpression: "+f),null}if(!c.isStandardized)return r.getLogger(this.declaredClass).error("filterExpression is using non standard function"),null;a=[];z.findFieldsCaseInsensitive(c.fieldNames,this.sublayer.fields,{missingFields:a});return 0<a.length?(r.getLogger(this.declaredClass).error(`filterExpression references unknown fields: ${a.join(", ")}`),null):
[c,b]}).filter(a=>null!=a):[]}},{key:"filter",get:function(){return e.isSome(this._filter)?this._filter.viewFilter:null},set:function(a){e.isNone(a)||!y.I3SMeshViewFilter.checkSupport(a)?this._filter=null:e.isSome(this._filter)?this._filter.viewFilter=a:this._filter=new y.I3SMeshViewFilter({viewFilter:a,layerFieldsIndex:this.sublayer.fieldsIndex,loadAsyncModule:b=>this._loadAsyncModule(b),addSqlFilter:(b,c)=>this.addSqlFilter(b,c,this.logError)})}},{key:"filterExpressionFields",get:function(){return q.fixFields(this.sublayer.fieldsIndex,
this.parsedFilterExpressions.reduce((a,[b])=>a.concat(b.fieldNames),[]))}},{key:"availableFields",get:function(){var a=this.sublayer;const b=a.fieldsIndex;let c=this.requiredFields;if(a.outFields||a.layer.outFields)a=[...(a.outFields||[]),...(a.layer.outFields||[])],c=[...q.unpackFieldNames(b,a),...c];return q.fixFields(b,c)}}]);return n}(L.DefinitionExpressionSceneLayerView(F.I3SMeshView3D(E.BuildingSublayerView3DMixin(M))));k.__decorate([m.property()],g.prototype,"i3slayer",null);k.__decorate([m.property()],
g.prototype,"layerView",void 0);k.__decorate([m.property()],g.prototype,"lodFactor",null);k.__decorate([m.property({readOnly:!0})],g.prototype,"parsedFilterExpressions",null);k.__decorate([m.property({type:D})],g.prototype,"filter",null);k.__decorate([m.property()],g.prototype,"_filter",void 0);k.__decorate([m.property({type:[String],readOnly:!0})],g.prototype,"filterExpressionFields",null);k.__decorate([m.property({type:[String],readOnly:!0})],g.prototype,"requiredFields",void 0);k.__decorate([m.property({type:[String],
readOnly:!0})],g.prototype,"availableFields",null);return g=k.__decorate([B.subclass("esri.views.3d.layers.BuildingComponentSublayerView3D")],g)});