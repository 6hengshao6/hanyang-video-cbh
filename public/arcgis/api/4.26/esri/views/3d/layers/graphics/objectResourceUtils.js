// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/devEnvironmentUtils ../../../../core/maybe ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/FloatArray ../../../../geometry/support/buffer/BufferView ../../../../chunks/vec32 ../../../../chunks/vec42 ../../../../chunks/vec22 ../../../../chunks/vec33 ../../../../chunks/vec43 ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ../../glTF/internal/resourceUtils ../../glTF/internal/TextureTransformUtils ./ProcessedObjectResource ./wosrLoader ../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Texture ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA".split(" "),
function(M,ba,d,V,ca,da,ea,B,Q,R,N,F,O,S,fa,ha,ia,ja,ka,la,T,I,ma,W,X,J,G,na,oa,z,U,H){function Y(f){const c=f.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return c?{fileType:"gltf",url:c[1],specifiedLodIndex:null!=c[4]?Number(c[4]):null}:f.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:f,specifiedLodIndex:null}:{fileType:"unknown",url:f,specifiedLodIndex:null}}function Z(f,c,l,v){const C=f.model,y=[],g=new Map,w=new Map,a=C.lods.length,h=R.empty();C.lods.forEach((x,m)=>{const p=!0===v.skipHighLods&&
(1<a&&0===m||3<a&&1===m)||!1===v.skipHighLods&&null!=v.singleLodIndex&&m!==v.singleLodIndex;if(!p||0===m){var r=new ma.ProcessedObjectResource(x.name,x.lodThreshold,[0,0,0]);x.parts.forEach(b=>{const e=p?new U.DefaultMaterial({}):pa(C,b,r,c,l,g,w);var D=d.isSome(e)?e:new U.DefaultMaterial({});const t=b.attributes.position.count,u=la.convertPrimitiveToTriangles(b.indices||t,b.primitiveType);var k=N.newFloatArray(3*t);const {typedBuffer:E,typedBufferStride:A}=b.attributes.position;O.transformMat4(k,
E,b.transform,3,A);k=[[z.VertexAttribute.POSITION,new J.Attribute(k,3,!0)]];const q=[[z.VertexAttribute.POSITION,u]];if(d.isSome(b.attributes.normal)){var n=N.newFloatArray(3*t);const {typedBuffer:K,typedBufferStride:L}=b.attributes.normal;V.normalFromMat4(P,b.transform);O.transformMat3(n,K,P,3,L);k.push([z.VertexAttribute.NORMAL,new J.Attribute(n,3,!0)]);q.push([z.VertexAttribute.NORMAL,u])}if(d.isSome(b.attributes.tangent)){n=N.newFloatArray(4*t);const {typedBuffer:K,typedBufferStride:L}=b.attributes.tangent;
V.normalFromMat4(P,b.transform);S.transformMat3(n,K,P,4,L);k.push([z.VertexAttribute.TANGENT,new J.Attribute(n,4,!0)]);q.push([z.VertexAttribute.TANGENT,u])}if(d.isSome(b.attributes.texCoord0)){n=N.newFloatArray(2*t);const {typedBuffer:K,typedBufferStride:L}=b.attributes.texCoord0;fa.normalizeIntegerBuffer(n,K,2,L);k.push([z.VertexAttribute.UV0,new J.Attribute(n,2,!0)]);q.push([z.VertexAttribute.UV0,u])}d.isSome(b.attributes.color)&&(n=new Uint8Array(4*t),4===b.attributes.color.elementCount?b.attributes.color instanceof
F.BufferViewVec4f?S.scale(n,b.attributes.color,255):b.attributes.color instanceof F.BufferViewVec4u8?ia.copy(n,b.attributes.color):b.attributes.color instanceof F.BufferViewVec4u16&&S.scale(n,b.attributes.color,1/256):(n.fill(255),b.attributes.color instanceof F.BufferViewVec3f?O.scale(n,b.attributes.color,255,4):b.attributes.color instanceof F.BufferViewVec3u8?ha.copy(n,b.attributes.color.typedBuffer,4,b.attributes.color.typedBufferStride):b.attributes.color instanceof F.BufferViewVec3u16&&O.scale(n,
b.attributes.color,1/256,4)),k.push([z.VertexAttribute.COLOR,new J.Attribute(n,4,!0)]),q.push([z.VertexAttribute.COLOR,u]));b={geometry:new na.Geometry(D,k,q),vertexCount:t};const {geometry:aa,vertexCount:qa}=b;b=aa.boundingInfo;d.isSome(b)&&0===m&&(R.expandWithVec3(h,b.bbMin),R.expandWithVec3(h,b.bbMax));d.isSome(e)&&(r.stageResources.geometries.push(aa),r.numberOfVertices+=qa)});p||y.push(r)}});return{engineResources:y,referenceBoundingBox:h}}function pa(f,c,l,v,C,y,g){const w=c.material+(c.attributes.normal?
"_normal":"")+(c.attributes.color?"_color":"")+(c.attributes.texCoord0?"_texCoord0":"")+(c.attributes.tangent?"_tangent":""),a=f.materials.get(c.material);var h=d.isSome(c.attributes.texCoord0);const x=d.isSome(c.attributes.normal);if(d.isNone(a))return null;a:{switch(a.alphaMode){case "BLEND":var m=G.AlphaDiscardMode.Blend;break a;case "MASK":m=G.AlphaDiscardMode.Mask;break a;case "OPAQUE":case null:case void 0:m=G.AlphaDiscardMode.Opaque;break a}m=void 0}if(!y.has(w)){if(h){var p=(k,E=!1)=>{if(d.isSome(k)&&
!g.has(k)){const A=f.textures.get(k);if(d.isSome(A)){const q=A.data;g.set(k,new oa.Texture(T.isEncodedMeshTexture(q)?q.data:q,{...A.parameters,preMultiplyAlpha:T.isEncodedMeshTexture(q)?!1:E,encoding:T.isEncodedMeshTexture(q)&&d.isSome(q.encoding)?q.encoding:void 0}))}}};p(a.textureColor,m!==G.AlphaDiscardMode.Opaque);p(a.textureNormal);p(a.textureOcclusion);p(a.textureEmissive);p(a.textureMetallicRoughness)}p=a.color[0]**(1/H.COLOR_GAMMA);const r=a.color[1]**(1/H.COLOR_GAMMA),b=a.color[2]**(1/H.COLOR_GAMMA),
e=a.emissiveFactor[0]**(1/H.COLOR_GAMMA),D=a.emissiveFactor[1]**(1/H.COLOR_GAMMA),t=a.emissiveFactor[2]**(1/H.COLOR_GAMMA),u=d.isSome(a.textureColor)&&h?g.get(a.textureColor):null;y.set(w,new U.DefaultMaterial({...v,transparent:m===G.AlphaDiscardMode.Blend,customDepthTest:G.DepthTestFunction.Lequal,textureAlphaMode:m,textureAlphaCutoff:a.alphaCutoff,diffuse:[p,r,b],ambient:[p,r,b],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",cullFace:a.doubleSided?G.CullFaceOptions.None:
G.CullFaceOptions.Back,hasVertexColors:!!c.attributes.color,hasVertexTangents:!!c.attributes.tangent,normalType:x?X.NormalAttributeType.Attribute:X.NormalAttributeType.ScreenDerivative,castShadows:!0,receiveSSAO:!0,textureId:d.isSome(u)?u.id:void 0,colorMixMode:a.colorMixMode,normalTextureId:d.isSome(a.textureNormal)&&h?g.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:d.isSome(u)&&!!u.params.preMultiplyAlpha,occlusionTextureId:d.isSome(a.textureOcclusion)&&h?g.get(a.textureOcclusion).id:
void 0,emissiveTextureId:d.isSome(a.textureEmissive)&&h?g.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:d.isSome(a.textureMetallicRoughness)&&h?g.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[e,D,t],mrrFactors:[a.metallicFactor,a.roughnessFactor,v.mrrFactors[2]],isSchematic:!1,colorTextureTransformMatrix:I.getTransformMatrix(a.colorTextureTransform),normalTextureTransformMatrix:I.getTransformMatrix(a.normalTextureTransform),occlusionTextureTransformMatrix:I.getTransformMatrix(a.occlusionTextureTransform),
emissiveTextureTransformMatrix:I.getTransformMatrix(a.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:I.getTransformMatrix(a.metallicRoughnessTextureTransform),...C}))}c=y.get(w);l.stageResources.materials.push(c);h&&(h=r=>{d.isSome(r)&&l.stageResources.textures.push(g.get(r))},h(a.textureColor),h(a.textureNormal),h(a.textureOcclusion),h(a.textureEmissive),h(a.textureMetallicRoughness));return c}const P=ca.create();M.fetch=async function(f,c){f=Y(ba.adjustStaticAGOUrl(f));if("wosr"===
f.fileType){f=await (c.cache?c.cache.loadWOSR(f.url,c):W.load(f.url,c));const {engineResources:x,referenceBoundingBox:m}=W.processLoadResult(f,c);return{lods:x,referenceBoundingBox:m,isEsriSymbolResource:!1,isWosr:!0}}const l=await (c.cache?c.cache.loadGLTF(f.url,c,!!c.usePBR):ka.loadGLTF(new ja.DefaultLoadingContext(c.streamDataRequester),f.url,c,c.usePBR)),v=d.get(l.model.meta,"ESRI_proxyEllipsoid"),C=l.meta.isEsriSymbolResource&&d.isSome(v)&&l.meta.uri.includes("/RealisticTrees/");if(C&&!l.customMeta.esriTreeRendering){l.customMeta.esriTreeRendering=
!0;a:for(let x=0;x<l.model.lods.length;++x){var y=l.model.lods[x];for(var g of y.parts){y=g.attributes.normal;if(d.isNone(y))break a;const m=g.attributes.position,p=m.count,r=Q.create(),b=Q.create(),e=Q.create(),D=new Uint8Array(4*p),t=new Float64Array(3*p),u=da.invert(ea.create(),g.transform);let k=0,E=0;for(let A=0;A<p;A++){m.getVec(A,b);y.getVec(A,r);B.transformMat4(b,b,g.transform);B.subtract(e,b,v.center);B.divide(e,e,v.radius);const q=e[2];var w=B.length(e);w=Math.min(.45+.55*w*w,1);B.divide(e,
e,v.radius);null!==u&&B.transformMat4(e,e,u);B.normalize(e,e);x+1!==l.model.lods.length&&1<l.model.lods.length&&(-1<q?B.lerp(e,e,r,.2):B.lerp(e,e,r,Math.min(-4*q-3.8,1)));t[k]=e[0];t[k+1]=e[1];t[k+2]=e[2];k+=3;D[E]=255*w;D[E+1]=255*w;D[E+2]=255*w;D[E+3]=255;E+=4}g.attributes.normal=new F.BufferViewVec3f(t);g.attributes.color=new F.BufferViewVec4u8(D)}}}g=!!c.usePBR;const {engineResources:a,referenceBoundingBox:h}=Z(l,l.meta.isEsriSymbolResource?{usePBR:g,isSchematic:!1,treeRendering:C,mrrFactors:[0,
1,.2]}:{usePBR:g,isSchematic:!1,treeRendering:!1,mrrFactors:[0,1,.5]},{...c.materialParamsMixin,treeRendering:C},c.skipHighLods&&null==f.specifiedLodIndex?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:f.specifiedLodIndex});return{lods:a,referenceBoundingBox:h,isEsriSymbolResource:l.meta.isEsriSymbolResource,isWosr:!1}};M.gltfToEngineResources=Z;M.parseUrl=Y;Object.defineProperty(M,Symbol.toStringTag,{value:"Module"})});