// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Collection ../../../../core/Handles ../../../../core/Logger ../../../../core/maybe ../../../../core/PooledArray ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ./FeatureTileDescriptor3D ./FeatureTileMeasurements3D ../../support/extentUtils ../../../support/Scheduler".split(" "),
function(d,r,e,u,v,w,x,h,y,m,g,E,F,G,z,k,t,A,B,n){d.FeatureTileTree3D=function(f){function l(a){a=C.call(this,a);a.tiles=new v;a.tileSize=512;a._idToTile=new Map;a._handles=new w;a._clients=new Set;a._dirty=!1;a._pendingTiles=null;a._newTiles=new y;return a}r._inherits(l,f);var C=r._createSuper(l);f=l.prototype;f.initialize=function(){this._handles.add([m.watch(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),m.sync),m.watch(()=>[this.tileSize,this.cameraOnSurface?.location,this.tilingScheme,
this.viewState?.contentCamera,this.focus?.location],()=>this._setDirty(),m.syncAndInitial)]);this.scheduler&&(this._frameWorker=this.scheduler.registerTask(n.TaskPriority.FEATURE_TILE_TREE,this))};f.destroy=function(){this._frameWorker=h.removeMaybe(this._frameWorker);this._handles=h.destroyMaybe(this._handles)};f.addClient=function(){const a=D++;this._clients.add(a);1===this._clients.size&&this._setDirty();return{remove:()=>this._removeClient(a)}};f._removeClient=function(a){this._clients.delete(a);
this._hasClients||this._clear()};f._setDirty=function(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(n.noBudget))};f._clear=function(){this.tiles.removeAll();this._idToTile.clear();this._reset();this._dirty=!1;this.notifyChange("updating")};f.runTask=function(a){this._dirty=!1;this._pendingTiles||(this._startUpdate(),h.isSome(this._frameWorker)&&(this._frameWorker.priority=n.TaskPriority.FEATURE_TILE_TREE_ACTIVE));this._subdivideTilesForView(a);
!this._pendingTiles&&h.isSome(this._frameWorker)&&(this._frameWorker.priority=n.TaskPriority.FEATURE_TILE_TREE);this.notifyChange("updating")};f._startUpdate=function(){this.suspended||(this.tilingScheme?(this._tileMeasurements||(this._tileMeasurements=new A.FeatureTileMeasurements3D({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize})),this._tileMeasurements.begin(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=
this._getRootTiles()):this._clear())};f._reset=function(){this._newTiles.clear();this._pendingTiles=this._tileMeasurements=null;this._setDirty()};f._getRootTiles=function(){const {tilingScheme:a}=this;return this._rootTileIds.map(b=>new t.FeatureTileDescriptor3D(b[0],b[1],b[2],a))};f._purgeHorizonTiles=function(a){a.sort((b,c)=>{b=b.measures.screenRect;c=c.measures.screenRect;return b[1]+b[3]-(c[1]+c[3])});k.empty(p);for(let b=0;b<a.length;b++)if(k.expand(p,a.data[b].measures.screenRect,p),10<k.height(p))return a.data.slice(b,
a.length);return[]};f._subdivideTilesForView=function(a){if(this._pendingTiles){for(var {tilingScheme:b}=this;0<this._pendingTiles.length&&!a.done;){const c=this._pendingTiles.pop();a.madeProgress();if(!this._filterExtentRect||k.intersects(this._filterExtentRect,c.extent))this._tileMeasurements.updateTile(c),c.measures.visibility!==t.Visibility.INVISIBLE&&(c.measures.shouldSplit?(b.ensureMaxLod(c.lij[0]+1),this._pendingTiles.push(...c.getChildren())):this._newTiles.push(c))}0===this._pendingTiles.length&&
(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}};f._updateTiles=function(a){for(var b of this.tiles.items)b.used=!1;a=a.filter(c=>{const q=this._idToTile.get(c.id);q?(q.copyMeasurementsFrom(c),q.used=!0):this._idToTile.set(c.id,c);return!q});b=this.tiles.items.filter(c=>c.used?!1:(this._idToTile.delete(c.id),!0));this.tiles.removeMany(b);this.tiles.addMany(a);this._sortTiles()};f._sortTiles=function(){this.viewState.fixedContentCamera||
this.tiles.sort((a,b)=>a.measures.visibility!==b.measures.visibility?a.measures.visibility===t.Visibility.VISIBLE_ON_SURFACE?-1:1:a.measures.distance-b.measures.distance);this.tiles.forEach((a,b)=>a.loadPriority=b)};r._createClass(l,[{key:"tilingScheme",get:function(){const a=this.tilingSchemeOwner.tilingScheme;return a?a.clone():null}},{key:"filterExtent",set:function(a){if(h.isSome(a)&&!a.spatialReference.equals(this.viewState.spatialReference))x.getLogger(this.declaredClass).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");
else{var b=this._get("filterExtent");b===a||h.isSome(b)&&a&&b.equals(a)||(a=h.isSome(a)?a.clone():null,this._set("filterExtent",a),this._setDirty())}}},{key:"_filterExtentRect",get:function(){if(h.isNone(this.filterExtent))return null;const a=k.create();B.toBoundingRect(this.filterExtent,a,this.tilingScheme.spatialReference);return a}},{key:"_rootTileIds",get:function(){const {tilingScheme:a}=this;return this._filterExtentRect&&a?a.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}},{key:"suspended",
set:function(a){a!==this._get("suspended")&&(this._set("suspended",a),this._setDirty())}},{key:"updating",get:function(){return this._dirty||!!this._pendingTiles}},{key:"_hasClients",get:function(){return 0<this._clients.size}},{key:"running",get:function(){return this.updating}}]);return l}(u);e.__decorate([g.property({constructOnly:!0})],d.FeatureTileTree3D.prototype,"scheduler",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureTileTree3D.prototype,"renderCoordsHelper",void 0);e.__decorate([g.property({constructOnly:!0})],
d.FeatureTileTree3D.prototype,"tilingSchemeOwner",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureTileTree3D.prototype,"cameraOnSurface",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureTileTree3D.prototype,"focus",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureTileTree3D.prototype,"viewState",void 0);e.__decorate([g.property({constructOnly:!0})],d.FeatureTileTree3D.prototype,"terrain",void 0);e.__decorate([g.property()],d.FeatureTileTree3D.prototype,"tiles",
void 0);e.__decorate([g.property()],d.FeatureTileTree3D.prototype,"tileSize",void 0);e.__decorate([g.property({readOnly:!0})],d.FeatureTileTree3D.prototype,"tilingScheme",null);e.__decorate([g.property()],d.FeatureTileTree3D.prototype,"filterExtent",null);e.__decorate([g.property({readOnly:!0})],d.FeatureTileTree3D.prototype,"_filterExtentRect",null);e.__decorate([g.property({readOnly:!0})],d.FeatureTileTree3D.prototype,"_rootTileIds",null);e.__decorate([g.property({value:!1})],d.FeatureTileTree3D.prototype,
"suspended",null);e.__decorate([g.property({readOnly:!0})],d.FeatureTileTree3D.prototype,"updating",null);d.FeatureTileTree3D=e.__decorate([z.subclass("esri.views.3d.layers.support.FeatureTileTree3D")],d.FeatureTileTree3D);let D=0;const p=k.create();Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});