// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/Error ../../../../core/lang ../../../../core/maybe ../../../../core/unitUtils ../../../../chunks/earcut ../../../../chunks/mat3 ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/DoubleArray ../../../../geometry/support/Indices ../../../../chunks/vec32 ../../../../layers/graphics/data/SnappingCandidate ../../../../renderers/support/renderingInfoUtils ../../../ViewingMode ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ./polygonUtils ../support/edgeUtils ../../support/debugFlags ../../support/ElevationProvider ../../support/renderInfoUtils/polygon ../../webgl-engine/lib/Attribute ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/ContentObjectType ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryWithMapPositions ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(Y,I,Z,pa,R,H,qa,ra,sa,ta,aa,S,B,D,ua,L,M,T,ba,U,va,wa,V,xa,ya,za,ca,da,Aa,Ba,Ca,Da,Ea,N,W,Fa,Ga,Ha,Ia,G,ea){function fa(d,g,l,a,c,b){const f=T.getZeroIndexArray(g.length);c=[[G.VertexAttribute.POSITION,new N.Attribute(a.positions,3,!0)],[G.VertexAttribute.NORMAL,new N.Attribute(a.normals,3,!0)],[G.VertexAttribute.COLOR,new N.Attribute(c,4,!0)],[G.VertexAttribute.SIZE,new N.Attribute(a.heights,1,!0)]];return new Ga.Geometry(d,c,[[G.VertexAttribute.POSITION,g],[G.VertexAttribute.NORMAL,g],
[G.VertexAttribute.COLOR,f]],a.elevation,Fa.ContentObjectType.Mesh,b,l)}function Ja(d,g,l,a,c,b,f,t,h,n,m,k,p){let z=0;var e=2*a.count,q=a.index,r=a.count,F=l.length/3,v=e;B.copy(y,k);const u=0<m?1:-1;e=3*q;let w=0;q=3*w;let x=r;k=3*x;for(let A=0;A<r;++A)p&&(y[0]=d[e],y[1]=d[e+1],y[2]=d[e+2],B.normalize(y,y)),c[q]=d[e],c[q+1]=d[e+1],c[q+2]=d[e+2],b[q]=g[e],b[q+1]=g[e+1],b[q+2]=g[e+2],f[q]=-u*y[0],f[q+1]=-u*y[1],f[q+2]=-u*y[2],t[w]=0,c[k]=d[e]+m*y[0],c[k+1]=d[e+1]+m*y[1],c[k+2]=d[e+2]+m*y[2],b[k]=
g[e],b[k+1]=g[e+1],b[k+2]=g[e+2],f[k]=u*y[0],f[k+1]=u*y[1],f[k+2]=u*y[2],t[x]=m,q+=3,k+=3,e+=3,w+=1,x+=1;q=e=0;k=3*v;d=0>m?ha:ia;g=0>m?ia:ha;for(p=0;p<F;++p)n[q]=l[e+d[0]],n[q+1]=l[e+d[1]],n[q+2]=l[e+d[2]],h[k]=l[e+g[0]]+r,h[k+1]=l[e+g[1]]+r,h[k+2]=l[e+g[2]]+r,q+=3,k+=3,e+=3;l=2*a.count;e=0;ja(c,b,t,f,z,a.pathLengths[0],a.count,l,h,e,m);l+=4*a.pathLengths[0];e+=2*a.pathLengths[0];z+=a.pathLengths[0];for(n=1;n<a.pathLengths.length;++n)ja(c,b,t,f,z,a.pathLengths[n],a.count,l,h,e,m),l+=4*a.pathLengths[n],
e+=2*a.pathLengths[n],z+=a.pathLengths[n]}function O(d,g,l,a,c,b,f){a[b]=a[f];f*=3;b*=3;d[b]=d[f];d[b+1]=d[f+1];d[b+2]=d[f+2];g[b]=g[f];g[b+1]=g[f+1];g[b+2]=g[f+2];l[b]=c[0];l[b+1]=c[1];l[b+2]=c[2]}function ja(d,g,l,a,c,b,f,t,h,n,m){let k=c,p=c+1,z=c+f,e=c+f+1,q=t,r=t+1,F=t+2*b;t=t+2*b+1;0>m&&(k=c+f+1,e=c);n*=3;for(let E=0;E<b;++E){E===b-1&&(0<m?(p=c,e=c+f):(p=c,k=c+f));var v=d,u=k,w=p,x=z,A=K;u*=3;w*=3;x*=3;B.set(X,v[u++],v[u++],v[u++]);B.set(ka,v[w++],v[w++],v[w++]);B.set(la,v[x++],v[x++],v[x++]);
B.subtract(ma,ka,X);B.subtract(na,la,X);B.cross(A,na,ma);B.normalize(A,A);O(d,g,a,l,K,q,k);O(d,g,a,l,K,r,p);O(d,g,a,l,K,F,z);O(d,g,a,l,K,t,e);h[n++]=q;h[n++]=F;h[n++]=t;h[n++]=q;h[n++]=t;h[n++]=r;k++;p++;z++;e++;q+=2;r+=2;F+=2;t+=2}}function Ka(d,g,l,a,c){d=d.stageObject;const b=d.geometries,f=b.length;g="absolute-height"!==g.mode;let t=0;const h=d.transformation,n=aa.invertOrIdentity(S.create(),h);for(let m=0;m<f;m+=2){const k=b[m];if(!Ha.isGeometryWithMapPositions(k))continue;const p=k.getMutableAttribute(G.VertexAttribute.POSITION).data,
z=k.vertexAttributes.get(G.VertexAttribute.SIZE).data,e=new Da.SamplePosition(k.mapPositions),q=p.length/3;let r=0,F=!1,v=0;for(let u=0;u<q;u++){J[0]=p[r];J[1]=p[r+1];J[2]=p[r+2];a(e,P);g&&(v+=P.sampledElevation);Ca.TESTS_DISABLE_OPTIMIZATIONS?(B.set(C,e.array[e.offset],e.array[e.offset+1],P.z+z[r/3]),H.isSome(l)&&c.toRenderCoords(C,l,C)):(B.set(C,p[r],p[r+1],p[r+2]),B.transformMat4(C,C,h),c.setAltitude(C,P.z+z[r/3]));B.transformMat4(C,C,n);p[r]=C[0];p[r+1]=C[1];p[r+2]=C[2];const w=.01/c.unitInMeters;
if(Math.abs(J[0]-p[r])>=w||Math.abs(J[1]-p[r+1])>=w||Math.abs(J[2]-p[r+2])>=w)F=!0;e.offset+=3;r+=3}F&&(k.invalidateBoundingInfo(),d.geometryVertexAttrsUpdated(b[m]),b[m+1].invalidateBoundingInfo(),d.geometryVertexAttrsUpdated(b[m+1]));t+=v/q}return t/f}const La=["polygon","extent"];Z=function(d){function g(a,c,b,f){a=l.call(this,a,c,b,f);a.ensureDrapedStatus(!1);return a}I._inherits(g,d);var l=I._createSuper(g);d=g.prototype;d.doLoad=async function(){if(!this._drivenProperties.size){var a=ca.validateSymbolLayerSize(this._getSymbolSize());
if(a)throw new pa("graphics3dextrudesymbollayer:invalid-size",a);}a=H.get(this.symbolLayer,"material","color");var c=this._getCombinedOpacityAndColor(a);a=D.fromArray(c);c=c[3];const b=1>c||this.needsDrivenTransparentPass;a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:c,transparent:b,cullFace:b?W.CullFaceOptions.None:W.CullFaceOptions.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};
this._material=new ea.DefaultMaterial(a);this._bottomMaterial=new ea.DefaultMaterial({...a,cullFace:W.CullFaceOptions.Back});this._context.stage.add(this._material);this._context.stage.add(this._bottomMaterial)};d.destroy=function(){I._get(I._getPrototypeOf(g.prototype),"destroy",this).call(this);this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))};d.createGraphics3DGraphic=function(a){const c=a.graphic;if(!this._validateGeometry(c.geometry,
La,this.symbolLayer.type))return null;const b=this._getVertexOpacityAndColor(a.renderingInfo,255),f=this.setGraphicElevationContext(c,new xa.ElevationContext);return this._createAs3DShape(c,a.renderingInfo,b,f,c.uid)};d.layerOpacityChanged=function(a,c){var b=H.get(this.symbolLayer,"material","color");b=this._getCombinedOpacity(b);const f=1>b||this.needsDrivenTransparentPass;this._material.setParameters({opacity:b,transparent:f});this._bottomMaterial.setParameters({opacity:b,transparent:f});const t=
this._getLayerOpacity();a.forEach(h=>{h=c(h);H.isSome(h)&&h.layerOpacityChanged(t,this._context.isAsync)})};d.layerElevationInfoChanged=function(a,c){return this.updateGraphics3DGraphicElevationInfo(a,c,V.needsElevationUpdates3D)};d.slicePlaneEnabledChanged=function(a,c){this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});a.forEach(b=>{b=c(b);H.isSome(b)&&b.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,
this._context.isAsync)});return!0};d.physicalBasedRenderingChanged=function(){this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};d._getExtrusionSize=function(a){a=a.size&&this._drivenProperties.size?va.getDriverAxisSizeValue(a.size,2)??0:this._getSymbolSize();return a/=this._context.renderCoordsHelper.unitInMeters};d.applyRendererDiff=function(a,
c){return this._drivenPropertiesChanged(c)?da.ApplyRendererDiffResult.Recreate_Symbol:da.ApplyRendererDiffResult.Recreate_Graphics};d.queryForSnapping=async function(a,c,b,f){c=this._getExtrusionSize(b)*this._context.renderCoordsHelper.unitInMeters/qa.getMetersPerVerticalUnitForSR(c);const {objectId:t,target:h}=a;b=R.clone(h);b.z=(b.z??0)+c;switch(a.type){case "edge":const {start:n,end:m}=a;a=R.clone(n);f=R.clone(m);a.z=(a.z??0)+c;f.z=(f.z??0)+c;return[U.makeEdgeCandidate(t,b,Infinity,a,f)];case "vertex":return[U.makeVertexCandidate(t,
b,Infinity),U.makeEdgeCandidate(t,h,Infinity,h,b)];default:return[]}};d._getSymbolSize=function(){return this.symbolLayer.size??1};d._createAs3DShape=function(a,c,b,f,t){var h=Aa.geometryAsPolygon(a.geometry);if(H.isNone(h))return null;if(0===h.rings.length||!h.rings.some(E=>0<E.length))return this._logGeometryValidationWarnings(h.rings,"rings","ExtrudeSymbol3DLayer"),null;a=Ea.geometryToRenderInfo(h,this._context.elevationProvider,this._context.renderCoordsHelper,f);this._logGeometryCreationWarnings(a,
h.rings,"rings","ExtrudeSymbol3DLayer");var n=ca.computeCentroid(h);if(H.isNone(n))return null;var m=[];const k=L.create(),p=S.create(),z=D.create(),e=this._context.renderCoordsHelper.viewingMode===wa.ViewingMode.Global;e||this._context.renderCoordsHelper.worldUpAtPosition(null,z);ua.computeTranslationToOriginAndRotation(h.spatialReference,[n.x,n.y,0],p,this._context.renderCoordsHelper.spatialReference);h=S.create();aa.invert(h,p);n=ta.create();sa.normalFromMat4(n,h);const {polygons:q,mapPositions:r,
position:F}=a;for(const E of q){var v=E.count;if(this._context.clippingExtent&&(L.empty(k),L.expandWithBuffer(k,E.mapPositions),!L.intersectsClippingArea(k,this._context.clippingExtent)))continue;var u=ra.earcut(E.mapPositions,E.holeIndices,3);if(0===u.length)continue;var w=u.length,x=6*v;v=T.newIndexArray(x+w);w=T.newIndexArray(w);var A=M.newDoubleArray(3*x);const Q=M.newDoubleArray(3*x),oa=M.newDoubleArray(3*x);x=M.newDoubleArray(x);const Ma=this._getExtrusionSize(c);Ja(F,r,u,E,A,oa,Q,x,v,w,Ma,
z,e);ba.transformMat4(A,A,h);ba.transformMat3(Q,Q,n);u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:t,layerUid:this._context.layer.uid});A=new Na(A,oa,Q,x);m.push(fa(this._material,v,v.length-w.length,A,b,u),fa(this._bottomMaterial,w,0,A,b,u))}if(0===m.length)return null;c=new Ia.Object3D({geometries:m,metadata:{layerUid:this._context.layer.uid,graphicUid:t,isElevationSource:!0}});c.transformation=p;b=Ba.createMaterial(this.symbolLayer,{opacity:this._getLayerOpacity()});b=H.isSome(b)?
{baseMaterial:this._material,edgeMaterials:[b],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null;m=new ya.Graphics3DObject3DGraphicLayer(this,c,m,null,null,Ka,f,b);m.alignedSampledElevation=a.sampledElevation;m.needsElevationUpdates=V.needsElevationUpdates3D(f.mode);return m};return I._createClass(g)}(za.Graphics3DSymbolLayer);const K=D.create(),X=D.create(),ka=D.create(),la=D.create(),ma=D.create(),na=D.create(),J=D.create(),C=D.create(),y=D.create(),P=new V.SampleElevationInfo,
ia=[0,2,1],ha=[0,1,2];let Na=I._createClass(function(d,g,l,a){this.positions=d;this.elevation=g;this.normals=l;this.heights=a});Y.Graphics3DExtrudeSymbolLayer=Z;Object.defineProperty(Y,Symbol.toStringTag,{value:"Module"})});