// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/mathUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/ellipsoidUtils ../../../../geometry/support/aaBoundingRect ../../../../chunks/boundedPlane ../../../../geometry/support/ray ../../../../chunks/sphere ./deconflictorDebug ./enums ../../support/debugFlags ../../webgl-engine/lib/Camera ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/ScaleInfo".split(" "),
function(k,n,B,O,G,x,H,I,J,la,ma,P,Q,R,S,u,r,y,K,T,p,C,U,A,D,t,V,W,X,L,Y,Z){function*M(c){if(Map.prototype.entries){c=c.entries();for(let h=c.next();!h.done;h=c.next())yield h.value[1]}else yield*c.values()}function*aa(c,h,v){h.clear();c.forEach((d,b)=>{const e=h.pushNew();e.id=b;e.visible=d.graphics3DGraphic.hasVisibilityFlag(t.VisibilityFlag.DECONFLICTION,v);e.prio=d.info?d.info[v].distance:Number.MAX_VALUE});yield;const a=h.iterableSort((d,b)=>d.visible!==b.visible?d.visible?-1:1:d.prio!==b.prio?
d.prio-b.prio:d.id-b.id);for(let d=a.next();!d.done;d=a.next())yield;h.forAll(d=>{const b=c.get(d.id);b&&(c.delete(d.id),c.set(d.id,b))});h.clear()}const m=r.create(),w=K.create(),z=K.create(),E=r.create(),ba=R.create(),ca=A.create(),F=U.create(),da=r.create(),ea=p.create();let fa=n._createClass(function(){this.aabr=p.create();this.distance=0;this.visible=this.culled=!1});J=n._createClass(function(c,h){this.graphics3DGraphic=c;this.slicePlaneEnabled=h;this.info={}});k.State=void 0;(function(c){c[c.Idle=
0]="Idle";c[c.Process=1]="Process";c[c.Sort=2]="Sort";c[c.Deconflict=3]="Deconflict";c[c.NumStates=4]="NumStates"})(k.State||(k.State={}));let N=function(){function c(){this.camera=new W.Camera;this.slicePlane=C.create();this.slicePlaneEnabled=!1}c.prototype.copyFrom=function(h){this.camera.copyFrom(h.camera);C.copy(h.slicePlane,this.slicePlane);this.slicePlaneEnabled=h.slicePlaneEnabled};return n._createClass(c)}();k.Deconflictor=function(c){function h(a){a=v.call(this,a);a._dirty=!1;a._runningViewState=
new N;a._state=k.State.Idle;a._active=new Map;a._visible=new Map;a._iterators=new ha;a._accBinsNumX=15;a._accBinsNumY=20;a._accBinsSizeX=0;a._accBinsSizeY=0;a._accBins=null;a.accNumTests=0;return a}n._inherits(h,c);var v=n._createSuper(h);c=h.prototype;c.destroy=function(){this._active.clear();this._visible.clear();this._iterators=null};c.setDirty=function(){!this._dirty&&0<this._active.size&&(this._dirty=!0,this.notifyChange("updating"))};c.runTask=function(a){switch(this._state){case k.State.Idle:this._startUpdate(),
a.madeProgress();case k.State.Process:if(this._state=k.State.Process,!this._processActiveGraphics(a))break;case k.State.Sort:if(this._state=k.State.Sort,!this._sortVisibleGraphics(a))break;case k.State.Deconflict:if(this._state=k.State.Deconflict,!this._deconflictVisibleGraphics(a))break;default:D.drawAccelerationStruct(this,this._visible),this._state=k.State.Idle,this.notifyChange("updating")}};c.modifyGraphics=function(a,d){d?a.forEach(b=>this.addToActiveGraphics(b)):a.forEach(b=>this.removeFromActiveGraphics(b));
this.setDirty()};c.layerSupportsDeconfliction=function(a){if(x.isNone(a)||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.geometries.length:0)&&a?.geometries[0]?.material instanceof Y.HUDMaterial?!0:!1};c._startUpdate=function(){D.prepare(this.view);this._dirty=!1;this._runningViewState.copyFrom(this.viewState);const {fullWidth:a,fullHeight:d}=this._runningViewState.camera;this._initBins(a,d);this._resetIterators()};c.addToActiveGraphics=function(a){a.info[this.visibilityGroup]=new fa;
this._active.set(a.graphics3DGraphic.graphic.uid,a);this.setDirty()};c.removeFromActiveGraphics=function(a){this._visible.delete(a.graphics3DGraphic.graphic.uid);const d=a.graphics3DGraphic;d.destroyed||d.clearVisibilityFlag(t.VisibilityFlag.DECONFLICTION,this.visibilityGroup);delete a.info[this.visibilityGroup];this._active.delete(a.graphics3DGraphic.graphic.uid);this.setDirty()};c._processActiveGraphics=function(a){const d=this._ensureActiveGraphicsIterator(),b=Q.invertOrIdentity(ba,this._runningViewState.camera.projectionMatrix),
e="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&0<this._runningViewState.camera.relativeElevation?ca:null;let g=0;x.isSome(e)&&(u.transformMat4(e,r.ZEROS,this._runningViewState.camera.viewMatrix),e[3]=T.getReferenceEllipsoid(this.view.spatialReference).radius,g=A.distanceToSilhouette(e,r.ZEROS));for(;!a.done;){a.madeProgress();var f=d.next();if(!0===f.done)return this._resetActiveGraphicsIterator(),!0;const l=(f=f.value)&&f.info[this.visibilityGroup];l&&(this._collectGraphics3DGraphics(f,
b,e,g),l.culled?this._visible.delete(f.graphics3DGraphic.graphic.uid):this._visible.set(f.graphics3DGraphic.graphic.uid,f))}return!1};c._sortVisibleGraphics=function(a){const d=this._ensureSortGraphicsIterator();for(;!a.done;){const b=d.next();a.madeProgress();if(!0===b.done)return this._resetSortGraphicsIterator(),!0}return!1};c._deconflictVisibleGraphics=function(a){const d=this._ensureVisibleGraphicsIterator(),b=this.visibilityGroup===t.VisibilityGroup.LABEL;for(;!a.done;){a.madeProgress();var e=
d.next();if(!0===e.done)return this._resetVisibleGraphicsIterator(),!0;e=e.value;const f=e.info[this.visibilityGroup];if(f&&!f.culled){var g=e.graphics3DGraphic;(g=(!b||g.isVisible())&&!this._isConflicted(e))&&this._addToBins(e);f.visible=g;this._setGraphicVisibility(e,g);D.drawPoly(f,g)}}return!1};c._resetIterators=function(){this._iterators.active=null;this._iterators.visible=null;this._iterators.sort=null};c._ensureActiveGraphicsIterator=function(){this._iterators.active||(this._iterators.active=
M(this._active));return this._iterators.active};c._resetActiveGraphicsIterator=function(){this._iterators.active=null};c._ensureVisibleGraphicsIterator=function(){this._iterators.visible||(this._iterators.visible=M(this._visible));return this._iterators.visible};c._resetVisibleGraphicsIterator=function(){this._iterators.visible=null};c._ensureSortGraphicsIterator=function(){this._iterators.sort||(this._iterators.sort=aa(this._visible,this._iterators.sortArray,this.visibilityGroup));return this._iterators.sort};
c._resetSortGraphicsIterator=function(){this._iterators.sort=null};c._collectGraphics3DGraphics=function(a,d,b,e){var g=a.graphics3DGraphic;if(!g.destroyed){var f=a.info[this.visibilityGroup];if(g.isVisible(t.VisibilityGroup.GRAPHIC,t.VisibilityFlag.DECONFLICTION)){var l=this.getGraphicsLayers(g);p.empty(f.aabr);g=null;for(const q of l)if(this.layerSupportsDeconfliction(q)){l=q.stageObject.geometries[0].material;if(x.isNone(g)){g=ia;this._getProjectionInfo(q,d,g);if(g.isOutsideScreen||this._isCulledBySlice(a,
m)||x.isSome(b)&&this._isCulledByHorizon(g,b,e)){f.culled=!0;return}!V.TESTS_DISABLE_OPTIMIZATIONS&&f.visible&&(g.distance*=.7)}this._expandBoundingRect(f,q,l,g)}x.isNone(g)?f.culled=!0:(f.distance=g.distance,f.culled=!1)}else f.culled=!0}};c._getProjectionInfo=function(a,d,b){const e=this._runningViewState.camera;a=a.stageObject;var g=a.geometries[0];const f=g.material;var l=A.getCenter(a.boundingVolumeWorldSpace.bounds);u.transformMat4(m,l,e.viewMatrix);l=g.vertexAttributes;g=l.get(L.VertexAttribute.NORMAL).data;
l=l.get(L.VertexAttribute.AUXPOS1).data;f.applyShaderOffsetsView(m,g,a.transformation,l,e,b.scaleInfo,m);y.set(w,m[0],m[1],m[2],1);y.transformMat4(z,w,e.projectionMatrix);u.scale(b.positionNDC,z,1/z[3]);f.applyShaderOffsetsNDC(b.positionNDC,l,e,b.positionNDC,E);b.distanceWithoutPolygonOffset=e.depthNDCToWorld(E[2]);b.distance=E[2]===b.positionNDC[2]?b.distanceWithoutPolygonOffset:e.depthNDCToWorld(b.positionNDC[2]);y.set(z,b.positionNDC[0],b.positionNDC[1],b.positionNDC[2],1);y.transformMat4(w,z,
d);y.scale(w,w,1/w[3]);u.set(b.positionView,m[0],m[1],m[2])};c._isCulledByHorizon=function(a,d,b){u.copy(F.direction,a.positionView);u.set(F.origin,0,0,0);return A.intersectRay(d,F,da)?a.distanceWithoutPolygonOffset>b:!1};c._isCulledBySlice=function(a,d){return a.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&C.extrusionContainsPoint(this._runningViewState.slicePlane,d)};c._expandBoundingRect=function(a,d,b,{positionNDC:e,scaleInfo:g}){const f=this._runningViewState.camera;d=d.getScreenSize(ja);
X.applyPrecomputedScaleFactor(d,g.factor,d);d[0]*=f.pixelRatio;d[1]*=f.pixelRatio;b=p.offset(b.calculateRelativeScreenBounds(d,g.factorAlignment.scale,ea),G.lerp(0,f.fullWidth,.5+.5*e[0]),G.lerp(0,f.fullHeight,.5+.5*e[1]));e=this.iconMarginFactor;0!==e&&(e*=Math.min(p.width(b),p.height(b)),b[0]-=e,b[1]-=e,b[2]+=e,b[3]+=e);p.expand(a.aabr,b,a.aabr)};c._isConflicted=function(a){const d=a.graphics3DGraphic.graphic.uid;a=a.info[this.visibilityGroup];for(let b=Math.floor(a.aabr[0]/this._accBinsSizeX);b<=
Math.floor(a.aabr[2]/this._accBinsSizeX);b++)if(!(0>b||b>=this._accBinsNumX))for(let e=Math.floor(a.aabr[1]/this._accBinsSizeY);e<=Math.floor(a.aabr[3]/this._accBinsSizeY);e++){if(0>e||e>=this._accBinsNumY)continue;const g=this._accBins[b][e];for(let f=0;f<g.length;f++){const l=g.data[f],q=l.info[this.visibilityGroup];if(q&&q.visible&&l.graphics3DGraphic.graphic.uid!==d&&(this.accNumTests++,p.intersects(q.aabr,a.aabr)))return!0}}return!1};c._initBins=function(a,d){if(null==this._accBins){this._accBins=
[];for(var b=0;b<this._accBinsNumX;b++){this._accBins.push([]);var e=this._accBins[this._accBins.length-1];for(let g=0;g<this._accBinsNumY;g++)e.push(new H)}}else for(b=0;b<this._accBinsNumX;b++)for(e=0;e<this._accBinsNumY;e++)this._accBins[b][e].clear();this._accBinsSizeX=a/this._accBinsNumX;this._accBinsSizeY=d/this._accBinsNumY;this.accNumTests=0};c._addToBins=function(a){var d=a.info[this.visibilityGroup],b=Math.floor(d.aabr[0]/this._accBinsSizeX);const e=Math.floor(d.aabr[2]/this._accBinsSizeX),
g=Math.floor(d.aabr[1]/this._accBinsSizeY);for(d=Math.floor(d.aabr[3]/this._accBinsSizeY);b<=e;b++)if(!(0>b||b>=this._accBinsNumX))for(let f=g;f<=d;f++)0>f||f>=this._accBinsNumY||this._accBins[b][f].push(a)};c._setGraphicVisibility=function(a,d){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(t.VisibilityFlag.DECONFLICTION,d,this.visibilityGroup),this.visibilityGroup===t.VisibilityGroup.LABEL&&this.view.labeler.setLabelGraphicVisibility(a,d))};n._createClass(h,[{key:"dirty",get:function(){return this._dirty}},
{key:"state",get:function(){return this._state}},{key:"updating",get:function(){return this._state!==k.State.Idle||this._dirty}},{key:"updatingProgress",get:function(){if(!this.updating)return 1;const a=this._state/k.State.NumStates;return this._dirty?.5*a:a}},{key:"running",get:function(){return this.view.ready&&null!=this.view.state&&this.updating}}]);return h}(O);B.__decorate([I.property({constructOnly:!0})],k.Deconflictor.prototype,"view",void 0);B.__decorate([I.property({type:Boolean,readOnly:!0})],
k.Deconflictor.prototype,"updating",null);k.Deconflictor=B.__decorate([P.subclass("esri.views.3d.layers.graphics.Deconflictor")],k.Deconflictor);let ka=n._createClass(function(){}),ha=n._createClass(function(c=null,h=null,v=null){this.active=c;this.visible=h;this.sort=v;this.sortArray=new H({allocator:a=>a||new ka})});const ja=S.create(),ia=new (function(){function c(){this.positionView=r.create();this.positionNDC=r.create();this.distanceWithoutPolygonOffset=this.distance=0;this.scaleInfo=new Z.ScaleInfo}
n._createClass(c,[{key:"isOutsideScreen",get:function(){const h=this.positionNDC;return-1>h[0]||-1>h[1]||-1>h[2]||1<=h[0]||1<=h[1]}}]);return c}());k.DeconflictorGraphic=J;k.DeconflictorViewState=N;Object.defineProperty(k,Symbol.toStringTag,{value:"Module"})});