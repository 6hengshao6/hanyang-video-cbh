// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/asyncUtils ../../../../core/HandleOwner ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../layers/support/FeatureFilter ../../../../layers/support/floorFilterUtils ../graphics/QueryEngine ../../../support/Scheduler".split(" "),
function(b,m,e,p,q,r,c,t,u,f,B,C,D,v,w,x,y,z){b.FeatureVisibilityFilter=function(k){function l(h){var a=A.call(this,h);a._updateTask=null;a._frameTask=null;a._queryEngine=null;a._updateRequested=!0;a._updateVisibility=async g=>{if(c.isNone(a._compositedFeatureFilter)&&c.isNone(a._sceneFilter)||0===a.context.getFeatureCount())return a._frameTask.schedule(()=>a.clear(),g);try{const d=await a._queryEngine.executeQueryForIdSet(a._compositedFeatureFilter,a._sceneFilter,g);return a._frameTask.schedule(()=>
{a.context.updateFeatureVisibilities(n=>d.has(n))},g)}catch(d){return t.throwIfAbortError(d),r.getLogger(a.declaredClass).warn(`FeatureFilter query failed: ${d}`,{error:d}),a._frameTask.schedule(()=>{a.context.setAllFeaturesVisibility(!0)},g)}};return a}m._inherits(l,k);var A=m._createSuper(l);k=l.prototype;k.initialize=function(){const h=z.TaskPriority.FILTER_VISIBILITY,{layer:a,view:g}=this._layerView,{featureStore:d}=this.context;this._queryEngine=new y.QueryEngine({context:{spatialReference:g.spatialReference,
layer:a,scheduler:g.resourceController.scheduler,featureStore:d,hasM:"hasM"in this._layerView?this._layerView.hasM:!1,hasZ:"hasZ"in this._layerView?this._layerView.hasZ:!1},priority:h});this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(h,this);this.updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),u.initial)};k.destroy=function(){this._updateRequested=!1;this.handles.removeAll();this.updatingHandles.removeAll();this.clear();this._updateTask=
c.abortMaybe(this._updateTask);this._frameTask=c.removeMaybe(this._frameTask);this._queryEngine=c.destroyMaybe(this._queryEngine);this._set("context",null)};k.reapply=function(){this._updateRequested=!0};k.clear=function(){this._queryEngine.clear();this.context.clearFeaturesVisibility()};k.runTask=function(h){this._updateRequested&&(this._updateTask=c.abortMaybe(this._updateTask),this._updateTask=p.createTask(this._updateVisibility),this._updateRequested=!1,h.madeProgress());this._frameTask.processQueue(h)};
m._createClass(l,[{key:"updating",get:function(){return this.running||this.updatingHandles.updating||c.isSome(this._updateTask)&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return c.isNone(this._compositedFeatureFilter)&&c.isNone(this._sceneFilter)}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in
this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return x.getFloorFilterClause(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){const {_featureFilter:h,_timeExtent:a,_floorFilter:g}=this;if(c.isNone(a)&&c.isNone(g))return h;const d=c.isSome(h)?h.clone():new w;c.isSome(a)&&(d.timeExtent=c.isSome(d.timeExtent)?d.timeExtent.intersection(a):a);
if(c.isSome(g)){const n=c.isNone(d.where)||""===d.where;d.where=n?g:`(${d.where}) AND (${g})`}return d}},{key:"_layerView",get:function(){return this.context.layerView}}]);return l}(q.HandleOwner);e.__decorate([f.property({constructOnly:!0})],b.FeatureVisibilityFilter.prototype,"context",void 0);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"updating",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"running",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,
"defaultVisibility",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_featureFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_sceneFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_floorFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_timeExtent",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_compositedFeatureFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,
"_layerView",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_updateTask",void 0);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_updateRequested",void 0);b.FeatureVisibilityFilter=e.__decorate([v.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],b.FeatureVisibilityFilter);Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});