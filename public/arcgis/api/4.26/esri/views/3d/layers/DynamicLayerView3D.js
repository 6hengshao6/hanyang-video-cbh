// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/asyncUtils ../../../core/handleUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/aaBoundingRect ./interfaces ./LayerView3D ./support/overlayImageUtils ./support/projectExtentUtils ../support/debugFlags ../terrain/interfaces ../webgl-engine/lib/ModelDirtyTypes ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/lib/UpdatePolicy ../webgl-engine/materials/ImageMaterial ../../layers/LayerView ../../layers/RefreshableLayerView ../../support/layerViewUtils ../../webgl/enums".split(" "),
function(r,n,B,E,v,q,h,F,w,p,W,X,G,C,k,H,I,y,J,K,x,z,L,M,N,O,P,Q,R,D){p=function(e){function t(){var a=S.apply(this,arguments);a.drapeSourceType=H.DrapeSourceType.RasterImage;a.updatePolicy=N.UpdatePolicy.SYNC;a.fullExtentInLocalViewSpatialReference=null;a.maximumDataResolution=null;a._images=[];a._extents=[];a._overlays=[];a.updateWhenStationary=!0;a._drapeSourceRenderer=null;a.refreshDebounced=h.debounce(async c=>{a.destroyed||await a._doRefresh(c).catch(b=>{h.isAbortError(b)||v.getLogger(a.declaredClass).error(b)})},
2E3);return a}r._inherits(t,e);var S=r._createSuper(t);e=t.prototype;e.initialize=function(){this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this);this.handles.add(E.makeHandle(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this)));this.addResolvingPromise(J.toViewIfLocal(this).then(a=>this._set("fullExtentInLocalViewSpatialReference",a)));this.updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler());this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(()=>
{this._isScaleRangeActive()&&this.notifyChange("suspended")},()=>{}));this._isScaleRangeLayer()&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.notifyChange("suspended"))};e.destroy=function(){this.clear()};e.setDrapingExtent=function(a,c){this._spatialReference=c;a.forEach(b=>{this._overlays[b.index]=b;this._updateImageExtent(b)})};e._updateImageExtent=function(a){const c=this._clippedExtent(a.extent,T);if(!q.isNone(c)){var b=y.computeImageExportSize(a.extent,c,a.resolution),
f=a.pixelRatio*this.view.state.pixelRatio,{layer:d}=this;if("imageMaxWidth"in d&&null!=d.imageMaxWidth||"imageMaxHeight"in d&&null!=d.imageMaxHeight){var g=d.imageMaxWidth;d=d.imageMaxHeight;if(b.width>g){const l=g/b.width;b.height=Math.floor(b.height*l);b.width=g;f*=l}b.height>d&&(g=d/b.height,b.width=Math.floor(b.width*g),b.height=d,f*=g)}g=this._extents[a.index];g&&k.equals(g.extent,c)&&this._imageSizeEquals(c,g.imageSize,b)||(this._extents[a.index]={extent:k.create(c),imageSize:b,pixelRatio:f},
this.suspended||this._fetch(a.index).catch(l=>{h.isAbortError(l)||v.getLogger(this.declaredClass).error(l)}))}};e.clear=function(){for(let a=0;a<this._images.length;a++)this._clearImage(a)};e.doRefresh=async function(){return this._doRefresh()};e._doRefresh=async function(a){if(!this.suspended){var c=[];for(let b=0;b<this._extents.length;b++)this._extents[b]&&c.push(this._fetch(b,a));await h.eachAlways(c)}};e.canResume=function(){if(!r._get(r._getPrototypeOf(t.prototype),"canResume",this).call(this))return!1;
var a=this.layer;if(this._isScaleRangeActive()){const {minScale:c,maxScale:b}=a.effectiveScaleRange;a=this.view.scale;if(a<b||0<c&&a>c)return!1}return!0};e.isUpdating=function(){return this._images.some(a=>!!a.loadingPromise)};e.processResult=async function(a,c,b){if(c instanceof HTMLImageElement||c instanceof HTMLCanvasElement)a.image=c};e.findExtentInfoAt=function(a){for(const c of this._extents){const b=c.extent;if((new C(b[0],b[1],b[2],b[3],this._spatialReference)).contains(a))return c}return null};
e.getFetchOptions=function(){};e.redraw=async function(a,c){await B.forEach(this._images,async(b,f)=>{b&&(await a(b,c),await this._createStageObjects(f,b.image,c))})};e._imageSizeEquals=function(a,c,b){if(!this.maximumDataResolution)return!1;const f=k.width(a)/this.maximumDataResolution.x;a=k.height(a)/this.maximumDataResolution.y;a=Math.abs(a/c.height-a/b.height);const d=K.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return Math.abs(f/c.width-f/b.width)<=d&&a<=d};e._fetch=async function(a,c){if(!this.suspended){var b=
this._extents[a],f=b.extent;this._images[a]||(this._images[a]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:k.create(f)});var d=this._images[a];d.loadingAbortController=q.abortMaybe(d.loadingAbortController);var g=new C(f[0],f[1],f[2],f[3],this._spatialReference);if(0===g.width||0===g.height)this._clearImage(a);else{var l=new AbortController;d.loadingAbortController=l;h.onAbort(c,()=>l.abort());var u=l.signal,
A=this._waitFetchReady(u).then(async()=>{const m={requestAsImageElement:!0,pixelRatio:this._overlays[a].pixelRatio,...this.getFetchOptions(),signal:u},{height:U,width:V}=b.imageSize;return this.layer.fetchImage(g,V,U,m)}).then(m=>{if(h.isAborted(u))throw v.getLogger(this.declaredClass).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),h.createAbortError();return this.processResult(d,m)}).then(()=>{k.copy(d.renderExtent,
f)}).finally(()=>{A===d.loadingPromise&&(d.loadingPromise=null,d.loadingAbortController=null)});d.loadingPromise=A;this.notifyChange("updating");await A.then(async()=>{if(u.aborted)throw h.createAbortError();await this._createStageObjects(a,d.image,u);this.notifyChange("updating")}).catch(m=>{m&&!h.isAbortError(m)&&v.getLogger(this.declaredClass).error(m);this.notifyChange("updating");throw m;})}}};e._clearImage=function(a){if(a=this._images[a]){q.isSome(a.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([a.renderGeometry],
z.DirtyOperation.UPDATE),a.renderGeometry=null);const c=this.view._stage;c.remove(a.texture);a.texture=null;c.remove(a.material);a.material=null;a.loadingAbortController=q.abortMaybe(a.loadingAbortController);a.loadingPromise=null;a.image=null;a.pixelData=null}};e._createStageObjects=async function(a,c,b){const f=this.view._stage,d=this._images[a];var g=()=>{f.remove(d.texture);d.texture=null;q.isSome(d.renderGeometry)&&(this._drapeSourceRenderer.removeGeometries([d.renderGeometry],z.DirtyOperation.UPDATE),
d.renderGeometry=null)};if(c){c=new M.Texture(c,{width:c.width,height:c.height,preMultiplyAlpha:!0,wrap:{s:D.TextureWrapMode.CLAMP_TO_EDGE,t:D.TextureWrapMode.CLAMP_TO_EDGE}});await B.result(this._images[a===x.OverlayIndex.INNER?x.OverlayIndex.OUTER:x.OverlayIndex.INNER].loadingPromise);h.throwIfAborted(b);g();f.add(c);await f.loadImmediate(c);d.texture=c;q.isNone(d.material)?(d.material=new O.ImageMaterial({transparent:!0,textureId:c.id}),f.add(d.material)):d.material.setParameters({textureId:c.id});
if(a===x.OverlayIndex.INNER)g=y.createGeometryForExtent(d.material,d.renderExtent);else{b=this._images[0].renderExtent;if(!b){g();return}g=y.createOuterImageGeometry(d.material,b,d.renderExtent)}d.renderGeometry=new L.RenderGeometry(g);d.renderGeometry.localOrigin=this._overlays[a].renderLocalOrigin;this._drapeSourceRenderer.addGeometries([d.renderGeometry],z.DirtyOperation.UPDATE)}else g(),f.remove(d.material),d.material=null};e._isScaleRangeLayer=function(){return"effectiveScaleRange"in this.layer};
e._isScaleRangeActive=function(){const a=this.layer;if(!this._isScaleRangeLayer())return!1;const {minScale:c,maxScale:b}=a.effectiveScaleRange;return R.isScaleRangeActive(c,b)};e._clippedExtent=function(a,c){if("local"!==this.view.viewingMode)return k.copy(c,a);const b=this.view.basemapTerrain;return b.ready?k.intersection(a,b.extent,c):k.copy(c,a)};e._suspendedChangeHandler=function(){this.suspended?this.clear():this.refreshDebounced()};e._waitFetchReady=async function(a){await F.whenOnce(()=>this.view.stationary,
a);h.throwIfAborted(a)};return r._createClass(t)}(Q(I.LayerView3D(P)));n.__decorate([w.property()],p.prototype,"layer",void 0);n.__decorate([w.property()],p.prototype,"suspended",void 0);n.__decorate([w.property({readOnly:!0})],p.prototype,"fullExtentInLocalViewSpatialReference",void 0);n.__decorate([w.property()],p.prototype,"updating",void 0);n=p=n.__decorate([G.subclass("esri.views.3d.layers.DynamicLayerView3D")],p);const T=k.create();return n});