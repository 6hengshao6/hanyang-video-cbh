// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../geometry/projection ../../../geometry/support/aaBoundingBox ../../../geometry/support/spatialReferenceUtils ./LayerView3D ./support/PopupSceneLayerView ../../layers/LayerView ../../webgl/context-util ../../../geometry/SpatialReference".split(" "),
function(r,q,m,n,v,d,k,t,J,K,L,A,u,w,B,x,C,D,E,F,G,H){var g;(function(c){c[c.API=1]="API";c[c.VerboseAPI=2]="VerboseAPI";c[c.Error=3]="Error"})(g||(g={}));const l=w.create(),y=w.create();m=function(c){function p(){var a=I.apply(this,arguments);a._suspendedHandle=null;a._usedMemory=0;a._futureMemory=0;a.type="voxel-3d";a.slicePlaneEnabled=!1;a._wasmLayerId=-1;a.ignoresMemoryFactor=!0;a._dbgFlags=new Set;return a}r._inherits(p,c);var I=r._createSuper(p);c=p.prototype;c.initialize=function(){this._dbgFlags.add(g.Error);
if("local"!==this.view.viewingMode)throw new n("voxel:unsupported-viewingMode","Voxel layers support local viewingMode only.",{});if(this.view._stage.renderView.renderingContext.type!==G.ContextType.WEBGL2)throw new n("voxel:unsupported-context","Voxel layers are supported in WebGL2 rendering contexts only.",{});if(!this.view._stage.renderView.renderingContext.capabilities.colorBufferFloat?.textureFloat)throw new n("voxel:missing-color-buffer-float","Voxel layers require the WebGL2 extension EXT_color_buffer_float",
{});if(!C.equals(this.layer.spatialReference,this.view.spatialReference))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});var a=this.layer.currentVariableId,b=this.layer.getVolume(a);a=this.layer.getVariable(a);if(d.isSome(b)&&d.isSome(a)){var e=b.dimensions[0];const h=b.dimensions[1],f=b.zDimension;if(1<f){b=e.size*h.size*b.dimensions[f].size;e=1;switch(a.renderingFormat.type){case "Int16":case "UInt16":e=
2;break;case "Int32":case "UInt32":case "Float32":e=4}this._futureMemory=e*b}}a=this.view.addVoxelLayerViewToWasm(this).then(h=>{this._wasmLayerId=h;this._suspendedHandle=k.watch(()=>this.suspended,f=>{const z=this.view.voxelWasm;d.isSome(z)&&z.setEnabled(this,!f)},k.initial);this.handles.add([k.watch(()=>this.layer.renderMode,f=>this._pushRenderModeToWasm(f)),k.watch(()=>this.layer.currentVariableId,f=>this._pushCurrentVariableIdToWasm(f)),k.watch(()=>this.layer.getSections(),f=>this._pushSectionsToWasm(f)),
k.watch(()=>this.layer.getVariableStyles(),f=>this._pushVariableStylesToWasm(f)),k.watch(()=>this.layer.getVolumeStyles(),f=>this._pushVolumeStylesToWasm(f)),k.watch(()=>this.layer.enableDynamicSections,f=>this._pushEnableDynamicSectionsToWasm(f)),k.watch(()=>this.layer.enableIsosurfaces,f=>this._pushEnableIsosurfacesToWasm(f)),k.watch(()=>this.layer.enableSections,f=>this._pushEnableSectionsToWasm(f)),k.watch(()=>this.layer.enableSlices,f=>this._pushEnableSlicesToWasm(f)),k.watch(()=>this.slicePlaneEnabled,
f=>this._pushAnalysisSliceToWasm(f,this.view.slicePlane)),k.watch(()=>this.view.slicePlane,f=>this._pushAnalysisSliceToWasm(this.slicePlaneEnabled,f))])}).catch(h=>{this.view.removeVoxelLayerViewFromWasm(this);this._wasmLayerId=-1;if(-1===h)throw new n("voxel:addLayer-failure","The voxel layer description was invalid.",{});if(-2===h)throw new n("voxel:addLayer-failure","The voxel layer web assembly module failed to download.",{});});this.addResolvingPromise(a)};c.destroy=function(){this.view.removeVoxelLayerViewFromWasm(this);
this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null)};c.isUpdating=function(){const a=this.view.voxelWasm;return 0>this._wasmLayerId||!d.isSome(a)?!1:a.isUpdating(this._wasmLayerId)};c.updatingFlagChanged=function(){this.notifyChange("updating")};c.whenGraphicBounds=function(a,b){if(b=a.attributes["Voxel.WorldPosition"])if(a=x.empty(),b=JSON.parse(b),B.projectVectorToVector(b,this.view.renderSpatialReference,y,this.view.spatialReference||H.WGS84))return x.expandWithVec3(a,
y),Promise.resolve({boundingBox:a,screenSpaceObjects:[]});return Promise.reject()};c.setUsedMemory=function(a){this._usedMemory=a;this._futureMemory=0};c.captureFrustum=function(){const a=this.view.voxelWasm;d.isSome(a)&&a.captureFrustum()};c.toggleFullVolumeExtentDraw=function(){const a=this.view.voxelWasm;d.isSome(a)&&a.toggleFullVolumeExtentDraw(this)};c.getLayerTimes=function(){let a=[];const b=this.view.voxelWasm;d.isSome(b)&&(a=b.getLayerTimes(this));return a};c.getCurrentLayerTimeIndex=function(){let a=
0;const b=this.view.voxelWasm;d.isSome(b)&&(a=b.getCurrentLayerTimeIndex(this));return a};c._pushRenderModeToWasm=function(a){const b=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushRenderModeToWasm() called, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);d.isSome(b)&&b.setRenderMode(this,a)||this._dbg(g.Error,"VoxelLayerView3D._pushRenderModeToWasm() failed!")};c._pushSectionsToWasm=function(a){const b=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushSectionsToWasm() called, ${d.isSome(b)?
"have WASM":"don't have WASM!!!"}`);d.isSome(b)&&b.setStaticSections(this,a)||this._dbg(g.Error,"VoxelLayerView3D._pushSectionsToWasm() failed!")};c._pushCurrentVariableIdToWasm=function(a){const b=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushCurrentVariableIdToWasm() called!, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);d.isSome(b)&&b.setCurrentVariable(this,a)||this._dbg(g.Error,"VoxelLayerView3D._pushCurrentVariableIdToWasm() failed!")};c._pushVariableStylesToWasm=function(a){const b=
this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushVariableStylesToWasm() called, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);let e=!1;d.isSome(b)&&((e=b.setVariableStyles(this,a))||this._dbg(g.Error,"VoxelLayerView3D._pushVariableStylesToWasm() failed!"))};c._accountForEnableSlices=function(a,b){b=d.isSome(b)?b:this.layer.enableSlices;for(let e=0;e<a.length;++e){const h=a[e];for(const f of h.slices)f.enabled=f.enabled&&b}};c._pushVolumeStylesToWasm=function(a){const b=this.view.voxelWasm;
this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushVolumeStylesToWasm() called, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);let e=!1;d.isSome(b)&&(this._accountForEnableSlices(a,null),(e=b.setVolumeStyles(this,a))||this._dbg(g.Error,"VoxelLayerView3D._pushVolumeStylesToWasm() failed!"))};c._pushAnalysisSliceToWasm=function(a,b){const e=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushAnalysisSliceToWasm() called, ${d.isSome(e)?"have WASM":"don't have WASM!!!"}`);var h=!1;d.isSome(e)&&
(d.isSome(b)?(h=b.origin,u.cross(l,b.basis1,b.basis2),u.normalize(l,l),h=e.setAnalysisSlice(this,a,h,l)):(u.set(l,0,0,1),h=e.setAnalysisSlice(this,!1,l,l)),h||this._dbg(g.Error,"VoxelLayerView3D._pushAnalysisSliceToWasm() failed!"))};c._pushEnableDynamicSectionsToWasm=function(a){const b=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushEnableDynamicSectionsToWasm() called, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);let e=!1;d.isSome(b)&&((e=b.setEnableDynamicSections(this,
a))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableDynamicSectionsToWasm() failed!"))};c._pushEnableSlicesToWasm=function(a){const b=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushEnableSlicesToWasm() called, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);var e=!1;d.isSome(b)&&(e=this.layer.getVolumeStyles(),this._accountForEnableSlices(e,a),(e=b.setVolumeStyles(this,e))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableSlicesToWasm() failed!"))};c._pushEnableIsosurfacesToWasm=
function(a){const b=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushEnableIsosurfacesToWasm() called, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);let e=!1;d.isSome(b)&&((e=b.setEnableIsosurfaces(this,a))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableIsosurfacesToWasm() failed!"))};c._pushEnableSectionsToWasm=function(a){const b=this.view.voxelWasm;this._dbg(g.VerboseAPI,`VoxelLayerView3D._pushEnableSectionsToWasm() called, ${d.isSome(b)?"have WASM":"don't have WASM!!!"}`);
let e=!1;d.isSome(b)&&((e=b.setEnableSections(this,a))||this._dbg(g.Error,"VoxelLayerView3D._pushEnableSectionsToWasm() failed!"))};c.whenGraphicAttributes=async function(a,b){return a};c._dbg=function(a,b){this._dbgFlags.has(a)&&(a===g.Error?v.getLogger(this.declaredClass).error(b):v.getLogger(this.declaredClass).warn(b))};r._createClass(p,[{key:"baseUrl",get:function(){return this.layer.parsedUrl?.path??""}},{key:"wasmLayerId",get:function(){return this._wasmLayerId}},{key:"usedMemory",get:function(){return this._usedMemory}},
{key:"unloadedMemory",get:function(){return this._futureMemory}},{key:"performanceInfo",get:function(){return{nodes:0,displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null}}}]);return p}(E.PopupSceneLayerView(D.LayerView3D(F)));q.__decorate([t.property()],m.prototype,"layer",void 0);q.__decorate([t.property()],m.prototype,"baseUrl",null);q.__decorate([t.property({type:Boolean})],m.prototype,"slicePlaneEnabled",void 0);return m=q.__decorate([A.subclass("esri.views.3d.layers.VoxelLayerView3D")],
m)});