// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../analysis/SlicePlane ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/boundedPlane ../../../../layers/Layer ../../../../layers/buildingSublayers/BuildingComponentSublayer ./sliceToolUtils ../support/projectionUtils ../../terrain/isTerrainSurfaceLayer".split(" "),
function(g,q,l,w,x,y,z,c,m,n,H,I,J,A,B,u,C,p,D,E){function F(d,k){h.has(d)||h.set(d,{all:[],activeController:null});h.get(d)?.all.push(k)}const r=z.getLogger("esri.views.3d.analysis.Slice.SliceController");g.SliceController=function(d){function k(a){a=G.call(this,a);a._handles=new y;a._internalChange=!1;a._currentSlicePlane=null;return a}q._inherits(k,d);var G=q._createSuper(k);d=k.prototype;d.initialize=function(){this._handles.add(this.analysis.excludedLayers.on("before-add",a=>{const b=a.item;
null!=b&&(b instanceof u||b instanceof C)?b instanceof u&&E.isTerrainSurfaceLayer(b)?(r.error("excludedLayers",`Layer '${b.title}, id:${b.id}' of type '${b.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),a.preventDefault()):this.analysis.excludedLayers.includes(b)&&a.preventDefault():(r.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),a.preventDefault())}));F(this.view,this);this._handles.add([m.watch(()=>
this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane();this._updateLayerViews()},{sync:!0}),m.watch(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),m.watch(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController();this._updateViewSlicePlane()},{sync:!0}),m.watch(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]);
this._handles.add([m.watch(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis");this._updateActiveController();this._updateBoundedPlaneFromSlicePlane();this._updateViewSlicePlane()};d.destroy=function(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null);var a=this.view;if(!h.has(a))throw Error("view expected in global slice register");const b=h.get(a),f=b?.all.lastIndexOf(this)??
-1;if(!b||-1===f)throw Error("controller expected in global slice register");b.all.splice(f,1);0===b.all.length&&h.delete(a);this._handles.destroy();this.set("view",null)};d._updateBoundedPlaneFromSlicePlane=function(){const a=this.analysis.shape;var b=this._currentSlicePlane;if(!(c.isNone(b)&&c.isNone(a)||c.isSome(b)&&c.isSome(a)&&a.equals(b))){var f=null;b=null;if(c.isSome(a)&&c.isSome(a.position)){f=a.position.spatialReference;const e=p.projectAndElevationAlignShape(a,this.view);c.isNone(e)&&D.logFailedGeometryProjectionError(this.analysis,
f,r);f=p.projectedShapeToPlane(e,this.view,{tiltEnabled:this.analysis.tiltEnabled},B.create());c.isSome(f)&&(b={heading:a.heading,tilt:a.tilt,position:a.position,width:a.width,height:a.height})}this._currentSlicePlane=b;this._internalChange=!0;this.analysisViewData.plane=f;this._internalChange=!1}};d._updateSlicePlaneFromBoundedPlane=function(){const a=p.planeToShape(this.analysisViewData.plane,this.view,this.view.spatialReference,new w);let b=null;c.isSome(a)&&(b={heading:a.heading,tilt:a.tilt,position:a.position,
width:a.width,height:a.height});this._currentSlicePlane=b;this._internalChange=!0;this.analysis.shape=a;this._internalChange=!1;this._updateViewSlicePlane()};d._updateActiveController=function(){if(!t){var a=h.get(this.view);a&&(this.analysisViewData.active?(c.isSome(a.activeController)&&a.activeController!==this?(t=!0,t=a.activeController.analysisViewData.active=!1):c.isSome(a.activeController),this._updateLayerViews(),a.activeController=this):c.isSome(a.activeController)&&a.activeController!==this||
!c.isSome(a.activeController)||a.activeController!==this||(a.activeController=null,this._updateLayerViews()))}};d._updateViewSlicePlane=function(){var a=this.view;const b=h.get(a)?.activeController;c.isSome(b)&&c.isSome(b.analysisViewData.plane)&&b.analysisViewData.visible?a.slicePlane=b.analysisViewData.plane:a.slicePlane=null};d._updateLayerViews=function(){const a=c.isSome(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,b=[],f=e=>{"layers"in e?e.layers.forEach(f):
b.push(e)};this.analysis.excludedLayers.forEach(f);this.view.allLayerViews.forEach(e=>{e.destroyed||("slicePlaneEnabled"in e&&(e.slicePlaneEnabled=a&&!b.includes(e.layer)),"sublayerViews"in e&&e.sublayerViews.forEach(v=>{v.slicePlaneEnabled=a&&!b.includes(v.sublayer)}))});null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=a&&!this.analysis.excludeGroundSurface)};q._createClass(k,[{key:"_allLayerAndSubLayerViews",get:function(){const a=this.view.allLayerViews.items;return a.concat(a.filter(p.isIBuildingSceneLayerView3D).flatMap(({sublayerViews:b})=>
b.items))}}]);return k}(x);l.__decorate([n.property()],g.SliceController.prototype,"view",void 0);l.__decorate([n.property()],g.SliceController.prototype,"analysis",void 0);l.__decorate([n.property()],g.SliceController.prototype,"analysisViewData",void 0);l.__decorate([n.property()],g.SliceController.prototype,"_allLayerAndSubLayerViews",null);g.SliceController=l.__decorate([A.subclass("esri.views.3d.analysis.Slice.SliceController")],g.SliceController);const h=new Map;let t=!1;Object.defineProperty(g,
Symbol.toStringTag,{value:"Module"})});