// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../geometry ../../../../analysis/dimensionUtils ../../../../analysis/LengthDimension ../../../../core/HandleOwner ../../../../core/Handles ../../../../core/lang ../../../../core/maybe ../../../../core/memoize ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3f64 ../../../../layers/graphics/hydratedFeatures ./lengthDimensionConstraintUtils ./lengthDimensionManipulatorUtils ./lengthDimensionUtils ./settings ../Slice/images/Factory ../../interactive/SnappingVisualizer3D ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/VerticesVisualElement ../../webgl-engine/lib/Material ../../webgl-engine/materials/ImageMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/coordinateHelper ../../../interactive/editGeometry/EditGeometry ../../../interactive/editGeometry/EditGeometryOperations ../../../interactive/snapping/SceneSnappingManagerPool ../../../interactive/snapping/SnappingContext ../../../interactive/snapping/SnappingDragPipelineStep ../../../interactive/snapping/SnappingOperation ../../../interactive/snapping/snappingUtils ../../../../geometry/Point".split(" "),
function(l,F,n,G,na,u,R,S,T,L,f,U,M,m,p,oa,V,N,H,v,h,C,w,W,X,Y,Z,A,aa,O,ba,ca,da,ea,fa,ha,ia,ja,ka,I){function J(){const {color:g,opacity:x}=w.settings.offsetManipulator;return new ba.RibbonLineMaterial({color:[...G.toUnitRGB(g),x],width:1,renderOccluded:A.RenderOccludedFlag.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}l.LengthDimensionSubTool=function(g){function x(a){var b=la.call(this,a);b._stagedDimension=null;b._computationManipulators=new Map;b._computationHandles=new T;b._getSnappingContext=
U.memoize(c=>new ha.SnappingContext({elevationInfo:{mode:"absolute-height",offset:0},pointer:c,editGeometryOperations:new ea.EditGeometryOperations(new da.EditGeometry("point",ca.createCoordinateHelper(!0,!1,b.view.spatialReference))),visualizer:new X.SnappingVisualizer3D}));b._snappingManagerResult=fa.acquire(a.view);b.addHandles(b._snappingManagerResult);b._unfocusedOffsetManipulatorMaterial=J();b._focusedOffsetManipulatorMaterial=J();b._thinOffsetManipulatorMaterial=J();b._thinOffsetManipulatorMaterial.setParameters({stipplePattern:O.createStipplePatternSimple(2)});
b._constraintSnappingIndicator=new Y.LineVisualElement({view:a.view,attached:!0,width:1,color:G.toUnitRGBA(w.settings.constraint.color),renderOccluded:A.RenderOccludedFlag.OccludeAndTransparent,stipplePattern:O.createStipplePatternSimple(5)});const d=G.toUnitRGBA(w.settings.disabledPointIndicator.color);d[3]*=w.settings.disabledPointIndicator.opacity;b._stagedStartIndicator=new Z.VerticesVisualElement({view:a.view,attached:!1,color:d,size:2*w.settings.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",
offset:0},spatialReference:a.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:A.RenderOccludedFlag.OccludeAndTransparent});return b}F._inherits(x,g);var la=F._createSuper(x);g=x.prototype;g.initialize=function(){this._snappingOperation=new ja.SnappingOperation({view:this.view});const {color:a,contrastColor:b}=w.settings.orientationManipulator;this._orientationManipulatorTexture=W.getRotateHeadingTexture(this.view.toolViewManager.textures,{accentColor:a,contrastColor:b,premultiplyAlpha:!this.view._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result});
this._orientationManipulatorMaterial=new aa.ImageMaterial({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:A.RenderOccludedFlag.Opaque});const {computations:d}=this.analysisViewData;for(const c of d)this._addComputation(c);this.addHandles([d.on("after-add",c=>this._addComputation(c.item)),d.on("after-remove",c=>this._removeComputation(c.item))]);this.addHandles([m.watch(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),
({stagedPoint:c,stagedComputation:e})=>{f.isNone(e)||f.isNone(c)||(c=H.clonePoint(c,new I),this._applyPointUpdate(e,{endPoint:c}))},m.sync),m.watch(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(c,e)=>{const {stagedDimension:k,selectedComputation:y,firstGrabbedManipulator:z}=c;if(k!==e?.stagedDimension||z!==e?.firstGrabbedManipulator)for(const [q,B]of this._computationManipulators)this._updateManipulators(q,
B,c);else for(const q of[y,e?.selectedComputation])f.isSome(q)&&(e=this._computationManipulators.get(q),this._updateManipulators(q,e,c))},m.syncAndInitial),m.watch(()=>this.analysis.style.lineSize,c=>{this._updateManipulatorStyle(c)},m.initial),m.watch(()=>this.view.state.camera,()=>{f.isSome(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),m.watch(()=>f.applySome(this._stagedComputation,c=>{c=c.elevationAlignedStartPoint;const e=N.create();return f.isSome(c)&&
this.view.renderCoordsHelper.toRenderCoords(c,e)?e:null}),c=>{f.isSome(c)?(this._stagedStartIndicator.vertices=[c],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]);this.addHandles(this._constraintHandles);this.addHandles(this._snappingIndicatorHandles);ka.setupSnappingToggleHandles(this,()=>{const c=this._activeComputation;var e=this._stagedComputation;if(f.isNone(c)||f.isSome(e))e=f.unwrapOr(this.view.inputManager.latestPointerType,"mouse"),e=this._getSnappingContext(e),
this.updatingHandles.addPromise(M.ignoreAbortErrors(this._snappingOperation.resnap(this._snappingManager,e)));if(f.isSome(c)){const {start:k,end:y}=this._computationManipulators.get(c);if(k.grabbing||y.grabbing){e=k.grabbing?"start":"end";const z=this._computeConstraint(c);v.reapplyConstraint(c,e,{constraint:z,view:this.view})}}})};g.destroy=function(){this._snappingOperation=f.destroyMaybe(this._snappingOperation);this._computationHandles.destroy();this._constraintSnappingIndicator.destroy();this._stagedStartIndicator.destroy();
this._orientationManipulatorMaterial.dispose();this._orientationManipulatorTexture.release()};g.removeStaged=function(){return f.isSome(this._stagedDimension)?(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0):!1};g.onDeactivate=function(){this.removeStaged();this._resetSnappingState()};g.onClick=function(a){const {_stagedDimension:b}=this;if(f.isNone(b))return a=this._onUnstagedClick(a),this.analysis.dimensions.add(a),null;this._onStagedClick(a);return b};g.onPointerMove=
function({mapPoint:a,pointerType:b}){"touch"!==b&&(b=this._getSnappingContext(b),this.updatingHandles.addPromise(M.ignoreAbortErrors(this._snappingOperation.snap({point:a},this._snappingManager,b))))};g.onManipulatorSelectionChanged=function(){f.isSome(this.analysisViewData.selectedComputation)&&!this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected&&(this.analysisViewData.selectedDimension=null)};g._onUnstagedClick=function({mapPoint:a,pointerType:b}){let d=
a;"mouse"===b&&(b=this._getSnappingContext(b),d=this._snappingManager.update({point:a,context:b}));this._stagedDimension=a=new R({startPoint:H.clonePoint(d,new I),endPoint:null,measureType:u.LengthDimensionMeasureType.Horizontal});this._resetSnappingState();return a};g._onStagedClick=function({mapPoint:a,pointerType:b}){const d=this._stagedComputation;if(!f.isNone(d)){var c=a;"mouse"===b&&(b=this._getSnappingContext(b),c=this._snappingManager.update({point:a,context:b}));a=H.clonePoint(c,new I);this._applyPointUpdate(d,
{endPoint:a});this._stagedDimension=null;this._resetSnappingState()}};g._resetSnappingState=function(){this._snappingManager.doneSnapping();this._snappingOperation.abort();this._snappingOperation.stagedPoint=null};g._addComputation=function(a){if(!this._computationManipulators.has(a)){var b=this._setupPointManipulator(a,{isStart:!0}),d=this._setupPointManipulator(a,{isStart:!1}),c=this._setupOffsetManipulator(a),e=this._setupHeadingManipulator(a),k=this._setupRotationManipulator(a),y=this._setupMeasureTypeManipulator(a,
u.LengthDimensionMeasureType.Direct),z=this._setupMeasureTypeManipulator(a,u.LengthDimensionMeasureType.Horizontal),q=this._setupMeasureTypeManipulator(a,u.LengthDimensionMeasureType.Vertical);b=new h.LengthDimensionManipulators({start:b,end:d,offset:c,heading:e,rotation:k,direct:y,horizontal:z,vertical:q});this._setupComputationToManipulatorsSync(a,b);this._computationManipulators.set(a,b);this.manipulators.addMany(b.values())}};g._removeComputation=function(a){const b=this._computationManipulators.get(a);
if(!f.isNone(b)){this._computationHandles.remove(a);this._computationManipulators.delete(a);for(const d of b.values())this.manipulators.remove(d)}};g._setupComputationToManipulatorsSync=function(a,b){this._computationHandles.add([m.watch(()=>a.geometry,()=>this._updateManipulators(a,b),{...m.syncAndInitial,equals:L.equals})],a)};g._setupPointManipulator=function(a,b){const {view:d}=this,{dimension:c}=a,e=h.createPointManipulator(d,{metadata:c});b=h.pointManipulatorHandles(e,{isStart:b.isStart,createSnappingPipelineStep:k=>
ia.createSnapDragEventPipelineStep({snappingContext:this._getSnappingContext(k),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:c,onUpdate:k=>this._applyPointUpdate(a,k),view:d});this._computationHandles.add(b,a);return e};g._setupOffsetManipulator=function(a){var {view:b}=this;const d=h.createOffsetManipulator(b,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,
metadata:a.dimension});b=h.offsetManipulatorHandles(d,{computation:a,view:b});this._computationHandles.add(b,a);return d};g._setupHeadingManipulator=function(a){var {view:b}=this;const d=h.createOrientationManipulator(b,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:a.dimension});b=h.headingManipulatorHandles(d,{computation:a,view:b});this._computationHandles.add(b,a);return d};g._setupRotationManipulator=function(a){var {view:b}=this;const d=h.createOrientationManipulator(b,
{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:a.dimension});b=h.rotationManipulatorHandles(d,{computation:a,view:b});this._computationHandles.add(b,a);return d};g._setupMeasureTypeManipulator=function(a,b){const {view:d}=this,c=h.createMeasureTypeManipulator(d,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,
metadata:a.dimension});b=h.measureTypeManipulatorHandles(c,{computation:a,manipulatorMeasureType:b,view:d});this._computationHandles.add(b,a);return c};g._updateManipulators=function(a,b,d={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const {stagedDimension:c,selectedComputation:e,firstGrabbedManipulator:k}=d,{start:y,end:z,offset:q,heading:B,rotation:D}=b;d=e===a;const P=C.isValidComputation(a),
{dimension:K}=a;for(var r of b.values()){const t=P&&f.isNone(c)&&(f.isNone(k)||r===k);r===q?(r.available=t,r.selected=d):r.available=t&&d}if(P){f.isSome(this._computeConstraint(a))?b.forEachMeasureTypeManipulator(t=>t.available=!1):b.manipulatorForMeasureType(K.measureType).available=!1;for(const t of[B,D])if(K.measureType!==u.LengthDimensionMeasureType.Direct||0===K.offset)t.available=!1;C.arePointsVerticallyAligned(a)?D.available=!1:B.available=!1;({geometry:r}=a);y.renderLocation=r.directSegment.startRenderSpace;
z.renderLocation=r.directSegment.endRenderSpace;var {renderCoordsHelper:E}=this.view;h.updateOffsetManipulatorTransform(q,r,E);B.available&&h.updateHeadingManipulatorTransform(B,a,E);D.available&&h.updateRotationManipulatorTransform(D,a,E);b.forEachMeasureTypeManipulator((t,ma)=>{t.available&&h.updateMeasureTypeManipulatorTransform(t,a,ma,E)})}};g._updateManipulatorStyle=function(a){const b=h.unfocusedOffsetWidth(a),d=h.focusedOffsetWidth(a);a={lineSizePt:a,material:this._orientationManipulatorMaterial};
for(const {offset:c,heading:e,rotation:k}of this._computationManipulators.values())c.radius=d/2,h.updateOrientationManipulator(e,a),h.updateOrientationManipulator(k,a);this._unfocusedOffsetManipulatorMaterial.setParameters({width:b});this._focusedOffsetManipulatorMaterial.setParameters({width:d})};g._applyPointUpdate=function(a,b){const {view:d}=this,c=C.computationToGeometryDependencies(a);"startPoint"in b&&(c.elevationAlignedStartPoint=b.startPoint);"endPoint"in b&&(c.elevationAlignedEndPoint=b.endPoint);
const e=C.computeGeometryFromDimension(c,d.renderCoordsHelper);if(!f.isNone(e)){var k=this._computeConstraint({...c,geometry:e});v.applyConstraint(a,b,{...c,constraint:k,unconstrainedGeometry:e,view:d});a===this._stagedComputation&&this._updateStagedDimensionOffset(a)}};g._updateStagedDimensionOffset=function(a){if(!f.isNone(a.geometry)){a.geometry.directSegment.eval(.5,Q);var b=this.view.state.camera.computeRenderPixelSizeAt(Q);a.dimension.offset=w.settings.initialOffsetPx*b}};g._computeConstraint=
function(a){return v.computeConstraint(v.constraintDependencies(a,this._snappingManager.options),this.view)};F._createClass(x,[{key:"updating",get:function(){return this.updatingHandles.updating||this._snappingManager.updating}},{key:"firstGrabbedManipulator",get:function(){return this.parentTool.firstGrabbedManipulator}},{key:"hasGrabbedManipulators",get:function(){return this.parentTool.hasGrabbedManipulators}},{key:"snappingOptions",get:function(){return this._snappingManager.options}},{key:"_snappingManager",
get:function(){return this._snappingManagerResult.snappingManager}},{key:"_activeComputation",get:function(){if(f.isSome(this._stagedComputation))return this._stagedComputation;const {selectedComputation:a}=this.analysisViewData;return this.hasGrabbedManipulators&&f.isSome(a)?a:null}},{key:"_stagedComputation",get:function(){const a=this._stagedDimension,b=this.analysisViewData.computations.at(-1);return f.isNone(a)||f.isNone(b)||b.dimension!==a?null:b}},{key:"_constraintHandles",get:function(){return[m.when(()=>
this.analysisViewData.selectedComputation,a=>{a.previousConstraint=this._computeConstraint(a)},{...m.syncAndInitial,equals:L.equals}),m.watch(()=>{const a=this._activeComputation;if(f.isNone(a))return null;const {measureType:b,orientation:d}=a.dimension;return{measureType:b,orientation:d,computation:a}},(a,b)=>{if(f.isSome(a)&&f.isNone(b)){const {measureType:d,orientation:c,computation:e}=a;switch(e.previousConstraint){case v.LengthDimensionConstraint.Horizontal:e.preConstraintProperties={measureType:u.LengthDimensionMeasureType.Horizontal,
orientation:0};break;case v.LengthDimensionConstraint.Vertical:e.preConstraintProperties={measureType:u.LengthDimensionMeasureType.Vertical,orientation:0};break;case v.LengthDimensionConstraint.Direct:e.preConstraintProperties={measureType:u.LengthDimensionMeasureType.Direct,orientation:c};break;default:e.preConstraintProperties={measureType:d,orientation:c}}}f.isNone(a)&&f.isSome(b)&&(b.computation.preConstraintProperties=null)},m.sync)]}},{key:"_snappingIndicatorHandles",get:function(){return[m.watch(()=>
({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:a,activeComputation:b})=>{const d=this._constraintSnappingIndicator;this.removeHandles("snapping-indicator-event-handles");if(f.isNone(b))d.attached=!1;else if(b===a)d.attached=!0;else{const {start:c,end:e}=this._computationManipulators.get(b);a=()=>{d.attached=c.grabbing||e.grabbing};a();this.addHandles([c.events.on("grab-changed",a),e.events.on("grab-changed",a)],"snapping-indicator-event-handles")}}),
m.watch(()=>{const a=this._activeComputation;return f.isSome(a)?{geometry:a.geometry,constraint:a.previousConstraint}:{}},({geometry:a,constraint:b})=>{const d=this._constraintSnappingIndicator;f.isSome(a)&&f.isSome(b)&&b!==v.LengthDimensionConstraint.Direct?(d.visible=!0,d.setGeometryFromSegment(a.directSegment)):d.visible=!1})]}},{key:"testInfo",get:function(){const a=b=>this.analysisViewData.computations.find(d=>d.dimension===b);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=
A.RenderOccludedFlag.Occlude;this.manipulators.forEach(({manipulator:b})=>{for(const {geometry:d}of b.renderObjects)d.material.setParameters({renderOccluded:A.RenderOccludedFlag.Occlude})})},getManipulatorsForDimension:b=>this._computationManipulators.get(a(b)),getComputationForDimension:b=>a(b),getConstraintForDimension:b=>{b=a(b);return f.isSome(b)?this._computeConstraint(b):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,
snappingManager:this._snappingManager}}}]);return x}(S.HandleOwner);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,"analysis",void 0);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,"analysisViewData",void 0);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,"manipulators",void 0);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,"parentTool",void 0);n.__decorate([p.property({constructOnly:!0,
nonNullable:!0})],l.LengthDimensionSubTool.prototype,"view",void 0);n.__decorate([p.property({readOnly:!0})],l.LengthDimensionSubTool.prototype,"updating",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"firstGrabbedManipulator",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"hasGrabbedManipulators",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"snappingOptions",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"_stagedDimension",
void 0);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"_activeComputation",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"_stagedComputation",null);l.LengthDimensionSubTool=n.__decorate([V.subclass("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],l.LengthDimensionSubTool);const Q=N.create();Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});