// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/asyncUtils ../../../core/Collection ../../../core/Error ../../../core/HandleOwner ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/scheduling ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/decorators/subclass".split(" "),function(m,t,n,x,y,z,f,A,g,h,B,r,C){function w(){const b=h.createResolver();b.promise.catch(()=>{});return b}const p=
b=>Object.freeze(Object.defineProperty({__proto__:null,default:b},Symbol.toStringTag,{value:"Module"}));var l;(function(b){b[b.PENDING=0]="PENDING";b[b.CREATED=1]="CREATED"})(l||(l={}));var k;(function(b){b[b.ADDED=0]="ADDED";b[b.REMOVED=1]="REMOVED"})(k||(k={}));f=function(b){function q(a){a=D.call(this,a);a._allAnalysisViews=new y;a._creatingViewCount=0;a._items=new Map;a._scheduledUpdateHandle=null;a._attachedToViewResolver=w();a._analysisModules={"area-measurement":{module:null},dimension:{module:null},
"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}};return a}t._inherits(q,b);var D=t._createSuper(q);b=q.prototype;b.destroy=function(){this._disconnectOwners();this._attachedToViewResolver.reject(h.createAbortError("AnalysisViewManager was destroyed"))};b.attach=function(){this._connectOwners();this._attachedToViewResolver.resolve()};b.detach=function(){this._disconnectOwners();this._attachedToViewResolver.reject(h.createAbortError());this._attachedToViewResolver=
w()};b.whenAnalysisView=async function(a){await this._attachedToViewResolver.promise;const e=this._items.get(a);if(g.isNone(e)||e.state.list===k.REMOVED)throw new z("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:a});return e.createAnalysisViewTask.promise};b._connectOwners=function(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),"analyses-owner-handles")};b._disconnectOwners=function(){this.handles.remove("analyses-owner-handles");
this._update();this._creatingViewCount=0};b._connectAnalysesCollection=function(a){for(const d of a)this._addAnalysis(d);const e=a.on("after-add",d=>this._addAnalysis(d.item)),c=a.on("after-remove",d=>this._removeAnalysis(d.item));return{remove:()=>{e.remove();c.remove();for(const d of a)this._removeAnalysis(d)}}};b._addAnalysis=function(a){const e=this._items.get(a);if(null==e){const c={state:{view:l.PENDING,list:k.ADDED},analysis:a,view:null,createAnalysisViewTask:null};this._items.set(a,c);c.createAnalysisViewTask=
x.createTask(d=>this._createAnalysisViewPromise(c,d))}else e.state.list=k.ADDED};b._removeAnalysis=function(a){a=this._items.get(a);null==a?A.getLogger(this.declaredClass).error("Trying to remove analysis which was not added"):(a.state.list=k.REMOVED,this._scheduleUpdate())};b._scheduleUpdate=function(){g.isSome(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=B.schedule(()=>this._update()))};b._update=function(){this._scheduledUpdateHandle=g.removeMaybe(this._scheduledUpdateHandle);this._items.forEach(a=>
{if(a.state.list===k.REMOVED)switch(this._items.delete(a.analysis),a.state.view){case l.PENDING:a.createAnalysisViewTask=g.abortMaybe(a.createAnalysisViewTask);break;case l.CREATED:g.isSome(a.view)&&(this._allAnalysisViews.remove(a.view),a.view=g.destroyMaybe(a.view),a.createAnalysisViewTask=null)}})};b._createAnalysisViewPromise=async function(a,e){var c=a.analysis;const d=c.type,u=this._analysisModules[d];this._creatingViewCount+=1;if(g.isNone(u.module))try{u.module=await this._loadAnalysisModule(d)}catch(v){throw--this._creatingViewCount,
v;}if(h.isAborted(e))throw--this._creatingViewCount,h.createAbortError("AnalysisView creation aborted");c=new u.module.default({analysis:c,view:this.view});try{await c.when()}catch(v){throw--this._creatingViewCount,v;}if(h.isAborted(e))throw--this._creatingViewCount,c.destroy(),h.createAbortError("AnalysisView creation aborted");a.view=c;a.state.view=l.CREATED;this._allAnalysisViews.add(c);--this._creatingViewCount;return c};b._loadAnalysisModule=function(a){switch(a){case "area-measurement":return new Promise((e,
c)=>m(["./AreaMeasurementAnalysisView3D"],d=>e(p(d)),c));case "dimension":return new Promise((e,c)=>m(["./DimensionAnalysisView3D"],d=>e(p(d)),c));case "direct-line-measurement":return new Promise((e,c)=>m(["./DirectLineMeasurementAnalysisView3D"],d=>e(p(d)),c));case "line-of-sight":return new Promise((e,c)=>m(["./LineOfSightAnalysisView3D"],d=>e(p(d)),c));case "slice":return new Promise((e,c)=>m(["./SliceAnalysisView3D"],d=>e(p(d)),c))}};t._createClass(q,[{key:"updating",get:function(){return!this.view.ready||
0!==this._creatingViewCount||this._allAnalysisViews.some(a=>a.updating)}},{key:"testInfo",get:function(){return{allAnalysisViews:this._allAnalysisViews}}}]);return q}(f.HandleOwner);n.__decorate([r.property()],f.prototype,"updating",null);n.__decorate([r.property({constructOnly:!0})],f.prototype,"view",void 0);n.__decorate([r.property()],f.prototype,"_allAnalysisViews",void 0);n.__decorate([r.property()],f.prototype,"_creatingViewCount",void 0);return f=n.__decorate([C.subclass("esri.views.3d.analysis.AnalysisViewManager3D")],
f)});