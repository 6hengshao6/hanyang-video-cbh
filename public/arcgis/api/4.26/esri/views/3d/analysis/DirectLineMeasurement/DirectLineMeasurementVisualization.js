// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../intl ../../../../core/Accessor ../../../../core/analysisThemeUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/quantityFormatUtils ../../../../core/quantityUtils ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/arrayUtils ../../../../core/has ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../interfaces ./interfaces ../support/viewUtils ../../interactive/visualElements/LabelVisualElement ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/MeasurementArrowVisualElement ../../interactive/visualElements/RightAngleQuadVisualElement ../../interactive/visualElements/support/Segment ../../webgl-engine/lib/Material ../../webgl-engine/materials/lineStippleUtils ../../../../intl/locale ../../../../intl/messages".split(" "),
function(l,G,m,H,fa,R,z,S,M,f,u,I,w,A,N,n,ha,ia,ja,T,O,P,B,U,h,J,C,E,V,W,x,F,K,X,Y){l.DirectLineMeasurementVisualization=function(p){function D(a){a=Z.call(this,a);a._params={triangleColor:H.toUnitRGBA(z.getAccentColor(.75)),triangleLineWidth:3,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:H.toUnitRGBA(z.getAccentColor(.75)),guideLineWidth:2,guideStippleLengthPixels:6,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12};a._handles=new S;a._segmentVisualElement=null;
a._triangleVisualElement=null;a._rightAngleQuad=null;a._projectedGeodesicLine=null;a._geodesicStartHint=null;a._geodesicEndHint=null;a._segmentLabel=null;a._verticalLabel=null;a._horizontalLabel=null;a._startPosition=B.create();a._endPosition=B.create();a._cornerPosition=B.create();a._startPositionAtSeaLevel=B.create();a._endPositionAtSeaLevel=B.create();a._triangleOrientationOverride=null;a.messages=null;a.loadingMessages=!0;a.visualElementOrientation=h.VisualElementOrientation.Auto;a.triangleCollapseRatioThreshold=
.03;return a}G._inherits(D,p);var Z=G._createSuper(D);p=D.prototype;p.initialize=function(){const a=this._params;var b={attached:!0,view:this.view};this._segmentVisualElement=new V.MeasurementArrowVisualElement({...b,geometry:null,renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent});this._triangleVisualElement=new E.LineVisualElement({...b,width:a.triangleLineWidth,color:a.triangleColor,renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent});this._rightAngleQuad=new W.RightAngleQuadVisualElement({...b,
color:H.toUnitRGBA(z.getAccentColor(.75)),renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent});const c={...b,polygonOffset:!0,renderOccluded:F.RenderOccludedFlag.OccludeAndTransparent};this._projectedGeodesicLine=new E.LineVisualElement({...c,width:a.geodesicProjectionLineWidth,color:a.geodesicProjectionLineColor,stipplePattern:K.createStipplePatternSimple(a.guideStippleLengthPixels)});this._geodesicStartHint=new E.LineVisualElement({...c,width:a.guideLineWidth,color:a.geodesicProjectionLineColor,
stipplePattern:K.createStipplePatternSimple(a.guideStippleLengthPixels)});this._geodesicEndHint=new E.LineVisualElement({...c,width:a.guideLineWidth,color:a.geodesicProjectionLineColor,stipplePattern:K.createStipplePatternSimple(a.guideStippleLengthPixels)});b={...b,backgroundColor:z.getTextHaloColor(.6),textColor:z.getTextColor()};this._segmentLabel=new C.LabelVisualElement({...b,fontSize:a.direcLabelFontSize});this._verticalLabel=new C.LabelVisualElement({...b,fontSize:a.verticalLabelFontSize});
this._horizontalLabel=new C.LabelVisualElement({...b,fontSize:a.horizontalLabelFontSize});this._handles.add([w.watch(()=>{const {elevationAlignedStartPoint:e,elevationAlignedEndPoint:d}=this.analysisView,g=this.view;return{view:g,camera:g.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:e,elevationAlignedEndPoint:d,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}},e=>this._updateGeometryAndViewMode(e),
w.syncAndInitial),w.watch(()=>({visible:this.visible,viewMode:this.viewMode}),e=>this._updateVisualElementVisibility(e),w.syncAndInitial),w.watch(()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement}),e=>this._updateLabelText(e),w.syncAndInitial),w.watch(()=>({visible:this.visible,viewMode:this.viewMode}),e=>this._updateLabelVisibility(e),w.syncAndInitial),w.watch(()=>this._measurementArrowStripeLength,e=>this._updateSegmentStripeLength(e),w.syncAndInitial),X.onLocaleChange(async()=>
this._updateMessageBundle())]);this._updateMessageBundle()};p.destroy=function(){this._handles=f.destroyMaybe(this._handles);this._segmentVisualElement=f.destroyMaybe(this._segmentVisualElement);this._triangleVisualElement=f.destroyMaybe(this._triangleVisualElement);this._rightAngleQuad=f.destroyMaybe(this._rightAngleQuad);this._projectedGeodesicLine=f.destroyMaybe(this._projectedGeodesicLine);this._geodesicStartHint=f.destroyMaybe(this._geodesicStartHint);this._geodesicEndHint=f.destroyMaybe(this._geodesicEndHint);
this._segmentLabel=f.destroyMaybe(this._segmentLabel);this._verticalLabel=f.destroyMaybe(this._verticalLabel);this._horizontalLabel=f.destroyMaybe(this._horizontalLabel);this.set("view",null)};p._updateVisualElementVisibility=function({visible:a,viewMode:b}){this._segmentVisualElement.visible=!1;this._triangleVisualElement.visible=!1;this._rightAngleQuad.visible=!1;this._projectedGeodesicLine.visible=!1;this._geodesicStartHint.visible=!1;this._geodesicEndHint.visible=!1;if(a)switch(b){case h.ViewMode.Direct:this._segmentVisualElement.visible=
!0;break;case h.ViewMode.Triangle:this._segmentVisualElement.visible=!0;this._triangleVisualElement.visible=!0;this._rightAngleQuad.visible=!0;break;case h.ViewMode.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}};p._updateGeometryAndViewMode=function({view:a,camera:b,viewMode:c,elevationAlignedStartPoint:e,elevationAlignedEndPoint:d,orientation:g,visualizedMeasurement:t,stripeLength:v}){const k=
a.renderCoordsHelper;if(!(f.isNone(k)||f.isNone(e)||f.isNone(d)||e.equals(d))){var q=this._startPosition,r=this._endPosition;k.toRenderCoords(e,q);k.toRenderCoords(d,r);e=g===h.VisualElementOrientation.AboveSegment?1:-1;d=k.getAltitude(r);var y=k.getAltitude(q);d=e*(d-y);0>d&&(q=this._endPosition,r=this._startPosition);t="geodesic"===t?new x.GeodesicSegment(this._startPosition,this._endPosition,k.spatialReference):new x.EuclideanSegment(this._startPosition,this._endPosition);this._segmentVisualElement.geometry=
t;this._updateSegmentStripeLength(v);switch(c){case h.ViewMode.Direct:this._updateSegment(t,g);break;case h.ViewMode.Triangle:this._updateSegmentAndTriangle({view:a,camera:b,segment:t,orientation:g,startPosition:q,endPosition:r,deltaSign:e,altitudeDelta:d});break;case h.ViewMode.ProjectedGeodesic:this._updateSegmentAndProjection({view:a,orientation:g,startPosition:q,endPosition:r})}}};p._updateSegment=function(a,b){this._segmentLabel.anchor=b===h.VisualElementOrientation.AboveSegment?"top":"bottom";
this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"}};p._updateSegmentAndTriangle=function({view:{renderCoordsHelper:a},camera:b,segment:c,orientation:e,startPosition:d,endPosition:g,deltaSign:t,altitudeDelta:v}){const k=this._cornerPosition;a.worldUpAtPosition(d,k);P.scale(k,k,t*Math.abs(v));P.add(k,k,d);this._triangleVisualElement.geometry=[[[d[0],d[1],d[2]],[k[0],k[1],k[2]],[g[0],g[1],g[2]]]];this._rightAngleQuad.geometry={previous:d,center:k,next:g};a=new x.EuclideanSegment(d,
k);t=new x.EuclideanSegment(k,g);var q=aa,r=ba;b.projectToRenderScreen(k,q);b.projectToRenderScreen(g,r);v="bottom";var y="top";q=q[0]<r[0]?"left":"right";const L=ca;r=da;J.screenSpaceTangent(d,k,L,b);J.screenSpaceTangent(d,g,r,b);O.dot(L,r)>=Q?v=Math.sign(L[1])===Math.sign(r[1])?C.mirrorPosition(q):q:(d=ea,J.screenSpaceTangent(k,g,d,b),O.dot(d,r)>=Q&&(v=Math.sign(d[0])===Math.sign(r[0])?C.mirrorPosition(y):y));e===h.VisualElementOrientation.BelowSegment&&(v="top"===v?"bottom":"top",y="top"===y?"bottom":
"top",q="top"===q?"bottom":"top");this._segmentLabel.anchor=v;this._segmentLabel.geometry={type:"segment",segment:c,sampleLocation:"center"};this._verticalLabel.geometry={type:"segment",segment:a,sampleLocation:"center"};this._verticalLabel.anchor=q;this._horizontalLabel.geometry={type:"segment",segment:t,sampleLocation:"center"};this._horizontalLabel.anchor=y};p._updateSegmentAndProjection=function({view:{renderCoordsHelper:a},orientation:b,startPosition:c,endPosition:e}){a.setAltitude(this._startPositionAtSeaLevel,
0,c);a.setAltitude(this._endPositionAtSeaLevel,0,e);a=new x.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,a.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(a);this._geodesicStartHint.setGeometryFromSegment(new x.EuclideanSegment(this._startPositionAtSeaLevel,c));this._geodesicEndHint.setGeometryFromSegment(new x.EuclideanSegment(this._endPositionAtSeaLevel,e));this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"};this._segmentLabel.anchor=
b===h.VisualElementOrientation.AboveSegment?"top":"bottom"};p._updateLabelText=function({text:a,visualizedMeasurement:b}){f.isSome(a)?(this._segmentLabel.text="euclidean"===b?a.euclideanDistance:a.geodesicDistance,this._horizontalLabel.text=a.horizontalDistance,this._verticalLabel.text=a.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=null);this.notifyChange("labels")};p._updateLabelVisibility=function({visible:a,viewMode:b}){const c=this._segmentLabel,
e=this._horizontalLabel,d=this._verticalLabel;c.visible=!1;e.visible=!1;d.visible=!1;if(a)switch(b){case h.ViewMode.Direct:c.visible=!0;break;case h.ViewMode.Triangle:c.visible=!0;e.visible=!0;d.visible=!0;break;case h.ViewMode.ProjectedGeodesic:c.visible=!0}};p._updateSegmentStripeLength=function(a){const b=this._segmentVisualElement;f.isSome(a)?(b.stripeLength=a,b.stripesEnabled=!0):b.stripesEnabled=!1};p._requiresGeodesicGuideAt=function(a){var b=this.view;if(!b?.state)return!1;const c=b.renderCoordsHelper;
b=b.state.camera.computeScreenPixelSizeAt(a);return 10<=c.getAltitude(a)/b};p._updateMessageBundle=function(){this.loadingMessages=!0;Y.fetchMessageBundle("esri/core/t9n/Units").then(a=>{this.messages=a}).finally(()=>{this.loadingMessages=!1})};G._createClass(D,[{key:"visible",get:function(){return this.analysisView.visible}},{key:"viewMode",get:function(){const {elevationAlignedStartPoint:a,elevationAlignedEndPoint:b}=this.analysisView;if(f.isNone(a)||f.isNone(b)||a.equals(b))return h.ViewMode.None;
var c=this.analysisView.result;if(f.isNone(c))return h.ViewMode.Direct;if("geodesic"===c.mode)return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?h.ViewMode.ProjectedGeodesic:h.ViewMode.Direct;const {verticalDistance:e,horizontalDistance:d}=c;c=e.value;const g=d.value;return Math.min(c/g,g/c)<this.triangleCollapseRatioThreshold?h.ViewMode.Direct:h.ViewMode.Triangle}},{key:"actualVisualizedMeasurement",get:function(){if(f.isNone(this.analysisView.result))switch(this.analysisView.measurementMode){default:return"euclidean";
case U.MeasurementMode.Geodesic:return"geodesic"}return this.analysisView.result.mode}},{key:"allowVisualElementsOrientationChange",get:function(){return f.isNone(this._triangleOrientationOverride)},set:function(a){f.isNone(this._triangleOrientationOverride)!==a&&(f.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}},{key:"labels",get:function(){return{direct:this._segmentLabel,horizontal:"geodesic"===
this.actualVisualizedMeasurement?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}},{key:"_labelsText",get:function(){if(this.destroyed)return null;const a=this.messages;var b=this.analysisView.result;if(f.isNone(b)||f.isNone(a))return null;const {directDistance:c,horizontalDistance:e,verticalDistance:d,geodesicDistance:g}=b;b=this.analysisView.unit;const t=v=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...v});switch(b){case "metric":return t({euclideanDistance:c&&
u.formatMetricLength(a,c),geodesicDistance:g&&u.formatMetricLength(a,g),horizontalDistance:e&&u.formatMetricLength(a,e),verticalDistance:d&&u.formatMetricVerticalLength(a,d)});case "imperial":return t({euclideanDistance:c&&u.formatImperialLength(a,c),geodesicDistance:g&&u.formatImperialLength(a,g),horizontalDistance:e&&u.formatImperialLength(a,e),verticalDistance:d&&u.formatImperialVerticalLength(a,d)});default:return t({euclideanDistance:c&&u.formatDecimal(a,c,b),geodesicDistance:g&&u.formatDecimal(a,
g,b),horizontalDistance:e&&u.formatDecimal(a,e,b),verticalDistance:d&&u.formatDecimal(a,d,b)})}}},{key:"_actualVisualElementsOrientation",get:function(){if(f.isSome(this._triangleOrientationOverride))return this._triangleOrientationOverride;const a=this.visualElementOrientation;return a===h.VisualElementOrientation.Auto?this.view.state.camera.aboveGround?h.VisualElementOrientation.AboveSegment:h.VisualElementOrientation.BelowSegment:a}},{key:"_measurementArrowStripeLength",get:function(){const {result:a,
unit:b}=this.analysisView;if(f.isNone(a))return null;var c=null;c=a.directDistance;switch(b){case "metric":c=c&&I.toUnit(c,"meters");break;case "imperial":c=c&&I.toUnit(c,N.preferredImperialLengthUnit(c.value,c.unit));break;default:c=c&&I.toUnit(c,b)}return f.isNone(c)?null:M.nextHighestPowerOfTen(c.value/30)*N.convertUnit(1,c.unit,"meters")}},{key:"testData",get:function(){return{labels:this.labels,stripeLength:this._segmentVisualElement?.stripeLength}}}]);return D}(R);m.__decorate([n.property()],
l.DirectLineMeasurementVisualization.prototype,"_triangleOrientationOverride",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"messages",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"view",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"analysis",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"analysisView",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,
"loadingMessages",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"visible",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"viewMode",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"actualVisualizedMeasurement",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"visualElementOrientation",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,
"triangleCollapseRatioThreshold",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"allowVisualElementsOrientationChange",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"labels",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"_labelsText",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"_actualVisualElementsOrientation",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,
"_measurementArrowStripeLength",null);l.DirectLineMeasurementVisualization=m.__decorate([T.subclass("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],l.DirectLineMeasurementVisualization);const Q=Math.cos(M.deg2rad(12)),aa=A.createRenderScreenPointArray3(),ba=A.createRenderScreenPointArray3(),ca=A.createRenderScreenPointArray(),da=A.createRenderScreenPointArray(),ea=A.createRenderScreenPointArray();Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});