// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/arrayUtils ../../../../../core/AsyncSequence ../../../../../core/asyncUtils ../../../../../core/HandleOwner ../../../../../core/handleUtils ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/has ../../../../../core/accessorSupport/decorators/subclass ../../../../../geometry/Extent ../../../../../geometry/support/aaBoundingRect ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/support/arcgisLayerUrl ../../../../../rest/query/operations/pbfOptimizedFeatureSet ../../../../../rest/query/operations/query ../../../../../rest/support/Query ./PendingFeatureTile".split(" "),
function(e,u,f,z,A,B,C,D,E,k,F,G,h,P,Q,H,I,J,y,K,L,v,w,x){e.FeatureServiceTiledFetcher=function(d){function n(a){a=M.call(this,a);a.tilesOfInterest=[];a.availability=0;a._pendingTiles=new Map;a._pendingEdits=new A.AsyncSequence;a._pendingEditsAbortController=new AbortController;return a}u._inherits(n,d);var M=u._createSuper(n);d=n.prototype;d.initialize=function(){this._initializeFetchExtent();this.updatingHandles.add(()=>this._configuration,()=>this.refresh());this.updatingHandles.add(()=>this.tilesOfInterest,
(a,b)=>{z.equals(a,b,({id:c},{id:g})=>c===g)||this._process()},G.sync)};d.destroy=function(){this._pendingTiles.forEach(a=>this._deletePendingTile(a));this._pendingTiles.clear();this.store.destroy();this.tilesOfInterest.length=0;this._pendingEditsAbortController.abort();this._pendingEditsAbortController=null};d.refresh=function(){this.store.refresh();this._pendingTiles.forEach(a=>this._deletePendingTile(a));this._process()};d.applyEdits=function(a){this._pendingEdits.push(a,async b=>{if(0!==b.addedFeatures.length||
0!==b.updatedFeatures.length||0!==b.deletedFeatures.length){for(const [,c]of this._pendingTiles)c.reset();b={...b,deletedFeatures:b.deletedFeatures.map(({objectId:c,globalId:g})=>c&&-1!==c?c:this._lookupObjectIdByGlobalId(g))};await this.updatingHandles.addPromise(this.store.processEdits(b,(c,g)=>this._queryFeaturesById(c,g),this._pendingEditsAbortController.signal));this._processPendingTiles()}})};d._initializeFetchExtent=function(){if(this.capabilities.query.supportsExtent&&K.isHostedAgolService(this.url)){var a=
B.createTask(async b=>{try{const c=await v.executeQueryForExtent(this.url,new w({where:"1\x3d1",outSpatialReference:this.spatialReference,cacheHint:this.capabilities.query.supportsCacheHint??void 0}),{query:this._configuration.customParameters,signal:b});this.store.extent=I.fromJSON(c.data?.extent)}catch(c){F.throwIfAbortError(c),E.getLogger(this.declaredClass).warn("Failed to fetch data extent",c)}});this.updatingHandles.addPromise(a.promise.then(()=>this._process()));this.handles.add(D.makeHandle(()=>
a.abort()))}};d._process=function(){this._markTilesNotAlive();this._createPendingTiles();this._deletePendingTiles();this._processPendingTiles()};d._markTilesNotAlive=function(){for(const [,a]of this._pendingTiles)a.alive=!1};d._createPendingTiles=function(){var a=this._collectMissingTilesInfo();this._setAvailability(k.isNone(a)?1:a.coveredArea/a.fullArea);if(!k.isNone(a))for(const {data:b,resolution:c}of a.missingTiles)(a=this._pendingTiles.get(b.id))?(a.resolution=c,a.alive=!0):this._createPendingTile(b,
c)};d._collectMissingTilesInfo=function(){let a=null;for(let b=this.tilesOfInterest.length-1;0<=b;b--){const c=this.store.process(this.tilesOfInterest[b],(g,l)=>this._verifyTileComplexity(g,l));k.isNone(a)?a=c:a.prepend(c)}return a};d._deletePendingTiles=function(){for(const [,a]of this._pendingTiles)a.alive||this._deletePendingTile(a)};d._processPendingTiles=function(){const a={fetchCount:(b,c)=>this._fetchCount(b,c),fetchFeatures:(b,c,g)=>this._fetchFeatures(b,c,g),finish:(b,c)=>this._finishPendingTile(b,
c),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(a))for(const [,b]of this._pendingTiles)this._verifyTileComplexity(this.store.getFeatureCount(b.data),b.resolution)&&this.updatingHandles.addPromise(b.process(a))};d._verifyTileComplexity=function(a,b){return this._verifyVertexComplexity(a)&&this._verifyFeatureDensity(a,b)};d._verifyVertexComplexity=function(a){return 1E6>a*this._minimumVerticesPerFeature};d._verifyFeatureDensity=function(a,b){if(k.isNone(this.tileInfo))return!1;
b*=this.tileSize;return 1>25/(b*b)*a};d._ensureFetchAllCounts=function(a){let b=!0;for(const [,c]of this._pendingTiles)c.state.type<x.StateType.FETCHED_COUNT&&this.updatingHandles.addPromise(c.process(a)),c.state.type<=x.StateType.FETCH_COUNT&&(b=!1);return b};d._finishPendingTile=function(a,b){this.store.add(a.data,b);this._deletePendingTile(a);this._updateAvailability()};d._updateAvailability=function(){const a=this._collectMissingTilesInfo();this._setAvailability(k.isNone(a)?1:a.coveredArea/a.fullArea)};
d._setAvailability=function(a){this._set("availability",a)};d._createPendingTile=function(a,b){b=new x.PendingFeatureTile(a,b);this._pendingTiles.set(a.id,b);return b};d._deletePendingTile=function(a){a.reset();this._pendingTiles.delete(a.data.id)};d._fetchCount=async function(a,b){return this.store.fetchCount(a.data,this.url,this._createCountQuery(a),{query:this.customParameters,timeout:6E5,signal:b})};d._fetchFeatures=async function(a,b,c){let g=0;const l=[];let p=0,q=b;for(;;){const r=this._createFeaturesQuery(a),
t=this._setPagingParameters(r,g,q),{features:m,exceededTransferLimit:N}=await this._queryFeatures(r,c);t&&(g+=k.unwrap(r.num));p+=m.length;for(const O of m)l.push(O);q=b-p;if(!t||!N||0>=q)return l}};d._filterProperties=function(a){return k.isNone(a)?{where:"1\x3d1",gdbVersion:void 0,timeExtent:void 0}:{where:a.where||"1\x3d1",timeExtent:a.timeExtent,gdbVersion:a.gdbVersion}};d._lookupObjectIdByGlobalId=function(a){const b=this.globalIdField,c=this.objectIdField;if(k.isNone(b))throw Error("Expected globalIdField to be defined");
let g=null;this.store.featureStore.forEach(l=>{a===l.attributes[b]&&(g=l.objectId??l.attributes[c])});if(k.isNone(g))throw Error(`Expected to find a feature with globalId ${a}`);return g};d._queryFeaturesById=function(a,b){const c=this._createFeaturesQuery();c.objectIds=a;return this._queryFeatures(c,b)};d._queryFeatures=function(a,b){return this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(a,b):this._queryFeaturesJSON(a,b)};d._queryFeaturesPBF=async function(a,b){const {sourceSpatialReference:c}=
this;({data:a}=await v.executeQueryPBF(this.url,a,new L.OptimizedFeatureSetParserContext({sourceSpatialReference:c}),{query:this._configuration.customParameters,timeout:6E5,signal:b}));return y.unquantizeOptimizedFeatureSet(a)};d._queryFeaturesJSON=async function(a,b){const {sourceSpatialReference:c}=this;({data:a}=await v.executeQuery(this.url,a,c,{query:this._configuration.customParameters,timeout:6E5,signal:b}));return y.convertFromFeatureSet(a,this.objectIdField)};d._createCountQuery=function(a){a=
this._createBaseQuery(a);this.capabilities.query.supportsCacheHint&&(a.cacheHint=!0);return a};d._createFeaturesQuery=function(a=null){const b=this._createBaseQuery(a);b.outFields=this.globalIdField?[this.globalIdField,this.objectIdField]:[this.objectIdField];b.returnGeometry=!0;k.isSome(a)&&(this.capabilities.query.supportsResultType?b.resultType="tile":this.capabilities.query.supportsCacheHint&&(b.cacheHint=!0));return b};d._createBaseQuery=function(a){a=new w({returnZ:this.hasZ,returnM:!1,geometry:k.isSome(this.tileInfo)&&
k.isSome(a)?J.toExtent(a.data.extent,this.tileInfo.spatialReference):void 0});const b=this._configuration.filter;k.isSome(b)&&(a.where=b.where,a.gdbVersion=b.gdbVersion,a.timeExtent=b.timeExtent);a.outSpatialReference=this.spatialReference;return a};d._setPagingParameters=function(a,b,c){if(!this.capabilities.query.supportsPagination)return!1;const {supportsMaxRecordCountFactor:g,supportsCacheHint:l,tileMaxRecordCount:p,maxRecordCount:q,supportsResultType:r}=this.capabilities.query,t=g?w.MAX_MAX_RECORD_COUNT_FACTOR:
1,m=t*((r||l)&&p?p:q||2E3);a.start=b;g?(a.maxRecordCountFactor=Math.min(t,Math.ceil(c/m)),a.num=Math.min(c,a.maxRecordCountFactor*m)):a.num=Math.min(c,m);return!0};u._createClass(n,[{key:"_minimumVerticesPerFeature",get:function(){switch(this.store?.featureStore.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":return 1;case "esriGeometryPolygon":return 4;case "esriGeometryPolyline":return 2}}},{key:"filter",set:function(a){const b=this._get("filter");a=this._filterProperties(a);
JSON.stringify(b)!==JSON.stringify(a)&&this._set("filter",a)}},{key:"customParameters",set:function(a){const b=this._get("customParameters");JSON.stringify(b)!==JSON.stringify(a)&&this._set("customParameters",a)}},{key:"_configuration",get:function(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}},{key:"tileInfo",set:function(a){const b=this._get("tileInfo");b===a||k.isSome(a)&&k.isSome(b)&&JSON.stringify(a)===JSON.stringify(b)||(this._set("tileInfo",
a),this.store.tileInfo=a)}},{key:"tileSize",set:function(a){this._get("tileSize")!==a&&this._set("tileSize",a)}},{key:"updating",get:function(){return this.updatingExcludingEdits||this._pendingEdits.updating}},{key:"updatingExcludingEdits",get:function(){return this.updatingHandles.updating}},{key:"hasZ",get:function(){return this.store.featureStore.hasZ}},{key:"debugInfo",get:function(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map(a=>
a.debugInfo),storedTiles:this.store.debugInfo}}}]);return n}(C.HandleOwner);f.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"url",void 0);f.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"objectIdField",void 0);f.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"globalIdField",void 0);f.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"capabilities",void 0);
f.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"sourceSpatialReference",void 0);f.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"spatialReference",void 0);f.__decorate([h.property({constructOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"store",void 0);f.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"_minimumVerticesPerFeature",null);f.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,
"filter",null);f.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"customParameters",null);f.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"_configuration",null);f.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"tileInfo",null);f.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"tileSize",null);f.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"tilesOfInterest",void 0);f.__decorate([h.property({readOnly:!0})],
e.FeatureServiceTiledFetcher.prototype,"updating",null);f.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"updatingExcludingEdits",null);f.__decorate([h.property({readOnly:!0})],e.FeatureServiceTiledFetcher.prototype,"availability",void 0);f.__decorate([h.property()],e.FeatureServiceTiledFetcher.prototype,"hasZ",null);e.FeatureServiceTiledFetcher=f.__decorate([H.subclass("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],
e.FeatureServiceTiledFetcher);Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});