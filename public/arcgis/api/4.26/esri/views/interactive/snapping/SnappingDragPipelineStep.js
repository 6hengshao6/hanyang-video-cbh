// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../layers/graphics/dehydratedFeatureComparison ../../../layers/graphics/hydratedFeatures ../../../support/elevationInfoUtils ../dragEventPipeline ./SnappingContext ../../support/Scheduler".split(" "),function(y,c,z,L,M,N,O,P,Q,A){function R(a,b,d){return z.debounce(async({frameTask:e,point:k,scenePoint:m,context:l,event:f,delta:p,getLastState:g},q)=>{const r=await e.schedule(()=>a.snap({point:k,scenePoint:m,
context:l,signal:q}),q);r.valid&&(e=await e.schedule(()=>r.apply(),q),g=g(),c.isSome(g.point)&&k!==g.point&&(e=a.update({point:g.point,scenePoint:g.scenePoint,context:l})),c.isNone(g.updatePoint)||!M.pointEquals(e,g.updatePoint))&&(B(f.mapEnd,e,p,b),d.execute(f))})}function S(a){return"3d"===a.type?a.resourceController.scheduler.registerTask(A.TaskPriority.SNAPPING):A.ImmediateTask}function T(a,b,d){return{context:new Q.SnappingContext({editGeometryOperations:a.editGeometryOperations,elevationInfo:a.elevationInfo,
pointer:a.pointer,vertexHandle:c.isSome(b.info)?b.info.handle:null,excludeFeature:a.excludeFeature,visualizer:a.visualizer}),originalPos:c.isSome(b.snapOrigin)?a.coordinateHelper.vectorToDehydratedPoint(b.snapOrigin):b.mapStart,originalScenePos:c.isSome(b.scenePoints)?b.scenePoints.sceneStart:null,frameTask:d}}function C(a,[b,d,e]){a=N.clonePoint(a);a.x+=b;a.y+=d;a.hasZ&&(a.z+=e);return a}function U(a,b){return c.isNone(a)||c.isNone(b)?null:C(a,t(b.sceneEnd,b.sceneStart))}function t(a,b){return[a.x-
b.x,a.y-b.y,a.hasZ&&b.hasZ?a.z-b.z:0]}function B(a,b,[d,e,k],m){a.x=b.x+d;a.y=b.y+e;m&&a.hasZ&&b.hasZ&&(a.z=b.z+k)}function V(a,b){if(!a.hasZ())return null;var d=b.vertices;b=null;for(const e of d){d=a.getZ(e.pos);if(c.isSome(b)&&c.isSome(d)&&1E-6<Math.abs(d-b))return null;c.isNone(b)&&(b=d)}return b}function D(a){return a}y.createSnapDragEventPipelineStep=function({predicate:a=()=>!0,snappingManager:b,snappingContext:d,updatingHandles:e,useZ:k=!0}){const m=new P.EventPipeline;if(c.isNone(b))return{snappingStep:[D,
m],cancelSnapping:D};let l=null,f=null,p,g=null;const q=()=>{l=c.abortMaybe(l);b.doneSnapping();c.isSome(f)&&f.frameTask.remove();f=null;p=c.removeMaybe(p);g=null},r=R(b,k,m);let E=null,F=null,G=null;return{snappingStep:[h=>{if(!a(h))return h;const {action:u}=h;if("start"===u){var {info:n}=h;const v=S(b.view);f=T(d,h,v);f.context.selfSnappingZ=null;!k&&c.isSome(n)&&(n=V(d.coordinateHelper,n.handle.component),c.isSome(n)&&(f.context.selfSnappingZ={value:n,elevationInfo:d.elevationInfo??O.absoluteHeightElevationInfo}))}if(c.isSome(f)){const {context:v,
originalScenePos:W,originalPos:H}=f,{mapEnd:I,mapStart:J,scenePoints:X}=h,w=C(H,t(I,J)),K=t(J,H),Y={...h,action:"update"},Z=f.context,x=U(W,X);G=n=b.update({point:w,scenePoint:x,context:v});B(I,n,K,k);E=w;F=x;if("end"!==u){const {frameTask:aa}=f;c.isNone(l)&&(l=new AbortController);g=ba=>{e.addPromise(z.ignoreAbortErrors(r({frameTask:aa,event:Y,context:Z,point:w,scenePoint:x,delta:K,getLastState:()=>({point:E,scenePoint:F,updatePoint:ba.forceUpdate?null:G})},c.unwrap(l).signal)))};g({forceUpdate:!1});
c.isNone(p)&&(p=L.watch(()=>b.options.effectiveEnabled,()=>g?.({forceUpdate:!0})))}}"end"===u&&q();return h},m],cancelSnapping:h=>{q();return h}}};Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});