// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Evented ../../../core/HandleOwner ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../geometry/projection ../../../support/elevationInfoUtils ./Settings ./SnappingDomain ./snappingFactory ./SnappingOptions ./SnappingPoint ./snappingUtils ./candidates/IntersectionSnappingCandidate ../support/viewUtils".split(" "),
function(l,A,p,G,H,t,I,v,r,P,Q,R,J,B,C,D,x,K,L,w,E,y,M){function N({coordinateHelper:f,elevationInfo:u}){return f.hasZ()?C.absoluteHeightElevationInfo:u}l.SnappingManager=function(f){function u(a){a=O.call(this,a);a.options=new L;a.snappingEnginesFactory=K.defaultSnappingEnginesFactory;a._engines=[];a._currentMainCandidate=null;a._currentOtherActiveCandidates=[];a._currentSnappedType=q.MAIN;return a}A._inherits(u,f);var O=A._createSuper(u);f=u.prototype;f.initialize=function(){this.handles.add([v.watch(()=>
{const {effectiveFeatureEnabled:a,effectiveSelfEnabled:b,touchSensitivityMultiplier:c,distance:d}=this.options;return{effectiveFeatureEnabled:a,effectiveSelfEnabled:b,touchSensitivityMultiplier:c,distance:d}},()=>{this.doneSnapping();this.emit("changed")},v.sync),v.watch(()=>this.options,a=>{for(const b of this._engines)b.options=a},v.sync),v.watch(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:a,snappingEnginesFactory:b})=>
this._recreateEngines(a,b),v.syncAndInitial)])};f.destroy=function(){this._destroyEngines()};f._recreateEngines=function(a,b){this._destroyEngines();if(a){var {view:c,options:d}=this;this._engines=b(c,d)}};f._destroyEngines=function(){for(const a of this._engines)a.destroy();this._engines=[]};f.snap=async function(a){return t.isSome(a.scenePoint)?this._snapMultiPoint(a):this._snapSinglePoint(a)};f.update=function(a){const {point:b,context:c}=a;this._removeVisualization();const d=this._currentMainCandidate;
if(t.isNone(d))return b;var e=this._selectUpdateInput(a);if(t.isNone(e))return b;({spatialReference:a}=c);var g=B.project(e,a);if(t.isNone(g))return b;({view:e}=this);const {elevationInfo:n,visualizer:h}=c,k=[];g=w.pointToSnappingPoint(g,e,c);const m=d.constraint.closestTo(g);if(!this._arePointsWithinScreenThreshold(g,m,c))return this._resetSnappingState(),b;d.targetPoint=m;k.push(...d.hints);for(const z of this._currentOtherActiveCandidates)z.targetPoint=m,k.push(...z.hints);t.isSome(h)&&this.handles.add(h.draw(k,
{spatialReference:a,elevationInfo:N(c),view:e,selfSnappingZ:c.selfSnappingZ}),"visualization-handle");return w.snappingPointToSnappingOutput(m,e,{z:b.z,m:b.m,spatialReference:b.spatialReference,elevationInfo:n})};f.doneSnapping=function(){this._removeVisualization();this._resetSnappingState()};f._selectUpdateInput=function({point:a,scenePoint:b}){switch(this._currentSnappedType){case q.MAIN:return a;case q.SCENE:return b}};f._resetSnappingState=function(){this._currentMainCandidate=null;this._currentOtherActiveCandidates=
[];this._currentSnappedType=q.MAIN};f._removeVisualization=function(){this.handles.remove("visualization-handle")};f._snapSinglePoint=async function({point:a,context:b,signal:c}){const {view:d}=this,e=w.pointToSnappingPoint(a,d,b),g=await this._fetchCandidates(e,x.SnappingDomain.ALL,b,c);return this._createSnapResult(e,q.MAIN,g,d,b,{z:a.z,m:a.m,spatialReference:a.spatialReference,elevationInfo:b.elevationInfo},c)};f._snapMultiPoint=async function({point:a,scenePoint:b,context:c,signal:d}){const {view:e}=
this,{coordinateHelper:g,spatialReference:n}=c;await B.initializeProjection(b.spatialReference,n);b=B.project(b,n);var h=w.pointToSnappingPoint(b,e,c);const k=await this._fetchCandidates(h,x.SnappingDomain.FEATURE,c,d);if(0<k.length)return a=await this._fetchCandidates(h,x.SnappingDomain.SELF,c,d),this._createSnapResult(h,q.SCENE,[...k,...a],e,c,{z:b.z,m:b.m,spatialReference:b.spatialReference,elevationInfo:c.elevationInfo},d);b=w.pointToSnappingPoint(a,e,c);h=await this._fetchCandidates(b,x.SnappingDomain.SELF,
c,d);return this._createSnapResult(b,q.MAIN,h,e,c,{z:g.hasZ()&&a.hasZ?a.z??0:void 0,m:g.hasM()&&a.hasM?a.m??0:void 0,spatialReference:a.spatialReference,elevationInfo:c.elevationInfo},d)};f._fetchCandidates=async function(a,b,c,d){return(await Promise.all(this._engines.map(e=>e.fetchCandidates(a,b,c,d)))).flat()};f._createSnapResult=function(a,b,c,d,e,g,n){return{get valid(){return!I.isAborted(n)},apply:()=>{const {spatialReference:h}=e,{snappedPoint:k,hints:m}=this._processCandidates(a,b,c,e);this._removeVisualization();
t.isSome(e.visualizer)&&this.handles.add(e.visualizer.draw(m,{spatialReference:h,elevationInfo:C.absoluteHeightElevationInfo,view:d,selfSnappingZ:e.selfSnappingZ}),"visualization-handle");return w.snappingPointToSnappingOutput(k,d,g)}}};f._processCandidates=function(a,b,c,d){if(1>c.length)return this.doneSnapping(),{snappedPoint:a,hints:[]};this._currentSnappedType!==b&&this._resetSnappingState();E.sortCandidatesInPlace(a,c);const e=this._currentMainCandidate;if(t.isSome(e)){const g=this._findOldConstraintInNewCandidates(e,
c);if(0<=g)if(c[g]instanceof y.IntersectionSnappingCandidate){if(this._arePointsWithinScreenThreshold(a,e.targetPoint,d))return this._updateSnappingCandidate(e,b,c,d)}else return this._intersectWithOtherCandidates(g,c,a,b,d)}return this._intersectWithOtherCandidates(0,c,a,b,d)};f._findOldConstraintInNewCandidates=function(a,b){return a instanceof y.IntersectionSnappingCandidate?0<=this._findOldCandidateIndex(b,a.first)&&0<=this._findOldCandidateIndex(b,a.second)?0:-1:this._findOldCandidateIndex(b,
a)};f._intersectWithOtherCandidates=function(a,b,c,d,e){const {coordinateHelper:g}=e,n=b[a],h=[];for(let k=0;k<b.length;++k){if(k===a)continue;const m=b[k];for(const z of n.constraint.intersect(m.constraint)){const F=z.closestTo(n.targetPoint);h.push([new y.IntersectionSnappingCandidate(F,n,m,m.isDraped),this._squaredScreenDistance(c,F,g)])}}return 0<h.length&&(h.sort((k,m)=>k[1]-m[1]),h[0][1]<this._squaredPointProximityThreshold(e.pointer))?this._updateSnappingCandidate(h[0][0],d,b,e):this._updateSnappingCandidate(n,
d,b,e)};f._updateSnappingCandidate=function(a,b,c,d){this.doneSnapping();this._currentMainCandidate=a;this._currentSnappedType=b;b=this._currentMainCandidate.targetPoint;const e=[];e.push(...a.hints);for(const g of c){if(a instanceof y.IntersectionSnappingCandidate){if(g.constraint.equals(a.first.constraint)||g.constraint.equals(a.second.constraint))continue}else if(g.constraint.equals(a.constraint))continue;c=g.constraint.closestTo(b);this._squaredScreenDistance(c,b,d.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&
(g.targetPoint=b,this._currentOtherActiveCandidates.push(g),e.push(...g.hints))}return{snappedPoint:b,hints:e}};f._squaredPointProximityThreshold=function(a){return"touch"===a?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold};f._arePointsWithinScreenThreshold=function(a,b,c){return this._squaredScreenDistance(a,b,c.coordinateHelper)<this._squaredPointProximityThreshold(c.pointer)};f._squaredScreenDistance=function(a,b,c){return E.squaredScreenDistance(this._toScreen(a,c),this._toScreen(b,
c))};f._toScreen=function(a,b){return M.vectorToScreenPoint(a,b.spatialReference,C.absoluteHeightElevationInfo,this.view)};f._findOldCandidateIndex=function(a,b){let c=-1;for(let d=0;d<a.length;++d)if(b.constraint.equals(a[d].constraint)){c=d;break}return c};A._createClass(u,[{key:"updating",get:function(){return this._engines.some(a=>a.updating)}},{key:"_squaredMouseProximityTreshold",get:function(){return this.options.distance*this.options.distance}},{key:"_squaredTouchProximityThreshold",get:function(){const {distance:a,
touchSensitivityMultiplier:b}=this.options,c=a*b;return c*c}},{key:"_squaredSatisfiesConstraintThreshold",get:function(){return D.defaults.satisfiesConstraintScreenThreshold*D.defaults.satisfiesConstraintScreenThreshold}},{key:"test",get:function(){return{visualizationsActive:this.handles.has("visualization-handle"),engines:this._engines}}}]);return u}(G.EventedMixin(H.HandleOwner));p.__decorate([r.property({constructOnly:!0})],l.SnappingManager.prototype,"view",void 0);p.__decorate([r.property()],
l.SnappingManager.prototype,"options",void 0);p.__decorate([r.property({readOnly:!0})],l.SnappingManager.prototype,"updating",null);p.__decorate([r.property()],l.SnappingManager.prototype,"snappingEnginesFactory",void 0);p.__decorate([r.property()],l.SnappingManager.prototype,"_engines",void 0);p.__decorate([r.property()],l.SnappingManager.prototype,"_squaredMouseProximityTreshold",null);p.__decorate([r.property()],l.SnappingManager.prototype,"_squaredTouchProximityThreshold",null);p.__decorate([r.property()],
l.SnappingManager.prototype,"_squaredSatisfiesConstraintThreshold",null);l.SnappingManager=p.__decorate([J.subclass("esri.views.interactive.snapping.SnappingManager")],l.SnappingManager);var q;(function(f){f[f.MAIN=0]="MAIN";f[f.SCENE=1]="SCENE"})(q||(q={}));Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});