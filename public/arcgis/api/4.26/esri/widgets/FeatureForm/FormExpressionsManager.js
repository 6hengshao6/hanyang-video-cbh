// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/MapUtils ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass".split(" "),function(l,v,n,A,t,w,x,q,C,D,E,B){l.FormExpressionsManager=function(d){function g(b){var c=u.call(this,b);c._fieldReferencesLookup=new Map;c._fieldsAffectedLookup=
new Map;c._latestFieldValues={...b.feature.attributes};return c}v._inherits(g,d);var u=v._createSuper(g);d=g.prototype;d.initialize=function(){this._dependencyGraph=this._buildDependencyGraph()};d.evaluateAll=function(){return this._evaluate(this.executors)};d.evaluateExpressions=function(b){return this._evaluate(b)};d.evaluateInvalidated=function(b){const {_fieldReferencesLookup:c,_latestFieldValues:h,feature:f}=this,k=new Set;for(const a of b)if(h[a]=f.getAttribute(a),c.has(a))for(const m of c.get(a))k.add(m);
return this._evaluate([...k])};d.evaluateInvalidatedByGeometry=async function(){if(this._fieldReferencesLookup.has("#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY"))return this._evaluate([...this._fieldReferencesLookup.get("#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY")])};d.resetExecutors=function(){for(const b of this.executors)b.reset()};d._buildDependencyGraph=function(){const {_fieldReferencesLookup:b,_fieldsAffectedLookup:c,executors:h}=this,f=new Map(this.inputFields.map(a=>[a.name,a])),k=new Map(h.map(a=>
[a,[]]));for(const a of h){for(const m of a.fieldsUsed){t.getOrCreateMapValue(b,m,()=>new Set).add(a);const r=f.get(m),{valueExpressionExecutor:e,editableExpressionExecutor:p}=r;w.isSome(e)&&e!==a&&(k.get(e).push(a),t.getOrCreateMapValue(c,e,()=>new Set).add(r));w.isSome(p)&&p!==a&&(k.get(p).push(a),t.getOrCreateMapValue(c,p,()=>new Set).add(r))}a.geometryUsed&&t.getOrCreateMapValue(b,"#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",()=>new Set).add(a)}return k};d._evaluate=async function(b){const c=new Map,
{_dependencyGraph:h,_fieldsAffectedLookup:f,_latestFieldValues:k}=this;for(const a of b)y(a,c,h);for(const [a,{resolver:m,dependencyPromises:r}]of c)Promise.all(r).then(async()=>{const [e,p]=this._makeContext(k);return a.executeAsync(e,p)}).then(()=>{if(f.has(a))for(const e of f.get(a))this._latestFieldValues[e.name]=e.value;m.resolve()},e=>{!e||x.isAbortError(e)||z(e)||a.markStale();m.reject(e)});b=(await Promise.allSettled(Array.from(c.values(),({resolver:a})=>a.promise))).filter(a=>"rejected"===
a.status&&!(x.isAbortError(a.reason)||z(a.reason)));if(0<b.length)throw new AggregateError(b,"One or more expression executions failed");};d._makeContext=function(b){const [c,h]=this._baseContext,f=this.feature.clone();f.attributes=b;return[{...c,$feature:f},h]};v._createClass(g,[{key:"_baseContext",get:function(){const {editType:b,layer:c,map:h,originalFeature:f,spatialReference:k}=this.arcadeContextInfo,a="feature"===c?.type?c:"scene"===c?.type&&w.isSome(c.associatedLayer)?c.associatedLayer:void 0;
return[{$originalfeature:f,$editcontext:{editType:b},$layer:a,$featureset:a,$datastore:c?.url,$map:h},{spatialReference:k??void 0}]}},{key:"feature",set:function(b){this._latestFieldValues={...b?.attributes};this._set("feature",b)}}]);return g}(A);n.__decorate([q.property()],l.FormExpressionsManager.prototype,"_baseContext",null);n.__decorate([q.property()],l.FormExpressionsManager.prototype,"feature",null);n.__decorate([q.property()],l.FormExpressionsManager.prototype,"executors",void 0);n.__decorate([q.property()],
l.FormExpressionsManager.prototype,"inputFields",void 0);n.__decorate([q.property()],l.FormExpressionsManager.prototype,"arcadeContextInfo",void 0);l.FormExpressionsManager=n.__decorate([B.subclass("esri.widgets.FeatureForm.FormExpressionsManager")],l.FormExpressionsManager);const y=(d,g,u)=>{if(!g.has(d)){var b=x.createResolver();g.set(d,{resolver:b,dependencyPromises:[]});d.abort();d=u.get(d);for(const c of d)y(c,g,u),g.get(c).dependencyPromises.push(b.promise)}},z=d=>d&&"object"===typeof d&&"message"in
d&&"Cancelled"===d.message;Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});