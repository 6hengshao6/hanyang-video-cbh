// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../kernel ../../../request ../../../symbols ../../../core/Accessor ../../../core/Collection ../../../core/jsonMap ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/screenUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/PropertyOrigin ../../../layers/effects/EffectView ../../../layers/effects/jsonUtils ../../../layers/support/ExportImageParameters ../../../layers/support/fieldUtils ../../../layers/support/rasterFormats/pixelRangeUtils ../../../renderers/support/jsonUtils ../../../renderers/support/rendererConversion ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../symbols/support/cimSymbolUtils ../../../symbols/support/previewUtils ../../../symbols/support/renderUtils ../../../symbols/support/symbolUtils ../../../symbols/support/utils ./clusterUtils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils ./utils ../../smartMapping/support/utils ../../../symbols/SimpleMarkerSymbol ../../../symbols/SimpleFillSymbol".split(" "),
function(va,Y,v,ha,wa,ia,u,xa,ya,za,A,B,D,x,Aa,Ba,w,bb,cb,db,Ca,L,Da,Ea,Fa,Ga,ja,Ha,Ia,Ja,Ka,La,Ma,C,Na,Oa,M,Pa,ka,Z,E,Qa,N,la){function F(g){return"esri.renderers.SimpleRenderer"===g.declaredClass}function G(g){return"esri.renderers.ClassBreaksRenderer"===g.declaredClass}function T(g){return"esri.renderers.UniqueValueRenderer"===g.declaredClass}function ma(g){return"esri.renderers.HeatmapRenderer"===g.declaredClass}function aa(g){return"esri.renderers.PointCloudClassBreaksRenderer"===g.declaredClass}
function ba(g){return"esri.renderers.PointCloudStretchRenderer"===g.declaredClass}function ca(g){return"esri.renderers.PointCloudUniqueValueRenderer"===g.declaredClass}function na(g){return"esri.renderers.DotDensityRenderer"===g.declaredClass}function oa(g){return"esri.renderers.PieChartRenderer"===g.declaredClass}function pa(g){return"esri.layers.SubtypeGroupLayer"===g.declaredClass}function Ra(g){g="authoringInfo"in g?g?.authoringInfo:null;return"univariate-color-size"===g?.type&&"above-and-below"===
g?.univariateTheme}const U=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Sa=new za.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),V=new N({size:6,outline:{color:[128,128,128,.5],width:.5}}),Ta=new la({style:"solid"}),Ua=new N({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let H={};u=function(g){function O(a){a=Va.call(this,a);a._hasColorRamp=
!1;a._hasOpacityRamp=!1;a._hasSizeRamp=!1;a._webStyleSymbolCache=new Map;a._dotDensityUrlCache=new Map;a._scaleDrivenSizeVariable=null;a._hasClusterSizeVariable=!1;a.children=new ya;a.layerView=null;a.layer=null;a.legendElements=[];a.parent=null;a.hideLayersNotInCurrentView=!1;a.keepCacheOnDestroy=!1;a.respectLayerVisibility=!0;a.sublayerIds=[];a.title=null;a.view=null;return a}Y._inherits(O,g);var Va=Y._createSuper(O);g=O.prototype;g.initialize=function(){const a=()=>this.notifyChange("ready");this.addHandles([x.on(()=>
this.children,"change",b=>{const {added:c,removed:d}=b;c.forEach(e=>{const f=`activeLayerInfo-ready-watcher-${e.layer.uid}`;this.addHandles(x.watch(()=>e.ready,a,x.initial),f)});d.forEach(e=>this.removeHandles(e.layer.uid));a()})]);this.keepCacheOnDestroy||(H={})};g.destroy=function(){this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=null;this.keepCacheOnDestroy||(H=null)};g.buildLegendElementsForFeatureCollections=async function(a){if(this.hideLayersNotInCurrentView&&
!await this._isLayerInCurrentView())this.legendElements=[],this.notifyChange("ready");else{a=Array.from(a,b=>{if("esri.layers.FeatureLayer"===b.declaredClass)return this._getRendererLegendElements(b.renderer,{title:b.title});if(b.featureSet&&b.featureSet.features.length){var c=b.layerDefinition,d=c&&c.drawingInfo;d=d&&Ha.fromJSON(d.renderer);c=Sa.read(c.geometryType);return d?this._getRendererLegendElements(d,{title:b.name,geometryType:c}):(A.getLogger(this.declaredClass).warn("drawingInfo not available!"),
null)}return null});try{const b=[];await D.eachAlways(a).then(c=>{c.forEach(({value:d})=>d&&b.push(...d))});this.legendElements=b;this.notifyChange("ready")}catch(b){A.getLogger(this.declaredClass).warn("error while building legend for layer!",b)}}};g.buildLegendElementsForRenderer=async function(a){try{this.legendElements=(this.hideLayersNotInCurrentView?await this._isLayerInCurrentView():1)?await this._getRendererLegendElements(a):[],this.notifyChange("ready")}catch(b){A.getLogger(this.declaredClass).warn("error while building legend for layer!",
b)}};g.buildLegendElementsForFeatureReduction=async function(a){try{this.legendElements=(this.hideLayersNotInCurrentView?await this._isLayerInCurrentView():1)?await this._getLegendElementsForFeatureReduction(a):[],this.notifyChange("ready")}catch(b){A.getLogger(this.declaredClass).warn("error while building legend for layer!",b)}};g.buildLegendElementsForTools=async function(){const a=this.layer;if("esri.layers.VoxelLayer"===a.declaredClass)this._constructLegendElementsForVoxellayer();else if("esri.layers.WMTSLayer"===
a.declaredClass)this._constructLegendElementsForWMTSlayer();else if("esri.layers.WMSLayer"===a.declaredClass)await this._constructLegendElementsForWMSSublayers();else if("esri.layers.BuildingSceneLayer"===a.declaredClass)await this._constructLegendElementsForBuildingSceneLayer();else if("esri.layers.MapImageLayer"===a.declaredClass||"esri.layers.TileLayer"===a.declaredClass||pa(a))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");var b="default";if("esri.layers.ImageryLayer"===
a.declaredClass){b=a?.renderingRule?.functionName||"default";const c=a.bandIds?.length?a.bandIds.join(""):"###";b=b+"_"+c}await this._getLegendLayers(`${a.uid}-${b}`).then(async c=>{this.legendElements=[];this.notifyChange("ready");c=c.map(async d=>{if("esri.layers.ImageryLayer"===a.declaredClass||"esri.layers.ImageryTileLayer"===a.declaredClass){const e=x.watch(()=>["renderingRule"in a&&a.renderingRule,a.bandIds],()=>D.debounce(async()=>{H["default"]=null;a.renderer?await this.buildLegendElementsForRenderer(a.renderer):
await this.buildLegendElementsForTools()})());this.addHandles(e,"imageryLayers-watcher")}(d=this._generateSymbolTableElementForLegendLayer(d))&&d.infos.length&&("esri.layers.ImageryLayer"===a.declaredClass&&(d.title=a.title),this.legendElements.push(d));this.notifyChange("ready")});await D.eachAlways(c)}).catch(c=>{A.getLogger(this.declaredClass).warn("Request to server for legend has failed!",c)})}};g._isLayerInCurrentView=async function(){const a=this.layer,b=this.layerView,c=b&&"createQuery"in
b&&"queryFeatureCount"in b;if(!(c||b&&"createQuery"in a&&"queryFeatureCount"in a))return!0;await x.whenOnce(()=>!b.updating);const d=c?"createQuery"in b&&b.createQuery():"createQuery"in a&&a.createQuery();if(!d)return!0;d.geometry=this.view.extent;return 0!==(c?"queryFeatureCount"in b&&await b.queryFeatureCount(d):"queryFeatureCount"in a&&await a.queryFeatureCount(d))};g._getParentLayerOpacity=function(a){let b=1;const c=a.parent;c&&"uid"in c&&(b=this._getParentLayerOpacity(c));return a.opacity*b};
g._isGroupActive=function(){const a=this.children;return a.length?a.some(b=>b.ready):!1};g._isRendererScaleDriven=function(a){return"dot-density"===a.type||U.test("valueExpression"in a?a.valueExpression:null)?!0:(a="visualVariables"in a?a.visualVariables:null)?a.some(b=>this._isScaleDrivenSizeVariable(b)):!1};g._isScaleDrivenSizeVariable=function(a){if(a&&"size"!==a.type)return!1;const b=a.minSize,c=a.maxSize;return"object"===typeof b&&b?this._isScaleDrivenSizeVariable(b):"object"===typeof c&&c?this._isScaleDrivenSizeVariable(c):
!!a.expression||U.test(a.valueExpression)};g._isLayerScaleDriven=function(a){if("minScale"in a&&0<a.minScale||"maxScale"in a&&0<a.maxScale)return!0;if("sublayers"in a&&a.sublayers)return a.sublayers.some(c=>this._isLayerScaleDriven(c));const b=a.parent;if(!1===a.loaded&&b&&"esri.layers.MapImageLayer"===b.declaredClass&&"source"in a&&a.source&&"map-layer"===a.source.type)for(const c of b.sourceJSON.layers??[])if(c.id===a.source.mapLayerId&&(0<c.minScale||0<c.maxScale))return!0;return!1};g._constructLegendElementsForVoxellayer=
async function(){this.legendElements=[];this.removeHandles("voxel-style-watcher");this.removeHandles("voxel-current-variable");const a=this.layer;this.addHandles(x.watch(()=>a.currentVariableId,()=>this._constructLegendElementsForVoxellayer()),"voxel-current-variable");this.addHandles(x.watch(()=>a.getVariableStyles(),()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");var b=B.unwrap(a.getVariableStyle(null));const c=[];if(b)if(b.uniqueValues?.length){const e=[];b.uniqueValues.forEach(f=>
{f.enabled&&e.push({label:f.label||`${f.value}`,value:f.value,symbol:new la({color:f.color,outline:null})})});e.length&&c.push({type:"symbol-table",title:b.label,infos:e})}else if(b.transferFunction){const {colorStops:e,stretchRange:f}=b.transferFunction,h=e.toArray().reverse(),k=f.map((m,l)=>`${0===l?E.SPECIAL_CHARS_LESS_THAN:E.SPECIAL_CHARS_GREATER_THAN} ${Qa.formatNumberLabel(m)}`).reverse(),q=h.map(m=>({color:m.color,value:null,label:null}));q[0].label=k[0];q[q.length-1].label=k[1];c.push({type:"color-ramp",
title:b.label,infos:q,preview:C.renderColorRampPreviewHTML(h.map(m=>m.color))})}const d=a.opacity;b=c.reduce((e,f)=>[...e,...this._getAllInfos(f)],[]).filter(e=>!!e?.symbol).map(e=>this._getSymbolPreview(e,d));await D.eachAlways(b);this.legendElements=c;this.notifyChange("ready")};g._constructLegendElementsForWMTSlayer=function(){this.legendElements=[];this.removeHandles("wmts-activeLayer-watcher");const a=this.layer.activeLayer;this.addHandles(x.watch(()=>{const {layer:b}=this;return b&&"activeLayer"in
b&&b.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");if(a.styleId&&a.styles){let b=null;a.styles.some(c=>a.styleId===c.id?(b=c.legendUrl,!0):!1);b&&(this.legendElements=[{type:"symbol-table",title:a.title,infos:[{src:b,opacity:this.opacity}]}])}this.notifyChange("ready")};g._constructLegendElementsForWMSSublayers=async function(){this.legendElements=[];this.removeHandles("wms-sublayers-watcher");const a=this.layer;let b=null;if(a.customParameters||a.customLayerParameters)b=
{...a.customParameters,...a.customLayerParameters};this.addHandles(x.watch(()=>{const {layer:c}=this;return c&&"sublayers"in c&&c.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");this.legendElements=await this._generateLegendElementsForWMSSublayers(a.sublayers,b);this.notifyChange("ready")};g._generateLegendElementsForWMSSublayers=async function(a,b){const c=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");
a=a.toArray();for(const d of a)a=x.watch(()=>[d.title,d.visible,d.legendEnabled],()=>this._constructLegendElementsForWMSSublayers()),this.addHandles(a,"wms-sublayers-watcher"),(!this.respectLayerVisibility||d.visible&&d.legendEnabled)&&(a=await this._generateSymbolTableElementForWMSSublayer(d,b))&&a.infos.length&&c.unshift(a);return c};g._generateSymbolTableElementForWMSSublayer=async function(a,b){return!a.legendUrl&&a.sublayers?(b=(await this._generateLegendElementsForWMSSublayers(a.sublayers,b)).filter(c=>
c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,b)};g._generateSymbolTableElementForLegendUrl=async function(a,b){let c=a.legendUrl;if(c){var d={type:"symbol-table",title:a.title||a.name||String(a.id??""),infos:[]};b&&(c=Ba.addQueryParameters(c,b));b=null;a=a.layer?.opacity;try{if(b=(await ia(c,{responseType:"image"})).data)b.style.opacity=a}catch{}d.infos.push({src:c,preview:b,opacity:a});return d}};g._getLegendLayers=function(a,b){const c=H&&H[a];return c?
Promise.resolve(c):this._legendRequest(b).then(d=>{d=d.layers;return H[a]=d})};g._legendRequest=function(a){var b=this.layer;a={f:"json",dynamicLayers:a};if("esri.layers.ImageryLayer"===b.declaredClass){var c=b.exportImageServiceParameters.renderingRule;c&&(a.renderingRule=JSON.stringify(c.rasterFunctionDefinition||c.toJSON()));b.bandIds&&(a.bandIds=b.bandIds.join());if(b.raster||b.viewId||b.customParameters){const {raster:d,viewId:e,customParameters:f}=b;a={raster:d,viewId:e,...a,...f}}}c=b.url.replace(/(\/)+$/,
"");"version"in b&&10.01<=b.version?(b=c.indexOf("?"),c=-1<b?c.substring(0,b)+"/legend"+c.substring(b):c+"/legend"):(b=c.toLowerCase().indexOf("/rest/"),b=c.substring(0,b)+c.substring(b+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(b)+"\x26returnbytes\x3dtrue");return ia(c,{query:a}).then(d=>d.data)};g._constructLegendElementsForBuildingSceneLayer=async function(){this.legendElements=[];this.removeHandles("sublayers-watcher");const a=this.layer;this.addHandles(x.watch(()=>
a.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){A.getLogger(this.declaredClass).warn("Request to server for legend has failed!",b)}};g._generateLegendElementsForBuildingSublayers=async function(a,b){let c=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");
a=a.toArray();for(const e of a)if(a=x.watch(()=>["renderer"in e&&e.renderer,e.opacity,e.title,e.visible],()=>this._constructLegendElementsForBuildingSceneLayer()),this.addHandles(a,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){a=e&&null!=e.opacity?e.opacity:null;var d=null!=a?a*b:b;"building-group"===e.type?(a={type:"symbol-table",title:e.title,infos:[]},d=await this._generateLegendElementsForBuildingSublayers(e.sublayers,d),a.infos.push(...d),c=[a,...c]):e.renderer&&(c=[...(await this._getRendererLegendElements(e.renderer,
{title:e.title,opacity:d,sublayer:e})),...c])}return c.filter(e=>!!e&&("infos"in e&&e.infos?0<e.infos.length:!0))};g._constructLegendElementsForSublayers=async function(){this.legendElements=[];this.removeHandles("sublayers-watcher");const a=this.layer;this.addHandles(x.watch(()=>a.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(b){A.getLogger(this.declaredClass).warn("Request to server for legend has failed!",
b)}};g._generateLegendElementsForSublayers=async function(a,b,c){const d=this.layer;let e=[];this.addHandles(a.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");a=a.toArray();!c&&this.sublayerIds&&this.sublayerIds.length&&(a=this.sublayerIds.map(f=>d.findSublayerById(f)).filter(B.isSome));for(const f of a)if(a=x.watch(()=>[f.renderer,f.opacity,f.title,f.visible,f.legendEnabled],()=>this._constructLegendElementsForSublayers()),this.addHandles(a,"sublayers-watcher"),
!this.respectLayerVisibility||f.visible&&f.legendEnabled&&this._isSublayerInScale(f)){a=f&&null!=f.opacity?f.opacity:null;a=null!=a?a*b:b;const h=pa(d)?!0:f.originIdOf("renderer")>L.OriginId.SERVICE;f.renderer&&!f.sublayers&&h?(await f.load(),e=[...(await this._getRendererLegendElements(f.renderer,{title:f.title,opacity:a,sublayer:f})),...e]):(a=await this._generateSymbolTableElementForSublayer(f,a,c))&&e.unshift(a)}return e.filter(f=>!!f&&("infos"in f&&f.infos?0<f.infos.length:!0))};g._generateSymbolTableElementForSublayer=
async function(a,b,c){if(!c){c=new Map;var d=this.layer,e=a.source;let f=null;if(e&&("map-layer"!==e.type||e.mapLayerId!==a.id||e.gdbVersion&&e.gdbVersion!==("gdbVersion"in d&&d.gdbVersion))||a.originIdOf("renderer")>L.OriginId.SERVICE||a.originIdOf("labelingInfo")>L.OriginId.SERVICE||a.originIdOf("labelsVisible")>L.OriginId.SERVICE)e=new Fa.ExportImageParameters({layer:this.layer}),f=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy();(await this._getLegendLayers(f||`${d.uid}-default`,f)).forEach(h=>
c.set(h.layerId,h))}d=c.get(a.id);return(!d||d?.subLayerIds&&d.defaultVisibility)&&a.sublayers?(b=await this._generateLegendElementsForSublayers(a.sublayers,b,c),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendLayer(d,a,b)};g._generateSymbolTableElementForLegendLayer=function(a,b,c){if(!a||!a.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(a,b))return null;var d=b?.renderer;let e=b?.title||a.layerName;d&&(!b||b?.originIdOf("renderer")>L.OriginId.SERVICE)&&
(d=b?.title||this._getRendererTitle(d,b))&&(e&&"string"!==typeof d&&"title"in d&&(d.title=e),e=d);const f={type:"symbol-table",title:e,legendType:a.legendType||null,infos:[]},h=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend;a.legendGroups&&0<a.legendGroups.length?a.legendGroups.forEach(k=>{const q={type:"symbol-table",title:k.heading,legendType:a.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(h.filter(m=>m.groupId===k.id),a.layerId,c)};0<q.infos?.length&&
f.infos.push(q)}):f.infos=this._generateSymbolTableElementInfosForLegendLayer(h,a.layerId,c);return 0<f.infos.length?f:null};g._generateSymbolTableElementInfosForLegendLayer=function(a,b,c){return a.map(d=>{let e=d.url;if(d.imageData&&0<d.imageData.length)e=`data:image/png;base64,${d.imageData}`;else if(0!==e.indexOf("http"))e=wa.addTokenParameter(`${this.layer.url}/${b}/images/${e}`);else return null;return{label:d.label,src:e,opacity:null==c?this.opacity:c,width:d.width,height:d.height}}).filter(B.isSome)};
g._isSublayerInScale=function(a){const b=a.minScale||0;a=a.maxScale||0;return 0<b&&b<this.scale||a>this.scale?!1:!0};g._isLegendLayerInScale=function(a,b){b=b||this.layer;let c=null,d=null,e=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&(d=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,d=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||
d>this.scale)e=!1;return e};g._sanitizeLegendForSublayer=function(a,b){if("version"in this.layer&&10.1>this.layer.version||0===a.length)return a;b=b.renderer;let c=0,d=null;a.some(e=>e.values)&&a.some((e,f)=>{e.values||(c=f,d=e,d.label||(d.label="others"));return null!=d});b?"unique-value"===b.type?d&&(a.splice(c,1),a.push(d)):"class-breaks"===b.type&&(d&&a.splice(c,1),a.reverse(),d&&a.push(d)):d&&(a.splice(c,1),a.push(d));return a};g._getRendererLegendElements=async function(a,b={}){var c=this.view;
c=F(a)||G(a)||T(a)||ma(a)||na(a)||oa(a)?"2d"===c.type||Ia.isSupportedRenderer3D(a):"raster-stretch"===a.type||"raster-colormap"===a.type||"raster-shaded-relief"===a.type||aa(a)||ba(a)||ca(a)||"vector-field"===a.type||"flow"===a.type;if(!c)return A.getLogger(this.declaredClass).warn(`Renderer of type '${a.type}' not supported!`),[];if(aa(a)||ba(a)||ca(a)||"esri.renderers.PointCloudRGBRenderer"===a.declaredClass)return this._constructPointCloudRendererLegendElements(a,b);if(na(a))return this._constructDotDensityRendererLegendElements(a);
a=await this._loadRenderer(a);return oa(a)?this._constructPieChartRendererLegendElements(a):this._constructRendererLegendElements(a,b)};g._getLegendElementsForFeatureReduction=async function(a){let b=null;"binning"===a.type?b=a.renderer:"cluster"===a.type&&(b=this._getClusterRenderer(a));return b?this._getRendererLegendElements(b):[]};g._getPointCloudRendererTitle=function(a){return(a.legendOptions?.title||a.field)??""};g._constructPointCloudRendererLegendElements=function(a,b={}){b=b.title;const c=
[];let d=null;var e=null;if(aa(a))d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorClassBreakInfos.forEach(f=>{d.infos.unshift({label:f.label||f.minValue+" - "+f.maxValue,value:[f.minValue,f.maxValue],symbol:this._getAppliedCloneSymbol(V,f.color)})});else if(ba(a)){e=a.stops;let f=null;if(e?.length&&(1===e.length&&(f=e[0].color),!f)){const h=e[0].value,k=e[e.length-1].value;null!=h&&null!=k&&(f=M.getColorFromPointCloudStops(h+(k-h)/2,e))}d={type:"symbol-table",
title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(V,f||V.color)}]};e=M.getRampStopsForPointCloud(a.stops??[])??[];e={type:"color-ramp",title:b||this._getPointCloudRendererTitle(a),infos:e,preview:C.renderColorRampPreviewHTML(e.map(h=>h.color))}}else ca(a)&&(d={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorUniqueValueInfos?.forEach(f=>{d.infos.push({label:f.label||f.values.join(", "),value:f.values.join(", "),symbol:this._getAppliedCloneSymbol(V,
f.color)})}));d&&d.infos.length&&c.push(d);e&&e.infos.length&&c.push(e);b=c.reduce((f,h)=>[...f,...(h.infos??[])],[]).filter(f=>!!f.symbol).map(f=>this._getSymbolPreview(f,this.opacity,{symbolConfig:{applyColorModulation:!!a.colorModulation}}));return D.eachAlways(b).then(()=>c)};g._getElementInfoForDotDensity=function(a,b){const {backgroundColor:c,outline:d,dotSize:e}=a;var f=this.effectList?.effects.map(k=>k.toJSON());f=Ea.effectFunctionsFromJSON(f);f=e+"-"+b+"-"+c+"-"+(d&&JSON.stringify(d.toJSON()))+
"-"+f;const h=this._dotDensityUrlCache;a=h.has(f)?h.get(f):C.renderDotDensityPreviewHTML(a,b);h.set(f,a);b=Ma.renderSymbol([[{shape:{type:"image",x:0,y:0,width:a.width,height:a.height,src:a.src},fill:null,stroke:null,offset:[0,0]}]],[a.width,a.height],{effectView:this.effectList});return{opacity:1,src:a.src,preview:b,width:a.width,height:a.height}};g._constructDotDensityRendererLegendElements=function(a){const b=a.calculateDotValue(this.view.scale),c={type:"symbol-table",title:{value:b&&Math.round(b),
unit:a.legendOptions&&a.legendOptions.unit||""},infos:[]};a.attributes.forEach(d=>{const e=this._getElementInfoForDotDensity(a,d.color);e.label=d.label||d.valueExpressionTitle||d.field;c.infos.push(e)});return Promise.resolve([c])};g._constructPieChartRendererLegendElements=async function(a){const b=this.layer.opacity,c=[];let d=null;const e=a.outline;a.attributes.forEach(k=>{const q=new N({color:k.color,outline:e});c.push({label:k.label||k.valueExpressionTitle||k.field,symbol:q})});var f=c.length?
[...c]:[];if(a.othersCategory?.color&&0!==a.othersCategory?.threshold){var h=new N({color:a.othersCategory.color,outline:e});d=a.othersCategory.label||"Other";c.push({label:d,symbol:h})}a.defaultColor?.a&&(h=new N({color:a.defaultColor,outline:e}),c.push({label:a.defaultLabel,symbol:h}));h=await this._getVisualVariableLegendElements(a,this.layer)||[];c.length&&(h.unshift({type:"symbol-table",title:null,infos:c}),f=f.filter(k=>k.label!==d).map(k=>k.symbol.color).filter(Boolean),f=C.renderPieChartPreviewHTML(f,
{holePercentage:a.holePercentage,backgroundColor:a.backgroundFillSymbol?.color,effectList:this.effectList,outline:e}),h.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(a,this.layer),infos:c,preview:f}));a=h.reduce((k,q)=>[...k,...this._getAllInfos(q)],[]).filter(k=>!!k?.symbol&&!k?.preview).map(k=>this._getSymbolPreview(k,b,{effectList:this.effectList}));await D.eachAlways(a);return h};g._constructRendererLegendElements=async function(a,b={}){const {title:c,sublayer:d}=b,e=d||this.layer;
this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1;this._scaleDrivenSizeVariable=null;const f=await this._getVisualVariableLegendElements(a,e)||[],h={type:"symbol-table",title:c||this._getRendererTitle(a,e),infos:[]};let k=null,q=!1;const m=new Set;if("flow"!==a.type||this._hasSizeRamp)if("univariate-color-size"===("authoringInfo"in a?a?.authoringInfo:null)?.type){var l=c,t=Ra(a)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",r=f.findIndex(n=>"color-ramp"===n.type);r=-1!==
r?f.splice(r,1)[0]:null;var p=f.findIndex(n=>"size-ramp"===n.type);p=-1!==p?f.splice(p,1)[0]:null;var y=[];r&&(l=r.title,y.push(r));p&&(l=p.title,y.push(p));0<y.length&&f.push({type:t,title:l,infos:y})}else if(ma(a))l=Pa.getHeatmapRampStops(a),f.push({type:"heatmap-ramp",title:c||this._getRendererTitle(a,e),infos:l,preview:C.renderColorRampPreviewHTML(l.map(n=>n.color),{effectList:this.effectList})});else if(T(a)){if((t=a&&a.authoringInfo)&&"relationship"===t.type){const {numClasses:n,field1:z,field2:I}=
t;t=t.focus;if(n&&z&&I){p=[z,I];r=ka.getRotationAngleForFocus(t)||0;for(l of p){const {field:da,normalizationField:P,label:W}=l;p=W||{field:this._getFieldAlias(da,e),normField:P&&this._getFieldAlias(P,e)};y=Ua.clone();y.angle=r;h.infos.push({label:p,symbol:y});m.add(y);r+=90}l=ka.getRelationshipRampElement({focus:t,numClasses:n,infos:a.uniqueValueInfos??[]});f.unshift(l)}}else if("esri.layers.ImageryLayer"===this.layer.declaredClass||"esri.layers.ImageryTileLayer"===this.layer.declaredClass)a.uniqueValueInfos?.forEach(n=>
{n.symbol&&h.infos.push({label:n.label||n.value,value:n.value,symbol:n.symbol})});else{const {field:n,field2:z,field3:I,fieldDelimiter:da,valueExpression:P,defaultSymbol:W}=a,Wa=!(!n&&!P||!z&&!I),J=[];a.uniqueValueGroups?.forEach(qa=>{const ea={type:"symbol-table",title:qa.heading,infos:[]};qa.classes?.forEach(K=>{const {symbol:ra,values:Xa}=K;if(ra){var Q=[],R=[];for(const Ya of Xa??[]){const {value:sa,value2:ta,value3:ua}=Ya,S=[],X=[];if(n||P)S.push(sa),X.push(this._getDomainName(n,sa,e));z&&(S.push(ta),
X.push(this._getDomainName(z,ta,e)));I&&(S.push(ua),X.push(this._getDomainName(I,ua,e)));Q.push(Wa?S.join(da||""):S[0]);R.push(X.join(" - "))}Q=Q.join(", ");K=K.label;K||(R=R.filter(Boolean),K=R.length?R.join(", "):Q);ea.infos.push({label:K,value:Q,symbol:ra})}});ea.infos.length&&J.push(ea)});J.length&&(l=J[0],1===J.length&&"title"in l&&!l.title?h.infos.push(...(l.infos??[])):(W&&(J.push({type:"symbol-table",infos:[{label:a.defaultLabel||"others",symbol:W}]}),q=!0),h.infos.push(...J)),c||a.legendOptions&&
a.legendOptions.title||a.valueExpressionTitle||(h.title=null))}a.defaultSymbol&&!q&&(h.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),q=!0)}else if(G(a))k=this._isUnclassedRenderer(a),k&&this._hasSizeRamp||(a.classBreakInfos.forEach(n=>{n.symbol&&h.infos.unshift({label:n.label||(k?null:n.minValue+" - "+n.maxValue),value:[n.minValue,n.maxValue],symbol:n.symbol})}),k&&(h.title=null),this._updateInfosforClassedSizeRenderer(a,h.infos)),a.defaultSymbol&&!k&&(h.infos.push({label:a.defaultLabel||
"others",symbol:a.defaultSymbol}),q=!0);else if("raster-stretch"===a.type)if("esri.layers.ImageryTileLayer"===this.layer.declaredClass||"esri.layers.WCSLayer"===this.layer.declaredClass)l=this._constructTileImageryStretchRendererElements(a),"stretch-ramp"===l.type?f.push(l):h.infos=l;else{l=this.layer;a.statistics&&a.statistics.length&&(t=null!=a.statistics[0].min?a.statistics[0].min:a.statistics[0][0],r=null!=a.statistics[0].max?a.statistics[0].max:a.statistics[0][1]);p=[];p=B.unwrap(l.renderingRule?
await l.generateRasterInfo(l.renderingRule):l.serviceRasterInfo);const n=p.keyProperties.BandProperties;y=ja.getPixelValueRange(p.pixelType);1===p.bandCount?(l=l.bandIds?.[0]||0,t=null!=t?t:p.statistics?p.statistics[l].min:y[0],r=null!=r?r:p.statistics?p.statistics[l].max:y[1],t||r?f.push(this._getStretchLegendElements(a,{min:t,max:r})):this._getServerSideLegend()):l.bandIds&&1===l.bandIds.length?(t=null!=t?t:p.statistics?p.statistics[l.bandIds[0]].min:y[0],r=null!=r?r:p.statistics?p.statistics[l.bandIds[0]].max:
y[1],t||r?f.push(this._getStretchLegendElements(a,{min:t,max:r})):this._getServerSideLegend()):3<=p.bandCount?n&&n.length>=p.bandCount?l.bandIds&&3===l.bandIds.length?(p=l.bandIds.map(z=>n[z].BandName),h.infos=this._createSymbolTableElementMultiBand(p)):"lerc"===l.format?(p=[0,1,2].map(z=>n[z].BandName),h.infos=this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend():"lerc"===l.format?(p=["band1","band2","band3"],h.infos=this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend():
this._getServerSideLegend()}else if("raster-colormap"===a.type)a.colormapInfos.forEach(n=>{h.infos.push({label:n.label,value:n.value,symbol:this._getAppliedCloneSymbol(Ta,n.color)})});else if(F(a)){l=a.symbol;switch(b.geometryType){case "point":l="pointSymbol"in e?e.pointSymbol:null;break;case "polyline":l="lineSymbol"in e?e.lineSymbol:null;break;case "polygon":l="polygonSymbol"in e?e.polygonSymbol:null}t=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;a.symbol&&t&&h.infos.push({label:a.label,
symbol:l})}else"vector-field"===a.type?(a.outputUnit&&(this.title="("+a.toJSON().outputUnit+")"),h.title=a.attributeField,l=a.getClassBreakInfos(),l?.length?l.forEach(n=>{h.infos.push({label:n.minValue+" - "+n.maxValue,symbol:n.symbol})}):h.infos.push({label:a.attributeField,symbol:a.getDefaultSymbol()})):"raster-shaded-relief"===a.type&&f.push(this._getStretchLegendElements(a,{min:0,max:255}));else l=await E.getSymbolForFlowRenderer(a),h.infos.push({label:null,symbol:l});const fa=a.defaultSymbol;
!fa||q||F(a)||k&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||f.push({type:"symbol-table",infos:[{label:a.defaultLabel||"others",symbol:fa}]});h.infos.length&&f.unshift(h);const Za=null==b.opacity?this.opacity:b.opacity,$a=this._isTallSymbol("visualVariables"in a?a.visualVariables:null),ab="esri.layers.ImageryLayer"===this.layer.declaredClass||"esri.layers.ImageryTileLayer"===this.layer.declaredClass;b=f.reduce((n,z)=>[...n,...this._getAllInfos(z)],[]).filter(n=>!!n?.symbol).map(n=>
this._getSymbolPreview(n,Za,{isDefault:n.symbol===fa,applyScaleDrivenSize:!m.has(n.symbol),symbolConfig:{isTall:$a,isSquareFill:ab},effectList:m.has(n.symbol)?null:this.effectList}));a=null;await D.eachAlways(b);return f};g._getServerSideLegend=function(){setTimeout(()=>this.buildLegendElementsForTools(),0)};g._getAllInfos=function(a){const b=a?.infos;return b?b.reduce((c,d)=>c.concat(this._getAllInfos(d)),[]):[a]};g._constructTileImageryStretchRendererElements=function(a){function b(q){const m=(c?.bandIds?.length?
c.bandIds:Array.from(Array(Math.min(d.bandCount,3)).keys())).map(l=>q&&q[l]&&q[l].BandName||"band"+(l+1));3>m.length?m.push(m[1]):3<m.length&&m.splice(3);return m}const c=this.layer,{rasterInfo:d}=c.raster,e=d.bandCount||a.statistics.length;var f;var h=[];const k=d.keyProperties&&d.keyProperties.BandProperties;(f=a?.statistics?.length?a.statistics:d?.statistics)?(h=void 0!==f[0].min?f[0].min:f[0][0],f=f[0].max||f[0][1]):(f=ja.getPixelValueRange(d.pixelType),h=f[0],f=f[1]);c.hasStandardTime()&&(h=
c.getStandardTimeValue(h),f=c.getStandardTimeValue(f));if(1===d.bandCount||1===c.bandIds?.length)return this._getStretchLegendElements(a,{min:h,max:f});h=k&&k.length>=e?b(k):b();return this._createSymbolTableElementMultiBand(h)};g._getStretchLegendElements=function(a,b){a=M.getStrectchRampStops(a.colorRamp,b);return{type:"stretch-ramp",title:"",infos:a,preview:C.renderColorRampPreviewHTML(a.map(c=>c.color))}};g._getClusterSymbol=function(){var a=this.layer;const b=(a="featureReduction"in a&&a.featureReduction)&&
"symbol"in a&&a.renderer;return b&&!0!==b?.authoringInfo?.isAutoGenerated?null:a&&"symbol"in a?a.symbol:null};g._getSizeLegendElement=async function(a,b,c,d){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(b):a,infos:await Z.getRampStops(c,b,await E.getMedianColor(c),this.scale,this.view.type,!!d,this._hasClusterSizeVariable?this._getClusterSymbol():null)}};g._createSymbolTableElementMultiBand=function(a){const b=[],c=["red","green","blue"];a.forEach((d,e)=>{b.push({label:{colorName:c[e],
bandName:d},src:E.RGB_IMG_SOURCE[e],opacity:this.opacity??1})});return b};g._updateInfosforClassedSizeRenderer=function(a,b){const c=a.authoringInfo&&"class-breaks-size"===a.authoringInfo.type,d=a.classBreakInfos.some(e=>Na.isVolumetricSymbol(e.symbol));if(c&&d){const e=Z.REAL_WORLD_MAX_SIZE;a=a.classBreakInfos.length;const f=(e-Z.REAL_WORLD_MIN_SIZE)/(1<a?a-1:a);b.forEach((h,k)=>{h.size=e-f*k})}};g._isTallSymbol=function(a){let b=!1,c=!1;if(a)for(let d=0;d<a.length&&(!b||!c);d++){const e=a[d];"size"===
e.type&&("height"===e.axis&&(b=!0),"width-and-depth"===e.axis&&(c=!0))}return b&&c};g._getSymbolPreview=async function(a,b,c){var d=!c?.isDefault&&null==a.size&&this._hasSizeRamp?Aa.px2pt(La.SymbolSizeDefaults.size):a.size;this._scaleDrivenSizeVariable&&c?.applyScaleDrivenSize&&({getSize:d}=await new Promise((e,f)=>va(["../../../renderers/visualVariables/support/visualVariableUtils"],e,f)),d=d(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===a.symbol.type?
a.symbol.style:null}));return C.renderPreviewHTML(a.symbol,{size:d,opacity:b,scale:!1,symbolConfig:c?.symbolConfig,effectView:c?.effectList}).then(e=>{a.preview=e;return a}).catch(()=>{a.preview=null;return a})};g._getClusterRenderer=function(a){this._hasClusterSizeVariable=!1;var b="renderer"in this.layer?this.layer.renderer:null;b=a.renderer?.clone()||b?.clone();const c=B.unwrap(Oa.getClusterSizeVariable(this.layerView._effectiveRenderer,this.view));if(c&&null!=b&&"visualVariables"in b&&!b.visualVariables?.some(d=>
"size"===d.type&&"outline"!==d.target&&!U.test(d.valueExpression))){if("clusterMinSize"in a&&"clusterMaxSize"in a){const {clusterMinSize:d,clusterMaxSize:e}=a;c.legendOptions=new Ja({showLegend:d!==e})}b.visualVariables=(b.visualVariables||[]).concat([c]);this._hasClusterSizeVariable=!0}return b};g._loadRenderer=async function(a){const b=[],c=a.clone(),d=await E.getMedianColor(c);if(G(c)||T(c))a=(c.classBreakInfos||c.uniqueValueInfos).map(e=>this._fetchSymbol(e.symbol,d).then(f=>{e.symbol=f}).catch(()=>
{e.symbol=null})),Array.prototype.push.apply(b,a);b.push(this._fetchSymbol(c.symbol||c.defaultSymbol,c.defaultSymbol?null:d).then(e=>{this._applySymbolToRenderer(c,e,F(c))}).catch(()=>{this._applySymbolToRenderer(c,null,F(c))}));return D.eachAlways(b).then(()=>c)};g._applySymbolToRenderer=function(a,b,c){c?a.symbol=b:a.defaultSymbol=b};g._fetchSymbol=async function(a,b){if(!a)throw Error();if("web-style"===a.type){const c=this._webStyleSymbolCache;try{const d=await ("2d"===this.view.type?a.fetchCIMSymbol({cache:c}):
a.fetchSymbol({cache:c}));return this._getAppliedCloneSymbol(d,b)}catch{throw A.getLogger(this.declaredClass).warn("Fetching web-style failed!"),Error();}}return this._getAppliedCloneSymbol(a,b)};g._getAppliedCloneSymbol=function(a,b){if(!a||!b)return a;a=a.clone();const c=b&&b.toRgba();a.type.includes("3d")?this._applyColorTo3dSymbol(a,c):"cim"===a.type?Ka.applyCIMSymbolColor(a,b):a.color&&(a.color=new ha(c||a.color));return a};g._applyColorTo3dSymbol=function(a,b){b&&a.symbolLayers.forEach(c=>{c&&
(c.material||(c.material={}),c.material.color=new ha(b))})};g._getVisualVariableLegendElements=async function(a,b){if(!("visualVariables"in a&&a.visualVariables)||"vector-field"===a.type)return null;var c=a.visualVariables,d=[];const e=[],f=[];for(const m of c)"color"===m.type?d.push(m):"size"===m.type?e.push(m):"opacity"===m.type&&f.push(m);c=[...d,...e,...f];let h;if(0===d.length&&G(a)&&a.classBreakInfos&&1===a.classBreakInfos.length)var k=(k=a.classBreakInfos[0])&&k.symbol;0===d.length&&F(a)&&
(k=a.symbol);k&&(k.type.includes("3d")?(d=k.symbolLayers.getItemAt(0),"water"===d.type?B.isSome(d.color)&&(h=d.color):B.isSome(d.material)&&B.isSome(d.material.color)&&(h=d.material.color)):k.url||(h=k.color));const q=this.effectList;return(await Promise.all(c.map(async m=>{if(!m.legendOptions||!1!==m.legendOptions.showLegend){const t="flow"===a.type?m.field:this._getRampTitle(m,b);let r=null;var l="getField"in b?b.getField?.(m.field):null;l=l&&Ga.isDateField(l);"color"===m.type?(m=await M.getRampStops(m,
null,l)??[],r={type:"color-ramp",title:t,infos:m,preview:C.renderColorRampPreviewHTML(m.map(p=>p.color),{effectList:q})},this._hasColorRamp||(this._hasColorRamp=0<m.length)):"size"===m.type&&"outline"!==m.target?U.test(m.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=m):(r=await this._getSizeLegendElement(t,m,a,l),this._hasSizeRamp||(this._hasSizeRamp=!(null==r.infos||!r.infos.length))):"opacity"===m.type&&(m=await M.getRampStops(m,h,l)??[],r={type:"opacity-ramp",title:t,
infos:m,preview:C.renderColorRampPreviewHTML(m.map(p=>p.color),{effectList:q})},this._hasOpacityRamp||(this._hasOpacityRamp=0<m.length));return r&&r.infos?r:null}}))).filter(B.isSome)};g._getDomainName=function(a,b,c){return a&&"function"!==typeof a?(c=(a="getField"in c&&c.getField&&c.getField(a))&&"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(a.name):null,"coded-value"===c?.type?c.getName(b):null):null};g._getClusterTitle=function(a){var b=this.layer;a=a.field;if("featureReduction"in b&&
b.featureReduction&&"cluster"===b.featureReduction.type&&(b=b.featureReduction,b=(b="popupTemplate"in b&&b.popupTemplate)&&b.fieldInfos))for(const c of b)if(c.fieldName===a)return"cluster_count"===a?c.label||{showCount:!0}:c.label;return{showCount:!0}};g._getRampTitle=function(a,b){let c=a.field,d=a.normalizationField,e=!1,f=!1,h=!1;var k=null;c="function"===typeof c?null:c;d="function"===typeof d?null:d;k=a.legendOptions&&a.legendOptions.title;if(null==k)if(a.valueExpressionTitle)k=a.valueExpressionTitle;
else{if("renderer"in b&&b.renderer&&"authoringInfo"in b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables)for(a=b.renderer.authoringInfo.visualVariables,k=0;k<a.length;k++){const q=a[k];if("color"===q.type){if("ratio"===q.style){e=!0;break}if("percent"===q.style){f=!0;break}if("percent-of-total"===q.style){h=!0;break}}}k={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:e,ratioPercent:f,ratioPercentTotal:h}}return k};g._getRendererTitle=function(a,
b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;var c=a.field;let d=null,e=null;G(a)&&(d=a.normalizationField,e="percent-of-total"===a.normalizationType);c="function"===typeof c?null:c;d="function"===typeof d?null:d;if(T(a)){const {field2:f,field3:h,fieldDelimiter:k}=a;c=c&&this._getFieldAlias(c,b);f&&(c=`<${c}>${k}<${this._getFieldAlias(f,b)}>`,h&&(c=`${c}${k}<${this._getFieldAlias(h,b)}>`));return c}a=null;if(c||d)a=
{field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),normByPct:e};return a};g._getFieldAlias=function(a,b){var c=("popupTemplate"in b?b.popupTemplate:null)?.fieldInfos;let d;c&&c.some(h=>a===h.fieldName?(d=h,!0):!1);c=null;"getField"in b&&b.getField?c=b.getField(a):"fieldsIndex"in b&&b.fieldsIndex&&(c=b.fieldsIndex.get(a));let e=null;if(b="featureReduction"in b&&b.featureReduction)!d&&"popupTemplate"in b&&b.popupTemplate&&b.popupTemplate.fieldInfos&&b.popupTemplate.fieldInfos.some(h=>
a?.toLowerCase()===h.fieldName?.toLowerCase()?(d=h,!0):!1),"fields"in b&&b.fields&&(e=b.fields.find(h=>h.name?.toLowerCase()===a?.toLowerCase()));b=d||c||e;let f=null;b&&(f=d?.label||c?.alias||e?.alias||"name"in b&&b.name||"fieldName"in b&&b.fieldName||null);return f};g._isUnclassedRenderer=function(a){const b=a.visualVariables;let c=!1;G(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(d=>!(!d||a.field!==d.field||(a.normalizationField||d.normalizationField)&&a.normalizationField!==
d.normalizationField)):!!b.length);return c};Y._createClass(O,[{key:"effectList",get:function(){const a=this.layer;let b=null;"effect"in a&&a.effect&&(b=new Da.EffectView,b.effect=a.effect,b.endTransitions(),b.scale=this.scale);return b}},{key:"opacity",get:function(){const a=this.layer.opacity,b=this.parent?.opacity;var c=this.layer.parent;c=c&&"uid"in c?this._getParentLayerOpacity(c):null;return null!=b?b*a:null!=c?c*a:a}},{key:"ready",get:function(){return null===this.layer?!0:0<this.children.length?
this._isGroupActive():0<this.legendElements.length}},{key:"scale",get:function(){return this.view?.scale??0}},{key:"isScaleDriven",get:function(){const a=this.layer;if(null===a)return!1;if("effect"in a&&a.effect&&Array.isArray(a.effect))return!0;if("featureReduction"in a&&a.featureReduction){if("cluster"===a.featureReduction.type)return!0;if("binning"===a.featureReduction.type&&"renderer"in a.featureReduction&&a.featureReduction.renderer)return this._isRendererScaleDriven(a.featureReduction.renderer)}return"renderer"in
a&&a.renderer?this._isRendererScaleDriven(a.renderer):this._isLayerScaleDriven(this.layer)}},{key:"version",get:function(){return this._get("version")+1}}]);return O}(xa);v.__decorate([w.property()],u.prototype,"children",void 0);v.__decorate([w.property({readOnly:!0})],u.prototype,"effectList",null);v.__decorate([w.property()],u.prototype,"layerView",void 0);v.__decorate([w.property()],u.prototype,"layer",void 0);v.__decorate([w.property()],u.prototype,"legendElements",void 0);v.__decorate([w.property({readOnly:!0})],
u.prototype,"opacity",null);v.__decorate([w.property()],u.prototype,"parent",void 0);v.__decorate([w.property({readOnly:!0,dependsOn:[]})],u.prototype,"ready",null);v.__decorate([w.property()],u.prototype,"hideLayersNotInCurrentView",void 0);v.__decorate([w.property()],u.prototype,"keepCacheOnDestroy",void 0);v.__decorate([w.property()],u.prototype,"respectLayerVisibility",void 0);v.__decorate([w.property({readOnly:!0})],u.prototype,"scale",null);v.__decorate([w.property()],u.prototype,"sublayerIds",
void 0);v.__decorate([w.property({readOnly:!0})],u.prototype,"isScaleDriven",null);v.__decorate([w.property()],u.prototype,"title",void 0);v.__decorate([w.property({readOnly:!0,dependsOn:["ready"],value:0})],u.prototype,"version",null);v.__decorate([w.property()],u.prototype,"view",void 0);return u=v.__decorate([Ca.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],u)});