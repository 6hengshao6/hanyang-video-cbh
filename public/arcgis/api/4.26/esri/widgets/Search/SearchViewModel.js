// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../assets ../../config ../../Graphic ../../PopupTemplate ../../symbols ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/Point ../../geometry/SpatialReference ../../intl/locale ../../intl/messages ../../portal/Portal ../../views/support/layerViewUtils ./LayerSearchSource ./LocatorSearchSource ./SearchSource ./support/geometryUtils ./support/locatorUtils ../support/geolocationUtils ../support/GoTo ../../symbols/TextSymbol ../../symbols/PictureMarkerSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleFillSymbol".split(" "),
function(F,h,O,P,H,I,g,Q,R,v,S,T,q,x,A,k,ma,na,oa,U,J,V,W,X,K,Y,w,L,Z,G,y,B,aa,ba,ca,da,ea){function n(f,r){return f.hasOwnProperty(r)&&null!=f[r]&&""!==f[r]}const t=T.getLogger("esri.widgets.Search.SearchViewModel"),C=R.ofType({key:f=>f.layer?"layer":"locator",base:Z,typeMap:{layer:w,locator:L}}),M=V.WGS84,fa=/<(?:.|\s)*?>/g;g=function(f){function r(a){a=ha.call(this,a);a._gotoController=null;a._searching=null;a._updatingPromise=null;a._createdFeatureLayers=[];a.autoNavigate=!0;a.autoSelect=!0;a.defaultPopupTemplate=
null;a.defaultSources=new C;a.defaultSymbols={point:new ca({url:O.getAssetUrl("esri/images/search/search-symbol-32.png"),size:24,width:24,height:24}),polyline:new da({color:[130,130,130,1],width:2}),polygon:new ea({color:[235,235,235,.4],outline:{color:[130,130,130,1],width:2}})};a.includeDefaultSources=!0;a.maxInputLength=128;a.maxResults=6;a.maxSuggestions=6;a.messages=null;a.minSuggestCharacters=3;a.popupEnabled=!0;a.popupTemplate=null;a.portal=K.getDefault();a.resultCount=null;a.resultGraphicEnabled=
!0;a.resultGraphic=null;a.results=null;a.selectedSuggestion=null;a.searchAllEnabled=!0;a.selectedResult=null;a.sources=new C;a.suggestionDelay=350;a.suggestionCount=null;a.suggestions=null;a.suggestionsEnabled=!0;a.view=null;return a}F._inherits(r,f);var ha=F._createSuper(r);f=r.prototype;f.initialize=function(){const a=async()=>{const b=await X.fetchMessageBundle("esri/widgets/Search/t9n/Search");this.messages=b;this.defaultPopupTemplate=new I({title:b.searchResult,content:"{Match_addr}"})};a();
this.addHandles([A.watch(()=>[this.includeDefaultSources,this.view,this.portal],()=>this._update(),A.initial),W.onLocaleChange(a)])};f.destroy=function(){this.removeAllHandles();this._destroyFeatureLayers();this._abortGoTo();this.clearGraphics()};f.clear=function(){this.searchTerm=""};f.clearGraphics=function(){this._removeHighlight();this._closePopup();const {view:a,resultGraphic:b}=this;a&&b&&a.graphics.remove(b);this._set("resultGraphic",null)};f.search=function(a,b){this.emit("search-start");
this.clearGraphics();const c=this._createSuggestionForSearch(a);return this._searching=a=(async()=>{try{await this.when();const d=await this._getResultsFromSources(c,b);if(q.unwrap(b?.signal)?.aborted)return null;const e={activeSourceIndex:this.activeSourceIndex,searchTerm:c.text??"",numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(e,d,c);const l=this._getFirstResult(e.results),m=(c.location&&l?l.name:c.text)?.replace(fa,"");this._set("searchTerm",m);(c.key&&"number"===typeof c.sourceIndex||
c.location)&&this._set("selectedSuggestion",c);this._set("results",e.results);this._set("resultCount",e.results.reduce((p,u)=>p+(u.results?.length??0),0));this.emit("search-complete",e);await this._selectFirstResult(l);return e}finally{this._clearSearching()}})()};f.searchNearby=async function(a){if(!this.locationEnabled){var b=new v("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});t.error(b);throw b;}return this._searching=b=(async()=>
{try{const c=await B.getCurrentPosition(),d=await B.positionToPoint({position:c,view:this.view},a);return await this.search(d,a)}finally{this._clearSearching()}})()};f.select=async function(a){this.clearGraphics();if(!a)throw a=new v("select:missing-parameter","Cannot select without a searchResult.",{searchResult:a}),t.error(a),a;const {view:b}=this,c=n(a,"sourceIndex")?a.sourceIndex:this._getSourceIndexOfResult(a),d=null!=c?this.allSources.at(c):null;if(!d)throw a=new v("select:missing-source","Cannot select without a source.",
{source:d}),t.error(a),a;var e=d instanceof w?this._getLayerSourcePopupTemplate(d):d.popupTemplate,l=d.resultSymbol||this._getDefaultSymbol(a);const m=n(d,"resultGraphicEnabled")?d.resultGraphicEnabled:this.resultGraphicEnabled;var p=n(d,"autoNavigate")?d.autoNavigate:this.autoNavigate,u=n(d,"popupEnabled")?d.popupEnabled:this.popupEnabled;const ia=u?e||this.popupTemplate||this.defaultPopupTemplate:null,{feature:z}=a;if(!z)throw a=new v("select:missing-feature","Cannot select without a feature.",
{feature:z}),t.error(a),a;const {attributes:ja,geometry:N,layer:ka,sourceLayer:la}=z,D=G.getPointFromGeometry(N);e={layerViewQuery:this._getLayerView(z),elevationQuery:b&&q.isSome(D)?G.getPointWithElevation(D,b).catch(()=>D):Promise.resolve(D)};var E=await x.eachAlways(e);e=E.layerViewQuery.value;E=E.elevationQuery.value;l instanceof ba&&(l.text=a.name);p=b&&p?a.target||a.extent:null;await (q.isSome(p)?this._goToSearchResult(p):Promise.resolve());l=e?z:new H({geometry:N,symbol:l,attributes:ja,layer:ka,
sourceLayer:la,popupTemplate:ia});(p=(u=u&&this.view?.popup)&&l.getEffectivePopupTemplate(u.defaultPopupTemplateEnabled))&&u.open({features:[l],location:E});e&&Y.highlightsSupported(e)&&!p&&this._highlightFeature({graphic:l,layerView:e});!e&&m&&b&&b.graphics.push(l);this._setResultFloor(a);this._set("selectedResult",a);this._set("resultGraphic",l);this.emit("select-result",{result:a,source:d,sourceIndex:c});return a};f.suggest=async function(a,b,c){a=a||this.searchTerm;this.emit("suggest-start",{searchTerm:a});
await this._suggestTimer(b,c);b=await this._suggestImmediate(a,c);this._set("suggestions",b?.results);this._set("suggestionCount",b?.results.reduce((d,e)=>d+(e.results?.length??0),0)??null);this.emit("suggest-complete",b);return b};f.when=async function(){await A.whenOnce(()=>!this.updating)};f._update=async function(){const {portal:a,view:b}=this;if(this.includeDefaultSources){const c=this._updatingPromise=x.eachAlways([a?.load(),b?.when()]);if(this.destroyed)return;await c;if(c!==this._updatingPromise)return}await A.whenOnce(()=>
this.messages);this.destroyed||this._updateDefaultSources();this._updatingPromise=null};f._clearSearching=function(){this._searching=null};f._convertHelperServices=function(){const a=this.portal?.helperServices?.geocode;return a?a.map(b=>{if(!1!==b.placefinding){var c=P.apiKey&&y.isArcGISWorldGeocoder(b.url)?{url:y.meteredArcGISLocatorUrl}:null;b=L.fromJSON({...b,...c});c=b.url;(y.isArcGISWorldGeocoder(c)||y.isProxiedArcGISWorldGeocoder(c)||y.isMeteredArcGISWorldGeocoder(c))&&b.set({singleLineFieldName:"SingleLine",
outFields:b.outFields??["Addr_type","Match_addr","StAddr","City"],placeholder:b.placeholder??this.messages?.placeholder??"",defaultZoomScale:"number"===typeof b.defaultZoomScale?b.defaultZoomScale:2500});if(b.singleLineFieldName)return b}}).filter(q.isSome):[]};f._destroyFeatureLayers=function(){this._createdFeatureLayers.forEach(a=>a?.destroy());this._createdFeatureLayers=[]};f._getLayerSources=function(a,b){const c=this.view?.map;return a.map(d=>{const e=c.findLayerById(d.id);if(e){d=this._getLayerJSON(d);
var l=w.fromJSON(d);l.placeholder=b;this._getLayer(e,d).then(m=>{l.layer=m});return l}}).filter(q.isSome).toArray()};f._getTableSources=function(a,b){const c=this.view?.map;return a.map(d=>{if(d.id){var e=c.findTableById(d.id);if(e){d=this._getLayerJSON(d);var l=w.fromJSON(d);l.placeholder=b;this._getLayer(e,d).then(m=>{l.layer=m});return l}}}).filter(q.isSome).toArray()};f._convertApplicationProperties=function(){var a=this.view?.map?.applicationProperties?.viewing?.search;if(!a)return[];const {enabled:b,
hintText:c,layers:d,tables:e}=a;if(!b)return[];a=this._getLayerSources(d,c);const l=this._getTableSources(e,c);return[...a,...l]};f._getSubLayer=async function(a,b){await a.load();if(!a.allSublayers)throw Error();a=a.allSublayers.find(c=>c.id===b.subLayer);if(!a)throw Error();a=await a.createFeatureLayer?.();if(!a)throw Error();this._createdFeatureLayers.push(a);return a};f._getBuildingSubLayer=async function(a,b){await a.load();a=a.allSublayers.find(c=>c.id===b.subLayer);if("building-component"!==
a?.type)throw Error();await a.load();if(null==a.associatedLayer)throw Error();await a.associatedLayer.load();return a};f._getLayer=async function(a,b){if("feature"===a.type||"scene"===a.type||"csv"===a.type||"geojson"===a.type||"ogc-feature"===a.type)return a;if("map-image"===a.type)try{return await this._getSubLayer(a,b)}catch(c){return a=new v("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:a}),t.error(a),null}return"building-scene"===a.type?this._getBuildingSubLayer(a,
b):null};f._getLayerJSON=function(a){return"function"===typeof a.toJSON?a.toJSON():a};f._updateDefaultSources=function(){const {defaultSources:a,includeDefaultSources:b}=this;this._destroyFeatureLayers();a.removeAll();b&&a.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()])};f._abortGoTo=function(){this._gotoController&&this._gotoController.abort();this._gotoController=null};f._clear=function(){this._abortGoTo();this._set("resultCount",null);this._set("results",null);
this._set("suggestions",null);this._set("suggestionCount",null);this._set("selectedResult",null);this._set("selectedSuggestion",null);this.emit("search-clear")};f._closePopup=function(){const a=this.view?.popup,{resultGraphic:b}=this;if(a&&b){var {selectedFeature:c}=a;c&&c===b&&a.close()}};f._suggestTimer=function(a,b){return x.after(null!=a?a:this.suggestionDelay,null,b&&b.signal)};f._createLocationForSearch=function(a){return a instanceof H?G.getPointFromGeometry(a.geometry):a instanceof J?a:Array.isArray(a)&&
2===a.length?new J({longitude:a[0],latitude:a[1]}):null};f._createSuggestionForSearch=function(a){if(a&&n(a,"key")&&n(a,"text")&&n(a,"sourceIndex"))return a;const b=this._createLocationForSearch(a),c="string"===typeof a?a:this.searchTerm,{selectedSuggestion:d,selectedResult:e}=this,l=(a=!a&&d&&e)&&d.location;return a&&d.key===e.key&&d.sourceIndex===e.sourceIndex||l?d:{location:q.unwrap(b),text:b?"":c,sourceIndex:null,key:null}};f._getFirstResult=function(a){let b=null;a&&a.some(c=>{({results:c}=c);
c=c?.[0];const d=!!c;d&&(b=c);return d});return b};f._selectFirstResult=async function(a){return this.autoSelect&&a?this.select(a):null};f._suggestImmediate=async function(a,b){await this.when();const c=await this._getSuggestionsFromSources(a,b);if(q.unwrap(b?.signal)?.aborted)return null;a={activeSourceIndex:this.activeSourceIndex,searchTerm:a??"",numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(a,c);return a};f._formatSourceResponse=function(a,b,c){const d=b?.value||[];b=b?.error;
const e=this.allSources.at(c);b?(a.errors.push({sourceIndex:c,source:e,error:b}),t.error(b),a.numErrors++):(a.results.push({sourceIndex:c,source:e,results:d}),a.numResults+=d.length)};f._formatResponse=function(a,b,c){if(b)if(-1===a.activeSourceIndex){const d=c&&n(c,"sourceIndex")&&-1!==c.sourceIndex?c.sourceIndex:void 0;b.forEach((e,l)=>{this._formatSourceResponse(a,e,void 0!==d?d:l)})}else this._formatSourceResponse(a,b[0],a.activeSourceIndex)};f._getResultsFromSources=async function(a,b){var {allSources:c}=
this;const d=!a.location&&n(a,"sourceIndex")?a.sourceIndex:this.activeSourceIndex,e=[];if(!c.length)throw c=new v("search:no-sources-defined","At least one source is required.",{allSources:c}),t.error(c),c;-1===d?c.forEach((l,m)=>{e.push(this._getResultsFromSource(a,m,b))}):e.push(this._getResultsFromSource(a,d,b));return x.eachAlways(e)};f._getSuggestionsFromSources=async function(a,b){const {allSources:c,activeSourceIndex:d}=this,e=[];if(!c.length){const l=new v("suggest:no-sources-defined","At least one source is required.",
{allSources:c});t.error(l);throw l;}-1===d?c.forEach((l,m)=>{e.push(this._getSuggestionsFromSource(a,m,b))}):e.push(this._getSuggestionsFromSource(a,d,b));return x.eachAlways(e)};f._getResultsFromSource=async function(a,b,c){const d=null!=b?this.allSources.at(b):null;if(!d)return null;const {location:e=null}=a,l=this.view?.spatialReference||M,m=n(d,"maxResults")?d.maxResults:this.maxResults,p=d instanceof w&&n(d,"exactMatch")?d.exactMatch:!1,{view:u}=this;return d.getResults?.({view:u,sourceIndex:b,
location:e,suggestResult:a,spatialReference:l,exactMatch:p,maxResults:m},c)};f._getSuggestionsFromSource=async function(a,b,c){const d=this.allSources.at(b);if(!d)return null;a??(a="");var e=n(d,"suggestionsEnabled")?d.suggestionsEnabled:this.suggestionsEnabled,l=a?.length,m=n(d,"minSuggestCharacters")?d.minSuggestCharacters:this.minSuggestCharacters;if(e&&a.trim()&&l>=m){e=this.view?.spatialReference||M;l=n(d,"maxSuggestions")?d.maxSuggestions:this.maxSuggestions;({view:m}=this);const p=d instanceof
w&&n(d,"exactMatch")?d.exactMatch:!1;return d.getSuggestions?.({view:m,sourceIndex:b,suggestTerm:a,spatialReference:e,maxSuggestions:l,exactMatch:p},c)}return null};f._getLayerSourcePopupTemplate=function(a){const {layer:b}=a;if(b)return n(a,"popupTemplate")?a.popupTemplate:b.popupTemplate};f._getSourceIndexOfResult=function(a){const b=this.results;if(!b)return null;let c=null;b.some(d=>d.results.some(e=>e===a?(c=d.sourceIndex,!0):!1));return c};f._goToSearchResult=async function(a){const b=!!a;this._abortGoTo();
const c=new AbortController;this._gotoController=c;await this.callGoTo({target:{target:a},options:{animate:b,signal:c.signal}});this._gotoController=null};f._getDefaultSymbol=function(a){const {defaultSymbols:b}=this;a=a.feature?.geometry;if(q.isNone(a))return null;switch(a.type){case "point":case "multipoint":return b.point;case "polyline":return b.polyline;case "extent":case "polygon":return b.polygon;default:return null}};f._removeHighlight=function(){this.removeHandles("highlight")};f._getLayerView=
async function(a){const {view:b}=this;if(!a||!b||"building-component"===a.layer?.type||"subtype-sublayer"===a.layer?.type)return null;({layer:a}=a);if(!a)return null;await b.when();return b.whenLayerView(a)};f._highlightFeature=function(a){const {graphic:b,layerView:c}=a,{attributes:d,layer:e}=b;({objectIdField:a}=e);a=c.highlight((a&&d?.[a])??null??b);this.addHandles(a,"highlight")};f._setResultFloor=function(a){const {view:b}=this;var c=a.feature?.attributes;(a=a.feature?.sourceLayer)&&"floorInfo"in
a&&a?.floorInfo?.floorField&&c&&(c=c[a.floorInfo.floorField],b?.emit("select-result-floor",c))};F._createClass(r,[{key:"activeSource",get:function(){return this.allSources.at(this.activeSourceIndex)??null}},{key:"activeSourceIndex",get:function(){return 1!==this.allSources.length&&this.searchAllEnabled?-1:0},set:function(a){this._overrideIfSome("activeSourceIndex",a)}},{key:"allPlaceholder",get:function(){return this.messages?.allPlaceholder},set:function(a){this._overrideIfSome("allPlaceholder",
a)}},{key:"allSources",get:function(){const {sources:a,defaultSources:b,includeDefaultSources:c}=this,d="function"===typeof c?c.call(null,{sources:a,defaultSources:b}):c?b.concat(a):a,e=this._get("allSources")||new C;e.removeAll();e.addMany(d.filter(Boolean));return e}},{key:"locationEnabled",get:function(){return this._get("locationEnabled")||B.supported()},set:function(a){if(void 0===a)this._clearOverride("locationEnabled");else{var b=B.supported();if(a&&!b){const c=new v("locationEnabled:geolocation-unsupported",
"Geolocation API is unsupported.",{geolocation:navigator.geolocation});t.error(c)}this._override("locationEnabled",!!a&&b)}}},{key:"placeholder",get:function(){const {allSources:a,activeSourceIndex:b,allPlaceholder:c}=this;if(-1===b)return c??"";const d=a.at(b);return d?d.placeholder:""}},{key:"searchTerm",get:function(){return this._get("searchTerm")||""},set:function(a){this._set("searchTerm",a||"");this.clearGraphics();this.selectedSuggestion&&this.selectedSuggestion.text!==a&&this._set("selectedSuggestion",
null);""===a&&this._clear()}},{key:"state",get:function(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"}},{key:"updating",get:function(){return null!=this._updatingPromise}}]);return r}(aa.GoToMixin(S.EventedMixin(Q)));g.ALL_INDEX=-1;h.__decorate([k.property()],g.prototype,"_searching",void 0);h.__decorate([k.property()],g.prototype,"_updatingPromise",void 0);h.__decorate([k.property({readOnly:!0,value:null})],g.prototype,"activeSource",null);
h.__decorate([k.property()],g.prototype,"activeSourceIndex",null);h.__decorate([k.property()],g.prototype,"allPlaceholder",null);h.__decorate([k.property({readOnly:!0})],g.prototype,"allSources",null);h.__decorate([k.property()],g.prototype,"autoNavigate",void 0);h.__decorate([k.property()],g.prototype,"autoSelect",void 0);h.__decorate([k.property()],g.prototype,"defaultPopupTemplate",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"defaultSources",void 0);h.__decorate([k.property()],
g.prototype,"defaultSymbols",void 0);h.__decorate([k.property()],g.prototype,"includeDefaultSources",void 0);h.__decorate([k.property()],g.prototype,"locationEnabled",null);h.__decorate([k.property()],g.prototype,"maxInputLength",void 0);h.__decorate([k.property()],g.prototype,"maxResults",void 0);h.__decorate([k.property()],g.prototype,"maxSuggestions",void 0);h.__decorate([k.property()],g.prototype,"messages",void 0);h.__decorate([k.property()],g.prototype,"minSuggestCharacters",void 0);h.__decorate([k.property({readOnly:!0})],
g.prototype,"placeholder",null);h.__decorate([k.property()],g.prototype,"popupEnabled",void 0);h.__decorate([k.property({type:I})],g.prototype,"popupTemplate",void 0);h.__decorate([k.property({type:K})],g.prototype,"portal",void 0);h.__decorate([k.property()],g.prototype,"resultCount",void 0);h.__decorate([k.property()],g.prototype,"resultGraphicEnabled",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"resultGraphic",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"results",
void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"selectedSuggestion",void 0);h.__decorate([k.property()],g.prototype,"searchAllEnabled",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"selectedResult",void 0);h.__decorate([k.property()],g.prototype,"searchTerm",null);h.__decorate([k.property({type:C})],g.prototype,"sources",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"state",null);h.__decorate([k.property()],g.prototype,"suggestionDelay",void 0);h.__decorate([k.property()],
g.prototype,"suggestionCount",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"suggestions",void 0);h.__decorate([k.property()],g.prototype,"suggestionsEnabled",void 0);h.__decorate([k.property({readOnly:!0})],g.prototype,"updating",null);h.__decorate([k.property()],g.prototype,"view",void 0);h.__decorate([k.property()],g.prototype,"clear",null);return g=h.__decorate([U.subclass("esri.widgets.Search.SearchViewModel")],g)});