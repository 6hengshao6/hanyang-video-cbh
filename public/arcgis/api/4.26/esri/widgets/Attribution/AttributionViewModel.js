// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../geometry ../../core/asyncUtils ../../core/Collection ../../core/HandleOwner ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/support/contains ../../geometry/support/webMercatorUtils ../../geometry/SpatialReference".split(" "),function(u,t,q,A,x,B,v,w,G,H,I,C,D,y,E){function z(f,
g){return f&&"copyright"in f&&(!g||"function"===typeof f.originOf&&"user"===f.originOf("copyright"))}function F(f,g){return f.length!==g.length||f.some((n,c)=>n.text!==g[c].text)}function r(f,g,n){n&&g&&(f.find(c=>c.layerView===g&&c.text===n)||f.push({text:n,layerView:g}))}const l=[];q=function(f){function g(c){var a=n.call(this,c);a._clear=()=>{a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension");a.notifyChange("state")};a._pendingAttributions=new Set;a._fetchedAttributionData=
new Map;a.items=new x;a.view=null;a._allLayerViewsChange=b=>{a.handles.remove("suspension");const d=a.get("view.allLayerViews");d&&a.handles.add(d.map(e=>v.watch(()=>[e.suspended,e.layer?.attributionVisible],()=>a._updateAttributionItems())),"suspension");b&&b.removed&&b.removed.forEach(e=>{a._pendingAttributions.delete(e);a._fetchedAttributionData.delete(e)});a._updateAttributionItems()};a.handles.add([v.on(()=>a.view?.allLayerViews,"change",b=>a._allLayerViewsChange(b),{onListenerAdd:()=>a._allLayerViewsChange(),
onListenerRemove:a._clear}),v.when(()=>!0===a.view?.stationary,()=>a._updateAttributionItems())]);return a}u._inherits(g,f);var n=u._createSuper(g);f=g.prototype;f.destroy=function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.items.removeAll()};f._updateAttributionItems=function(){const c=this.view,a=c?.allLayerViews;l.length=0;c&&a?(a.forEach(b=>{if(!b.suspended&&b.layer?.attributionVisible){var d=b.layer;if(z(d,"user"))r(l,b,d.copyright);else if(d.hasAttributionData)if(this._fetchedAttributionData.has(b)){var e=
this._fetchedAttributionData.get(b);e?r(l,b,this._getDynamicAttribution(e,c,d)):z(d)&&r(l,b,d.copyright)}else this._fetchAttributionData(b);else(e=d.get("portalItem.accessInformation"))?r(l,b,e):r(l,b,d.copyright)}}),F(this.items,l)&&(this.items.removeAll(),this.items.addMany(l)),l.length=0,this.notifyChange("state")):this._clear()};f._fetchAttributionData=async function(c){if(!this._pendingAttributions.has(c)){this._pendingAttributions.add(c);var a=await A.result(c.layer.fetchAttributionData());
this._pendingAttributions.has(c)&&(a=a.ok?this._createContributionIndex(a.value,"bing-maps"===c.layer.type):null,this._pendingAttributions.delete(c),this._fetchedAttributionData.set(c,a));this._updateAttributionItems()}};f._createContributionIndex=function(c,a){c=c.contributors;const b={};if(!c)return b;for(let p=0;p<c.length;p++){const h=c[p];var d=h.coverageAreas;if(!d)return;for(const k of d){var e=k.bbox,m=k.zoomMin-(a&&k.zoomMin?1:0);d=k.zoomMax-(a&&k.zoomMax?1:0);for(e={extent:y.geographicToWebMercator({xmin:e[1],
ymin:e[0],xmax:e[3],ymax:e[2],spatialReference:E.WGS84}),attribution:h.attribution||"",score:null!=k.score?k.score:100,id:p};m<=d;m++)b[m]=b[m]||[],b[m].push(e)}}b.maxKey=Math.max.apply(null,Object.keys(b));return b};f._getDynamicAttribution=function(c,a,b){const {extent:d,scale:e}=a;b=b.tileInfo?.scaleToZoom(e)??0;b=Math.min(c.maxKey??0,Math.round(b));if(!d||null==b||-1>=b)return"";c=c[b];const m=y.project(d.center.clone().normalize(),a.spatialReference),p={};return c?c.filter(h=>{const k=h.id;(h=
!p[k]&&m&&h.extent&&D.extentContainsPoint(h.extent,m))&&(p[k]=!0);return h}).sort((h,k)=>k.score-h.score||h.objectId-k.objectId).map(h=>h.attribution).join(", "):""};u._createClass(g,[{key:"state",get:function(){return this.get("view.ready")?0<this._pendingAttributions.size?"loading":"ready":"disabled"}}]);return g}(B.HandleOwner);t.__decorate([w.property({readOnly:!0,type:x})],q.prototype,"items",void 0);t.__decorate([w.property({readOnly:!0})],q.prototype,"state",null);t.__decorate([w.property()],
q.prototype,"view",void 0);return q=t.__decorate([C.subclass("esri.widgets.Attribution.AttributionViewModel")],q)});