// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../analysis/LineOfSightAnalysis ../../analysis/LineOfSightAnalysisObserver ../../analysis/LineOfSightAnalysisTarget ../../core/Collection ../../core/collectionUtils ../../core/Handles ../../core/handleUtils ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../support/elevationInfoUtils ./LineOfSightTarget ../support/AnalysisViewModel".split(" "),
function(n,k,t,x,y,f,u,z,A,e,h,m,G,H,I,B,p,v,C){const q=f.ofType(v);f=function(d){function l(a){a=D.call(this,a);a.analysis=null;a.supportedViewType="3d";a.unsupportedErrorMessage="LineOfSightViewModel is only supported in 3D views.";a._handles=new z;a._vmTargetsToConnection=new Map;a._analysisTargetsToConnection=new Map;return a}n._inherits(l,d);var D=n._createSuper(l);d=l.prototype;d.initialize=function(){this._handles.add([this.targets.on("after-add",a=>this._onViewModelTargetAdded(a.item)),this.targets.on("after-remove",
a=>this._onViewModelTargetRemoved(a.item)),h.watch(()=>this.analysis,a=>this._onAnalysisChange(a),h.syncAndInitial)])};d.destroy=function(){this._analysisTargetsToConnection.forEach(a=>a.remove());this._handles=e.destroyMaybe(this._handles)};d.continue=function(){e.isSome(this.tool)&&this.tool.continue()};d.stop=function(){e.isSome(this.tool)&&this.tool.stop()};d.constructAnalysis=function(){return new t};d.onConnectToAnalysisView=async function(a){this._handles.add([a.on("result-changed",b=>{const c=
this._analysisTargetsToConnection.get(b.target);c&&(e.isSome(b.result)?(c.viewModelTarget.intersectedGraphic=b.result.intersectedGraphic,c.viewModelTarget.intersectedLocation=e.unwrap(b.result.intersectedLocation),c.viewModelTarget.visible=b.result.visible):(c.viewModelTarget.intersectedGraphic=null,c.viewModelTarget.intersectedLocation=null,c.viewModelTarget.visible=void 0))})],"view")};d.onDisconnectFromAnalysisView=function(){null!=this._handles&&this._handles.remove("view")};d._onViewModelTargetAdded=
function(a){if(!this._vmTargetsToConnection.get(a)){var b=new y({position:a.location});this._connectViewModelWithAnalysisTarget(a,b);this.analysis.targets.add(b)}};d._onViewModelTargetRemoved=function(a){if(a=this._vmTargetsToConnection.get(a))a.remove(),this.analysis.targets.remove(a.analysisTarget)};d._onAnalysisTargetAdded=function(a){if(!this._analysisTargetsToConnection.get(a)){var b=new v({location:e.applySome(a.position,c=>this._convertAnalysisPointToAbsoluteHeight(c,a.elevationInfo))});this._connectViewModelWithAnalysisTarget(b,
a);this.targets.add(b)}};d._onAnalysisTargetRemoved=function(a){if(a=this._analysisTargetsToConnection.get(a))a.remove(),this.targets.remove(a.viewModelTarget)};d._connectViewModelWithAnalysisTarget=function(a,b){let c=!1;const F=A.handlesGroup([h.watch(()=>({position:b.position,elevationInfo:b.elevationInfo}),({position:r,elevationInfo:g})=>{c||(c=!0,a.location=e.applySome(r,E=>this._convertAnalysisPointToAbsoluteHeight(E,g)),c=!1)},h.sync),h.watch(()=>a.location,r=>{c||(c=!0,b.position=e.applySome(r,
g=>{g=g.clone();g.hasZ||(g.z=0);return g}),b.elevationInfo=null,c=!1)},h.sync)]),w={analysisTarget:b,viewModelTarget:a,remove:()=>{F.remove();this._vmTargetsToConnection.delete(a);this._analysisTargetsToConnection.delete(b)}};this._vmTargetsToConnection.set(a,w);this._analysisTargetsToConnection.set(b,w)};d._onAnalysisChange=function(a){this._handles.remove("analysis");this._handles.add([this.analysis.targets.on("after-add",b=>this._onAnalysisTargetAdded(b.item)),this.analysis.targets.on("after-remove",
b=>this._onAnalysisTargetRemoved(b.item))],"analysis");this.targets.removeAll();a.targets.forEach(b=>{this._onAnalysisTargetAdded(b)})};d._convertAnalysisPointToAbsoluteHeight=function(a,b){const c=a.clone();e.isSome(this.view)&&(b=p.getEffectiveElevationInfo(a.hasZ,b),c.z=p.getConvertedElevation(this.view,a,b,p.absoluteHeightElevationInfo));return c};n._createClass(l,[{key:"state",get:function(){return this.disabled||!this.ready?"disabled":e.isNone(this.tool)?"ready":this.tool.state}},{key:"observer",
get:function(){const {observer:a}=this.analysis;return e.isNone(a)||e.isNone(a.position)?null:this._convertAnalysisPointToAbsoluteHeight(a.position,a.elevationInfo)},set:function(a){a=e.applySome(a,b=>{b=b.clone();b.hasZ||(b.z=0);return b});this.analysis.observer=new x({position:a})}},{key:"targets",get:function(){return this._get("targets")||new q},set:function(a){this._set("targets",u.referenceSetter(a,this.targets,q))}},{key:"testInfo",get:function(){return{analysisView:this.analysisView,getAnalysisTargetFromViewModelTarget:a=>
e.applySome(this._vmTargetsToConnection.get(a),b=>b.analysisTarget)}}}]);return l}(C.AnalysisViewModel);k.__decorate([m.property({type:t})],f.prototype,"analysis",void 0);k.__decorate([m.property({readOnly:!0})],f.prototype,"state",null);k.__decorate([m.property()],f.prototype,"observer",null);k.__decorate([m.property({type:q,cast:u.castForReferenceSetter,nonNullable:!0})],f.prototype,"targets",null);return f=k.__decorate([B.subclass("esri.widgets.lineOfSight.LineOfSightViewModel")],f)});