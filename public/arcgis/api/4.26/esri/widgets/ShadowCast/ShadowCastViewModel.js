// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Color ../../core/Accessor ../../core/asyncUtils ../../core/has ../../core/Handles ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/screenUtils ../../core/timeUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/accessorSupport/decorators/subclass ../../chunks/vec3f64 ../../views/3d/support/earthUtils ../../views/3d/support/sunUtils ../../views/3d/webgl-engine/shaders/ShadowCastVisualizeTechniqueConfiguration ./DiscreteOptions ./DurationMode ./DurationOptions ./ShadowCastState ./ShadowTooltipViewModel ./ShadowVisualizationType ./ThresholdOptions ../support/traversalUtils".split(" "),
function(u,d,v,c,G,T,H,f,z,m,A,q,e,U,V,I,J,K,L,w,B,M,C,x,N,p,D,O){function t(h,n){f.isSome(h)&&f.isSome(n)&&h.setParameters({shadowCastOptions:n})}function y(h){if(h.suspended)return!1;switch(h.type){case "building-scene-3d":case "csv-3d":case "elevation-3d":case "feature-3d":case "geojson-3d":case "graphics-3d":case "integrated-mesh-3d":case "ogc-feature-3d":case "route-3d":case "scene-layer-3d":case "scene-layer-graphics-3d":case "stream-3d":case "wms-3d":return!0;case "base-dynamic-3d":case "dimension-3d":case "imagery-3d":case "imagery-tile-3d":case "line-of-sight-3d":case "map-image-3d":case "point-cloud-3d":case "tile-3d":case "vector-tile-3d":case "voxel-3d":case "wfs-3d":case "wmts-3d":case "media-3d":return!1;
case "group":return h.layerViews.toArray().some(n=>y(n));default:return!1}}const E=[],P=J.create(),F=[],Q=q.convertTime(1,"hours","milliseconds");c=function(h){function n(a){var b=R.call(this,a);b.view=null;b.tooltip=new N.ShadowTooltipViewModel({getDuration:(g,l)=>b.getDuration(g,l)});b.startTimeOfDay=q.convertTime(10,"hours","milliseconds");b.endTimeOfDay=q.convertTime(16,"hours","milliseconds");b.visualizationType=p.ShadowVisualizationType.Threshold;b.thresholdOptions=new D;b.durationOptions=new C;
b.discreteOptions=new B;b._running=!0;b._handles=new H;b._stopPreviewingTask=null;b._forcePreview=!1;b._autoRestoreForcePreviewEnabled=!0;b._utcOffset=null;b.date=new Date;return b}u._inherits(n,h);var R=u._createSuper(n);h=n.prototype;h.initialize=function(){this._handles.add([m.watch(()=>({view:this.view,tooltipEnabled:this._tooltipEnabled}),({view:a,tooltipEnabled:b})=>{this.tooltip.view=a;this.tooltip.enabled=b},m.syncAndInitial),m.watch(()=>this._forcePreviewDependencies,()=>{f.abortMaybe(this._stopPreviewingTask);
this._forcePreview=!0;this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=G.createTask(async a=>{await z.after(500,a);z.throwIfAborted(a);this._forcePreview=!1}))},m.syncAndInitial),m.watch(()=>({renderer:this.renderer,parameters:this._visualizationParameters}),a=>t(a.renderer,a.parameters),m.syncAndInitial),m.watch(()=>({renderer:this.renderer,parameters:{lightDirections:this._lightDirections}}),a=>t(a.renderer,a.parameters),m.syncAndInitial),m.watch(()=>({renderer:this.renderer,parameters:{enabled:this._running}}),
a=>t(a.renderer,a.parameters),m.syncAndInitial),m.watch(()=>({renderer:this.renderer,parameters:{previewing:this._previewing}}),a=>t(a.renderer,a.parameters),m.syncAndInitial)])};h.destroy=function(){this.stop();this._handles=f.destroyMaybe(this._handles);f.destroyMaybe(this.tooltip)};h.start=function(){this._running=!0};h.stop=function(){this._running=!1};h.setRunning=function(a){this._running=a};h.getDuration=async function(a,b){const {view:g,renderer:l}=this;if(f.isNone(g)||f.isNone(l))return 0;
a=g.state.camera.screenToRender(A.createScreenPointArray(a.x,a.y),A.createRenderScreenPointArray());a=l.readAccumulatedShadow(a);b=this._sampleCount;return 0===b?0:this._duration/b*b*a};u._createClass(n,[{key:"state",get:function(){return f.isSome(this.view)&&this.view.ready&&f.isSome(this._referencePosition)?x.ShadowCastState.Ready:x.ShadowCastState.Disabled}},{key:"date",set:function(a){a=new Date(a);a.setHours(0,0,0,0);this._set("date",a)}},{key:"utcOffset",get:function(){return f.unwrapOr(this._utcOffset,
this._utcOffsetAuto)},set:function(a){this._utcOffset=a}},{key:"testData",get:function(){return{setAutoRestoreForcedPreviewEnabled:a=>{this._autoRestoreForcePreviewEnabled=a},setForcedPreview:a=>{this._forcePreview=a},isPreviewing:()=>this._previewing}}},{key:"_previewing",get:function(){const {view:a}=this;return f.isNone(a)||f.isNone(a.allLayerViews)?!0:this._forcePreview||!a.stationary||a.allLayerViews.some(b=>y(b)&&b.updating)}},{key:"_utcOffsetAuto",get:function(){return f.mapOr(this._referencePosition,
0,a=>K.longitudeToTimezone(a[0],!1))}},{key:"_dateUTCOffset",get:function(){let a=this.date;a=q.offsetDateUTC(a,-a.getTimezoneOffset(),"minutes");return a=q.offsetDateUTC(a,-this.utcOffset,"hours")}},{key:"_startDateTimeUTC",get:function(){return q.offsetDateUTC(this._dateUTCOffset,this.startTimeOfDay)}},{key:"_endDateTimeUTC",get:function(){return q.offsetDateUTC(this._dateUTCOffset,this.endTimeOfDay)}},{key:"_referencePosition",get:function(){return f.applySome(this.view,a=>f.applySome(a.environmentManager,
b=>b.referencePositionWGS84Comparable))}},{key:"_interval",get:function(){const a=0<this._duration?Math.floor(this._duration/255):255,b=this.discreteOptions.interval;switch(this.visualizationType){case p.ShadowVisualizationType.Threshold:case p.ShadowVisualizationType.Duration:return a;case p.ShadowVisualizationType.Discrete:return 0<b?b:a}}},{key:"_sampleCount",get:function(){return this._lightDirections.length}},{key:"_duration",get:function(){return this.endTimeOfDay-this.startTimeOfDay}},{key:"_lightDirections",
get:function(){var {view:a}=this;if(f.isNone(a))return E;var b="global"===a.viewingMode?P:this._referencePosition;if(f.isNone(b))return E;a=L.computeDirectionsOverTime(this._startDateTimeUTC,this._endDateTimeUTC,this._interval,b,a.state.viewingMode);b=a.length;F.length=0;const g=O.breadthFirstBinaryPartitioning(0,b,F),l=Array(b);for(let r=0;r<b;++r)l[r]=a[g[r]];return l}},{key:"_tooltipEnabled",get:function(){return this.state===x.ShadowCastState.Ready&&this.visualizationType!==p.ShadowVisualizationType.Discrete&&
this._running&&!this._previewing}},{key:"_visualizationParameters",get:function(){if(!this._running)return null;switch(this.visualizationType){case p.ShadowVisualizationType.Threshold:return this._thresholdVisualizationParameters;case p.ShadowVisualizationType.Duration:return this._durationVisualizationParameters;case p.ShadowVisualizationType.Discrete:return this._discreteVisualizationParameters}}},{key:"_thresholdVisualizationParameters",get:function(){const {value:a,color:b}=this.thresholdOptions,
g=this._duration;return{visualization:w.ShadowCastVisualization.Threshold,color:v.toUnitRGBA(b),threshold:0<g?a/this._duration:0}}},{key:"_durationVisualizationParameters",get:function(){const {color:a,mode:b}=this.durationOptions;var g=this._duration;g=0<g&&b===M.DurationMode.Hourly?Q/g:0;return{color:v.toUnitRGBA(a),visualization:w.ShadowCastVisualization.Gradient,bandsEnabled:0<g,bandSize:g}}},{key:"_discreteVisualizationParameters",get:function(){return{color:v.toUnitRGBA(this.discreteOptions.color),
visualization:w.ShadowCastVisualization.Gradient,bandsEnabled:!1,bandSize:0}}},{key:"_forcePreviewDependencies",get:function(){var {view:a}=this;if(f.isNone(a))return null;const b=a.slicePlane;var g=a.allLayerViews.toArray().filter(y),l=g.map(k=>k.layer).filter(f.isSome);a=g.map(k=>k.visible);const r=l.map(k=>k.visible),S=l.map(k=>k.opacity);l=l.filter(k=>"definitionExpression"in k).map(k=>k.definitionExpression);g=g.filter(k=>"filter"in k).map(k=>k.filter);return{slicePlane:b,startDateUTC:this._startDateTimeUTC,
endDateUTC:this._endDateTimeUTC,layerViewVisibilities:a,layerVisibilities:r,layerOpacities:S,filters:g,definitionExpressions:l}}},{key:"renderer",get:function(){var {view:a}=this;if(f.isNone(a))return null;a=a._stage;return f.isNone(a)?null:a.renderer}}]);return n}(c);d.__decorate([e.property()],c.prototype,"state",null);d.__decorate([e.property()],c.prototype,"view",void 0);d.__decorate([e.property()],c.prototype,"tooltip",void 0);d.__decorate([e.property({nonNullable:!0})],c.prototype,"date",null);
d.__decorate([e.property({nonNullable:!0})],c.prototype,"utcOffset",null);d.__decorate([e.property({nonNullable:!0})],c.prototype,"startTimeOfDay",void 0);d.__decorate([e.property({nonNullable:!0})],c.prototype,"endTimeOfDay",void 0);d.__decorate([e.property({nonNullable:!0})],c.prototype,"visualizationType",void 0);d.__decorate([e.property({type:D,nonNullable:!0})],c.prototype,"thresholdOptions",void 0);d.__decorate([e.property({type:C,nonNullable:!0})],c.prototype,"durationOptions",void 0);d.__decorate([e.property({type:B,
nonNullable:!0})],c.prototype,"discreteOptions",void 0);d.__decorate([e.property()],c.prototype,"_running",void 0);d.__decorate([e.property()],c.prototype,"_handles",void 0);d.__decorate([e.property()],c.prototype,"_stopPreviewingTask",void 0);d.__decorate([e.property()],c.prototype,"_forcePreview",void 0);d.__decorate([e.property()],c.prototype,"_autoRestoreForcePreviewEnabled",void 0);d.__decorate([e.property()],c.prototype,"_previewing",null);d.__decorate([e.property()],c.prototype,"_utcOffset",
void 0);d.__decorate([e.property()],c.prototype,"_utcOffsetAuto",null);d.__decorate([e.property()],c.prototype,"_dateUTCOffset",null);d.__decorate([e.property()],c.prototype,"_startDateTimeUTC",null);d.__decorate([e.property()],c.prototype,"_endDateTimeUTC",null);d.__decorate([e.property()],c.prototype,"_referencePosition",null);d.__decorate([e.property()],c.prototype,"_interval",null);d.__decorate([e.property()],c.prototype,"_sampleCount",null);d.__decorate([e.property()],c.prototype,"_duration",
null);d.__decorate([e.property()],c.prototype,"_lightDirections",null);d.__decorate([e.property()],c.prototype,"_tooltipEnabled",null);d.__decorate([e.property()],c.prototype,"_visualizationParameters",null);d.__decorate([e.property()],c.prototype,"_thresholdVisualizationParameters",null);d.__decorate([e.property()],c.prototype,"_durationVisualizationParameters",null);d.__decorate([e.property()],c.prototype,"_discreteVisualizationParameters",null);d.__decorate([e.property()],c.prototype,"_forcePreviewDependencies",
null);d.__decorate([e.property()],c.prototype,"renderer",null);return c=d.__decorate([I.subclass("esri.widgets.ShadowCast.ShadowCastViewModel")],c)});