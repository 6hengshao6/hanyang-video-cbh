// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Collection ../../core/HandleOwner ../../core/Handles ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Column ./Grid/Grid ./Grid/GridViewModel ./Grid/GroupColumn ./support/FeatureStore ../support/widgetUtils ../support/decorators/messageBundle ../../intl/locale ../../intl/messages".split(" "),
function(v,f,J,e,x,K,L,M,G,q,g,Y,Z,aa,N,O,P,C,Q,R,S,T,H,ba,I,U,D){e=function(d){function y(a){var b=V.call(this,a);b._debounceRefresh=G.debounce(()=>b._refresh());b._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"];b._highlights=new L;b.activeFilters=new x;b.autoRefreshEnabled=!0;b.cellClassNameGenerator=(k,m)=>k.path||null;b.columns=new x;b.dataProvider=async(k,m)=>{const {store:p}=v._assertThisInitialized(b),{page:w,pageSize:t,sortOrders:u}=k;k=b._sortOrdersToLayerOrderByFields(u);
m&&(p?(await p.set({orderByFields:k}),"loaded"!==p.state&&"loading"!==p.state&&await p.load(),m&&m(await p.fetchItems({page:w,pageSize:t}))):m&&m([]))};b.editingEnabled=!1;b.fieldConfigs=null;b.grid=null;b.highlightEnabled=!0;b.itemIdPath="objectId";b.messagesCommon=null;b.messagesURIUtils=null;b.relatedRecordsEnabled=!1;b.store=null;b.tableTemplate=null;b.view=null;const {hiddenFields:c,itemIdPath:l}=v._assertThisInitialized(b);c?.addMany(b._defaultHiddenFields);b._onLayerRefresh=b._onLayerRefresh.bind(v._assertThisInitialized(b));
b._set("store",new H);b._set("grid",new R({itemIdPath:l,viewModel:v._assertThisInitialized(b)}));return b}v._inherits(y,d);var V=v._createSuper(y);d=y.prototype;d.initialize=function(){const a=async()=>{this.messages=await D.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable");this.messagesCommon=await D.fetchMessageBundle("esri/t9n/common");this.messagesURIUtils=await D.fetchMessageBundle("esri/widgets/support/t9n/uriUtils")};a();this.handles.add([U.onLocaleChange(()=>{a();this._generateColumns()}),
q.on(()=>this.highlightIds,"change",b=>this._onHighlightIdsChange(b),{onListenerAdd:()=>{this.highlightIds.forEach(b=>this._highlight(b))},onListenerRemove:()=>{this.highlightIds.forEach(b=>this._unhighlight(b))}}),q.watch(()=>this.layerView,()=>{this._highlights.removeAll();this.layerView&&this.highlightEnabled&&this.highlightIds?.forEach(b=>this._highlight(b))}),q.watch(()=>this.highlightEnabled,()=>{this._highlights.removeAll();this.highlightEnabled&&this.highlightIds?.forEach(b=>this._highlight(b))}),
q.watch(()=>this.relatedRecordsEnabled,b=>this.store.relatedRecordsEnabled=b),q.watch(()=>this.layer?.loaded,b=>b&&this._onLayerLoad()),q.watch(()=>this.store.state,b=>{"loaded"===b&&this.grid?.scrollToTop()}),q.watch(()=>[this.messages,this.tableTemplate,this.fieldConfigs],()=>this.layer?.loaded&&this._generateColumns()),q.watch(()=>this.editingEnabled,b=>{this.columns.forEach(c=>{"editingEnabled"in c&&(c.editingEnabled=b)});this.grid?.onColumnChange()}),q.watch(()=>this.layer?.definitionExpression,
(b,c)=>(b||c)&&"loaded"===this.store.state&&this.reset()),q.watch(()=>this.layer&&"timeExtent"in this.layer&&this.layer.timeExtent,(b,c)=>(b||c)&&!this.timeExtent&&"loaded"===this.store.state&&this.reset()),q.on(()=>this.layer,"refresh",b=>this._onLayerRefresh(b))])};d.destroy=function(){this._resetColumns();this.handles.removeAll();this._highlights.removeAll();this._highlights.destroy();this.grid?.destroy();this.columns?.destroy();this.view=this.layer=null};d.clearHighlights=function(){this._highlights.removeAll()};
d.clearSelection=function(){this.grid?.clearSelection()};d.deleteSelection=async function(){var a=this.highlightIds.toArray();a?.length&&({deleteFeatureResults:a}=await this.store.deleteRowsByObjectId(a),a=a.filter(b=>!b.error).map(b=>b.objectId),a.length&&(this.deselectRows(a),await this.refresh()))};d.deselectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid?.deselectRows(a)};d.filterBySelection=function(){const a=this.highlightIds.toArray();a.length&&(this.clearSelectionFilter(),
this.store.objectIds=a,this.activeFilters.add({type:"selection",objectIds:a}))};d.getObjectIdIndex=function(a){return this.store?.getObjectIdIndex(a)};d.getValue=function(a,b){return this.store.getItemByObjectId(a)?.feature?.attributes[b]};d.refresh=async function(){return G.ignoreAbortErrors(this._debounceRefresh())};d.reset=function(){this.grid?.reset()};d.selectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);return this.grid?.selectRows(a)};d.scrollToIndex=function(a){this.grid?.scrollToIndex(a)};
d.clearSelectionFilter=function(){this.store.objectIds=null;const a=this.activeFilters.find(b=>"selection"===b.type);a&&this.activeFilters.remove(a)};d.zoomToSelection=function(){const {layer:a,view:b}=this,c=this.highlightIds.toArray();if(a&&b&&c.length){var l=a.createQuery();l.objectIds=c;l.returnGeometry=!0;a.queryFeatures(l).then(k=>{b.goTo(k.features).catch(m=>{"AbortError"!==m.name&&console.error(m)})})}};d._refresh=async function(){await this.store.refreshLayerInfo();const a=this.highlightIds.toArray();
a.length&&(await this.store.verifyFeaturesByObjectId(a)).forEach((b,c)=>{b||this.deselectRows(a[c])});this.grid?.refreshPageCache()};d._onLayerLoad=function(){const a=this.layer.capabilities?.query.maxRecordCount;a&&a<this.pageSize&&this.grid&&(this.grid.pageSize=a);this._generateColumns()};d._onLayerRefresh=function(a){this.autoRefreshEnabled&&a.dataChanged&&this.refresh()};d._generateColumns=function(){this._resetColumns();const a=[],b=this.tableTemplate?.columnTemplates?this._generateColumnsFromTemplates(this.tableTemplate.columnTemplates):
this.fieldConfigs?.length?this._generateColumnsFromConfigs():this._generateDefaultFieldColumns();a.push(...b);this.attachmentsEnabled&&a.push(this._generateDefaultAttachmentColumn());this.columns.addMany([...a])};d._generateColumnsFromTemplates=function(a){const {editingEnabled:b,grid:c,hiddenFields:l,layer:k,messages:m,messagesCommon:p,messagesURIUtils:w,store:t,tableTemplate:u}=this,n=this.layer?.fields??[];return a.filter(h=>(n||[]).find(r=>"fieldName"in h&&h.fieldName===r.name)||"group"===h.type&&
"columnTemplates"in h).map(h=>{if("fieldName"in h){var r=(n||[]).find(W=>h.fieldName===W.name),z=!1===h.visible||!0!==h.visible&&null!=r&&l.includes(r.name);const {direction:A,formatFunction:B,initialSortPriority:E,menuConfig:F,textAlign:X}=h;return new C({direction:A,editingEnabled:b,expressionInfos:u?.expressionInfos||null,field:r,formatFunction:B,grid:c,hidden:z,initialSortPriority:E,layer:k,messages:m,messagesCommon:p,messagesURIUtils:w,menuConfig:F,store:t,template:h,textAlign:X})}if("group"===
h.type&&"columnTemplates"in h){r=this._generateColumnsFromTemplates(h.columnTemplates);z=!1===h.visible||!0!==h.visible&&null!=h.label&&l.includes(h.label);const {label:A}=h;return new T({header:A,columns:r,hidden:z})}return new Q({...h})})};d._generateColumnsFromConfigs=function(){const {editingEnabled:a,fieldConfigs:b,grid:c,hiddenFields:l,layer:k,messages:m,messagesCommon:p,messagesURIUtils:w,store:t}=this;if(!b)return[];const u=this.layer?.fields??[];return b.filter(n=>(u||[]).find(h=>n.name===
h.name)).map(n=>{const h=n.direction||null,r=n.formatFunction||null,z=n.textAlign||null,A=M.isSome(n.initialSortPriority)?n.initialSortPriority:null,B=(u||[]).find(F=>n.name===F.name),E=!1===n.visible||!0!==n.visible&&null!=B&&l.includes(B.name);return new C({config:n,direction:h,editingEnabled:a,field:B,formatFunction:r,grid:c,hidden:E,layer:k,store:t,messages:m,messagesCommon:p,messagesURIUtils:w,menuConfig:n.menuConfig||null,textAlign:z,initialSortPriority:A})})};d._generateDefaultFieldColumns=
function(){const {editingEnabled:a,grid:b,hiddenFields:c,layer:l,messages:k,messagesCommon:m,messagesURIUtils:p,store:w}=this;return(this.layer?.fields??[]).map(t=>{const u=c.includes(t.name);return new C({editingEnabled:a,field:t,grid:b,hidden:u,layer:l,store:w,messages:k,messagesCommon:m,messagesURIUtils:p})})};d._generateDefaultAttachmentColumn=function(){return new P({header:this.messages?.attachments})};d._sortOrdersToLayerOrderByFields=function(a){return a&&a.length?a.filter((b,c,l)=>l.map(k=>
k.path).indexOf(b.path)===c).filter(({direction:b})=>!!b).map(({direction:b,path:c})=>c+" "+b?.toUpperCase()):[]};d._highlight=function(a){this.layerView&&O.highlightsSupported(this.layerView)&&this._highlights.add(this.layerView.highlight(a),a)};d._unhighlight=function(a){this._highlights.remove(a)};d._getStoreItemsFromSelectionParams=function(a){const b=[];a=a instanceof Array?a:[a];a.forEach(c=>{let l=c instanceof J?c:null;c=l?l.getObjectId():c;if("number"===typeof c||"string"===typeof c){if(!l){const k=
this.store.getItemByObjectId(c);k&&(l=k.feature)}b.push({objectId:c,feature:l})}});return b};d._onHighlightIdsChange=function(a){const {highlightEnabled:b}=this,{added:c,removed:l}=a;b&&(c.forEach(k=>this._highlight(k)),l.forEach(k=>this._unhighlight(k)))};d._resetColumns=function(){this.columns.items.forEach(a=>a.destroy());this.columns.removeAll()};v._createClass(y,[{key:"activeSortOrders",get:function(){return this.grid?.sortOrders?this.grid.sortOrders.map(({path:a,direction:b})=>({fieldName:a,
direction:b})):[]}},{key:"attachmentsEnabled",set:function(a){this.attachmentsEnabled!==a&&(this._set("attachmentsEnabled",a),this._generateColumns(),this.store.attachmentsEnabled=a)}},{key:"filterGeometry",set:function(a){if(this.filterGeometry||a){var b=this.activeFilters.find(c=>"geometry"===c.type);b&&this.activeFilters.remove(b);this._set("filterGeometry",a);(this.store.filterGeometry=a)&&this.activeFilters.add({type:"geometry",geometry:a})}}},{key:"hiddenFields",get:function(){return this._get("hiddenFields")||
new x},set:function(a){Array.isArray(a)?this._set("hiddenFields",new x(a)):this._set("hiddenFields",a)}},{key:"highlightOnRowSelectEnabled",get:function(){return this.highlightEnabled},set:function(a){this.highlightEnabled=a}},{key:"layer",set:function(a){this._set("layer",a);this.grid?.clearSort();this._resetColumns();(this.store.layer=a)&&(a.loaded?this._onLayerLoad():a.load());this.notifyChange("state")}},{key:"layerView",get:function(){return this.view?.allLayerViews.find(a=>a.layer===this.layer)||
null}},{key:"messages",set:function(a){this.grid?.set("messages",a);this._set("messages",a)}},{key:"state",get:function(){const {store:a}=this;return a&&"disabled"!==a.state?"loading"===a.state?"loading":"loaded"===a.state?"loaded":"ready":"disabled"}},{key:"timeExtent",set:function(a){this._set("timeExtent",a);this.store.timeExtent=a}},{key:"highlightIds",get:function(){return this._get("highlightIds")||new x},set:function(a){Array.isArray(a)?this._set("highlightIds",new x(a)):this._set("highlightIds",
a)}}]);return y}(K.HandleOwnerMixin(S));f.__decorate([g.property({readOnly:!0})],e.prototype,"activeFilters",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"activeSortOrders",null);f.__decorate([g.property()],e.prototype,"attachmentsEnabled",null);f.__decorate([g.property()],e.prototype,"autoRefreshEnabled",void 0);f.__decorate([g.property()],e.prototype,"cellClassNameGenerator",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"columns",void 0);f.__decorate([g.property()],
e.prototype,"dataProvider",void 0);f.__decorate([g.property()],e.prototype,"editingEnabled",void 0);f.__decorate([g.property()],e.prototype,"fieldConfigs",void 0);f.__decorate([g.property()],e.prototype,"filterGeometry",null);f.__decorate([g.property({readOnly:!0})],e.prototype,"grid",void 0);f.__decorate([g.property()],e.prototype,"hiddenFields",null);f.__decorate([g.property()],e.prototype,"highlightEnabled",void 0);f.__decorate([g.property()],e.prototype,"highlightOnRowSelectEnabled",null);f.__decorate([g.property({readOnly:!0})],
e.prototype,"itemIdPath",void 0);f.__decorate([g.property()],e.prototype,"layer",null);f.__decorate([g.property()],e.prototype,"layerView",null);f.__decorate([g.property()],e.prototype,"messages",null);f.__decorate([g.property(),I.messageBundle("esri/t9n/common")],e.prototype,"messagesCommon",void 0);f.__decorate([g.property(),I.messageBundle("esri/widgets/support/t9n/uriUtils")],e.prototype,"messagesURIUtils",void 0);f.__decorate([g.property()],e.prototype,"relatedRecordsEnabled",void 0);f.__decorate([g.property({readOnly:!0})],
e.prototype,"state",null);f.__decorate([g.property({readOnly:!0,type:H})],e.prototype,"store",void 0);f.__decorate([g.property()],e.prototype,"tableTemplate",void 0);f.__decorate([g.property()],e.prototype,"timeExtent",null);f.__decorate([g.property()],e.prototype,"view",void 0);f.__decorate([g.property()],e.prototype,"highlightIds",null);return e=f.__decorate([N.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],e)});