// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/Point ../../networks/support/utils ../../rest/networks/trace ../../rest/networks/support/TraceLocation ../../rest/networks/support/TraceParameters ./support/GeometryHandler ./support/GraphicHandler".split(" "),
function(r,l,v,w,k,x,y,z,A,m,J,K,L,B,C,t,D,u,E,F,G){k=function(g){function n(a){a=H.call(this,a);a._activeProgress=!1;a._clickHandler=null;a._flags=[];a._geometryHandler=null;a._graphicHandler=null;a._highlightHandler=[];a._traces=[];a._traceResults=[];a._unObject=null;a._watchHandler=null;a.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"};a.flags=[];a.gdbVersion="sde.DEFAULT";a.selectedTraces=[];a.selectOnComplete=!0;a.showGraphicsOnComplete=!0;a.showSelectionAttributes=
!0;return a}r._inherits(n,g);var H=r._createSuper(n);g=n.prototype;g.initialize=function(){this._geometryHandler=new F.GeometryHandler;this._graphicHandler=new G.GraphicHandler};g.destroy=function(){this.view=null};g.addFlagByHit=function(a,b){const c=d=>{const e=this.view?.popup;e&&(e.autoOpenEnabled=d)};return new Promise((d,e)=>{c(!1);this._clickHandler?.remove();this.emit("add-flag",{type:a});this._clickHandler=this.view?.on("click",f=>{this.queryFlagByHitTest(f,a,b).then(h=>{c(!0);this._clickHandler?.remove();
this.emit("add-flag-complete",{type:a,symbol:b});d(h)}).catch(h=>{c(!0);this._clickHandler?.remove();this.emit("add-flag-error",{type:a,symbol:b});e(h)})})})};g.addFlagsOnLoad=async function(){return new Promise(a=>{const b=[];this._watchHandler=A.when(()=>null!=this.view&&!this.view.updating,async()=>{if(!(0<this._flags.length)){const c=this.flags.map(async d=>{if(d.mapPoint){var e=new C({x:d.mapPoint.x,y:d.mapPoint.y,spatialReference:d.mapPoint.spatialReference.wkid});e={screenPoint:this.view.toScreen(e),
mapPoint:e};await this.queryFlagByHitTest(e,d.type)||("barrier"===d.type?b.push("barrier"):b.push("starting-point"))}});await Promise.all(c)}a(b)},{initial:!0})})};g.addResultGraphicToView=async function(a,b){const {view:c}=this,{results:d}=a;if(c&&d)for(const f in d.aggregatedGeometry)if("line,multipoint,polygon".includes(f)&&null!==d.aggregatedGeometry[f]){d.aggregatedGeometry[f].spatialReference=this._unObject.spatialReference;a.graphicEnabled=!0;var e=await this._geometryHandler.projectGeometry(d.aggregatedGeometry[f],
c.spatialReference);const h={globalid:a.trace.globalId};null!==e&&(e=this._graphicHandler.makeGraphic(e,b.color,h,c.spatialReference),c.graphics.add(e))}};g.addTerminal=function(a,b){const c=[...this._flags];c.forEach(d=>{d.globalId===b.globalId&&(b.selectedTerminals?.includes(parseInt(a,10))||d.selectedTerminals?.push(parseInt(a,10)))});this._flags=c};g.callTrace=async function(){const a=this._traces.filter(b=>b.selected);return 0<a.length?(0<this._traceResults.length&&this._traceResults.forEach(b=>
{this.removeResultGraphicFromView(b)}),this._traceResults=[],this.removeSelection(),await Promise.all(a.map(async(b,c)=>{const d=new E({gdbVersion:this.gdbVersion,moment:null,traceType:b.traceType,traceLocations:this._flags,namedTraceConfigurationGlobalId:b.globalId,traceConfiguration:null,outSpatialReference:null,resultTypes:null});await this.executeTrace(b,this._unObject.networkServiceUrl,d).then(e=>{if(e.hasOwnProperty("results")){var f={...e};if(null!==f.results){e=[...f.results.elements];f.results.elements.length=
0;const h=new Map;for(const p of e)h.has(p.globalId)||(h.set(p.globalId,!0),f.results.elements.push(p));e=[...this._traceResults];e.splice(c,0,f);this._traceResults=e;null!==f.results&&(this.selectOnComplete&&this.mergeSelection(!0,f.trace),this.showGraphicsOnComplete&&this.addResultGraphicToView(f,f.graphicColor))}else f=[...this._traceResults],f.splice(c,0,e),this._traceResults=f;this._activeProgress=!1}else this._activeProgress=!1,f=[...this._traceResults],f.splice(c,0,e),this._traceResults=f}).catch(e=>
{this._activeProgress=!1;throw e;})})),!0):!1};g.changeResultGraphicColor=function(a,b){const c=[...this._traceResults];0<c.length&&c.forEach(d=>{d.trace.globalId===b.trace.globalId&&(d.graphicColor=a,d.graphicEnabled=!0)});this._traceResults=c;this.removeResultGraphicFromView(b);this.addResultGraphicToView(b,a)};g.changeFlagSymbol=function(a,b){0<this._flags.length&&this._flags.forEach(c=>{c.type===a&&b&&c.mapGraphic&&(c.mapGraphic.symbol=b)})};g.checkCanTrace=function(){const a={status:!0,issues:[]};
let b=!1;const c=this._flags.some(e=>"starting-point"===e.type);var d=this._flags.filter(e=>null!==e.allTerminals);0<d.length&&(b=d.some(e=>0>=e.selectedTerminals.length));d=[];c?(d=this._traces.filter(e=>e.selected),0>=d.length?(a.status=!1,a.issues=["noTrace"],b&&(a.status=!1,a.issues=["noTrace","noTerminalSelected"])):b&&(a.status=!1,a.issues=["noTerminalSelected"])):(d=this._traces.filter(e=>!0===e.selected),0<d.length?(a.status=!1,a.issues=["noStart"],b&&(a.status=!1,a.issues=["noStart","noTerminalSelected"])):
(a.status=!1,a.issues=["noStart","noTrace"],b&&(a.status=!1,a.issues=["noStart","noTrace","noTerminalSelected"])));return a};g.checkSelectionExist=function(){let a=!1;this._highlightHandler.some(b=>{b&&(a=!0)});return a};g.clearResult=function(a){let b=this._traceResults;if(0<b.length){const c=b.filter(d=>d.trace.globalId===a.globalId);0<c.length&&this.removeResultGraphicFromView(c[0]);b=b.filter(d=>d.trace.globalId!==a.globalId)}this._traceResults=b;0===b.length?(this.removeSelection(),this.emit("clear-selection",
{resultSet:[]})):this.mergeSelection(!1,a)};g.executeTrace=function(a,b,c){const d=this._processFlags(c.traceLocations);c.traceLocations=d;return D.trace(b,c).then(e=>({trace:a,results:e,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success"})).catch(e=>({trace:a,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:e.message}))};g.getValidSources=function(){let a=[];const b=this._unObject.dataElement?.domainNetworks??
[];for(const c of b)a=a.concat(c.junctionSources),a=a.concat(c.edgeSources);return a};g.loadUtilityNetwork=async function(){var {view:a}=this;if(!a)return null;await a.when();a=a.map;if(a.utilityNetworks?.length){const b=a.utilityNetworks.getItemAt(0);await b.load();this._unObject=b;try{await a.loadAll(),this._populateOutfields()}catch(c){this._populateOutfields()}return b}return null};g.manageFilterBarrier=function(a,b){const c=[...this._flags];c.forEach(d=>{d.globalId===b.globalId&&"barrier"===
b.type&&d.id===b.id&&(d.isFilterBarrier=a)});this._flags=c};g.mergeSelection=function(a,b){let c=[];const d=[...this._traceResults],e=b.globalId;d.forEach(f=>{e===f.trace.globalId&&(f.selectionEnabled=a);f.selectionEnabled&&null!=f.results&&null!==f.results.elements&&(c=[...c,...(f.results.elements??[])])});this.selectResults([...(new Set(c))])};g.queryFeaturesById=async function(a){const {view:b}=this;if(!b)return null;const c=t.getObjectIdsFromElements(this._unObject,a);a=this._getUniqueMapLayerViews(b);
const d={layerUrl:c[0].layerUrl,objectIds:c[0].objectIds,outFields:["*"]};a=a.filter(e=>e.layer?.parsedUrl?.path===c[0].layerUrl);return 0<a.length&&(a=(await Promise.all(a.map(async e=>{const f=new v;f.add(e.layer);return(await t.getFeaturesFromLayers({layers:f,layerInfos:[d],returnGeometry:!0,outSpatialReference:b.spatialReference}))[0]}))).filter(e=>0<e.featureSet.features.length),0<a.length)?a:null};g.queryFlagByHitTest=function(a,b,c){return this._lookupFlagByHit(a).then(d=>{const {view:e}=this;
if(!e)return!1;if(0<d.length){const f=[...this._flags];d.forEach(h=>{h=h.graphic;const p=h.attributes.hasOwnProperty("GLOBALID")?h.attributes.GLOBALID:h.attributes.globalid;if(0>=f.filter(I=>I.globalId===p).length){var q=this._graphicHandler.getFlagGraphic(h.mapPoint,b,h,c);e.graphics.add(q);f.push({...h,type:b,globalId:h.attributes.globalid||h.attributes.GLOBALID,details:h,mapGraphic:q,id:f.length+1})}else null!==h.percentAlong&&(q=this._graphicHandler.getFlagGraphic(h.mapPoint,b,h,c),e.graphics.add(q),
f.push({...h,type:b,globalId:h.attributes.globalid||h.attributes.GLOBALID,details:h,mapGraphic:q,id:f.length+1}))});this._flags=f;return!0}return!1})};g.removeResultGraphicFromView=function(a){const {view:b}=this;if(b){var c=b.graphics;a.graphicEnabled=!1;c.filter(d=>d.attributes[d.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===a.trace.globalId).forEach(d=>{b.graphics.remove(d)})}};g.removeFlag=function(a){const b=this._flags.filter(c=>{if(c.id!==a.id)return c});this._removeGraphic(a);
this._flags=b};g.removeSelection=function(){this._highlightHandler.forEach(a=>{a&&a.remove()});this._highlightHandler=[]};g.removeTerminal=function(a,b){const c=[...this._flags];c.forEach(d=>{if(d.globalId===b.globalId&&b.selectedTerminals?.includes(parseInt(a,10))){const e=b.selectedTerminals.indexOf(parseInt(a,10));d.selectedTerminals?.splice(e,1)}});this._flags=c};g.removeFlagsOnLoadWatcher=function(){this._watchHandler&&null!==this._watchHandler&&this._watchHandler.remove()};g.reset=function(){this._flags=
[];this._traceResults=[];const a=[...this._traces];a.forEach(b=>{b.selected=!1});this._traces=a;this.view&&(this.view.graphics.removeAll(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}))};g.selectFeaturesById=function(a){const {view:b}=this;if(b){var c=t.getObjectIdsFromElements(this._unObject,a);this._getUniqueMapLayerViews(b).forEach(d=>{d.layer?.parsedUrl?.path===c[0].layerUrl&&this._highlightHandler.push(d.highlight(c[0].objectIds))})}};g.selectResults=function(a){if(0<a.length){this.removeSelection();
a=this._groupResultsByNetworkSource(a);const b=[];for(const c in a)this.selectFeaturesById(a[c]),b.push(this.queryFeaturesById(a[c]));Promise.all(b).then(c=>{this.emit("select-features",{resultSet:c})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})};g.selectTraces=function(a,b){const c=[...this._traces];c.forEach(d=>{b===d.globalId&&(d.selected=a)});this._traces=c};g.selectTracesOnLoad=function(){this._unObject.hasOwnProperty("sharedNamedTraceConfigurations")&&(this._traces=
[...this._unObject.sharedNamedTraceConfigurations],this._traces.forEach(a=>{a.selected=!1;this.selectedTraces.includes(a.globalId)&&(a.selected=!0)}))};g.zoomToAsset=function(a){this.view?.goTo(a).catch(b=>console.error(b))};g._getUniqueMapLayerViews=function(a){const b=[];a.layerViews.filter(c=>"feature"===c.layer.type||"group"===c.layer.type).forEach(c=>{"group"===c.type?c.layerViews.forEach(d=>{b.push(d)}):b.some(d=>d.layer.layerId===c.layer.layerId)||b.push(c)});return b};g._processFlags=function(a){const b=
[];a.forEach(c=>{if(null!==c.selectedTerminals&&0<c.selectedTerminals.length)c.selectedTerminals.forEach(d=>{d=new u({globalId:c.globalId,percentAlong:c.percentAlong,terminalId:d,type:c.type,isFilterBarrier:c.isFilterBarrier});b.push(d)});else{const d=new u({globalId:c.globalId,percentAlong:c.percentAlong,terminalId:null,type:c.type,isFilterBarrier:c.isFilterBarrier});b.push(d)}});return b};g._getDisplayField=function(a){const b=a.layer;let c=b.displayField;var d="";for(const e in a.attributes){const f=
e.toLowerCase();f===c?.toLowerCase()&&(d=a.attributes[e],"assetgroup"===f||"assettype"===f?((d=a.attributes[b.typeIdField.toUpperCase()])||(d=a.attributes[b.typeIdField.toLowerCase()]),c=b.typeIdField,d=this._checkSubtype(b,d),""===c&&(b.templates&&0<b.templates.length?(c=b.templates[0]?.name,d=b.templates[0]?.name):(c=b.displayField,d=a.attributes[e]))):d=this._checkDomain(b.fields,e,d))}return{field:c,value:d}};g._checkSubtype=function(a,b){let c=b;null!==a.types&&0<a.types.length&&(a=a.types.filter(d=>
d.id===b),0<a.length&&(c=a[0].name));return c};g._checkDomain=function(a,b,c){let d=c;a=a.filter(e=>e.name.toLowerCase()===b.toLowerCase());0<a.length&&null!==a[0].domain&&(a=a[0].domain.codedValues.filter(e=>e.code===c),0<a.length&&(d=a[0].name));return d};g._groupBy=function(a,b){return a.reduce((c,d)=>{(c[d[b]]=c[d[b]]||[]).push(d);return c},{})};g._groupResultsByNetworkSource=function(a){return 0<a.length?a[0].hasOwnProperty("results")?this._groupBy(a[0].results.elements,"networkSourceId"):this._groupBy(a,
"networkSourceId"):a.hasOwnProperty("results")?this._groupBy(a.results.elements,"networkSourceId"):[]};g._lookupFlagByHit=function(a){return this.view.hitTest(a.screenPoint).then(b=>{const c=[];if(0<b.results.length&&(b=b.results.find(f=>null!==f.layer),b.graphic&&z.isSome(b.graphic.geometry)))if("polyline"===b.graphic.geometry.type){var d=this._geometryHandler.getPercentageAlong(b.graphic.geometry,a.mapPoint,b.graphic.geometry.spatialReference),e=this._getDisplayField(b.graphic);b.graphic.terminalId=
null;b.graphic.isFilterBarrier=!1;b.graphic.allTerminals=null;b.graphic.selectedTerminals=null;b.graphic.percentAlong=d;b.graphic.displayValue=e;b.graphic.mapPoint=b.mapPoint;c.push(b)}else"point"!==b.graphic.geometry.type&&"polygon"!==b.graphic.geometry.type||null===this._unObject||(d=this._unObject.getTerminalConfiguration(b.graphic),e=this._getDisplayField(b.graphic),b.graphic.terminalId=d?d.terminals[0].id||null:1,b.graphic.isFilterBarrier=!1,b.graphic.allTerminals=d??null,b.graphic.selectedTerminals=
[d?d.terminals[0].id||null:1],b.graphic.percentAlong=null,b.graphic.displayValue=e,b.graphic.mapPoint=b.mapPoint,c.push(b));return c})};g._populateOutfields=async function(){const a=this.view?.map,b=this.getValidSources();a?.layers.forEach(c=>{"group"===c.type?c.layers.forEach(d=>{b.some(e=>e.layerId===d.layerId)&&d.fields.some(e=>"assetgroup"===e.name.toLowerCase())&&(d.outFields=["assetgroup","assettype","globalid","objectid"])}):b.some(d=>d.layerId===c.layerId)&&c.fields.some(d=>"assetgroup"===
d.name.toLowerCase())&&(c.outFields=["assetgroup","assettype","globalid","objectid"])})};g._removeGraphic=function(a){this.view?.graphics.remove(a.mapGraphic)};r._createClass(n,[{key:"state",get:function(){return this.view?.ready?"ready":"loading"}},{key:"view",get:function(){return this._get("view")},set:function(a){a&&"2d"!==a.type&&y.getLogger(this.declaredClass).error(new w("view:invalid-view","SceneView is not supported",{view:a}));this._set("view",a)}}]);return n}(x.HandleOwnerMixin(k.EventedAccessor));
l.__decorate([m.property()],k.prototype,"_activeProgress",void 0);l.__decorate([m.property()],k.prototype,"_flags",void 0);l.__decorate([m.property()],k.prototype,"_traces",void 0);l.__decorate([m.property()],k.prototype,"_traceResults",void 0);l.__decorate([m.property()],k.prototype,"defaultGraphicColor",void 0);l.__decorate([m.property()],k.prototype,"flags",void 0);l.__decorate([m.property()],k.prototype,"gdbVersion",void 0);l.__decorate([m.property()],k.prototype,"selectedTraces",void 0);l.__decorate([m.property()],
k.prototype,"selectOnComplete",void 0);l.__decorate([m.property()],k.prototype,"showGraphicsOnComplete",void 0);l.__decorate([m.property()],k.prototype,"showSelectionAttributes",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"state",null);l.__decorate([m.property({value:null})],k.prototype,"view",null);return k=l.__decorate([B.subclass("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],k)});