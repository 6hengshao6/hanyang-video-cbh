// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/Clonable ../../../core/Collection ../../../core/HandleOwner ../../../core/Identifiable ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/throttle ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/arrayUtils ../../../core/has ../../../core/accessorSupport/decorators/subclass ../../../rest/support/RelationshipQuery ../support/featureUtils".split(" "),
function(h,e,F,d,G,A,H,I,t,u,q,v,f,Q,R,S,J,B,C){d=function(k){function n(c){var a=K.call(this,c);a._queryAbortController=null;a._queryPageAbortController=null;a._queryFeatureCountAbortController=null;a.featuresPerPage=10;a.description=null;a.graphic=null;a.layer=null;a.map=null;a.orderByFields=null;a.featureCount=0;a.relationshipId=null;a.showAllEnabled=!1;a.title=null;a._cancelQuery=()=>{const {_queryAbortController:b}=h._assertThisInitialized(a);b&&b.abort();a._queryAbortController=null};a._cancelQueryFeatureCount=
()=>{const {_queryFeatureCountAbortController:b}=h._assertThisInitialized(a);b&&b.abort();a._queryFeatureCountAbortController=null};a._cancelQueryPage=()=>{const {_queryPageAbortController:b}=h._assertThisInitialized(a);b&&b.abort();a._queryPageAbortController=null};a._queryController=async()=>{a._cancelQuery();const b=new AbortController;a._queryAbortController=b;await u.ignoreAbortErrors(a._query());a._queryAbortController===b&&(a._queryAbortController=null)};a._queryFeatureCountController=async()=>
{a._cancelQueryFeatureCount();const b=new AbortController;a._queryFeatureCountAbortController=b;await u.ignoreAbortErrors(a._queryFeatureCount());a._queryFeatureCountAbortController===b&&(a._queryFeatureCountAbortController=null)};a._queryPageController=async()=>{const b=new AbortController;a._queryPageAbortController=b;await u.ignoreAbortErrors(a._queryPage());a._queryPageAbortController===b&&(a._queryPageAbortController=null)};a._queryThrottled=v.throttle(a._queryController,100,h._assertThisInitialized(a));
a._queryFeatureCountThrottled=v.throttle(a._queryFeatureCountController,100,h._assertThisInitialized(a));a._queryPageThrottled=v.throttle(a._queryPageController,100,h._assertThisInitialized(a));a._query=async()=>{const {_queryAbortController:b,relatedFeatures:g}=h._assertThisInitialized(a);a._destroyRelatedFeatureViewModels();a.featurePage=1;g.removeAll();g.addMany(a._sliceFeatures(await a._queryRelatedFeatures({signal:b?.signal})))};a.handles.add([q.watch(()=>[a.displayCount,a.graphic,a.layer,a.map,
a.orderByFieldsFixedCasing,a.relationshipId,a.featuresPerPage,a.showAllEnabled,a.canQuery,a.featureCount],()=>a._queryThrottled(),q.initial),q.watch(()=>[a.featurePage,a.showAllEnabled],()=>a._queryPageThrottled()),q.watch(()=>[a.layer,a.relationshipId,a.objectId,a.canQuery],()=>a._queryFeatureCountThrottled())]);return a}h._inherits(n,k);var K=h._createSuper(n);k=n.prototype;k.destroy=function(){this._destroyRelatedFeatureViewModels();this.relatedFeatures.removeAll();this._cancelQuery();this._cancelQueryFeatureCount();
this._cancelQueryPage()};k._destroyRelatedFeatureViewModels=function(){this.relatedFeatureViewModels?.forEach(c=>!c.destroyed&&c.destroy());this.relatedFeatureViewModels.removeAll()};k._queryFeatureCount=async function(){const {layer:c,relatedLayer:a,relationshipId:b,objectId:g,_queryFeatureCountAbortController:w,canQuery:r,supportsCacheHint:x}=this;await c?.load();await a?.load();if(r&&c&&a){var l=a.createQuery();l=new B({cacheHint:x,relationshipId:b,returnGeometry:!1,objectIds:[g],where:t.unwrapOrValue(l.where,
void 0)});l=await c.queryRelatedFeaturesCount(l,{signal:w?.signal});this._set("featureCount",l[g]||0)}else this._set("featureCount",0)};k._sliceFeatures=function(c){const {showAllEnabled:a,displayCount:b}=this;return a?c:b?c.slice(0,b):[]};k._queryPage=async function(){const {relatedFeatures:c,featurePage:a,showAllEnabled:b,_queryPageAbortController:g}=this;!b||2>a||c.addMany(await this._queryRelatedFeatures({signal:g?.signal}))};k._queryRelatedFeatures=async function(c){const {orderByFieldsFixedCasing:a,
showAllEnabled:b,featuresPerPage:g,displayCount:w,layer:r,relationshipId:x,featurePage:l,featureCount:D,relatedLayer:p,supportsCacheHint:L}=this,{canQuery:M,objectId:E}=this;if(!M||!r||!p)return[];var y=b?((l-1)*g+D)%D:0;const N=b?g:w;var z=p.objectIdField;z=[...a.map(m=>m.field),z].filter(t.isSome);const O=a.map(m=>`${m.field} ${m.order}`),P=p.createQuery();y=new B({orderByFields:O,start:y,num:N,outFields:z,cacheHint:L,relationshipId:x,returnGeometry:!1,objectIds:[E],where:t.unwrapOrValue(P.where,
void 0)});c=(await r.queryRelatedFeatures(y,{signal:c?.signal}))[E]?.features||[];c.forEach(m=>{m.sourceLayer=p;m.layer=p});return c};h._createClass(n,[{key:"featurePage",get:function(){return this._get("featurePage")},set:function(c){const {featuresPerPage:a,featureCount:b}=this;this._set("featurePage",Math.min(Math.max(c,1),Math.ceil(b/a)||1))}},{key:"orderByFieldsFixedCasing",get:function(){const {orderByFields:c,relatedLayer:a}=this;return c&&a?.loaded?c.map(b=>{const g=b.clone();g.field=C.getFixedFieldName(b.field,
a);return g}):c??[]}},{key:"supportsCacheHint",get:function(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}},{key:"canQuery",get:function(){const c=this.layer?.capabilities?.queryRelated;return!!this.relatedLayer&&!!this.relationship&&"number"===typeof this.relationshipId&&"number"===typeof this.objectId&&!!c?.supportsCount&&!!c?.supportsPagination}},{key:"itemDescriptionFieldName",get:function(){return this.orderByFieldsFixedCasing[0]?.field||null}},{key:"displayCount",get:function(){return this._get("displayCount")},
set:function(c){this._set("displayCount",Math.min(Math.max(c,0),10))}},{key:"objectId",get:function(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}},{key:"objectIdField",get:function(){return this.layer?.objectIdField||null}},{key:"relatedFeatures",get:function(){return this._get("relatedFeatures")||new A}},{key:"relatedLayer",get:function(){const {layer:c,map:a,relationship:b}=this;return c?.loaded&&a&&b?C.findRelatedLayer(a,c,b)??null:null}},{key:"relationship",
get:function(){const {relationshipId:c,layer:a}=this;return"number"===typeof c?a?.relationships?.find(({id:b})=>b===c)??null:null}},{key:"relatedFeatureViewModels",get:function(){return this._get("relatedFeatureViewModels")||new A}},{key:"state",get:function(){const {_queryAbortController:c,_queryFeatureCountAbortController:a,_queryPageAbortController:b,canQuery:g}=this;return a?"loading":c||b?"querying":g?"ready":"disabled"}}]);return n}(G.ClonableMixin(I.IdentifiableMixin(H.HandleOwnerMixin(d))));
e.__decorate([f.property()],d.prototype,"_queryAbortController",void 0);e.__decorate([f.property()],d.prototype,"_queryPageAbortController",void 0);e.__decorate([f.property()],d.prototype,"_queryFeatureCountAbortController",void 0);e.__decorate([f.property({value:1})],d.prototype,"featurePage",null);e.__decorate([f.property()],d.prototype,"featuresPerPage",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"orderByFieldsFixedCasing",null);e.__decorate([f.property({readOnly:!0})],d.prototype,
"supportsCacheHint",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"canQuery",null);e.__decorate([f.property()],d.prototype,"description",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"itemDescriptionFieldName",null);e.__decorate([f.property({value:3})],d.prototype,"displayCount",null);e.__decorate([f.property({type:F})],d.prototype,"graphic",void 0);e.__decorate([f.property()],d.prototype,"layer",void 0);e.__decorate([f.property()],d.prototype,"map",void 0);e.__decorate([f.property({readOnly:!0})],
d.prototype,"objectId",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"objectIdField",null);e.__decorate([f.property()],d.prototype,"orderByFields",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,"relatedFeatures",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"relatedLayer",null);e.__decorate([f.property({readOnly:!0})],d.prototype,"relationship",null);e.__decorate([f.property()],d.prototype,"featureCount",void 0);e.__decorate([f.property({readOnly:!0})],d.prototype,
"relatedFeatureViewModels",null);e.__decorate([f.property()],d.prototype,"relationshipId",void 0);e.__decorate([f.property()],d.prototype,"showAllEnabled",void 0);e.__decorate([f.property()],d.prototype,"state",null);e.__decorate([f.property()],d.prototype,"title",void 0);return d=e.__decorate([J.subclass("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],d)});