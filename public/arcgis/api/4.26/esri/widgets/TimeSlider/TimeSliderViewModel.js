// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../TimeExtent ../../TimeInterval ../../core/Collection ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/timeUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/TimeSlider".split(" "),
function(G,z,h,n,H,B,g,I,J,c,C,t,K,l,D,P,Q,L,M,N){function A(d){return c.isSome(d)&&void 0!==d.count}function x(d){return c.isSome(d)&&void 0!==d.interval}function E(d){return c.isSome(d)&&void 0!==d.dates}function F(d){return null!=d&&"object"===typeof d&&"declaredClass"in d&&"esri.WebMap"===d.declaredClass}g=function(d){function v(a){a=O.call(this,a);a._animationController=null;a._isViewTimeExtentInitialized=!1;a._timerId=null;a.actions=new B;a.fullTimeExtent=null;a.loop=!1;a.mode="time-window";
a.stops={count:10};a.timeExtent=null;a.view=null;return a}z._inherits(v,d);var O=z._createSuper(v);d=v.prototype;d.initialize=function(){this.handles.add([t.watch(()=>this.effectiveStops,()=>{c.isNone(this.timeExtent)&&(this.timeExtent=this._getDefaultTimeExtent())},t.initial),t.watch(()=>this.view,(a,b)=>{this._unregisterWidget(b);this._registerWidget(a)},t.syncAndInitial),t.watch(()=>this.timeExtent,a=>{if(!c.isNone(this.view)){var b=this.view.timeExtent;(c.isNone(a)||a.isAllTime)&&(c.isNone(b)||
b.isAllTime)||c.isSome(a)&&c.isSome(b)&&a.equals(b)||(this.view.timeExtent=c.unwrap(a))}},t.initial),t.watch(()=>c.applySome(this.view,a=>a.timeExtent),a=>{this._isViewTimeExtentInitialized?(c.isNone(a)||a.isAllTime)&&(c.isNone(this.timeExtent)||this.timeExtent.isAllTime)||c.isSome(a)&&c.isSome(this.timeExtent)&&a.equals(this.timeExtent)||(this.timeExtent=a):this._isViewTimeExtentInitialized=!0})])};d.destroy=function(){c.isSome(this._timerId)&&(clearInterval(this._timerId),this._timerId=null);this._unregisterWidget(this.view);
this.view=null;c.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null)};v.getPropertiesFromWebMap=async function(a,b){if(c.isNone(a)||!F(a))return null;await a.load({signal:b});var e=a?.widgets?.timeSlider;if(!e)return null;const {getFullTimeExtentFromWebDocument:f,getModeFromTimeSlider:m,getStopsFromTimeSlider:p,getTimeExtentFromTimeSlider:q}=await new Promise((r,y)=>G(["./utils"],r,y));a=await f(a,b);b=e.loop;const w=m(e),k=e.stopDelay??2E3,u=p(e);
e=q(e,w);return{fullTimeExtent:a,loop:b,mode:w,playRate:k,stops:u,timeExtent:e}};d.next=function(){this._step({forward:!0,allowRestart:!1})};d.play=function(){this._startAnimation()};d.previous=function(){this._step({forward:!1,allowRestart:!1})};d.stop=function(){this._stopAnimation()};d.triggerAction=function(a){this.emit("trigger-action",{action:a})};d.updateWebDocument=function(a){if(F(a)){const b=new N({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,loop:this.loop,numStops:A(this.stops)?
this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:x(this.stops)?this.stops.interval:null,stops:E(this.stops)?this.stops.dates:null});a.widgets?a.widgets.timeSlider=b:a.widgets=new M({timeSlider:b})}};d.valuesToTimeExtent=function(a){if(c.isNone(a))return null;var b=a.sort((e,f)=>e-f).map(e=>new Date(e));a=0<b.length?b[0]:null;b=1<b.length?b[1]:null;switch(this.mode){case "time-window":return new n({start:a,end:b});case "instant":return new n({start:a,
end:a});case "cumulative-from-start":return new n({start:null,end:a});case "cumulative-from-end":return new n({start:a,end:null});default:return n.allTime}};d._animate=async function(){try{const a=this.view,b=c.applySome(this._animationController,e=>e.signal);await Promise.all([C.after(this.playRate,null,b),c.isSome(a)&&t.whenOnce(()=>!1===a.updating,b)])}catch(a){C.isAbortError(a)||J.getLogger(this.declaredClass).error(a);this._animationController=null;return}this._step({forward:!0,allowRestart:!1});
c.isNone(this._animationController)||this._animate()};d._divideTimeExtentByCount=function(a,b=10){if(!a||!b)return[];const {start:e,end:f}=a;if(c.isNone(e)||c.isNone(f))return[];if(1E4<b)return this._divideTimeExtentByCount(a);a=[];const m=e.getTime(),p=f.getTime()-m;for(let q=0;q<=b;q++)a.push(new Date(m+q/b*p));return a};d._divideTimeExtentByInterval=function(a,b,e=1E4){if(!a||!b)return[];const {start:f,end:m}=a;if(c.isNone(f)||c.isNone(m))return[];const p=m.getTime()-f.getTime(),q=b.toMilliseconds();
if(0>=q||p/q>e)return this._divideTimeExtentByCount(a);a=[];const {value:w,unit:k}=b;for(b=f;b.getTime()<=m.getTime();)a.push(new Date(b.getTime())),b=K.offsetDate(b,w,k);return a};d._getDefaultTimeExtent=function(){const {effectiveStops:a,mode:b}=this;if(c.isNone(a)||!b)return null;switch(b){case "time-window":return 1<a.length?new n({start:a[0],end:a[1]}):null;case "cumulative-from-start":return 0<a.length?new n({start:null,end:a[0]}):null;case "cumulative-from-end":return 0<a.length?new n({start:a[0],
end:null}):null;case "instant":return 0<a.length?new n({start:a[0],end:a[0]}):null;default:return null}};d._registerWidget=function(a){c.isSome(a)&&(a.persistableViewModels.includes(this)||a.persistableViewModels.add(this))};d._startAnimation=function(){this._stopAnimation();this._animationController=new AbortController;this._step({forward:!0,allowRestart:!0});this._animate()};d._step=function(a){const {forward:b,allowRestart:e}=a;({effectiveStops:a}=this);if(!c.isNone(this.timeExtentValues)&&!c.isNone(a)){var f=
a.map(k=>k.getTime());a=this.timeExtentValues.map(k=>{var u=f.indexOf(k);if(-1!==u)return u;u=f.reduce((r,y)=>Math.abs(y-k)<Math.abs(r-k)?y:r);return f.indexOf(u)});var m=a.map(k=>k+=b?1:-1),p=m.some(k=>0>k||k>f.length-1),{loop:q,state:w}=this;if(p)if(q||e){const k=Math.min(...a),u=Math.max(...a);a=(b?a.map(r=>r-k):a.map(r=>r+(f.length-1-u))).map(r=>f[r]);this.timeExtent=this.valuesToTimeExtent(a)}else"playing"===w&&this.stop();else a=m.map(k=>f[k]),this.timeExtent=this.valuesToTimeExtent(a)}};d._stopAnimation=
function(){c.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null)};d._unregisterWidget=function(a){c.isSome(a)&&a.persistableViewModels.remove(this)};z._createClass(v,[{key:"effectiveStops",get:function(){const {fullTimeExtent:a,stops:b}=this;if(E(b)){var {dates:e}=b;if(null==e||0===e.length)return null;e=e.sort((p,q)=>p.getTime()-q.getTime());if(c.isNone(a))return e;const {start:f,end:m}=a;return c.isNone(f)||c.isNone(m)?e:e.filter(p=>!(p.getTime()<
f.getTime()||p.getTime()>m.getTime()))}return A(b)?(e=b.timeExtent??c.unwrap(a),this._divideTimeExtentByCount(e,b.count)):x(b)?(e=b.timeExtent??c.unwrap(a),this._divideTimeExtentByInterval(e,b.interval)):[]}},{key:"playRate",set:function(a){0>=a||36E5<a||("playing"===this.state&&this._startAnimation(),this._set("playRate",a))}},{key:"state",get:function(){return c.isNone(this.fullTimeExtent)?"disabled":c.isSome(this._animationController)?"playing":"ready"}},{key:"timeExtentValues",get:function(){const {mode:a,
timeExtent:b}=this;if(c.isNone(b)||b.isAllTime||b.isEmpty)return null;const {start:e,end:f}=b;switch(a){case "cumulative-from-end":case "instant":return c.isSome(e)?[e.getTime()]:null;case "cumulative-from-start":return c.isSome(f)?[f.getTime()]:null;case "time-window":return c.isSome(e)&&c.isSome(f)?[e.getTime(),f.getTime()]:null}}}]);return v}(I.HandleOwnerMixin(g.EventedAccessor));h.__decorate([l.property()],g.prototype,"_animationController",void 0);h.__decorate([l.property({type:B})],g.prototype,
"actions",void 0);h.__decorate([l.property({readOnly:!0})],g.prototype,"effectiveStops",null);h.__decorate([l.property({type:n})],g.prototype,"fullTimeExtent",void 0);h.__decorate([l.property({nonNullable:!0})],g.prototype,"loop",void 0);h.__decorate([l.property({nonNullable:!0})],g.prototype,"mode",void 0);h.__decorate([l.property({nonNullable:!0,value:1E3})],g.prototype,"playRate",null);h.__decorate([l.property({readOnly:!0})],g.prototype,"state",null);h.__decorate([l.property({cast:d=>{if(c.isNone(d))return null;
x(d)&&(d.interval=D.ensureType(H,d.interval));if(x(d)||A(d))d.timeExtent=D.ensureType(n,d.timeExtent);return d}})],g.prototype,"stops",void 0);h.__decorate([l.property({type:n})],g.prototype,"timeExtent",void 0);h.__decorate([l.property({readOnly:!0})],g.prototype,"timeExtentValues",null);h.__decorate([l.property()],g.prototype,"view",void 0);h.__decorate([l.property()],g.prototype,"next",null);h.__decorate([l.property()],g.prototype,"play",null);h.__decorate([l.property()],g.prototype,"previous",
null);h.__decorate([l.property()],g.prototype,"stop",null);h.__decorate([l.property()],g.prototype,"updateWebDocument",null);return g=h.__decorate([L.subclass("esri.widgets.TimeSlider.TimeSliderViewModel")],g)});