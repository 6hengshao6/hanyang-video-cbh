// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ../../views/draw/support/helpMessageUtils ./CreateWorkflowData ./Edits ./Workflow ./workflowUtils".split(" "),function(u,q,y,A,t,h,J,K,B,z,C,D,E,F,d){var v;h=v=function(G){function n(b){b=
H.call(this,b);b.type="create";return b}u._inherits(n,G);var H=u._createSuper(n);n.create=function(b,k,a){b=new v({data:new D({edits:new E.Edits,viewModel:b}),onCommit:async e=>{await a(e.creationInfo.layer,{addFeatures:[e.edits.feature]})}});b._set("steps",this._createWorkflowSteps(b,k));return b};n._createWorkflowSteps=function(b,k="awaiting-feature-creation-info"){const {data:a,handles:e}=b,r=new Map;b=d.createWorkflowSteps(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature",
"adding-attachment","editing-attachment"],k,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){a.creationInfo=null;a.edits.feature=null;a.viewModel.featureTemplatesViewModel.select(null);e.add(a.viewModel.featureTemplatesViewModel.on("select",({item:c})=>{c&&(a.creationInfo=c,a.viewModel.activeWorkflow?.next())}),this.id)},async tearDown(){e.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){e.add(await d.setUpFeatureAdd(a.viewModel.sketchViewModel,
a.creationInfo,c=>{a.edits.feature=c;a.viewModel.activeWorkflow?.next()},r),this.id)},async tearDown(){e.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const c=a.edits.feature,w=c.sourceLayer,l=a.viewModel,p=l.sketchViewModel;var x=d.findLayerInfo(l.layerInfos,w);const {spatialReference:I}=l.view;l.featureFormViewModel.set({arcadeEditType:"INSERT",feature:c,formTemplate:x?.formTemplate,spatialReference:I});p.allowDeleteKey=!1;d.prepareAttachmentsForCreateWorkflow(l.attachmentsViewModel);
const m=d.getVisualVariableAttributes(c);await d.startUpdatingFeature(p,c,w,m,r);x=p.on("update",async f=>{var g=f.graphics[0];if("complete"===f.state)return d.startUpdatingFeature(p,g,w,m,r);await d.visualVariableInteractiveUpdate(p.view,g,f,m,r);f=g.attributes;y.isSome(m.rotation)&&({field:g}=m.rotation,l.featureFormViewModel.setValue(g,f[g]));y.isSome(m.size)&&({field:g}=m.size,l.featureFormViewModel.setValue(g,f[g]))});e.add([a.viewModel.featureFormViewModel.on("value-change",async()=>{a.edits.updateAttributes(a.viewModel.featureFormViewModel.getValues());
c.attributes=a.edits.feature.attributes;"3d"===p.view.type&&await d.updateGraphicSymbolWhenRequired(c,r)}),x,A.watch(()=>a.viewModel.attachmentsViewModel.mode,f=>{"add"===f&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===f&&a.viewModel.activeWorkflow.go("editing-attachment")})],this.id)},async tearDown(c){c.cancelled&&a.viewModel.sketchViewModel.layer.removeAll();e.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode=
"view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}})});return d.avoidFeatureTemplateSelectionWithOnlyOneItem(a,b)};u._createClass(n,[{key:"shouldShowAttachments",get:function(){return this.data&&this.data.creationInfo&&this.data.viewModel?d.shouldShowAttachmentsForCreateWorkflow(this.data):!1}},{key:"shouldAllowAttachmentEditing",get:function(){return this.shouldShowAttachments}},
{key:"helpMessage",get:function(){if("editing-new-feature"===this.stepId){var {creationInfo:b,viewModel:k}=this.data;return C.getDrawHelpMessage(b.layer.geometryType,k.sketchViewModel.createGraphic?.geometry)}}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const {layer:b}=this.data.creationInfo,k=b.capabilities?.operations.supportsAdd,a=z.getEffectiveLayerCapabilities(b)?.operations.supportsAdd;return z.getEffectiveEditingEnabled(b)&&!b.editingEnabled||!!a&&!k}}]);return n}(F);q.__decorate([t.property()],
h.prototype,"shouldShowAttachments",null);q.__decorate([t.property()],h.prototype,"shouldAllowAttachmentEditing",null);q.__decorate([t.property()],h.prototype,"helpMessage",null);q.__decorate([t.property()],h.prototype,"reliesOnOwnerAdminPrivileges",null);return h=v=q.__decorate([B.subclass("esri.widgets.Editor.CreateWorkflow")],h)});