// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/support/layerUtils ../../views/support/layerViewUtils ./Edits ./UpdateWorkflowData ./Workflow ./workflowUtils".split(" "),function(E,w,K,F,B,L,C,r,W,X,Q,M,R,S,T,
U,p){var G;r=G=function(D){function t(b){b=V.call(this,b);b.type="update";return b}E._inherits(t,D);var V=E._createSuper(t);t.create=function(b,h,a){b=new G({data:new T({edits:new S.Edits,viewModel:b}),onCommit:async c=>{const u=c.edits.feature;if(u){var d=u.sourceLayer,e=u.clone();if(!c.edits.attributesModified){const f=d.objectIdField;e.attributes={[f]:u.getAttribute(f)}}c.edits.geometryModified||(e.geometry=null);await a(d,{updateFeatures:[e]})}}});b._set("steps",this._createWorkflowSteps(b,h));
return b};D=t.prototype;D.highlight=function(b){var h=this.data.viewModel.view;h&&b&&(h=b&&h.allLayerViews.items.find(({layer:a})=>a===b.layer||"subtype-sublayer"===b.layer.type&&b.layer.parent===a),R.highlightsSupported(h)&&this.handles.add(h.highlight(b),"candidate-highlight"))};D.unhighlight=function(){this.handles.remove("candidate-highlight")};t._createWorkflowSteps=function(b,h="awaiting-feature-to-update"){const {data:a,handles:c}=b,u=new Map;return p.createWorkflowSteps(["awaiting-feature-to-update",
"awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],h,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const {spinnerViewModel:d}=a.viewModel,e=a.viewModel.view;let f=null;c.add({remove(){f&&(f.abort(),f=null)}},this.id);a.edits.feature=null;const I=e.on("immediate-click",l=>{d.location=l.mapPoint;d.visible=!0;f?.abort();const {editableItems:H}=a.viewModel;f=new AbortController;(new Promise((m,q)=>{B.onAbort(f?.signal,
()=>q(B.createAbortError()));m(p.fetchCandidates(H,e,l,f?.signal))})).then(m=>{B.throwIfAborted(f);a.candidates=m.reduce((q,k)=>k.error?q:[...q,...k.value],[]);a.viewModel.spinnerViewModel.visible=1===a.candidates.length;0!==a.candidates.length&&(m=a.viewModel.activeWorkflow,1===a.candidates.length?(a.edits.feature=a.candidates[0],m.go("editing-existing-feature").catch(()=>{}).then(()=>a.viewModel.spinnerViewModel.visible=!1)):m.next())})});e.focus();c.add(I,this.id)},async tearDown(){c.remove(this.id)}}),
"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){const {edits:d}=a;d.feature=null;c.add(L.watch(()=>d.feature,e=>{b.unhighlight();b.highlight(e)}),this.id)},async tearDown(){b.unhighlight();c.remove(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){if(!c.has("editing-existing-feature")){var d=a.edits.feature,e=a.viewModel.view,{attachmentsViewModel:f,editableItems:I,featureFormViewModel:l,layerInfos:H,sketchViewModel:m}=
a.viewModel;a.editableItem=I.find(g=>g.layer===d.layer);var q=new AbortController;c.add({remove:()=>q.abort()},this.id);var k=p.whenEditorLayerView(e,d.layer),x=p.fetchFullFeature(d,e,q.signal);k=await k;var n=await x;if(!B.isAborted(q)){a.edits.updateGeometry(n.geometry);a.edits.updateAttributes(n.attributes);a.edits.trackChanges();var v=a.editableItem.supports;x=v.includes("create");v=v.includes("update");f.set({abilities:{editing:!0,operations:{add:x||v,update:v,delete:v}},graphic:n,filesEnabled:!1,
mode:"view"});x=p.findLayerInfo(H,n.sourceLayer);l.set({arcadeEditType:"UPDATE",feature:n,formTemplate:x?.formTemplate,spatialReference:e.spatialReference,view:e});var y="createInteractiveEditSession"in k?k.createInteractiveEditSession(d):null;k=[l.on("value-change",g=>{a.edits.updateAttributes(l.getValues());n.attributes=a.edits.feature.attributes;y&&y.setAttribute(g.fieldName,g.value)}),L.watch(()=>f.mode,g=>{"add"===g&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===g&&a.viewModel.activeWorkflow.go("editing-attachment")})];
y&&(k.push(K.makeHandle(()=>y.rollback())),c.add(K.makeHandle(()=>y.commit()),b._handleKeys.afterCommit));if(a.editableItem.geometryUpdatesEnabled){m.allowDeleteKey=!1;const g=p.getVisualVariableAttributes(n),{interactive:N,visual:O}=await p.setUpGeometryUpdate(n,g,m,e,({geometry:P,attributes:J},z)=>{if(F.isSome(g.rotation)){var {field:A}=g.rotation;l.setValue(A,J[A])}F.isSome(g.size)&&({field:A}=g.size,l.setValue(A,J[A]));a.edits.updateAttributes(J);a.edits.updateGeometry(P);l.feature.geometry=P;
("undo"===z.type||"redo"===z.type||"update"===z.type&&F.isSome(z.toolEventInfo)&&p.isTerminalUpdateEventType(z.toolEventInfo.type))&&l.notifyFeatureGeometryChanged()},u);k.push(N,O);c.add(N,b._handleKeys.beforeCommit);c.add(O,b._handleKeys.afterCommit)}else b.highlight(n);c.add(k,this.id)}}},async tearDown({cancelled:d}){d&&(b.unhighlight(),c.remove(this.id))}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode=
"view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}})})};E._createClass(t,[{key:"shouldShowAttachments",get:function(){return!!this.data?.editableItem.attachmentsOnUpdateEnabled}},{key:"shouldAllowAttachmentEditing",get:function(){return!!this.data?.editableItem.supports.includes("update")}},{key:"helpMessage",get:function(){return"awaiting-feature-to-update"===this.stepId?"select":
void 0}},{key:"reliesOnOwnerAdminPrivileges",get:function(){const {layer:b}=this.data.editableItem,h=b.capabilities?.operations.supportsUpdate,a=M.getEffectiveLayerCapabilities(b)?.operations.supportsUpdate;return M.getEffectiveEditingEnabled(b)&&!b.editingEnabled||!!a&&!h}}]);return t}(U);w.__decorate([C.property()],r.prototype,"shouldShowAttachments",null);w.__decorate([C.property()],r.prototype,"shouldAllowAttachmentEditing",null);w.__decorate([C.property()],r.prototype,"helpMessage",null);w.__decorate([C.property()],
r.prototype,"reliesOnOwnerAdminPrivileges",null);return r=G=w.__decorate([Q.subclass("esri.widgets.Editor.UpdateWorkflow")],r)});