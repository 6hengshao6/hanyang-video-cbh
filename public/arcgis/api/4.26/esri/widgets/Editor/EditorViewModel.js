// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/asyncUtils ../../core/Collection ../../core/deprecate ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../layers/support/layerUtils ../../portal/support/urlUtils ../Attachments/AttachmentsViewModel ./CreateFeaturesWorkflow ./CreateWorkflow ./deprecationUtils ./UpdateWorkflow ./workflowUtils ../FeatureForm/FeatureFormViewModel ../FeatureTemplates/FeatureTemplatesViewModel ../Sketch/SketchViewModel ../Spinner/SpinnerViewModel".split(" "),
function(v,h,D,B,E,y,f,F,G,z,n,k,V,W,X,H,I,w,J,K,L,M,A,N,O,P,Q,R,S){function q(g,r,t){u.error(new y(g,r,t))}function T(g,r){return g?g.find(t=>t.layer===r):void 0}const u=G.getLogger("esri.widgets.Editor.EditorViewModel"),C=["create","create-features","update"];f=function(g){function r(a){var b=t.call(this,a);b._sketchGraphicsLayer=new I({listMode:"hide",internal:!0});b._updateEditableItemsTask=null;b.activeWorkflow=null;b._activityQueue=[];b.editableItems=new B;b.failures=[];b.attachmentsViewModel=
new K({abilities:{editing:!0}});b.featureFormViewModel=new P;b.featureTemplatesViewModel=new Q;b.sketchViewModel=new R({layer:b._sketchGraphicsLayer});b.spinnerViewModel=new S;b.pageStack=[];b.showDiscardPrompt=()=>Promise.resolve();b._candidateCommitted=!1;b.back=async()=>{const c=b.activeWorkflow;if(c&&b.canGoBack){if(b.hasPendingEdits)try{await b.showDiscardPrompt()}catch(d){return}c.hasPreviousStep?await c.previous({cancelCurrentStep:!0}):await b.cancelWorkflow({force:!0})}};b.save=()=>{const {featureFormViewModel:c}=
v._assertThisInitialized(b);c.submit();!c.submittable||0<c.validateContingencyConstraints(c.getValues(),{includeIncompleteViolations:!0}).length||b.activeWorkflow?.commit()};b.selectFeature=(c,d=!1)=>{const e=b.activeWorkflow;b._candidateCommitted||"update"!==e?.type||(e.data.edits.feature=c,d&&(e.next(),b._candidateCommitted=!0))};return b}v._inherits(r,g);var t=v._createSuper(r);g=r.prototype;g.initialize=function(){this.handles.add([n.watch(()=>{const a=this.view?.map?.editableLayers.filter(({parent:c,
visible:d})=>c&&"visible"in c?d&&c.visible:d),b=this.view?.allLayerViews?.filter(c=>!!a?.includes(c.layer)&&!c.suspended);return[a,b,this.layerInfos,this.allowedWorkflows]},()=>this._updateEditableItems(),n.initial),n.on(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),n.on(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),n.when(()=>this.view?.map,a=>{a.add(this._sketchGraphicsLayer)},n.initial),n.watch(()=>this.editableItems.toArray(),()=>{const {activeWorkflow:a}=
this;this.refreshCreationTemplates();if(a){var {stepId:b}=a;"create"===a.type?"awaiting-feature-creation-info"!==b||this.canCreate||this._cancelWorkflow():"update"===a.type&&("awaiting-feature-to-update"===b&&!this.canUpdate||"awaiting-update-feature-candidate"===b&&!a.data.candidates.some(c=>{const d=this.editableItems.find(e=>e.layer===c.layer);return d&&d.supports.includes("update")}))&&this._cancelWorkflow()}}),n.watch(()=>this.page,(a,b)=>{const c=this.pageStack.slice();a=c.indexOf(a);-1===a&&
b?c.push(b):c.splice(a);this.pageStack=c}),n.when(()=>"awaiting-update-feature-candidate"===this.state,()=>this._candidateCommitted=!1)])};g.destroy=function(){this._cancelWorkflow().then(()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer);this.view=null});this._updateEditableItemsTask=z.abortMaybe(this._updateEditableItemsTask)};g.startCreateWorkflowAtFeatureTypeSelection=async function(){A.workflowDeprecation(u,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection");
await n.whenOnce(()=>!this.updating);if(this.canCreate){await this._cancelWorkflow();var a=this._createCreateWorkflow();await a.start();this._set("activeWorkflow",a)}else q("editing:unsupported-workflow","Create workflow is unsupported or disabled.")};g.startCreateFeaturesWorkflowAtFeatureTypeSelection=async function(){return this.startCreateFeaturesWorkflow()};g.startCreateWorkflowAtFeatureCreation=async function(a){A.workflowDeprecation(u,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation");
await n.whenOnce(()=>!this.updating);if(this.canCreate){await this._cancelWorkflow();var b=this._createCreateWorkflow("awaiting-feature-to-create");b.data.creationInfo=a;await b.start();this._set("activeWorkflow",b)}else q("editing:unsupported-workflow","Create workflow is unsupported or disabled.")};g.startCreateFeaturesWorkflowAtFeatureCreation=async function(a){return this.startCreateFeaturesWorkflow(a,"creating-features")};g.startCreateFeaturesWorkflow=async function(a,b="awaiting-feature-creation-info"){await n.whenOnce(()=>
!this.updating);if(!this.canCreate)throw new y("editing:unsupported-workflow","Creating features is unsupported or disabled.");await this._cancelWorkflow();a=this._createCreateFeaturesWorkflow(a,b);await a.start();this._set("activeWorkflow",a)};g.startCreateWorkflowAtFeatureEdit=async function(a){A.workflowDeprecation(u,"startCreateWorkflowAtFeatureEdit");await n.whenOnce(()=>!this.updating);if(this.canCreate){await this._cancelWorkflow();var b=this._createCreateWorkflow("editing-new-feature");b.data.edits.feature=
a;await b.start();this._set("activeWorkflow",b)}else q("editing:unsupported-workflow","Create workflow is unsupported or disabled.")};g.startUpdateWorkflowAtFeatureSelection=async function(){await n.whenOnce(()=>!this.updating);if(this.canUpdate){await this._cancelWorkflow();var a=this._createUpdateWorkflow();await a.start();this._set("activeWorkflow",a)}else q("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};g.startUpdateWorkflowAtMultipleFeatureSelection=async function(a){await n.whenOnce(()=>
!this.updating);if(this.canUpdate){await this._cancelWorkflow();var b=this._createUpdateWorkflow("awaiting-update-feature-candidate");b.data.candidates=a;await b.start();this._set("activeWorkflow",b)}else q("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};g.startUpdateWorkflowAtFeatureEdit=async function(a){await n.whenOnce(()=>!this.updating);if(this.canUpdate){await this._cancelWorkflow();var b=this._createUpdateWorkflow("editing-existing-feature");b.data.edits.feature=
a;await b.start();this._set("activeWorkflow",b)}else q("editing:unsupported-workflow","Update workflow is unsupported or disabled.")};g.deleteFeatureFromWorkflow=async function(){const {activeWorkflow:a}=this;a&&"update"===a.type?(await this._delete(a.data.edits.feature),await a.reset()):q("editing:unsupported-workflow","Deleting requires an active update workflow.")};g.cancelWorkflow=async function(a){return this._cancelWorkflow({warn:!0,...a})};g.findEditableItemForLayer=function(a){const b="subtype-sublayer"===
a.type?a.parent:a;return this.editableItems.find(c=>c.layer===b)};g.refreshCreationTemplates=function(){const a=[];for(const {layer:b,supports:c}of this.editableItems)b.loaded&&c.includes("create")&&a.push(b);this.featureTemplatesViewModel.layers=a};g._updateEditableItems=async function(){z.abortMaybe(this._updateEditableItemsTask);const a=D.createTask(async b=>{var c=this.view?.allLayerViews,d=this.view?.map?.editableLayers;if(c&&d){var e=new Set(d);d=d?.filter(m=>{const l=w.getEffectiveLayerCapabilities(m)?.operations;
return!(!m.visible||!l?.supportsAdd||l?.supportsQuery)});var p=c.filter(m=>e.has(m.layer));c=[];for(const m of p.reverse()){const {layer:l,suspended:x}=m;"subtype-group"===l.type?(await l.loadAll(),c.push(...l.sublayers.slice().reverse().map(U=>this._makeEditableItemForLayer(U,x)))):c.push(this._makeEditableItemForLayer(l,x))}for(const m of d.reverse())"subtype-group"===m.type?(await m.loadAll(),c.push(...m.sublayers.map(l=>this._makeEditableItemForLayer(l,!1)))):c.push(this._makeEditableItemForLayer(m,
!1));b.aborted||(b=this.editableItems,this.editableItems=new B(c),b.destroy())}});this.updatingHandles.addPromise(a.promise);this._updateEditableItemsTask=a};g._cancelWorkflow=async function(a){const b=this.activeWorkflow;b?a&&!1===a.force?(await b.cancel(a),this._set("activeWorkflow",null)):(this.emit("workflow-cancel"),this._set("activeWorkflow",null),await b.cancel(a)):a&&a.warn&&q("editing:no-active-workflow","There is no active workflow to cancel.")};g._createCreateFeaturesWorkflow=function(a,
b){return L.create(this,a,b,(c,d,e)=>this._applyEdits(c,d,e),(c,d)=>this._addAttachments(c,d))};g._createCreateWorkflow=function(a){return M.create(this,a,(b,c,d)=>this._applyEdits(b,c,d))};g._createUpdateWorkflow=function(a){return N.create(this,a,(b,c)=>this._applyEdits(b,c))};g._delete=async function(a){const b=a?.sourceLayer;b&&"applyEdits"in b&&await this._applyEdits(b,{deleteFeatures:[a]})};g._addAttachments=function(a,b){const c=[];b?.forEach(d=>c.push(this._addAttachment(a,d.feature,d.attachment)));
return Promise.all(c)};g._addAttachment=async function(a,b,c){let d=null;if("geojson"===a.type||"scene"===a.type||"oriented-imagery"===a.type)throw new y("editor:attachments-not-supported","Adding attachments is not supported for this layer type");await this._queueOperation(async()=>d=await a.addAttachment?.(b,c).catch(e=>{throw e?.error||e;})??null);return d};g._applyEdits=async function(a,b,c){let d=null;const e=a.url?await w.getOwningPortalUrl(a.url):null,p={returnServiceEditsOption:e&&J.parseKnownArcGISOnlineDomain(e)||
RegExp("/hosted/","i").test(a.url)?void 0:"original-and-current-features",...c};await this._queueOperation(async()=>{if(w.getEffectiveLayerCapabilities(a)?.operations.supportsQuery){const m=await O.whenEditorLayerView(this.view,a);d=await a.applyEdits(b,p);await n.whenOnce(()=>!m.updating);return d}return d=await a.applyEdits(b,p)});return d};g._queueOperation=function(a){this._activityQueue.push(a);this.notifyChange("syncing");const b=(c,d)=>{c=d.indexOf(c);-1<c&&d.splice(c,1)};return a().then(c=>
{if("error"in c&&c.error)throw c.error;if("addFeatureResults"in c){const {addFeatureResults:d,deleteFeatureResults:e,updateFeatureResults:p}=c,m=d.find(l=>!!l.error)||p.find(l=>!!l.error)||e.find(l=>!!l.error);if(m)throw m.error;}return c}).catch(c=>{q("editing:operation-error","An error occurred.",{error:c});const d={error:c,retry:()=>{b(d,this.failures);return this._queueOperation(a)},cancel:()=>{b(d,this.failures)}};this._set("failures",[...this.failures,d])}).then(()=>{b(a,this._activityQueue);
this.notifyChange("syncing")})};g._makeEditableItemForLayer=function(a,b=!0){const c=w.getEffectiveLayerCapabilities(a);var d=c?.operations;const e=T(this.layerInfos,a);var p=this.allowedWorkflows;const m=p.includes("create")||p.includes("create-features");var l=p.includes("update");const x=m&&!!d?.supportsAdd&&(!e||!1!==e.enabled&&!1!==e.addEnabled);p=l&&!!d?.supportsUpdate&&(!e||!1!==e.enabled&&!1!==e.updateEnabled);l=l&&!!d?.supportsDelete&&(!e||!1!==e.enabled&&!1!==e.deleteEnabled);d=[];b||(x&&
d.push("create"),p&&d.push("update"),l&&d.push("delete"));b=!!c?.data?.supportsAttachment&&(!e||!1!==e.allowAttachments);return{layer:a,supports:d,attributeUpdatesEnabled:p&&(!e||!1!==e.attributeUpdatesEnabled),geometryUpdatesEnabled:p&&!!c?.editing?.supportsGeometryUpdate&&(!e||!1!==e.geometryUpdatesEnabled),hasAttachments:b,attachmentsOnCreateEnabled:b&&m&&(!e||!1!==e.attachmentsOnCreateEnabled),attachmentsOnUpdateEnabled:b&&(!e||!1!==e.attachmentsOnUpdateEnabled)}};v._createClass(r,[{key:"allowedWorkflows",
get:function(){return this._get("allowedWorkflows")},set:function(a){a&&0!==a.length||(a=[...C]);this._set("allowedWorkflows",a)}},{key:"canCreate",get:function(){return this.editableItems.some(a=>a.supports.includes("create"))}},{key:"canUpdate",get:function(){return this.editableItems.some(a=>a.supports.includes("update")||a.supports.includes("delete")||a.attachmentsOnUpdateEnabled)}},{key:"labelOptions",get:function(){return this.sketchViewModel.labelOptions},set:function(a){this.sketchViewModel.labelOptions=
a}},{key:"layerInfos",set:function(a){a?.some(b=>{"allowAttachments"in b&&E.deprecated(u,"Property: layerInfo.allowAttachments",{replacement:"layerInfo.attachmentsOnCreateEnabled or layerInfo.attachmentsOnUpdateEnabled",version:"4.26"});return!0});this._set("layerInfos",a)}},{key:"snappingOptions",get:function(){return this.sketchViewModel.snappingOptions},set:function(a){this.sketchViewModel.snappingOptions=a}},{key:"state",get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";
var a=this.attachmentsViewModel.mode;if("add"===a)return"adding-attachment";if("edit"===a)return"editing-attachment";({activeWorkflow:a}=this);return a?a.stepId:"ready"}},{key:"syncing",get:function(){return 0<this._activityQueue.length}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"tooltipOptions",get:function(){return this.sketchViewModel.tooltipOptions},set:function(a){this.sketchViewModel.tooltipOptions=a}},{key:"view",set:function(a){this.sketchViewModel.view=a;
this.spinnerViewModel.view=a;this._set("view",a)}},{key:"page",get:function(){const {activeWorkflow:a,state:b}=this;return"awaiting-feature-to-update"===b||"awaiting-feature-to-create"===b||"create-features"===a?.type&&0===a.pendingFeatures.length?"ready":b??"disabled"}},{key:"selectedTemplateItem",get:function(){var {activeWorkflow:a}=this;if("create-features"===a?.type&&0===a.pendingFeatures.length){({template:a}=a.data.creationInfo);for(const b of this.featureTemplatesViewModel.items)if("findByTemplate"in
b){const c=b.findByTemplate(a);if(c)return c}else if(b.template===a)return b}}},{key:"featureFormDisabled",get:function(){const {activeWorkflow:a}=this;return"update"===a?.type&&!1===a?.data.editableItem?.attributeUpdatesEnabled}},{key:"canGoBack",get:function(){return z.isSome(this.activeWorkflow)&&!this.syncing}},{key:"shouldShowDeleteButton",get:function(){const {activeWorkflow:a}=this;return!!a&&"update"===a.type&&a.data.editableItem.supports.includes("delete")}},{key:"hasPendingEdits",get:function(){const {activeWorkflow:a}=
this;return a?"create"===a.type||"create-features"===a.type&&0<a.numPendingFeatures||"editing-existing-feature"===a.stepId&&a.data.edits.modified:!1}}]);return r}(F.HandleOwnerMixin(f.EventedAccessor));h.__decorate([k.property({readOnly:!0})],f.prototype,"activeWorkflow",void 0);h.__decorate([k.property({readOnly:!0})],f.prototype,"_activityQueue",void 0);h.__decorate([k.property({value:[...C]})],f.prototype,"allowedWorkflows",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"canCreate",
null);h.__decorate([k.property({readOnly:!0})],f.prototype,"canUpdate",null);h.__decorate([k.property()],f.prototype,"editableItems",void 0);h.__decorate([k.property({readOnly:!0})],f.prototype,"failures",void 0);h.__decorate([k.property()],f.prototype,"attachmentsViewModel",void 0);h.__decorate([k.property()],f.prototype,"featureFormViewModel",void 0);h.__decorate([k.property()],f.prototype,"featureTemplatesViewModel",void 0);h.__decorate([k.property()],f.prototype,"labelOptions",null);h.__decorate([k.property()],
f.prototype,"layerInfos",null);h.__decorate([k.property()],f.prototype,"sketchViewModel",void 0);h.__decorate([k.property()],f.prototype,"snappingOptions",null);h.__decorate([k.property()],f.prototype,"spinnerViewModel",void 0);h.__decorate([k.property()],f.prototype,"state",null);h.__decorate([k.property({readOnly:!0})],f.prototype,"syncing",null);h.__decorate([k.property()],f.prototype,"updating",null);h.__decorate([k.property()],f.prototype,"tooltipOptions",null);h.__decorate([k.property()],f.prototype,
"view",null);h.__decorate([k.property()],f.prototype,"pageStack",void 0);h.__decorate([k.property()],f.prototype,"showDiscardPrompt",void 0);h.__decorate([k.property()],f.prototype,"_candidateCommitted",void 0);h.__decorate([k.property()],f.prototype,"page",null);h.__decorate([k.property()],f.prototype,"selectedTemplateItem",null);h.__decorate([k.property()],f.prototype,"featureFormDisabled",null);h.__decorate([k.property()],f.prototype,"canGoBack",null);h.__decorate([k.property()],f.prototype,"shouldShowDeleteButton",
null);h.__decorate([k.property()],f.prototype,"hasPendingEdits",null);return f=h.__decorate([H.subclass("esri.widgets.Editor.EditorViewModel")],f)});