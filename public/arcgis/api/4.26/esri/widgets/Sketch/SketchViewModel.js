// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.27/esri/copyright.txt for details.
//>>built
define("require ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../symbols ../../core/Collection ../../core/Error ../../core/Evented ../../core/Handles ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/has ../../core/accessorSupport/decorators/subclass ../../geometry/ellipsoidUtils ../../geometry/projection ../../geometry/support/coordsUtils ../../geometry/support/spatialReferenceUtils ../../layers/GraphicsLayer ../../views/3d/interactive/editingTools/isSupportedGraphicUtils ../../views/3d/interactive/editingTools/moveGraphic/isSupportedGraphic ../../views/3d/interactive/editingTools/reshapeGraphic/isSupportedGraphic ../../views/3d/interactive/editingTools/transformGraphic/isSupportedGraphic ../../views/draw/support/layerUtils ../../views/input/InputManager ../../views/interactive/keybindings ../../views/interactive/sketch/SketchLabelOptions ../../views/interactive/sketch/SketchTooltipOptions ../../views/interactive/snapping/SnappingManager ../../views/interactive/snapping/SnappingOptions ../../views/interactive/snapping/snappingUtils ../../views/support/hitTestSelectUtils ../../views/support/screenUtils ./support/OperationHandle ../../symbols/SimpleMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/MeshSymbol3D ../../symbols/FillSymbol3DLayer".split(" "),
function(A,M,t,F,aa,ba,q,P,ca,n,N,B,u,ta,ua,va,da,ea,G,Q,fa,ha,C,ia,H,ja,R,x,v,S,T,ka,U,la,ma,V,E,W,na,oa,pa,qa){function ra(l){return"polygon"===l||"rectangle"===l||"circle"===l}function I(l,z){X("undo",l.history.undo,l.history.redo,z)}function J(l,z){X("redo",l.history.redo,l.history.undo,z)}function X(l,z,O,a){if(z=z.pop()){var c=z.updates,d=[];a.forEach((b,e)=>{e=c[e];null!=e&&("geometry"in e&&n.isSome(e.geometry)&&(d.push({geometry:b.geometry}),b.geometry=e.geometry),"symbol"in e&&n.isSome(e.symbol)&&
(d.push({symbol:b.symbol}),b.symbol=e.symbol),"undo"in e&&(d.push(e),e[l](b)))});O.push({updates:d})}}function D(l){return{updates:l.map(z=>({geometry:z.geometry}))}}function w(l){return"requireError"in l&&"aborted"===l.requireError}const K=l=>Object.freeze(Object.defineProperty({__proto__:null,default:l},Symbol.toStringTag,{value:"Module"})),Y={defaultZ:0},L={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,
multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};q=function(l){function z(a){a=O.call(this,a);a._numUpdating=0;a._handles=new P;a._internalGraphicsLayer=new ha({listMode:"hide",internal:!0,title:"SVM Internal"});a._operationHandle=null;a._viewHandles=new P;a.activeFillSymbol=null;a.activeLineSymbol=null;a.activeVertexSymbol=null;a.allowDeleteKey=!0;a.labelOptions=new S;a.layer=null;a.pointSymbol=new W({style:"circle",size:6,color:[255,255,255],outline:{color:[50,
50,50],width:1}});a.polygonSymbol=new na({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}});a.polylineSymbol=new oa({color:[130,130,130,1],width:2});a.meshSymbol=new pa({symbolLayers:[new qa]});a._snappingManager=null;a.tooltipOptions=new T;a.updateGraphics=new aa;a.updateOnGraphicClick=!0;a.vertexSymbol=new W({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}});a._moduleLoaderAbortController=null;a._viewReadyAbortController=null;a._originalAutoOpenEnabled=null;
a.defaultCreateOptions=Y;a.defaultUpdateOptions=L;a.snappingOptions=new U;return a}M._inherits(z,l);var O=M._createSuper(z);l=z.prototype;l.initialize=function(){this._handles.add([B.on(()=>this.view?.map?.layers,"change",a=>{a.removed.includes(this.layer)&&this.cancel()}),B.on(()=>this.layer?.graphics,"change",a=>{if(n.isSome(this._operationHandle))for(const c of a.removed)this.updateGraphics.includes(c)&&(1<this.updateGraphics.length?this._operationHandle.removeFromSelection(c):this._operationHandle.cancel())}),
B.watch(()=>this.layer?.elevationInfo??null,a=>{a!==this._internalGraphicsLayer.elevationInfo&&(this.cancel(),this._internalGraphicsLayer.elevationInfo=a)},B.syncAndInitial),B.watch(()=>this.view,a=>{n.destroyMaybe(this._snappingManager);a&&(this._snappingManager=new ka.SnappingManager({view:a,options:this.snappingOptions}),"2d"===a.type?new Promise((c,d)=>A(["../../views/2d/interactive/editingTools"],c,d)):"3d"===a.type&&(new Promise((c,d)=>A(["../../views/3d/interactive/editingTools"],c,d)),new Promise((c,
d)=>A(["../../views/3d/layers/GraphicsLayerView3D"],b=>c(K(b)),d))))},B.syncAndInitial),B.watch(()=>this.view?.spatialReference,(a,c)=>{a&&c&&!a.equals(c)&&this.cancel()})]);la.setupSnappingToggleHandles(this)};l.destroy=function(){this.cancel();this._handles=n.destroyMaybe(this._handles);this._viewHandles=n.destroyMaybe(this._viewHandles);this._removeDefaultLayer();this._snappingManager=n.destroyMaybe(this._snappingManager);this._set("view",null);this.emit("destroy")};l.cancel=function(){this._moduleLoaderAbortController=
n.abortMaybe(this._moduleLoaderAbortController);this._viewReadyAbortController=n.abortMaybe(this._viewReadyAbortController);this._operationHandle&&this._operationHandle.cancel()};l.complete=function(){this._operationHandle&&this._operationHandle.complete()};l.delete=function(){const {state:a,updateGraphics:c}=this;if("active"===a&&c.length){const {activeTool:d,layer:b}=this,e=c.toArray();b.removeMany(e);this.cancel();this._emitDeleteEvent({graphics:e,tool:d})}};l.duplicate=function(){if("active"===
this.state&&this.updateGraphics.length){const a=this.updateGraphics.map(c=>c.clone()).toArray();this.layer.addMany(a);this.emit("duplicate",{graphics:a,type:"duplicate"});return a}return[]};l.create=async function(a,c){this.cancel();await this._waitViewReady();const {view:d,layer:b}=this;if(!d||"disabled"===this.state)throw b||this._logMissingLayer(),N.createAbortError();n.isSome(d.activeTool)&&(d.activeTool=null);if(a){R.addUniqueLayer(d,this._internalGraphicsLayer);var e=await this._setupCreateOperation(a,
c);n.isNone(e)||this.destroyed?d.map.remove(this._internalGraphicsLayer):(e.on("complete",()=>{if(e===this._operationHandle){const k=this.createGraphic,h=this._operationHandle.cancelled;this._operationHandle.destroy();this._operationHandle=null;this._set("createGraphic",null);this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer);e.cancelled||null==k||b.add(k);this.emit("create",{graphic:k,state:h?"cancel":"complete",tool:a,toolEventInfo:null,type:"create"})}}),this._operationHandle=
e,d.ready&&d.focus())}else this._logError("sketch:missing-parameter","Missing parameter 'tool'.")};l.update=async function(a,c){this.cancel();await this._waitViewReady();const {layer:d,view:b,state:e}=this;if(!b||"disabled"===e)throw d||this._logMissingLayer(),N.createAbortError();n.isSome(b.activeTool)&&(b.activeTool=null);const k=Array.isArray(a)?a:[a];null!=a&&k&&k.length?k.some(h=>h.layer!==d?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),
!0):n.isNone(h.geometry)?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0):!1)||(a=await this._setupUpdateOperation(k,c),this.destroyed||n.isNone(a)||w(a)||(R.addUniqueLayer(b,this._internalGraphicsLayer),this._setUpdateOperationHandle(a,c),this.emit("update",{graphics:k,state:"start",aborted:!1,tool:a.tool,toolEventInfo:null,type:"update"}))):this._logError("sketch:missing-parameter","Missing parameter 'graphics'.")};
l._updateSpatialReference=async function(a){const c=this.view;if(c){this._beginAsyncOperation();a=Array.isArray(a)?a:[a];for(const d of a)n.isSome(d.geometry)&&"mesh"!==d.geometry.type&&!fa.equals(d.geometry.spatialReference,c.spatialReference)&&(G.canProjectWithoutEngine(d.geometry.spatialReference,c.spatialReference)||G.isLoaded()||await G.load(),d.geometry=G.project(d.geometry,c.spatialReference));this._endAsyncOperation()}else this._logMissingView()};l.undo=function(){this.canUndo()&&this._operationHandle?.undo()};
l.redo=function(){this.canRedo()&&this._operationHandle?.redo()};l.canUndo=function(){return!(!this._operationHandle||!this._operationHandle.canUndo())};l.canRedo=function(){return!(!this._operationHandle||!this._operationHandle.canRedo())};l.toggleUpdateTool=function(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()};l._getFirstHit=async function(a){var c=this.view;if(!c)return this._logMissingView(),null;if("2d"===c.type){const b=[];c.map.allLayers.forEach(e=>
{"vector-tile"!==e.type&&"imagery"!==e.type||b.push(e)});c=await c.hitTest(a,{exclude:b});return ma.findFirstGraphicHit(c.results)}const d=[c.map.ground];c.map.allLayers.forEach(b=>{"integrated-mesh"===b.type&&d.push(b)});a=await c.hitTest(a,{exclude:d});if(0<a.results.length){const b=a.results[0];if(n.isSome(b)&&"graphic"===b.type&&b.graphic&&(!a.ground.mapPoint||1>c.map.ground.opacity||a.ground.distance-n.unwrapOr(b.distance,0)>-Math.min(3*a.ground.distance,"global"===c.viewingMode?ea.getReferenceEllipsoid(c.renderCoordsHelper.spatialReference).radius/
c.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY)))return b}return null};l._generateViewHandles=function(a){return[a.on("immediate-click",async c=>{var d="active"===this.state&&"create"===this._operationHandle?.type;if("disabled"!==this.state&&!d&&this.updateOnGraphicClick){this._beginAsyncOperation();var b=await c.async(()=>this._getFirstHit(V.createScreenPointFromEvent(c)));d=null;n.isSome(b)?(b=b.graphic,this.updateGraphics.includes(b)||b.layer===this.layer?(c.stopPropagation(),d=b):
"2d"!==a.type||this._isComponentGraphic(b)||"active"!==this.state||this.cancel()):"active"===this.state&&this.cancel();n.isSome(d)&&!this.updateGraphics.includes(d)&&await this.update([d],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}});this._endAsyncOperation()}},x.ViewEventPriorities.WIDGET)]};l._setupCreateOperation=async function(a,c){const d=this.view;if(!d)return this._logMissingView(),null;a=await this._setupDrawGraphicTool(a,d,{hasZ:"3d"===d.type,
...this.defaultCreateOptions,...c});if(n.isNone(a))return null;d.tools.add(a);d.activeTool=a;return this._setupCreateOperationHandle(a)};l._setupDrawGraphicTool=async function(a,c,d){if("multipoint"===a&&"3d"===c.type)return this._logError("sketch:create","Multipoint geometries are not supported in SceneView."),null;if(!c)return this._logMissingView(),null;const b="rectangle"!==a,e="rectangle"!==a;a={view:c,mode:"rectangle"===a||"circle"===a?"hybrid":"click",...d,snapToScene:!1,geometryType:a,graphicSymbol:this._getGraphicSymbolFromTool(a),
snappingManager:this._snappingManager,forceUniformSize:e,centered:b};return"2d"===c.type?this._makeDrawGraphicTool2D(a):this._makeDrawGraphicTool3D(a)};l._makeDrawGraphicTool2D=async function(a){const c=await this._requireModule(new Promise((d,b)=>A(["../../views/2d/interactive/editingTools"],d,b)));return w(c)||this.destroyed?null:new c.module.DrawGraphicTool2D({...a,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:ra(a.geometryType)?
this.activeFillSymbol:null,tooltipOptions:this.tooltipOptions})};l._makeDrawGraphicTool3D=async function(a){const c=await this._requireModule(new Promise((b,e)=>A(["../../views/3d/interactive/editingTools"],b,e)));if(w(c)||this.destroyed)return null;const {elevationInfo:d}=this.layer;return new c.module.DrawGraphicTool3D({...a,elevationInfo:d,snapToScene:n.isSome(d)?"absolute-height"===d.mode:!0,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions})};l._setupCreateOperationHandle=function(a){const c=
this.view;if(!c)return this._logMissingView(),null;let d=null;const b=a.forceUniformSize,e=a.centered,k=[c.on("key-down",f=>{if(f.key===v.SKETCH_KEYS.pan)f.stopPropagation(),f.repeat||(a.enabled=!1);else if(f.key===v.SKETCH_KEYS.complete)f.stopPropagation(),a.completeCreateOperation();else if(f.key!==v.SKETCH_KEYS.vertexAdd||f.repeat)f.key===v.SKETCH_KEYS.undo?(f.stopPropagation(),h.undo()):f.key===v.SKETCH_KEYS.redo?(f.stopPropagation(),h.redo()):f.key!==v.SKETCH_KEYS.constraint||"rectangle"!==a.geometryType&&
"circle"!==a.geometryType||f.repeat?f.key!==v.SKETCH_KEYS.center||f.repeat||(a.centered=!e,f.stopPropagation()):(a.forceUniformSize=!b,f.stopPropagation());else{const g=a.drawOperation.geometryType;if("polyline"===g||"polygon"===g||"multipoint"===g)f.stopPropagation(),a.drawOperation.commitStagedVertex()}},x.ViewEventPriorities.WIDGET),c.on("key-up",f=>{f.key===v.SKETCH_KEYS.pan?a.enabled=!0:f.key!==v.SKETCH_KEYS.constraint||"rectangle"!==a.geometryType&&"circle"!==a.geometryType?f.key===v.SKETCH_KEYS.center&&
(a.centered=e,f.stopPropagation()):(a.forceUniformSize=b,f.stopPropagation())},x.ViewEventPriorities.WIDGET),a.on("vertex-add",f=>{d=n.isNone(d)?"start":"active";switch(f.operation){case "apply":this.emit("create",{graphic:n.unwrap(a.graphic),state:d,tool:this.activeTool,toolEventInfo:f,type:"create"});break;case "undo":this._emitUndoEvent({graphics:[n.unwrap(a.graphic)],tool:a.geometryType});break;case "redo":this._emitRedoEvent({graphics:[n.unwrap(a.graphic)],tool:a.geometryType})}}),a.on("cursor-update",
f=>{0<a.drawOperation.numCommittedVertices&&this.emit("create",{graphic:n.unwrap(a.graphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:f.vertices[0].coordinates,type:"cursor-update"},type:"create"})}),a.on("vertex-remove",f=>{switch(f.operation){case "apply":this.emit("create",{graphic:n.unwrap(a.graphic),state:"active",tool:this.activeTool,toolEventInfo:f,type:"create"});break;case "undo":this._emitUndoEvent({graphics:[n.unwrap(a.graphic)],tool:a.geometryType});break;case "redo":this._emitRedoEvent({graphics:[n.unwrap(a.graphic)],
tool:a.geometryType})}}),a.on("complete",f=>{this._set("createGraphic",n.unwrap(f.graphic));d="complete";f.aborted?h&&h.cancel():h&&h.complete()}),B.watch(()=>this._getGraphicSymbolFromTool(a.geometryType),f=>{a.graphicSymbol=f})],h=new E.CreateOperationHandle({activeComponent:a,tool:a.geometryType,type:"create",onEnd:()=>{k.forEach(f=>f.remove());k.length=0;c.tools?.remove(a)},undo:()=>{a.canUndo&&a.undo()},redo:()=>{a.canRedo&&a.redo()},canUndo:()=>a.canUndo,canRedo:()=>a.canRedo});return h};l._getGraphicSymbolFromTool=
function(a){switch(a){case "point":case "multipoint":return this.pointSymbol;case "polyline":return this.polylineSymbol;case "circle":case "rectangle":case "polygon":return this.polygonSymbol;case "mesh":return this.meshSymbol}};l._setupUpdateOperation=async function(a,c){const {layer:d,view:b}=this;if(!b)return this._logMissingView(),null;c={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...c,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...c?.reshapeOptions}};var e=c.tool;
for(var k of a)d.remove(k),d.add(k);if("3d"===b.type){if(0===a.length)return null;switch(e){case "move":return this._setupMove3DOperation(a,c,b,e);case "reshape":if(1<a.length)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;e=H.isSupportedGraphic(a[0]);if(e===C.SupportedGraphicResult.SUPPORTED)return this._setupReshape3DOperation(a[0],c,b);this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${C.isSupportedGraphicResultMessage(e)}).`);
return null;case "transform":return this._setupGraphicTransform3DOperation(a,c,b)}}switch(e){case "move":return this._setupMove2DOperation(a,c,b);case "reshape":if(1<a.length)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;k=H.isSupportedGraphic(a[0]);if(k===C.SupportedGraphicResult.SUPPORTED)return this._setupTransformOrReshape2DOperation(a,e,c,b);this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${C.isSupportedGraphicResultMessage(k)}).`);
return null;case "transform":return 1===a.length&&(k=n.get(a[0].geometry,"type"),"point"===k||"multipoint"===k)&&(e="reshape"),this._setupTransformOrReshape2DOperation(a,e,c,b)}};l._setupMove3DOperation=async function(a,c,d,b,e=!1){for(var k of a){const m=ia.isSupportedGraphic(k);if(m!==C.SupportedGraphicResult.SUPPORTED)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${C.isSupportedGraphicResultMessage(m)}).`),null}k=await this._requireModule(new Promise((m,
p)=>A(["../../views/3d/interactive/editingTools"],m,p)));if(w(k))return k;const h=new k.module.GraphicMoveTool({view:d,enableZ:c.enableZ,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions});d.tools.add(h);h.graphics.addMany(a);e||this.updateGraphics.addMany(a);const f=[],g=new E.UpdateOperationHandle({activeComponent:h,tool:b,type:"update",onEnd:()=>{f.forEach(m=>m.remove());f.length=0;d.tools?.remove(h);h.destroyed||h.destroy()},undo:()=>{I(g,this.updateGraphics.toArray());
this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:b})},redo:()=>{J(g,this.updateGraphics.toArray());this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:b})},addToSelection:m=>{this.updateGraphics.push(m);h.graphics.push(m);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[m],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:m=>{const p=this.updateGraphics.indexOf(m);g.history.undo.forEach(y=>
y.updates.splice(p,1));g.history.redo.forEach(y=>y.updates.splice(p,1));this.updateGraphics.remove(m);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[m],type:"selection-change"},type:"update"});0===this.updateGraphics.length?g.complete():h.graphics.remove(m)},toggleTool:async()=>{if(1===this.updateGraphics.length&&!1!==c.toggleToolOnClick&&"transform"===b){var m=this.updateGraphics.getItemAt(0);H.isSupportedGraphic(m)===
C.SupportedGraphicResult.SUPPORTED&&(m=await this._setupReshape3DOperation(m,c,d,!0),w(m)||(g.onEnd(),g.destroy(),this._setUpdateOperationHandle(m,c)))}}});f.push(...this._getHandlesForComponent(g,c),d.on("immediate-click",m=>this._getCommonUpdateOperationClickHandlers(g,m,c),x.ViewEventPriorities.WIDGET),d.on("key-down",m=>{this._getCommonUpdateOperationKeyDownHandlers(g,m)},x.ViewEventPriorities.WIDGET));return g};l._setupGraphicTransform3DOperation=function(a,c,d,b=!1){if(1===a.length&&ja.isSupportedGraphic(a[0])===
C.SupportedGraphicResult.SUPPORTED){const e=a[0],k=e.geometry;if(n.isSome(k)&&("point"===k.type||"mesh"===k.type))return this._setupPointTransform3DOperation(e,c,d);if(n.isSome(k)&&("polygon"===k.type||"polyline"===k.type))return this._setupPolyTransform3DOperation(e,c,d,b)}return this._setupMove3DOperation(a,c,d,"transform",b)};l._setupPointTransform3DOperation=async function(a,c,d){const {enableRotation:b,enableScaling:e,enableZ:k}=c,h=await this._requireModule(new Promise((p,y)=>A(["../../views/3d/interactive/editingTools"],
p,y)));if(w(h))return h;const f=new h.module.GraphicTransformTool({graphic:a,view:d,enableRotation:b,enableScaling:e,enableZ:k,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions});d.tools.add(f);this.updateGraphics.add(a);const g=[],m=new E.UpdateOperationHandle({activeComponent:f,tool:"transform",type:"update",onEnd:()=>{g.forEach(p=>p.remove());g.length=0;d.tools?.remove(f);f.destroyed||f.destroy()},undo:()=>{I(m,this.updateGraphics.toArray());this._emitUndoEvent({graphics:this.updateGraphics.toArray(),
tool:"transform"})},redo:()=>{J(m,this.updateGraphics.toArray());this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:"transform"})},addToSelection:async p=>{this.updateGraphics.add(p);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[p],removed:[],type:"selection-change"},type:"update"});p=await this._setupMove3DOperation(this.updateGraphics.toArray(),c,d,"transform",!0);w(p)||(m.onEnd(),m.destroy(),this._setUpdateOperationHandle(p,
c))},removeFromSelection:p=>{this.updateGraphics.remove(p);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[p],type:"selection-change"},type:"update"});m.complete()},toggleTool:()=>{}});g.push(...this._getHandlesForComponent(m,c),d.on("immediate-click",p=>this._getCommonUpdateOperationClickHandlers(m,p,c),x.ViewEventPriorities.WIDGET),d.on("key-down",p=>{this._getCommonUpdateOperationKeyDownHandlers(m,p)},x.ViewEventPriorities.WIDGET));
return m};l._setupPolyTransform3DOperation=async function(a,c,d,b=!1){const {enableRotation:e,enableScaling:k,enableZ:h,preserveAspectRatio:f}=c,g=await this._requireModule(new Promise((r,sa)=>A(["../../views/3d/interactive/editingTools"],r,sa)));if(w(g))return g;const m=new g.module.ExtentTransformTool({graphic:a,view:d,enableRotation:e,enableScaling:k,enableZ:h,preserveAspectRatio:f,tooltipOptions:this.tooltipOptions});d.tools.add(m);b||this.updateGraphics.add(a);const p=[],y=new E.UpdateOperationHandle({activeComponent:m,
tool:"transform",type:"update",onEnd:()=>{p.forEach(r=>r.remove());p.length=0;d.tools?.remove(m);m.destroyed||m.destroy()},canUndo:()=>m.canUndo,undo:()=>{m.undo();this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:"transform"})},canRedo:()=>m.canRedo,redo:()=>{m.redo();this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:"transform"})},addToSelection:async r=>{this.updateGraphics.add(r);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,
tool:this.activeTool,toolEventInfo:{added:[r],removed:[],type:"selection-change"},type:"update"});r=await this._setupMove3DOperation(this.updateGraphics.toArray(),c,d,"transform",!0);w(r)||(y.onEnd(),y.destroy(),this._setUpdateOperationHandle(r,c))},removeFromSelection:r=>{this.updateGraphics.remove(r);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[r],type:"selection-change"},type:"update"});y.complete()},
toggleTool:async()=>{if(1===this.updateGraphics.length&&!1!==c.toggleToolOnClick){var r=this.updateGraphics.getItemAt(0);H.isSupportedGraphic(r)===C.SupportedGraphicResult.SUPPORTED&&(r=await this._setupReshape3DOperation(r,c,d,!0),w(r)||(y.onEnd(),y.destroy(),this._setUpdateOperationHandle(r,c)))}}});p.push(...this._getHandlesForComponent(y,c),d.on("immediate-click",r=>this._getCommonUpdateOperationClickHandlers(y,r,c),x.ViewEventPriorities.WIDGET),d.on("key-down",r=>this._getCommonUpdateOperationKeyDownHandlers(y,
r),x.ViewEventPriorities.WIDGET),d.on("key-down",r=>{r.key!==v.SKETCH_KEYS.constraint||r.repeat||(m.preserveAspectRatio=!m.preserveAspectRatio,r.stopPropagation())},x.ViewEventPriorities.WIDGET),d.on("key-up",r=>{r.key===v.SKETCH_KEYS.constraint&&(m.preserveAspectRatio=!m.preserveAspectRatio,r.stopPropagation())},x.ViewEventPriorities.WIDGET));return y};l._setupMove2DOperation=async function(a,c,d){this.updateGraphics.addMany(a);await this._updateSpatialReference(a);const b=await this._getGraphicMover(a,
c,d);if(w(b))return b;const e=new E.UpdateOperationHandle({activeComponent:b,tool:"move",type:"update",onEnd:()=>{this._displayDefaultCursor();f.forEach(g=>g.remove());h.forEach(g=>g.remove());f=[];h=[];b.destroy();this._internalGraphicsLayer?.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const g=this.updateGraphics.toArray();I(e,g);e.refreshComponent();this._emitUndoEvent({graphics:g,tool:"move"})},redo:()=>{const g=this.updateGraphics.toArray();J(e,g);e.refreshComponent();this._emitRedoEvent({graphics:g,
tool:"move"})},addToSelection:async g=>{await this._updateSpatialReference(g);this.updateGraphics.push(g);b.graphics=this.updateGraphics.toArray();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[g],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:g=>{const m=this.updateGraphics.indexOf(g);e.history.undo.forEach(y=>y.updates.splice(m,1));e.history.redo.forEach(y=>y.updates.splice(m,1));this.updateGraphics.remove(g);
const p=this.updateGraphics.toArray();this.emit("update",{graphics:p,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[g],type:"selection-change"},type:"update"});0===this.updateGraphics.length?e.complete():b.graphics=p}});let k=!1,h=[d.on("immediate-click",g=>this._getCommonUpdateOperationClickHandlers(e,g,c),x.ViewEventPriorities.WIDGET),d.on("key-down",g=>{this._getCommonUpdateOperationKeyDownHandlers(e,g);g.key!==v.SKETCH_KEYS.constraint||g.repeat||(k=!0,b.enableMoveAllGraphics=
!b.enableMoveAllGraphics)},x.ViewEventPriorities.WIDGET),d.on("key-up",g=>{g.key===v.SKETCH_KEYS.constraint&&k&&(k=!1,b.enableMoveAllGraphics=!b.enableMoveAllGraphics)},x.ViewEventPriorities.WIDGET)],f=this._getHandlesForComponent(e,c);return e};l._setupReshape3DOperation=async function(a,c,d,b=!1){const e=await this._requireModule(new Promise((m,p)=>A(["../../views/3d/interactive/editingTools"],m,p)));if(w(e))return e;const k=c.reshapeOptions,h=new e.module.GraphicReshapeTool({view:d,graphic:a,enableZVertex:c.enableZ&&
"move"===k?.vertexOperation,enableZShape:c.enableZ&&"move"===k?.shapeOperation,enableMoveGraphic:"move"===k?.shapeOperation||"move-xy"===k?.shapeOperation,enableMidpoints:"split"===k?.edgeOperation,enableEdgeOffset:"offset"===k?.edgeOperation,snappingManager:this._snappingManager,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions});d.tools.add(h);b||this.updateGraphics.add(a);const f=[],g=new E.UpdateOperationHandle({activeComponent:h,tool:"reshape",type:"update",onEnd:()=>{f.forEach(m=>
m.remove());f.length=0;d.tools?.remove(h);h.destroyed||h.destroy()},canUndo:()=>h.canUndo,undo:()=>{h.undo();this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:"reshape"})},canRedo:()=>h.canRedo,redo:()=>{h.redo();this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:"reshape"})},addToSelection:async m=>{this.updateGraphics.add(m);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[m],removed:[],type:"selection-change"},
type:"update"});m=await this._setupMove3DOperation(this.updateGraphics.toArray(),c,d,"transform",!0);w(m)||(g.onEnd(),g.destroy(),this._setUpdateOperationHandle(m,c))},removeFromSelection:m=>{this.updateGraphics.remove(m);this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[m],type:"selection-change"},type:"update"});g.complete()},toggleTool:async()=>{if(!1!==c.toggleToolOnClick){var m=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),
c,d,!0);w(m)||(g.onEnd(),g.destroy(),this._setUpdateOperationHandle(m,c))}}});f.push(...this._getHandlesForComponent(g,c),d.on("immediate-click",m=>this._getCommonUpdateOperationClickHandlers(g,m,c),x.ViewEventPriorities.WIDGET),d.on("key-down",m=>{this._getCommonUpdateOperationKeyDownHandlers(g,m)},x.ViewEventPriorities.WIDGET));return g};l._setupTransformOrReshape2DOperation=async function(a,c,d,b){this.updateGraphics.addMany(a);await this._updateSpatialReference(a);a="transform"===c?await this._getBox(a,
d,b):await this._getReshape(a,d,b);if(w(a))return a;const e=new E.UpdateOperationHandle({activeComponent:a,type:"update",onEnd:()=>{h.forEach(f=>f.remove());k.forEach(f=>f.remove());h=[];k=[];e.activeComponent&&!e.activeComponent.destroyed&&e.activeComponent.destroy();this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{I(e,this.updateGraphics.toArray());e.refreshComponent();this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:e.tool})},redo:()=>{J(e,this.updateGraphics.toArray());
e.refreshComponent();this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:e.tool})},addToSelection:async f=>{var g=e.activeComponent;if("reshape"===g?.type){g=[...this.updateGraphics,f];this.updateGraphics.removeAll();g=await this._setupMove2DOperation(g,d,b);if(w(g))return;e.onEnd();e.destroy();this._setUpdateOperationHandle(g,d)}else this.updateGraphics.add(f),g.graphics=this.updateGraphics.toArray(),g.refresh(),e.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),
state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[f],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async f=>{const g=this.updateGraphics.indexOf(f);e.history.undo.forEach(p=>p.updates.splice(g,1));e.history.redo.forEach(p=>p.updates.splice(g,1));this.updateGraphics.remove(f);const m=this.updateGraphics.toArray();if(0===m.length)e.complete();else{const p=m[0].geometry;1!==m.length||!n.isSome(p)||"point"!==p.type&&"multipoint"!==p.type?e.activeComponent.graphics=
m:e.toggleTool()}this.emit("update",{graphics:m,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[f],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(!(1<this.updateGraphics.length)){var f=this.updateGraphics.getItemAt(0),g=f.geometry;n.isSome(g)&&("reshape"===e.tool&&("point"===g.type||"multipoint"===g.type)||"transform"===e.tool&&"extent"===g.type)||(g=null,"transform"===e.tool?g=await this._getReshape([f],d,b):"reshape"===e.tool&&(g=await this._getBox([f],
d,b)),w(g)||(e.activeComponent?.destroy(),e.activeComponent=g,e.activeComponent&&(h.forEach(m=>m.remove()),h=this._getHandlesForComponent(e,d))))}}});let k=[b.on("immediate-click",f=>this._getCommonUpdateOperationClickHandlers(e,f,d),x.ViewEventPriorities.WIDGET),b.on("key-down",f=>{this._getCommonUpdateOperationKeyDownHandlers(e,f);f.key===v.SKETCH_KEYS.constraint&&!f.repeat&&e&&(f=e.activeComponent)&&"box"===f.type&&(f.preserveAspectRatio=!f.preserveAspectRatio)},x.ViewEventPriorities.WIDGET),b.on("key-up",
f=>{f.key===v.SKETCH_KEYS.constraint&&e&&(f=e.activeComponent)&&"box"===f.type&&(f.preserveAspectRatio=!f.preserveAspectRatio)},x.ViewEventPriorities.WIDGET)],h=this._getHandlesForComponent(e,d);return e};l._getGraphicMover=async function(a,c,d){({enableMoveAllGraphics:c}=c);const b=await this._requireModule(new Promise((e,k)=>A(["../../views/draw/support/GraphicMover"],h=>e(K(h)),k)));return w(b)?b:new b.module.default({enableMoveAllGraphics:c,highlightsEnabled:!0,indicatorsEnabled:!1,graphics:a,
view:d,callbacks:{onGraphicMoveStart:({dx:e,dy:k,graphic:h})=>{this._displayGrabbingCursor();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:k,mover:h,type:"move-start"},type:"update"})},onGraphicMove:({dx:e,dy:k,graphic:h})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:k,mover:h,type:"move"},type:"update"}),onGraphicMoveStop:({dx:e,dy:k,
graphic:h})=>{this._displayPointerCursor();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:e,dy:k,mover:h,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})};l._getBox=async function(a,c,d){const {enableRotation:b,enableScaling:e,preserveAspectRatio:k}=c;c=await this._requireModule(new Promise((h,f)=>A(["../../views/draw/support/Box"],
g=>h(K(g)),f)));return w(c)?c:new c.module.default({graphics:a,enableRotation:b,enableScaling:e,preserveAspectRatio:k,layer:this._internalGraphicsLayer,view:d,tooltipOptions:this.tooltipOptions,callbacks:{onMoveStart:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onMove:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),
onMoveStop:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onScaleStart:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onScale:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onScaleStop:h=>this.emit("update",
{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onRotateStart:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onRotate:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"}),onRotateStop:h=>this.emit("update",{graphics:this.updateGraphics.toArray(),
state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...h},type:"update"})}})};l._getReshape=async function(a,c,d){const b="split"===c.reshapeOptions?.edgeOperation;c="move"===c.reshapeOptions?.shapeOperation;const e=await this._requireModule(new Promise((k,h)=>A(["../../views/draw/support/Reshape"],f=>k(K(f)),h)));return w(e)?e:new e.module.default({enableMidpoints:b,enableMovement:c,graphic:a[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions,
view:d,callbacks:{onReshapeStart:k=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...k},type:"update"}),onReshape:k=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...k},type:"update"}),onReshapeStop:({mover:k,type:h})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:k,type:h},
type:"update"}),onMoveStart:({dx:k,dy:h,mover:f,type:g})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:k,dy:h,mover:f,type:g},type:"update"}),onMove:({dx:k,dy:h,mover:f,type:g})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:k,dy:h,mover:f,type:g},type:"update"}),onMoveStop:({dx:k,dy:h,mover:f,type:g})=>this.emit("update",{graphics:this.updateGraphics.toArray(),
state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:k,dy:h,mover:f,type:g},type:"update"}),onVertexAdd:({added:k,type:h,vertices:f})=>{k=k.map(g=>Q.geometryToCoordinates(g.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:k,vertices:f,type:h},type:"update"})},onVertexRemove:({removed:k,type:h,vertices:f})=>{k=k.map(g=>Q.geometryToCoordinates(g.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),
state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:k,vertices:f,type:h},type:"update"})}}})};l._getHandlesForComponent=function(a,c){const d=a.activeComponent;if(!d)return[];switch(d.type){case "graphic-mover":return[d.on("graphic-click",({graphic:b,viewEvent:e})=>{e.native?.shiftKey&&(e.stopPropagation(),a.removeFromSelection(b))}),d.on("graphic-move-start",b=>a.addToHistory(D(b.allGraphics)))];case "box":return[d.on("graphic-click",b=>this._onTransformOrReshape2DGraphicClick(a,
c,b)),d.on("move-start",b=>a.addToHistory(D(b.graphics))),d.on("rotate-start",b=>a.addToHistory(D(b.graphics))),d.on("scale-start",b=>a.addToHistory(D(b.graphics)))];case "reshape":return[d.on("graphic-click",b=>this._onTransformOrReshape2DGraphicClick(a,c,b)),d.on("move-start",b=>a.addToHistory(D([b.mover]))),d.on("reshape-start",b=>a.addToHistory(D([b.graphic]))),d.on("vertex-add",b=>a.addToHistory(D([b.oldGraphic]))),d.on("vertex-remove",b=>a.addToHistory(D([b.oldGraphic])))];case "move-3d":return[d.on("graphic-move-start",
b=>{a.addToHistory(D(b.allGraphics));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:0<b.allGraphics.length?b.allGraphics[0]:null,type:"move-start"},type:"update"})}),d.on("graphic-move",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:b.dx,dy:b.dy,mover:0<b.allGraphics.length?b.allGraphics[0]:null,type:"move"},type:"update"})}),d.on("graphic-move-stop",
b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:0<b.allGraphics.length?b.allGraphics[0]:null,type:"move-stop"},type:"update"})}),d.on("immediate-click",b=>{b.shiftKey?this._toggleSelection([b.graphic],a,c):a.toggleTool()})];case "transform-3d":return[d.on("record-undo",({record:b})=>{a.addToHistory({updates:[b]})}),d.on("graphic-translate-start",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),
state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,dx:b.dxScreen,dy:b.dyScreen,type:"move-start"},type:"update"})}),d.on("graphic-translate-stop",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,dx:b.dxScreen,dy:b.dyScreen,type:"move-stop"},type:"update"})}),d.on("graphic-rotate-start",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,
toolEventInfo:{mover:b.graphic,angle:b.angle,type:"rotate-start"},type:"update"})}),d.on("graphic-rotate-stop",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,angle:b.angle,type:"rotate-stop"},type:"update"})}),d.on("graphic-scale-start",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,xScale:b.xScale,yScale:b.yScale,
type:"scale-start"},type:"update"})}),d.on("graphic-scale-stop",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,xScale:b.xScale,yScale:b.yScale,type:"scale-stop"},type:"update"})}),d.on("graphic-translate",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,dx:b.dxScreen,dy:b.dyScreen,type:"move"},type:"update"})}),d.on("graphic-rotate",
b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,angle:b.angle,type:"rotate"},type:"update"})}),d.on("graphic-scale",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:b.graphic,xScale:b.xScale,yScale:b.yScale,type:"scale"},type:"update"})}),d.on("immediate-click",b=>{b.shiftKey?this._toggleSelection([b.graphic],a,c):a.toggleTool()})];
case "reshape-3d":return[d.on("reshape",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:b,type:"update"})}),d.on("move",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:b,type:"update"})}),d.on("vertex-add",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:b,type:"update"})}),
d.on("vertex-remove",b=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:b,type:"update"})}),d.on("immediate-click",b=>{b.shiftKey?this._toggleSelection([b.graphic],a,c):a.toggleTool()})]}};l._onTransformOrReshape2DGraphicClick=function(a,c,d){const {graphic:b,viewEvent:e}=d;if(e.native?.shiftKey&&b.layer===this.layer)return e.stopPropagation(),a.removeFromSelection(b);if(c.toggleToolOnClick)return e.stopPropagation(),a.toggleTool()};
l._setUpdateOperationHandle=function(a,c){this._operationHandle=a;const d=this.view?.map;this._disablePopup(c);a.on("complete",()=>{if(a===this._operationHandle){const b=this.updateGraphics.toArray(),e=this._operationHandle.tool;this._operationHandle.destroy();this._operationHandle=null;this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray());this.updateGraphics.removeAll();d&&d.remove(this._internalGraphicsLayer);this._restorePopup(c);this.emit("update",{graphics:b,state:"complete",
aborted:a.cancelled,tool:e,toolEventInfo:null,type:"update"})}})};l._getCommonUpdateOperationClickHandlers=async function(a,c,d){const b=V.createScreenPointFromEvent(c),e=await c.async(()=>this._getFirstHit(b));n.isNone(e)?a.complete():c.native.shiftKey&&this._toggleSelection([e.graphic],a,d)?c.stopPropagation():this.updateGraphics.includes(e.graphic)?c.stopPropagation():a.complete()};l._toggleSelection=function(a,c,d){const b=!!d.multipleSelectionEnabled;return a.some(e=>null==e?!1:b&&e.layer===
this.layer?(this.updateGraphics.includes(e)?c.removeFromSelection(e):c.addToSelection(e),!0):!1)};l._getCommonUpdateOperationKeyDownHandlers=function(a,c){if(a){var d=c.key;d===v.SKETCH_KEYS.undo&&a.canUndo()?(c.stopPropagation(),a.undo()):d===v.SKETCH_KEYS.redo&&a.canRedo()?(c.stopPropagation(),a.redo()):d===v.SKETCH_KEYS.cancel?(c.stopPropagation(),a.cancel()):this.allowDeleteKey&&v.SKETCH_KEYS.delete.includes(d)&&this._onDeleteKey(c)}};l._onDeleteKey=function(a){if(this._operationHandle&&"update"===
this._operationHandle.type){var c=this.activeComponent,d=this.updateGraphics.toArray();n.isNone(c)||"reshape-3d"===c.type||"reshape"===c.type&&(1!==d.length||"point"!==n.get(d[0].geometry,"type"))||(a.stopPropagation(),this.delete())}};l._removeDefaultLayer=function(){this._internalGraphicsLayer&&(this.view?.map?.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=n.destroyMaybe(this._internalGraphicsLayer))};l._isComponentGraphic=function(a){const {activeComponent:c}=this;return!a||n.isNone(c)?
!1:a.attributes&&a.attributes.esriSketchTool||"draw-2d"===c.type&&c.graphic===a||("box"===c.type||"reshape"===c.type)&&c.isUIGraphic(a)};l._displayPointerCursor=function(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")};l._displayGrabbingCursor=function(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")};l._displayDefaultCursor=function(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=
null)};l._logError=function(a,c,d){ca.getLogger(this.declaredClass).error(new ba(a,c,d))};l._requireModule=async function(a){const c=new AbortController;this._moduleLoaderAbortController=c;a=await a;return this._moduleLoaderAbortController!==c||c.signal.aborted?{requireError:"aborted"}:{module:a}};l._emitUndoEvent=function(a){this.emit("undo",{...a,type:"undo"})};l._emitRedoEvent=function(a){this.emit("redo",{...a,type:"redo"})};l._emitDeleteEvent=function(a){this.emit("delete",{...a,type:"delete"})};
l.wait=function(){return B.whenOnce(()=>!this.updating)};l._beginAsyncOperation=function(){this._numUpdating+=1;this.notifyChange("updating")};l._endAsyncOperation=function(){--this._numUpdating;this.notifyChange("updating")};l._disablePopupEnabled=function(a){return"3d"!==this.view?.type||this.updateOnGraphicClick||(n.unwrap(a)?.toggleToolOnClick??!1)};l._disablePopup=function(a){this._disablePopupEnabled(a)&&(a=this.view?.popup)&&n.isNone(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=
a.autoOpenEnabled,a.autoOpenEnabled=!1)};l._restorePopup=function(a){this._disablePopupEnabled(a)&&(a=this.view?.popup)&&n.isSome(this._originalAutoOpenEnabled)&&(a.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)};l._waitViewReady=async function(){const a=this.view;a?(n.abortMaybe(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,await N.whenOrAbort(B.whenOnce(()=>a?.ready),this._viewReadyAbortController.signal)):this._logMissingView()};
l._logMissingView=function(){this._logError("sketch:missing-property",Z("view"))};l._logMissingLayer=function(){this._logError("sketch:missing-property",Z("layer"))};M._createClass(z,[{key:"_defaultUpdateTool",get:function(){return"3d"===this.view?.type?"move":"transform"}},{key:"updating",get:function(){return 0<this._numUpdating||n.isSome(this._snappingManager)&&this._snappingManager.updating}},{key:"activeTool",get:function(){return this._operationHandle?.tool??null}},{key:"activeComponent",get:function(){return this._operationHandle?.activeComponent??
null}},{key:"createGraphic",get:function(){return!n.isSome(this.activeComponent)||"draw-3d"!==this.activeComponent.type&&"draw-2d"!==this.activeComponent.type?this._get("createGraphic"):n.unwrap(this.activeComponent.graphic)}},{key:"defaultCreateOptions",get:function(){return this._get("defaultCreateOptions")},set:function(a){this._set("defaultCreateOptions",{...Y,...a})}},{key:"defaultUpdateOptions",get:function(){return this._get("defaultUpdateOptions")},set:function(a){this._set("defaultUpdateOptions",
{...L,...a,reshapeOptions:{...L.reshapeOptions,...a?.reshapeOptions}})}},{key:"snappingOptions",set:function(a){n.isSome(this._snappingManager)&&(this._snappingManager.options=a);this._set("snappingOptions",a)}},{key:"state",get:function(){const a=!(!this.view?.ready||!this.layer),c=this._operationHandle;return a&&c?"active":a?"ready":"disabled"}},{key:"view",get:function(){return this._get("view")},set:function(a){const c=this._get("view");if(c){const {container:d,map:b}=c;d&&(c.cursor=null);b&&
b.remove(this._internalGraphicsLayer);this._viewHandles.removeAll();this.cancel()}this._handles.remove("view-ready");a&&this._handles.add(B.when(()=>a.ready,d=>{this._viewHandles.removeAll();d&&this._viewHandles.add(this._generateViewHandles(a))},B.syncAndInitial),"view-ready");this._set("view",a)}},{key:"test",get:function(){return{operationHandle:this._operationHandle,defaultUpdateOptions:L}}}]);return z}(q.EventedAccessor);t.__decorate([u.property()],q.prototype,"updating",null);t.__decorate([u.property()],
q.prototype,"_operationHandle",void 0);t.__decorate([u.property({readOnly:!0})],q.prototype,"activeTool",null);t.__decorate([u.property()],q.prototype,"activeFillSymbol",void 0);t.__decorate([u.property()],q.prototype,"activeLineSymbol",void 0);t.__decorate([u.property()],q.prototype,"activeVertexSymbol",void 0);t.__decorate([u.property()],q.prototype,"allowDeleteKey",void 0);t.__decorate([u.property({readOnly:!0})],q.prototype,"createGraphic",null);t.__decorate([u.property()],q.prototype,"defaultCreateOptions",
null);t.__decorate([u.property()],q.prototype,"defaultUpdateOptions",null);t.__decorate([u.property({type:S,nonNullable:!0})],q.prototype,"labelOptions",void 0);t.__decorate([u.property()],q.prototype,"layer",void 0);t.__decorate([u.property({types:F.symbolTypes})],q.prototype,"pointSymbol",void 0);t.__decorate([u.property({types:F.symbolTypes})],q.prototype,"polygonSymbol",void 0);t.__decorate([u.property({types:F.symbolTypes})],q.prototype,"polylineSymbol",void 0);t.__decorate([u.property()],q.prototype,
"meshSymbol",void 0);t.__decorate([u.property({type:U,nonNullable:!0})],q.prototype,"snappingOptions",null);t.__decorate([u.property()],q.prototype,"_snappingManager",void 0);t.__decorate([u.property({readOnly:!0})],q.prototype,"state",null);t.__decorate([u.property({type:T,nonNullable:!0})],q.prototype,"tooltipOptions",void 0);t.__decorate([u.property({readOnly:!0})],q.prototype,"updateGraphics",void 0);t.__decorate([u.property()],q.prototype,"updateOnGraphicClick",void 0);t.__decorate([u.property({types:F.symbolTypes})],
q.prototype,"vertexSymbol",void 0);t.__decorate([u.property({value:null})],q.prototype,"view",null);q=t.__decorate([da.subclass("esri.widgets.Sketch.SketchViewModel")],q);const Z=l=>`Property '${l}' is missing on SketchViewModel.`;return q});